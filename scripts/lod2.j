globals
  boolean MjollnirsExists=false
  boolean IsRGC=false
  boolean MortalWoundsDamage=false
  boolean IsRuneFirstSpawn=true
  constant integer EMPTYDUMMY='n07D'
  boolean advancedTracking=false
  real OF8
  boolean UDSG_IsOrb=false
  integer asdasd=0
  integer array dstr
  sound gg_snd_DarkSummoningLaunch1
  sound gg_snd_PossessionMissileLaunch1
  group FleshGolems=CreateGroup()
  fogmodifier PickHighlightExtended
  boolean Mode_Debug=false
  integer array HeroDummy
  boolean HeroInGame_BS=false
  boolean HeroInGame_Queen=false
  trigger DamageRegister
  region ExtraBoundaries=null
  region ExtraBoundariesAdv=null
  boolean NoReflection=false
  integer FakeDamageType=0
  region SentFountainReg
  region ScourgeFountainReg
  group CouriersSummoned=CreateGroup()
  integer UDSTriggers=0
  boolean DiffusalBladeExists=false
  boolean QuellingBladeExists=false
  boolean SkadiExists=false
  boolean OrbOfVenomExists=false
  boolean tranquilsExists=false
  unit UDSG_Attacker
  unit UDSG_Target
  real UDSG_Dmg
  integer UDSG_TempInt
  rect WardAbuseRect
  trigger MeleeRangeItemsSwitcher
  integer array amhc
  unit array lastunit1
  unit array lastunit2
  integer array counter1
  boolean array testr1
  boolean array testr2
  unit ShowPickUnit
  unit VisPickUnit
  unit ShowTUnit
  trigger TriggerEn1
  trigger TriggerEn2
  timer TimerMh
  boolean DicktB=true
  
  player tt_player3
  real TempReal2
  constant integer HOTKEY=StringHash("hotkey")
  unit PreloaderUnit
  boolean IsControlled=false
  integer movespeedactive=0
  unit AltarOfRandom
  integer array BonusEffects
  integer array ClearCounter
  real array TxtDur
  integer array NetWorthsNoGold
  boolean array NetWorthRecount
  unit AddTime1
  unit AddTime2
  unit AddTime3
  unit AddTime4
  boolean FBHappened=false
  constant integer TEMPEST=StringHash("tempest")
  integer buybackC=-1
  group ABDGroup
  trigger TreeRevivalTrigger
  boolean array ShakingOn
  boolean array HackStatus
  unit AHUnit
  unit AHUnit2
  unit AHUnit3
  unit SwarmTempUnit
  
  integer TC_es_lvl
  boolean IsOrbAttack=false
  boolean array BottlePickupRunesOldfashion
  integer array NetWorths
  timer ShoppingPeriodic
  rect ShoppingSquare
  unit ShoppingUnit
  trigger Centaur_HoofStompTrigger
  trigger ES_Aftershock
  integer array stuns
  
  rect RoshanCanWalkHere
  group TrampleTempGroup
  trigger ShowSkillsOnSelectT
  integer maxSkillId=0
  hashtable SCMD=InitHashtable()
  hashtable TempHash=InitHashtable()
  boolean array ShowSkills
  
  integer TempInt
  integer Snowball_Dmg
  integer Shredder_TempInt
  integer Rubick_TempInt
  integer Phoenix_TempInt
  boolean Gyro_TempBool
  integer Gyro_TempInt
  integer Zeus_TempInt
  integer array FleshHeapCount
  integer Potm_Leap_lvl
  unit EchoSlam_Caster
  unit Skewer_Caster
  integer Skewer_lvl
  real Skewer_x
  real Skewer_y
  boolean array HideMorphIcon
  unit Zeus_Lightning_Closest
  real Zeus_Lightning_ClosDist
  real Zeus_Lightning_ClosX
  real Zeus_Lightning_ClosY
  unit Lesh_TempUnit
  real Lesh_TempReal
  boolean array RGCFFed
  unit CausticFinal_SK
  real CausticFinal_dmg
  unit RealityTempUnit
  integer Silencer_CurseOfSilence_Level=0
  real LightningGrappleAngle
  unit LightningGrappleUnit
  real LightningGrappleDmg
  integer StaticChargeCounter
  unit StaticChargeCaster
  unit Lion_Finger_TempUnit
  real THD_TempReal1
  real THD_TempReal2
  real THD_TempReal3
  real THD_TempReal4
  real THD_TempReal5
  real THD_TempReal6
  
  unit Traxex_Gust_Tempunit=null
  real Traxex_Gust_TempX
  real Traxex_Gust_TempY
  group Traxex_Gust_TempGroup
  
  hashtable HeroStats=InitHashtable()
  hashtable UMD=InitHashtable()
  hashtable UnitStats=InitHashtable()
  hashtable MHT = InitHashtable()
  hashtable HY=InitHashtable()
  hashtable UTable=InitHashtable()
  hashtable PRDtable=InitHashtable()
  hashtable ItemCosts=InitHashtable()
  
  boolean array PlayerHaveHero
  
  sound Sound_Tick
  real ForceOfNatureX
  real ForceOfNatureY
  boolean ForceOfNatureMC=false
  
  player TempPlayer
  
  integer LastRoshanSlayer=0
  real array ResetCooldown
  real array ReadyCooldown
  boolean AghBlackHoleDamage
  real Queen_SnatchedHP=999999
  unit Queen_SnatchedUnit=null
  group Queen_TempGroup=null
  unit Queen_TempUnit=null
  integer Queen_TempInt=0
  integer Queen_TempInt2=0
  sound array spooky
  integer DigestItemsCount=0
  integer array DigestItems
  unit SpitTempUnit
  boolean FlyingCourierAllowed=false
  
  real ThirstInterval=0.015
  unit array BugHunterProviders
  real zOffsetDebug=.0
  
  unit BroodWebTemp
  boolean IsCorrosiveSkinDamage=false
  integer array DisablesList
  integer DisablesListCount=0
  string array SDHeroesPool
  integer array SDHeroesPoolInc
  integer array SDHeroesIDs
  constant string EmptySlotPath="UI\\Widgets\\Console\\Undead\\undead-inventory-slotfiller.blp"
  constant integer indexid_VS=1
  constant integer indexid_Zeus=2
  constant integer indexid_Enchantress=3
  constant integer indexid_Morphling=4
  constant integer indexid_CM=5
  constant integer indexid_Sven=6
  constant integer indexid_NagaSiren=7
  constant integer indexid_ES=8
  constant integer indexid_Riki=9
  constant integer indexid_LoneDruid=10
  constant integer indexid_Lina=11
  constant integer indexid_Juggernaut=12
  constant integer indexid_Silencer=13
  constant integer indexid_Treant=14
  constant integer indexid_Chieftain=15
  constant integer indexid_Kotl=16
  constant integer indexid_Ursa=17
  constant integer indexid_OgreMagi=18
  constant integer indexid_Tinker=19
  constant integer indexid_Furion=20
  constant integer indexid_PL=21
  constant integer indexid_Tiny=22
  constant integer indexid_Techies=23
  constant integer indexid_Chen=24
  constant integer indexid_Luna=25
  constant integer indexid_Sniper=26
  constant integer indexid_Troll=27
  constant integer indexid_Rhasta=28
  constant integer indexid_Wisp=29
  constant integer indexid_Pandaren=30
  constant integer indexid_Centaur=31
  constant integer indexid_Bounty=32
  constant integer indexid_DK=33
  constant integer indexid_AM=34
  constant integer indexid_Trax=35
  constant integer indexid_Omni=36
  constant integer indexid_Beastmaster=37
  constant integer indexid_THD=38
  constant integer indexid_Alchemist=39
  constant integer indexid_Potm=40
  constant integer indexid_Storm=41
  constant integer indexid_Huskar=42
  constant integer indexid_Lanaya=43
  constant integer indexid_Puck=44
  constant integer indexid_Clock=45
  constant integer indexid_Admiral=46
  constant integer indexid_WR=47
  constant integer indexid_Gyro=48
  constant integer indexid_Disruptor=49
  constant integer indexid_Tusk=50
  constant integer indexid_Phoenix=51
  constant integer indexid_BB=52
  constant integer indexid_Rubick=53
  constant integer indexid_Xin=54
  constant integer indexid_Legion=55
  constant integer indexid_Skywrath=56
  constant integer indexid_Timber=57
  constant integer indexid_Lycan=58
  constant integer indexid_Brood=59
  constant integer indexid_PA=60
  constant integer indexid_Medusa=61
  constant integer indexid_Bala=62
  constant integer indexid_Leoric=63
  constant integer indexid_Doom=64
  constant integer indexid_NA=65
  constant integer indexid_Slardar=66
  constant integer indexid_QoP=67
  constant integer indexid_Bone=68
  constant integer indexid_Void=69
  constant integer indexid_Viper=70
  constant integer indexid_Razor =71
  constant integer indexid_Lifestealer =72
  constant integer indexid_Pugna =73
  constant integer indexid_Tide =74
  constant integer indexid_Bane =75
  constant integer indexid_Necrolyte =76
  constant integer indexid_Pudge =77
  constant integer indexid_Barathum =78
  constant integer indexid_Weaver =79
  constant integer indexid_SF =80
  constant integer indexid_SK =81
  constant integer indexid_Axe =82
  constant integer indexid_BS =83
  constant integer indexid_Abaddon =84
  constant integer indexid_Spectre =85
  constant integer indexid_WD =86
  constant integer indexid_OD =87
  constant integer indexid_WL =88
  constant integer indexid_Geomancer =89
  constant integer indexid_Dazzle =90
  constant integer indexid_Pit =91
  constant integer indexid_Zombie =92
  constant integer indexid_DS =93
  constant integer indexid_Kodo =94
  constant integer indexid_Enigma =95
  constant integer indexid_Batrider =96
  constant integer indexid_AA =97
  constant integer indexid_Slark =98
  constant integer indexid_TB =99
  constant integer indexid_Leshrak =100
  constant integer indexid_SD =101
  constant integer indexid_Lich =102
  constant integer indexid_Banshee =103
  constant integer indexid_Lion =104
  constant integer indexid_Veno =105
  constant integer indexid_Magnus =106
  constant integer indexid_Visage =107
  constant integer indexid_Nessaj =108
  constant integer indexid_Wyvern =109
  constant integer indexid_Zet =110
  constant integer indexid_Earth =111
  constant integer indexid_Oracle =112
  constant integer indexid_Crabe =113
  constant integer indexid_Sieger =114
  constant integer indexid_Sorcesser =115
  constant integer indexid_Invoker =116
  constant integer indexid_Formless =117
  constant integer indexid_SpaceOrc =118
  constant integer indexid_OgreLord =119
  constant integer indexid_FireLord =120
  constant integer indexid_Queen =121
  
  boolean quest_test=false
  
  group RadianceDamaged=CreateGroup()
  group TempGroup
  
  boolean NeedBoost=true
  integer array ArmletStrBonus
  integer array PositiveBuffs
  integer PositiveBuffsCount=0
  
  //trigger CustomUnitBountySystem
  constant integer EXPAOE=1325
  unit GlobalKiller=null
  integer GlobalKillerExp
  boolean SacrificedByLich=false
  integer array SpawnHistory
  integer array EvasionContainers
  
  
  boolean Intended=false
  
  integer array BonusMSPercentSystem
  
  constant integer COLOR=StringHash("color")
  constant integer BOUNTYL=StringHash("bounty_lowest")
  constant integer BOUNTYH=StringHash("bounty_highest")
  constant integer SIGHT=StringHash("sight")
  constant integer NSIGHT=StringHash("nsight")
  constant integer EXP=StringHash("expirience")
  // LoD Globals
  //===================================================
  //boolean array HasPickedUlt //used for 4 non-ult spells
  //==================================================
  
  real TempReal
  integer MORPH_MIN_STATS=5
  integer Lich_MorphedSkillId
  integer TempInteger
  timer DarknessTimer=CreateTimer()
  
  boolean TempBoolean=false
  
  boolean array HidePassivesForPlayer
  
  boolean IsFakeDamage=false
  integer array PassivesRealID
  integer array PassivesSpellbookID
  integer array PassivesLearningSkill
  integer array PassivesBuffID
  integer array PassivesUpgradeID
  integer array PassivesLearningSkillUpg
  integer array PassivesVisualID
  
  integer PassivesCount=0
  
  integer array AghaUpgradeID
  integer array AghaBaseSpellID
  integer array AghaUpgradedSpellID
  integer array AghaVisualId
  integer AghaCounter=1
  
  real DoubleEdgeDamage
  unit DoubleEdgeCaster
  integer array Prevent100GoldPerSwap
  boolean array IsImpossibleToBuyback
  
  
  group g_TrueshotGroup=CreateGroup()
  unit TrueshotBearer=null
  player TrueshotPlayer=null
  integer TrueshotDmg
  boolean TrueshotAlive=false
  
  unit Oracle_TempCaster
  unit Oracle_TempDummy
  integer Oracle_TempLvl
  trigger Oracle_PurgeTrigger=null
  
  integer array BerserkerBloodResistCont
  
  unit Medusa_StoneGaze_TempUnit
  group Medusa_StoneGaze_Group
  
  trigger trig_WintersCurse
  unit unit_WinterCurseTarget
  group group_WinterCurse
  unit unit_WinterCurseCaster
  
  unit Wyvern_SplinterBlast_InitialCaster
  unit Wyvern_SplinterBlast_Helper
  
  unit TempCaster
  unit TempTarget
  trigger TempTrigger
  integer KaolinGGTempLvl
  integer KaolinGGBuffedByStone
  unit KaolinGGTempUnit
  group KaolinGGTempGroup
  real KaolinGeoGripTempX
  real KaolinGeoGripTempY
  integer KaolinTempRollingLvl
  boolean KaolinRollingBoulderTempBool
  integer KaolinTempRollingBuffed
  real KaolinTempRollingDamage
  group KaolinTempRollingGroup
  unit KaolinTempRollingCaster
  unit KaolinClosestTarget
  unit KaolinRollingTempUnit
  unit KaolinTempCaster
  unit KaolinPushedUnit
  unit KaolinSmashTempUnit
  unit KaolinMagnetizeTempCaster
  unit KaolinMagnetizeTempVictim
  group Kaolin_PushSmashedGroup
  integer KaolinTempInteger
  integer KaolinsPushLevelStorage
  real KaolinDistanceTemp
  real KaolinPushDamage
  boolean Kaolin_PreloadAnimation=false
  // LoD Globals - new
  //===================================================
  
  trigger GAME_TRIGGER = CreateTrigger()
  trigger CHAT_TRIGGER = CreateTrigger()
  location ZeroLocation = Location(0,0)
  //boolean Mode_FF = false
  
  
  //used for the buff system
  //==============================		
  integer array LoDBuff_AbilID
  integer array LoDBuff_BuffID
  
  //used for the stats system
  //==============================
  constant integer LoDArmourAbilityBase  = 'AA00'
  constant integer LoDArmourAbilityCount = 8
  constant integer LoDArmourNegAbilityBase  = 'AG00'
  constant integer LoDArmourNegAbilityCount = 8
  constant integer LoDDamageAbilityBase  = 'AB00'
  constant integer LoDDamageAbilityCount = 12
  constant integer LoDRegenAbilityBase   = 'AC00'
  constant integer LoDRegenAbilityCount  = 6
  constant integer LoDManaRegenAbilityBase  = 'AD00'
  constant integer LoDManaRegenAbilityCount = 6
  constant integer LoDAttackAbilityBase  = 'AE00'
  constant integer LoDAttackAbilityCount = 10
  constant integer LoDAttackNegAbilityBase  = 'AF00'
  constant integer LoDAttackNegAbilityCount = 10
  constant integer LoDDamageNegAbilityBase  = 'AI00'
  constant integer LoDDamageNegAbilityCount = 12
  
  //used for group functions - if you see any of these variables used, replace it by something else
  //==============================
  unit array group_temp_unit
  real array group_temp_real
  integer array group_temp_integer
  boolean group_temp_boolean = false
  player group_temp_player = null
  group group_temp_group = null
  group temp_group = CreateGroup()
  group temp_group2 = CreateGroup()
  
  // LoD Globals - stable
  //===================================================
  integer array CanAddTime
  
  boolean IsRealDamage=true
  real GetUnitPhysicalResistance_Result=1
  boolean LOLWTF=false
  trigger LOLWTF_Trig
  unit Shadowraze_Source=null
  integer Shadowraze_Level
  unit Netherblast_Source=null
  integer Netherblast_Level
  integer array HeroTypeId
  integer array AlternateSkillID
  boolean array CourierDead
  unit LoDMoonGlaive_Source
  unit LoDMoonGlaive_Origin
  unit LoDMoonGlaive_Target
  real LoDMoonGlaive_MaxDistance
  unit RipTideSource=null
  group RipTideAlreadyHit=null
  integer NumberOfHeroes=119
  integer PlayerSkillOffset=6
  integer baseCreepSpawnTime=90
  integer CreepSpawnTimeForSD=150
  integer CreepSpawnTimeForMD=150
  integer CreepSpawnTimeForRD=240
  constant integer EssenceShiftHash=StringHash("essenceshift")
  integer MaximumLevel=25
  boolean array b_isDamageShowed
  integer array DPS
  integer array PlayersId
  boolean array PlayerFFed
  boolean GameWasFFed=false
  string TabTab="		"
  boolean b_isPickTime=true
  string s_MainMode=""
  string ModeForTitle
  integer array OneSkillCheckArray
  integer OneSkillOffsetCheck=1000
  integer NumberOfExtraAbilities=0
  integer array ExtraAbilityLevel
  integer i_BonusDraftAmount=0
  integer array i_BonusHeroCounter
  boolean array b_HeroAvailableForPlayer
  boolean array b_isPlayerReady
  boolean b_AllPlayersReady=false
  multiboard AbilityDraftMultiboard=null
  unit array SpellPickingDummy
  boolean array b_IsHeroAlreadyPreloaded
  integer array SelectedSkillHeroPointValue
  //integer array UltimatesHeroId
  integer array MeleeOrRangedRestricted
  integer array HeroNumArrayRandomized
  integer array PlayerSkillNumber
  string array SkillIcon
  integer array SkillID
  integer array EngineeringUpgradeSkillID
  string array BalanceStrings
  string array ExBalanceStrings
  boolean array IsPassiveAbility
  boolean array IsMultiIconAbility
  boolean array IsPermanentAbility
  boolean array IsAbilityDoesNotWork
  integer array Kills
  integer array Deaths
  integer array PlayerCS
  integer array CSDenies
  integer array CSNeutrals
  integer array Assists
  integer array ItemStats_Consumables
  integer array ItemStats_Wards
  integer array PlayerGoldCash
  integer array PlayerBestStreak
  integer array DoubleKills
  integer array TrippleKills
  integer array PlayerTimeDead
  integer array PlayerTowersDenied
  integer array GoldEarnedByKills
  integer array PlayerTowersKilled
  integer array PlayerAPM
  real array LastTimeActivity
  timer GlobalTimer=null
  real GameStartsTime=0
  boolean array b_isHeroPicked
  boolean array IsHeroIngame
  integer array PlayerKillsStreak
  integer array MultikillCounter
  integer array OwnageCounters
  boolean IsHeroesAvailable=false
  string array udg_Colors
  boolean array PlayerHaveRealHero
  timer array MultikillTimers
  timer array HeroRespawnTimer
  integer MinutesForTime=0
  integer SecondsForTime=0
  integer array DM_Counter
  boolean Mode_MA=false
  boolean Mode_DM=false
  boolean Mode_SO=false
  boolean Mode_AR=false
  boolean Mode_RD=false
  integer Mode_RD_Count=14
  boolean Mode_TR=false
  boolean Mode_AP=false
  boolean Mode_ID=false
  boolean Mode_AH=false
  multiboard MainMB=null
  unit Roshan=null
  boolean array HasUsedRandom
  integer MinGoldForRepick=150
  boolean Mode_EM=false
  boolean Mode_NP=false
  boolean Mode_SC=false
  location FrozenThroneLoc=null
  location TreeOfLifeLoc=null
  location MidCreepsWaypoint=null
  location TopCreepsWaypoint=null
  location BottomCreepsWaypoint=null
  boolean ElfTopRaxRExists=true
  boolean ElfMidRaxRExists=true
  boolean ElfBotRaxRExists=true
  boolean ElfTopRaxMExists=true
  boolean ElfMidRaxMExists=true
  boolean ElfBotRaxMExists=true
  boolean UndTopRaxRExists=true
  boolean UndMidRaxRExists=true
  boolean UndBotRaxRExists=true
  boolean UndTopRaxMExists=true
  boolean UndMidRaxMExists=true
  boolean UndBotRaxMExists=true
  integer MeleeCreepsAmount=3
  integer RangeCreepsAmount=1
  location ScourgeMidMeleeSpawn=null
  location ScourgeTopMeleeSpawn=null
  location ScourgeBottomMeleeSpawn=null
  location ScourgeMidRangeSpawn=null
  location ScourgeBottomRangeSpawn=null
  location ScourgeTopRangeSpawn=null
  location SentinelMidMeleeSpawn=null
  location SentinelBottomMeleeSpawn=null
  location SentinelTopMeleeSpawn=null
  location SentinelMidRangeSpawn=null
  location SentinelBottomRangeSpawn=null
  location SentinelTopRangeSpawn=null
  location TopRuneSpawn=null
  location BottomRuneSpawn=null
  unit array udg_Hero
  integer M1=0
  integer N1=0
  player array Sents
  player array Scrgs
  integer array DM_LivesUsed
  unit array DM_PrevHero
  integer array OO
  force Force_Elfs=null
  force Force_Unds=null
  player array Sentinels
  player array Scourges
  player Neutrals=null
  constant player Player15=Player(15)
  boolean Mode_SP=false
  integer VO=0
  integer array WO
  player PlayerModeTyper=null
  unit TmpUnit376=null
  integer TmpInt377=0
  real TmpReal378=0
  constant integer WaypointAbilID='A06G'
  location array WaypointLocations
  group TempGroup2=null
  boolean udg_ObserverMode=false
  boolean E2=false
  boolean Mode_DU=false
  boolean Mode_AA=false
  boolean Mode_AI=false
  boolean Mode_AS=false
  string FullModesString=""
  boolean Mode_SH=false
  boolean Mode_Normal=true
  player tt_player2=null
  integer array ItemsAbilities2
  integer ItemsAbilitiesMax2=0
  force AllPlayers=null
  boolean GameEnded=false
  constant real I3=0
  boolean O3=false
  boolean RandomAllowed=true
  boolean RepickAllowed=true
  boolean array HasAlreadyPickedHero
  string MainModeInTxt=""
  boolean array G3
  boolean H3=false
  boolean Z3=false
  location Y3=null
  real Meepo_Earthbind_TempY=0
  string K3=""
  string array LeftAt
  rect ScouBotMeleeSpawnRect=null
  rect ScouMidMeleeSpawnRect=null
  rect ScouTopMeleeSpawnRect=null
  rect gg_rct_Hero_Creation_UD=null
  rect SentBotRangeSpawnRect=null
  rect SentTopRangeSpawnRect=null
  rect SentMidRangeSpawnRect=null
  rect ScouBotRangeSpawnRect=null
  rect ScouMidRangeSpawnRect=null
  rect ScouTopRangeSpawnRect=null
  rect gg_rct_Hero_Creation_NE=null
  rect SentBotMeleeSpawnRect=null
  rect SentTopMeleeSpawnRect=null
  rect SentMidMeleeSpawnRect=null
  rect BottomRuneSpawnRect=null
  rect F4=null
  rect G4=null
  rect TopRuneSpawnRect=null
  rect NR_Und_Ar=null
  rect NR_Elf_Ar=null
  rect NR_Elf_Cr=null
  rect NR_Und_Bpr=null
  rect NR_Und_Pr=null
  rect NR_Elf_Pr=null
  rect NR_Und_TRr=null
  rect NR_Elf_BRr=null
  rect NR_Und_BBr=null
  rect NR_Elf_OldSmr=null
  rect gg_rct_Allpick_Sent=null
  rect gg_rct_Allpick_Scourge=null
  rect Q4=null
  rect NR_Und_A=null//Neutral Rects: Undead - Ancient
  rect NR_Elf_A=null
  rect NR_Elf_C=null
  rect NR_Und_Bp=null
  rect NR_Und_P=null
  rect NR_Elf_P=null
  rect NR_Und_TR=null
  rect NR_Und_BB=null
  rect NR_Elf_BR=null
  rect NR_Elf_OldSm=null
  rect H5=null
  rect Z5=null
  rect NR_Uld_OldSm=null
  rect NR_Uld_OldSmr=null
  rect NR_Elf_Roof=null
  rect NR_Elf_Roofr=null
  rect J5=null
  rect A6=null
  rect E6=null
  rect IA=null
  rect OA=null
  rect BA=null
  rect CA=null
  rect DA=null
  rect EA=null
  rect Waypoints_ScMidSpawn=null
  rect Waypoints_ScTopSpawn=null
  rect Waypoints_ScBotSpawn=null
  rect Waypoints_SentBotSpawn=null
  rect Waypoints_SentMidSpawn=null
  rect Waypoints_SentTopSpawn=null
  sound OC=null
  sound AC=null
  sound BC=null
  sound CC=null
  sound Sounds_Dominating=null
  sound Sounds_DK=null
  sound Sounds_FB=null
  sound Sound_TechiesLaugh=null
  sound Sounds_Godlike=null
  sound Sounds_HolyShit=null
  string XC="Sound\\Music\\mp3Music\\Human1.mp3"
  string YC="Sound\\Music\\mp3Music\\Human2.mp3"
  string JC="Sound\\Music\\mp3Music\\Human3.mp3"
  sound KC=null
  sound LC=null
  sound Sounds_KillingSpree=null
  sound NC=null
  sound Sounds_Megakill=null
  sound SoundMeld=null
  sound Sounds_Monsterkill=null
  string QC="Sound\\Music\\mp3Music\\NightElf1.mp3"
  string UC="Sound\\Music\\mp3Music\\NightElf2.mp3"
  string OD="Sound\\Music\\mp3Music\\NightElf3.mp3"
  string BD="Sound\\Music\\mp3Music\\Orc1.mp3"
  string DD="Sound\\Music\\mp3Music\\Orc2.mp3"
  string ED="Sound\\Music\\mp3Music\\Orc3.mp3"
  string FD="Sound\\Music\\mp3Music\\BloodElfTheme.mp3"
  string GD="Sound\\Music\\mp3Music\\DarkAgents.mp3"
  string HD="Sound\\Music\\mp3Music\\TragicConfrontation.mp3"
  string ZD="Sound\\Music\\mp3Music\\SadMystery.mp3"
  string VD="Sound\\Music\\mp3Music\\IllidansTheme.mp3"
  sound Sounds_Ownage=null
  sound TD=null
  sound QD=null
  sound Sounds_TrippleKill=null
  string IE="Sound\\Music\\mp3Music\\Undead1.mp3"
  string OE="Sound\\Music\\mp3Music\\Undead2.mp3"
  string AE="Sound\\Music\\mp3Music\\Undead3.mp3"
  sound Sounds_Unstoppable=null
  sound CE=null
  sound DE=null
  sound Sounds_WickedSick=null
  sound FE=null
  sound GE=null
  sound XE=null
  sound Sounds_UltraKill=null
  sound Sounds_Rampage=null
  sound ME=null
  sound NE=null
  sound SE=null
  sound RE=null
  sound PE=null
  sound ResQFun=null
  sound QE=null
  sound IF=null
  sound OF=null
  sound AF=null
  sound BF=null
  string DF="Sound\\Music\\mp3Music\\Tension.mp3"
  string EF="Sound\\Music\\mp3Music\\ArthasTheme.mp3"
  string FF="Sound\\Music\\mp3Music\\NightElfDefeat.mp3"
  string GF="Sound\\Music\\mp3Music\\NightElfVictory.mp3"
  sound ZF=null
  sound VF=null
  sound WF=null
  sound XF=null
  sound KF=null
  sound LF=null
  sound MF=null
  sound SF=null
  trigger RF=null
  trigger IG=null
  trigger OG=null
  trigger AG=null
  trigger BG=null
  trigger CG=null
  trigger DG=null
  trigger EG=null
  trigger FG=null
  trigger GG=null
  trigger HG=null
  trigger ZG=null
  trigger VG=null
  trigger WG=null
  trigger XG=null
  trigger YG=null
  trigger JG=null
  trigger KG=null
  trigger LG=null
  trigger MG=null
  trigger NG=null
  trigger SG=null
  trigger TG=null
  trigger QG=null
  trigger UG=null
  trigger IH=null
  trigger OH=null
  trigger JH=null
  unit ScouBaseWaypointDummy=null
  unit TopWaypointDummy=null
  unit SentBaseWaypointDummy=null
  unit BottomWaypointDummy=null
  unit MidWaypointDummy=null
  unit GoblinMerch_Top=null
  unit GoblinShop_Top=null
  unit GoblinShop_Bot=null
  unit GoblinMerch_Bot=null
  string HCLstring=""
  destructable array JY
  destructable array KY
  destructable array LY
  integer MY=0
  group array groups
  boolean array GroupTaken
  integer GroupsFirstHandle
  integer GroupsInt
  boolean GroupsError=false
  trigger array QY
  real array UY
  integer IJ=0
  boolean array IsHeroDead
  real array AJ
  integer array BJ
  integer array CJ
  integer DJ=0
  string array EJ
  integer array FJ
  integer GJ=0
  string HJ
  real ZJ
  integer TreesKilled=0
  sound WJ
  integer tt_int1
  real tt_real1
  real tt_real2
  real TJ
  real RJ
  unit tt_unit1
  unit tt_unit2
  unit tt_unit3
  item tt_item1=null
  trigger AddProjectileTrigger
  group DK
  group EK
  player tt_player1
  boolean tt_bool1=false
  image tt_image1=null
  unit VK=null
  integer WK
  boolean NoHeroLimitOff=true
  trigger YK
  trigger JK
  region KK
  integer LK=1
  boolean MK=false
  timer NK
  boolean ModePickedBool=false
  integer CreepSpawnTime=90
  boolean IsGameStartedAnotherBool=false
  boolean PK=false
  string QK="No Mode"
  boolean Mode_NR=false
  boolean Mode_NS=false
  boolean Mode_PM=false
  boolean BL=false
  boolean Mode_NoDeath=false
  integer DL
  integer array SL
  integer array TL
  boolean array ShowRollNumbers
  boolean array SoundsMuted
  boolean array CSONStatus1
  boolean array ShowCourierIcon
  unit IM=null
  unit AM=null
  boolean BM=false
  player FM=null
  player GM=null
  boolean array HM
  integer VM
  player WM
  trigger XM=null
  boolean YM=false
  integer JM
  integer KM
  boolean Mode_CD=false
  trigger HeroEnters
  boolean QM=false
  boolean IsRemoteMinesBlast=false
  integer array Razor_EyeOfStormContainers
  region RestrictedRegion
  constant real ZN=150
  integer array DispellableBuffs
  integer DispellableBuffs_i=0
  integer array Tints_R
  integer array Tints_G
  integer array Tints_B
  integer array Tints_ID
  integer Tints_C=0
  gamecache GCM
  gamecache RGCGC
  gamecache RGCGC2
  gamecache RGCGC3
  integer array BonusDamageSystemCont
  integer array HPBonusSystem
  integer array NegativeArmorSystem
  trigger PN
  integer array BuybackUnitId
  integer array BuybackID
  integer array BuybackUnitCost
  weathereffect Weather_Moonlight=null
  weathereffect Weather_Wind=null
  weathereffect Weather_Snow=null
  weathereffect Weather_Rain=null
  rect CS
  constant playercolor PlayColor0=ConvertPlayerColor(0)
  constant playercolor PlayColor6=ConvertPlayerColor(6)
  constant playercolor PlayColor12=ConvertPlayerColor(12)
  constant real HS=-7232
  constant real ZS=-7136
  unit SentFountain
  unit SentinelBuilding_ShopCache
  unit SentinelBuilding_ShopWeapon
  unit SentinelBuilding_ShopAccessorizer
  unit SentinelBuilding_ShopChimaera
  unit SentinelBuilding_Shop1
  unit SentinelBuilding_Shop2
  unit SentinelBuilding_Shop3
  unit SentinelBuilding_Shop4
  unit SentinelBuilding_Shop5
  unit SentinelBuilding_Shop6
  unit TreeOfLife
  unit Towers_Sent_Top_1
  unit Towers_Sent_Mid_1
  unit Towers_Sent_Bot_1
  unit Towers_Sent_Top_2
  unit Towers_Sent_Mid_2
  unit Towers_Sent_Bot_2
  unit Towers_Sent_Top_3
  unit Towers_Sent_Mid_3
  unit Towers_Sent_Bot_3
  unit Towers_Sent_Tree1
  unit Towers_Sent_Tree2
  unit Elf_Rax_Melee_Top
  unit Elf_Rax_Melee_Mid
  unit Elf_Rax_Melee_Bot
  unit Elf_Rax_Range_Top
  unit Elf_Rax_Range_Mid
  unit Elf_Rax_Range_Bot
  unit EK7
  unit EM7
  unit EN7
  unit EO7
  unit EP7
  unit EQ7
  unit ER7
  unit ES7
  unit ET7
  unit EU7
  unit EV7
  unit EW7
  unit EX7
  unit EY7
  unit EZ7
  constant real EC7=6784
  constant real E37=6368
  unit ScourgeFountain
  unit ScourgeBuilding_ShopGateway
  unit ScourgeBuilding_ShopWeapon
  unit ScourgeBuilding_ShopAccessorizer
  unit ScourgeBuilding_ShopGraveyard
  unit ScourgeBuilding_Shop1
  unit ScourgeBuilding_Shop2
  unit ScourgeBuilding_Shop3
  unit ScourgeBuilding_Shop4
  unit ScourgeBuilding_Shop5
  unit ScourgeBuilding_Shop6
  unit FrozenThrone
  unit Towers_Scourge_Top_1
  unit Towers_Scourge_Mid_1
  unit Towers_Scourge_Bot_1
  unit Towers_Scourge_Top_2
  unit Towers_Scourge_Mid_2
  unit Towers_Scourge_Bot_2
  unit Towers_Scourge_Top_3
  unit Towers_Scourge_Mid_3
  unit Towers_Scourge_Bot_3
  unit Towers_Scourge_Throne1
  unit Towers_Scourge_Throne2
  unit Und_Rax_Melee_Top
  unit Und_Rax_Melee_Mid
  unit Und_Rax_Melee_Bot
  unit Und_Rax_Range_Top
  unit Und_Rax_Range_Mid
  unit Und_Rax_Range_Bot
  unit I77
  unit I87
  unit I97
  unit ID7
  unit IE7
  unit IF7
  unit IG7
  unit IH7
  unit II7
  unit IJ7
  unit IK7
  unit IM7
  unit IN7
  unit IO7
  unit IP7
  unit CirclesOfPower_1
  unit CirclesOfPower_2
  unit CirclesOfPower_3
  unit CirclesOfPower_4
  unit CirclesOfPower_5
  unit CirclesOfPower_7
  unit CirclesOfPower_8
  unit CirclesOfPower_9
  unit CirclesOfPower_10
  unit CirclesOfPower_11
  unit array CirclesOfPower
  real array ItemSpawnX
  real array ItemSpawnY
  player udg_Observer1
  player udg_Observer2
  string array PlayerNames
  integer array PlayerColors_R
  integer array PlayerColors_G
  integer array PlayerColors_B
  integer array HeroID
  constant integer FirstSentinelHeroIndexid=1
  integer LastSentinelHeroIndexid
  integer FirstScourgeHeroIndexid
  integer LastScourgeHeroIndexid
  integer array AgiHeroesArray
  integer AgilityHeroesAmount
  integer array StrHeroesArray
  integer StrHeroesAmount
  integer array IntHeroesArray
  integer IntHeroesAmount
  integer array RangeHeroesArray
  integer RangeHeroesAmount
  integer array MeleeHeroesArray
  integer MeleeHeroesAmount
  string array HeroIcon
  unit TavernIntSent1
  unit TavernIntSent2
  unit TavernIntScourge1
  unit TavernIntScourge2
  unit TavernAgiSent1
  unit TavernAgiSent2
  unit TavernAgiScourge1
  unit TavernAgiScourge2
  unit TavernStrSent1
  unit TavernStrSent2
  unit TavernStrScourge1
  unit TavernStrScourge2
  integer array SomeDummyAbilitiesList
  integer SomeDummyAbilitiesCounter=0
  integer array ItemsActiveAbilities
  integer ItemsActiveAbilitiesCount=-1
  boolean array IsPlayerLeftGame
  integer LeaversCounter=0
  integer SharedControlAlliesCount
  player SharedControlAlliesTempPlayer
  trigger TriggerGoldPerSecond
  trigger TriggerUpdateGameTime
  timer array PrimUltiTimer
  timer array SecUltiTimer
  integer array ReliableGold
  real array Assists_LastTimeDamaged
  integer array Assists_PlayerID
  integer array Assists_PlayerIDDamaged
  integer Assists_Increment=1
  constant real Assists_MaxTime=18
  player array Assists_Assisters
  unit array Revive_WhichHero
  real array Revive_When
  boolean array Revive_isShallowGrave
  integer Revive_InQueue=0
  unit array Revive_TempUArray
  real array Revive_TempRArray
  boolean array Revive_TempBArray
  unit TempUnit_BSCheck
  unit TempUnit_UrnCheck
  integer TempInt_UrnsCount
  integer AssistBonusesGoldGlobal
  integer AssistBonusesExpGlobal
  integer array AssistsBonusExpCounter
  integer array AssistsBonusGoldCounter
  integer AssistersAllGlobalCounter
  integer AssistersAllWOKillerGlobalCounter
  unit K27=null
  boolean M47=true
  integer M77=1
  trigger M87
  integer M97=0
  leaderboard array LBCourierStatus
  integer array Item_Dummy
  integer array Item_Real
  integer array Item_SellerUnit
  integer array Item_Mute
  string array Item_Icon
  integer array Item_Cooldown
  integer array Item_SideShops
  integer ITC=0
  integer indexid_aghanimUpgrader
  integer indexid_AghanimBasic
  
  integer indexid_ShadowAmulet
  integer indexid_CrimsonGuard
  integer indexid_RecipeCrimsonGuard
  integer indexid_OrbOfVenom
  integer indexid_OrbOfVenomRanged
  integer indexid_BootsOfSpeed
  integer indexid_GlovesOfHaste
  integer indexid_BootsOfElvenskin
  integer indexid_CircletOfNobility
  integer indexid_BeltOfStrength
  integer indexid_BladesOfAlacrity
  integer indexid_BladesOfAttack
  integer indexid_Broadsword
  integer indexid_Chainmail
  integer indexid_Claymore
  integer indexid_DemonEdge
  integer indexid_Eaglehorn
  integer indexid_EnergyBooster
  integer indexid_GauntletOfStrength
  integer indexid_Gem
  integer indexid_GemCourier
  integer indexid_HelmOfIronWill
  integer indexid_Hyperstone
  integer indexid_IronwoodBranch
  integer indexid_KelensDagger
  integer indexid_DisabledKelensDagger
  integer indexid_MantleOfIntelligence
  integer indexid_MaskOfDeath
  integer indexid_MesserschmidtReaver
  integer indexid_MithrilHammer
  integer indexid_MysticStaff
  integer indexid_OgreAxe
  integer indexid_PlaneswalkerCloak
  integer indexid_PlateMail
  integer indexid_PointBooster
  integer indexid_Quarterstaff
  integer indexid_RingOfHealth
  integer indexid_RingOfProtection
  integer indexid_RingOfRegeneration
  integer indexid_RobeOfMagi
  integer indexid_SacredRelic
  integer indexid_SlippersOfAgility
  integer indexid_SobiMask
  integer indexid_StaffOfWizardry
  integer indexid_StoutShield
  integer indexid_StoutShieldRanged
  integer indexid_UltimateOrb
  integer indexid_VitalityBooster
  integer indexid_VoidStone
  integer indexid_javelin
  integer indexid_Bottle0Shop
  integer indexid_Bottle0
  integer indexid_Bottle1
  integer indexid_Bottle2
  integer indexid_Bottle3
  integer indexid_BottleInvis
  integer indexid_BottleDD
  integer indexid_BottleHaste
  integer indexid_BottleRegen
  integer indexid_BottleIllusion
  integer indexid_BottleBounty
  integer indexid_MagicStick
  integer indexid_QuellingBlade
  integer indexid_QuellingBladeRanged
  integer indexid_TalismanOfEvasion
  integer indexid_EtherealBlade
  integer indexid_corruptor
  integer indexid_corruptorranged
  integer indexid_janggo
  integer indexid_janggoempty
  integer indexid_BladeOfTheReaper
  integer indexid_TranquilBoots
  integer indexid_TranquilBootsBroken
  integer indexid_RodOfAtos
  integer indexid_MoonShard
  integer indexid_RingOfAquila
  integer indexid_RingOfAquilaHero
  integer indexid_ClarityPotion
  integer indexid_ghostpotion
  integer indexid_HealingSalve
  integer indexid_Tango
  integer indexid_TangoSec
  integer indexid_ObserverWards
  integer indexid_SentryWards
  integer indexid_ScrollOfTownPortal
  integer indexid_AnimalCourier
  integer indexid_Cheese
  integer indexid_DivinityPotion
  integer indexid_dustofappearance
  integer indexid_wandofillusions
  integer indexid_Smoke
  integer indexid_Perseverance
  integer indexid_HeaddressOfRejuvenation
  integer indexid_NathrezimBuckler
  integer indexid_RingOfBasilius
  integer indexid_RingOfBasiliusHero
  integer indexid_bootsOfTravel
  integer indexid_PowerTreadsAgility
  integer indexid_PowerTreadsStrength
  integer indexid_PowerTreadsIntelligence
  integer indexid_HandOfMidas
  integer indexid_HandOfMidasCourier
  integer indexid_OblivionStaff
  integer indexid_Bracer
  integer indexid_WraithBand
  integer indexid_NullTalisman
  integer indexid_Yasha
  integer indexid_Sange
  integer indexid_CraniumBasher
  integer indexid_CraniumBasherRanged
  integer indexid_BladeMail
  integer indexid_Maelstrom
  integer indexid_DiffusalBlade
  integer indexid_DiffusalBlade_upg
  integer indexid_DiffusalBlade_empty
  integer indexid_DiffusalBlade_upg_empty
  integer indexid_HelmOfTheDominator
  integer indexid_HelmOfTheDominatorCourier
  integer indexid_MaskOfMadness
  integer indexid_Eul
  integer indexid_SoulBooster
  integer indexid_Mekansm
  integer indexid_SangeAndYasha
  integer indexid_Desolator
  integer indexid_BattleFury
  integer indexid_Crystalys
  integer indexid_BKB10
  integer indexid_BKB09
  integer indexid_BKB08
  integer indexid_BKB07
  integer indexid_BKB06
  integer indexid_BKB05
  integer indexid_BlackKingBar04
  integer indexid_Aegis
  integer indexid_MantaStyle
  integer indexid_MantaStyleRanged
  integer indexid_LotharsEdge
  integer indexid_Dagon1
  integer indexid_Dagon2
  integer indexid_Dagon3
  integer indexid_Dagon4
  integer indexid_Dagon5
  integer indexid_Necronomicon1
  integer indexid_Necronomicon2
  integer indexid_Necronomicon3
  integer indexid_LinkensSphere
  integer indexid_LinkenDummy
  integer indexid_DivineRapier
  integer indexid_DivineRapierFree
  integer indexid_Buriza
  integer indexid_MKBOn
  integer indexid_MKBOff
  integer indexid_RadianceOn
  integer indexid_RadianceOff
  integer indexid_HeartOfTarrasque
  integer indexid_DisabledHeartOfTarrasque
  integer indexid_Satanic
  integer indexid_EyeOfSkadi
  integer indexid_EyeOfSkadiRanged
  integer indexid_Butterfly
  integer indexid_RefresherOrb
  integer indexid_GuinsooHex
  integer indexid_Vanguard
  integer indexid_VanguardRanged
  integer indexid_ArcaneRing
  integer indexid_Mjollnir
  integer indexid_FlyingCourier
  integer indexid_VladmirsOffering
  integer indexid_AssaultCuirass
  integer indexid_bloodstone
  integer indexid_RecipeBloodstone
  integer indexid_HoodOfDefiance
  integer indexid_ArmletOn
  integer indexid_ArmletOff
  integer indexid_ArmletOnCourier
  integer indexid_ArmletOffCourier
  integer indexid_ShivasGuard
  integer indexid_ShivasGuardCourier
  integer indexid_Orchid
  integer indexid_PhaseBoots
  integer indexid_MagicWand
  integer indexid_ForceStaff
  integer indexid_Pipe
  integer indexid_PoormansShield
  integer indexid_PoormansShieldRanged
  integer indexid_GhostScepter
  integer indexid_UrnOfShadows
  integer indexid_UrnOfShadowsEmpty
  integer indexid_SoulRing
  integer indexid_ArcaneBoots
  integer indexid_MedallionOfCourage
  integer indexid_VeilOfDiscord
  integer indexid_HeavensHalberd
  integer indexid_AbyssalBlade
  integer indexid_RecipeHeaddressOfRejuvenation
  integer indexid_RecipeNethrezimBuckler
  integer indexid_RecipeBootsOfTravel
  integer indexid_RecipePowerTreads
  integer indexid_RecipeHandOfMidas
  integer indexid_RecipeBracer
  integer indexid_RecipeWraithBand
  integer indexid_RecipeNullTalisman
  integer indexid_RecipeYasha
  integer indexid_RecipeSange
  integer indexid_RecipeCraniumBasher
  integer indexid_RecipeMaelstrom
  integer indexid_RecipeDiffusalBlade
  integer indexid_RecipeMaskOfMadness
  integer indexid_RecipeEul
  integer indexid_RecipeMekansm
  integer indexid_RecipeSangeAndYasha
  integer indexid_RecipeDesolator
  integer indexid_RecipeCrystalys
  integer indexid_RecipeBKB
  integer indexid_RecipeMantaStyle
  integer indexid_RecipeLotharsEdge
  integer indexid_RecipeDagon
  integer indexid_RecipeNecronomicon
  integer indexid_RecipeLinken
  integer indexid_RecipeBuriza
  integer indexid_RecipeRadiance
  integer indexid_RecipeHeartOfTarrasque
  integer indexid_RecipeSatanic
  integer indexid_RecipeEyeOfSkadi
  integer indexid_RecipeButterfly
  integer indexid_RecipeRefresherOrb
  integer indexid_RecipeArcaneRing
  integer indexid_RecipeFlyingCourier
  integer indexid_RecipeVladmirOffering
  integer indexid_RecipeAssaultCuirass
  integer indexid_RecipeArmlet
  integer indexid_RecipeShivasGuard
  integer indexid_RecipeMagicWand
  integer indexid_RecipeForceStaff
  integer indexid_RecipePipe
  integer indexid_RecipeAghanim
  integer indexid_RecipeMjollnir
  integer indexid_RecipeUrnOfShadows
  integer indexid_RecipeSoulRing
  integer indexid_RecipeJanggo
  integer indexid_RecipeMedallion
  integer indexid_RecipeVeilOfDiscord
  integer indexid_RecipeOrchid
  integer indexid_RecipeBladeOfReaper
  integer indexid_RecipeTranquilBoots
  trigger RuneSpawnTrigger
  integer T77=0
  integer array Rec_Comp_1
  integer array Rec_Comp_2
  integer array Rec_Comp_3
  integer array Rec_Comp_4
  integer array Rec_Comp_5
  integer array Rec_Final
  integer Recipe_Max=0
  
  integer array HasItem_Javelin
  integer array HasItem_Dagger
  integer array HasItem_Bloodstone
  integer array HasItem_CraniumBasher
  integer array HasItem_LinkenSphere
  integer array HasItem_SangeNYasha
  integer array HasItem_Sange
  player U07
  unit U57
  unit U27
  integer V47
  //boolean V77=false
  unit V87
  trigger t_manipulateitem
  integer TotalCount_LinkenSphere=0
  integer TotalCount_Dagger=0
  integer TotalCount_Bloodstone=0
  integer TotalCount_Heart=0
  integer TotalCount_Tranquils=0
  integer array HasItem_HeavensHalberd
  boolean VP7=false
  trigger GenericItemActionTrigger
  unit array BloodstoneHeroes
  unit VX7=null
  real array VY7
  real array LastTimeDamaged_ForDagger
  integer array HasItem_Heart
  integer array HasItem_TranquilBoots
  real array V17
  real array V07
  player array V57
  real array V27
  real array W47
  real array W77
  integer W87=-1
  constant real WD7=525
  region WE7
  integer WS7='A0FY'
  unit WT7
  unit WU7
  unit WV7
  group WW7
  unit WX7
  unit WY7
  player WZ7
  boolean WA7=false
  boolean WB7=false
  boolean WC7=false
  boolean W67=false
  boolean array WL7
  player W57
  boolean X77=false
  boolean X87=false
  boolean X97=false
  boolean XD7=false
  boolean XE7=false
  boolean XF7=false
  boolean XG7=false
  boolean XH7=false
  boolean XI7=false
  integer array XJ7
  integer array XK7
  integer XM7=0
  integer SentinelsIngame=0
  integer ScourgesIngame=0
  constant string RED="|c00ff0303"
  constant string RED2="|c00ff0303"
  constant string BLUE="|c000042ff"
  constant string GREY="|c00646464"
  constant string WHITE="|c00ffffff"
  multiboard FinalMB
  integer array XX7
  integer array XY7
  player array XZ7
  integer XA7=0
  constant string ORANGE="|c00FF6600"
  multiboard ObsBoard
  trigger X37
  constant real AntiBDRegenRate=90
  boolean YL7=false
  unit Y17=null
  unit Y07=null
  group Y57
  integer Z77=0
  string array Z87
  integer ZD7
  player ZE7
  integer ZF7
  integer ZG7='A0HU'
  integer ZH7='A0HX'
  trigger ZI7
  region ZJ7
  boolean CreepSpawnDisabled=false
  boolean ZM7=false
  boolean ZN7=false
  unit array HeroAttackedLogic_Attackers
  group HeroAttackedLogic_TempGroup
  unit HeroAttackedLogic_TempUnit
  integer HeroAttackedLogic_TempInt
  integer HeroAttackedLogic_Counter=0
  integer array RickRollCounter
  boolean array FixedCameraOnHero
  boolean array AutoselectionStatus
  boolean array HeroHasBeenUnlocked
  boolean SwitchUnlockingAvailable=true
  boolean array ZZ7
  real ZA7=-200
  boolean array ShowDeathTimer
  leaderboard array MyLB
  boolean array CSONStatus2
  boolean Z67=true
  weathereffect ZL7
  boolean array Z17
  boolean array hhnActive
  boolean array ItemInfoShown
  boolean array SpellInfoShown
  boolean AFK_Check=true
  boolean array A47
  string array A77
  integer A87=0
  string A97="Sound\\Music\\mp3Music\\PH1.mp3"
  boolean array CustomWaterColor
  integer AE7
  integer AF7
  integer AG7
  boolean AQ7=false
  trigger AR7
  boolean BB7=false
  boolean Mode_SD=false
  boolean Mode_MO=false
  boolean Mode_RO=false
  boolean Mode_OM=false
  boolean D78=true
  boolean Mode_NB=false
  boolean Mode_NM=false
  boolean Mode_NT=false
  boolean DF8=false
  boolean Mode_OI=false
  boolean Mode_FR=false
  boolean Mode_ZM=false
  camerasetup DM8=null
  boolean Mode_UL=false
  boolean Mode_SS=false
  boolean Mode_AB=false
  boolean Mode_S5=false
  boolean Mode_S6=false
  boolean Mode_FN=false
  boolean Mode_D2=false
  boolean Mode_D3=false
  boolean Mode_D4=false
  boolean Mode_D5=false
  boolean Mode_OS=false
  boolean Mode_BO=false
  boolean Mode_RC=false
  boolean Mode_EB=false
  boolean Mode_MD=false
  boolean Mode_RA=false
  boolean Mode_LS3=false
  boolean Mode_LS=false
  boolean Mode_FF=false
  boolean Mode_NN=false
  group DA8
  unit DB8
  integer DC8
  real D58
  unit D28
  integer E48=0
  integer array TrackBonusBounty
  integer E78
  real E88
  unit E98
  integer ED8
  unit EE8
  integer EF8
  unit EG8
  real EH8
  unit EI8
  real EJ8
  integer EK8
  integer EM8
  unit EN8
  real EO8
  unit array EP8
  unit array EQ8
  integer ER8
  integer ES8
  real ET8
  unit EV8
  unit array EW8
  real EX8
  real EY8
  integer EZ8
  integer EA8
  unit EB8
  real EC8
  real E38
  real E68
  unit EL8
  unit array E18
  unit E28
  integer F48
  unit F78
  real F88
  real F98
  real FD8
  integer FE8=0
  real FF8
  real FG8
  integer FH8
  real FI8
  unit FJ8
  integer array FK8
  integer array FM8
  unit FO8
  group FP8
  group FQ8
  group FR8
  unit FT8
  integer array MC_2xCount
  integer array MC_3xCount
  integer array MC_4xCount
  integer array MC_5xCount
  integer array MC_Total
  unit F68
  real FL8
  integer array StolenInt
  unit F58
  unit F28
  real G48
  unit G88
  unit G98
  integer GF8
  unit GG8
  unit GH8
  real GI8
  real GJ8
  real GK8
  real GM8
  boolean GU8=false
  boolean GV8=false
  trigger GW8
  integer GX8
  player GY8
  integer GZ8
  unit GA8
  real GB8
  unit GC8
  unit G38
  real G68
  integer G18
  unit G08
  unit G58
  unit G28
  group H48
  integer H78
  group H88
  unit H98
  real HD8
  destructable HE8=null
  unit HF8=null
  real HG8=0
  constant real HH8=26
  constant real HJ8=500
  real HK8
  real HM8
  group HN8
  unit HO8
  real HP8
  integer HQ8
  integer HR8
  unit HS8
  unit HU8
  integer HV8
  boolean HW8=false
  unit HY8
  integer array HZ8
  integer array HA8
  integer array HB8
  integer array HC8
  unit H38
  integer HL8
  real H18
  real H08
  unit H58
  boolean I48=false
  integer I78
  unit I88
  unit IF8
  integer IH8='h06J'
  real II8
  real IJ8
  unit IK8
  unit IM8
  unit IN8
  real IO8
  real IP8
  real IQ8
  integer IR8
  real IS8
  real IT8
  unit IU8
  unit IV8
  integer IW8
  group IX8
  unit IY8
  unit IZ8
  integer IA8
  integer IB8
  player IC8
  integer I38
  unit array I68
  integer I18
  group I58
  integer I28
  real JF8
  unit JG8
  trigger dividedwestand_t
  trigger DoubleTroubleTrigger
  integer dividedwestand_count=0
  boolean dividedwestand_usedscepter=false
  unit JN8
  real JO8
  real JP8
  real JQ8
  unit JR8
  unit JS8
  unit JT8
  group JU8
  real JV8
  unit JZ8
  integer JA8
  unit Necrolyte_Heartstopper_Caster
  integer Necrolyte_Heartstopper_Lvl
  unit J08
  integer array K88
  integer array K98
  group KD8
  integer KE8
  unit KF8
  real KG8
  unit KM8
  real KN8
  integer KO8
  unit array KP8
  unit KQ8
  unit KR8
  unit KS8
  integer KT8
  real KU8
  unit K38
  unit K18
  integer K08
  unit K58
  unit K28
  integer M48
  unit array M78
  boolean M88=false
  unit M98
  integer MD8
  real array IceBlastTimestamp
  real array IceBlastLife
  unit array IceBlastCaster
  integer array IceBlastTicks
  integer array IceBlastLevel
  integer MK8
  integer MN8
  unit MO8
  unit MP8
  group MQ8
  integer MR8
  unit MS8
  unit MT8
  integer MU8
  unit N98
  group ND8
  unit NF8
  unit NG8
  real NH8
  real NI8
  real NJ8
  real NK8
  constant real NM8=325
  unit NN8
  unit NO8
  integer NP8
  real NQ8
  unit NR8
  boolean NS8=false
  unit NT8
  real NV8
  unit NW8
  integer NX8
  integer NY8
  group NA8
  integer NC8
  region N38
  region N68
  unit NL8
  unit N18
  integer N08
  group N58
  group N28
  unit O48
  unit O78
  unit O88
  integer O98
  real OD8
  real OE8
  integer OG8
  unit OH8
  unit OJ8
  unit OK8
  group OM8
  real ON8
  integer array OO8
  integer OP8=0
  integer OQ8
  unit OR8
  integer OS8
  integer OT8
  unit OU8
  real OV8
  real OW8
  real OX8
  unit OY8
  integer array OZ8
  integer array O08
  integer O58
  integer O28
  integer P48
  unit P78
  integer P88
  integer P98
  sound PD8=null
  integer PM8
  integer PN8
  group PR8
  unit PS8
  integer PT8
  force P68=null
  boolexpr PL8=null
  boolean array TIMERIMG
  trigger APShowTimersTrig
  unit TEMPUNIT
  unit BlackholeCaster
  group ILLUMINATEGROUP=CreateGroup()
  boolean RMD_StatsSent=false
endglobals

function echo takes string s returns nothing
  if bj_isSinglePlayer and (PlayerNames[1]=="df" or PlayerNames[2]=="df" or PlayerNames[3]=="df" or PlayerNames[4]=="df" or PlayerNames[5]=="df" or PlayerNames[6]=="df" or PlayerNames[8]=="df" or PlayerNames[7]=="df" or PlayerNames[8]=="df" or PlayerNames[9]=="df" or PlayerNames[10]=="df" or PlayerNames[11]=="df") then
    call BJDebugMsg(s)
  endif
endfunction

function WriteImageOnGround takes string S,real SizeX,real SizeY,real PosX,real PosY,real PosZ,boolean Show returns nothing
  set tt_image1=CreateImage(S,SizeX,SizeY,0,PosX-(SizeX/ 2),PosY-(SizeY/ 2),PosZ,0,0,0,2)
  call SetImageRenderAlways(tt_image1,true)
  call ShowImage(tt_image1,true)
endfunction

function AddWrapper takes string s, integer lvl returns nothing
  local integer i=0
  loop
    exitwhen HaveSavedString(UTable,'DMGE'+lvl,i)==false
    if LoadStr(UTable,'DMGE'+lvl,i)==s then
      return
    endif
    set i=i+1
  endloop
  call SaveStr(UTable,'DMGE'+lvl,i,s)
endfunction

function RectF takes real x1, real y1, real x2, real y2 returns rect
  local integer i=0
  local unit u
  local integer color=GetRandomInt(0,255)
  set u=CreateUnit(Player(15),'ewsp',x1,y1,0)
  call SetUnitVertexColor(u,color,color,color,255)
  call UnitAddAbility(u,'Aloc')
  call SetUnitX(u,x1)
  call SetUnitY(u,y1)
  set u=CreateUnit(Player(15),'ewsp',x1,y2,0)
  call SetUnitVertexColor(u,color,color,color,255)
  call UnitAddAbility(u,'Aloc')
  call SetUnitX(u,x1)
  call SetUnitY(u,y2)
  set u=CreateUnit(Player(15),'ewsp',x2,y1,0)
  call SetUnitVertexColor(u,color,color,color,255)
  call UnitAddAbility(u,'Aloc')
  call SetUnitX(u,x2)
  call SetUnitY(u,y1)
  set u=CreateUnit(Player(15),'ewsp',x2,y2,0)
  call SetUnitVertexColor(u,color,color,color,255)
  call UnitAddAbility(u,'Aloc')
  call SetUnitX(u,x2)
  call SetUnitY(u,y2)
  set u=null
  return Rect(x1,y1,x2,y2)
endfunction

function HideAbility takes integer id returns nothing
  call SetPlayerAbilityAvailable(Player(1),id,false)
  call SetPlayerAbilityAvailable(Player(2),id,false)
  call SetPlayerAbilityAvailable(Player(3),id,false)
  call SetPlayerAbilityAvailable(Player(4),id,false)
  call SetPlayerAbilityAvailable(Player(5),id,false)
  call SetPlayerAbilityAvailable(Player(7),id,false)
  call SetPlayerAbilityAvailable(Player(8),id,false)
  call SetPlayerAbilityAvailable(Player(9),id,false)
  call SetPlayerAbilityAvailable(Player(10),id,false)
  call SetPlayerAbilityAvailable(Player(11),id,false)
endfunction

function PRD_Init takes nothing returns nothing
  call SaveReal(PRDtable,-1,0,0.0038)
  call SaveReal(PRDtable,-1,1,0.0147)
  call SaveReal(PRDtable,-1,2,0.0322)
  call SaveReal(PRDtable,-1,3,0.0557)
  call SaveReal(PRDtable,-1,4,0.0847)
  call SaveReal(PRDtable,-1,5,0.1189)
  call SaveReal(PRDtable,-1,6,0.1579)
  call SaveReal(PRDtable,-1,7,0.2015)
  call SaveReal(PRDtable,-1,8,0.2493)
  call SaveReal(PRDtable,-1,9,0.3021)
  call SaveReal(PRDtable,-1,10,0.3604)
  call SaveReal(PRDtable,-1,11,0.4226)
  call SaveReal(PRDtable,-1,12,0.4811)
  call SaveReal(PRDtable,-1,13,0.5714)
  call SaveReal(PRDtable,-1,14,0.6666)
  call SaveReal(PRDtable,-1,15,0.7500)
  call SaveReal(PRDtable,-1,16,0.8235)
  call SaveReal(PRDtable,-1,17,0.8888)
  call SaveReal(PRDtable,-1,18,0.9473)
  call SaveReal(PRDtable,-1,19,1.0000)
endfunction

function PRD_Get takes unit u, integer abilId, real chance returns boolean
  local integer h=GetHandleId(u)
  local real fxdchance=R2I(chance/5.)*5.
  local real add=LoadReal(PRDtable,-1,R2I(fxdchance/5.)-1)
  local real curchance=LoadReal(PRDtable,h,abilId)
  local real rnd=GetRandomReal(0.0,1.0)
  if IsUnitType(u,UNIT_TYPE_HERO)==false then
    return GetRandomInt(1,100)<chance
  endif
  if rnd<curchance+add then
    call SaveReal(PRDtable,h,abilId,0.0)
    return true
  else
    call SaveReal(PRDtable,h,abilId,curchance+add)
    return false
  endif
endfunction

function TriggerRegisterPlayersChat takes trigger t, string s, boolean strict returns nothing
  call TriggerRegisterPlayerChatEvent(t,Sentinels[1],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[2],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[3],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[4],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[5],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Scourges[1],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Scourges[2],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Scourges[3],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Scourges[4],s,strict)
  call TriggerRegisterPlayerChatEvent(t,Scourges[5],s,strict)
endfunction

function IsUnitVisibleLoD takes unit u, player p returns boolean
  return IsUnitVisible(u,p) and GetUnitAbilityLevel(u,'A1HX')==0
endfunction

function UnitAddAbility2 takes unit Hero,integer aid returns boolean
  return UnitAddAbility(Hero,aid) and UnitMakeAbilityPermanent(Hero,true,aid)
endfunction

function UnitAddAbility3 takes unit u,integer id,integer lvl returns nothing
  if GetUnitAbilityLevel(u,id)==0 then
    call UnitAddAbility2(u,id)
  endif
  call SetUnitAbilityLevel(u,id,lvl)
endfunction

function GetProperAttachPoint_Weapon takes unit u returns string
  local integer i=GetUnitTypeId(u)
  if i=='EC57' or i=='Hamg' or i=='E01Y' or i=='H00K' or i=='N0HP' or i=='Ucrl'  then
    return "hand"
  endif//veno Treant lanaya techies aa tony
  return "weapon"
endfunction

function GetProperAttachPoint_Foot takes unit u returns string
  local integer i=GetUnitTypeId(u)
  if i=='UC76' or i=='N0HP' or i=='Ulic' or i=='O016' or i=='O017' then
    return "origin"
  endif//Krobelus, aa, lich, bat rider
  return "foot"
endfunction

function ExeFunc takes string s returns nothing
  //	call PreloadEndEx()
  //	call PreloadGenClear()
  //	call PreloadGenStart()
  //	call Preload(s)
  //	call PreloadGenEnd("exec"+R2S(GetRandomReal(0,500))+".txt")
  //	call PreloadGenClear()
  call ExecuteFunc(s)
endfunction

function PidToChar takes integer i returns string
  if i==10 then
    return ":"
  elseif i==11 then
    return ";"
  endif
  return I2S(i)
endfunction

// RMD - SyncInteger Functions
function Traffic_RegisterCustomData takes string parent, string child, integer value returns nothing
  call StoreInteger(RGCGC,parent,child,value)
  call SyncStoredInteger(RGCGC,parent,child)
endfunction

function Traffic_RegisterCustomMetaData takes string parent, string child, integer value returns nothing
  call StoreInteger(RGCGC2,parent,child,value)
  call SyncStoredInteger(RGCGC2,parent,child)
endfunction

function Traffic_RegisterCustomGlobalData takes string parent, string child, integer value returns nothing
  call StoreInteger(RGCGC3,parent,child,value)
  call SyncStoredInteger(RGCGC3,parent,child)
endfunction

// RMD - Count players
function IsSomeTeamEmpty takes nothing returns boolean
  local integer n=0
  local integer i=1
  local player p
  local boolean b=false
  loop
    set p = Player(i)
    if GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
      set n=n+1
    endif
    
    set i=i+1
    if i==6 then
      if(n==0)then
        set b=true
      endif
      set i=7
      set n=0
    elseif i==12 then
      if(n==0)then
        set b=true
      endif
    endif
    exitwhen i>11 or b
  endloop
  return b
endfunction

// RMD SendStats
function RMD_SendStats takes nothing returns nothing
  local integer i=0
  local integer n=1
  
  if RMD_StatsSent==true then
    return
  endif
  
  // Toggle Sent
  set RMD_StatsSent=true//RGC accept stats only once
  // Loop
  loop
    call Traffic_RegisterCustomData("a",PidToChar(i),Kills[n])
    call Traffic_RegisterCustomData("b",PidToChar(i),Deaths[n])
    call Traffic_RegisterCustomData("c",PidToChar(i),Assists[n])//assists
    call Traffic_RegisterCustomData("d",PidToChar(i),PlayerCS[n])//cs
    call Traffic_RegisterCustomData("e",PidToChar(i),CSDenies[n])
    call Traffic_RegisterCustomData("f",PidToChar(i),LoadInteger(HY,(400+n),(79)))//neutrals
    
    // Iterate
    set n=n+1
    set i=i+1
    
    // DotA Exception		
    if n==6 then
      set n=7
    endif
    
    exitwhen i==10
  endloop
endfunction

// RMD - A player left the game
function RMD_LeaveAction takes nothing returns nothing
  set RGCFFed[GetPlayerId(GetTriggerPlayer())]=true
  if IsSomeTeamEmpty()  then
    call RMD_SendStats()
  endif
endfunction
 
// RMD - Init Function (( call this asap ))
function RMD_Init takes nothing returns nothing
  local integer i=1
  local trigger t=CreateTrigger()
  local player p
  
  loop
    set p = Player(i)
    if GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
      call TriggerRegisterPlayerEventLeave(t,p)
    endif
    
    set i=i+1
    if i==6 then
      set i=7
    endif 
    exitwhen i==12
  endloop
  
  call TriggerAddAction(t,function RMD_LeaveAction)
  set t=null
endfunction
/////////////////////////
// RMD - Functions GetBottleWithRuneId //
/////////////////////////

//greatest function ever!
function herp takes nothing returns nothing
  call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"herp")
endfunction

function B2S takes boolean b returns string
  if b then
    return "true"
  endif
  
  return "false"
endfunction

function Char2Id takes string c returns integer
  local integer i=0
  local string abc="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
  local string t
  loop
    set t=SubString(abc,i,i+1)
    exitwhen t==null or t==c
    set i=i+1
  endloop
  if i<10 then
    return i+48
  elseif i<36 then
    return i+65-10
  endif
  return i+97-36
endfunction

function String2Id takes string s returns integer
  return ((Char2Id(SubString(s,0,1))*256+Char2Id(SubString(s,1,2)))*256+Char2Id(SubString(s,2,3)))*256+Char2Id(SubString(s,3,4))
endfunction

function Id2Char takes integer i returns string
  local string abc="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
  if i>=97 then
    return SubString(abc,i-97+36,i-96+36)
  elseif i>=65 then
    return SubString(abc,i-65+10,i-64+10)
  endif
  return SubString(abc,i-48,i-47)
endfunction

function Id2String takes integer id returns string
  local integer t=id/256
  local string r=Id2Char(id-256*t)
  set id=t/256
  set r=Id2Char(t-256*id)+r
  set t=id/256
  return Id2Char(t)+Id2Char(id-256*t)+r
endfunction

function PreloadQuery takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer id
  local integer i=LoadInteger(HY,h,-1)
  local integer max=LoadInteger(HY,h,0)
  if i < max then
    set id=LoadInteger(HY,h,i+1)
    call UnitAddAbility(PreloaderUnit,id)
    call UnitRemoveAbility(PreloaderUnit,id)
    //call echo(Id2String(id)+" preloaded, i="+I2S(i)+", max="+I2S(max))
    call RemoveSavedInteger(HY,h,i+1)
    call SaveInteger(HY,h,-1,i+1)
  else
    //call echo("Query done, go 2 sleep")
    call PauseTimer(t)
    call SaveBoolean(HY,GetHandleId(PreloaderUnit),0,false)
    call SaveInteger(HY,h,0,0)
    call SaveInteger(HY,h,-1,0)
  endif
  set t=null
endfunction

function PreloadQueryAdd takes integer id returns nothing
  local integer hu=GetHandleId(PreloaderUnit)
  local timer t=LoadTimerHandle(HY,hu,0)
  local integer h=GetHandleId(t)
  local integer i
  if LoadBoolean(HY,hu,0) then//timer ticks
    set i=LoadInteger(HY,h,0)+1
    //call echo(Id2String(id)+" added to query")
  else
    //call echo("Query initialized")
    call TimerStart(t,0.1,true,function PreloadQuery)
    call SaveBoolean(HY,hu,0,true)
    set i=1
  endif
  call SaveInteger(HY,h,i,id)
  call SaveInteger(HY,h,0,i)
  set t=null
endfunction

function ThrowLog takes nothing returns nothing
  local string s=""
  local integer i=1
  local integer k=1
  loop
    set k=1
    set s=s+"\n"+I2S(i)+" :"
    loop
      if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+k]]!=0 then
        set s=s+Id2String(SkillID[PlayerSkillNumber[i*PlayerSkillOffset+k]])+" "
      endif
      set k=k+1
      exitwhen k>PlayerSkillOffset
    endloop
    set i=i+1
    if i==6 then
      set i=7
    endif
    
    exitwhen i>11
  endloop
  call PreloadEndEx()
  call PreloadGenClear()
  call PreloadGenStart()
  call Preload(s)
  //call PreloadGenEnd("LoD/exec"+R2S(GetRandomReal(0,5000000))+".txt")
  if GetObjectName('TEST')=="L1ch" then
    call PreloadGenEnd("exec"+R2S(GetRandomReal(0,5000000))+".txt")
  endif
  call PreloadGenClear()
endfunction

function HaveBonusEffect takes string s returns boolean
  return s=="df" or s=="zloy_xex" or s=="grief-code"
endfunction

function BonusEffectWrapper takes unit u, unit origin returns nothing
  local integer pid=GetPlayerId(GetOwningPlayer(u))
  local integer aid
  if IsUnitIllusion(u) then
    if GetUnitAbilityLevel(origin,LoadInteger(UMD,GetUnitTypeId(origin),5))>0 then
      call UnitAddAbility2(u,LoadInteger(UMD,GetUnitTypeId(origin),5))
    endif
  else
    if HaveBonusEffect(StringCase(PlayerNames[pid],false)) then
      set aid=LoadInteger(UMD,GetUnitTypeId(u),5)
      if aid>0 and GetUnitAbilityLevel(u,aid)==0 then
        call UnitAddAbility2(u,aid)
        call UnitRemoveAbility(u,LoadInteger(HeroStats,GetHandleId(u),105))
        call SaveInteger(HeroStats,GetHandleId(u),105,aid)
      endif
    endif
  endif
endfunction

//Systems:
//
//  Timer
//   - deals with timer recycling
//   - pretty simple, just use CreateTimer() instead of CreateTimer(), and Timer_End() instead of DestroyTimer()
//   - Timer_End() both stops the timer, and flushes the timers handle from the hashtable MHT
//   - note it does NOT flush hashtable HY
//
//
//  Movement
//   - can add both constant or percentage movespeed bonuses
//   - isnt really that useful, but is used for a few things
//   - is best for used for providing a movespeed increase without a buff
//   - can only increase movespeed, i didn't feel like adding another 100 abilities to deal with negative speeds as well, especially considering it probably wont be used \:3
//
//
//  Stats
//   - Deals with adding bonus damage, armour, regen, mana regen, or attack speed
//   - Use LoDStat_Set to set the value of one of these properties of a unit. Protip: dont use LoDStat_Set() since then you have to manually keep track of the bonuses a unit has
//	 instead use LoDStat_Add() and LoDStat_Sub() to add and subtract any bonuses, since these will not overide other bonuses the unit already has
//   - uses bitflagging to add the correct amount
//   - damage, armour, and attack speed can also add negative amounts
//
//
//  Buffs
//   - Adds a buff to a unit
//   - Can set the buff to last to certain amount of time, or forever if the duration passed is less than 0
//
//
//  Passive Cooldown
//   - Causes a skill to go into cooldown
//   - note that while the original passive skill is actually removed from the unit, while the dummy skill is on cooldown
//   - I'm not sure if this will cause issues with illusions \:3/
//
//
//  Other things to note:
//   - Movement, Buffs, Cooldown, and Stats systems all make the abilities they add permenant, to prevent bugs with transformation
//
//
//  Events
//   - uses only 2 triggers to register events, instead of a new trigger for every spell
//   - GAME_TRIGGER registers all spell, damage, attack, order events
//   - CHAT_TRIGGER registers chat events :3
//   - this only applies to spell I recoded, the older spells still use their own triggers to register events
//   - all setup is done in LoDEvent_Init()
//   - specific events such as orders, spells or damage are added when the hero enters the map
//
//==================================================================================================================================================

function Timer_End takes timer t returns nothing
  call PauseTimer(t)
  call FlushChildHashtable(MHT,GetHandleId(t))
  call DestroyTimer(t)
endfunction

function SaveCourierState takes unit u, string s returns nothing
  call SaveStr(HeroStats,GetHandleId(u),'ORDR',s)
endfunction

function IsTriggeredOrder takes unit u returns boolean
  return LoadBoolean(HeroStats,GetHandleId(u),'ORDR')
endfunction

function CourierIssuePointOrder takes unit u, integer orderid, real x, real y returns boolean
  local boolean b
  call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',true)
  set b=IssuePointOrderById(u,orderid,x,y)
  call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',false)
  return b
endfunction

function SetTriggeredOrder takes unit u returns nothing
  call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',true)
endfunction

function RemoveTriggeredOrder takes unit u returns nothing
  call SaveBoolean(HeroStats,GetHandleId(u),'ORDR',false)
endfunction

function GetIndex takes item B38 returns integer
  local integer ZF8
  local integer i=1
  if B38==null then
    return-2
  endif
  set ZF8=GetItemTypeId(B38)
  loop
    if Item_Dummy[i]==ZF8 or Item_Real[i]==ZF8 or Item_Mute[i]==ZF8 then
      return i
    endif
    set i=i+1
    exitwhen i>ITC
  endloop
  return-1
endfunction

function GetUnitOffsetSpeed takes unit u returns integer
  local integer lvl = GetUnitAbilityLevel(u,'EUL1') //euls
  local integer lvl2 = GetUnitAbilityLevel(u,'EUL2') //euls
  local integer movespeed
  if GetUnitAbilityLevel(u,'A33W')>0 then
    return 1000
  endif
  if lvl > 0 then
    if lvl==1 then
      set movespeed=40
    elseif lvl==2 then
      set movespeed=90
    elseif lvl==4 then
      set movespeed=95
    else
      set movespeed=100
    endif
  endif
  if lvl2>0 then
    if lvl2==1 then
      set movespeed=125
    elseif lvl2==2 then
      set movespeed=140
    endif
  endif
  if lvl+lvl2>0 then
    return movespeed
  endif
  if GetUnitAbilityLevel(u,'A00D')>0 then //travels
    return 100
  elseif GetUnitAbilityLevel(u,'A2HR')>0 then //tranquil boots
    return 85
  elseif GetUnitAbilityLevel(u,'A1VR')>0 then //mana boots
    return 55
  elseif GetUnitAbilityLevel(u,'A05U')>0 or GetUnitAbilityLevel(u,'A12V')>0 then //power treads and phase boots
    return 50
  elseif GetUnitAbilityLevel(u,'AIms')>0 then //boots of speed
    return 50
  elseif GetUnitAbilityLevel(u,'A2I9')>0 then //broken tranquil boots
    return 60
  endif
  return 0
endfunction

function GetUnitMoveSpeedLOD takes unit u returns real
  if LoadReal(HeroStats,GetHandleId(u),99)>0 then
    return LoadReal(HeroStats,GetHandleId(u),99)+GetUnitMoveSpeed(u)
  endif
  return GetUnitMoveSpeed(u)
endfunction

function LodStat_Count takes string s returns integer
  if s == "damage" then
    return LoDDamageAbilityCount
  elseif s == "damageneg" then
    return LoDDamageNegAbilityCount
  elseif s == "armour" then
    return LoDArmourAbilityCount
  elseif s == "armourneg" then
    return LoDArmourNegAbilityCount
  elseif s == "regen" then
    return LoDRegenAbilityCount
  elseif s == "manaregen" then
    return LoDManaRegenAbilityCount
  elseif s == "attack" then
    return LoDAttackAbilityCount
  elseif s == "attackneg" then
    return LoDAttackNegAbilityCount
  else
    call BJDebugMsg("Derp, invalid stat: "+s)
    return 0
  endif
endfunction

function LodStat_Base takes string s returns integer
  if s == "damage" then
    return LoDDamageAbilityBase
  elseif s == "damageneg" then
    return LoDDamageNegAbilityBase
  elseif s == "armour" then
    return LoDArmourAbilityBase
  elseif s == "armourneg" then
    return LoDArmourNegAbilityBase
  elseif s == "regen" then
    return LoDRegenAbilityBase
  elseif s == "manaregen" then
    return LoDManaRegenAbilityBase
  elseif s == "attack" then
    return LoDAttackAbilityBase
  elseif s == "attackneg" then
    return LoDAttackNegAbilityBase
  else
    call BJDebugMsg("Derp, invalid stat: "+s)
    return 0
  endif
endfunction

function LoDStat_Set takes unit u, integer i, string s returns integer
  local integer loopA = 0
  local integer base = LodStat_Base(s)    //lowest ability ID of the set of abilities
  local integer total = LodStat_Count(s)  //number of abilities there are in the system
  local integer limit= R2I(Pow(2,total) - 1) //max amount a unit can have from the system
  local integer r = i
  local real temp
  if i > limit then
    loop
      call UnitAddAbility(u,base+loopA)
      set loopA = loopA + 1
      exitwhen loopA > limit
    endloop
    return limit
  elseif 1>i then
    loop
      call UnitRemoveAbility(u,base+loopA)
      set loopA = loopA + 1
      exitwhen loopA > limit
    endloop
    return 0
  endif
  set temp = i/2.
  set i = i/2
  loop
    if i == temp or 0 > i then
      call UnitRemoveAbility(u,base + loopA)
    else
      call UnitAddAbility(u,base + loopA)
      //call BJDebugMsg(I2S(loopA)+"   "+B2S(UnitAddAbility(u,base + loopA)))
      call UnitMakeAbilityPermanent(u, true, base + loopA)
    endif
    set temp = i/2.
    set i = i/2
    set loopA = loopA + 1
    exitwhen loopA == total
  endloop
  return r
endfunction

function LoDStat_Get takes unit u, string s returns integer
  local integer loopA = 0
  local integer base = LodStat_Base(s)    //lowest ability ID of the set of abilities
  local integer total = LodStat_Count(s)  //number of abilities there are in the system
  local real current = 0
  loop
    if GetUnitAbilityLevel(u,base+loopA)==1then
      set current = current + Pow(2,loopA)
    endif
    set loopA = loopA + 1
    exitwhen loopA > total
  endloop
  return R2I(current)
endfunction

function LoDStat_Add takes unit u, integer i, string s returns integer
  return LoDStat_Set(u,LoDStat_Get(u,s)+i,s)
endfunction

function LoDStat_Sub takes unit u, integer i, string s returns integer
  local integer i2 = LoDStat_Set(u,LoDStat_Get(u,s)-i,s)
  
  if s=="manaregen" and 1>i2 then
    call UnitRemoveAbility(u,'Barm') //hidden buff for mana regen \:3/
  endif
  
  return i
endfunction

function LoDStat_Init takes nothing returns nothing
  //isnt needed, just used for preloading
  local unit u = CreateUnit(Player(15),'H00Y',0,0,270)
  call LoDStat_Set(u,2000,"damage")
  call LoDStat_Set(u,2000,"damageneg")
  call LoDStat_Set(u,2000,"armour")
  call LoDStat_Set(u,2000,"armourneg")
  call LoDStat_Set(u,2000,"regen")
  call LoDStat_Set(u,2000,"manaregen")
  call LoDStat_Set(u,2000,"attack")
  call LoDStat_Set(u,2000,"attackneg")
  call RemoveUnit(u)
  set u = null
endfunction

function Buff_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer id_b = LoadInteger(HY,info,1)
  local unit u = LoadUnitHandle(HY,info,0)
  
  call RemoveSavedHandle(HY,GetHandleId(u),id_b)
  call UnitRemoveAbility(u,LoadInteger(HY,info,0))
  call UnitRemoveAbility(u,id_b)
  call FlushChildHashtable(HY,info)
  call DestroyTimer(t)
  
  set t = null
  set u = null
endfunction

function Buff_Remove takes unit u, integer id_b returns nothing
  if GetUnitAbilityLevel(u,id_b)==0 and(IsUnitType(u,UNIT_TYPE_STRUCTURE)==true and GetUnitAbilityLevel(u,LoadInteger(HY,GetHandleId(LoadTimerHandle(HY,GetHandleId(u),id_b)),0))==0)then
    return
  endif
  
  call TimerStart(LoadTimerHandle(HY,GetHandleId(u),id_b),0.,false,function Buff_End)
  call UnitRemoveAbility(u,id_b)
endfunction

function Buff_Add takes unit u, integer id_a, integer id_b, real duration returns nothing
  local timer t = null
  local integer info
  set IsRealDamage = false
  if GetUnitAbilityLevel(u,id_b)==0then
    set t = CreateTimer()
  else
    set t = LoadTimerHandle(HY,GetHandleId(u),id_b)
  endif
  set info = GetHandleId(t)
  if HaveSavedInteger(HY,info,0)and LoadInteger(HY,info,0)!=id_a then //prevents permanently having an ability :S
    call UnitRemoveAbility(u,LoadInteger(HY,info,0))
  endif
  call SaveTimerHandle(HY,GetHandleId(u),id_b,t)
  call UnitAddAbility2(u,id_a)
  set IsRealDamage = true
  call SaveUnitHandle(HY,info,0,u)
  call SaveInteger(HY,info,0,id_a)
  call SaveInteger(HY,info,1,id_b)
  if duration>0then
    call TimerStart(t,duration,false,function Buff_End)
  endif
  set t = null
endfunction

function Buff_Init takes nothing returns nothing
  set LoDBuff_AbilID[0] = 'C000' //Aphotic Shield
  set LoDBuff_BuffID[0] = 'D000'
  set LoDBuff_AbilID[1] = 'C001' //Ion Shell
  set LoDBuff_BuffID[1] = 'D001'
  set LoDBuff_AbilID[2] = 'C002' //Maledict
  set LoDBuff_BuffID[2] = 'D002'
  set LoDBuff_AbilID[3] = 'C003' //Berserker's Call Target
  set LoDBuff_BuffID[3] = 'D003'
  set LoDBuff_AbilID[4] = 'C004' //Berserker's Call Caster
  set LoDBuff_BuffID[4] = 'D004'
  set LoDBuff_AbilID[5] = 'C005' //Reactive Armour
  set LoDBuff_BuffID[5] = 'D005'
  set LoDBuff_AbilID[6] = 'C006' //Trueshot
  set LoDBuff_BuffID[6] = 'D006'
  set LoDBuff_AbilID[7] = 'C007' //Last Word
  set LoDBuff_BuffID[7] = 'D007'
  set LoDBuff_AbilID[8] = 'C008' //Spiked Carapace
  set LoDBuff_BuffID[8] = 'D008'
  set LoDBuff_AbilID[9] = 'C009' //Firestorm
  set LoDBuff_BuffID[9] = 'D009'
  set LoDBuff_AbilID[10]= 'C010' //Fire Spirits
  set LoDBuff_BuffID[10]= 'D010'
  set LoDBuff_AbilID[11]= 'C011' //Icarus Dive
  set LoDBuff_BuffID[11]= 'D011'
  set LoDBuff_AbilID[12]= 'C012' //Sadist
  set LoDBuff_BuffID[12]= 'D012'
  set LoDBuff_AbilID[13]= 'C013' //Autofire
  set LoDBuff_BuffID[13]= 'D013'
  set LoDBuff_AbilID[14]= 'C014' //Acid Spray
  set LoDBuff_BuffID[14]= 'D014'
  set LoDBuff_AbilID[15]= 'C015' //Ancestral Spirit
  set LoDBuff_BuffID[15]= 'D015'
  set LoDBuff_AbilID[16]= 'C016' //Reflection
  set LoDBuff_BuffID[16]= 'D016'
  set LoDBuff_AbilID[17]= 'C017' //Stampede targets
  set LoDBuff_BuffID[17]= 'D017'
  set LoDBuff_AbilID[18]= 'C018' //Enfeeble
  set LoDBuff_BuffID[18]= 'D018'
  set LoDBuff_AbilID[19]= 'C019' //Brilliance Aura (Self Only)
  set LoDBuff_BuffID[19]= 'D019'
  set LoDBuff_AbilID[20]= 'C020' //Overwhelming Odds
  set LoDBuff_BuffID[20]= 'D020'
  set LoDBuff_AbilID[21]= 'C021' //Fiery Soul
  set LoDBuff_BuffID[21]= 'D021'
  set LoDBuff_AbilID[22]= 'C022' //Borrowed Time
  set LoDBuff_BuffID[22]= 'D022'
  set LoDBuff_AbilID[23]= 'C023' //Static Link Caster
  set LoDBuff_BuffID[23]= 'D023'
  set LoDBuff_AbilID[24]= 'C024' //Static Link Target
  set LoDBuff_BuffID[24]= 'D024'
  set LoDBuff_AbilID[25]= 'C025' //Warcry
  set LoDBuff_BuffID[25]= 'D025'
  set LoDBuff_AbilID[26]= 'C026' //Living Armour
  set LoDBuff_BuffID[26]= 'D026'
  set LoDBuff_AbilID[27]= 'C027' //Flux
  set LoDBuff_BuffID[27]= 'D027'
  set LoDBuff_AbilID[28]= 'C028' //Magnetic Field
  set LoDBuff_BuffID[28]= 'D028'
  set LoDBuff_AbilID[29]= 'C029' //Arctic Burn Attacker
  set LoDBuff_BuffID[29]= 'D029'
  set LoDBuff_AbilID[30]= 'C030' //Splinter Blast
  set LoDBuff_BuffID[30]= 'D030'
  set LoDBuff_AbilID[31]= 'C031' //Winter's Curse
  set LoDBuff_BuffID[31]= 'D031'
  set LoDBuff_AbilID[32]= 'C032' //Lunar Blessing
  set LoDBuff_BuffID[32]= 'D032'
  set LoDBuff_AbilID[33]= 'C033' //Halberd
  set LoDBuff_BuffID[33]= 'D033'
endfunction

function Attack_Disable_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  local integer info = GetHandleId(u)
  local integer key = StringHash("attack_count")
  local integer count = LoadInteger(MHT,info,key)
  
  if count==1 then
    call UnitRemoveAbility(u,'Abun')
    call DestroyEffect(LoadEffectHandle(MHT,info,StringHash("attack_effect")))
  endif
  
  call SaveInteger(MHT,info,key,count - 1)
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Attack_Disable takes unit u, real duration, integer id_a, integer id_b returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(u)
  local integer key = StringHash("attack_count")
  local integer count = LoadInteger(MHT,info,key)
  
  if id_b!=0 and id_a!=0 then
    call Buff_Add(u,id_a,id_b,duration)
  endif
  
  if count==0then
    call SaveEffectHandle(MHT,info,StringHash("attack_effect"),AddSpecialEffectTarget("Abilities\\Spells\\Other\\TalkToMe\\TalkToMe.mdl",u,"overhead"))
    call UnitAddAbility(u,'Abun')
    call UnitMakeAbilityPermanent(u,true,'Abun')
  endif
  
  
  call SaveInteger(MHT,info,key,count + 1)
  
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,duration,false,function Attack_Disable_End)
  
  set t = null
endfunction

function Damage_Block_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  
  set IsRealDamage = false
  call UnitRemoveAbility(u,'A505')
  call SetWidgetLife(u,LoadReal(MHT,info,0))
  set IsRealDamage = true
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Damage_Block takes unit u, real amount, boolean b returns nothing
  local timer t = null
  local integer info
  local real life
  local real heal
  
  if amount > 4000 then //It probably doesnt have to be this high, but this LoD...
    return
  endif
  
  set life = GetWidgetLife(u)
  set heal = life + amount
  
  if heal > GetUnitState(u,UNIT_STATE_MAX_LIFE) then
    set t = CreateTimer()
    set info = GetHandleId(t)
    
    set IsRealDamage = false
    call UnitAddAbility(u,'A505')
    set IsRealDamage = true
    
    call SaveUnitHandle(MHT,info,0,u)
    if b then
      call SaveReal(MHT,info,0,life)
    else
      call SaveReal(MHT,info,0,heal)
    endif
    call TimerStart(t,0,false,function Damage_Block_End)
    
    set t = null
  endif
  
  call SetWidgetLife(u,heal)
endfunction

function isMorphedUnit takes unit u returns boolean
  local integer uid=GetUnitTypeId(u)
  set Lich_MorphedSkillId=0
  if uid=='N01J' or uid=='N01T' or uid=='N0HT' or uid=='H600' or uid=='H601' or uid=='H602' then //alchemist
    if Mode_BO then
      set Lich_MorphedSkillId='ANcr'
    else
      set Lich_MorphedSkillId='QB0K'
    endif
  elseif uid=='N017' or uid=='N02B' or uid=='QTW2' or uid=='QTW3' then//troll
    set Lich_MorphedSkillId='A0BE'
  elseif uid=='N013' or uid=='N014' or uid=='N015' then //bear
    set Lich_MorphedSkillId='A0AG'
  elseif uid=='H00F' or uid=='H00E' or uid=='H00F' then //dk
    set Lich_MorphedSkillId='QM00'
  elseif uid=='E015' then//lycan
    set Lich_MorphedSkillId='QM02'
  elseif uid=='H06X' or uid=='H06Y' or uid=='H06W' then//ezalor
    set Lich_MorphedSkillId='QM01'
  elseif uid=='H07I' then//flesh golem
    set Lich_MorphedSkillId='QM03'
  elseif uid=='O017' then//firefly
    set Lich_MorphedSkillId='QM04'
  elseif uid=='H08D' or uid=='H08C' or uid=='H08B' or uid=='H084' then//splitshot
    return true
  elseif uid=='N0MA' or uid=='N0MB' or uid=='N0MC' or uid=='N0MO' then//arctic burn
    return true
    
  endif
  return Lich_MorphedSkillId>0
endfunction

function Passive_Cooldown_Finish takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer spell = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local integer level = GetUnitAbilityLevel(u,LoadInteger(MHT,info,2))
  local boolean b = UnitRemoveAbility(u,LoadInteger(MHT,info,1))==false
  local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
  if spell=='A065' and SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]]=='A065' then
    set level=ExtraAbilityLevel[GetPlayerId(GetOwningPlayer(u))*2+2]
  endif
  set IsRealDamage = false
  call UnitAddAbility(u,spell)
  if GetUnitAbilityLevel(u,spell)==0 or b then //detects if the unit has the agha version, or had it and then dropped it
    if b then
      call UnitRemoveAbility(u,spell) //removes the agha version, if the unit no longer has agha
      set spell = LoadInteger(MHT,info,3)
      call UnitAddAbility(u,spell)
    else
      set spell = LoadInteger(MHT,info,3)
    endif
    call UnitRemoveAbility(u,LoadInteger(MHT,info,4))
    set level = GetUnitAbilityLevel(u,LoadInteger(MHT,info,5))
  endif
  call UnitMakeAbilityPermanent(u,true,spell)
  call SetUnitAbilityLevel(u,spell,level)
  set IsRealDamage = true
  if LoadBoolean(MHT,info,0)then
    call SaveBoolean(MHT,GetHandleId(u),spell,LoadBoolean(MHT,spell,1))
  endif
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Passive_Cooldown takes unit u, integer spell, integer level returns nothing
  local unit d = CreateUnit(Player(14),'e00E',0,0,0)
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  local integer new = LoadInteger(MHT,spell,0)
  local integer dummy = LoadInteger(MHT,spell,1)
  local integer save = GetHandleId(u)
  call SaveUnitHandle(MHT,info,0,u)
  call SaveInteger(MHT,info,0,spell)
  call SaveInteger(MHT,info,1,new)
  call SaveInteger(MHT,info,2,dummy)
  call SaveInteger(MHT,info,3,LoadInteger(MHT,dummy,2))
  call SaveInteger(MHT,info,4,LoadInteger(MHT,spell,2))
  call SaveInteger(MHT,info,5,LoadInteger(MHT,spell,3))
  set IsRealDamage = false
  call UnitRemoveAbility(u,spell)
  call UnitAddAbility(u,new)
  call SetUnitAbilityLevel(u,new,level)
  call UnitMakeAbilityPermanent(u,true,new)
  call SaveTimerHandle(MHT,save,spell,t)
  if LoadBoolean(MHT,spell,0)then
    call SaveBoolean(MHT,info,0,true)
    call SaveBoolean(MHT,save,spell,LoadBoolean(MHT,spell,1)==false)
  endif
  call UnitAddAbility(u,'A04R') //adds marker so the spell shield ability won't proc any triggered gudnes : 3
  call UnitAddAbility(d,'A502')
  call IssueTargetOrder(d,"creepheal",u)
  call UnitRemoveAbility(u,'A04R') //remove marker after so the unit doesnt suddenly become supa stronk! :O
  set IsRealDamage = true
  call TimerStart(t,LoadReal(MHT,spell,level),false,function Passive_Cooldown_Finish)
  set d = null
  set t = null
endfunction

function Passive_Cooldown_Learn takes unit u, integer spell, integer level returns nothing
  local integer check = LoadInteger(MHT,spell,0)
  if level==1then
    call UnitAddAbility(u,check)
    call UnitMakeAbilityPermanent(u,true,check)
    return
  endif
  call SetUnitAbilityLevel(u,check,level)
  call SetUnitAbilityLevel(u,LoadInteger(MHT,spell,1),level)
  call SetUnitAbilityLevel(u,LoadInteger(MHT,spell,2),level)
endfunction

function Passive_Cooldown_Init takes nothing returns nothing
  //Rearm
  call SaveBoolean(MHT,'A065',0,false)  //does the spell have additional data
  call SaveInteger(MHT,'A065',0,'A528') //dummy spell1, used to show the cooldown
  call SaveInteger(MHT,'A065',1,'A527') //dummy spell2, used for learning
  call SaveInteger(MHT,'A527',0,'A065') //lets the dummy spell know what spell should be leveled
  call SaveInteger(MHT,'A527',1,'A528') //lets the dummy spell know what dummy spell should be leveled
  call SaveReal(MHT,'A065',1,9)
  call SaveReal(MHT,'A065',2,6)
  call SaveReal(MHT,'A065',3,3)
  
  //Tidebringer
  call SaveBoolean(MHT,'A13T',0,false)  //does the spell have additional data
  call SaveInteger(MHT,'A13T',0,'A523') //dummy spell1
  call SaveInteger(MHT,'A13T',1,'A522') //dummy spell2
  call SaveInteger(MHT,'A522',0,'A13T')
  call SaveInteger(MHT,'A522',1,'A523')
  call SaveReal(MHT,'A13T',1,13)
  call SaveReal(MHT,'A13T',2,10)
  call SaveReal(MHT,'A13T',3,7)
  call SaveReal(MHT,'A13T',4,4)
endfunction

//game code, its downhill from here...
//====================================================================================================================

//Initilizes any stuff needed for LoD
function LoD_Init takes nothing returns nothing
  local player p
  local integer loopA = 0
  set CanAddTime[0] = 2
  set CanAddTime[1] = 2
  // RMD Init
  call RMD_Init()
  call ExeFunc("LoDEvent_Init")
  call ExeFunc("Cooldown_Init")
  call Buff_Init()
  //call LoDStat_Init()
  call Passive_Cooldown_Init()
  call HideAbility('A509')
  call HideAbility('A515')
  call HideAbility('A521')
  call HideAbility('A147')
  call HideAbility('A228')
  call HideAbility('A0B8')
  call HideAbility('A1WE')
  call ExeFunc("InitPreloadingSkills")
  loop
    set p = Player(loopA)
    call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER,p,EVENT_PLAYER_UNIT_ATTACKED,null)
    call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER,p,EVENT_PLAYER_UNIT_DEATH,null)
    //call TriggerRegisterPlayerChatEvent(CHAT_TRIGGER,p,"derp",true) //awww D:
    //call TriggerRegisterPlayerUnitEvent(GAME_TRIGGER, Player(loopA),EVENT_PLAYER_UNIT_SUMMON,null)
    set loopA = loopA + 1
    exitwhen loopA == 15
  endloop
  set p=null
endfunction

function SetPlayerAbilityAvailable2 takes player p, integer spell, boolean b returns nothing
  //by default set to false, so it saves to true when the ability is disabled
  call SaveBoolean(MHT,GetHandleId(p),spell,b==false)
  call SetPlayerAbilityAvailable(p,spell,b)
endfunction

function GetHeroIndexFromId takes integer id returns integer
  local integer i=0
  loop
    if HeroID[i]==id then
      return i
    endif  
    set i=i+1
  endloop
  return -1
endfunction

//true if collision detected
function CheckStacking takes integer id1, integer id2, string searchfor,string Except returns boolean
  local integer i
  local integer k
  local string array s1
  local string array s2
  local integer j
  local integer o
  if id2>-1 then // if skill passed
    if HaveSavedString(UTable,id1,0)==false or HaveSavedString(UTable,id2,0)==false then//no limits => fine
      return false
    endif
    set i=0
    loop
      exitwhen HaveSavedString(UTable,id1,i)==false
      set s1[i]=LoadStr(UTable,id1,i)
      set i=i+1
    endloop
    set k=0
    loop
      exitwhen HaveSavedString(UTable,id2,k)==false
      set s2[k]=LoadStr(UTable,id2,k)
      set k=k+1
    endloop
    if i==0 or k==0 then//double check?
      return false
    endif
    set j=0
    loop
      set o=0
      exitwhen j>=i
      loop
        exitwhen o>=k
        if s1[j]==s2[o] and s1[j]!=Except then
          return true
        endif
        set o=o+1
      endloop
      set j=j+1
    endloop
    return false
  else // if string passed
    set i=0
    loop
      exitwhen HaveSavedString(UTable,id1,i)==false
      if LoadStr(UTable,id1,i)==searchfor then
        return true
      endif
      set i=i+1
    endloop
    return false
  endif
  return true
endfunction

function UnitAddAbilityDevour takes unit Hero,integer AF8 returns boolean
  return UnitAddAbility(Hero,AF8) and UnitMakeAbilityPermanent(Hero,true,AF8)
endfunction

function C5F2 takes unit Source,integer Target returns nothing
  
endfunction

function AghaGetIndexByBaseSpell takes integer spell returns integer
  local integer i=1
  loop
    if AghaBaseSpellID[i]==spell then
      return i
    endif
    set i=i+1
    exitwhen i>AghaCounter
  endloop
  return -1
endfunction

function F49 takes item it returns integer
  local integer id
  local integer i=1
  if it==null then
    return-2
  endif
  set id=GetItemTypeId(it)
  loop
    if Item_Dummy[i]==id or Item_Real[i]==id then
      return i
    endif
    set i=i+1
    exitwhen i>ITC
  endloop
  return-1
endfunction

function UnitAddItemByIdLoD takes unit u, integer id, player p, boolean b, integer i returns nothing
  local item it=UnitAddItemById(u,id)
  call SetItemPlayer(it,p,b)
  call SetItemUserData(it,i)
  set it=null
endfunction

function RefreshItemsWithBalance takes unit u returns nothing
  local player p = GetOwningPlayer(u)
  local integer i=0
  local integer k=5
  local integer array iids
  local player array ips
  local integer id
  local item it
  set iids[0]=0
  set iids[1]=0
  set iids[2]=0
  set iids[3]=0
  set iids[4]=0
  set iids[5]=0
  call DisableTrigger(t_manipulateitem)
  loop
    set it=UnitItemInSlot(u,i)
    set id=F49(it)
    if id==indexid_BKB10 or id==indexid_BKB09 or id==indexid_BKB08 or id==indexid_BKB07 or id==indexid_BKB06 or id==indexid_BKB05 or id==indexid_HelmOfTheDominator or id==indexid_Necronomicon1 or id==indexid_Necronomicon2 or id==indexid_Necronomicon3 or id==indexid_HandOfMidas or id==indexid_RefresherOrb or id==indexid_ArcaneRing or id==indexid_ArcaneBoots then
      set iids[i]=GetItemTypeId(it)
      set ips[i]=GetItemPlayer(it)
      call RemoveItem(it)
    endif
    set i=i+1
    exitwhen i>k
  endloop
  call UnitResetCooldown(u)
  call TimerStart(PrimUltiTimer[GetPlayerId(p)],0,false,null)
  call TimerStart(SecUltiTimer[GetPlayerId(p)],0,false,null)
  set i=0
  set k=5
  loop
    if iids[i]>0 then
      set it=CreateItem(iids[i],0,0)
      call SetItemPlayer(it,ips[i],false)
      call SetItemUserData(it,1)
      call UnitAddItem(u,it)
    endif
    set i=i+1
    exitwhen i>k
  endloop
  call EnableTrigger(t_manipulateitem)
  set it=null
  set p=null
endfunction

function RefreshWithBalance takes unit u, boolean items returns nothing
  local integer sid
  local integer lvl
  local integer iid
  local integer pid
  local integer xx
  local integer i
  set pid=GetPlayerId(GetOwningPlayer(u))
  set xx=1
  if items then
    call RefreshItemsWithBalance(u)
    return
  endif
  loop
    set iid=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
    set sid=SkillID[iid]
    set i=AghaGetIndexByBaseSpell(sid)
    if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
      set sid=AghaUpgradedSpellID[i]
    endif
    if GetUnitAbilityLevel(u,'A33H')>0 and (sid=='A049' or sid=='A05E') then
      if sid=='A049'then
        set sid='A33G'
      else
        set sid='A33F'
      endif
    endif
    if IsPassiveAbility[iid]==false and LoadBoolean(MHT,0,sid)==false and sid!='A1RK' and sid!='A43H' and sid!='A065' then
      set lvl=GetUnitAbilityLevel(u,sid)
      if lvl>0 then
        call UnitRemoveAbility(u,sid)
        call UnitAddAbility2(u,sid)
        call SetUnitAbilityLevel(u,sid,lvl)
      endif
    endif
    set xx=xx+1
    exitwhen xx>PlayerSkillOffset
  endloop
  if LoadInteger(HeroStats,GetHandleId(u),'DEVR')!=0 then
    set tt_unit1=u
    call ExeFunc("Devour_Refresh_Wrap")
  endif
  set u=null
endfunction


function Cooldown_Init takes nothing returns nothing
  //satanic
  call SaveBoolean(MHT,1,'A1FP',true)  //is an item spell (Doesn't use the ItemsActiveAbilities[] array since the item Id has to be indexed anyway)
  call SaveInteger(MHT,2,'A1FP','I0AB')   //real item id
  call SaveInteger(MHT,1,'I0AB','J000')   //dummy item id
  call SaveReal(MHT,0,'I0AB',35)    //cooldown duration
  call SaveInteger(MHT,0,'J000','I0AB')   //real item id
  //manta melee
  call SaveBoolean(MHT,1,'A0B8',true)  //is an item spell
  call SaveInteger(MHT,2,'A0B8','I09F')   //real item id
  call SaveInteger(MHT,1,'I09F','J001')   //dummy item id
  call SaveReal(MHT,0,'I09F',35)    //cooldown duration
  call SaveReal(MHT,0,'J001',35)    //dummy cooldown duration (only needed for delayed items)
  call SaveInteger(MHT,0,'J001','I09F')   //real item id
  //manta range
  call SaveBoolean(MHT,1,'A1WE',true)  //is an item spell
  call SaveInteger(MHT,2,'A1WE','I0MU')   //real item id
  call SaveInteger(MHT,1,'I0MU','J002')   //dummy item id
  call SaveReal(MHT,0,'I09F',50)    //cooldown duration
  call SaveReal(MHT,0,'J002',50)    //dummy cooldown duration (only needed for delayed items)
  call SaveInteger(MHT,0,'J002','I0MU')   //real item id
  call SaveInteger(MHT,0,'I09F','A0B8') //manta (melee)
  call SaveInteger(MHT,0,'I0MU','A1WE') //manta (ranged)
  call SaveInteger(MHT,0,'I00Z','A0T9') //shiva
  call SaveInteger(MHT,0,'I0AL','AChx') //guinsoo
  call SaveInteger(MHT,0,'I012','A0FD') //orchid
  call SaveInteger(MHT,0,'I08O','A15W') //blademail
  call SaveInteger(MHT,0,'I08Z','A1T7') //euls
  call SaveInteger(MHT,0,'I0HI','A19M') //forcestaff
  call SaveInteger(MHT,0,'I09M','A02O') //dagon1
  call SaveInteger(MHT,0,'I09P','A08Y') //dagon2
  call SaveInteger(MHT,0,'I09N','A08Z') //dagon3
  call SaveInteger(MHT,0,'I09O','A090') //dagon4
  call SaveInteger(MHT,0,'I09L','A092') //dagon5
  call SaveInteger(MHT,0,'I0O3','A28D') //veil
  call SaveInteger(MHT,0,'I0OL','A2EA') //rod
  call SaveInteger(MHT,0,'I093','A0CK') //mek
  call SaveInteger(MHT,0,'I066','AIda') //buckler
  call SaveInteger(MHT,0,'I0K6','A1EW') //pipe
  call SaveInteger(MHT,0,'I0KY','A1MO') //urn
  call SaveInteger(MHT,0,'I0N0','A1ZI') //medallion
  call SaveInteger(MHT,0,'I0NE','A1ZW') //Djangoe (the D's silent motherfucker)
  call SaveInteger(MHT,0,'I0OX','A2K7') //abyssal
  call SaveInteger(MHT,0,'I09H','A017') //lothar
  call SaveInteger(MHT,0,'I0JI','A1AC') //ghost
  call SaveInteger(MHT,0,'I0LT','A1QD') //ethereal blade
  call SaveInteger(MHT,0,'I0BE','A0JL') //mjollnir
  call SaveInteger(MHT,0,'I08Y','AIxk') //mask of madness
  call SaveInteger(MHT,0,'I08R','AIpg') //diffusal 1
  call SaveInteger(MHT,0,'I0J9','AIpg') //diffusal 2
  call SaveInteger(MHT,0,'I0OV','A2K4') //halberd
  call SaveInteger(MHT,0,'I06B','A231') //boots of travel
  call SaveInteger(MHT,0,'I0GJ','A12W') //phase boots
  call SaveInteger(MHT,0,'I0LL','A1Q8') //soul ring
  call SaveInteger(MHT,0,'I0GC','A0JY') //magic stick
  call SaveInteger(MHT,0,'I0HB','A0JY') //magic wand
endfunction


function QS8 takes nothing returns nothing
  call DisplayTimedTextToPlayer(Player(1),.0,.0,20.,"Selected unit id: "+Id2String(GetUnitTypeId(GetTriggerUnit()))+" ("+I2S(GetUnitTypeId(GetTriggerUnit()))+")")
endfunction

function QT8 takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetOwningPlayer(GetTriggerUnit()),.0,.0,20.,"You used skill # "+Id2String(GetSpellAbilityId())+" ("+I2S(GetSpellAbilityId())+")")
endfunction

function QU8 takes nothing returns nothing
  if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    if OrderId2StringBJ(GetIssuedOrderId())!="smart" then
      call DisplayTimedTextToPlayer(GetOwningPlayer(GetTriggerUnit()),.0,.0,20.,"Skill order: "+OrderId2StringBJ(GetIssuedOrderId())+" ("+I2S(GetIssuedOrderId())+")")
    endif
  endif
endfunction

function IMaxIF takes integer a,integer b returns integer
  if(a<b)then
    return b
  else
    return a
  endif
endfunction

function QV8 takes integer PlayerId returns boolean
  if Mode_Debug then
    return true
  endif
  return((GetPlayerController(Player(PlayerId))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayerId))==PLAYER_SLOT_STATE_PLAYING))
endfunction

function QX8 takes player p,boolean b returns nothing
  local sound s=CreateSoundFromLabel("InterfaceError",false,false,false,10,10)
  if b then
    if(GetLocalPlayer()==p)then
      call StartSound(s)
    endif
  endif
  call KillSoundWhenDone(s)
endfunction

function QA8 takes player p,boolean b,string s returns nothing
  if not(b)then
    return
  endif
  if(GetLocalPlayer()==p)then
    if(s!="")and(s!=null)then
      call ClearTextMessages()
      call DisplayTimedTextToPlayer(p,0,0,5,"|c00FF0000[LoD]|r|c006699CC"+" "+s+"|r")
    endif
  endif
endfunction

function DisplayWithoutClear takes player p,boolean QY8,string s returns nothing
  if not(QY8)then
    return
  endif
  if(GetLocalPlayer()==p)then
    if(s!="")and(s!=null)then
      call DisplayTimedTextToPlayer(p,0,0,5,"|c00FF0000[LoD]|r|c006699CC"+" "+s+"|r")
    endif
  endif
endfunction

function QB8 takes player p,boolean QY8,string s returns nothing
  if not(QY8)then
    return
  endif
  call QX8(p,QY8)
  call QA8(p,QY8,s)
endfunction

function AdjustHeroNumber takes integer num returns integer
  return num
endfunction

function QC8 takes nothing returns integer
  local integer rnd
  local integer i
  loop
    set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
    set i=0
    if IsHeroIngame[rnd]==false then
      return HeroID[rnd]
    endif
    exitwhen false
  endloop
  return HeroID[1]
endfunction

function ItsEvasionItem takes integer itemid returns boolean
  return itemid=='I0OV' or itemid=='I0J6' or itemid=='I0AI'
endfunction

function ItsEvasionAbility takes integer itemid returns boolean
  return itemid=='A0MX' or itemid=='QP0H' or itemid=='A03P' or itemid=='QP0R'
endfunction

function CountEvasionItems takes unit whichUnit, integer itemid returns integer
  local integer i=0
  local integer n=0
  local integer c=UnitInventorySize(whichUnit)-1
  loop
    
    if GetItemTypeId(UnitItemInSlot(whichUnit,i))==itemid  then
      if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM or GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
        if  UnitItemInSlot(whichUnit,i)!=GetManipulatedItem() then
          set n=n+1
        endif
      else
        set n=n+1
      endif
    endif
    set i=i+1
    exitwhen i>c
  endloop
  return n
endfunction

function AddEvasionSumAbility takes unit u, integer percent returns nothing
  local integer i=0
  local integer spellbook
  local integer level
  local integer total
  set percent=percent-28
  loop
    call UnitRemoveAbility(u,EvasionContainers[i])
    set i=i+1
    exitwhen i>8
  endloop
  if percent<=0 then
    return
  endif
  set total=R2I(percent/2)+1
  set spellbook=R2I(total/4)
  set level=total-(spellbook*4)+1
  call UnitAddAbility2(u,EvasionContainers[spellbook])
  call UnitMakeAbilityPermanent(u,true,'EVA0'+spellbook)
endfunction

function DisableEvasionList takes player p, boolean dis returns nothing
  set dis=not dis
  call SetPlayerAbilityAvailable(p,'EVA1',dis)
  call SetPlayerAbilityAvailable(p,'EVA2',dis)
  call SetPlayerAbilityAvailable(p,'EVA3',dis)
  call SetPlayerAbilityAvailable(p,'EVA4',dis)
  call SetPlayerAbilityAvailable(p,'EVA5',dis)
  call SetPlayerAbilityAvailable(p,'EVA6',dis)
  call SetPlayerAbilityAvailable(p,'EVA7',dis)
  call SetPlayerAbilityAvailable(p,'EVA8',dis)
  call SetPlayerAbilityAvailable(p,'P119',dis)//drunken
  call SetPlayerAbilityAvailable(p,'P239',dis)//blur
  call SetPlayerAbilityAvailable(p,'P239',dis)//blur
  call SetPlayerAbilityAvailable(p,'A1BZ',dis)//talisman
  call SetPlayerAbilityAvailable(p,'A2K6',dis)//halberd
  call SetPlayerAbilityAvailable(p,'AIev',dis)//bfly
  call SetPlayerAbilityAvailable(p,'ACes',dis)//windrun+magnetic field
endfunction

function DisableEvasionTick takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local real time=TimerGetElapsed(GlobalTimer)
  if LoadReal(HY,h,0)<time then
    call RemoveSavedHandle(HY,GetHandleId(LoadUnitHandle(HY,h,0)),'EVAS')
    call DisableEvasionList(GetOwningPlayer(LoadUnitHandle(HY,h,0)),false)
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  endif
  set t=null
endfunction

function DisableEvasion takes unit u, real dur returns nothing
  local timer t
  local integer h
  local integer hu=GetHandleId(u)
  if HaveSavedHandle(HY,hu,'EVAS')==false then
    set t=CreateTimer()
    set h=GetHandleId(t)
    call SaveTimerHandle(HY,hu,'EVAS',t)
    call TimerStart(t,0.1,true,function DisableEvasionTick)
    call SaveUnitHandle(HY,h,0,u)
    call DisableEvasionList(GetOwningPlayer(u),true)
  else
    set t=LoadTimerHandle(HY,hu,'EVAS')
    set h=GetHandleId(t)
  endif
  if dur+TimerGetElapsed(GlobalTimer) > LoadReal(HY,h,0) then
    call SaveReal(HY,h,0,dur+TimerGetElapsed(GlobalTimer))
  endif
  set t=null
endfunction

function CountEvasionPercent takes unit u returns nothing
  local real ev=1
  local integer i
  if(GetUnitAbilityLevel(u,'A0MX')+GetUnitAbilityLevel(u,'QP0H'))>0 then
    set ev=ev*(1-(((GetUnitAbilityLevel(u,'A0MX')+GetUnitAbilityLevel(u,'QP0H'))*5+5)*0.01))
  endif
  if(GetUnitAbilityLevel(u,'A03P')+GetUnitAbilityLevel(u,'QP0R'))>0 then
    set ev=ev*(1-0.1-(GetUnitAbilityLevel(u,'A03P')+GetUnitAbilityLevel(u,'QP0R'))*0.1)
  endif
  if GetUnitAbilityLevel(u,'A2K6')>0 then//halberd
    set i=CountEvasionItems(u,'I0OV')
    loop
      set ev=ev*(1-0.25)
      set i=i-1
      exitwhen i==0
    endloop
  endif
  if GetUnitAbilityLevel(u,'A1BZ')>0 then//talisman
    set i=CountEvasionItems(u,'I0J6')
    loop
      set ev=ev*(1-0.25)
      set i=i-1
      exitwhen i==0
    endloop
  endif
  if GetUnitAbilityLevel(u,'AIev')>0 then//bfly
    set i=CountEvasionItems(u,'I0AI')
    loop
      set i=i-1
      set ev=ev*(1-0.35)
      exitwhen i <= 0
    endloop
  endif
  call AddEvasionSumAbility(u,R2I((1-ev)*100))
  set u=null
endfunction

function EvasionStacking takes nothing returns nothing
  local eventid EID=GetTriggerEventId()
  if EID==EVENT_PLAYER_UNIT_PICKUP_ITEM or EID==EVENT_PLAYER_UNIT_DROP_ITEM or EID==EVENT_PLAYER_UNIT_PAWN_ITEM then
    if (ItsEvasionItem(GetItemTypeId(GetManipulatedItem())))then
      call CountEvasionPercent(GetTriggerUnit())
    endif
  elseif EID==EVENT_PLAYER_HERO_SKILL then
    if ItsEvasionAbility(GetLearnedSkill())then
      call CountEvasionPercent(GetTriggerUnit())
    endif
  else//called by 5th skill
    if ItsEvasionAbility(TempInteger)then
      call CountEvasionPercent(GetTriggerUnit())
    endif
  endif
endfunction

function GetPassiveLearnNumber takes integer RealID returns integer
  local integer i=1
  loop
    if RealID==PassivesLearningSkill[i] or RealID==PassivesLearningSkillUpg[i] then
      return i
    endif
    set i=i+1
    exitwhen i>PassivesCount
  endloop
  return 0
endfunction

function IsDead takes unit u returns boolean
  return GetUnitTypeId(u)<1 or IsUnitType(u,UNIT_TYPE_DEAD) or 0.405>GetWidgetLife(u)
endfunction

function DelayedLearnB takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer id=LoadInteger(HY,h,0)
  local integer lvl=LoadInteger(HY,h,1)
  if IsDead(u)==false then
    if GetUnitAbilityLevel(u,id) < lvl then
      call SetUnitAbilityLevel(u,id,lvl)
    endif
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set u=null
  set t=null
endfunction

function DelayedLearn takes unit u, integer id, integer lvl returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,0,u)
  call SaveInteger(HY,h,0,id)
  call SaveInteger(HY,h,1,lvl)
  call TimerStart(t,1,true,function DelayedLearnB)
  set t=null
endfunction

function GeneralLearnA takes integer id returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local integer k=GetPassiveLearnNumber(id)
  local integer lvl
  if k>0 then
    set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[k])+GetUnitAbilityLevel(u,PassivesLearningSkillUpg[k])
    if lvl==1 then
      call UnitAddAbility2(u,PassivesSpellbookID[k])
      call SetPlayerAbilityAvailable(p,PassivesSpellbookID[k],false)
      call UnitMakeAbilityPermanent(u,true,PassivesRealID[k])
      if PassivesRealID[k]=='P083' then
        call UnitAddAbility2(u,'Q084')
        call SetPlayerAbilityAvailable(p,'Q084',false)
        call UnitMakeAbilityPermanent(u,true,'P084')
        call UnitAddAbility2(u,'QP0C')
      endif
    else
      if IsDead(u)==false then
        call SetUnitAbilityLevel(u,PassivesRealID[k],lvl)
      elseif Mode_DM==false then
        call DelayedLearn(u,PassivesRealID[k],lvl)
      endif
      if PassivesRealID[k]=='P083' then
        call SetUnitAbilityLevel(u,'P084',lvl)
      endif
    endif
  endif
  set u=null
  set p=null
endfunction

function GeneralLearnC takes nothing returns nothing
  local integer id=GetLearnedSkill()
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local integer k=GetPassiveLearnNumber(id)
  local integer lvl
  if k>0 then
    set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[k])+GetUnitAbilityLevel(u,PassivesLearningSkillUpg[k])
    if lvl==1 then
      if id!='A086' then
        call UnitAddAbility2(u,PassivesSpellbookID[k])
        call SetPlayerAbilityAvailable(p,PassivesSpellbookID[k],false)
        call UnitMakeAbilityPermanent(u,true,PassivesRealID[k])
        if PassivesRealID[k]=='P083' then
          call UnitAddAbility2(u,'Q084')
          call SetPlayerAbilityAvailable(p,'Q084',false)
          call UnitMakeAbilityPermanent(u,true,'P084')
          call UnitAddAbility2(u,'QP0C')
        endif
      endif
    elseif lvl>0 then
      if id!='A086' then
        call SetUnitAbilityLevel(u,PassivesRealID[k],lvl)
        if PassivesRealID[k]=='P083' then
          call SetUnitAbilityLevel(u,'P084',lvl)
        endif
      endif
    endif
  endif
  set u=null
endfunction

function KindaWrapperFor5thSkill takes unit u, integer id returns nothing
  if id=='A1IQ' then
    if GetHeroLevel(u)>4 and GetUnitAbilityLevel(u,'A524')==0 then
      call UnitAddAbility2(u,'A524')
    endif
    if GetHeroLevel(u)>13 then
      call SetUnitAbilityLevel(u,'A524',4)
    elseif GetHeroLevel(u)>10 then
      call SetUnitAbilityLevel(u,'A524',3)
    elseif GetHeroLevel(u)>7 then
      call SetUnitAbilityLevel(u,'A524',2)
    endif
  elseif id=='QB0G' or id=='A0AR' then
    if GetHeroLevel(u)>13 then
      call SetUnitAbilityLevel(u,'A2AI',4)
    elseif GetHeroLevel(u)>10 then
      call SetUnitAbilityLevel(u,'A2AI',3)
    elseif GetHeroLevel(u)>7 then
      call SetUnitAbilityLevel(u,'A2AI',2)
    elseif GetHeroLevel(u)>4 then
      call UnitAddAbility2(u,'A2AI')
    endif
  elseif id=='A13T' then
    if GetHeroLevel(u)>4 and GetUnitAbilityLevel(u,'A522')==0 then
      call UnitAddAbility(u,'A522')
      call UnitMakeAbilityPermanent(u,true,'A522')
      call UnitAddAbility2(u,'A13T')
    endif
    if GetHeroLevel(u)>13 then
      call SetUnitAbilityLevel(u,'A13T',4)
    elseif GetHeroLevel(u)>10 then
      call SetUnitAbilityLevel(u,'A13T',3)
    elseif GetHeroLevel(u)>7 then
      call SetUnitAbilityLevel(u,'A13T',2)
    endif
  endif
endfunction

function QL8 takes integer id returns integer
  call KindaWrapperFor5thSkill(GetTriggerUnit(),id)
  if id=='A2JR' then
    return 'A2JK'
  elseif id=='Z318' then
    return 'A0BR'
  elseif id=='QF89' then
    return 'QF88'
  elseif id=='QF87' then
    return 'A0KX'
  elseif id=='P247' then
    return 'A086'
  elseif id=='A13T' then
    return 'A522'
  endif
  return id
endfunction

function GetPassiveID takes integer learnid returns integer
  local integer i=1
  local integer k=0
  loop
    if learnid==PassivesLearningSkill[i] or learnid==PassivesLearningSkillUpg[i] or learnid==PassivesRealID[i] or learnid==PassivesSpellbookID[i] then 
      set k=i
    endif
    set i=i+1
    exitwhen k>0 or i>PassivesCount
  endloop
  return k
endfunction

function ChangeAbilityVision takes unit u, integer oldid, integer newid returns nothing
  local integer lvl=GetUnitAbilityLevel(u,oldid)
  call UnitRemoveAbility(u,oldid)
  call UnitAddAbility2(u,newid)
  call SetUnitAbilityLevel(u,newid,lvl)
endfunction

function IsRangedUnit takes unit u, integer pid returns boolean
  return IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER)==true or CheckStacking(PlayerSkillNumber[pid+1],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+2],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+3],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+4],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+5],-1,"range morph",null) or CheckStacking(PlayerSkillNumber[pid+6],-1,"range morph",null)
endfunction

function IsMeleeUnit takes unit u, integer pid returns boolean
  return IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==true or CheckStacking(PlayerSkillNumber[pid+1],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+2],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+3],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+4],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+5],-1,"melee morph",null) or CheckStacking(PlayerSkillNumber[pid+6],-1,"melee morph",null)
endfunction

function Q08 takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetHeroLevel(u)
  local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
  local integer Q28
  local integer i
  local integer k=0
  local integer HQ28
  
  if NumberOfExtraAbilities>=1 then
    set Q28=SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]]
    set Q28=QL8(Q28)
    set HQ28=GetPassiveID(Q28)
    if lvl>=5 and ExtraAbilityLevel[PlayerId*2+1]==0 then
      call UnitAddAbility2(u,Q28)
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call UnitRemoveAbility(u,PassivesUpgradeID[HQ28])
        call UnitAddAbility2(u,PassivesUpgradeID[HQ28])
        call ChangeAbilityVision(u,PassivesLearningSkill[HQ28],PassivesLearningSkillUpg[HQ28])
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,1)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,1)//get ability lvl
      call SaveUnitHandle(HY,'0GTU',1488,u)//get trigger unit
      call SaveInteger(HY,'0GLS',1488,Q28)//get learned skill
      set ExtraAbilityLevel[PlayerId*2+1]=1
      //call BJDebugMsg(LoadStr(MHT,Q28,1000))
      if HaveSavedString(MHT,Q28,1000) then
        call ExeFunc(LoadStr(MHT,Q28,1000))
      endif
      if Q28!='A1IQ' then//not jinada
        call Passive_Cooldown_Learn(u,Q28,1)
      endif
    endif
    if lvl>=8 and ExtraAbilityLevel[PlayerId*2+1]==1 then
      call SetUnitAbilityLevel(u,Q28,2)
      if (GetUnitAbilityLevel(u,'A33H')>0 and (Q28=='A049' or Q28=='A05E')) or (Q28=='A1C0' and GetUnitAbilityLevel(u,'A418')>0) then
        call SetUnitAbilityLevel(u,AlternateSkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]],2)
      endif
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[HQ28],2)
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,2)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,2)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+1]=2
      if HaveSavedString(MHT,Q28,1001) then
        call ExeFunc(LoadStr(MHT,Q28,1001))
      endif
      call Passive_Cooldown_Learn(u,Q28,2)
    endif
    if lvl>=11 and ExtraAbilityLevel[PlayerId*2+1]==2 then
      call SetUnitAbilityLevel(u,Q28,3)
      if (GetUnitAbilityLevel(u,'A33H')>0 and (Q28=='A049' or Q28=='A05E')) or (Q28=='A1C0' and GetUnitAbilityLevel(u,'A418')>0) then
        call SetUnitAbilityLevel(u,AlternateSkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]],3)
      endif
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[HQ28],3)
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,3)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,3)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+1]=3
      if HaveSavedString(MHT,Q28,1001) then
        call ExeFunc(LoadStr(MHT,Q28,1001))
      endif
      call Passive_Cooldown_Learn(u,Q28,3)
    endif
    if lvl>=14 and ExtraAbilityLevel[PlayerId*2+1]==3 then
      call SetUnitAbilityLevel(u,Q28,4)
      if (GetUnitAbilityLevel(u,'A33H')>0 and (Q28=='A049' or Q28=='A05E')) or (Q28=='A1C0' and GetUnitAbilityLevel(u,'A418')>0) then
        call SetUnitAbilityLevel(u,AlternateSkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]],4)
      endif
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[HQ28],4)
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,4)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,4)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+1]=4
      if HaveSavedString(MHT,Q28,1001) then
        call ExeFunc(LoadStr(MHT,Q28,1001))
      endif
      call Passive_Cooldown_Learn(u,Q28,4)
    endif
    call GeneralLearnA(Q28)
    if(ItsEvasionAbility(Q28))then
      set TempInteger=Q28
      call EvasionStacking()
    endif
  endif
  if NumberOfExtraAbilities>=2 then
    set Q28=SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]]
    set HQ28=GetPassiveID(Q28)
    set Q28=QL8(Q28)
    
    set i=AghaGetIndexByBaseSpell(Q28)
    
    if lvl>=8 and ExtraAbilityLevel[PlayerId*2+2]==0 then
      
      call UnitAddAbility(u,Q28)
      call UnitMakeAbilityPermanent(u,true,Q28)
      if Mode_MA then
        if i>0 then
          call UnitMakeAbilityPermanent(u,true,AghaUpgradedSpellID[i])
        endif
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,1)
        endif
      endif
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call UnitAddAbility2(u,PassivesUpgradeID[HQ28])
        call ChangeAbilityVision(u,PassivesLearningSkill[i],PassivesLearningSkillUpg[i])
      endif
      call SaveInteger(HY,'0GAL',1488,1)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+2]=1
      if HaveSavedString(MHT,Q28,1000) then
        call ExeFunc(LoadStr(MHT,Q28,1000))
      endif
      if Q28!='A065' then//-rearm
        call Passive_Cooldown_Learn(u,Q28,1)
      endif
    endif
    if i>0 and GetUnitAbilityLevel(u,AghaUpgradeID[i])>0 then
      set Q28=AghaUpgradedSpellID[i]
    endif
    if lvl>=13 and ExtraAbilityLevel[PlayerId*2+2]==1 then
      call SetUnitAbilityLevel(u,Q28,2)
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[HQ28],2)
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,2)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,2)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+2]=2
      if HaveSavedString(MHT,Q28,1001) then
        call ExeFunc(LoadStr(MHT,Q28,1001))
      endif
      call Passive_Cooldown_Learn(u,Q28,2)
    endif
    if lvl>=18 and ExtraAbilityLevel[PlayerId*2+2]==2 then
      call SetUnitAbilityLevel(u,Q28,3)
      if HidePassivesForPlayer[PlayerId] and HQ28>0 then
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[HQ28],3)
      endif
      if Q28>='A40K' and Q28<='A40N' then
        if GetUnitAbilityLevel(u,Q28+8)>0 then
          call SetUnitAbilityLevel(u,Q28+8,3)
        endif
      endif
      call SaveInteger(HY,'0GAL',1488,3)
      call SaveUnitHandle(HY,'0GTU',1488,u)
      call SaveInteger(HY,'0GLS',1488,Q28)
      set ExtraAbilityLevel[PlayerId*2+2]=3
      if HaveSavedString(MHT,Q28,1001) then
        call ExeFunc(LoadStr(MHT,Q28,1001))
      endif
      call Passive_Cooldown_Learn(u,Q28,3)
    endif
    call GeneralLearnA(Q28)
  endif
  if HidePassivesForPlayer[PlayerId] then
    set TEMPUNIT=u
    call ExeFunc("HidePassivesOnLearn")
  endif
  set u=null
endfunction

function InterruptUnit takes unit u returns nothing
  call PauseUnit(u,true)
  call IssueImmediateOrder(u,"stop")
  call PauseUnit(u,false)
endfunction

function SpellPickingPreventOrders takes nothing returns nothing
  local integer id=GetIssuedOrderId()
  if(GetUnitTypeId(GetTriggerUnit())=='hfoo')then
    if (id==851996 or id==851995 or id==851997 or id==852467 or id==851973 or id==851972)==false then
      call DisableTrigger(GetTriggeringTrigger())
      call InterruptUnit(GetTriggerUnit())
      call EnableTrigger(GetTriggeringTrigger())
    endif
  endif
  if b_isPickTime==false then
    call DestroyTrigger(GetTriggeringTrigger())
  endif
endfunction

function R98 takes nothing returns nothing
  local unit u=GetEnumUnit()
  call CreateUnit(GetOwningPlayer(u),'n00C',GetUnitX(u),GetUnitY(u),.0)
  call PanCameraToTimed(GetUnitX(u),GetUnitY(u),.0)
  call KillUnit(u)
  set u=null
endfunction

function PlacePickDummies takes player p returns nothing
  call CreateUnit(p,'n00C',-7252,6993,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-7252,6666,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-7252,6340,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6775,6993,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6775,6340,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6775,6666,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6412,6993,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6412,6666,bj_UNIT_FACING)
  call CreateUnit(p,'n00C',-6412,6340,bj_UNIT_FACING)
endfunction

function RD8 takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='etol'
endfunction

function RE8 takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='unpl'
endfunction

function RF8 takes integer RG8 returns nothing
  local group g=CreateGroup()
  set GameWasFFed=true
  if RG8==1 then
    call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function RD8))
  else
    call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function RE8))
  endif
  call ForGroup(g,function R98)
  call DestroyGroup(g)
  set g=null
endfunction

function RH8 takes integer PlayerId returns integer
  local integer xx=0
  loop
    if PlayersId[xx]==PlayerId then
      return xx
    endif
    set xx=xx+1
    exitwhen xx>12
  endloop
  return 0
endfunction

function PlayerLeave_CheckFF takes nothing returns nothing
  local integer i=0
  local boolean b=true
  local boolean bb=false
  loop
    if(GetPlayerController(Player(PlayersId[i]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[i]))==PLAYER_SLOT_STATE_PLAYING)then
      set bb=true//if player exist
      if not PlayerFFed[PlayersId[i]]then
        set b=false//not ffed yet
        exitwhen true
      endif
    endif
    set i=i+1
    exitwhen i>5
  endloop
  if b and bb then
    call RF8(1)
  endif
  set i=6
  set b=true
  set bb=false
  loop
    if(GetPlayerController(Player(PlayersId[i]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[i]))==PLAYER_SLOT_STATE_PLAYING)then
      set bb=true
      if not PlayerFFed[PlayersId[i]]then
        set b=false
        exitwhen true
      endif
    endif
    set i=i+1
    exitwhen i>11
  endloop
  if b and bb then
    call RF8(2)
  endif
endfunction

function RN8 takes integer PlayerId, boolean b returns nothing
  local player p=Player(PlayerId)
  if not(GameWasFFed) and Mode_FF then
    if b then //for leavers
      set PlayerFFed[PlayerId]=true
      call PlayerLeave_CheckFF()
      return
    endif
    if GetPlayerState(p,PLAYER_STATE_RESOURCE_LUMBER)>=20 then
      if not(PlayerFFed[PlayerId])then
        call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"Player "+udg_Colors[PlayerId]+PlayerNames[PlayerId]+"|r"+"|c006699CC"+" has voted to fast finish."+"|r")
        set PlayerFFed[PlayerId]=true
        call PlayerLeave_CheckFF()
      else
        call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"You have already voted."+"|r")
      endif
    else
      call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"You can only vote to fast finish after 20 minutes."+"|r")
    endif
  endif
  set p=null
endfunction

function RO8 takes player p returns nothing
  local integer RJ8=0
  if not(GameWasFFed)then
    call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00FF0000[FF] |r"+"|c006699CC"+"Who is FF."+"|r")
    loop
      if((GetPlayerController(Player(PlayersId[RJ8]))==MAP_CONTROL_USER)and(GetPlayerSlotState(Player(PlayersId[RJ8]))==PLAYER_SLOT_STATE_PLAYING))then
        if PlayerFFed[PlayersId[RJ8]]then
          call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c006699CC[|r"+"|c0066FF66Y|r"+"|c006699CC]|r"+" "+TabTab+udg_Colors[PlayersId[RJ8]]+PlayerNames[PlayersId[RJ8]]+"|r")
        else
          call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c006699CC[|r"+"|c00C83264N|r"+"|c006699CC]|r"+" "+TabTab+udg_Colors[PlayersId[RJ8]]+PlayerNames[PlayersId[RJ8]]+"|r")
        endif
      elseif RJ8==0 then
        call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c00ff0303The Sentinel|r")
      elseif RJ8==6 then
        call DisplayTimedTextToPlayer(p,.0,.0,10.,"|c0020c000The Scourge|r")
      endif
      set RJ8=RJ8+1
      exitwhen RJ8>12
    endloop
  endif
endfunction

function RP8 takes nothing returns nothing
  local integer xx=0
  loop
    set PlayersId[xx]=xx
    set xx=xx+1
    exitwhen xx>12
  endloop
endfunction

function IsPlayer takes player p returns boolean
  return GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING and GetPlayerController(p)==MAP_CONTROL_USER
endfunction

function SuspendXP_Fix takes nothing returns boolean
  call SuspendHeroXP(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2),true)
  return false
endfunction

function FixOverexp takes nothing returns nothing
  local trigger t
  local integer h
  local unit Source=GetTriggerUnit()
  local integer SkillPoints=GetHeroSkillPoints(Source)
  if GetHeroLevel(Source)>=MaximumLevel then
    call SuspendHeroXP(Source,true)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
    call TriggerRegisterTimerEvent(t,0.1,true)
    call TriggerAddCondition(t,Condition(function SuspendXP_Fix))
    set t=null
  endif
  set Source=null
endfunction

function DPSTimerCounter takes nothing returns nothing
  local integer i=0
  local integer d=1
  local real totaldmg=0
  loop
    loop
      set totaldmg=totaldmg+LoadReal(HY,i,'hDPS'+d)
      call SaveReal(HY,i,'hDPS'+d,LoadReal(HY,i,'hDPS'+d+1))
      set d=d+1
      exitwhen d==61
    endloop
    set DPS[i]=R2I(totaldmg/60.)
    set d=1
    set totaldmg=0
    set i=i+1
    exitwhen i==12
  endloop
endfunction

function SD8 takes nothing returns nothing
  local integer PlayerId=GetPlayerId(GetOwningPlayer(GetEventDamageSource()))
  local real Damage=GetEventDamage()
  local real hp=GetWidgetLife(GetTriggerUnit())
  if not(GetPlayerController(GetOwningPlayer(GetEventDamageSource()))==MAP_CONTROL_USER) or not(GetPlayerController(GetOwningPlayer(GetTriggerUnit()))==MAP_CONTROL_USER) or not IsPlayerEnemy(GetOwningPlayer(GetTriggerUnit()),GetOwningPlayer(GetEventDamageSource())) then
    return
  endif
  if Damage>hp then
    set Damage=hp
  endif
  if not IsRealDamage then
    return
  endif
  call SaveReal(HY,PlayerId,'hDPS'+60,Damage+LoadReal(HY,PlayerId,'hDPS'+60))
endfunction

function DPSRegister takes nothing returns nothing
  local trigger t
  if b_isPickTime==false and IsPlayer(GetOwningPlayer(GetTriggerUnit())) then
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
    call TriggerAddAction(t,function SD8)
    set t=null
  endif
endfunction

function DistanceBetweenXY takes real x1,real y1,real x2,real y2 returns real
  return SquareRoot(((x1-x2)*(x1-x2))+((y1-y2)*(y1-y2)))
endfunction

function ShakeCamDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call CameraClearNoiseForPlayer(LoadPlayerHandle(HY,h,0))
  call RemoveSavedHandle(HeroStats,GetHandleId(LoadPlayerHandle(HY,h,0)),'CAMS')
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  
  set t=null
endfunction

function ShakeCam takes unit u, real dmg returns nothing
  local timer t
  local integer h
  local player p=GetOwningPlayer(u)
  local integer hp=GetHandleId(p)
  local real power=dmg/100
  if HaveSavedHandle(HeroStats,hp,'CAMS') then
    set t=LoadTimerHandle(HeroStats,hp,'CAMS')
    set h=GetHandleId(t)
    if LoadReal(HY,h,0)<power then
      call CameraClearNoiseForPlayer(p)
    endif
    call CameraSetEQNoiseForPlayer(p,power)
  else
    set t=CreateTimer()
    call TimerStart(t,0.3,false,function ShakeCamDur)
    set h=GetHandleId(t)
    call SavePlayerHandle(HY,h,0,p)
    call SaveReal(HY,h,0,power)
    call CameraSetEQNoiseForPlayer(p,power)
    call SaveTimerHandle(HeroStats,hp,'CAMS',t)
  endif
  
  set t=null
endfunction

function SG8 takes nothing returns nothing
  local texttag tt=null
  local string d=I2S(R2I(GetEventDamage()))
  local player t=GetOwningPlayer(GetTriggerUnit())
  local player a=GetOwningPlayer(GetEventDamageSource())
  if IsPlayer(t) and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and GetEventDamage()>=5 and ShakingOn[GetPlayerId(t)] then
    call ShakeCam(GetTriggerUnit(),GetEventDamage())
  endif
  if d=="0" or (b_isDamageShowed[GetPlayerId(t)]==false and b_isDamageShowed[GetPlayerId(a)]==false) then
    return
  endif
  call CreateTextTagUnitBJ(d,GetTriggerUnit(),zOffsetDebug,12.,100.,100.,100.,.0)
  set zOffsetDebug=zOffsetDebug+20
  set tt=bj_lastCreatedTextTag
  call SetTextTagVelocityBJ(tt,10.,90)
  call SetTextTagPermanentBJ(tt,false)
  call SetTextTagLifespanBJ(tt,3)
  call SetTextTagFadepointBJ(tt,2)
  call SetTextTagVisibility(tt,false)
  if b_isDamageShowed[GetPlayerId(t)]and GetLocalPlayer()==t then
    call SetTextTagColor(tt,250,0,0,255)
    call SetTextTagVisibility(tt,true)
  endif
  if b_isDamageShowed[GetPlayerId(a)]and GetLocalPlayer()==a and IsUnitVisible(GetTriggerUnit(),a)then
    call SetTextTagColor(tt,0,0,250,255)
    call SetTextTagVisibility(tt,true)
  endif
  set tt=null
  set t=null
  set a=null
endfunction

function SH8 takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local trigger t
  if (IsUnitType(u,UNIT_TYPE_HERO) and b_isPickTime)==false then
    if quest_test then
      set t=CreateTrigger()
      call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
      call TriggerAddAction(t,function SG8)
      set t=null
    endif
    if IsUnitType(u,UNIT_TYPE_HERO) and GetUnitAbilityLevel(u,'A04R')==0 then
      call ExeFunc("LoDEvent_Add")
    endif
  endif
  
  set u = null
  //set t = null
endfunction

function isPlayerPickedAbility takes player p,integer SJ8 returns boolean
  local integer PlayerId=GetPlayerId(p)
  local integer xx=1
  loop
    if(PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]==SJ8)then
      return true
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  return false
endfunction

function IsRearmPicked takes unit u returns boolean
  //call echo(B2S(GetUnitAbilityLevel(u,'Y076')==1)+B2S(GetUnitAbilityLevel(u,'A065')>0)+B2S(GetUnitAbilityLevel(u,'A527')>0)+B2S(GetUnitAbilityLevel(u,'A528')>0)+B2S(isPlayerPickedAbility(GetOwningPlayer(u),76)))
  return GetUnitAbilityLevel(u,'Y076')==1 or GetUnitAbilityLevel(u,'A065')>0 or GetUnitAbilityLevel(u,'A527')>0 or GetUnitAbilityLevel(u,'A528')>0 or isPlayerPickedAbility(GetOwningPlayer(u),76)
endfunction

function SK8 takes integer PlayerId,integer Q28 returns integer
  local integer xx=1
  loop
    set Q28=QL8(Q28)
    if(SkillID[PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]]==Q28)then
      return PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  return 0
endfunction

function PreloadAbility takes integer X58 returns nothing
  local unit u=CreateUnit(Player(15),'H00Y',0,0,270)
  call UnitAddAbility(u,X58)
  call UnitRemoveAbility(u,X58)
  call RemoveUnit(u)
  set u=null
endfunction

function GetHeroAbilityLevel takes unit Hero, integer id returns integer
  local integer i=GetPlayerId(GetOwningPlayer(Hero))
  local integer aid1=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+id]]
  local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+id]]
  if aid1!=null then
    if GetUnitAbilityLevel(Hero,aid1)>0 then
      return GetUnitAbilityLevel(Hero,aid1)
    endif
  endif
  return GetUnitAbilityLevel(Hero,aid2)
endfunction



//returns 1st if true, else 2nd
function Switcher takes boolean switch, integer ifBalance, integer ifImbalance returns integer
  if switch then
    return ifBalance
  endif
  return ifImbalance
endfunction

function ST takes integer id, string s returns string
  local integer i=0
  if s==null or s=="" then
    return s
  endif
  loop
    exitwhen HaveSavedString(UTable,id,i)==false
    set i=i+1
  endloop
  call SaveStr(UTable,id,i,s)
  return s
endfunction

function BalanceOffStackSwitch takes integer id, string BO_off returns nothing
  if Mode_BO==false then
    call ST(id,BO_off)
  endif
endfunction

function ExBalanceStackSwitch takes integer id, string stack returns nothing
  if Mode_EB then
    call ST(id,stack)
  endif
endfunction

function GetSkillIndex takes integer id returns integer
  local integer i=1
  loop
    if SkillID[i]==id then
      return i
    endif
    set i=i+1
    exitwhen i>maxSkillId
  endloop
  return -1
endfunction

function CSD takes integer id, string IconPath, string StackLim, integer RSkillId, integer ASkillId, integer USkillId, string BalanceStr, string ExBalanceStr, boolean isPassive, string hotkey returns nothing
  set SkillIcon[id]=IconPath
  set SkillID[id]=RSkillId
  set AlternateSkillID[id]=ASkillId
  set EngineeringUpgradeSkillID[id]=USkillId
  set BalanceStrings[id]=BalanceStr
  set ExBalanceStrings[id]=ExBalanceStr
  set IsPassiveAbility[id]=isPassive
  set IsMultiIconAbility[id]=false
  set IsPermanentAbility[id]=false
  set IsAbilityDoesNotWork[id]=false
  if hotkey!="_" and hotkey!="" and hotkey!=null then
    call SaveStr(UTable,RSkillId,HOTKEY,hotkey)
  endif
  set maxSkillId=id
endfunction

function STCopy takes integer source, integer target returns string
  local integer i=0
  loop
    exitwhen HaveSavedString(UTable,source,i)==false
    call SaveStr(UTable,target,i,LoadStr(UTable,source,i))
    set i=i+1
  endloop
  return null
endfunction

function SD_DoesntWork takes nothing returns nothing
  local integer i=1
  local integer k=0
  local integer lim=(NumberOfHeroes-1)*4
  loop
    if IsAbilityDoesNotWork[i] then
      loop
        
        if ModuloInteger(i,4)==0 then
          set k=GetRandomInt(1,NumberOfHeroes)*4
        else
          set k=GetRandomInt(1,lim)
        endif
        exitwhen R2I(k/4)!=R2I(i/4) and IsAbilityDoesNotWork[k]==false
      endloop
      call CSD(i,SkillIcon[k],STCopy(i,k),SkillID[k],AlternateSkillID[k],EngineeringUpgradeSkillID[k],BalanceStrings[k],ExBalanceStrings[k],IsPassiveAbility[k],LoadStr(UTable,SkillID[k],HOTKEY))
      set IsAbilityDoesNotWork[i]=false
    endif
    set i=i+1
    exitwhen i>lim
  endloop
  
endfunction

function SZ8 takes nothing returns nothing
  local integer i=0
  local string s
  call CSD(0,EmptySlotPath,null,0,0,0,null,null,false,"_")
  set i=indexid_VS-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFrostBolt.blp",ST(i*4+1,"thunderbolt"),'A02A',0,'Y001',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHowlOfTerror.blp",ST(i*4+2,"volcano"),'A17O',0,'Y002',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNGnollCommandAura.blp",null,'P003','QP03','Y003',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNWandOfNeutralization.blp",ST(i*4+4,"forkedlightning"),'A0IN','A1AW','Y004',null,null,false,"w")
  set i=indexid_Zeus-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNChainLightning.blp",ST(i*4+1,"chainlightning"),'A020',0,'Y005',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBlue_Lightning.blp",ST(i*4+2,"thunderbolt"),'A0JC',0,'Y006',null,null,false,"g")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNZeusStatic.blp",null,'A0N5','QP1T','Y007',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSpell_Holy_SealOfMight.blp",ST(i*4+4,"roar")+ST(i*4+4,"r1"),'A29G','A29H','Y008',null,null,false,"w")
  set i=indexid_Enchantress-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNMagicImmunity.blp",ST(i*4+1,null),'A0DW','QP04','Y009',null,null,true,"_")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSlow.blp",ST(i*4+2,"slow"),'A0DX',0,'Y010',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNNaturesAttendants.blp",ST(i*4+3,"tornado"),'A01B',0,'Y011',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDryadDispelMagic.blp",ST(i*4+4,"arrows")+ST(i*4+4,"range only"),'A0DY','A1WB','Y012',null,null,false,"t")
  set IsPermanentAbility[i*4+4]=true
  set i=indexid_Morphling-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCrushingWave.blp",ST(i*4+1,"carrionswarm"),Switcher(Mode_EB,'QB02','A0FN'),0,Switcher(Mode_EB,'QY02','Y013'),null,"Waveform CD 11 -> 13",false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNShimmerWeed.blp",ST(i*4+2,"acidbomb"),'A0G6',0,'Y014',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNReplenishMana.blp",ST(i*4+3,"replenishmana")+ST(i*4+3,"replenishlife")+ST(i*4+3,"abuz agi")+ST(i*4+3,"str bug"),'A0KX',0,'Y015',null,null,false,"_")
  set IsMultiIconAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNForceofNature.blp",ST(i*4+4,"item 16")+ST(i*4+4,"coldarrows"),'A0G8',0,'Y016',null,null,false,"r")
  set i=indexid_CM-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCrystalNova.blp",ST(i*4+1,"mounthippogryph"),'A1E9',0,'Y017',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFrost.blp",ST(i*4+2,"entanglingroots"),'A04C',0,'Y018',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBrilliance.blp",null,'P019','QP05','Y019',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTN_CMFF.blp",ST(i*4+4,"autoharvestlumber"),'A03R','A0AV','Y020',null,null,false,"z")
  set i=indexid_Sven-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNStormBolt.blp",ST(i*4+1,"spellshieldaoe"),'A190',0,'Y021',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCleavingAttack.blp",ST(i*4+2,"melee only"),'A01K','QP06','Y022',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAncestralSpirit.blp",ST(i*4+3,"fanofknives"),'A2IS',0,'Y023',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSvenGS.BLP",ST(i*4+4,"roar"),'A0WP','A43D','Y024',null,null,false,"r")
  set i=indexid_NagaSiren-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSirenMirrorImage.blp",ST(i*4+1,"mirrorimage"),'A063',0,'Y025',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNEnsnare.blp",ST(i*4+2,"unavatar"),'A24D',0,'Y026',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNRipTide.blp",ST(i*4+3,"fanofknives"),'A2KU',0,'Y027',null,null,false,"d")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNPenguin.blp",ST(i*4+4,"awaken")+ST(i*4+4,"avengerform")+ST(i*4+4,"r2"),'A07U',0,'Y028',null,null,false,"g")
  set i=indexid_ES-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNShockWave.blp",ST(i*4+1,"barkskinoff"),'A0SK',0,'Y029',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSmash.blp",ST(i*4+2,"roar"),'A0DL',0,'Y030',null,"Enchant Totem in addition with Tidebringer, Geminate attack (on melee), Walrus Punch, Jinada, Morph or Sleight of Fist will only add +100/140/180/220% dmg",false,"e")
  call ExBalanceStackSwitch(i*4+2,"ET - Tide - Grow - Geminate - Walrus")
  call ExBalanceStackSwitch(i*4+2,"ET-Jinada")
  call ExBalanceStackSwitch(i*4+2,"ET-Geminate")
  call ExBalanceStackSwitch(i*4+2,"ET-Drunken")
  call BalanceOffStackSwitch(i*4+2,"bgdmg1")
  call BalanceOffStackSwitch(i*4+2,"bgdmg2")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAftershock.blp",null,'A0DJ','QP1H','Y031',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNEarthquake.blp",ST(i*4+4,"fanofknives"),'A0DH','A1OB','Y032',null,null,false,"c")
  set i=indexid_Riki-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCloudOfFog.blp",ST(i*4+1,"neutralinteract"),'A0RG',0,'Y033',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBlinkStrikeSA.blp",ST(i*4+2,"barkskinon"),'A0K9',0,'Y034',null,null,false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNTheBlackArrow.blp",null,'A0DZ','QP07','Y035',null,"Backstab deals only .5/0.6/0.7/0.8x agility damage if you have Fury Swipes",true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNRikiINV.blp",ST(i*4+4,"inv bug 1")+ST(i*4+4,"ibug"),'A0MB','QP08','Y036',null,"Permanent Invisibility will be removed on spell casting",true,"_")
  set i=indexid_LoneDruid-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNGrizzlyBear.blp",ST(i*4+1,"summongrizzly"),'A0A5',0,'Y037',null,null,false,"b")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNDOCMasterTraining.blp",ST(i*4+2,"fanofknives"),'A1EG',0,'Y038',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTN_SyllaSynergy.BLP",ST(i*4+3,"engineeringupgrade"),0,0,'Y039',null,null,true,"_")
  set IsAbilityDoesNotWork[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNBearForm.blp",ST(i*4+4,"bearform")+ST(i*4+4,"unbearform")+ST(i*4+4,"battleroar")+ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph"),'A0AG',0,'Y040',null,null,false,"f")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Lina-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSearingArrows.blp",ST(i*4+1,"carrionswarm"),'A01F',0,'Y041',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTN_LightStrikeArray.blp",ST(i*4+2,"restorationoff"),Switcher(Mode_EB,'QB0E','Z042'),0,Switcher(Mode_EB,'QY0E','Y042'),null,"Light Strike Array CD changed from 7 to 9s",false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNDisenchant.blp",null,'A18X','QP1U','Y043',"Spells with a cooldown of 3s or less will only proc Fiery Soul every 2nd cast.",null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNManaFlare.blp",ST(i*4+4,"chainlightning"),'A01P','A09Z','Y044',null,null,false,"g")
  set i=indexid_Juggernaut-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNWhirlwind.blp",ST(i*4+1,"whirlwind"),'A05G',0,'Y045',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHealingWard.blp",ST(i*4+2,"healingward"),'A047',0,'Y046',null,null,false,"g")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBladeDance.blp",ST(i*4+3,null),'A00K','QP09','Y047',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNOmnislash.BLP",ST(i*4+4,"thunderbolt"),'A0M1','A1AX','Y048',null,null,false,"e")
  set i=indexid_Silencer-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNControlMagic.blp",ST(i*4+1,"neutralspell"),'A14L',0,'Y049',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTN_GlaviesOfWisdom.BLP",ST(i*4+2,"arrows")+ST(i*4+2,"range only"),'A0LZ',0,'Y050',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBansheeMaster.BLP",ST(i*4+3,"transmute"),'A2NT',0,'Y051',null,null,false,"t")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSilencerSilence.blp",ST(i*4+4,"battlestations")+ST(i*4+4,"r4"),'A0L3','A2QC','Y052',null,null,false,"e")
  set i=indexid_Treant-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNNaturesGuise.blp",ST(i*4+1,"invisibility"),'A01Z',0,'Y053',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNLeechSeed.blp",ST(i*4+2,"unavengerform"),'A26N',0,'Y054',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNLivingArmor.blp",ST(i*4+3,"spiritlink"),'A2ML',0,'Y055',null,null,false,"v")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNOvergrowth.blp",ST(i*4+4,"blight"),'A07Z','A44S','Y056',null,null,false,"r")
  set i=indexid_Chieftain-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNGreatStomp.blp",ST(i*4+1,"holybolt"),'A1AA',0,'Y057',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNAncestralCharge.blp",ST(i*4+2,"loadcorpse")+ST(i*4+2,"whirlwind"),'A1A8',0,'Y058',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNNaturalOrder.blp",null,'A1CD','QP1I','Y059',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNEarthSplitter.blp",ST(i*4+4,"board"),'A1A1','A43J','Y060',null,null,false,"e")
  set i=indexid_Kotl-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrbOfLightning.blp",ST(i*4+1,"carrionscarabs")+ST(i*4+1,"carrionscarabsinstant"),'A085',0,'Y061',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCharm.blp",ST(i*4+2,"spellsteal"),'A10X',0,'Y062',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPriestAdept.blp",ST(i*4+3,"frenzy"),'A112',0,'Y063',null,null,false,"c")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNGhostMage.blp",ST(i*4+4,"range morph")+ST(i*4+4,"metamorphosis")+ST(i*4+4,"phoenixfire")+ST(i*4+4,"creepheal"),'QM01',0,'Y064',null,null,false,"f")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Ursa-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNEarthquake.blp",ST(i*4+1,"thunderclap"),'A03Y',0,'Y065',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBloodLust.blp",ST(i*4+2,"fanofknives"),Switcher(Mode_EB,'QB0P','A1N4'),0,Switcher(Mode_EB,'QY0P','Y066'),null,"Overpower manacost increased from 45/55/65/75 to 50/65/80/95, and attack speed bonus reduced if you pick Grow",false,"v")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFurySwipes.blp",null,'P067','QP0A','Y067',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNImprovedStrengthOfTheWild.blp",ST(i*4+4,"berserk"),'A0LC','A443','Y068',null,null,false,"r")
  set i=indexid_OgreMagi-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFireBolt.blp",ST(i*4+1,"thunderbolt"),Switcher(Mode_EB,'QB0J','A04W'),0,Switcher(Mode_EB,'QY0J','Y069'),null,"Fire Blast CD changed from 6 to 8s",false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNLiquidFire.blp",ST(i*4+2,"acidbomb"),'A011',0,'Y070',null,null,false,"q")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBloodLust.blp",ST(i*4+3,"bloodlust"),'A083',0,'Y071',null,null,false,"b")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNWitchDoctorMaster.blp",ST(i*4+4,"carrionscarabsoff"),'A088','QP24','Y072',"Multicast chance reduced: x2 by 7%/3.5%/0%, x3 by 7%/3.5%, x4 by 7%",null,true,"_")
  set i=indexid_Tinker-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTinkerLaser.blp",ST(i*4+1,"drunkenhaze"),'A049','A33G','Y073',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNClusterRockets.blp",ST(i*4+2,"fanofknives"),'A05E','A33F','Y074',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMarchOfTheMachines.blp",ST(i*4+3,"manaflareoff")+ST(i*4+3,"stampede"),'A0BQ',0,'Y075',null,null,false,"c")
  set i=i*4+4
  call CSD(i,"ReplaceableTextures\\CommandButtons\\BTNEngineeringUpgrade.blp",ST(i,"monsoon")+ST(i,"channel")+ST(i,"magicundefense"),'A065',0,'Y076',"Rearm has a 9/6/3 cooldown.",null,false,"r")
  set s=ST(i,"r1")+ST(i,"r4")+ST(i,"r55")+ST(i,"r18") //zeus silencer furion spectre
  if Mode_RC==false then
    set s=ST(i,"r44")+ST(i,"r95")+ST(i,"r2")+ST(i,"r3")+ST(i,"r14")+ST(i,"r17")
    set s=ST(i,"r6")+ST(i,"r7")+ST(i,"r8")+ST(i,"r9")+ST(i,"r123")+ST(i,"r11")+ST(i,"r12")+ST(i,"r15")+ST(i,"r16")
    set s=ST(i,"r19")+ST(i,"r20")+ST(i,"r21")+ST(i,"r22")+ST(i,"r23")+ST(i,"r24")+ST(i,"r25")
  endif
  set i=indexid_Furion-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNEatTree.blp",ST(i*4+1,"carrionswarm"),'A21E',0,'Y077',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWispSplode.blp",ST(i*4+2,"blink"),'A01O',0,'Y078',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNEnt.blp",ST(i*4+3,"forceofnature"),'AEfn',0,'Y079',null,null,false,"f")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTreeOfEternity.blp",ST(i*4+4,"chainlightning")+ST(i*4+4,"r55"),'A1W8','A1W9','Y080',null,null,false,"w")
  set i=indexid_PL-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNWindsArrows.blp",ST(i*4+1,"spellstealoff"),'A10D',0,'Y081',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNDoppelwalk.blp",ST(i*4+2,"windwalk"),Switcher(Mode_EB,'QB0B','A0D7'),0,Switcher(Mode_EB,'QY0B','Y082'),null,"Doppelwalk Manacost changed from 150/120/90/60 to 150/130/110/90",false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNJuxtapose.blp",null,'A0DB','QP0B','Y083',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNPhantomEdge.blp",null,'A0YK','QP0C','Y084',null,null,true,"_")
  set IsAbilityDoesNotWork[i*4+4]=true
  set i=indexid_Tiny-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNGolemStormBolt.blp",ST(i*4+1,"phoenixmorph"),'A0LL',0,'Y085',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNToss.blp",ST(i*4+2,"carrionscarabson"),'A0BZ',0,'Y086',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNResistantSkin.blp",null,'A19Q','QP1J','Y087',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTinyGrow.blp",null,'A0CY','QP1K','Y088',null,"Only increases damage by 40/80/120 for ranged heroes or heroes with range morphs.",true,"_")
  call ExBalanceStackSwitch(i*4+4,"ET - Tide - Grow - Geminate - Walrus")
  call BalanceOffStackSwitch(i*4+4,"bgdmg1")
  call BalanceOffStackSwitch(i*4+4,"bgdmg2")
  set IsPermanentAbility[i*4+4]=true
  set i=indexid_Techies-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNGoblinLandMine.blp",ST(i*4+1,"item 89"),'A05J',0,'Y089',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNStasisTrap.blp",ST(i*4+2,"stasistrap"),'A06H',0,'Y090',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSelfDestructOn.blp",ST(i*4+3,"selfdestruct"),'A06B',0,'Y091',null,null,false,"c")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNRemote.blp",ST(i*4+4,"ward")+ST(i*4+4,"chainlightning"),'A0AK','A1FY','Y092',null,null,false,"r")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Chen-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNHolyBolt.blp",ST(i*4+1,"drunkenhaze"),'A0KM',0,'Y093',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNStaffOfPreservation.blp",ST(i*4+2,"ancestralspirittarget")+ST(i*4+2,"build"),'A0LV',0,'Y094',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNScepterOfMastery.blp",ST(i*4+3,"ambush"),'A28T',0,'Y095',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNHeal.blp",ST(i*4+4,"controlmagic")+ST(i*4+4,"r6"),'A0LT','A1CS','Y096',null,null,false,"d")
  set i=indexid_Luna-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNMoonStone.blp",ST(i*4+1,"firebolt"),'A042',0,'Y097',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNUpgradeMoonGlaive.blp",ST(i*4+2,"buff placer")+ST(i*4+2,"arrows"),'A041','QP0D','Y098',null,null,true,"_")
  set IsPermanentAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAdvancedStrengthOfTheMoon.blp",null,'A062','QP0E','Y099',null,null,true,"_")
  set IsPermanentAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNElunesBlessing.blp",ST(i*4+4,"corporealform"),'A054','A00U','Y100',null,null,false,"e")
  set i=indexid_Sniper-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFragmentationBombs.blp",ST(i*4+1,"possession"),'A064',0,'Y101',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHumanMissileUpOne.blp",null,'A03S','QP0F','Y102',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNHumanMissileUpTwo.blp",ST(i*4+3,"range only"),'A03U','QP1Q','Y103',null,null,true,"_")
  set IsPermanentAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDwarvenLongRifle.blp",ST(i*4+4,"thunderbolt"),'A04P','A1AU','Y104',null,null,false,"t")
  set i=indexid_Troll-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrcMeleeUpThree.blp",ST(i*4+1,"metamorphosis")+ST(i*4+1,"bearform")+ST(i*4+1,"unbearform")+ST(i*4+1,"melee morph")+ST(i*4+1,"bash"),'A0BE',0,'Y105',null,null,false,"g")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWhirlingAxesRanged.blp",ST(i*4+2,"autodispel")+ST(i*4+2,"loadarcher"),'A21M','A21N','Y106',null,null,false,"e")
  set IsMultiIconAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNCommand.blp",null,'A0O0','QP0G','Y107',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNBerserkForTrolls.blp",ST(i*4+4,"fanofknives"),'A1EJ',0,'Y108',null,null,false,"r")
  set i=indexid_Rhasta-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNRhastaForkedLightning.blp",ST(i*4+1,"forkedlightning"),'A010',0,'Y109',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHex.blp",ST(i*4+2,"hex"),'A0RX',0,'Y110',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMagicLariet.blp",ST(i*4+3,"magicleash"),'A00P',0,'Y111',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSerpentWard.blp",ST(i*4+4,"ward")+ST(i*4+4,"r7"),'A00H','A0A1','Y112',null,null,false,"w")
  set i=indexid_Wisp-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTether.blp",ST(i*4+1,"chainlightning, frenzyoff"),'A1TA',0,'Y113',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSpirits.blp",ST(i*4+2,"fanofknives")+ST(i*4+2,"battleroar")+ST(i*4+2,"roar"),'A1T8',0,'Y114',null,null,false,"w")
  set IsMultiIconAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNOvercharge.blp",ST(i*4+3,"manashieldon")+ST(i*4+3,"manashieldoff"),'A28Q',0,'Y115',null,null,false,"v")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNRelocate.blp",ST(i*4+4,"spellstealon"),'A1TB',0,'Y116',null,null,false,"r")
  set i=indexid_Pandaren-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNThunderClapPanda.blp",ST(i*4+1,"thunderclap"),'A06M',0,'Y117',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNStrongDrink.blp",ST(i*4+2,"drunkenhaze"),'Acdh',0,'Y118',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNDrunkenDodge.blp",null,'A0MX','QP0H','Y119',null,null,true,"_")
  call ExBalanceStackSwitch(i*4+3,"ET-Drunken")
  call ExBalanceStackSwitch(i*4+3,"Tide-Drunken")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStormEarth&Fire.blp",ST(i*4+4,"elementalfury"),'A0MQ','A1B6','Y120',null,null,false,"r")
  set i=indexid_Centaur-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNWarStomp.blp",ST(i*4+1,"stomp"),'A00S',0,'Y121',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNArcaniteMelee.blp",ST(i*4+2,"firebolt"),'A00L',0,'Y122',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNThorns.blp",null,'A00V','QP0I','Y123',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStampede.blp",ST(i*4+4,"ward")+ST(i*4+4,"r8"),'A2O6',0,'Y124',null,null,false,"t")
  set i=indexid_Bounty-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNUpgradeMoonGlaive.blp",ST(i*4+1,"thunderbolt"),'A004',0,'Y125',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNJinada.blp",ST(i*4+2,"nagabuild")+ST(i*4+2,"r9"),'A1IQ',0,'Y126',null,"Jinada only deals 1.25/1.45/1.65/1.85x damage if it procs while 'Sleight of Fist' or 'Grow!' or 'Geminate attack' (on melee) picked",true,"_")
  call ExBalanceStackSwitch(i*4+2,"ET-Jinada")
  call ExBalanceStackSwitch(i*4+2,"Tide-Jinada")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNWindWalkOn.blp",ST(i*4+3,"windwalk"),Switcher(Mode_EB,'QB09','A07A'),0,Switcher(Mode_EB,'QY09','Y127'),null,"Windwalk manacost changed from 50 to 50/60/70/80",false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTrack.blp",ST(i*4+4,"faeriefire"),'A0B4',0,'Y128',null,null,false,"r")
  set i=indexid_DK-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDKBreatheFire.blp",ST(i*4+1,"breathoffire"),'A03F',0,'Y129',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHumanArmorUpThree.blp",ST(i*4+2,"thunderbolt"),Switcher(Mode_EB,'QB0G','A0AR'),0,Switcher(Mode_EB,'QY0G','Y130'),null,"Dragon Tail CD changed from 9 to 11",false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNIncinerate.blp",null,'A0CL','QP0J','Y131',null,null,true,"_")
  set IsPermanentAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAzureDragon.blp",ST(i*4+4,"metamorphosis")+ST(i*4+4,"range morph"),'QM00',0,'Y132',null,null,false,"r")
  set i=indexid_AM-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFeedback.blp",ST(i*4+1,"orb effect"),'A022','QP0K','Y133',null,null,true,"_")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBlink.blp",ST(i*4+2,"blink"),Switcher(Mode_EB,'QB08','AEbl'),0,Switcher(Mode_EB,'QY08','Y134'),null,"Blink manacost changed from 60 to 60/70/80/90",false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNNeutralManaShield.blp",null,'A0KY','QP0L','Y135',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNManaVoid.blp",ST(i*4+4,"thunderbolt"),'A0E3',0,'Y136',null,null,false,"v")
  set i=indexid_Trax-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNColdArrows.blp",ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A026',0,'Y137',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNDrowSilence.blp",ST(i*4+2,"silence"),'A33A',0,'Y138',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNTrueShot.blp",ST(i*4+3,"defend"),'A2O2',0,'Y139',"Trueshot Aura only works on range creeps, no matter if your hero is range or melee",null,false,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMarksmanship.blp",ST(i*4+4,"fanofknives"),'QF89',0,'QY88',null,null,false,"_")
  set i=indexid_Omni-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNResurrection.blp",ST(i*4+1,"frostarmor"),'A08N',0,'Y141',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNRepel.blp",ST(i*4+2,"antimagicshell"),'A08V',0,'Y142',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSpiritLink.blp",null,'A06A','QP0M','Y143',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDivineIntervention.blp",ST(i*4+4,"battleroar"),'A0ER','A2S8','Y144',null,null,false,"g")
  set i=indexid_Beastmaster-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAbility_Warrior_SavageBlow.blp",ST(i*4+1,"carrionswarm"),'A0O1',0,'Y145',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNEnchantedCrows.blp",ST(i*4+2,"awaken")+ST(i*4+2,"unsummon"),'A0OO',0,'Y146',null,null,false,"d")
  set IsMultiIconAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNEnchantedBears.blp",ST(i*4+3,null),'A0BD','QP0N','Y147',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNBattleRoar.blp",ST(i*4+4,"thunderbolt"),'A0O2','A289','Y148',null,null,false,"r")
  set i=indexid_THD-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDualBreath.blp",ST(i*4+1,"carrionswarm"),'A0O7',0,'Y149',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFreezingBreath.blp",ST(i*4+2,"breathoffire"),'A0O6',0,'Y150',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAutoFire.blp",ST(i*4+3,"acidbomb"),'A30T',0,'Y151',null,null,false,"q")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNBreathOfFireNew.blp",ST(i*4+4,"shockwave"),'A0O5','A1B1','Y152',null,null,false,"r")
  set i=indexid_Alchemist-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNHealingSpray.blp",ST(i*4+1,"preservation"),'A0IL',0,'Y153',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNUnstableConcoction.blp",ST(i*4+2,"fanofknives")+ST(i*4+2,"corrosivebreath"),'A1NI',0,'Y154',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMGexchange.blp",null,'A0O3','QP0O','Y155',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNChemicalRage.blp",ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r25"),Switcher(Mode_EB,'QB0K','ANcr'),0,Switcher(Mode_EB,'QY0K','Y156'),null,"Chemical Rage BAT changed from 1.4/1.2/1.0 to 1.5/1.4/1.3, Manareg from 3/7.5/12 to 3/7/11, HP Regen from 50/75/100 to 30/50/70",false,"r")
  set i=indexid_Potm-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNStarfall.blp",ST(i*4+1,"coupleinstant"),'A0KV',0,'Y157',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNImprovedStrengthOfTheMoon.blp",ST(i*4+2,"spies"),'A0L8',0,'Y158',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAdvancedStrengthOfTheWild.blp",ST(i*4+3,"windwalk"),'A0LN',0,'Y159',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAmbush.blp",ST(i*4+4,"corporealform")+ST(i*4+4,"r11"),'A0KU',0,'Y160',null,null,false,"w")
  set i=indexid_Storm-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAbility_Druid_CatForm.blp",ST(i*4+1,"fanofknives"),'A14P',0,'Y161',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNManaFlare.blp",ST(i*4+2,"chainlightning"),'A14R',0,'Y162',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNOverload.blp",null,'A0QW','QP1V','Y163',"Spells with a cooldown of 3s or less will only proc Overload every 2nd cast (except Ball Lightning).",null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStormReach.blp",ST(i*4+4,"carrionswarm"),'A14O',0,'Y164',null,null,false,"g")
  set i=indexid_Huskar-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNRegenerate.blp",ST(i*4+1,"massteleport"),'A0QP',0,'Y165',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFlamingArrows.blp",ST(i*4+2,"arrows"),'A0QN',0,'Y166',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBerserkerBlood.blp",null,'A0QQ','QP1L','Y167',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSoulEater.blp",ST(i*4+4,"firebolt"),'A0QR','A1B3','Y168',null,null,false,"f")
  set i=indexid_Lanaya-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNRefraction.blp",ST(i*4+1,"fanofknives"),'A1EA',0,'Y169',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWardenHide.blp",ST(i*4+2,"windwalk"),'A0RV',0,'Y170',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNVorpal.blp",ST(i*4+3,"range only"),'A0RO','QP1S','Y171',null,null,true,"_")
  set IsPermanentAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTrap.blp",ST(i*4+4,"curse")+ST(i*4+4,"spiritwolf"),'A0RP','A449','Y172',null,null,false,"c")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Puck-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNIllusory.blp",ST(i*4+1,"spiritlink")+ST(i*4+1,"coupletarget"),'A0S9',0,'Y173',null,null,false,"r")
  set IsMultiIconAbility[i*4+1]=true
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWanningRift.blp",ST(i*4+2,"creepanimatedead"),'A0SC',0,'Y174',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPhaseShift.blp",ST(i*4+3,"phaseshift"),'A0SB',0,'Y175',null,null,false,"f")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNManaFlare.blp",ST(i*4+4,"rainofchaos"),'A0S8','A1QP','Y176',null,null,false,"c")
  set i=indexid_Clock-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFlakCannons.blp",ST(i*4+1,"creepdevour"),'A0Z4',0,'Y177',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNPowerGenerator.blp",ST(i*4+2,"neutraldetectaoe"),'A0Z5',0,'Y178',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFlare.blp",ST(i*4+3,"blizzard"),'A0Z6',0,'Y179',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStrengthOfTheMoon.blp",ST(i*4+4,"clusterrockets"),'A0Z8','A1CV','Y180',null,null,false,"t")
  set i=indexid_Admiral-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTorrent.blp",ST(i*4+1,"rejuvination"),'A136',0,'Y181',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNTidebringer.blp",ST(i*4+2,"orcbuild")+ST(i*4+2,"r12"),'A13T',0,'Y182',"Tidebringer only deals 80% AoE damage for ranged attackers.",null,true,"_")
  call BalanceOffStackSwitch(i*4+2,"bgdmg2")
  call ExBalanceStackSwitch(i*4+2,"ET - Tide - Grow - Geminate - Walrus")
  call ExBalanceStackSwitch(i*4+2,"Tide-Jinada")
  call ExBalanceStackSwitch(i*4+2,"Tide-Drunken")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSpy.blp",ST(i*4+3,"incineratearrow")+ST(i*4+3,"incineratearrowoff"),'A11N',0,'Y183',null,null,false,"x")
  set IsMultiIconAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNUndeadDestroyer.blp",ST(i*4+4,"spiritofvengeance"),'A11K',0,'Y184',null,null,false,"t")
  set i=indexid_WR-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNShackleShot.blp",ST(i*4+1,"chainlightning"),'A12J',0,'Y185',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNPowerShot.blp",ST(i*4+2,"spirittroll"),'A12K',0,'Y186',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNCyclone.blp",ST(i*4+3,"fanofknives"),'A14I',0,'Y187',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNFocusFire.blp",ST(i*4+4,"incineratearrowon"),'A12P','A1D6','Y188',null,null,false,"f")
  set i=indexid_Gyro-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFlakCannons.blp",ST(i*4+1,"creepthunderbolt"),'A1SO',0,'Y189',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHumanArtilleryUpOne.blp",ST(i*4+2,"chainlightning"),'A1SQ',0,'Y190',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFragmentationBombs.blp",ST(i*4+3,"orb effect")+ST(i*4+3,"range only")+ST(i*4+3,"fanofknives")+ST(i*4+3,"multi-attack"),'A229',0,'Y191',null,null,false,"f")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNCalldown.blp",ST(i*4+4,"ravenform"),'A1T5','A235','Y192',null,null,false,"c")
  set i=indexid_Disruptor-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNThrallIcon4.blp",ST(i*4+1,"autodispel"),'A1TV',0,'Y193',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNThrallIcon3.blp",ST(i*4+2,"chainlightning"),'A1SW',0,'Y194',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNThrallIcon1.blp",ST(i*4+3,"rechargeoff"),'A1SU',0,'Y195',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStaticField.blp",ST(i*4+4,"stampede"),'A1U6','A30N','Y196',null,null,false,"r")
  set i=indexid_Tusk-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNIceShards.blp",ST(i*4+1,"standdown"),'A1YO',0,'Y197',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSnowball2.blp",ST(i*4+2,"frenzyon"),'A1S7',0,'Y198',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFrozenSigil.blp",ST(i*4+3,"summongrizzly"),'A1YR',0,'Y199',null,null,false,"f")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNChillingTouch.blp",ST(i*4+4,"fanofknives"),'A1YQ',0,'Y200',null,null,false,"r")
  call ExBalanceStackSwitch(i*4+4,"ET - Tide - Grow - Geminate - Walrus")
  call BalanceOffStackSwitch(i*4+4,"bgdmg2")
  set i=indexid_Phoenix-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDash.blp",ST(i*4+1,"creepthunderclap"),'A1RJ',0,'Y201',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFireSpirits.blp",ST(i*4+2,"gold2lumber")+ST(i*4+2,"harvest"),'A1YX',0,'Y202',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSunray.blp",ST(i*4+3,"charm")+ST(i*4+3,"immolation")+ST(i*4+3,"unimmolation")+ST(i*4+3,"animatedead"),'A1YY',0,'Y203',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNPhoenix2.blp",ST(i*4+4,"rechargeon")+ST(i*4+4,"r123")+ST(i*4+4,"locust")+ST(i*4+4,"sun+raisedead"),'A1RK','A43H','Y204',null,null,false,"v")
  set i=indexid_BB-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNBristleGoo.blp",ST(i*4+1,"darkritual"),'A0FW',0,'Y205',null,null,false,"g")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFanOfKnives.blp",ST(i*4+2,"fanofknives"),'A0GP',0,'Y206',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNQuillSprayOff.blp",ST(i*4+3,null),'A0M3','QP1M','Y207',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNHire.blp",null,'A0FV','QP1N','Y208',"Spells with a cooldown of 3s or less will only proc Warpath every 2nd cast (except Goo and Quill Spray).",null,true,"_")
  set i=indexid_Rubick-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTelekinesis.blp",ST(i*4+1,"wispharvest"),'A27F',0,'Y209',null,null,false,"z")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFadeBolt.blp",ST(i*4+2,"tranquility"),'A27G',0,'Y210',null,null,false,"x")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNNullField.blp",null,'A27V','QP0P','Y211',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSpellSteal2.blp",ST(i*4+4,"transmute")+ST(i*4+4,"shbug"),'A27H','A30J','Y212',null,null,false,"q")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Xin-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSearingChains.blp",ST(i*4+1,"fanofknives"),'A2H3',0,'Y213',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSleightOfFist.blp",ST(i*4+2,"recharge")+ST(i*4+2,"metamorphosis"),Switcher(Mode_EB,'QB0L','A2H0'),0,Switcher(Mode_EB,'QY0L','Y214'),null,"Grow! provides less damage while using Sleight of Fist. Sleight of Fist CD changed from 30/22/14/6 to 32/24/16/8.",false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFlameGuard.blp",ST(i*4+3,"darksummoning"),'A2HS',0,'Y215',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNFireRemnant.blp",ST(i*4+4,"ancestralspirit")+ST(i*4+4,"acolyteharvest")+ST(i*4+4,"acidbomb"),'A2JR','A2JL','Y216',null,null,false,"r")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Legion-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAnimalWarTraining.blp",ST(i*4+1,"steal"),'A2JB',0,'Y217',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNPressTheAttack.blp",ST(i*4+2,"creepheal"),'A2J2',0,'Y218',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMomentOfCourage.blp",null,'A2EY','QP1O','Y219',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDuel.blp",ST(i*4+4,"autodispeloff"),'A2CI',0,'Y220',null,null,false,"d")
  set i=indexid_Skywrath-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNArcaneBolt.blp",ST(i*4+1,"chainlightning"),'A2BE',0,'Y221',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNConcussiveShot.blp",ST(i*4+2,"fanofknives"),'A2IT',0,'Y222',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAncientSeal.blp",ST(i*4+3,"soulburn"),'A2HN',0,'Y223',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMysticFlare.blp",ST(i*4+4,"submerge"),'A2BG','A30H','Y224',null,null,false,"e")
  set i=indexid_Timber-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNWhirlingDeath.blp",ST(i*4+1,"fanofknives"),'A2FK',0,'Y225',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNTimberChain.blp",ST(i*4+2,"summonfactory"),'A2E3',0,'Y226',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNReactiveArmor.blp",null,'A2E4','QP1P','Y227',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNShredder_Chakram.blp",ST(i*4+4,"massteleport")+ST(i*4+4,"immolation")+ST(i*4+4,"unimmolation")+ST(i*4+4,"windwalk")+ST(i*4+4,"auraunholy"),'A2E5','A43S','Y228',null,null,false,"c")
  set i=indexid_Lycan-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSpiritWolf.blp",ST(i*4+1,"spiritwolf"),'A03D',0,'Y229',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHowlOfTerror.blp",ST(i*4+2,"deathanddecay"),'A0ZF',0,'Y230',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFeralHeart.blp",null,'A03E','QP0Q','Y231',null,null,true,"_")
  set IsPermanentAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDireWolf.blp",ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r95"),'QM02',0,'Y232',null,null,false,"f")
  set i=indexid_Brood-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSpiderGreen.blp",ST(i*4+1,"parasite"),'A0BH',0,'Y233',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWeb.blp",ST(i*4+2,"restoration")+ST(i*4+2,"inv bug 1"),'Z234',0,'Y234',null,null,false,"b")
  set IsPermanentAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNRedDragonDevour.blp",ST(i*4+3,"orb effect"),'Q0BK',0,'Y235',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNspiderling.blp",ST(i*4+4,"bash")+ST(i*4+4,"roar")+ST(i*4+4,"melee only"),'A0WQ',0,'Y236',null,null,false,"t")
  set i=indexid_PA-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNThoriumRanged.blp",ST(i*4+1,"summonphoenix"),'A0YM',0,'Y237',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBearBlink.blp",ST(i*4+2,"deathcoil"),'A0PL',0,'Y238',null,null,false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPABlur.blp",null,'A03P','QP0R','Y239',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNCoupDeGrace.blp",null,'A03Q','QP0S','Y240',null,null,true,"_")
  set i=indexid_Medusa-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSplitShot.blp",ST(i*4+1,"range only")+ST(i*4+1,"fanofknives"),'A1C0','A418','Y241',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNMysticSnakeNew.blp",ST(i*4+2,"chainlightning"),'A0G2',0,'Y242',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNNeutralManaShield.blp",ST(i*4+3,"manashieldon")+ST(i*4+3,"manashieldoff")+ST(i*4+3,"shbug"),'A0MP',0,'Y243',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNStoneGazeNew.blp",ST(i*4+4,"lavamonster"),'A1AT',0,'Y244',null,null,false,"g")
  set i=indexid_Bala-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNVoid.blp",ST(i*4+1,"thunderbolt"),'A02H',0,'Y245',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNPossession.blp",ST(i*4+2,"drunkenhaze"),'A08C',0,'Y246',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNHeroDreadLord.blp",null,'P247','A086','Y247',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDarkness.blp",ST(i*4+4,"battlestations")+ST(i*4+4,"r14"),'DRKN',0,'Y248',null,null,false,"r")
  set IsPermanentAbility[i*4+4]=true
  set i=indexid_Leoric-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAdvancedUnholyStrength.blp",ST(i*4+1,"thunderbolt"),Switcher(Mode_EB,'QB0H','AHtb'),0,Switcher(Mode_EB,'QY0H','Y249'),null,"Hellfire Blast CD changed from 8 to 10s",false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNVampiricAura.blp",null,'P250','QP0U','Y250',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\PassiveButtons\\BTNSkeletonCriticalStrike.blp",ST(i*4+3,"wispharvest"),'A2S0','QP0W','Y251',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNRe.blp",ST(i*4+4,"reincarnation")+ST(i*4+4,"r15"),'A01Y',0,'Y252',null,null,false,"_")
  set i=indexid_Doom-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNRedDragonDevour.blp",ST(i*4+1,"channel")+ST(i*4+1,"animatedead")+ST(i*4+1,"stomp")+ST(i*4+1,"tornado")+ST(i*4+1,"ensnare")+ST(i*4+1,"thunderclap")+ST(i*4+1,"purge"),'A10R','A32Z','Y253',null,null,false,"e")
  set s=ST(i*4+1,"shockwave")+ST(i*4+1,"frostarmor")+ST(i*4+1,"manaburn")+ST(i*4+1,"heal")+ST(i*4+1,"chainlightning")+ST(i*4+1,"raisedead")
  set IsMultiIconAbility[i*4+1]=true
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWallOfFire.blp",ST(i*4+2,"fanofknives"),'A1OP',0,'Y254',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSoulBurn.blp",ST(i*4+3,"firebolt"),'A094',0,'Y255',null,null,false,"v")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDoom.blp",ST(i*4+4,"doom"),'A0MU','A0A2','Y256',null,null,false,"d")
  set i=indexid_NA-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNImpaleNA.blp",ST(i*4+1,"impale"),'A0X7',0,'Y257',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNManaBurn.blp",ST(i*4+2,"creepheal"),'A1H5',0,'Y258',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNThornShield.blp",ST(i*4+3,"fanofknives"),'A2KO',0,'Y259',null,null,false,"d")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNWindWalkOn.blp",ST(i*4+4,"windwalk"),'A09U',0,'Y260',null,null,false,"v")
  set i=indexid_Slardar-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSirenMaster.blp",ST(i*4+1,"berserk"),'A05C',0,'Y261',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHydraWarStomp.blp",ST(i*4+2,"roar"),Switcher(Mode_EB,'QB0I','A29K'),0,Switcher(Mode_EB,'QY0I','Y262'),null,"Slithereen Crush CD changed from 8 to 10",false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSlardarBash.blp",ST(i*4+3,"bash"),'A0JJ','QP0V','Y263',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAmplifyDamage.blp",ST(i*4+4,"faeriefire"),Switcher(Mode_EB,'QB0C','A034'),0,Switcher(Mode_EB,'QY0C','Y264'),null,"Amplify Damage manacost changed from 25 -> 35/45/55",false,"g")
  set i=indexid_QoP-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNShadowStrike.blp",ST(i*4+1,"shadowstrike"),'A0Q7',0,'Y265',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBlink.blp",ST(i*4+2,"blink"),Switcher(Mode_EB,'QB07','A0ME'),0,Switcher(Mode_EB,'QY07','Y266'),null,"Blink manacost changed from 60 to 60/70/80/90",false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPossession.blp",ST(i*4+3,"fanofknives"),'A04A',0,'Y267',null,null,false,"f")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTornado.blp",ST(i*4+4,"shockwave"),'A28R','A28S','Y268',null,null,false,"w")
  set i=indexid_Bone-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNClinkzStrafe.blp",ST(i*4+1,"berserk"),'A030',0,'Y269',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSearingArrows.blp",ST(i*4+2,"arrows")+ST(i*4+2,"range only")+ST(i*4+2,"channel"),'AHfa',0,'Y270',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNWindWalkOn.blp",ST(i*4+3,"windwalk"),Switcher(Mode_EB,'QB0A','A025'),0,Switcher(Mode_EB,'QY0A','Y271'),null,"Windwalk (Clinkz) manacost changed from 75 to 80/90/100/110",false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDeathPact.blp",ST(i*4+4,"innerfire"),'A04Q',0,'Y272',null,null,false,"e")
  set i=indexid_Void-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTimewalk.blp",ST(i*4+1,"carrionswarm"),'A0LK',0,'Y273',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBacktrack.blp",null,'A0CZ','QP22','Y274',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNTimelock.blp",ST(i*4+3,"bash"),'A081','QP0X','Y275',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNChronosphere.blp",ST(i*4+4,"clusterrockets")+ST(i*4+4,"r16"),'A0J1','A1D7','Y276',null,null,false,"c")
  set i=indexid_Viper-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSlowPoison.blp",ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A09V',0,'Y277',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCorrosiveBreath.blp",null,'A1A3','QP21','Y278',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMagicImmunity.blp",null,'A0MM','QP0Y','Y279',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNShadowStrike.blp",ST(i*4+4,"shadowstrike"),'A080','A1UZ','Y280',null,null,false,"v")
  set i=indexid_Razor-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNPlasmaField.blp",ST(i*4+1,"fanofknives"),'A1E7',0,'Y281',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNRazorChain.blp",ST(i*4+2,"tankdroppilot"),'A1DP',0,'Y282',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNUnstableCurrent.blp",null,'A1E6','QP0Z','Y283',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMonsoon.blp",ST(i*4+4,"darkportal"),'A1AO','A1UV','Y284',null,null,false,"e")
  set i=indexid_Lifestealer-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNUnholyFrenzy.blp",ST(i*4+1,"852273"),'A0T2',0,'Y285',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCannibalize.blp",ST(i*4+2,"agi bug 1"),'A0SS','QP1W','Y286',"Feast only regenerates/deals 1.75/2.75/3.75/4.75% HP on ranged heroes.",null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNGhoulFrenzy.blp",ST(i*4+3,"chainlightning"),'A194',0,'Y287',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNOrbOfCorruption.blp",ST(i*4+4,"decouple"),'A0SW',0,'Y288',null,null,false,"t")
  set i=indexid_Pugna-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrbOfLightning.blp",ST(i*4+1,"unavatar"),'A0MT',0,'Y289',null,null,false,"b")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCripple.blp",ST(i*4+2,"banish"),'A2TD',0,'Y290',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNEntrapmentWard.blp",ST(i*4+3,"summongrizzly"),'A09D',0,'Y291',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNLifeDrain.blp",ST(i*4+4,"drain"),'A0CC','A02Z','Y292',null,null,false,"d")
  set i=indexid_Tide-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSummonWaterElemental.blp",ST(i*4+1,"acidbomb"),'A046',0,'Y293',null,null,false,"g")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNNagaArmorUp3.blp",null,'A04E','QP10','Y294',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAnchorSmash.blp",ST(i*4+3,"roar"),'A226',0,'Y295',null,null,false,"c")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSeaGiantWarStomp.blp",ST(i*4+4,"howlofterror"),'A29I',0,'Y296',null,null,false,"v")
  set i=indexid_Bane-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCurse.blp",ST(i*4+1,"innerfire"),'A04V',0,'Y297',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNDevourMagic.blp",ST(i*4+2,"chainlightning"),'A0GK',0,'Y298',null,null,false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNWandOfShadowSight.blp",ST(i*4+3,"sleep"),'A04Y',0,'Y299',null,null,false,"t")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAmuletOftheWild.blp",ST(i*4+4,"magicleash"),'A02Q','A1D9','Y300',null,null,false,"f")
  set i=indexid_Necrolyte-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDeathNova.blp",ST(i*4+1,"fanofknives"),'A05V',0,'Y301',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSpell_Holy_SealOfRighteousness.blp",null,'A01N','QP11','Y302',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNOrbOfCorruption.blp",null,'A060','QP12','Y303',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNReapersScythe.blp",ST(i*4+4,"thunderbolt"),'A067','A08P','Y304',null,null,false,"r")
  set i=indexid_Pudge-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNImpale.blp",ST(i*4+1,"detectaoe"),'A06I',0,'Y305',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNPlagueCloud.blp",ST(i*4+2,"unimmolation"),'A06K',0,'Y306',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNExhumeCorpses.blp",null,'A06D','QP13','Y307',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNCannibalize.blp",ST(i*4+4,"magicleash"),'A0FL','A1CX','Y308',null,null,false,"d")
  set i=indexid_Barathum-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_GatherShadows.blp",ST(i*4+1,"detonate"),'A1P8',0,'Y309',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNEtherealFormOn.blp",ST(i*4+2,"fanofknives"),'A0ES','QP14','Y310',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNGreaterBash.blp",ST(i*4+3,"bash"),'A0G5','QP1X','Y311',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNNetherStrike.blp",ST(i*4+4,"creepheal"),'A0G4','A1D8','Y312',null,null,false,"e")
  set i=indexid_Weaver-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCarrionSwarm.blp",ST(i*4+1,"tankloadpilot"),'A1QW',0,'Y313',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWeaverShukuchi.blp",ST(i*4+2,"windwalk"),'A0CA',0,'Y314',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNLocustSwarm.blp",ST(i*4+3,"orb effect"),'A0CG',0,'Y315',null,null,true,"_")
  call ExBalanceStackSwitch(i*4+3,"ET - Tide - Grow - Geminate - Walrus")
  call BalanceOffStackSwitch(i*4+3,"bgdmg2")
  call ExBalanceStackSwitch(i*4+3,"ET-Geminate")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNOrbOfFrost.blp",ST(i*4+4,"disassociate"),'A0CT',0,'Y316',null,null,false,"t")
  set i=indexid_SF-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDeathCoil.blp",ST(i*4+1,"roar")+ST(i*4+1,"howlofterror")+ST(i*4+1,"battleroar"),'A0EY',0,'Y317',null,null,false,"z")
  set IsMultiIconAbility[i*4+1]=true
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSacrificialSkull.blp",null,'Z318','A0BR','Y318',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNRegenerationAura.blp",null,'A0FU','QP15','Y319',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDizzy.blp",ST(i*4+1,"852273"),'A29J',0,'Y320',null,null,false,"r")
  set i=indexid_SK-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNImpale.blp",ST(i*4+1,"disenchant"),'A06O',0,'Y321',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSandStorm.blp",ST(i*4+2,"voodoo"),'A0H0',0,'Y322',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPoisonSting.blp",null,'A0FA','QP16','Y323',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNEarthquake.blp",ST(i*4+4,"lightningshield"),'A06R','A1B4','Y324',null,null,false,"c")
  set i=indexid_Axe-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTN_BerserkerCall.BLP",ST(i*4+1,"dismount"),'A0I6',0,'Y325',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNIncinerate.blp",ST(i*4+2,"creepheal"),'A0S1',0,'Y326',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNStaffOfSanctuary.blp",null,'A0C6','QP17','Y327',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNOrcMeleeUpThree.blp",ST(i*4+4,"chainlightning"),'A0E2','A1MR','Y328',null,null,false,"c")
  set i=indexid_BS-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNShamanMaster.blp",ST(i*4+1,"farsight"),'A44X',0,'Y61A',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBloodrite.blp",ST(i*4+2,"creepheal"),'A44Z',0,'Y61B',null,null,false,"b")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNThirst.blp",null,'A0I8','QP1Z','Y331',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMarkOfFire.blp",ST(i*4+4,"shadowsight"),'A0LH',0,'Y332',null,null,false,"r")
  set i=indexid_Abaddon-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDeathCoil.blp",ST(i*4+1,"townbelloff"),'A0I3',0,'Y333',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNLightningShield.blp",ST(i*4+2,"chainlightning"),'A0MF',0,'Y334',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNIceBlade.blp",null,'A0MG','QP18','Y335',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAnimateDead.blp",ST(i*4+4,"windwalk")+ST(i*4+4,"r17"),'A0NS','A1DA','Y336',null,null,false,"b")
  set i=indexid_Spectre-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAbility_Spectral_Dagger.blp",ST(i*4+1,"tankpilot"),'A0HW',0,'Y337',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNCripplingFear.blp",null,'A0FX','QP19','Y338',"Ranged heroes and Illusions only deal half of the damage",null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNThickFur.blp",null,'A0NA','QP20','Y339',"Dispersion disperses only 8/10/12/14% damage on STR heroes",null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNHaunt.blp",ST(i*4+4,"healingspray")+ST(i*4+4,"healingwave")+ST(i*4+4,"r18"),'A0H9',0,'Y340',null,null,false,"t")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_WD-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAcidBomb.blp",ST(i*4+1,"chainlightning"),'A0NM',0,'Y341',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNBigBadVoodooSpell.blp",ST(i*4+2,"unimmolation"),'A0NE',0,'Y342',null,null,false,"v")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNShadowPact.blp",ST(i*4+3,"renew"),'A0NO',0,'Y343',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDeathWard.blp",ST(i*4+4,"tornado"),'A0NT','A0NX','Y344',null,null,false,"d")
  set i=indexid_OD-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrbOfDeathOn.blp",ST(i*4+1,"arrows")+ST(i*4+1,"range only"),'A0OI',0,'Y345',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_AntiShadow.blp",ST(i*4+2,"chainlightning"),'A0OJ',0,'Y346',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNEssenceAura.blp",ST(i*4+3,"r19"),'A0IF','QP1A','Y347',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_ImpPhaseShift.blp",ST(i*4+4,"blizzard"),'A0OK','A1VW','Y348',null,null,false,"c")
  set i=indexid_WL-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFatalBonds.blp",ST(i*4+1,"autodispelon"),'A0J5',0,'Y349',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_ShadowWordPain.blp",ST(i*4+2,"creepheal"),'A0AS',0,'Y350',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNUnsummonBuilding.blp",ST(i*4+3,"blizzard"),'A06P',0,'Y351',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNInfernal.blp",ST(i*4+4,"inferno")+ST(i*4+4,"r20"),'S008','S00U','Y352',null,null,false,"r")
  set i=indexid_Geomancer-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNEarthbind.blp",ST(i*4+1,"renewon"),'A0NB',0,'Y353',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNDispelMagic.blp",ST(i*4+2,"carrionscarabsoff"),'A0N8',0,'Y354',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNGeostrike.blp",null,'A0N7','QP1B','Y355',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDividedWeStand.blp",null,'A0MW','A27C','Y356',null,null,true,"_")
  set IsAbilityDoesNotWork[i*4+4]=true
  set i=indexid_Dazzle-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNINV_Wand_12.blp",ST(i*4+1,"thunderbolt"),'A0NQ',0,'Y357',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNAnkh.blp",ST(i*4+2,"devourmagic"),'A10L',0,'Y358',null,null,false,"g")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNShadowWave.blp",ST(i*4+3,"darkportal"),'A0OR',0,'Y359',null,null,false,"d")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_ShadowWard.blp",ST(i*4+4,"renewoff"),'A10Q','A1DB','Y360',null,null,false,"w")
  set i=indexid_Pit-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFire.blp",ST(i*4+1,"unavengerform"),'A01I',0,'Y361',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNGrave.blp",ST(i*4+2,"flamestrike"),'A0RA',0,'Y362',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\PassiveButtons\\PASBTNShadeTrueSight.blp",null,'AIcd','QP1C','Y363',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDarkPortal.blp",ST(i*4+4,"divineshield")+ST(i*4+4,"whirlwind"),'A0R0',0,'Y364',null,null,false,"d")
  set i=indexid_Zombie-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDecay.blp",ST(i*4+1,"repair, str bug"),'A15S',0,'Y365',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHeartStopper.BLP",ST(i*4+2,"lumber2gold"),'A0R5',0,'Y366',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNTombstone.blp",ST(i*4+3,"soulpreservation")+ST(i*4+3,"r21"),'A15V',0,'Y367',null,null,false,"t")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNFleshGolem.blp",ST(i*4+4,"metamorphosis")+ST(i*4+4,"melee morph")+ST(i*4+4,"r24"),'QM03',0,'Y368',null,null,false,"f")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_DS-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_Teleport.blp",ST(i*4+1,"repairoff"),'A0QE',0,'Y369',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_Haunting.blp",ST(i*4+2,"autoentangle"),'A0QG',0,'Y370',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSpell_Nature_AstralRecal.blp",ST(i*4+3,"bloodlust"),'A0R7',0,'Y371',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNWallRep.blp",ST(i*4+4,"manaflareon"),'A0QK','A21Q','Y372',null,null,false,"w")
  set i=indexid_Kodo-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNPoisonAbility66.blp",ST(i*4+1,"tranquility"),'A32A',0,'A32T',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNMammothStomp.blp",ST(i*4+2,"curse"),'A32C',0,'A32U',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNDevour.blp",ST(i*4+3,"eattree")+ST(i*4+3,"controlmagic"),'A32E',0,'A32V',null,null,false,"t")
  set IsMultiIconAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDrum.blp",ST(i*4+4,"absorb"),'A32G',0,'A32W',null,null,false,"r")
  set i=indexid_Enigma-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNMalefice.blp",ST(i*4+1,"townbellon"),'A0I7',0,'Y377',null,null,false,"f")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTN_Conversion.BLP",ST(i*4+2,"autoentangleinstant"),'A180',0,'Y378',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNDeathAndDecay.blp",ST(i*4+3,"load")+ST(i*4+3,"deathanddecay"),'A0B1',0,'Y379',null,null,false,"d")
  set IsAbilityDoesNotWork[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNGenericSpellImmunity.blp",ST(i*4+4,"cannibalize"),'A1BX','A30L','Y380',null,null,false,"b")
  set i=indexid_Batrider-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNLocustSwarm.blp",ST(i*4+1,"repairon"),'A1EL',0,'Y381',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFlamebreak.blp",ST(i*4+2,"autoharvestgold"),'A19V',0,'Y382',null,null,false,"r")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFirefly.blp",ST(i*4+3,"metamorphosis")+ST(i*4+3,"range morph")+ST(i*4+3,"r3"),'QM04',0,'Y383',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMagicLariet.blp",ST(i*4+4,"chainlightning"),'A19O',0,'Y384',null,null,false,"f")
  set i=indexid_AA-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNColdFeet.blp",ST(i*4+1,"etherealform"),'A1MG',0,'Y385',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNIceVortex.blp",ST(i*4+2,"replenish"),'A1HS',0,'Y386',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNChillingTouch.blp",ST(i*4+3,"berserk"),'A1HQ',0,'Y387',null,null,false,"g")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNIceBlast.blp",ST(i*4+4,"taunt")+ST(i*4+4,"fanofknives")+ST(i*4+4,"r22"),'A1MI','A2QE','Y388',null,null,false,"t")
  set i=indexid_Slark-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrbOfDarkness.blp",ST(i*4+1,"fanofknives"),'A1IM',0,'Y389',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNQuillSpray.blp",ST(i*4+2,"whirlwind"),'A1J7',0,'Y390',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNScatterRockets.blp",ST(i*4+3,"abuz agi")+ST(i*4+3,"agi bug 1"),'A1HR','QP1F','Y391',"Essence Shift only works on 2/3 the attacks for ranged heroes.",null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNShadowDance.blp",ST(i*4+4,"windwalk")+ST(i*4+4,"ibug"),'A1IN',0,'Y392',null,null,false,"d")
  set i=indexid_TB-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSoulSteal.blp",ST(i*4+1,"replenishoff"),'A2KZ',0,'Y393',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNConjure.blp",ST(i*4+2,"board"),'A0H4',0,'Y394',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNMetamorphosis.blp",ST(i*4+3,"metamorphosis")+ST(i*4+3,"range morph")+ST(i*4+3,"chemicalrage"),'A1RI',0,'Y395',null,null,false,"t")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNSunder.blp",ST(i*4+4,"cripple"),'A07Q',0,'Y396',null,null,false,"r")
  set i=indexid_Leshrak-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNEarthquake.blp",ST(i*4+1,"requestsacrifice"),Switcher(Mode_EB,'QB0F','Z397'),0,Switcher(Mode_EB,'QY0F','Y397'),null,"Split Earth CD changed from 9 to 11",false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNGuldanSkull.blp",ST(i*4+2,"fanofknives"),'A20T',0,'Y398',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNLeshLightStorm.blp",ST(i*4+3,"chainlightning"),'A06V',0,'Y399',null,null,false,"g")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\PASBTNShadeTrueSight.blp",ST(i*4+4,"berserk"),'A21F','A21G','Y400',null,null,false,"v")
  set i=indexid_SD-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNPicture12.blp",ST(i*4+1,"chainlightning"),'A1S8',0,'Y401',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSoulCatcher.blp",ST(i*4+2,"replenishon"),'A1SB',0,'Y402',null,null,false,"c")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNShadowPoison.blp",ST(i*4+3,"fingerofdeath")+ST(i*4+3,"flare"),'A1S4',0,'Y403',null,null,false,"w")
  set IsMultiIconAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNDemonicPurge.blp",ST(i*4+4,"blizzard"),'A343','A34J','Y404',null,null,false,"g")
  set i=indexid_Lich-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNGlacier.blp",ST(i*4+1,"frostnova"),'A07F',0,'Y405',null,null,false,"v")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFrostArmor.blp",ST(i*4+2,"frostarmor"),'A08R',0,'Y406',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNDarkRitual.blp",ST(i*4+3,"innerfire"),'A053',0,'Y407',null,null,false,"d")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNBreathOfFrost.blp",ST(i*4+4,"sleep"),'A05T','A08H','Y408',null,null,false,"c")
  set i=indexid_Banshee-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNCarrionSwarm.blp",ST(i*4+1,"carrionswarm"),Switcher(Mode_EB,'QB06','A078'),0,Switcher(Mode_EB,'QY06','Y409'),null,"Carrion Swarm CD changed from 4 to 6",false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSilence.blp",ST(i*4+2,"silence"),'A07M',0,'Y410',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNKrobWitchcraft.blp",null,0,0,'Y411',null,null,true,"_")
  set IsAbilityDoesNotWork[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNExorcism.blp",ST(i*4+4,"locustswarm"),'A04N',0,'Y412',null,null,false,"x")
  set i=indexid_Lion-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNImpale.blp",ST(i*4+1,"freezingbreath"),'A0X5',0,'Y413',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNHex.blp",ST(i*4+2,"hex"),'A0MN',0,'Y414',null,null,false,"d")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNManaDrain.blp",ST(i*4+3,"drain"),'A02N',0,'Y415',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNCorpseExplode.blp",ST(i*4+4,"chainlightning"),'A095','A09W','Y416',null,null,false,"f")
  set i=indexid_Veno-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp",ST(i*4+1,"magicdefense"),'A173',0,'Y417',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNEnvenomedSpear.blp",ST(i*4+2,"buff placer"),'A0MY','QP1D','Y418',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNVenomWards.blp",ST(i*4+3,"ward"),'A0MS',0,'Y419',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNCorrosiveBreath.blp",ST(i*4+4,"summongrizzly"),'A013','A0A6','Y420',null,null,false,"v")
  set i=indexid_Magnus-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNShockWave.blp",ST(i*4+1,"carrionswarm"),'A02S',0,'Y421',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNEmpower.blp",ST(i*4+2,"innerfire"),'A037',0,'Y422',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSkewer.blp",ST(i*4+3,"blackarrowon"),'A1RD',0,'Y423',null,null,false,"d")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNReversePolarity.blp",ST(i*4+4,"roar"),'A29L','A447','Y424',null,null,false,"v")
  set i=indexid_Visage-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAbsorbMagic.blp",ST(i*4+1,"cripple"),'A08X',0,'Y425',null,null,false,"g")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSoulAssumption.blp",ST(i*4+2,"creepheal"),'A1NA',0,'Y426',null,null,false,"c")
  set IsMultiIconAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNAntiMagicShell.blp",null,'A0VX','QP23','Y427',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNGargoyle.blp",ST(i*4+4,"fanofknives"),'A1NE','A2IG','Y428',null,null,false,"t")
  set i=indexid_Nessaj-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNChaosBolt.blp",ST(i*4+1,"tankpilot"),Switcher(Mode_EB,'QB00','A055'),0,Switcher(Mode_EB,'QY00','Y429'),null,"Chaos Bolt CD changed from 10 to 12",false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNRealityRift.blp",ST(i*4+2,"forceboard"),'A0RW',0,'Y430',null,null,false,"e")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNCriticalStrikeCK.blp",null,'A03N','QP1E','Y431',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNPhantasm.blp",ST(i*4+4,"mirrorimage"),'A03O',0,'Y432',null,null,false,"t")
  set i=indexid_Wyvern-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNArcticSiege.blp",ST(i*4+1,"stomp")+ST(i*4+1,"range morph")+ST(i*4+1,"r44")+ST(i*4+1,"metamorphosis"),'A332',0,'Y437',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNSplinterBlast.blp",ST(i*4+2,"unstoneform"),'A2LA',0,'Y438',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNColdEmbrace.blp",ST(i*4+3,"townbellon"),'A2LB',0,'Y439',null,null,false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNWintersCurse.blp",ST(i*4+4,"unwindwalk"),'A0Z0',0,'Y440',null,null,false,"w")
  set i=indexid_Zet-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNPurge.blp",ST(i*4+1,"unravenform"),'A2M1',0,'Y433',null,null,false,"c")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNMagneticField.blp",ST(i*4+2,"unrobogoblin"),'A2LM',0,'Y434',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNSparkWraith.blp",ST(i*4+3,"undeadbuild"),'A2LL',0,'Y435',null,null,false,"r")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTempestDouble.blp",ST(i*4+4,"metamorphosis")+ST(i*4+4,"summongrizzly"),'A2M0'*0,0,'Y436',null,null,false,"d")
  set IsAbilityDoesNotWork[i*4+4]=true
  set i=indexid_Earth-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNBoulderSmash.blp",ST(i*4+1,"cripple"),'A2QM',0,'Y443',null,null,false,"d")
  set IsMultiIconAbility[i*4+1]=true
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNRollingBoulder.blp",ST(i*4+2,"unsubmerge"),'A2TJ',0,'Y444',null,null,false,"d")
  set IsMultiIconAbility[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNScourgeBuild.blp",ST(i*4+3,"unflamingarrows"),'A2QI',0,'Y445',null,null,false,"r")
  set IsMultiIconAbility[i*4+3]=true
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNMagnetize.blp",ST(i*4+4,"summonwareagle"),'A2TI',0,'Y446',null,null,false,"t")
  set IsMultiIconAbility[i*4+4]=true
  set i=indexid_Oracle-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNFortunesEnd.blp",ST(i*4+1,"webon"),'A2QT',0,'Y453',null,null,false,"t")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFatesEdict.blp",ST(i*4+2,"chainlightning"),'A2T5',0,'Y454',null,null,false,"f")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNPurifyingFlames.blp",ST(i*4+3,"avengerform"),Switcher(Mode_EB,'QB0O','A2SG'),0,Switcher(Mode_EB,'QY0O','Y455'),null,"Purifying Flames cooldown increased from 3 to 4",false,"e")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNFalsePromise.blp",ST(i*4+4,"lavamonster"),Switcher(Mode_EB,'QB11','A2TF'),0,Switcher(Mode_EB,'QY0S','Y456'),null,"False Promise cooldown increased to 40/35/30 and duration decreased to 5/6/7",false,"r")
  // utility
  set i=indexid_Crabe-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSoulSteal.blp",ST(i*4+1,"acidbomb"),'A1PH',0,'Y458',null,null,false,"e")
  call CSD(i*4+2,"ReplaceableTextures\\PassiveButtons\\PASBTNBansheeAdept.blp",null,'A33Q','A33R','Y459',null,null,true,"_")
  call CSD(i*4+3,"ReplaceableTextures\\PassiveButtons\\PASBTNEvasion.blp",ST(i*4+3,"magicdefense"),'A34A','QP28','A34B',null,null,false,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNLightningGrapple.blp",ST(i*4+4,"barkskinoff"),'A33U',0,'Y460',null,null,false,"g")
  if (Mode_SD or Mode_MD or Mode_AR)==false then
    set i=indexid_Sieger-1
    call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSunstrike.blp",ST(i*4+1,"request_hero")+ST(i*4+1,"r23"),'Z601',0,'Y601',null,null,false,"t")
    call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFireRocks.blp",ST(i*4+2,"mechanicalcritter"),'Z602',0,'Y602',null,null,false,"d")
    call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNLavaSpawn.blp",ST(i*4+3,"militia"),'Z603',0,'Y603',null,null,false,"f")
    call CSD(i*4+4,null,null,0,0,0,null,null,false,"_")
    set IsAbilityDoesNotWork[i*4+4]=true
    // water invoker
    set i=indexid_Sorcesser-1
    call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNLament.blp",ST(i*4+1,"militiaconvert"),'Z604',0,'Y604',null,null,false,"y")
    call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNManaShield.blp",ST(i*4+2,"windwalk"),'Z605',0,'Y605',null,null,false,"v")
    call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNFreezingBreath.blp",ST(i*4+3,"militiaoff"),'Z606',0,'Y606',null,null,false,"g")
    call CSD(i*4+4,null,null,0,0,0,null,null,false,"_")
    set IsAbilityDoesNotWork[i*4+4]=true
    //wex invoker
    set i=indexid_Invoker-1
    call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNAnimalWarTraining.blp",ST(i*4+1,"militiaunconvert"),'Z607',0,'Y607',null,null,false,"z")
    call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNInvokeTornado.blp",ST(i*4+2,"mindrot"),'Z608',0,'Y608',null,null,false,"x")
    call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNEMP.blp",ST(i*4+3,"monsoon"),'Z609',0,'Y609',null,null,false,"c")
    call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNScatterRockets.blp",ST(i*4+4,"mount"),'Z610',0,'Y610',null,null,false,"b")
  endif
  //FIXLESS
  set i=indexid_Formless-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNTome.blp",ST(i*4+1,"unload"),'A40K','A40S','Y500',null,null,false,"j")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNTomeBrown.blp",ST(i*4+2,"unloadall"),'A40L','A40T','Y501',null,null,false,"k")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNTomeRed.blp",ST(i*4+3,"unloadallcorpses"),'A40M','A40U','Y502',null,null,false,"l")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNTomeOfRetraining.blp",ST(i*4+4,"undeadbuild"),'A40N','A40V','Y503',null,null,false,"i")
  set i=indexid_SpaceOrc-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNDalaranMutant.blp",ST(i*4+1,"lavamonster"),'A0QV',0,'Y614',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNWandOfShadowSight.blp",ST(i*4+2,"carrionscarabs")+ST(i*4+2,"carrionscarabsoff")+ST(i*4+2,"carrionscarabson")+ST(i*4+2,"sun+raisedead"),'A43Y',0,'Y615',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNCarrionScarabs.blp",ST(i*4+3,"carrionscarabs")+ST(i*4+3,"carrionscarabsoff")+ST(i*4+3,"carrionscarabson")+ST(i*4+3,"sun+raisedead"),'A00T',0,'Y616',null,null,false,"w")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNAdaptiveness.blp",null,'A440','QP25','Y617',null,null,true,"_")
  set i=indexid_OgreLord-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNSpellSteal.blp",ST(i*4+1,"soulburn"),'A0EC',0,'Y329',null,null,false,"d")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNAnteUp.blp",ST(i*4+2,"lumber2gold"),'A44U',0,'Y618',null,null,false,"e")
  set IsAbilityDoesNotWork[i*4+2]=true
  call CSD(i*4+3,"ReplaceableTextures\\CommandButtons\\BTNBloodBath.blp",null,'A0LE','QP1Y','Y330',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNChestOfGold.blp",ST(i*4+4,"evileye"),'A44V',0,'Y619',null,null,false,"c")
  set IsAbilityDoesNotWork[i*4+4]=true
  set i=indexid_FireLord-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNWallOfFire.blp",ST(i*4+1,"volcano"),'A451',0,'Y61C',null,null,false,"w")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNFire.blp",ST(i*4+2,"stomp"),'A454',0,'Y61D',null,null,false,"t")
  call CSD(i*4+3,"ReplaceableTextures\\PassiveButtons\\PASBTNImmolation.blp",null,'A45B','QP26','Y61E',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNVolcano.blp",ST(i*4+4,"fanofknives"),'A456',0,'Y61F',null,null,false,"f")
  set i=indexid_Queen-1
  call CSD(i*4+1,"ReplaceableTextures\\CommandButtons\\BTNVitalStrike.blp",ST(i*4+1,"curse"),'A45W',0,'Y61G',null,null,false,"r")
  call CSD(i*4+2,"ReplaceableTextures\\CommandButtons\\BTNArrowShower.blp",ST(i*4+2,"volcano"),'A45X',0,'Y61H',null,null,false,"w")
  call CSD(i*4+3,"ReplaceableTextures\\PassiveButtons\\BTNMortalWounds.blp",null,'A460','QP27','Y61I',null,null,true,"_")
  call CSD(i*4+4,"ReplaceableTextures\\CommandButtons\\BTNHippogriff.blp",ST(i*4+4,"creepthunderclap"),'A461',0,'Y61J',null,null,false,"d")
  set NumberOfHeroes=indexid_Queen
  if Mode_SD or Mode_MD or Mode_AR then
    //call SD_DoesntWork()
    call ExecuteFunc("RollSpellsForInvokerSD")
  endif
endfunction

function S38 takes location l,real d,real a returns location
  return Location(GetLocationX(l)+d*Cos(a*bj_DEGTORAD),GetLocationY(l)+d*Sin(a*bj_DEGTORAD))
endfunction

function S08 takes nothing returns boolean
  local real dx=GetDestructableX(GetFilterDestructable())-.0
  local real dy=GetDestructableY(GetFilterDestructable())-.0
  return(dx*dx+dy*dy<=bj_enumDestructableRadius)
endfunction

function S58 takes player whichPlayer returns force
  set P68=CreateForce()
  call ForceEnumEnemies(P68,whichPlayer,PL8)
  return P68
endfunction

function T48 takes itemtype T78,integer T88 returns nothing
  local group g
  set bj_stockPickedItemType=T78
  set bj_stockPickedItemLevel=T88
  set g=CreateGroup()
  call GroupEnumUnitsOfType(g,"marketplace",PL8)
  call ForGroup(g,function UpdateEachStockBuildingEnum)
  call DestroyGroup(g)
  set g=null
endfunction

function T98 takes nothing returns nothing
  local integer pickedItemId
  local itemtype TD8
  local integer TE8=0
  local integer TF8=0
  local integer T88
  set T88=1
  loop
    if(bj_stockAllowedPermanent[T88])then
      set TF8=TF8+1
      if(GetRandomInt(1,TF8)==1)then
        set TD8=ITEM_TYPE_PERMANENT
        set TE8=T88
      endif
    endif
    if(bj_stockAllowedCharged[T88])then
      set TF8=TF8+1
      if(GetRandomInt(1,TF8)==1)then
        set TD8=ITEM_TYPE_CHARGED
        set TE8=T88
      endif
    endif
    if(bj_stockAllowedArtifact[T88])then
      set TF8=TF8+1
      if(GetRandomInt(1,TF8)==1)then
        set TD8=ITEM_TYPE_ARTIFACT
        set TE8=T88
      endif
    endif
    set T88=T88+1
    exitwhen T88>10
  endloop
  if(TF8==0)then
    set TD8=null
    return
  endif
  call T48(TD8,TE8)
  set TD8=null
endfunction

function TG8 takes nothing returns nothing
  call T98()
  call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INTERVAL,true,function T98)
endfunction

function TK8 takes nothing returns nothing
  local integer i
  local integer j
  local integer h
  local integer v
  local string TM8="abcdefghijklmnopqrstuvwxyz0123456789 -=,."
  local integer array TN8
  local boolean array TO8
  set TO8[0]=true
  set TO8[50]=true
  set TO8[60]=true
  set TO8[70]=true
  set TO8[80]=true
  set TO8[90]=true
  set TO8[100]=true
  set i=0
  set j=0
  loop
    if TO8[j]then
      set j=j+1
    endif
    exitwhen j>=256
    set TN8[j]=i
    set i=i+1
    set j=j+1
  endloop
  set i=0
  loop
    exitwhen i>=12
    set h=R2I(100*GetPlayerHandicap(Player(i)))
    if not TO8[h]then
      set h=TN8[h]
      set v=h/ 6
      set h=h-v*6
      call SetPlayerHandicap(Player(i),1)
      set HCLstring=HCLstring+SubString(TM8,v,v+1)
    endif
    set i=i+1
  endloop
endfunction

function MBSetText takes multiboard mb,integer c,integer r,string s returns nothing
  local multiboarditem mbitem=null
  set mbitem=MultiboardGetItem(mb,r-1,c-1)
  call MultiboardSetItemValue(mbitem,s)
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function MBSetIcon takes multiboard mb,integer c,integer r,string s returns nothing
  local multiboarditem mbitem=null
  set mbitem=MultiboardGetItem(mb,r-1,c-1)
  call MultiboardSetItemIcon(mbitem,s)
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function MBSetStyle takes multiboard mb,integer c,integer r,boolean val,boolean icon returns nothing
  local multiboarditem mbitem=null
  set mbitem=MultiboardGetItem(mb,r-1,c-1)
  call MultiboardSetItemStyle(mbitem,val,icon)
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function MBSetColor takes multiboard mb,integer c,integer r,real red,real g,real b,real a returns nothing
  local multiboarditem mbitem=null
  set mbitem=MultiboardGetItem(mb,r-1,c-1)
  call MultiboardSetItemValueColor(mbitem,PercentTo255(red),PercentTo255(g),PercentTo255(b),PercentTo255(100.-a))
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function MBSetWidth takes multiboard mb,integer c,integer r,real w returns nothing
  local multiboarditem mbitem=null
  set mbitem=MultiboardGetItem(mb,r-1,c-1)
  call MultiboardSetItemWidth(mbitem,w/ 100)
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function DaI_Load takes integer i returns destructable
  if i>16000 then
    return LY[i-16000]
  elseif i>8000 then
    return KY[i-8000]
  else
    return JY[i]
  endif
  return JY[i]
endfunction

function DaI_Clear takes integer i returns nothing
  if i>16000 then
    set LY[i-16000]=null
  elseif i>8000 then
    set KY[i-8000]=null
  else
    set JY[i]=null
  endif
endfunction

function DaI_Save takes destructable d returns integer
  set MY=MY+1
  if MY>24000 then
    set LY[MY-16000]=d
  elseif MY>8000 then
    set KY[MY-8000]=d
  else
    set JY[MY]=d
  endif
  return MY
endfunction

function IsBlocked takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B0BI')>0 or GetUnitAbilityLevel(u,'BNss')>0 or GetUnitAbilityLevel(u,'B0EV')>0
endfunction

function KillGroup takes group g returns nothing
  local integer i=GetHandleId(g)-GroupsFirstHandle
  //call echo("Group killed: "+I2S(GetHandleId(g))+" , trigger h="+I2S(GetHandleId(GetTriggeringTrigger())))
  if i<0 or i>240 then
    set GroupsError=true
  else
    call GroupClear(g)
    set GroupTaken[i]=false
    set GroupsInt=i
  endif
endfunction

function GetAvailableGroup takes nothing returns group
  local integer i=GroupsInt
  loop
    exitwhen i==GroupsInt-1
    if GroupTaken[i]==false then
      set GroupsInt=i+1
      if GroupsInt==240 then
        set GroupsInt=0
      endif
      set GroupTaken[i]=true
      //call echo("Group allocated: "+I2S(GetHandleId(groups[i]))+" , trigger h="+I2S(GetHandleId(GetTriggeringTrigger())))
      return groups[i]
    endif
    set i=i+1
    if i==240 then
      set i=0
    endif
  endloop
  call BJDebugMsg("|c00ff0303Running out of groups!|r This may be not a big glitch but still dangerous. Report it please.")
  return CreateGroup()
endfunction

function GroupsClose takes nothing returns boolean
  local integer Count=0
  local integer i=0
  loop
    exitwhen i==240
    if GroupTaken[i] then
      set Count=Count+1
    endif
    set i=i+1
  endloop
  return false
endfunction

function InitGroups takes nothing returns nothing
  local integer i=0
  set GroupsInt=0
  set groups[i]=CreateGroup()
  set GroupTaken[i]=false
  set i=i+1
  set GroupsFirstHandle=GetHandleId(groups[0])
  loop
    exitwhen i==240
    set groups[i]=CreateGroup()
    set GroupTaken[i]=false
    set i=i+1
  endloop
endfunction

function GetClosestOfGroup takes group g, real x, real y returns unit
  local group g2=GetAvailableGroup()
  local real dist=99999
  local unit u
  local unit closest=null
  local real r=0.
  call GroupAddGroup(g,g2)
  loop
    set u=FirstOfGroup(g2)
    exitwhen u==null
    set r=DistanceBetweenXY(GetUnitX(u),GetUnitY(u),x,y)
    if r < dist then
      set closest=u
      set dist=r
    endif
    call GroupRemoveUnit(g2,u)
  endloop
  set tt_unit1=closest
  call KillGroup(g2)
  set u=null
  set closest=null
  set g2=null
  return tt_unit1
endfunction

function UG8 takes nothing returns nothing
  local integer i=0
  if GameEnded==false and ZN7==false then
    loop
      call DisplayTimedTextToPlayer(Player(i),0,0,120,"|c00ff0303An internal checksum has failed|r")
      call DisplayTimedTextToPlayer(Player(i),0,0,120,"|c00ff0303This might not be a serious glitch, but it is important for me to get it|r")
      set i=i+1
      exitwhen i==12
    endloop
  endif
endfunction

function CleanTrigger takes trigger t returns nothing
  call DisableTrigger(t)
  set IJ=IJ+1
  set QY[IJ]=t
  set UY[IJ]=(TimerGetElapsed(GlobalTimer))+60
  if IJ>8000 then
    call UG8()
  endif
endfunction

function UI8 takes integer i returns nothing
  if i!=IJ then
    set QY[i]=QY[IJ]
    set UY[i]=UY[IJ]
  endif
  set QY[IJ]=null
  set UY[IJ]=0
  set IJ=IJ-1
endfunction

function UJ8 takes nothing returns boolean
  local real UK8=(TimerGetElapsed(GlobalTimer))
  local integer i
  set i=1
  loop
    exitwhen i>IJ
    if UY[i]<UK8 then
      if QY[i]==null or IsTriggerEnabled(QY[i]) then
        call UG8()
      else
        call DestroyTrigger(QY[i])
      endif
      call UI8(i)
    else
      set i=i+1
    endif
  endloop
  return false
endfunction

function UM8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call SaveInteger(HY,GetHandleId(LoadTriggerHandle(HY,h,35)),LoadInteger(HY,h,33),2)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function AddTimedKeyForTrigger takes trigger t,integer UP8,real SB8 returns nothing
  local trigger t2=CreateTrigger()
  call TriggerAddCondition(t2,Condition(function UM8))
  call TriggerRegisterTimerEvent(t2,SB8,false)
  call SaveInteger(HY,GetHandleId(t),UP8,1)
  call SaveTriggerHandle(HY,GetHandleId(t2),35,t)
  call SaveInteger(HY,GetHandleId(t2),33,UP8)
  set t2=null
endfunction

function UQ8 takes unit u returns string
  if u==null then
    return GetObjectName('n09T')
  endif
  return GetObjectName(HeroID[GetUnitPointValue(u)])
endfunction

function UR8 takes integer i returns string
  if i==0 then
    return GetObjectName('n09T')
  endif
  return GetObjectName(HeroID[i])
endfunction

function US8 takes unit u returns string
  if u==null then
    return EmptySlotPath
  endif
  return HeroIcon[LoadInteger(HY,GetPlayerId(GetOwningPlayer(u)),'hHid')]
endfunction

function UT8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call SaveInteger(HY,GetHandleId(LoadUnitHandle(HY,h,14)),LoadInteger(HY,h,33),2)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function AddTimedKeyToUnit takes unit UV8,integer UP8,real SB8 returns nothing
  local trigger t=CreateTrigger()
  call TriggerAddCondition(t,Condition(function UT8))
  call TriggerRegisterTimerEvent(t,SB8,false)
  call SaveInteger(HY,GetHandleId(UV8),UP8,1)
  call SaveUnitHandle(HY,GetHandleId(t),14,UV8)
  call SaveInteger(HY,GetHandleId(t),33,UP8)
  set t=null
endfunction

function AddEffectTargetTimed_clean takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call DestroyEffect(LoadEffectHandle(HY,h,1))
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
endfunction

function AddEffectTargetTimed takes string path, unit u, string where, real dur returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local effect e=AddSpecialEffectTarget(path,u,where)
  call TimerStart(t,dur,false,function AddEffectTargetTimed_clean)
  call SaveEffectHandle(HY,h,1,e)
  set e=null
  set t=null
endfunction

function GetUnitPrimaryAttribute takes unit Hero returns integer
  //1 == int
  //2 == agi
  //3 == str
  local integer x
  local integer id=GetUnitTypeId(Hero)
  if IsUnitType(Hero,UNIT_TYPE_HERO)==false then
    return 0
  endif
  if HeroTypeId[GetPlayerId(GetOwningPlayer(Hero))]!=id then
    set id=HeroTypeId[GetPlayerId(GetOwningPlayer(Hero))]
  endif
  set x=1
  loop
    exitwhen x>AgilityHeroesAmount
    if id==AgiHeroesArray[x]then
      return 2
    endif
    set x=x+1
  endloop
  set x=1
  loop
    exitwhen x>StrHeroesAmount
    if id==StrHeroesArray[x]then
      return 3
    endif
    set x=x+1
  endloop
  set x=1
  loop
    exitwhen x>IntHeroesAmount
    if id==IntHeroesArray[x]then
      return 1
    endif
    set x=x+1
  endloop
  if id=='Eevm' or id=='E02V' or id=='E02W' or id=='E02U' or id=='N02B' or id=='N017' or id=='H08D' or id=='H08C' or id=='H084' or id=='H08B' or id=='N013' or id=='N014' or id=='N015' or id=='E02O' or id=='QTW2' or id=='QTW3' then
    return 2
  endif
  if id=='N01H' or id=='N01T' or id=='N01J' or id=='H600' or id=='H601' or id=='H602' or id=='H00E' or id=='H00G' or id=='H00F' or id=='H07I' or id=='E015' or id=='H0CQ' or id=='H0E3' or id=='H0E4' or id=='H0E5' or id=='U01X' or id=='N0MB' or id=='N0MC' or id=='N0MO' or id=='N0MA'then
    return 3
  endif
  if id=='H06X' or id=='H06Y' or id=='H06W' or id=='H0BC' or id=='O017' or id=='N0M7' or id=='N0MA' or id=='N0MB' or id=='N0MC' or id=='N0MO' then
    return 1
  endif
  return 0
endfunction

function GetHeroHighestStatValue takes unit u returns integer
  local integer int=GetHeroInt(u,true)
  local integer agi=GetHeroAgi(u,true)
  local integer str=GetHeroStr(u,true)
  return IMaxIF(IMaxIF(str,int),agi)
endfunction

function GetHeroMainStatValue takes unit u returns integer
  local integer i=GetUnitPrimaryAttribute(u)
  if i==1 then
    return GetHeroInt(u,true)
  endif
  if i==2 then
    return GetHeroAgi(u,true)
  endif
  if i==3 then
    return GetHeroStr(u,true)
  endif
  return 0
endfunction

function UA8 takes unit whichUnit returns boolean
  return GetWidgetLife(whichUnit)<1 or IsHeroDead[GetPlayerId(GetOwningPlayer(whichUnit))]
endfunction

function SaveUnitModelScale takes integer U38,real U68,integer UL8 returns nothing
  set DJ=DJ+1
  set AJ[DJ]=U68
  set BJ[DJ]=U38
  set CJ[DJ]=UL8
endfunction

function U18 takes unit u returns real
  local integer U38=GetUnitTypeId(u)
  local integer i=1
  loop
    exitwhen i>DJ
    if BJ[i]==U38 or CJ[i]==U38 then
      return AJ[i]
    endif
    set i=i+1
  endloop
  return 1.
endfunction

function SaveUnitWinAnimation takes integer U58,string U28 returns nothing
  set GJ=GJ+1
  set EJ[GJ]=U28
  set FJ[GJ]=U58
endfunction

function V48 takes unit u returns string
  local integer U58=GetUnitTypeId(u)
  local integer i=1
  loop
    exitwhen i>GJ
    if FJ[i]==U58 then
      return EJ[i]
    endif
    set i=i+1
  endloop
  return"stand"
endfunction

function V78 takes unit u returns nothing
  if GetUnitTypeId(u)=='N01I' then
    call SetUnitAnimationByIndex(u,6)
  else
    call SetUnitAnimation(u,V48(u))
  endif
endfunction

function IsSentinel takes player p returns boolean
  return(p==Sentinels[0])or(p==Sentinels[1])or(p==Sentinels[2])or(p==Sentinels[3])or(p==Sentinels[4])or(p==Sentinels[5])
endfunction

function IsScourge takes player p returns boolean
  return(p==Scourges[0])or(p==Scourges[1])or(p==Scourges[2])or(p==Scourges[3])or(p==Scourges[4])or(p==Scourges[5])
endfunction

function IsPlayerBelongToTeams takes player p returns boolean
  return p==Sentinels[1]or p==Sentinels[2]or p==Sentinels[3]or p==Sentinels[4]or p==Sentinels[5]or p==Scourges[1]or p==Scourges[2]or p==Scourges[3]or p==Scourges[4]or p==Scourges[5]
endfunction

function IsPlayerExisted takes player p returns boolean
  return ((GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING or GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT) and GetPlayerController(p)==MAP_CONTROL_USER) or (Mode_Debug and p!=Sentinels[0] and p!=Scourges[0])
endfunction

function IsPlayerLeaver takes player p returns boolean
  return GetPlayerSlotState(p)==PLAYER_SLOT_STATE_LEFT and GetPlayerController(p)==MAP_CONTROL_USER
endfunction

function CountPlayersInForceSub takes nothing returns nothing
  if(IsPlayer(GetEnumPlayer()))then
    set bj_forceCountPlayers=bj_forceCountPlayers+1
  endif
endfunction

function CountPlayersInForce takes force f returns integer
  set bj_forceCountPlayers=0
  call ForForce(f,function CountPlayersInForceSub)
  return bj_forceCountPlayers
endfunction

function VN8 takes nothing returns nothing
  if GetPlayerSlotState(GetEnumPlayer())==PLAYER_SLOT_STATE_PLAYING then
    if GetEnumPlayer()!=Player(13)and GetEnumPlayer()!=Player(14)then
      set bj_forceCountPlayers=bj_forceCountPlayers+1
    endif
  endif
endfunction

function VO8 takes force f returns integer
  set bj_forceCountPlayers=0
  call ForForce(f,function VN8)
  return bj_forceCountPlayers
endfunction


function Id2S takes integer value returns string
  local string charMap = ".................................!.#$%&'()*+,-./0123456789:;<=>.@ABCDEFGHIJKLMNOPQRSTUVWXYZ[.]^_`abcdefghijklmnopqrstuvwxyz{|}~................................................................................................................................."
  local string result = ""
  local integer remainingValue = value
  local integer charValue
  local integer byteno
  
  set byteno = 0
  loop
    set charValue = ModuloInteger(remainingValue, 256)
    set remainingValue = remainingValue / 256
    set result = SubString(charMap, charValue, charValue + 1) + result
    
    set byteno = byteno + 1
    exitwhen byteno == 4
  endloop
  return result
endfunction

function RemoveHeroFromTavernForPlayer takes integer hid,player p returns nothing
  if NoHeroLimitOff then
    call SetPlayerTechMaxAllowed(p,hid,0)
    set b_isHeroPicked[GetUnitPointValueByType(hid)]=true
  endif
endfunction

function TechHeroForAll takes integer hid returns nothing
  call RemoveHeroFromTavernForPlayer(hid,Sentinels[1])
  call RemoveHeroFromTavernForPlayer(hid,Sentinels[2])
  call RemoveHeroFromTavernForPlayer(hid,Sentinels[3])
  call RemoveHeroFromTavernForPlayer(hid,Sentinels[4])
  call RemoveHeroFromTavernForPlayer(hid,Sentinels[5])
  call RemoveHeroFromTavernForPlayer(hid,Scourges[1])
  call RemoveHeroFromTavernForPlayer(hid,Scourges[2])
  call RemoveHeroFromTavernForPlayer(hid,Scourges[3])
  call RemoveHeroFromTavernForPlayer(hid,Scourges[4])
  call RemoveHeroFromTavernForPlayer(hid,Scourges[5])
endfunction

function VR8 takes integer hid returns nothing
  if NoHeroLimitOff then
    call SetPlayerTechMaxAllowed(Sentinels[1],hid,0)
    call SetPlayerTechMaxAllowed(Sentinels[2],hid,0)
    call SetPlayerTechMaxAllowed(Sentinels[3],hid,0)
    call SetPlayerTechMaxAllowed(Sentinels[4],hid,0)
    call SetPlayerTechMaxAllowed(Sentinels[5],hid,0)
    call SetPlayerTechMaxAllowed(Scourges[1],hid,0)
    call SetPlayerTechMaxAllowed(Scourges[2],hid,0)
    call SetPlayerTechMaxAllowed(Scourges[3],hid,0)
    call SetPlayerTechMaxAllowed(Scourges[4],hid,0)
    call SetPlayerTechMaxAllowed(Scourges[5],hid,0)
  endif
endfunction

function VS8 takes player p returns nothing
  local integer i=FirstSentinelHeroIndexid
  local integer k=LastSentinelHeroIndexid
  if NoHeroLimitOff then
    loop
      exitwhen i>k
      call SetPlayerTechMaxAllowed(p,HeroID[i],0)
      set i=i+1
    endloop
    set i=FirstScourgeHeroIndexid
    set k=LastScourgeHeroIndexid
    loop
      exitwhen i>k
      call SetPlayerTechMaxAllowed(p,HeroID[i],0)
      set i=i+1
    endloop
  endif
endfunction

function TechAll takes nothing returns nothing
  call VS8(Sentinels[1])
  call VS8(Sentinels[2])
  call VS8(Sentinels[3])
  call VS8(Sentinels[4])
  call VS8(Sentinels[5])
  call VS8(Scourges[1])
  call VS8(Scourges[2])
  call VS8(Scourges[3])
  call VS8(Scourges[4])
  call VS8(Scourges[5])
endfunction

function FillTaverns takes player p returns nothing
  local integer i=FirstSentinelHeroIndexid
  local integer k=LastSentinelHeroIndexid
  if NoHeroLimitOff then
    loop
      exitwhen i>k
      call SetPlayerTechMaxAllowed(p,HeroID[i],999)
      set i=i+1
    endloop
    set i=FirstScourgeHeroIndexid
    set k=LastScourgeHeroIndexid
    loop
      exitwhen i>k
      call SetPlayerTechMaxAllowed(p,HeroID[i],999)
      set i=i+1
    endloop
  endif
endfunction

function UnTechAll takes nothing returns nothing
  call FillTaverns(Sentinels[1])
  call FillTaverns(Sentinels[2])
  call FillTaverns(Sentinels[3])
  call FillTaverns(Sentinels[4])
  call FillTaverns(Sentinels[5])
  call FillTaverns(Scourges[1])
  call FillTaverns(Scourges[2])
  call FillTaverns(Scourges[3])
  call FillTaverns(Scourges[4])
  call FillTaverns(Scourges[5])
endfunction

function VX8 takes nothing returns nothing
  local integer i
  local integer k
  local integer a=0
  //set ZO=FirstSentinelHeroIndexid
  set i=FirstSentinelHeroIndexid
  set k=LastSentinelHeroIndexid
  loop
    exitwhen i>k
    set a=a+1
    set WO[a]=i
    set i=i+1
  endloop
  set i=FirstScourgeHeroIndexid
  set k=LastScourgeHeroIndexid
  loop
    exitwhen i>k
    set a=a+1
    set WO[a]=i
    set i=i+1
  endloop
  set VO=a
endfunction

function GetSetElement takes nothing returns integer
  local integer VA8=GetRandomInt(FirstSentinelHeroIndexid,VO)
  local integer VB8=WO[VA8]
  set VB8=WO[VA8]
  if(FirstSentinelHeroIndexid==VO)then
    set WO[VA8]=0
    return VB8
  endif
  if(VA8==VO)then
    set VO=VO-1
    return VB8
  endif
  set WO[VA8]=WO[VO]
  set VO=VO-1
  return VB8
endfunction

function IsUnitSilenced takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B01T')>0 or GetUnitAbilityLevel(u,'BNsi')>0 or GetUnitAbilityLevel(u,'B01X')>0 or GetUnitAbilityLevel(u,'BNdo')>0 or GetUnitAbilityLevel(u,'B02M')>0 or GetUnitAbilityLevel(u,'Bhea')>0 or GetUnitAbilityLevel(u,'B07V')>0 or GetUnitAbilityLevel(u,'B0BY')>0 or GetUnitAbilityLevel(u,'B08O')>0 or GetUnitAbilityLevel(u,'B07U')>0 or GetUnitAbilityLevel(u,'B0DL')>0 or GetUnitAbilityLevel(u,'B08V')>0 or GetUnitAbilityLevel(u,'B031')>0 or GetUnitAbilityLevel(u,'B0FT')>0 or GetUnitAbilityLevel(u,'B0FG')>0 or GetUnitAbilityLevel(u,'B450')>0
endfunction

function IsRangedUnitHasOverAS takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and (GetUnitAbilityLevel(u,'A1N3')>0 or GetUnitAbilityLevel(u,'A12Q')==1 or LoDStat_Get(u,"attack")>200)
endfunction

function V38 takes string s returns integer
  if s=="a"then
    return 10
  elseif s=="b"then
    return 11
  elseif s=="c"then
    return 12
  elseif s=="d"then
    return 13
  elseif s=="e"then
    return 14
  elseif s=="f"then
    return 15
  else
    return S2I(s)
  endif
endfunction

function VL8 takes string s returns integer
  return V38(SubString(s,0,1))*16+V38(SubString(s,1,2))
endfunction

function isAintItemAbility takes integer aid returns boolean
  local integer i=1
  loop
    exitwhen i>ItemsAbilitiesMax2
    if aid==ItemsAbilities2[i]then
      return false
    endif
    set i=i+1
  endloop
  return true
endfunction

function V28 takes unit W48 returns integer
  local integer W78=GetUnitTypeId(W48)
  if W78=='e00R' or W78=='u00M' then
    return 1
  elseif W78=='e011' or W78=='u00D' then
    return 2
  elseif W78=='e00S' or W78=='u00N' then
    return 3
  elseif W78=='e019' or W78=='u00T' then
    return 4
  endif
  return 0
endfunction

function isPoisonArrowSkill takes integer id returns boolean
  return id=='A0DY' or id=='A1WB' or id=='A026' or id=='A09V' or id=='AHfa' or id=='A0LZ' or id=='A0OI'
endfunction

function IsDisjointSpell takes integer id returns boolean
  return id=='A0ME' or id=='AEbl'  or id=='AIbk' or id=='QB08' or id=='A01O' or id=='A0FN' or id=='QB07' or id=='A14O'
endfunction

function TextTagWithGold takes player whichPlayer,integer gold returns nothing
  local texttag t
  if gold>0 then
    set t=CreateTextTag()
    call SetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD)+gold)
    call SetTextTagText(t,"+"+I2S(gold),.025)
    call SetTextTagPosUnit(t,udg_Hero[GetPlayerId(whichPlayer)],0)
    call SetTextTagColor(t,255,220,0,255)
    call SetTextTagVelocity(t,0,.03)
    call SetTextTagVisibility(t,GetLocalPlayer()==whichPlayer)
    call SetTextTagFadepoint(t,2)
    call SetTextTagLifespan(t,3)
    call SetTextTagPermanent(t,false)
  endif
  set t=null
endfunction

function GoldForKillingEnemyStructures takes player p, integer gold returns nothing
  call TextTagWithGold(p,gold)
  set ReliableGold[GetPlayerId(p)]=ReliableGold[GetPlayerId(p)]+gold
endfunction

function GoldForKillingEnemyStructuresWrap takes integer team, integer gold returns nothing
  if team==0 then
    call GoldForKillingEnemyStructures(Sentinels[1],gold)
    call GoldForKillingEnemyStructures(Sentinels[2],gold)
    call GoldForKillingEnemyStructures(Sentinels[3],gold)
    call GoldForKillingEnemyStructures(Sentinels[4],gold)
    call GoldForKillingEnemyStructures(Sentinels[5],gold)
  else
    call GoldForKillingEnemyStructures(Scourges[1],gold)
    call GoldForKillingEnemyStructures(Scourges[2],gold)
    call GoldForKillingEnemyStructures(Scourges[3],gold)
    call GoldForKillingEnemyStructures(Scourges[4],gold)
    call GoldForKillingEnemyStructures(Scourges[5],gold)
  endif
endfunction

function RaxKill takes unit u,boolean ranged returns nothing
  local integer gold
  if ranged then
    set gold=100
  else
    set gold=175
  endif
  if IsUnitAlly(GetDyingUnit(),GetOwningPlayer(u))then
    set gold=gold/2
  endif
  if GetOwningPlayer(GetDyingUnit())==Scourges[0]then
    call GoldForKillingEnemyStructuresWrap(0,gold)
  else
    call GoldForKillingEnemyStructuresWrap(1,gold)
  endif
endfunction

function TowerKill takes unit whichUnit,integer Level returns nothing
  local integer gold
  set gold=120+40*Level
  if IsUnitAlly(GetDyingUnit(),GetOwningPlayer(whichUnit))then
    set gold=gold/2
  endif
  if GetOwningPlayer(GetDyingUnit())==Scourges[0]then
    call GoldForKillingEnemyStructuresWrap(0,gold)
  else
    call GoldForKillingEnemyStructuresWrap(1,gold)
  endif
endfunction

function GetRandomHeroByAttr takes player p, integer at returns nothing
  local integer i
  local integer k
  local location spawnLoc
  local integer rnd
  local integer pid=GetPlayerId(p)
  local boolean int=at==1
  local boolean agi=at==2
  local boolean str=at==3
  set HasUsedRandom[pid]=true
  if IsSentinel(p) then
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
  else
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
  endif
  loop
    if int then
      set rnd=GetHeroIndexFromId(IntHeroesArray[GetRandomInt(1,IntHeroesAmount)])
    elseif agi then
      set rnd=GetHeroIndexFromId(AgiHeroesArray[GetRandomInt(1,AgilityHeroesAmount)])
    elseif str then
      set rnd=GetHeroIndexFromId(StrHeroesArray[GetRandomInt(1,StrHeroesAmount)])
    endif
    exitwhen IsHeroIngame[rnd]==false and (MeleeOrRangedRestricted[pid]==0 or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_RANGED_ATTACKER) and MeleeOrRangedRestricted[pid]==2) or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_MELEE_ATTACKER) and MeleeOrRangedRestricted[pid]==1))
  endloop
  if Mode_DU==false then
    call VR8(HeroID[rnd])
    set b_isHeroPicked[rnd]=true
    set IsHeroIngame[rnd]=true
  endif
  call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
  call RemoveLocation(spawnLoc)
  set spawnLoc=null
endfunction

function GetRandomHeroByAttack takes player p, integer class returns nothing
  local integer i
  local integer k
  local location spawnLoc
  local integer rnd=0
  local integer j=0
  
  set HasUsedRandom[GetPlayerId(p)]=true
  if IsSentinel(p) then
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
  else
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
  endif
  loop
    if class==1 then//melee
      set rnd=GetHeroIndexFromId(MeleeHeroesArray[GetRandomInt(1,MeleeHeroesAmount)])
    elseif class==2 then//range
      set rnd=GetHeroIndexFromId(RangeHeroesArray[GetRandomInt(1,RangeHeroesAmount)])
    endif
    exitwhen IsHeroIngame[rnd]==false or j>400
    set j=j+1
  endloop
  if j>400 and IsHeroIngame[rnd] then
    if class==1 then
      call DisplayTimedTextToPlayer(p,0,0,10,"No melee heroes left.")
    elseif class==2 then
      call DisplayTimedTextToPlayer(p,0,0,10,"No range heroes left.")
    endif
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+150)
    set HasUsedRandom[GetPlayerId(p)]=false
  else
    if Mode_DU==false then
      call VR8(HeroID[rnd])
      set b_isHeroPicked[rnd]=true
      set IsHeroIngame[rnd]=true
    endif
    call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
  endif
  call RemoveLocation(spawnLoc)
  set spawnLoc=null
endfunction

function WT8 takes player p returns nothing
  local integer i
  local integer k
  local location spawnLoc
  local integer rnd
  local integer pid=GetPlayerId(p)
  set HasUsedRandom[GetPlayerId(p)]=true
  if IsSentinel(p) then
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_NE)
  else
    set spawnLoc=GetRectCenter(gg_rct_Hero_Creation_UD)
  endif
  loop
    set rnd=GetRandomInt(FirstSentinelHeroIndexid,LastScourgeHeroIndexid)
    exitwhen IsHeroIngame[rnd]==false and (MeleeOrRangedRestricted[pid]==0 or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_RANGED_ATTACKER) and MeleeOrRangedRestricted[pid]==2) or (IsUnitIdType(HeroID[rnd],UNIT_TYPE_MELEE_ATTACKER) and MeleeOrRangedRestricted[pid]==1))
  endloop
  if Mode_DU==false then
    call VR8(HeroID[rnd])
    set b_isHeroPicked[rnd]=true
    set IsHeroIngame[rnd]=true
  endif
  call CreateUnitAtLoc(p,HeroID[rnd],spawnLoc,0)
  call RemoveLocation(spawnLoc)
  set spawnLoc=null
endfunction

function IsBasicCourier takes unit whichUnit returns boolean
  return GetUnitTypeId(whichUnit)=='n00I' or GetUnitTypeId(whichUnit)=='n022' or GetUnitTypeId(whichUnit)=='n021' or GetUnitTypeId(whichUnit)=='n0KY' or GetUnitTypeId(whichUnit)=='n0KZ' or GetUnitTypeId(whichUnit)=='n0LE' or GetUnitTypeId(whichUnit)=='n023' or GetUnitTypeId(whichUnit)=='n024' or GetUnitTypeId(whichUnit)=='n025' or GetUnitTypeId(whichUnit)=='n0L0' or GetUnitTypeId(whichUnit)=='n0L1' or GetUnitTypeId(whichUnit)=='n0M4' or GetUnitTypeId(whichUnit)=='n00M' or GetUnitTypeId(whichUnit)=='n0HV' or GetUnitTypeId(whichUnit)=='n0LS'
endfunction

function IsFlyingCourier takes unit whichUnit returns boolean
  return GetUnitTypeId(whichUnit)=='e01H' or GetUnitTypeId(whichUnit)=='e01Z' or GetUnitTypeId(whichUnit)=='e02R' or GetUnitTypeId(whichUnit)=='e02T' or GetUnitTypeId(whichUnit)=='e02S' or GetUnitTypeId(whichUnit)=='e030'
endfunction

function IsCourier takes unit whichUnit returns boolean
  return IsBasicCourier(whichUnit)or IsFlyingCourier(whichUnit)
endfunction

function IsValidTree takes destructable d returns boolean
  return GetDestructableTypeId(d)=='CTtr' or GetDestructableTypeId(d)=='NTtc' or GetDestructableTypeId(d)=='NTtw' or GetDestructableTypeId(d)=='ATtr' or GetDestructableTypeId(d)=='B002' or GetDestructableTypeId(d)=='B003' or GetDestructableTypeId(d)=='B005' or GetDestructableTypeId(d)=='ITtw' or GetDestructableTypeId(d)=='CTtr'
endfunction

function IsMagicImmune takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_MAGIC_IMMUNE) or GetUnitAbilityLevel(u,'A0S6')>0 or GetUnitAbilityLevel(u,'A179')>0 or GetUnitAbilityLevel(u,'ACmi')>0 or GetUnitAbilityLevel(u,'A0SU')>0 or GetUnitAbilityLevel(u,'B014')>0 or GetUnitAbilityLevel(u,'A0H3')>0 or LoadInteger(HY,GetHandleId(u),4252)==1
endfunction

function WC8 takes unit W38 returns boolean
  return GetUnitAbilityLevel(W38,'A04R')>0 and IsPlayerBelongToTeams(GetOwningPlayer(W38))
endfunction

function IsBuggyFlying takes unit u returns boolean
  return GetUnitTypeId(u)=='H00F' or GetUnitTypeId(u)=='H00E' or GetUnitTypeId(u)=='H00G' or GetUnitTypeId(u)=='O017' or GetUnitTypeId(u)=='N0MA' or GetUnitTypeId(u)=='N0MB' or GetUnitTypeId(u)=='N0MC' or GetUnitTypeId(u)=='N0MO' or GetUnitTypeId(u)=='N0M7'
endfunction

function IsDamageReal takes real d returns boolean
  return 2<d and d<3000
endfunction

function W18 takes nothing returns nothing
  local integer VT8=1
  set PlayerModeTyper=Sentinels[1]
  loop
    exitwhen IsPlayer(PlayerModeTyper)or VT8>5
    set VT8=VT8+1
    set PlayerModeTyper=Sentinels[VT8]
  endloop
  if IsPlayer(PlayerModeTyper)==false then
    set PlayerModeTyper=Scourges[1]
    set VT8=1
    loop
      exitwhen IsPlayer(PlayerModeTyper)or VT8>5
      set VT8=VT8+1
      set PlayerModeTyper=Scourges[VT8]
    endloop
  endif
endfunction

function IsRealHero takes unit Hero returns boolean
  return IsUnitType(Hero,UNIT_TYPE_HERO) and IsUnitIllusion(Hero)==false and GetUnitTypeId(Hero)!='H00M' and GetUnitTypeId(Hero)!='H00Y' and GetUnitTypeId(Hero)!='H07G' and GetUnitTypeId(Hero)!='H0B8' and GetUnitTypeId(udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])!=GetUnitTypeId(Hero)
endfunction

function W28 takes integer U38 returns integer
  local integer i=1
  loop
    exitwhen i>LastScourgeHeroIndexid
    if U38==HeroID[i]then
      return i
    endif
    set i=i+1
  endloop
  return 0
endfunction

function IsDayTime takes nothing returns boolean
  return GetTimeOfDay()>6. and GetTimeOfDay()<18.
endfunction

function RemoveAbilsForUnit takes unit u returns nothing
  local integer i=1
  local integer lvl
  loop
    set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])+GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
    if lvl==0 and (GetUnitAbilityLevel(u,PassivesRealID[i])>0 or GetUnitAbilityLevel(u,PassivesSpellbookID[i])>0 or GetUnitAbilityLevel(u,PassivesBuffID[i])>0) then
      call UnitRemoveAbility(u,PassivesRealID[i])
      call UnitRemoveAbility(u,PassivesSpellbookID[i])
      call UnitRemoveAbility(u,PassivesBuffID[i])
    endif
    set i=i+1
    exitwhen i>PassivesCount
  endloop
endfunction

function RemoveAbilsConst takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer i=1
  local integer lvl
  //call echo("fired")
  if IsDead(u)==false then
    loop
      set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])+GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
      if lvl==0 and (GetUnitAbilityLevel(u,PassivesRealID[i])>0 or GetUnitAbilityLevel(u,PassivesSpellbookID[i])>0 or GetUnitAbilityLevel(u,PassivesBuffID[i])>0) then
        call UnitRemoveAbility(u,PassivesRealID[i])
        call UnitRemoveAbility(u,PassivesSpellbookID[i])
        call UnitRemoveAbility(u,PassivesBuffID[i])
      endif
      set i=i+1
      exitwhen i>PassivesCount
    endloop
  endif
  if LoadBoolean(HY,h,0) or GetTriggerEvalCount(t)>125 or (GetTriggerEvalCount(t)>30 and isMorphedUnit(u)!=LoadBoolean(HY,h,3)) then
    //call echo(I2S(GetTriggerEvalCount(t)))
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
    call TriggerEvaluate(MeleeRangeItemsSwitcher)
  endif
  set TEMPUNIT=u
  set t=null
  set u=null
endfunction

function Wait0SecPlz takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local trigger tt
  local integer hh
  local integer id=GetSpellAbilityId()
  if id=='A0AG' or id=='QM01' or id=='A0BE' or id=='QM00' or id=='QB0K' or id=='ANcr' or id=='QB0L' or id=='A2H0' or id=='QM02' or id=='QM03' or id=='QM04' or id=='A1RI' or id=='A332' or id=='A2M0' or id=='A2H1' then
    set tt=CreateTrigger()
    set hh=GetHandleId(tt)
    call SaveUnitHandle(HY,hh,0,LoadUnitHandle(HY,h,0))
    call SaveInteger(HY,hh,0,id)
    call SaveBoolean(HY,hh,3,isMorphedUnit(LoadUnitHandle(HY,h,0)))
    call TriggerRegisterTimerEvent(tt,0.02,GetTriggerEventId()!=EVENT_UNIT_SPELL_ENDCAST)
    call TriggerAddCondition(tt,Condition(function RemoveAbilsConst))
    call SaveBoolean(HY,hh,0,GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST)
    set tt=null
  endif
  set t=null
endfunction

function GetMorphId takes integer UnitID returns integer
  local integer id=W28(UnitID)
  local string MorphString=I2S(2*id-2)
  local integer l=StringLength(MorphString)
  if UnitID=='N01H' or UnitID=='H600' then
    return 'M500'
  elseif UnitID=='N01T' or UnitID=='H601' then
    return 'M502'
  elseif UnitID=='N01J' or UnitID=='H602' then
    return 'M504'
  elseif UnitID=='H00F' then
    return 'M506'
  elseif UnitID=='H00E' then
    return 'M508'
  elseif UnitID=='H00G' then
    return 'M510'
  elseif UnitID=='O017' then
    return 'M512'
  elseif UnitID=='H06X' then
    return 'M514'
  elseif UnitID=='H06Y' then
    return 'M516'
  elseif UnitID=='H06W' then
    return 'M518'
  elseif UnitID=='N013' then
    return 'M520'
  elseif UnitID=='N014' then
    return 'M522'
  elseif UnitID=='N015' then
    return 'M524'
  elseif UnitID=='E015' then
    return 'M526'
  elseif UnitID=='H07I' then
    return 'M528'
  elseif UnitID=='Eevm' then
    return 'M530'
  elseif UnitID=='E02V' then
    return 'M532'
  elseif UnitID=='E02W' then
    return 'M534'
  elseif UnitID=='E02U' then
    return 'M536'
  elseif UnitID=='H08D' then
    return 'M538'
  elseif UnitID=='H08C' then
    return 'M540'
  elseif UnitID=='H084' then
    return 'M542'
  elseif UnitID=='H08B' then
    return 'M544'
  elseif UnitID=='N017' then
    return 'M546'
  elseif UnitID=='N02B' then
    return 'M548'
  elseif UnitID=='N0MB' then
    return 'M550'
  elseif UnitID=='N0MC' then
    return 'M552'
  elseif UnitID=='N0MO' then
    return 'M554'
  elseif UnitID=='N0MA' then
    return 'M556'
  elseif UnitID=='U01X' then
    return 'M558'
  elseif UnitID=='QTW2' then
    return 'M562'
  elseif UnitID=='QTW3' then
    return 'M564'
  elseif UnitID=='KODO' then
    return 'M566'
  elseif UnitID=='H00U' then
    return 'M186'
  elseif UnitID=='H500' then
    return 'M568'
  elseif UnitID=='H501' then
    return 'M570'
  elseif UnitID=='H502' then
    return 'M572'
  endif
  if id==0 then
    return 0
  endif
  if l==1 then
    set MorphString="M00"+MorphString
  elseif l==2 then
    set MorphString="M0"+MorphString
  elseif l==3 then
    set MorphString="M"+MorphString
  else
    return 0
  endif
  return String2Id(MorphString)
endfunction

function MorphUnit takes unit u returns integer
  //local integer morph = GetMorphId(HeroTypeId[GetPlayerId(GetOwningPlayer(u))])
  local integer morph = GetMorphId(GetUnitTypeId(u))
  
  //call BJDebugMsg("xin: "+Id2String('M106'))
  //call BJDebugMsg("morfid: "+Id2String(morph))
  //call BJDebugMsg(B2S(morph!='M106'))
  
  if morph!='M106'then //prevents the unit from transforming into itself \:3/
    call UnitAddAbility(u,'A04R')//adds marker so the morph ability cant be stolen
    call UnitAddAbility(u,morph)
    call UnitRemoveAbility(u,morph)
    call UnitRemoveAbility(u,'A04R')
  endif
  call RemoveAbilsForUnit(u)
  return morph
endfunction

function UnMorphUnit takes unit u, integer morph returns nothing
  
  //call BJDebugMsg("xin: "+Id2String('M106'))
  //call BJDebugMsg("unmorfid: "+Id2String(morph))
  //call BJDebugMsg(B2S(morph!='M106'))
  
  if morph!='M107'then //prevents the unit from transforming into itself \:3/
    call UnitAddAbility(u,'A04R')//adds marker so the morph ability cant be stolen
    call UnitAddAbility(u,morph)
    call UnitRemoveAbility(u,morph)
    call UnitRemoveAbility(u,'A04R')
  endif
  call RemoveAbilsForUnit(u)
endfunction

function GetHeroExpReward takes unit Hero returns integer
  local integer Level=GetHeroLevel(Hero)
  if Level==1 then
    return 100
  elseif Level==2 then
    return 120
  elseif Level==3 then
    return 160
  elseif Level==4 then
    return 220
  else
    return-200+100*Level
  endif
  return 0
endfunction

function IsObserver takes player p returns boolean
  return udg_ObserverMode and(udg_Observer1==p or udg_Observer2==p)
endfunction

function IsUnitCycloned takes unit u returns boolean
  return GetUnitAbilityLevel(u,'Bcyc')>0 or GetUnitAbilityLevel(u,'Bcy2')>0
endfunction

function IsUnitFamiliar takes integer id returns boolean
  return id=='u014' or id=='u015' or id=='u016' or id=='u01D' or id=='u01E' or id=='u01F'
endfunction

function IsHexed takes unit u returns boolean
  return GetUnitAbilityLevel(u,'BOhx')>0 or GetUnitAbilityLevel(u,'B00H')>0
endfunction

function DamageTarget2 takes unit source,unit target, attacktype at, damagetype dt, real dmg returns nothing
  set IsFakeDamage=true
  call UnitDamageTarget(source,target,dmg,true,true,at,dt,WEAPON_TYPE_WHOKNOWS)
  set IsFakeDamage=false
endfunction

function DamageTarget takes unit Source,unit Target,integer DT,real Damage returns nothing
  if DT==0 then
    return
  endif
  set IsFakeDamage=true
  set FakeDamageType=DT
  if DT==1 then//magic
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_FIRE,WEAPON_TYPE_WHOKNOWS)//magic
  elseif DT==2 then//physical
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)//physic
  elseif DT==3 then//pure
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)//pure
  elseif DT==4 then//??
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_PIERCE,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)//physical
  elseif DT==5 then//mixed
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
  elseif DT==6 then//DHR
    call SetWidgetLife(Target,RMaxBJ(GetWidgetLife(Target)-Damage,1))
    if GetWidgetLife(Target)<2 and GetUnitAbilityLevel(Target,'B07D')==0 then
      call UnitRemoveBuffs(Target,true,true)
      call UnitRemoveAbility(Target,'Aetl')
      call UnitDamageTarget(CreateUnit(GetOwningPlayer(Source),'e00E',0,0,0),Target,100000000.00,true,false,ATTACK_TYPE_MELEE,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    endif
  elseif DT==7 then//zombie amplify - unique?
    if GetUnitAbilityLevel(Target,'Aetl')>0 or GetUnitAbilityLevel(Target,'B01N')>0 then
      call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    else
      call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_UNIVERSAL,WEAPON_TYPE_WHOKNOWS)
    endif
  elseif DT==8 then//universal, magic immune penetrate, resistance affects
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_ENHANCED,WEAPON_TYPE_WHOKNOWS)
  elseif DT==9 then//pure, magic immune penetrate
    call UnitDamageTarget(Source,Target,Damage,true,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_UNIVERSAL,WEAPON_TYPE_WHOKNOWS)
  endif
  set FakeDamageType=0
  set IsFakeDamage=false
endfunction

function DamageTargetWithDelay_Go takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,30)
  local integer XH8=LoadInteger(HY,h,36)
  local real Damage=LoadReal(HY,h,20)
  call DamageTarget(Source,Target,XH8,Damage)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function DamageTarget_Delayed takes unit Source,unit Target,integer DT,real Damage,real delay returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveInteger(HY,h,36,DT)
  call SaveReal(HY,h,20,Damage*1.)
  call TriggerRegisterTimerEvent(t,delay,false)
  call TriggerAddCondition(t,Condition(function DamageTargetWithDelay_Go))
  set t=null
endfunction

function SoundForPlayer takes player whichPlayer,string path returns nothing
  local sound s=CreateSound(path,false,false,false,10,10,"DefaultEAXON")
  if(GetLocalPlayer()==whichPlayer)then
    call StartSound(s)
  endif
  call KillSoundWhenDone(s)
  set s=null
endfunction

function Error takes player p,string txt returns nothing
  local sound s=CreateSoundFromLabel("InterfaceError",false,false,false,10,10)
  if(txt!="")and(txt!=null)then
    if(GetLocalPlayer()==p)then
      call ClearTextMessages()
      call DisplayTimedTextToPlayer(p,.5,-1.,2.,"|cffffcc00"+txt+"|r")
    endif
  endif
  if(GetLocalPlayer()==p)then
    call StartSound(s)
  endif
  call KillSoundWhenDone(s)
  set s=null
endfunction

function ErrorDefault2s takes player p,string txt returns nothing
  local sound s=CreateSoundFromLabel("InterfaceError",false,false,false,10,10)
  if(GetLocalPlayer()==p)then
    if(txt!="")and(txt!=null)then
      call DisplayTimedTextToPlayer(p,0,0,2.,"|cffffcc00"+txt+"|r")
    endif
    call StartSound(s)
  endif
  call KillSoundWhenDone(s)
  set s=null
endfunction




function RunIfTrue takes string f,boolean b returns nothing
  if b and f!="" and f!=null then
    call ExeFunc(f)
  endif
endfunction

function SafeX50 takes real x returns real
  local real dx=GetRectMinX(bj_mapInitialPlayableArea)+50
  if(x<dx)then
    return dx
  endif
  set dx=GetRectMaxX(bj_mapInitialPlayableArea)-50
  if(x>dx)then
    return dx
  endif
  return x
endfunction

function SafeX75 takes real x returns real
  local real dx=GetRectMinX(bj_mapInitialPlayableArea)+75
  if(x<dx)then
    return dx
  endif
  set dx=GetRectMaxX(bj_mapInitialPlayableArea)-75
  if(x>dx)then
    return dx
  endif
  return x
endfunction

function SafeY50 takes real y returns real
  local real dy=GetRectMinY(bj_mapInitialPlayableArea)+50
  if(y<dy)then
    return dy
  endif
  set dy=GetRectMaxY(bj_mapInitialPlayableArea)-50
  if(y>dy)then
    return dy
  endif
  return y
endfunction

function SafeY75 takes real y returns real
  local real dy=GetRectMinY(bj_mapInitialPlayableArea)+75
  if(y<dy)then
    return dy
  endif
  set dy=GetRectMaxY(bj_mapInitialPlayableArea)-75
  if(y>dy)then
    return dy
  endif
  return y
endfunction

function RemoveHero takes unit Hero returns nothing
  call SaveBoolean(HY,(GetHandleId(Hero)),(38),(false))
  call FlushChildHashtable(HY,(GetHandleId(Hero)))
  call RemoveUnit(Hero)
endfunction

function IMinIF takes integer a,integer b returns integer
  if(a<b)then
    return a
  else
    return b
  endif
endfunction

function RMinIF takes real a,real b returns real
  if(a<b)then
    return a
  else
    return b
  endif
endfunction

function RMaxIF takes real a,real b returns real
  if(a<b)then
    return b
  else
    return a
  endif
endfunction

function YK8 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(GetExpiredTimer())
  local unit u=LoadUnitHandle(HY,h,26)
  call SetWidgetLife(u,GetWidgetLife(u)+LoadReal(HY,h,20))
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function YM8 takes unit whichUnit,real Damage returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,20,Damage*1.)
  call SaveUnitHandle(HY,h,26,whichUnit)
  call TimerStart(t,0,false,function YK8)
  set t=null
endfunction

function HealUnitFor takes unit whichUnit,real Damage returns nothing
  local real maxlife=GetUnitState(whichUnit,UNIT_STATE_MAX_LIFE)
  local real curlife=GetWidgetLife(whichUnit)
  if(GetWidgetLife(whichUnit)>0.5)then
    if Damage>(maxlife-curlife)then
      if Damage>=curlife then
        call SetWidgetLife(whichUnit,maxlife)
        call YM8(whichUnit,Damage-(maxlife-curlife))
      else
        call YM8(whichUnit,Damage)
      endif
    else
      call SetWidgetLife(whichUnit,GetWidgetLife(whichUnit)+Damage)
    endif
  endif
endfunction

function DistanceBetweenUnits takes unit Source,unit Target returns real
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  if Source==null or Target==null then
    return I2R(9999999999)
  else
    return SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
  endif
  return 1.
endfunction

function YX8 takes unit Source,location Target returns real
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetLocationX(Target)
  local real TargetY=GetLocationY(Target)
  if Source==null then
    return I2R(9999999999)
  else
    return SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
  endif
  return 1.
endfunction

function CustomSpeed_Moveunit takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local real bonus=I2R(LoadInteger(HY,h,0))
  local integer limit=LoadInteger(HY,h,1)
  local real x
  local real y
  local real dx
  local real dy
  local real angle
  local real ms
  local real d
  local real currentspeed=GetUnitDefaultMoveSpeed(u)+I2R(GetUnitOffsetSpeed(u))
  local real bonusfixed
  local integer ord
  local integer c=LoadInteger(HY,h,-1)+1
  if limit==0 then
    set limit=9999
  endif
  set bonusfixed=RMinIF(currentspeed*(100.0+bonus)/100.0,limit)-GetUnitMoveSpeed(u)
  call SaveInteger(HY,h,-1,c)
  //if ModuloInteger(c,50)==0 then
  //	call echo(R2S(bonusfixed))
  //endif
  call SaveReal(HeroStats,GetHandleId(u),99,R2I(bonusfixed))
  if bonusfixed>0 and IsDead(u)==false then
    set x=GetUnitX(u)
    set y=GetUnitY(u)
    set dx=LoadReal(HY,h,10)
    set dy=LoadReal(HY,h,11)
    set d=DistanceBetweenXY(dx,dy,x,y)
    if LoadBoolean(HeroStats,GetHandleId(u),99)==false then//not triggered
      set ord=GetUnitCurrentOrder(u)
      if (d<100 and d>1) and ord!=851993 and ord!=851972 and ord!=851973 then//not holded, stopped or stunned
        set angle=Atan2(y-dy,x-dx)
        set ms=bonusfixed*ThirstInterval
        call SaveReal(HeroStats,GetHandleId(u),99,R2I(ms/ThirstInterval))
        call SetUnitX(u,SafeX50(x+ms*Cos(angle)))
        call SetUnitY(u,SafeY50(y+ms*Sin(angle)))
      endif
    else
      call SaveBoolean(HeroStats,GetHandleId(u),99,false)
    endif
    call SaveReal(HY,h,10,GetUnitX(u))
    call SaveReal(HY,h,11,GetUnitY(u))
  endif
  set t=null
  set u=null
endfunction

//bonus - %% bonus, limit - max speed

function CustomSpeed takes unit u, integer bonus, integer limit returns nothing
  local timer t
  local integer h
  if HaveSavedHandle(HeroStats,GetHandleId(u),'MVSP')==false then
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,ThirstInterval,true,function CustomSpeed_Moveunit)
    set movespeedactive=movespeedactive+1
    call SaveUnitHandle(HY,h,0,u)
    call SaveReal(HY,h,10,GetUnitX(u))
    call SaveReal(HY,h,11,GetUnitY(u))
    call SaveBoolean(HY,h,100,true)
    call SaveTimerHandle(HeroStats,GetHandleId(u),'MVSP',t)
  else
    set t=LoadTimerHandle(HeroStats,GetHandleId(u),'MVSP')
    set h=GetHandleId(t)
  endif
  if bonus==LoadInteger(HY,h,0) and limit==LoadInteger(HY,h,1) then
    set t=null
    return
  endif
  call SaveInteger(HY,h,1,limit)
  call SaveInteger(HY,h,0,bonus)
  if bonus==0 then
    call PauseTimer(t)
    set movespeedactive=movespeedactive-1
    call SaveReal(HeroStats,GetHandleId(u),99,0)
    call SaveBoolean(HY,h,100,false)
  elseif LoadBoolean(HY,h,100)==false then
    call TimerStart(t,ThirstInterval,true,function CustomSpeed_Moveunit)
    set movespeedactive=movespeedactive+1
    call SaveBoolean(HY,h,100,true)
  endif
  set t=null
endfunction

function UnitRefillMana takes unit whichUnit returns nothing
  call SetUnitState(whichUnit,UNIT_STATE_MANA,GetUnitState(whichUnit,UNIT_STATE_MAX_MANA))
endfunction

function YA8 takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetEnumPlayer(),0,I3,ZJ,HJ)
endfunction

function DisplayTimedTextToForceEx takes force YC8,real SB8,string Y38 returns nothing
  set HJ=Y38
  set ZJ=SB8
  call ForForce(YC8,function YA8)
endfunction

function Y68 takes nothing returns nothing
  if ShowRollNumbers[GetPlayerId(GetEnumPlayer())]then
    call DisplayTimedTextToPlayer(GetEnumPlayer(),0,I3,ZJ,HJ)
  endif
endfunction

function YL8 takes force YC8,real SB8,string Y38 returns nothing
  set HJ=Y38
  set ZJ=SB8
  call ForForce(YC8,function Y68)
endfunction

function Y18 takes unit whichUnit,real Y08 returns nothing
  call SetWidgetLife(whichUnit,GetWidgetLife(whichUnit)+Y08)
endfunction

function Y28 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call DestroyEffect((LoadEffectHandle(HY,h,(32))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger((t))
  set t=null
  return false
endfunction

function Z48 takes string Z78,unit whichUnit,string Z88,real SB8 returns nothing
  local effect fx=AddSpecialEffectTarget(Z78,whichUnit,Z88)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveEffectHandle(HY,h,(32),(fx))
  call TriggerRegisterUnitEvent(t,whichUnit,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function Y28))
  set fx=null
  set t=null
endfunction

function Z98 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call DestroyEffect((LoadEffectHandle(HY,h,(32))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger((t))
  set t=null
  return false
endfunction

function ZD8 takes string Z78,real x,real y,real SB8 returns nothing
  local effect fx=AddSpecialEffect(Z78,x,y)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveEffectHandle(HY,h,(32),(fx))
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function Z98))
  set fx=null
  set t=null
endfunction

function ZE8 takes unit whichUnit,integer ZF8 returns item
  local integer ZG8=0
  local item ZH8
  loop
    exitwhen ZG8==6
    set ZH8=UnitItemInSlot(whichUnit,ZG8)
    if ZH8!=null and GetItemTypeId(ZH8)==ZF8 then
      return ZH8
    endif
    set ZG8=ZG8+1
  endloop
  set ZH8=null
  return null
endfunction

function CleanTimer takes timer t returns nothing
  call PauseTimer(t)
  call FlushChildHashtable(HY,(GetHandleId(t)))
  call DestroyTimer(t)
endfunction

function GetAngleBetweenUnits takes unit a,unit b returns real
  return bj_RADTODEG*Atan2(GetUnitY(b)-GetUnitY(a),GetUnitX(b)-GetUnitX(a))
endfunction

function AngleBetweenXY takes real x1,real y1,real x2,real y2 returns real
  return bj_RADTODEG*Atan2(y2-y1,x2-x1)
endfunction

function ZN8 takes nothing returns nothing
  call DestroyLightning((LoadLightningHandle(HY,(GetHandleId(GetExpiredTimer())),(41))))
endfunction

function ZO8 takes string ZP8,real x1,real y1,real x2,real y2,real r,real g,real b,real a,real SB8 returns nothing
  local timer t=CreateTimer()
  local lightning ZQ8=AddLightning(ZP8,true,x1,y1,x2,y2)
  call SetLightningColor(ZQ8,r,g,b,a)
  call SaveLightningHandle(HY,(GetHandleId(t)),(41),(ZQ8))
  call TimerStart(t,SB8,false,function ZN8)
  set t=null
  set ZQ8=null
endfunction

function TextTagOnUnitEx takes string s,real dur,unit u,real height,real offset,integer r,integer g,integer b,integer a returns nothing
  local texttag tt=CreateTextTag()
  call SetTextTagText(tt,s,height)
  call SetTextTagPosUnit(tt,u,offset)
  call SetTextTagColor(tt,r,g,b,a)
  call SetTextTagVelocity(tt,0,0.0355)
  call SetTextTagFadepoint(tt,2)
  call SetTextTagPermanent(tt,false)
  call SetTextTagLifespan(tt,dur)
  if IsUnitVisible(u,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
    call SetTextTagVisibility(tt,true)
  else
    call SetTextTagVisibility(tt,false)
  endif
  set tt=null
endfunction

function TextTagOnUnit takes string ZS8,real SB8,unit ZT8,real ZV8,integer r,integer g,integer b,integer a returns nothing
  local texttag tt=CreateTextTag()
  call SetTextTagText(tt,ZS8,ZV8)
  call SetTextTagPosUnit(tt,ZT8,64)
  call SetTextTagColor(tt,r,g,b,a)
  call SetTextTagVelocity(tt,0,.0355)
  call SetTextTagFadepoint(tt,2)
  call SetTextTagPermanent(tt,false)
  call SetTextTagLifespan(tt,SB8)
  call SetTextTagVisibility(tt,IsUnitVisible(ZT8,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
  set tt=null
endfunction

function ZW8 takes player p,string ZS8,real SB8,unit ZT8,real ZV8,integer r,integer g,integer b,integer a returns nothing
  local texttag tt=CreateTextTag()
  call SetTextTagText(tt,ZS8,ZV8)
  call SetTextTagPosUnit(tt,ZT8,64)
  call SetTextTagColor(tt,r,g,b,a)
  call SetTextTagVelocity(tt,0,.0355)
  call SetTextTagFadepoint(tt,2)
  call SetTextTagPermanent(tt,false)
  call SetTextTagLifespan(tt,SB8)
  call SetTextTagVisibility(tt,IsPlayerAlly(GetLocalPlayer(),p) or IsObserver(GetLocalPlayer()))
  set tt=null
endfunction

function ReturnTrue takes nothing returns boolean
  return true
endfunction

function TriggerRegisterAnyUnitEvent takes trigger t,playerunitevent pue returns nothing
  local integer i=0
  loop
    call TriggerRegisterPlayerUnitEvent(t,Player(i),pue,Condition(function ReturnTrue))
    set i=i+1
    exitwhen i==16
  endloop
endfunction

function TriggerRegisterHumanUnitEvent takes trigger t,playerunitevent pue returns nothing
  local integer i=1
  loop
    exitwhen i>5
    call TriggerRegisterPlayerUnitEvent(t,Sentinels[i],pue,Condition(function ReturnTrue))
    call TriggerRegisterPlayerUnitEvent(t,Scourges[i],pue,Condition(function ReturnTrue))
    set i=i+1
  endloop
endfunction

function ZC8 takes nothing returns nothing
  if IsValidTree(GetEnumDestructable())and IsDestructableAliveBJ(GetEnumDestructable())then
    set TreesKilled=TreesKilled+1
    call KillDestructable(GetEnumDestructable())
  endif
endfunction

function KillTrees takes real x,real y,real d returns integer
  local rect r=Rect(x-d,y-d,x+d,y+d)
  set TreesKilled=0
  call EnumDestructablesInRect(r,Condition(function ReturnTrue),function ZC8)
  call RemoveRect(r)
  set r=null
  return TreesKilled
endfunction

function IsTerrainPathableFixed takes real x,real y returns boolean
  return( not(IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)))
endfunction

function PlaySoundAtPos takes sound Z18,real x,real y returns nothing
  call SetSoundPosition(Z18,x,y,0)
  call SetSoundVolume(Z18,127)
  set bj_lastPlayedSound=Z18
  if(Z18!=null)then
    call StartSound(Z18)
  endif
endfunction

function TimedReveal_End takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local fogmodifier f=(LoadFogModifierHandle(HY,h,(42)))
  call FogModifierStop(f)
  call DestroyFogModifier(f)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set f=null
  return false
endfunction

function TimedReveal takes player p,real SB8,real x,real y,real r returns nothing
  local trigger t=CreateTrigger()
  local fogmodifier fm=CreateFogModifierRadius(p,FOG_OF_WAR_VISIBLE,x,y,r,true,true)
  call FogModifierStart(fm)
  call SaveFogModifierHandle(HY,(GetHandleId(t)),(42),(fm))
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function TimedReveal_End))
  set fm=null
  set t=null
endfunction

function A88 takes nothing returns nothing
  call PauseUnit(GetEnumUnit(),true)
endfunction

function A98 takes nothing returns boolean
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,16000,Condition(function ReturnTrue))
  call ForGroup(g,function A88)
  call KillGroup(g)
  set g=null
  return false
endfunction

function AD8 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function A98))
  call TriggerEvaluate(t)
  set t=null
endfunction

function FixPassivesPlz takes nothing returns nothing
  local integer pid=GetPlayerId(GetTriggerPlayer())
  local integer i=1
  local integer lvl
  local unit u=udg_Hero[pid]
  if u!=null and IsDead(u)==false then
    loop
      set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])
      if lvl==0 then
        set lvl=GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
      endif
      if lvl==0 and (GetUnitAbilityLevel(u,PassivesRealID[i])>0 or GetUnitAbilityLevel(u,PassivesSpellbookID[i])>0) then
        call UnitRemoveAbility(u,PassivesRealID[i])
        call UnitRemoveAbility(u,PassivesSpellbookID[i])
        call UnitRemoveAbility(u,PassivesBuffID[i])
      endif
      set i=i+1
      exitwhen i>PassivesCount
    endloop
  endif
  set u=null
endfunction

function AH8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target
  local unit Source
  local real AJ8
  local unit Projectile
  local real x
  local real y
  local real TargetX
  local real TargetY
  local real AM8
  local real AN8
  local real AO8
  local real AP8
  local boolean disjointed
  local real lastX
  local real lastY
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if IsDisjointSpell(GetSpellAbilityId()) then
      call SaveBoolean(HY,h,-1,true)
      call SaveReal(HY,h,-1,GetUnitX(GetTriggerUnit()))
      call SaveReal(HY,h,-2,GetUnitY(GetTriggerUnit()))
    endif
  else
    set Target=LoadUnitHandle(HY,h,(30))
    set Source=LoadUnitHandle(HY,h,(43))
    set AJ8=(LoadReal(HY,h,(44)))
    set Projectile=(LoadUnitHandle(HY,h,(45)))
    set x=GetUnitX(Projectile)
    set y=GetUnitY(Projectile)
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
    set AM8=AJ8*.03
    if(LoadBoolean(HY,h,-1))then
      set TargetX=LoadReal(HY,h,-1)
      set TargetY=LoadReal(HY,h,-2)
    endif
    set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
    set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
    set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
    call SetUnitX(Projectile,AO8)
    call SetUnitY(Projectile,AP8)
    call SetUnitFacing(Projectile,AN8)
    if IsDead(Target)then
      call KillUnit(Projectile)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    elseif DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
      call KillUnit(Projectile)
      set tt_unit1=Source
      set tt_unit2=Target
      if LoadBoolean(HY,h,-1)==false then
        if HaveSavedString(HY,h,46) then
          call ExeFunc(LoadStr(HY,h,46))
        endif
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Target=null
  set Source=null
  set Projectile=null
  return false
endfunction

function AddProjectile takes unit Source,unit Target,integer AR8,string AS8,real AJ8, boolean CanBeDisjoined returns trigger
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real AT8=GetUnitFacing(Source)
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function AH8))
  call SaveReal(HY,h,(44),((AJ8)*1.))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveStr(HY,h,(46),(AS8))
  call SaveUnitHandle(HY,h,(43),((Source)))
  call SaveBoolean(HY,h,-1,false)
  if CanBeDisjoined then
    
    call SaveReal(HY,h,-1,0)
    call SaveReal(HY,h,-2,0)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
  endif
  call SaveUnitHandle(HY,h,(45),(CreateUnit(GetOwningPlayer(Source),AR8,SourceX,SourceY,AT8)))
  set AddProjectileTrigger=t
  set t=null
  return AddProjectileTrigger
endfunction

function AU8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real AV8=(LoadReal(HY,h,(49)))
  local real U68=AV8-(AV8-U18(Hero))*Count/ 40
  if Count>40 or IsDead(Hero)then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitScale(Hero,U68,U68,U68)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function AW8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real AX8=(LoadReal(HY,h,(50)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function AU8))
  set h=GetHandleId(t)
  call SaveReal(HY,h,(49),((AX8)*1.))
  call SaveUnitHandle(HY,h,(14),(Hero))
  set t=null
  set Hero=null
  return false
endfunction

function AY8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real AZ8=((LoadReal(HY,h,(51)))-U18(Hero))*Count/ 40
  local real U68=U18(Hero)+AZ8
  if Count>40 or IsDead(Hero)then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitScale(Hero,U68,U68,U68)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function AA8 takes unit Hero,real SB8,real U68 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real AB8=U68*U18(Hero)
  local real AX8=AB8
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,(50),((AX8)*1.))
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function AW8))
  if SB8>3 then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,.025,true)
    call TriggerAddCondition(t,Condition(function AY8))
    set h=GetHandleId(t)
    call SaveReal(HY,h,(51),((AB8)*1.))
    call SaveUnitHandle(HY,h,(14),(Hero))
  else
    call SetUnitScale(Hero,AX8,AX8,AX8)
  endif
  set t=null
endfunction

function AC8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer A38=(LoadInteger(HY,h,(52)))
  if Hero!=null then
    call UnitRemoveAbility(Hero,A38)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function A68 takes unit u,integer A38,real SB8 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(u,A38)
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function AC8))
  call SaveUnitHandle(HY,h,(14),(u))
  call SaveInteger(HY,h,(52),(A38))
  set t=null
endfunction

function DummyProjectileMoving takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,30)
  local unit caster=LoadUnitHandle(HY,h,43)
  local real speed=LoadReal(HY , h , 44)
  local unit projectile=LoadUnitHandle(HY , h , 45)
  local real xp=GetUnitX(projectile)
  local real yp=GetUnitY(projectile)
  local real xt=GetUnitX(target)
  local real yt=GetUnitY(target)
  local real Distance=speed * 0.03
  local real angle=AngleBetweenXY(xp , yp , xt , yt)
  local real dx=xp + Distance * Cos(angle * bj_DEGTORAD)
  local real dy=yp + Distance * Sin(angle * bj_DEGTORAD)
  call SetUnitX(projectile , dx)
  call SetUnitY(projectile , dy)
  call SetUnitFacing(projectile , angle)
  if IsDead(target) then
    call KillUnit(projectile)
    call FlushChildHashtable(HY , h)
    call DestroyTrigger(t)
  elseif DistanceBetweenXY(xt , yt , dx , dy) <= Distance then
    call KillUnit(projectile)
    set TempCaster = caster
    set TempTarget = target
    call ExeFunc(LoadStr(HY , h , 46))
    call FlushChildHashtable(HY , h)
    call DestroyTrigger(t)
  endif
  set t = null
  set target = null
  set projectile = null
  set caster = null
  return false
endfunction

function CreateDummyProjectile takes unit caster,unit target,integer projectile,string callback,real speed returns trigger
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local real face=GetUnitFacing(caster)
  call TriggerRegisterTimerEvent(t , 0.03 , true)
  call TriggerAddCondition(t , Condition(function DummyProjectileMoving))
  call SaveReal(HY , h , 44 , speed)
  //call SaveInteger(HY , h , 30 , SaveUnitAsInteger(target))
  call SaveUnitHandle(HY,h,30,target)
  call SaveStr(HY , h , 46 , callback)
  call SaveUnitHandle(HY,h,43,caster)
  //call SaveInteger(HY , h , 43 , SaveUnitAsInteger(caster))
  call SaveUnitHandle(HY , h , 45 , CreateUnit(GetOwningPlayer(caster) , projectile , x , y , face))
  set TempTrigger = t
  set t = null
  return TempTrigger
endfunction

function A18 takes nothing returns nothing
  set bj_groupCountUnits=bj_groupCountUnits+1
endfunction

function A08 takes group g returns integer
  set bj_groupCountUnits=0
  call ForGroup(g,function A18)
  return bj_groupCountUnits
endfunction

function A58 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local fogmodifier fm=(LoadFogModifierHandle(HY,h,(42)))
  call FogModifierStop(fm)
  call DestroyFogModifier(fm)
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
  set fm=null
endfunction

function A28 takes fogmodifier fm,real SB8 returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call FogModifierStart(fm)
  call SaveFogModifierHandle(HY,h,42,fm)
  call TimerStart(t,SB8,false,function A58)
  set t=null
endfunction

function B48 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer B78=LoadInteger(HY,h,55)
  local destructable d=DaI_Load(B78)
  if d!=null then
    call RemoveDestructable(d)
  endif
  call DaI_Clear(B78)
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set d=null
  set t=null
endfunction

function B88 takes destructable d,real delay returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,delay,false,function B48)
  call SaveInteger(HY,h,55,DaI_Save(d))
  set t=null
endfunction

function BE8 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call SetUnitAnimation(LoadUnitHandle(HY,h,53),"stand")
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function BF8 takes unit u,real SB8 returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,53,u)
  call TimerStart(t,SB8,false,function BE8)
  set t=null
endfunction

function BG8 takes real SB8,boolean BH8,real x,real y,real BI8,real BJ8,real BK8,real BM8,real BN8 returns nothing
  local real BO8
  local real BP8
  local real BQ8
  if(BJ8<=0 or BN8<=0 or BM8<=0)then
    return
  endif
  set BP8=2.*SB8/ BM8
  set BO8=2.*BJ8/ BN8
  set BQ8=BI8/ BJ8
  call TerrainDeformRipple(x,y,BJ8,BK8,R2I(SB8*1000),1,BO8,BP8,BQ8,BH8)
endfunction

function ImitateBountyGain takes player whichPlayer,unit whichUnit,integer gold returns nothing
  local texttag t
  local string s = ""
  local boolean b = GetLocalPlayer()==whichPlayer
  call SetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD)+gold)
  set t=CreateTextTag()
  if GetHandleId(t)>0 then
    call SetTextTagText(t,"+"+I2S(gold),.025)
    call SetTextTagPosUnit(t,whichUnit,-0.4)
    call SetTextTagColor(t,255,220,0,255)
    call SetTextTagVelocity(t,0,.03)
    call SetTextTagVisibility(t,b)
    call SetTextTagFadepoint(t,2)
    call SetTextTagLifespan(t,3)
    call SetTextTagPermanent(t,false)
  else
    call DestroyTextTag(t)
  endif
  if b or IsObserver(whichPlayer) then
    set s = "UI\\Feedback\\GoldCredit\\GoldCredit.mdl"
  endif
  call DestroyEffect(AddSpecialEffectTarget(s,whichUnit,"overhead"))
  set t=null
endfunction

function BS8 takes nothing returns boolean
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call FlushChildHashtable(HY,(GetHandleId((LoadUnitHandle(HY,h,(26))))))
  call ShowUnit(LoadUnitHandle(HY,h,26),false)
  call RemoveUnit(LoadUnitHandle(HY,h,26))
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
  return false
endfunction

function BT8 takes unit u,real d returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,d,false,function BS8)
  call SaveUnitHandle(HY,h,26,u)
  set t=null
endfunction

function BU8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call RemoveUnit((LoadUnitHandle(HY,h,(26))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function BV8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call KillUnit((LoadUnitHandle(HY,h,(26))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function BW8 takes unit u,real d returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,d,false)
  call TriggerAddCondition(t,Condition(function BV8))
  call SaveUnitHandle(HY,h,(26),(u))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,d+.01,false)
  call TriggerAddCondition(t,Condition(function BU8))
  call SaveUnitHandle(HY,h,(26),(u))
  set t=null
endfunction

function BX8 takes sound Z18 returns nothing
  if Z18!=null then
    if SoundsMuted[GetPlayerId(GetLocalPlayer())]==false then
      call StartSound(Z18)
    endif
  endif
endfunction

function BY8 takes sound Z18,player XS8 returns nothing
  if GetLocalPlayer()==XS8 and SoundsMuted[GetPlayerId(XS8)]==false then
    call StartSound(Z18)
  endif
endfunction

function BZ8 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false)!=null
endfunction

function BA8 takes nothing returns nothing
  call BY8(WJ,GetOwningPlayer(GetEnumUnit()))
endfunction

function BB8 takes unit Source,sound Z18,real x,real y,real r returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set WJ=Z18
  call GroupEnumUnitsInRange(g,x,y,r,Condition(function BZ8))
  call GroupRemoveUnit(g,Source)
  call ForGroup(g,function BA8)
  call KillGroup(g)
  set g=null
endfunction

function GetItemSlot takes unit whichUnit,item B38 returns integer
  local integer i=0
  loop
    exitwhen i>5
    if UnitItemInSlot(whichUnit,i)==B38 then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function B68 takes real n1,real n2 returns integer
  if n1/ n2-R2I(n1/ n2)>=.5 then
    return R2I(n1/ n2)+1
  endif
  return R2I(n1/ n2)
endfunction

function BL8 takes player p returns nothing
  if GetLocalPlayer()==p then
    call ClearTextMessages()
  endif
endfunction

function B18 takes unit u,real d returns nothing
  call SetWidgetLife(u,RMaxIF(GetWidgetLife(u)-d,1))
endfunction

function PreloadUnit takes integer B58 returns nothing
  call RemoveUnit(CreateUnit(Player(15),B58,0,0,0))
endfunction

function B28 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,(53)))
  local real SB8=(LoadReal(HY,h,(57)))
  local integer C48=(LoadInteger(HY,h,(58)))
  if GetTriggerEvalCount(t)/ 10>R2I(SB8)then
    call SetUnitVertexColor(u,255,100,255,255)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif IsDead(u)==false then
    call SetUnitVertexColor(u,255,100,255,C48)
  endif
  set t=null
  set u=null
  return false
endfunction

function C78 takes unit u,real SB8,integer C48 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function B28))
  call SaveUnitHandle(HY,h,(53),(u))
  call SaveReal(HY,h,(57),((SB8)*1.))
  call SaveInteger(HY,h,(58),(C48))
  set t=null
endfunction

function DistribGoldToPlayerForUnit takes player C98,integer CD8,unit CE8 returns nothing
  local texttag t=CreateTextTag()
  local string s="UI\\Feedback\\GoldCredit\\GoldCredit.mdl"
  call SetPlayerState(C98,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(C98,PLAYER_STATE_RESOURCE_GOLD)+CD8)
  call SetTextTagText(t,"+"+I2S(CD8),.025)
  call SetTextTagPosUnit(t,CE8,0)
  call SetTextTagColor(t,255,220,0,255)
  call SetTextTagVelocity(t,0,.03)
  if GetLocalPlayer()!=C98 then
    set s=""
  endif
  call SetTextTagVisibility(t,GetLocalPlayer()==C98)
  if GetWidgetLife(CE8)>.5 then
    call DestroyEffect(AddSpecialEffectTarget(s,CE8,"overhead"))
  endif
  call SetTextTagFadepoint(t,2)
  call SetTextTagLifespan(t,3)
  call SetTextTagPermanent(t,false)
  set t=null
endfunction

function CF8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer CG8=(LoadInteger(HY,h,(59)))
  if UnitRemoveAbility(Target,CG8) or GetUnitAbilityLevel(Target,CG8)==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function CH8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer CG8=(LoadInteger(HY,h,(59)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if UnitRemoveAbility(Target,CG8)==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function CF8))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,h,(59),(CG8))
  endif
  set t=null
  set Target=null
  return false
endfunction

function AddTimedAbility takes unit Target,integer CG8,integer Level,real SB8 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Target,CG8)
  call SetUnitAbilityLevel(Target,CG8,Level)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function CH8))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,(59),(CG8))
  set t=null
endfunction

function CJ8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer CG8=(LoadInteger(HY,h,(59)))
  local integer CK8=(LoadInteger(HY,h,(59)))
  call UnitRemoveAbility(Target,CK8)
  if UnitRemoveAbility(Target,CG8) or GetUnitAbilityLevel(Target,CG8)==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function CM8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer aid=(LoadInteger(HY,h,(59)))
  local integer bid=(LoadInteger(HY,h,(60)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call UnitRemoveAbility(Target,bid)
  if UnitRemoveAbility(Target,aid)==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function CJ8))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,h,(59),(aid))
    call SaveInteger(HY,h,(60),(bid))
  endif
  set t=null
  set Target=null
  return false
endfunction

function UnitAddAbilityTimedEx takes unit Target,integer aid,integer lvl,real dur,integer bid returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Target,aid)
  call SetUnitAbilityLevel(Target,aid,lvl)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,dur,false)
  call TriggerAddCondition(t,Condition(function CM8))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,(59),(aid))
  call SaveInteger(HY,h,(60),(bid))
  set t=null
endfunction

function UnitAddAbilityTimedEx_RemoveFix takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,17)
  local integer bid=LoadInteger(HY,h,60)
  local integer aid=LoadInteger(HY,h,59)
  call UnitRemoveAbility(u,aid)
  if UnitRemoveAbility(u,bid) or GetUnitAbilityLevel(u,bid)==0 then
    call RemoveSavedHandle(MHT,GetHandleId(u),0-aid)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set u=null
  return false
endfunction

function UnitAddAbilityTimedEx_Remove takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,17)
  local integer aid=LoadInteger(HY,h,59)
  local integer bid=LoadInteger(HY,h,60)
  if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(u,bid)
    if UnitRemoveAbility(u,aid)==false then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
      call TriggerRegisterTimerEvent(t,1,true)
      call TriggerAddCondition(t,Condition(function UnitAddAbilityTimedEx_RemoveFix))
      call SaveUnitHandle(HY,h,17,(u))
      call SaveInteger(HY,h,(59),(aid))
      call SaveInteger(HY,h,(60),(bid))
    else
      call RemoveSavedHandle(MHT,GetHandleId(u),0-aid)
    endif
  endif
  set t=null
  set u=null
  return false
endfunction

function UnitAddAbilityTimedExF takes unit u,integer aid,integer lvl,real dur,integer bid returns nothing
  local trigger t
  local integer h
  local real cdur
  local real ndur=TimerGetElapsed(GlobalTimer)+dur
  if IsDead(u) then
    return
  endif
  if HaveSavedHandle(MHT,GetHandleId(u),0-aid) then
    set t=LoadTriggerHandle(MHT,GetHandleId(u),0-aid)
    set h=GetHandleId(t)
    call UnitAddAbility2(u,aid)
    call SetUnitAbilityLevel(u,aid,lvl)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call UnitAddAbility2(u,aid)
    call SetUnitAbilityLevel(u,aid,lvl)
    call SaveUnitHandle(HY,h,17,u)
    call SaveInteger(HY,h,59,aid)
    call SaveInteger(HY,h,60,bid)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,0.1,true)
    call TriggerAddCondition(t,Condition(function UnitAddAbilityTimedEx_Remove))
    call SaveTriggerHandle(MHT,GetHandleId(u),0-aid,t)
  endif
  set cdur=LoadReal(HY,h,0)
  if cdur < ndur then
    call SaveReal(HY,h,0,ndur)
  endif
  
  set t=null
endfunction

function CO8 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u1=LoadUnitHandle(HY,h,(61))
  local unit u2=LoadUnitHandle(HY,h,(62))
  local real SB8=(LoadReal(HY,h,(57)))
  local lightning ZQ8=(LoadLightningHandle(HY,h,(41)))
  if I2R(GetTriggerEvalCount(t))*.025>SB8 then
    call DestroyLightning(ZQ8)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call MoveLightning(ZQ8,true,GetUnitX(u1),GetUnitY(u1),GetUnitX(u2),GetUnitY(u2))
  endif
  set t=null
  set u1=null
  set u2=null
  set ZQ8=null
  return false
endfunction

function CR8 takes string ZP8,unit u1,unit u2,real r,real g,real b,real a,real SB8 returns nothing
  local real x1=GetUnitX(u1)
  local real y1=GetUnitY(u1)
  local real x2=GetUnitX(u2)
  local real y2=GetUnitY(u2)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local lightning ZQ8=AddLightning(ZP8,true,x1,y1,x2,y2)
  call SetLightningColor(ZQ8,r,g,b,a)
  call SaveLightningHandle(HY,h,(41),(ZQ8))
  call SaveUnitHandle(HY,h,(61),((u1)))
  call SaveUnitHandle(HY,h,(62),((u2)))
  call SaveReal(HY,h,(57),((SB8)*1.))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function CO8))
  set t=null
  set ZQ8=null
endfunction

function CS8 takes string CT8 returns nothing
  local sound CU8=CreateSound(CT8,false,false,false,10,10,"")
  call SetSoundVolume(CU8,0)
  call StartSound(CU8)
  call KillSoundWhenDone(CU8)
  set CU8=null
endfunction

function IsSpiritBear takes unit Unit returns boolean
  return GetUnitTypeId(Unit)=='n004' or GetUnitTypeId(Unit)=='n018' or GetUnitTypeId(Unit)=='n01C' or GetUnitTypeId(Unit)=='n01G'
endfunction

function CL8 takes player p returns nothing
  local unit Hero=udg_Hero[GetPlayerId(p)]
  local integer i=0
  local item Item
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(Hero,i)
    call SetItemDroppable(Item,false)
    set i=i+1
  endloop
  set Hero=null
  set Item=null
endfunction

function C08 takes player p returns nothing
  local unit Hero=udg_Hero[GetPlayerId(p)]
  local integer i=0
  local item Item
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(Hero,i)
    call SetItemDroppable(Item,true)
    set i=i+1
  endloop
  set Hero=null
  set Item=null
endfunction

function C58 takes unit u returns boolean
  return GetUnitAbilityLevel(u,'Aetl')>0 or GetUnitAbilityLevel(u,'Bcyc')>0 or GetUnitAbilityLevel(u,'Bcy2')>0 or GetUnitAbilityLevel(u,'B01N')>0
endfunction

function IsUnitEntangled takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B0C1')>0 or GetUnitAbilityLevel(u,'BEer')>0 or GetUnitAbilityLevel(u,'Beng')>0 or GetUnitAbilityLevel(u,'Bena')>0 or GetUnitAbilityLevel(u,'B017')>0 or GetUnitAbilityLevel(u,'B078')>0 or GetUnitAbilityLevel(u,'B08F')>0 or GetUnitAbilityLevel(u,'B08E')>0 or GetUnitAbilityLevel(u,'B0ER')>0 or GetUnitAbilityLevel(u,'B0FN')>0
endfunction

function IsUnitInvulnerable takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B02J')>0 or GetUnitAbilityLevel(u,'BUsp')>0 or GetUnitAbilityLevel(u,'Bust')>0 or IsUnitCycloned(u)
endfunction

function SoF_RemoveDisables takes unit u returns nothing
  call UnitRemoveAbility(u,'B0C1')
  call UnitRemoveAbility(u,'BEer')
  call UnitRemoveAbility(u,'Beng')
  call UnitRemoveAbility(u,'Bena')
  call UnitRemoveAbility(u,'B017')
  call UnitRemoveAbility(u,'B078')
  call UnitRemoveAbility(u,'B08F')
  call UnitRemoveAbility(u,'B08E')
  call UnitRemoveAbility(u,'B0ER')
  call UnitRemoveAbility(u,'B0FN')
endfunction

function IsUnitDisabled takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B00H')>0 or GetUnitAbilityLevel(u,'BOhx')>0 or GetUnitAbilityLevel(u,'BPSE')>0 or GetUnitAbilityLevel(u,'B099')>0 or GetUnitAbilityLevel(u,'BSTN')>0 or GetUnitAbilityLevel(u,'B0CF')>0 or GetUnitAbilityLevel(u,'B0BM')>0 or GetUnitAbilityLevel(u,'B06M')>0 or GetUnitAbilityLevel(u,'B07N')>0 or GetUnitAbilityLevel(u,'B08S')>0 or GetUnitAbilityLevel(u,'B00Q')>0 or GetUnitAbilityLevel(u,'B04V')>0 or GetUnitAbilityLevel(u,'B072')>0 or GetUnitAbilityLevel(u,'BUan')>0 or GetUnitAbilityLevel(u,'B095')>0 or GetUnitAbilityLevel(u,'B03I')>0 or GetUnitAbilityLevel(u,'B0AD')>0 or GetUnitAbilityLevel(u,'B0AE')>0 or GetUnitAbilityLevel(u,'B0BE')>0 or GetUnitAbilityLevel(u,'B0BF')>0 or GetUnitAbilityLevel(u,'B008')>0 or GetUnitAbilityLevel(u,'B04B')>0 or GetUnitAbilityLevel(u,'B02F')>0 or GetUnitAbilityLevel(u,'BUsp')>0 or GetUnitAbilityLevel(u,'BUst')>0 or GetUnitAbilityLevel(u,'B0DD')>0 or GetUnitAbilityLevel(u,'B0C2')>0 or GetUnitAbilityLevel(u,'B06S')>0 or GetUnitAbilityLevel(u,'B02S')>0 or  GetUnitAbilityLevel(u,'B07E')>0 or GetUnitAbilityLevel(u,'B00Q')>0 or LoadInteger(HY,GetHandleId(u),4293)==1 or LoadInteger(HY,GetHandleId(u),4303)==1
endfunction

function L88 takes unit u returns boolean
  return IsUnitDisabled(u)or IsUnitEntangled(u)or IsUnitPaused(u)or IsUnitCycloned(u)
endfunction

function SetTime takes integer Minutes,integer Seconds,boolean extraColor returns nothing
  local integer x=0
  loop
    exitwhen x>15
    call SetPlayerState(Player(x),PLAYER_STATE_RESOURCE_LUMBER,Minutes)
    call SetPlayerState(Player(x),PLAYER_STATE_RESOURCE_FOOD_USED,Seconds)
    set x=x+1
  endloop
endfunction

function IsUnitBADWithSpellbooks takes unit u returns boolean
  local integer id=GetUnitTypeId(u)
  return id=='n027' or id=='u014' or id=='u015' or id=='u016' or id=='u01D' or id=='u01E' or id=='u01F' or id=='u017' or id=='u019' or id=='u018' or id=='u01A' or id=='u01B' or id=='u01C'
endfunction

function LI8 takes real x,real y returns location
  local real AO8
  local real AP8
  local integer i=0
  loop
    exitwhen i>40
    set AO8=x+i*20
    set AP8=y+i*20
    if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
      return Location(AO8,AP8)
    endif
    set AO8=x+i*20
    set AP8=y-i*20
    if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
      return Location(AO8,AP8)
    endif
    set AO8=x-i*20
    set AP8=y+i*20
    if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
      return Location(AO8,AP8)
    endif
    set AO8=x-i*20
    set AP8=y-i*20
    if IsPointInRegion(RestrictedRegion,AO8,AP8)==false then
      return Location(AO8,AP8)
    endif
    set i=i+1
  endloop
  return Location(x,y)
endfunction

function GenericCondition_IsDotAInvis takes unit u returns boolean
  return GetUnitAbilityLevel(u,'B068')>0 or GetUnitAbilityLevel(u,'B07T')>0 or GetUnitAbilityLevel(u,'B076')>0 or GetUnitAbilityLevel(u,'BOwk')>0 or GetUnitAbilityLevel(u,'B04R')>0 or GetUnitAbilityLevel(u,'B0A5')>0 or GetUnitAbilityLevel(u,'B01Q')>0 or GetUnitAbilityLevel(u,'B006')>0 or GetUnitAbilityLevel(u,'Binv')>0 or GetUnitAbilityLevel(u,'Apiv')>0 or GetUnitAbilityLevel(u,'A021')>0 or GetUnitAbilityLevel(u,'A0K4')>0 or GetUnitAbilityLevel(u,'A0XB')>0 or GetUnitAbilityLevel(u,'A0Z2')>0 or GetUnitAbilityLevel(u,'A1GA')>0 or GetUnitAbilityLevel(u,'A1HW')>0 or GetUnitAbilityLevel(u,'A1HX')>0 or GetUnitAbilityLevel(u,'A00J')>0 or GetUnitAbilityLevel(u,'B08K')>0 or GetUnitAbilityLevel(u,'B08X')>0 or GetUnitAbilityLevel(u,'B039')>0 or GetUnitAbilityLevel(u,'B00K')>0 or GetUnitAbilityLevel(u,'BHfs')>0 or GetUnitAbilityLevel(u,'A140')>0 or GetUnitAbilityLevel(u,'B021')>0 or GetUnitAbilityLevel(u,'A0ZD')>0 or GetUnitAbilityLevel(u,'A0KT')>0
endfunction

function IsUnitSpiritBear takes unit whichUnit returns boolean
  local integer LM8=GetUnitTypeId(whichUnit)
  return LM8=='n004' or LM8=='n01G' or LM8=='n01C' or LM8=='n018' or LM8=='e00K' or LM8=='e00I' or LM8=='e00L' or LM8=='e01J'
endfunction

function AliveNonBuildOrMarker takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(u,'A04R')==0 and IsDead(u)==false
endfunction

function LO8 takes nothing returns boolean
  return AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function IsNonAncient takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(u)
endfunction

function LP8 takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LR8 takes nothing returns boolean
  return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LS8 takes nothing returns boolean
  return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LT8 takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1)))!=null
endfunction

function DefaultEnemyFilter takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LV8 takes nothing returns boolean
  return(((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and( AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)))!=null
endfunction

function LW8 takes nothing returns boolean
  return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function NonImmuneEnemyFilter takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and (AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function NonImmuneVisibleEnemyFilter takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LZ8 takes nothing returns boolean
  return(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LA8 takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LB8 takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))!=null
endfunction

function LC8 takes nothing returns boolean
  return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false)!=null
endfunction

function L38 takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit())))!=null
endfunction

function L68 takes nothing returns boolean
  return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function LL8 takes nothing returns boolean
  return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and IsPlayerBelongToTeams(GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function L18 takes nothing returns boolean
  return(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function L08 takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function L58 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function L28 takes nothing returns boolean
  return((IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) or GetOwningPlayer(GetFilterUnit())==Sentinels[0]or GetOwningPlayer(GetFilterUnit())==Scourges[0])and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D49 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D79 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D89 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function D99 takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DD9 takes nothing returns boolean
  return((GenericCondition_IsDotAInvis(GetFilterUnit())==false or IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))==true) and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DE9 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function DF9 takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DG9 takes nothing returns boolean
  return(((AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())))!=null
endfunction

function DH9 takes nothing returns boolean
  return(AliveNonBuildOrMarker(GetFilterUnit()))!=null
endfunction

function DI9 takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and (AliveNonBuildOrMarker(GetFilterUnit())) and IsNonAncient(GetFilterUnit()))!=null
endfunction

function Juggernaut_Omnislash_Filter takes nothing returns boolean
  return(((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1)))and GetUnitTypeId(GetFilterUnit())!='n0F5')!=null
endfunction

function DK9 takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and((AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1)))!=null
endfunction

function DN9 takes nothing returns boolean
  return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and V28(GetFilterUnit())>0
endfunction

function IsPurge takes integer id returns boolean
  return id=='AIpg' or id=='A1SA' or id=='A2T2' or id=='A2TN' or id=='A02V' or id=='ACpu' or id=='A18D' or id=='A1OU' or id=='AIcy'
endfunction

function StunTarget_GetId takes real dur returns integer
  if dur < 0.5 then
    return stuns[0]
  elseif dur < 0.9 then
    return stuns[1]
  elseif dur < 1.3 then
    return stuns[2]
  elseif dur < 1.7 then
    return stuns[3]
  elseif dur < 2.1 then
    return stuns[4]
  elseif dur < 2.5 then
    return stuns[5]
  elseif dur < 2.9 then
    return stuns[6]
  elseif dur < 3.3 then
    return stuns[7]
  elseif dur < 3.7 then
    return stuns[8]
  elseif dur < 4.1 then
    return stuns[9]
  elseif dur < 4.5 then
    return stuns[10]
  elseif dur < 4.9 then
    return stuns[11]
  elseif dur < 5.3 then
    return stuns[12]
  endif
  return 0
endfunction

function StunTarget_GetLvl takes real dur returns integer
  set dur=dur*1.0
  if dur < 0.5 then
    return R2I(dur*10)
  elseif dur < 0.9 then
    return R2I((dur-0.4)*10)
  elseif dur < 1.3 then
    return R2I((dur-0.8)*10)
  elseif dur < 1.7 then
    return R2I((dur-1.2)*10)
  elseif dur < 2.1 then
    return R2I((dur-1.6)*10)
  elseif dur < 2.5 then
    return R2I((dur-2.0)*10)
  elseif dur < 2.9 then
    return R2I((dur-2.4)*10)
  elseif dur < 3.3 then
    return R2I((dur-2.8)*10)
  elseif dur < 3.7 then
    return R2I((dur-3.2)*10)
  elseif dur < 4.1 then
    return R2I((dur-3.6)*10)
  elseif dur < 4.5 then
    return R2I((dur-4.0)*10)
  elseif dur < 4.9 then
    return R2I((dur-4.4)*10)
  elseif dur < 5.3 then
    return R2I((dur-4.8)*10)
  endif
  return 0
endfunction

function StunTarget_GetNerfed takes unit u, real dur returns real
  local integer h
  local real newdur
  local integer c
  local real mult
  if IsUnitType(u,UNIT_TYPE_HERO)==false or Mode_EB==false then
    return dur
  endif
  set h=GetHandleId(u)
  set c=LoadInteger(HeroStats,h,32)
  set mult=1
  if TimerGetElapsed(GlobalTimer)-LoadReal(HeroStats,h,32) < 6 and LoadReal(HeroStats,h,32)!=0 then
    if c==1 then
      set mult=0.75
    elseif c==2 then
      set mult=0.5
    else
      set mult=0.25
    endif
    call SaveInteger(HeroStats,h,32,c+1)
  else
    call SaveInteger(HeroStats,h,32,1)
  endif
  call SaveReal(HeroStats,h,32,TimerGetElapsed(GlobalTimer))
  set newdur=R2I(dur*1.0*mult*10)*1.0/10
  return newdur
endfunction

function StunTargetLod takes unit target, real dur returns real
  local unit d
  local integer id
  local integer lvl
  local real realdur=StunTarget_GetNerfed(target,dur)
  if realdur>0 then
    set id=StunTarget_GetId(realdur)
    set lvl=StunTarget_GetLvl(realdur)
    set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(d,id)
    call SetUnitAbilityLevel(d,id,lvl)
    call IssueTargetOrder(d,"thunderbolt",target)
    set d=null
  endif
  return realdur
endfunction

function DS9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,(73))
  local integer Count=GetTriggerEvalCount(t)
  local real y=(Count-13)*(Count-13)
  if Count<26 then
    if IsBuggyFlying(Hero)==false then
      call SetUnitFlyHeight(Hero,375-y,0)
    endif
  else
    call PauseUnit(Hero,false)
    if IsBuggyFlying(Hero)==false then
      call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
    endif
    call DamageTarget((LoadUnitHandle(HY,h,2)),Hero,1,(LoadReal(HY,h,(20))))
    call StunTargetLod(Hero,(LoadReal(HY,h,(57))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function DU9 takes unit Hero,unit Source,real SB8,real DV9,real DW9 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call PauseUnit(Hero,true)
  if IsBuggyFlying(Hero)==false then
    call UnitAddAbility(Hero,'Amrf')
    call UnitRemoveAbility(Hero,'Amrf')
  endif
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Impale\\ImpaleHitTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
  call SaveUnitHandle(HY,h,(73),((Hero)))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,(20),((DV9)*1.))
  call SaveReal(HY,h,(57),((SB8)*1.))
  call TriggerRegisterTimerEvent(t,.02/ .52*DW9,true)
  call TriggerAddCondition(t,Condition(function DS9))
  set t=null
endfunction

function DX9 takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false and IsMagicImmune(GetEnumUnit())==false and((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),((4253))))==1)==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call DU9(GetEnumUnit(),tt_unit1,TJ,tt_real1,RJ)
  endif
endfunction

function DY9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real DV9=(LoadReal(HY,h,(20)))
  local real SB8=(LoadReal(HY,h,(57)))
  local real x1=(LoadReal(HY,h,(64)))
  local real y1=(LoadReal(HY,h,(65)))
  local real x2=(LoadReal(HY,h,(66)))
  local real y2=(LoadReal(HY,h,(67)))
  local real w=(LoadReal(HY,h,(68)))
  local real DZ9=(LoadReal(HY,h,(44)))
  local real a=Atan2(y2-y1,x2-x1)
  local group g=(LoadGroupHandle(HY,h,(22)))
  local group DA9=GetAvailableGroup()
  local real offset=DZ9*.0625
  local real DC9=(LoadReal(HY,h,(71)))
  local real D39=(LoadReal(HY,h,(72)))
  local real D69=(LoadReal(HY,h,(70)))
  local real DL9=(LoadReal(HY,h,(63)))
  if offset>DistanceBetweenXY(x1,y1,x2,y2)then
    set x1=x2
    set y1=y2
  else
    set x1=x1+offset*Cos(a)
    set y1=y1+offset*Sin(a)
  endif
  set tt_unit1=Source
  set tt_real1=DV9
  set TJ=SB8
  set RJ=DL9
  set DK=g
  call GroupEnumUnitsInRange(DA9,x1,y1,w,Condition(function DefaultEnemyFilter))
  call ForGroup(DA9,function DX9)
  call KillGroup(DA9)
  if DistanceBetweenXY(x1,y1,DC9,D39)>=D69 then
    call SaveReal(HY,h,(71),((x1)*1.))
    call SaveReal(HY,h,(72),((y1)*1.))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\Impale\\ImpaleMissTarget.mdl",x1,y1))
  endif
  call SaveReal(HY,h,(64),((x1)*1.))
  call SaveReal(HY,h,(65),((y1)*1.))
  if x1==x2 and y1==y2 then
    if(LoadBoolean(HY,h,(69))) then
      call KillGroup(g)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set g=null
  set DA9=null
  set Source=null
  set t=null
  return false
endfunction

function ImpaleFactory takes unit Source,unit target,real dmg,real stun,real pause,real x1,real y1,real x2,real y2,real w,group alreadyAffected,boolean D29,real speed returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real YR8=DistanceBetweenXY(x1,y1,x2,y2)
  local integer E49=B68(YR8,ZN)
  local real D69=YR8/ E49
  local group g
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,(20),((dmg)*1.))
  call SaveReal(HY,h,(57),((stun)*1.))
  call SaveReal(HY,h,(63),((pause)*1.))
  call SaveReal(HY,h,(64),((x1)*1.))
  call SaveReal(HY,h,(65),((y1)*1.))
  call SaveReal(HY,h,(66),((x2)*1.))
  call SaveReal(HY,h,(67),((y2)*1.))
  call SaveReal(HY,h,(68),((w)*1.))
  call SaveReal(HY,h,(44),((speed)*1.))
  if alreadyAffected==null then
    set g=GetAvailableGroup()
    if target!=null and IsUnitIllusion(target)==false then
      call GroupAddUnit(g,target)
    endif
    call SaveGroupHandle(HY,h,(22),(g))
    call SaveBoolean(HY,h,(69),(D29))
    set g=null
  else
    call SaveGroupHandle(HY,h,(22),(alreadyAffected))
    call SaveBoolean(HY,h,(69),(D29))
  endif
  call SaveReal(HY,h,(70),((D69)*1.))
  call SaveReal(HY,h,(71),((x1)*1.))
  call SaveReal(HY,h,(72),((y1)*1.))
  call TriggerRegisterTimerEvent(t,.0625,true)
  call TriggerAddCondition(t,Condition(function DY9))
  set t=null
  set g=null
endfunction

function SetNapalmFactory takes unit Source,integer Level,integer E89 returns nothing
  local integer i
  if HZ8[1]==0 then
    return
  endif
  set i=1
  loop
    exitwhen i>10
    call UnitRemoveAbility(Source,HZ8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call UnitRemoveAbility(Source,HA8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call UnitRemoveAbility(Source,HB8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call UnitRemoveAbility(Source,HC8[i])
    set i=i+1
  endloop
  call UnitRemoveAbility(Source,'B0BS')
  if Level==0 and E89==0 then
    call SaveInteger(HY,GetHandleId(Source),281,0)
  endif
  if Level==1 then
    call UnitAddAbility(Source,HZ8[E89])
  elseif Level==2 then
    call UnitAddAbility(Source,HA8[E89])
  elseif Level==3 then
    call UnitAddAbility(Source,HB8[E89])
  elseif Level==4 then
    call UnitAddAbility(Source,HC8[E89])
  endif
endfunction

function AddDispellableBuff takes integer id returns nothing
  set DispellableBuffs_i=DispellableBuffs_i+1
  set DispellableBuffs[DispellableBuffs_i]=id
endfunction

function RemoveDispellableBuffs takes unit u returns nothing
  local integer i=1
  loop
    exitwhen i>DispellableBuffs_i
    call UnitRemoveAbility(u,DispellableBuffs[i])
    set i=i+1
  endloop
endfunction

function AddPositiveBuffToList takes integer id returns nothing
  set PositiveBuffsCount=PositiveBuffsCount+1
  set PositiveBuffs[PositiveBuffsCount]=id
endfunction

function RemovePositiveBuffs takes unit u returns nothing
  local integer i=1
  loop
    exitwhen i>PositiveBuffsCount
    call UnitRemoveAbility(u,PositiveBuffs[i])
    set i=i+1
  endloop
endfunction

function EH9 takes nothing returns boolean
  return false
endfunction

function ShareVisionTic takes nothing returns nothing
  //A1HX shadow dance
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer buffid=LoadInteger(HY,h,0)
  local player p=LoadPlayerHandle(HY,h,1)
  local boolean needchange=LoadBoolean(HY,h,'0NEW')
  local player np=LoadPlayerHandle(HY,h,'0NEW')
  local unit dummy=LoadUnitHandle(HY,h,'DUMM')
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call RemoveUnit(dummy)
    call UnitShareVision(u,p,false)
    call FlushChildHashtable(HY,h)
    call RemoveSavedHandle(MHT,GetHandleId(u),buffid)
    call CleanTrigger(t)
  else
    if GetUnitAbilityLevel(u,buffid)>0 then//buff in
      if needchange then
        call UnitShareVision(u,p,false)
        call SetUnitOwner(dummy,np,false)
        set p=np
        call SavePlayerHandle(HY,h,0,p)
        call SaveBoolean(HY,h,'0NEW',false)
      endif
      if GetUnitAbilityLevel(u,'A1HX')==0 then
        call UnitShareVision(u,p,true)
        call SetUnitPosition(dummy,GetUnitX(u),GetUnitY(u))
      else
        call UnitShareVision(u,p,false)
      endif
    else
      call RemoveUnit(dummy)
      call UnitShareVision(u,p,false)
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(MHT,GetHandleId(u),buffid)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set u=null
  set dummy=null
endfunction

function ShareVision takes unit u,unit toWho,integer buffId returns nothing
  local trigger t=LoadTriggerHandle(MHT,GetHandleId(u),buffId)
  local integer hu=GetHandleId(u)
  local integer h
  local unit dummy
  if t==null then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.02,true)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function ShareVisionTic))
    call SaveUnitHandle(HY,h,0,u)
    call SavePlayerHandle(HY,h,1,GetOwningPlayer(toWho))
    call SaveInteger(HY,h,0,buffId)
    call SaveTriggerHandle(MHT,hu,buffId,t)
    set dummy=CreateUnit(GetOwningPlayer(toWho),'hFFD',GetUnitX(u),GetUnitY(u),0)
    call SaveUnitHandle(HY,h,'DUMM',dummy)
    call UnitAddAbility(dummy,'A30X')
    set dummy=null
  else
    set h=GetHandleId(t)
    if IsPlayerEnemy(GetOwningPlayer(toWho),LoadPlayerHandle(HY,h,1))then
      call SaveBoolean(HY,h,'0NEW',true)
      call SavePlayerHandle(HY,h,'0NEW',GetOwningPlayer(toWho))
    endif
  endif
  set t=null
endfunction

function IsMagicSelfDispell takes integer id returns boolean
  return id=='A1WE' or id=='A0B8' or id=='A063' or id=='A03O' or id=='A0T2' or id=='QB0Q' or id=='A0MQ' or id=='A1B6' or id=='A11F' or id=='A11E' or id=='A0S3' or id=='A11D'  or id=='A11G' or id=='A11H'  or id=='A2LI' or id=='A0NS' or id=='A1DA'
  //mantas, phantasm, mirror image, rage, primal split, BKB, borrowed time
endfunction

function IsMagicDispell takes integer id returns boolean
  return id=='A08V' or id=='QB05' or id=='A2TF' or id=='QB11' or id=='A0MF' or id=='Aprg' or id=='ACpu' or id=='AIpg' or id=='A02E' or id=='A02V' or id=='A0QH' or id=='A0QX' or id=='A18D' or id=='A1OU' or id=='A1SA' or id=='A2T2' or id=='A2TN' or id=='Acyc' or id=='ACcy' or id=='AIcy' or id=='A0XK' or id=='A12L' or id=='A13V' or id=='A1RL'
  //repel, false promise, aphotic shield, purges, cyclones
endfunction

function MagicDispellCheck takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer id=LoadInteger(HY,h,0)
  local integer buffid=LoadInteger(HY,h,1)
  local integer sid
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(u,id)
    call UnitRemoveAbility(u,buffid)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if GetUnitAbilityLevel(u,id)==0 then//ability was removed somehow
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      set sid=GetSpellAbilityId()
      if GetTriggerUnit()==u then//selfcasts
        if IsMagicSelfDispell(sid)then
          call UnitRemoveAbility(u,id)
          call UnitRemoveAbility(u,buffid)
          call FlushChildHashtable(HY,h)
          call CleanTrigger(t)
        endif
      else
        if GetSpellTargetUnit()==u and (IsPlayerAlly(GetOwningPlayer(GetTriggerUnit()),GetOwningPlayer(u)) or IsBlocked(u)==false) and IsMagicDispell(sid) then
          call UnitRemoveAbility(u,id)
          call UnitRemoveAbility(u,buffid)
          call FlushChildHashtable(HY,h)
          call CleanTrigger(t)
        endif
      endif
    endif
  endif
  set t=null
  set u=null
endfunction

//Will take unit and awaits till he'll get under dispellng stuff
//takes Which unit and which ability to remove on dispell
function DetectMagicDispell takes unit u, integer id, integer buffid returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function MagicDispellCheck))
  call SaveUnitHandle(HY,h,0,u)
  call SaveInteger(HY,h,0,id)
  call SaveInteger(HY,h,1,buffid)
  set t=null
endfunction

function FindRealIndexId takes integer indexId returns integer
  if Item_SideShops[indexId]==0 then
    return indexId
  else
    return Item_SideShops[indexId]
  endif
endfunction

function Bottle_IsIndexRune takes integer id returns boolean
  return id==indexid_BottleIllusion or id==indexid_BottleHaste or id==indexid_BottleDD or id==indexid_BottleRegen or id==indexid_BottleInvis or id==indexid_BottleBounty
endfunction

function GetRuneFromBottle takes integer id returns integer
  if id==indexid_BottleIllusion then
    return 'I007'
  elseif id==indexid_BottleHaste then
    return 'I006'
  elseif id==indexid_BottleDD then
    return 'I00K'
  elseif id==indexid_BottleRegen then
    return 'I008'
  elseif id==indexid_BottleInvis then
    return 'I00J'
  elseif id==indexid_BottleBounty then
    return 'I0QA'
  endif
  return -1
endfunction

function EM9 takes unit u,integer id returns boolean
  local integer i
  local item it
  set i=0
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    if it!=null and GetItemTypeId(it)==id then
      set it=null
      return true
    endif
    set i=i+1
  endloop
  set it=null
  return false
endfunction

function GetIndexNoMute takes item it returns integer
  local integer id
  local integer i=1
  if it==null then
    return-2
  endif
  set id=GetItemTypeId(it)
  loop
    exitwhen i>ITC
    if Item_Dummy[i]==id or Item_Real[i]==id then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function FindItemOfTypeEx takes unit u,integer id,item it returns item
  local integer i
  local item cit
  set i=0
  loop
    exitwhen i>5
    set cit=UnitItemInSlot(u,i)
    if cit!=null and cit!=it and GetItemTypeId(cit)==id then
      set cit=null
      return UnitItemInSlot(u,i)
    endif
    set i=i+1
  endloop
  set cit=null
  return null
endfunction

function FindItemOfType takes unit u,integer id returns item
  local integer i
  local item it
  set i=0
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    if it!=null and GetItemTypeId(it)==id then
      set it=null
      return UnitItemInSlot(u,i)
    endif
    set i=i+1
  endloop
  set it=null
  return null
endfunction

function FindItemOfIndexExForPlayer takes player p,unit u,integer indexId,item cit returns item
  local integer i
  local item it
  set i=0
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    if it!=null and it!=cit and GetIndex(it)==indexId and(GetItemPlayer(it)==p or indexId==indexid_ObserverWards or indexId==indexid_SentryWards)then
      set it=null
      return UnitItemInSlot(u,i)
    endif
    set i=i+1
  endloop
  set it=null
  return null
endfunction

function FindItemOfIndexForPlayer takes player p,unit u,integer indexId returns item
  local integer i
  local item it
  set i=0
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    if(it!=null)and GetIndex(it)==indexId and(GetItemPlayer(it)==p or indexId==indexid_ObserverWards or indexId==indexid_SentryWards)then
      set it=null
      return UnitItemInSlot(u,i)
    endif
    set i=i+1
  endloop
  set it=null
  return null
endfunction

function FindItemByIndex takes unit u,integer indexId returns item
  local integer i
  local item it
  set i=0
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    if(it!=null)and GetIndex(it)==indexId then
      set it=null
      return UnitItemInSlot(u,i)
    endif
    set i=i+1
  endloop
  set it=null
  return null
endfunction

function IsUnitHaveAghanim takes unit u returns boolean
  local item it
  local integer i=0
  local integer id
  loop
    set it=UnitItemInSlot(u,i)
    if it!=null then
      set id=GetIndex(it)
      if id==indexid_AghanimBasic and GetItemUserData(it)!=-2 then
        set it=null
        return true
      endif
      if id==indexid_aghanimUpgrader and GetItemUserData(it)!=-2 then
        set it=null
        return true
      endif
    endif
    set i=i+1
    exitwhen i>5
  endloop
  set it=null
  return false
endfunction

function GetAghaIdByBase takes integer id returns integer
  local integer i=1
  local integer k=0
  loop
    if AghaBaseSpellID[i]==id then
      set k=i
    endif
    set i=i+1
    exitwhen k>0 or i>AghaCounter
  endloop
  return k
endfunction

function UndroppableAghaSold_Refund takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local player p=LoadPlayerHandle(HY,h,0)
  local integer gold=LoadInteger(HY,h,0)
  if GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-gold >= 2100 then
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-2100)
  endif
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function UndroppableAghaSold takes player p returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function UndroppableAghaSold_Refund)
  call SavePlayerHandle(HY,GetHandleId(t),0,p)
  call SaveInteger(HY,GetHandleId(t),0,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
  set t=null
endfunction

function SpecialAghanimBonuses takes integer id, unit u, boolean drop returns nothing
  local item it
  if drop==false then
    //if IsUnitHaveAghanim(u)==false then
    if id=='A0CY' then//grow
      call UnitAddAbility2(u,'A2KK')
      call UnitMakeAbilityPermanent(u,true,'A1W0')
      call UnitMakeAbilityPermanent(u,true,'A1W4')
      call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A2KK',false)
      call SetPlayerTechResearched(GetOwningPlayer(u),'R00K',1)
      if GetUnitTypeId(u)=='Ucrl' then
        call UnitAddAbility(u,'A2KB')
        call UnitRemoveAbility(u,'A2KB')
        set HeroTypeId[GetPlayerId(GetOwningPlayer(u))]='U01X'
        call AddUnitAnimationProperties(u,"upgrade",true)
        call SetPlayerTechResearched(GetOwningPlayer(u),'R00K',1)
      endif
    elseif id=='A0DY' then//ench
      call SetPlayerTechResearched(GetOwningPlayer(u),'R00J',1)
    endif
    //endif
  else
    if IsUnitHaveAghanim(u)==false then
      if id=='A0CY' or id=='A0DY' then
        if(IsPlayerLeaver(GetOwningPlayer(u))==false) then
          call Error(GetOwningPlayer(u),"You can't drop last Aghanim if it provides you with bonus attack range.")
          set it=tt_item1
          if it!=null then
            call SetItemUserData(it,-500)
            
            set it=UnitAddItemById(u,Item_Real[indexid_aghanimUpgrader])
            call SetItemPlayer(it,GetOwningPlayer(u),false)
            call SetItemUserData(it,1)
            call UndroppableAghaSold(GetOwningPlayer(u))
          endif
          set it=null
        endif
      endif
    endif
  endif
endfunction

function AddAghanim takes integer k, unit u, integer ultnum returns boolean
  local player p=GetOwningPlayer(u)
  if Mode_RC==false then
    if (AghaUpgradeID[k]=='A2S7' or AghaUpgradeID[k]=='A236') then//guardian angel or calldown?
      if IsRearmPicked(u) then//rearm?
        return false
      endif
    endif
  else
    if AghaUpgradeID[k]=='A236' then//calldown?
      if IsRearmPicked(u) then//rearm?
        return false
      endif
    endif
  endif
  if (isPlayerPickedAbility(p,74) or isPlayerPickedAbility(p,73)) and GetUnitAbilityLevel(u,'A33H')==0 then//rockets/laser
    call UnitAddAbility2(u,'A33H')
    call SetPlayerAbilityAvailable(p,'A33H',false)
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A343') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A343')) then
    set tt_unit1=u
    call ExeFunc("SD_DemonicPurgeAgh_Pickup")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A088') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A088')) then
    set tt_unit1=u
    call ExeFunc("AghaFireblast_Add")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A2E5') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A2E5'))then
    set tt_unit1=u
    call ExeFunc("AghaChakram_Add")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A07Z') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A07Z'))then
    set tt_unit1=u
    call ExeFunc("EyesInTheForest_Add")
  endif
  if AghaUpgradeID[k]>0 then
    call UnitAddAbility2(u,AghaUpgradeID[k])
    call UnitMakeAbilityPermanent(u,true,AghaUpgradedSpellID[k])
    call SetPlayerAbilityAvailable(p,AghaUpgradeID[k],false)
  endif
  call SaveInteger(HeroStats,GetHandleId(u),'AGH0'+ultnum,AghaBaseSpellID[k])
  return true
endfunction

function RemoveAghanim takes integer k, unit u, integer ultnum returns nothing
  local player p=GetOwningPlayer(u)
  if IsUnitHaveAghanim(u) then
    return
  endif
  if GetUnitAbilityLevel(u,'A33H')>0 then
    call UnitRemoveAbility(u,'A33H')
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A343') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A343'))then
    set tt_unit1=u
    call ExeFunc("SD_DemonicPurgeAgh_Drop")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A088') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A088'))then
    set tt_unit1=u
    call ExeFunc("AghaFireblast_Remove")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A2E5') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A2E5'))then
    set tt_unit1=u
    call ExeFunc("AghaChakram_Remove")
  endif
  if ((ultnum==1 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+4]]=='A07Z') or (ultnum==2 and SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]=='A07Z'))then
    set tt_unit1=u
    call ExeFunc("EyesInTheForest_Remove")
  endif
  call UnitRemoveAbility(u,AghaUpgradeID[k])
  call UnitRemoveAbility(u,AghaUpgradedSpellID[k])
  call SaveInteger(HeroStats,GetHandleId(u),'AGH0'+ultnum,0)
endfunction

function HeroAghanim takes unit u,boolean drop returns boolean
  local integer k=GetAghaIdByBase(SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset+4]])
  local integer z=GetAghaIdByBase(SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset+6]])
  local integer aid//ability id
  local boolean b=false
  if IsUnitType(u,UNIT_TYPE_HERO)==false then
    return false
  endif
  if k>0 then
    if drop then
      call RemoveAghanim(k,u,1)
    else
      set b=AddAghanim(k,u,1)
    endif
    call SpecialAghanimBonuses(SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset+4]],u,drop)
  endif
  if (Mode_BO or Mode_MA or k==0) and z>0 then
    if drop then
      call RemoveAghanim(z,u,2)
    else
      set b=AddAghanim(z,u,2) or b
    endif
    call SpecialAghanimBonuses(SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset+6]],u,drop)
  endif
  return b
endfunction

function IsAghanim takes item it returns boolean
  local integer i=GetIndex(it)
  local integer id=GetItemTypeId(it)
  if id==Item_Real[indexid_aghanimUpgrader] or id==Item_Real[indexid_AghanimBasic] then
    return true
  endif
  return false
endfunction

function IsIndexIdConsumable takes integer indexId returns boolean
  return indexId==indexid_FlyingCourier or indexId==indexid_Cheese or indexId==indexid_dustofappearance or indexId==indexid_ClarityPotion or indexId==indexid_HealingSalve or indexId==indexid_Tango or indexId==indexid_ObserverWards or indexId==indexid_SentryWards or indexId==indexid_ScrollOfTownPortal or indexId==indexid_ghostpotion or indexId==indexid_wandofillusions or indexId==indexid_Smoke
endfunction

function IsIndexIdCharged takes integer indexId returns boolean
  return (indexId)==indexid_UrnOfShadows or indexId==indexid_janggo or (indexId)==indexid_DiffusalBlade or (indexId)==indexid_DiffusalBlade_upg or indexId==indexid_bloodstone or indexId==indexid_Aegis or (indexId)==indexid_MagicStick or (indexId)==indexid_MagicWand or indexId==indexid_BladeOfTheReaper 
endfunction

function GetBestCourier takes player p returns unit
  local unit u
  local group g=GetAvailableGroup()
  local unit fitting=null
  local boolean worst=false
  call GroupAddGroup(CouriersSummoned,g)
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    if IsBasicCourier(u) and IsDead(u)==false then
      if GetOwningPlayer(u)==p then
        set fitting=u
        exitwhen true
      elseif GetPlayerAlliance(GetOwningPlayer(u),p,ALLIANCE_SHARED_CONTROL) then
        if fitting==null or worst then
          set fitting=u
        endif
      elseif IsUnitAlly(u,p) then
        if fitting==null then
          set fitting=u
          set worst=true
        endif
      endif
    endif
    call GroupRemoveUnit(g,u)
  endloop
  set u=null
  call KillGroup(g)
  set tt_unit1=fitting
  set fitting=null
  return tt_unit1
endfunction

function MakeFlyingCourier takes item it, player p returns nothing
  local unit u=GetBestCourier(p)
  if u==null then
    return
  endif
  if UnitItemInSlot(u,0)==null or UnitItemInSlot(u,1)==null or UnitItemInSlot(u,2)==null or UnitItemInSlot(u,3)==null or UnitItemInSlot(u,4)==null or UnitItemInSlot(u,5)==null then
    call UnitAddItem(u,it)
  else
    set tt_unit1=u
    call RemoveItem(it)
    call ExecuteFunc("LongCourierUp")
  endif
  set u=null
endfunction

function IsRapierOrGem takes item B38 returns boolean
  return GetIndex(B38)==indexid_DivineRapier or GetIndex(B38)==indexid_DivineRapierFree or GetIndex(B38)==indexid_Gem or GetIndex(B38)==indexid_GemCourier
endfunction

function EW9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer ZF8=(LoadInteger(HY,h,(74)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local boolean consumable=(LoadBoolean(HY,h,(75)))
  local integer charges=(LoadInteger(HY,h,(76)))
  local item newItem=CreateItem(ZF8,x,y)
  call SetItemPlayer(newItem,p,true)
  call SetItemUserData(newItem,0)
  if IsRapierOrGem(newItem) then
    call SetItemInvulnerable(newItem,true)
  endif
  if consumable then
    call SetItemCharges(newItem,charges)
  endif
  if ZF8==Item_Dummy[indexid_RecipeFlyingCourier] then
    call MakeFlyingCourier(newItem,p)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set p=null
  set newItem=null
  return false
endfunction

function DelayedItemCreation takes integer ZF8,real x,real y,player p,boolean consumable,integer charges returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveInteger(HY,h,(74),(ZF8))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SavePlayerHandle(HY,h,(54),(p))
  call SaveBoolean(HY,h,(75),(consumable))
  call SaveInteger(HY,h,(76),(charges))
  call TriggerAddCondition(t,Condition(function EW9))
  call TriggerRegisterTimerEvent(t,0,false)
  set t=null
endfunction

function DestroyItem takes item B38 returns nothing
  call DisableTrigger(t_manipulateitem)
  call RemoveItem(B38)
  call EnableTrigger(t_manipulateitem)
endfunction

function GetEmptyInventorySlots takes unit whichUnit returns integer
  local integer i=0
  local integer n=0
  local integer E29=UnitInventorySize(whichUnit)-1
  loop
    exitwhen i>E29
    if UnitItemInSlot(whichUnit,i)==null then
      set n=n+1
    endif
    set i=i+1
  endloop
  return n
endfunction

function F79 takes item B38 returns integer
  local integer ZF8
  local integer i=1
  if B38==null then
    return-2
  endif
  set ZF8=GetItemTypeId(B38)
  loop
    exitwhen i>ITC
    if Item_Mute[i]==ZF8 then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function MuteToRealId takes item B38 returns integer
  local integer ZF8
  local integer i=1
  if B38==null then
    return-2
  endif
  set ZF8=GetItemTypeId(B38)
  loop
    exitwhen i>ITC
    if Item_Mute[i]==ZF8 then
      return Item_Real[i]
    endif
    set i=i+1
  endloop
  return-1
endfunction

function UnitToIndex takes unit whichUnit returns integer
  local integer unitId
  local integer i=0
  if whichUnit==null then
    return-2
  endif
  set unitId=GetUnitTypeId(whichUnit)
  loop
    exitwhen i>ITC
    if Item_SellerUnit[i]==unitId then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function FD9 takes item FE9 returns string
  if FE9==null then
    return EmptySlotPath
  endif
  return Item_Icon[GetIndex(FE9)]
endfunction

function FG9 takes integer indexId returns integer
  if indexid_Tango==indexId then
    return 4
  endif
  if indexid_ObserverWards==indexId or indexid_SentryWards==indexId or indexid_DivinityPotion==indexId or indexid_ghostpotion==indexId or indexid_wandofillusions==indexId or indexid_dustofappearance==indexId then
    return 2
  endif
  return 1
endfunction

function IsItemTemporary takes item B38 returns boolean
  return GetItemType(B38)==ITEM_TYPE_POWERUP or GetItemType(B38)==ITEM_TYPE_PURCHASABLE or GetItemType(B38)==ITEM_TYPE_MISCELLANEOUS
endfunction

function FI9 takes unit Hero returns real
  local real result
  if IsSentinel(GetOwningPlayer(Hero))then
    set result=GetRectCenterX(gg_rct_Hero_Creation_NE)
  else
    set result=GetRectCenterX(gg_rct_Hero_Creation_UD)
  endif
  return result
endfunction

function FK9 takes unit Hero returns real
  local real result
  if IsSentinel(GetOwningPlayer(Hero))then
    set result=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set result=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  return result
endfunction

function AddItemInSlot takes unit Hero,item Item,integer slot returns nothing
  local real x=FI9(Hero)
  local real y=FK9(Hero)
  local integer i=0
  local boolean array b
  local item ttitem
  call DisableTrigger(t_manipulateitem)
  loop
    exitwhen i>(UnitInventorySize(Hero)-1)
    if UnitItemInSlot(Hero,i)==null and i!=slot then
      set ttitem=CreateItem('I02M',x,y)
      call UnitAddItem(Hero,ttitem)
      set b[i]=true
    else
      set b[i]=false
    endif
    if i==slot then
      call EnableTrigger(t_manipulateitem)
      call UnitAddItem(Hero,Item)
      call DisableTrigger(t_manipulateitem)
    endif
    set i=i+1
  endloop
  set i=0
  loop
    exitwhen i>5
    if b[i] then
      call RemoveItem(UnitItemInSlot(Hero,i))
    endif
    set i=i+1
  endloop
  call EnableTrigger(t_manipulateitem)
  set tt_item1=Item
  set Item=null
  set ttitem=null
endfunction

function AddItemByIdInSlot takes unit Hero,integer FN9,integer FO9 returns item
  local real x=FI9(Hero)
  local real y=FK9(Hero)
  local item Item=CreateItem(FN9,x,y)
  local integer i=0
  local boolean array FP9
  local item FQ9
  call DisableTrigger(t_manipulateitem)
  if FN9>0 then
    loop
      exitwhen i>(UnitInventorySize(Hero)-1)
      if UnitItemInSlot(Hero,i)==null and i!=FO9 then
        set FQ9=CreateItem('I02M',x,y)
        call UnitAddItem(Hero,FQ9)
        set FP9[i]=true
      else
        set FP9[i]=false
      endif
      if i==FO9 then
        call EnableTrigger(t_manipulateitem)
        call UnitAddItem(Hero,Item)
        call DisableTrigger(t_manipulateitem)
      endif
      set i=i+1
    endloop
    set i=0
    loop
      exitwhen i>5
      if FP9[i] then
        call RemoveItem(UnitItemInSlot(Hero,i))
      endif
      set i=i+1
    endloop
  endif
  call EnableTrigger(t_manipulateitem)
  set tt_item1=Item
  set Item=null
  set FQ9=null
  return tt_item1
endfunction

function FR9 takes integer U58,integer r,integer g,integer b returns nothing
  set Tints_C=Tints_C+1
  set Tints_R[Tints_C]=r
  set Tints_G[Tints_C]=g
  set Tints_B[Tints_C]=b
  set Tints_ID[Tints_C]=U58
endfunction


//METADATA TABLE
//Keys data:
//INT 0-2 for R G B
function ApplyFrostColor takes unit u returns nothing
  local integer uid=GetUnitTypeId(u)
  local integer a=255
  if HaveSavedInteger(MHT,GetHandleId(u),'ALPH') then
    set a=LoadInteger(MHT,GetHandleId(u),'ALPH')
  endif
  call SetUnitVertexColor(u,128,192,192,a)
  call SaveInteger(MHT,GetHandleId(u),COLOR+0,128)
  call SaveInteger(MHT,GetHandleId(u),COLOR+1,192)
  call SaveInteger(MHT,GetHandleId(u),COLOR+2,192)
  call SaveInteger(MHT,GetHandleId(u),'ALPH',a)
endfunction

function RestoreTint takes unit u returns nothing
  local integer uid=GetUnitTypeId(u)
  local integer r=255
  local integer g=255
  local integer b=255
  local integer a=255
  if HaveSavedInteger(UMD,uid,0) then
    set r=LoadInteger(UMD,uid,0)
  endif
  if HaveSavedInteger(UMD,uid,1) then
    set g=LoadInteger(UMD,uid,1)
  endif
  if HaveSavedInteger(UMD,uid,2) then
    set b=LoadInteger(UMD,uid,2)
  endif
  if HaveSavedInteger(MHT,GetHandleId(u),'ALPH') then
    set a=LoadInteger(MHT,GetHandleId(u),'ALPH')
  endif
  call SetUnitVertexColor(u,r,g,b,a)
  call SaveInteger(MHT,GetHandleId(u),COLOR+0,r)
  call SaveInteger(MHT,GetHandleId(u),COLOR+1,g)
  call SaveInteger(MHT,GetHandleId(u),COLOR+2,b)
  call SaveInteger(MHT,GetHandleId(u),'ALPH',a)
endfunction

function SetTint takes unit u, integer r, integer g, integer b, integer a returns nothing
  local integer uid=GetUnitTypeId(u)
  local integer h=GetHandleId(u)
  if r==-1 then
    if HaveSavedInteger(MHT,h,COLOR+0) then
      set r=LoadInteger(MHT,h,COLOR+0)
    elseif HaveSavedInteger(UMD,uid,0) then
      set r=LoadInteger(UMD,uid,0)
    else
      set r=255
    endif
  endif
  if g==-1 then
    if HaveSavedInteger(MHT,h,COLOR+1) then
      set g=LoadInteger(MHT,h,COLOR+1)
    elseif HaveSavedInteger(UMD,uid,1) then
      set g=LoadInteger(UMD,uid,1)
    else
      set g=255
    endif
  endif
  if b==-1 then
    if HaveSavedInteger(MHT,h,COLOR+2) then
      set b=LoadInteger(MHT,h,COLOR+2)
    elseif HaveSavedInteger(UMD,uid,2) then
      set b=LoadInteger(UMD,uid,2)
    else
      set b=255
    endif
  endif
  if a==-1 then
    if HaveSavedInteger(MHT,h,'ALPH') then
      set a=LoadInteger(MHT,h,'ALPH')
    else
      set a=255
    endif
  endif
  call SetUnitVertexColor(u,r,g,b,a)
  call SaveInteger(MHT,h,COLOR+0,r)
  call SaveInteger(MHT,h,COLOR+1,g)
  call SaveInteger(MHT,h,COLOR+2,b)
  call SaveInteger(MHT,h,'ALPH',a)
endfunction

function UMD_SaveTints takes integer uid, integer r, integer g, integer b returns nothing
  //store unit's tint. Use -1 to not store value (empty will be converted into 255)
  if r>-1 and r<256 then
    call SaveInteger(UMD,uid,0,r)
  endif
  if g>-1 and g<256 then
    call SaveInteger(UMD,uid,1,g)
  endif
  if b>-1 and b<256 then
    call SaveInteger(UMD,uid,2,b)
  endif
endfunction

function FS9 takes unit u returns nothing
  local integer id=GetUnitTypeId(u)
  local integer i=1
  local integer a=255
  local boolean found=false
  if id=='Ewar' then
    set a=R2I(2.55*(100-18+20*GetUnitAbilityLevel(u,'P239'))) //A03P
  endif
  loop
    exitwhen i>Tints_C or found
    if Tints_ID[i]==id then
      set found=true
      call SetUnitVertexColor(u,Tints_R[i],Tints_G[i],Tints_B[i],a)
    endif
    set i=i+1
  endloop
  if found==false then
    call SetUnitVertexColor(u,255,255,255,255)
  endif
endfunction

function FU9 takes unit u returns nothing
  local integer id=GetUnitTypeId(u)
  local integer i=1
  local boolean found=false
  loop
    exitwhen i>Tints_C or found
    if Tints_ID[i]==id then
      set found=true
      call SetUnitVertexColor(u,Tints_R[i],Tints_G[i],Tints_B[i],0)
    endif
    set i=i+1
  endloop
  if found==false then
    call SetUnitVertexColor(u,255,255,255,0)
  endif
endfunction

function Traffic_RegisterPlayerData takes player p,string FW9,integer Y08 returns nothing
  local string id=I2S(GetPlayerId(p))
  call StoreInteger(GCM,id,FW9,Y08)
  if IsPlayer(PlayerModeTyper)==false then
    call W18()
  endif
  if GetLocalPlayer()==PlayerModeTyper then
    call SyncStoredInteger(GCM,id,FW9)
  endif
endfunction

function Traffic_RegisterData takes string FY9,integer Y08 returns nothing
  call StoreInteger(GCM,"Data",FY9,Y08)
  if IsPlayer(PlayerModeTyper)==false then
    call W18()
  endif
  if GetLocalPlayer()==PlayerModeTyper then
    call SyncStoredInteger(GCM,"Data",FY9)
  endif
endfunction

function FA9 takes string s,string FB9,string FC9 returns string
  local string F39=""
  local integer i=0
  local integer F69=StringLength(s)
  local string FL9
  local integer F19=StringLength(FB9)
  local boolean found=false
  loop
    exitwhen i+1>F69
    set FL9=SubString(s,i,i+F19)
    if FL9!=FB9 or found then
      set F39=F39+SubString(s,i,i+1)
      set i=i+1
    else
      set F39=F39+FC9
      set i=i+F19
      set found=true
    endif
  endloop
  return F39
endfunction

function F09 takes player F59,player F29 returns string
  local string s=GetObjectName('n0C8')
  set s=FA9(s,"$dead",udg_Colors[GetPlayerId(F59)]+(PlayerNames[GetPlayerId((F59))])+"|r")
  set s=FA9(s,"$killer",udg_Colors[GetPlayerId(F29)]+(PlayerNames[GetPlayerId((F29))])+"|r")
  return s
endfunction

function SetBonusMSPercent takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer k
  if d<1 then
    call UnitRemoveAbility(u,BonusMSPercentSystem[0])
    call UnitRemoveAbility(u,BonusMSPercentSystem[1])
    call UnitRemoveAbility(u,BonusMSPercentSystem[2])
    call UnitRemoveAbility(u,BonusMSPercentSystem[3])
    call UnitRemoveAbility(u,BonusMSPercentSystem[4])
    call UnitRemoveAbility(u,BonusMSPercentSystem[5])
    call UnitRemoveAbility(u,BonusMSPercentSystem[6])
    call UnitRemoveAbility(u,BonusMSPercentSystem[7])
    call UnitRemoveAbility(u,BonusMSPercentSystem[8])
    call UnitRemoveAbility(u,BonusMSPercentSystem[9])
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set k=9
  set i=0
  loop
    exitwhen i>k
    if b[i]==1 then
      call UnitAddAbility2(u,BonusMSPercentSystem[i])
    else
      call UnitRemoveAbility(u,BonusMSPercentSystem[i])
    endif
    set i=i+1
  endloop
endfunction

function AddBonusMSPercent takes unit u, integer d returns nothing
  local integer h=GetHandleId(u)
  local integer curBonus=LoadInteger(MHT,h,'MSPC')
  if IsUnitType(u,UNIT_TYPE_HERO)==true then
    call SetBonusMSPercent(u,d+curBonus)
    call SaveInteger(MHT,h,'MSPC',d+curBonus)
  endif
endfunction

function SubBonusMSPercent takes unit u, integer d returns nothing
  local integer h=GetHandleId(u)
  local integer curBonus=LoadInteger(MHT,h,'MSPC')
  if IsUnitType(u,UNIT_TYPE_HERO)==true then
    call SetBonusMSPercent(u,curBonus-d)
    call SaveInteger(MHT,h,'MSPC',curBonus-d)
  endif
endfunction

function AddBonusDamage takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer k
  if d<1 then
    call UnitRemoveAbility(u,BonusDamageSystemCont[0])
    call UnitRemoveAbility(u,BonusDamageSystemCont[1])
    call UnitRemoveAbility(u,BonusDamageSystemCont[2])
    call UnitRemoveAbility(u,BonusDamageSystemCont[3])
    call UnitRemoveAbility(u,BonusDamageSystemCont[4])
    call UnitRemoveAbility(u,BonusDamageSystemCont[5])
    call UnitRemoveAbility(u,BonusDamageSystemCont[6])
    call UnitRemoveAbility(u,BonusDamageSystemCont[7])
    call UnitRemoveAbility(u,BonusDamageSystemCont[8])
    call UnitRemoveAbility(u,BonusDamageSystemCont[9])
    call UnitRemoveAbility(u,BonusDamageSystemCont[10])
    call UnitRemoveAbility(u,BonusDamageSystemCont[11])
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set k=11
  set i=0
  loop
    exitwhen i>k
    if b[i]==1 then
      call UnitAddAbility2(u,BonusDamageSystemCont[i])
    else
      call UnitRemoveAbility(u,BonusDamageSystemCont[i])
    endif
    set i=i+1
  endloop
endfunction

function BonusDamageSystem takes unit u returns nothing
  local integer h=GetHandleId(u)
  local integer i=0
  set i=i+LoadInteger(HY,h,'a068')
  set i=i+LoadInteger(HY,h,'a272')
  set i=i+LoadInteger(HY,h,'a430')
  set i=i+LoadInteger(HY,h,'axxx')
  set i=i+LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(u)),'DDUE')//duel
  call AddBonusDamage(u,i)
endfunction

function AddBonusHP takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer E29
  if d<1 then
    call UnitRemoveAbility(u,HPBonusSystem[0])
    call UnitRemoveAbility(u,HPBonusSystem[1])
    call UnitRemoveAbility(u,HPBonusSystem[2])
    call UnitRemoveAbility(u,HPBonusSystem[3])
    call UnitRemoveAbility(u,HPBonusSystem[4])
    call UnitRemoveAbility(u,HPBonusSystem[5])
    call UnitRemoveAbility(u,HPBonusSystem[6])
    call UnitRemoveAbility(u,HPBonusSystem[7])
    call UnitRemoveAbility(u,HPBonusSystem[8])
    call UnitRemoveAbility(u,HPBonusSystem[9])
    call UnitRemoveAbility(u,HPBonusSystem[10])
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set E29=10
  set i=0
  loop
    exitwhen i>E29
    if b[i]==1 then
      call UnitAddAbility2(u,HPBonusSystem[i])
    else
      call UnitRemoveAbility(u,HPBonusSystem[i])
    endif
    set i=i+1
  endloop
endfunction

function ManageBonusHP takes unit u, integer hp returns nothing
  local integer hu=GetHandleId(u)
  local integer stored=LoadInteger(MHT,hu,'BHPS')
  //call echo(I2S(hp)+" requested to manage, with stored = "+I2S(hp+stored))
  if hp > 0 then
    call AddBonusHP(u,hp+stored)
  elseif hp < 0 then
    call AddBonusHP(u,IMaxIF(stored + hp, 0))
    //call echo(I2S(IMaxIF(stored + hp, 0)) + " final bonus hp")
  endif
  call SaveInteger(MHT,hu,'BHPS',IMaxIF(stored + hp,0))
endfunction

function GD9 takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer E29
  if d<1 then
    call UnitRemoveAbility(u,NegativeArmorSystem[0])
    call UnitRemoveAbility(u,NegativeArmorSystem[1])
    call UnitRemoveAbility(u,NegativeArmorSystem[2])
    call UnitRemoveAbility(u,NegativeArmorSystem[3])
    call UnitRemoveAbility(u,NegativeArmorSystem[4])
    call UnitRemoveAbility(u,NegativeArmorSystem[5])
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set E29=i
  set i=0
  loop
    exitwhen i>E29
    if b[i]==1 then
      call UnitAddAbility2(u,NegativeArmorSystem[i])
    else
      call UnitRemoveAbility(u,NegativeArmorSystem[i])
    endif
    set i=i+1
  endloop
endfunction

function GG9 takes unit Source returns integer
  local integer W78=GetUnitTypeId(Source)
  local integer GH9='o01P'
  if W78=='Udre' or W78=='H071' then
    set GH9='o01N'
  endif
  return GH9
endfunction

function GI9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitX(Caster,GetUnitX(Source))
    call SetUnitY(Caster,GetUnitY(Source))
  endif
  set t=null
  set Source=null
  set Caster=null
  return false
endfunction

function GJ9 takes unit Source returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),GG9(Source),GetUnitX(Source),GetUnitY(Source),0)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function GI9))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  set t=null
  set Caster=null
endfunction

function GK9 takes integer unitId returns boolean
  local integer i=0
  loop
    exitwhen i>59
    if unitId==BuybackUnitId[i]then
      return true
    endif
    set i=i+1
  endloop
  return false
endfunction

function DefineBuybackUnitIndex takes integer Level returns integer
  local real Time=TimerGetElapsed(GlobalTimer)-GameStartsTime
  local real Minutes=(R2I(Time)/ 60)-(1/ 2)
  local real GO9=100+Level*Level*1.5+Minutes*15
  local integer ZG8
  set ZG8=R2I(GO9/ 50)
  set ZG8=IMinBJ(ZG8,59)
  set ZG8=IMaxBJ(ZG8,0)
  return ZG8
endfunction

function FixVisionGlitch_DefineDummy takes unit hero returns integer
  local integer uid=GetUnitTypeId(hero)
  local integer did='o01P'
  if uid=='Udre' or uid=='H071' then
    set did='o01N'
  endif
  return did
endfunction

function FixVisionGlitch_CorrectXY takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit hero=(LoadUnitHandle(HY,h,2))
  local unit dummy=(LoadUnitHandle(HY,h,(19)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or hero==null then
    call KillUnit(dummy)
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  else
    call SetUnitX(dummy,GetUnitX(hero))
    call SetUnitY(dummy,GetUnitY(hero))
  endif
  set t=null
  set hero=null
  set dummy=null
  return false
endfunction

function FixVisionGlitchOnBuyBach takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d=CreateUnit(GetOwningPlayer(u),FixVisionGlitch_DefineDummy(u),GetUnitX(u),GetUnitY(u),0)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function FixVisionGlitch_CorrectXY))
  call SaveUnitHandle(HY,h,2,(u))
  call SaveUnitHandle(HY,h,(19),(d))
  set t=null
  set d=null
endfunction

function GP9 takes player p returns nothing
  local integer id=GetPlayerId(p)
  local unit GQ9=CirclesOfPower[id]
  local unit Hero=udg_Hero[id]
  local integer Level=GetHeroLevel(Hero)
  local integer i=0
  call FixVisionGlitchOnBuyBach(Hero)
  loop
    exitwhen i>59
    call RemoveUnitFromStock(GQ9,BuybackUnitId[i])
    set i=i+1
  endloop
  if Mode_DM then
    return
  endif
  if YL7==false then
    return
  endif
  call AddUnitToStock(GQ9,BuybackUnitId[DefineBuybackUnitIndex(Level)],1,1)
  set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(Level)]
  set Hero=null
  set GQ9=null
endfunction

function GR9 takes player p returns nothing
  local integer id=GetPlayerId(p)
  local unit c=CirclesOfPower[id]
  local unit Hero=udg_Hero[id]
  local integer lvl=GetHeroLevel(Hero)
  local integer i=0
  if Mode_DM then
    return
  endif
  if YL7==false then
    return
  endif
  if BuybackID[id]=='h0D4' then
    return
  endif
  if BuybackID[id]!=0 then
    call RemoveUnitFromStock(c,BuybackID[id])
  endif
  call AddUnitToStock(c,BuybackUnitId[DefineBuybackUnitIndex(lvl)],1,1)
  set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(lvl)]
  set Hero=null
  set c=null
endfunction

function GS9 takes nothing returns boolean
  if Mode_DM then
    return false
  endif
  call GR9(Sentinels[1])
  call GR9(Sentinels[2])
  call GR9(Sentinels[3])
  call GR9(Sentinels[4])
  call GR9(Sentinels[5])
  call GR9(Scourges[1])
  call GR9(Scourges[2])
  call GR9(Scourges[3])
  call GR9(Scourges[4])
  call GR9(Scourges[5])
  return false
endfunction

function GT9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer id=(LoadInteger(HY,h,(34)))
  local unit GQ9=CirclesOfPower[id]
  local unit Hero=udg_Hero[id]
  local integer Level=GetHeroLevel(Hero)
  local integer i=0
  call UnitRemoveAbility(GQ9,'A20U')
  call AddUnitToStock(GQ9,BuybackUnitId[DefineBuybackUnitIndex(Level)],1,1)
  set BuybackID[id]=BuybackUnitId[DefineBuybackUnitIndex(Level)]
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set GQ9=null
  set Hero=null
  return false
endfunction

function GU9 takes player p returns nothing
  local integer id=GetPlayerId(p)
  local unit GQ9=CirclesOfPower[id]
  local unit Hero=udg_Hero[id]
  local integer Level=GetHeroLevel(Hero)
  local integer i=0
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call GJ9(Hero)
  loop
    exitwhen i>59
    call RemoveUnitFromStock(GQ9,BuybackUnitId[i])
    set i=i+1
  endloop
  call TriggerAddCondition(t,Condition(function GT9))
  call TriggerRegisterTimerEvent(t,420,false)
  call SaveInteger(HY,h,(34),(id))
  set BuybackID[id]='h0D4'
  call UnitAddAbility(GQ9,'A20U')
  call IssueImmediateOrderById(GQ9,852526)
  set Hero=null
  set GQ9=null
  set t=null
endfunction

function StorePlayersColorValues takes nothing returns nothing
  set PlayerColors_R[GetPlayerId(Sentinels[1])]=0
  set PlayerColors_G[GetPlayerId(Sentinels[1])]=66
  set PlayerColors_B[GetPlayerId(Sentinels[1])]=255
  set PlayerColors_R[GetPlayerId(Sentinels[2])]=48
  set PlayerColors_G[GetPlayerId(Sentinels[2])]=230
  set PlayerColors_B[GetPlayerId(Sentinels[2])]=185
  set PlayerColors_R[GetPlayerId(Sentinels[3])]=50
  set PlayerColors_G[GetPlayerId(Sentinels[3])]=0
  set PlayerColors_B[GetPlayerId(Sentinels[3])]=129
  set PlayerColors_R[GetPlayerId(Sentinels[4])]=255
  set PlayerColors_G[GetPlayerId(Sentinels[4])]=252
  set PlayerColors_B[GetPlayerId(Sentinels[4])]=1
  set PlayerColors_R[GetPlayerId(Sentinels[5])]=255
  set PlayerColors_G[GetPlayerId(Sentinels[5])]=50
  set PlayerColors_B[GetPlayerId(Sentinels[5])]=0
  set PlayerColors_R[GetPlayerId(Scourges[1])]=220
  set PlayerColors_G[GetPlayerId(Scourges[1])]=50
  set PlayerColors_B[GetPlayerId(Scourges[1])]=50
  set PlayerColors_R[GetPlayerId(Scourges[2])]=50
  set PlayerColors_G[GetPlayerId(Scourges[2])]=50
  set PlayerColors_B[GetPlayerId(Scourges[2])]=50
  set PlayerColors_R[GetPlayerId(Scourges[3])]=75
  set PlayerColors_G[GetPlayerId(Scourges[3])]=150
  set PlayerColors_B[GetPlayerId(Scourges[3])]=190
  set PlayerColors_R[GetPlayerId(Scourges[4])]=16
  set PlayerColors_G[GetPlayerId(Scourges[4])]=60
  set PlayerColors_B[GetPlayerId(Scourges[4])]=18
  set PlayerColors_R[GetPlayerId(Scourges[5])]=68
  set PlayerColors_G[GetPlayerId(Scourges[5])]=42
  set PlayerColors_B[GetPlayerId(Scourges[5])]=4
endfunction

function HK9 takes nothing returns nothing
  local integer VT8
  local integer VU8
  local integer i
  set udg_Colors[GetPlayerId(Sentinels[0])]="|c00ff0303"
  set udg_Colors[GetPlayerId(Sentinels[1])]="|c000042ff"
  set udg_Colors[GetPlayerId(Sentinels[2])]="|c001ce6b9"
  set udg_Colors[GetPlayerId(Sentinels[3])]="|c00540081"
  set udg_Colors[GetPlayerId(Sentinels[4])]="|c00fffc01"
  set udg_Colors[GetPlayerId(Sentinels[5])]="|c00ff8000"
  set udg_Colors[GetPlayerId(Scourges[0])]="|c0020c000"
  set udg_Colors[GetPlayerId(Scourges[1])]="|c00e55bb0"
  set udg_Colors[GetPlayerId(Scourges[2])]="|c00959697"
  set udg_Colors[GetPlayerId(Scourges[3])]="|c007ebff1"
  set udg_Colors[GetPlayerId(Scourges[4])]="|c00106246"
  set udg_Colors[GetPlayerId(Scourges[5])]="|c004e2a04"
  call SetPlayerColor(Sentinels[0],PLAYER_COLOR_RED)
  call SetPlayerColor(Sentinels[1],PLAYER_COLOR_BLUE)
  call SetPlayerColor(Sentinels[2],PLAYER_COLOR_CYAN)
  call SetPlayerColor(Sentinels[3],PLAYER_COLOR_PURPLE)
  call SetPlayerColor(Sentinels[4],PLAYER_COLOR_YELLOW)
  call SetPlayerColor(Sentinels[5],PLAYER_COLOR_ORANGE)
  call SetPlayerColor(Scourges[0],PLAYER_COLOR_GREEN)
  call SetPlayerColor(Scourges[1],PLAYER_COLOR_PINK)
  call SetPlayerColor(Scourges[2],PLAYER_COLOR_LIGHT_GRAY)
  call SetPlayerColor(Scourges[3],PLAYER_COLOR_LIGHT_BLUE)
  call SetPlayerColor(Scourges[4],PLAYER_COLOR_AQUA)
  call SetPlayerColor(Scourges[5],PLAYER_COLOR_BROWN)
  set VT8=1
  set VU8=5
  loop
    if GetPlayerSlotState(Sentinels[VT8])==PLAYER_SLOT_STATE_EMPTY then
      call SetPlayerName(Sentinels[VT8],GetObjectName('n0DH')+" "+I2S(VT8))
    endif
    if GetPlayerSlotState(Scourges[VT8])==PLAYER_SLOT_STATE_EMPTY then
      call SetPlayerName(Scourges[VT8],GetObjectName('n0DH')+" "+I2S(5+VT8))
    endif
    set VT8=VT8+1
    exitwhen VT8>VU8
  endloop
endfunction

function HM9 takes nothing returns nothing
  local integer i
  local integer k
  local integer HI9=125
  call SetUnitOwner(CirclesOfPower_1,Sentinels[1],false)
  call SetUnitOwner(CirclesOfPower_2,Sentinels[2],false)
  call SetUnitOwner(CirclesOfPower_3,Sentinels[3],false)
  call SetUnitOwner(CirclesOfPower_4,Sentinels[4],false)
  call SetUnitOwner(CirclesOfPower_5,Sentinels[5],false)
  call SetUnitOwner(CirclesOfPower_7,Scourges[1],false)
  call SetUnitOwner(CirclesOfPower_8,Scourges[2],false)
  call SetUnitOwner(CirclesOfPower_9,Scourges[3],false)
  call SetUnitOwner(CirclesOfPower_10,Scourges[4],false)
  call SetUnitOwner(CirclesOfPower_11,Scourges[5],false)
  set CirclesOfPower[GetPlayerId(Sentinels[1])]=CirclesOfPower_1
  set CirclesOfPower[GetPlayerId(Sentinels[2])]=CirclesOfPower_2
  set CirclesOfPower[GetPlayerId(Sentinels[3])]=CirclesOfPower_3
  set CirclesOfPower[GetPlayerId(Sentinels[4])]=CirclesOfPower_4
  set CirclesOfPower[GetPlayerId(Sentinels[5])]=CirclesOfPower_5
  set CirclesOfPower[GetPlayerId(Scourges[1])]=CirclesOfPower_7
  set CirclesOfPower[GetPlayerId(Scourges[2])]=CirclesOfPower_8
  set CirclesOfPower[GetPlayerId(Scourges[3])]=CirclesOfPower_9
  set CirclesOfPower[GetPlayerId(Scourges[4])]=CirclesOfPower_10
  set CirclesOfPower[GetPlayerId(Scourges[5])]=CirclesOfPower_11
  set i=1
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=2
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=3
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=4
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=5
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=7
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=8
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=9
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=10
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=11
  if GetLocalPlayer()==Player(i)then
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,255)
  else
    call SetUnitVertexColor(CirclesOfPower[GetPlayerId(Player(i))],255,255,255,HI9)
  endif
  set i=1
  loop
    set k=GetPlayerId(Sentinels[i])
    set ItemSpawnX[k]=GetUnitX(CirclesOfPower[k])
    set ItemSpawnY[k]=GetUnitY(CirclesOfPower[k])
    set k=GetPlayerId(Scourges[i])
    set ItemSpawnX[k]=GetUnitX(CirclesOfPower[k])
    set ItemSpawnY[k]=GetUnitY(CirclesOfPower[k])
    set i=i+1
    exitwhen i>5
  endloop
endfunction

function HN9 takes unit XX8 returns boolean
  local integer ID=GetUnitTypeId(XX8)
  if ID=='n00V' or ID=='n00W' or ID=='n002' or ID=='n00X' or ID=='nC38' or ID=='n01K' or ID=='n009' then
    return true
  endif
  return false
endfunction

function HO9 takes nothing returns nothing
  if(GetOwningPlayer(GetEnumUnit())==Player(0))then
    call SetUnitOwner(GetEnumUnit(),Sentinels[0],false)
    if HN9(GetEnumUnit())==false then
      call SetUnitColor(GetEnumUnit(),ConvertPlayerColor(0))
    endif
  else
    call SetUnitOwner(GetEnumUnit(),Scourges[0],false)
    if HN9(GetEnumUnit())==false then
      call SetUnitColor(GetEnumUnit(),ConvertPlayerColor(6))
    endif
  endif
endfunction

function HP9 takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Player(0),Condition(function ReturnTrue))
  call ForGroup(g,function HO9)
  call GroupClear(g)
  call GroupEnumUnitsOfPlayer(g,Player(6),Condition(function ReturnTrue))
  call ForGroup(g,function HO9)
  call KillGroup(g)
  set g=null
endfunction

function HR9 takes player p returns nothing
  local integer i=0
  local string HS9=GetPlayerName(p)
  local integer F69=StringLength(HS9)
  local integer HT9=F69
  loop
    exitwhen i==F69
    if SubString(HS9,i,i+1)=="("and SubString(HS9,i-1,i)==" "then
      set HT9=i-1
      call SetPlayerName(p,SubString(HS9,0,HT9))
      set i=F69
    else
      set i=i+1
    endif
  endloop
endfunction

function InitForces takes nothing returns nothing
  local integer HV9
  local integer HW9
  local integer VT8
  local integer VU8
  local integer x=0
  local integer y=0
  local integer i
  local trigger t=null
  local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
  local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
  if GetPlayerState(Sentinels[0],PLAYER_STATE_OBSERVER)!=0 or GetPlayerState(Scourges[0],PLAYER_STATE_OBSERVER)!=0 then
    set udg_ObserverMode=true
    set Sentinels[0]=Player(13)
    set Scourges[0]=Player(14)
    set udg_Observer1=Player(0)
    set udg_Observer2=Player(6)
    set advancedTracking=GetPlayerName(udg_Observer1)=="ohsystem.net"
    call SetAllyColorFilterState(0)
    loop
      exitwhen x>5
      call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(0),true)
      call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(4),true)
      call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(0),false)
      call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(4),false)
      set x=x+1
    endloop
  endif
  call ForceAddPlayer(Force_Elfs,Sentinels[0])
  call ForceAddPlayer(Force_Elfs,Sentinels[1])
  call ForceAddPlayer(Force_Elfs,Sentinels[2])
  call ForceAddPlayer(Force_Elfs,Sentinels[3])
  call ForceAddPlayer(Force_Elfs,Sentinels[4])
  call ForceAddPlayer(Force_Elfs,Sentinels[5])
  call ForceAddPlayer(Force_Unds,Scourges[0])
  call ForceAddPlayer(Force_Unds,Scourges[1])
  call ForceAddPlayer(Force_Unds,Scourges[2])
  call ForceAddPlayer(Force_Unds,Scourges[3])
  call ForceAddPlayer(Force_Unds,Scourges[4])
  call ForceAddPlayer(Force_Unds,Scourges[5])
  call ForceAddPlayer(AllPlayers,Sentinels[1])
  call ForceAddPlayer(AllPlayers,Sentinels[2])
  call ForceAddPlayer(AllPlayers,Sentinels[3])
  call ForceAddPlayer(AllPlayers,Sentinels[4])
  call ForceAddPlayer(AllPlayers,Sentinels[5])
  call ForceAddPlayer(AllPlayers,Scourges[1])
  call ForceAddPlayer(AllPlayers,Scourges[2])
  call ForceAddPlayer(AllPlayers,Scourges[3])
  call ForceAddPlayer(AllPlayers,Scourges[4])
  call ForceAddPlayer(AllPlayers,Scourges[5])
  if udg_ObserverMode then
    call ForceAddPlayer(AllPlayers,Player(0))
    call ForceAddPlayer(AllPlayers,Player(6))
  endif
  set x=0
  set y=0
  loop
    exitwhen x>5
    loop
      exitwhen y>5
      if(x!=y)then
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(0),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(1),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(2),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(3),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(4),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(5),true)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(6),false)
        call SetPlayerAlliance(Sentinels[x],Sentinels[y],ConvertAllianceType(7),false)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(0),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(1),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(2),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(3),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(4),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(5),true)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(6),false)
        call SetPlayerAlliance(Scourges[x],Scourges[y],ConvertAllianceType(7),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(0),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(1),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(2),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(3),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(4),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(5),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(6),false)
        call SetPlayerAlliance(Sentinels[x],Scourges[y],ConvertAllianceType(7),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(0),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(1),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(2),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(3),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(4),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(5),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(6),false)
        call SetPlayerAlliance(Scourges[x],Sentinels[y],ConvertAllianceType(7),false)
      endif
      set y=y+1
    endloop
    set y=0
    set x=x+1
  endloop
  call SetPlayerTeam(Sentinels[0],0)
  call SetPlayerTeam(Sentinels[1],0)
  call SetPlayerTeam(Sentinels[2],0)
  call SetPlayerTeam(Sentinels[3],0)
  call SetPlayerTeam(Sentinels[4],0)
  call SetPlayerTeam(Sentinels[5],0)
  call SetPlayerTeam(Scourges[0],1)
  call SetPlayerTeam(Scourges[1],1)
  call SetPlayerTeam(Scourges[2],1)
  call SetPlayerTeam(Scourges[3],1)
  call SetPlayerTeam(Scourges[4],1)
  call SetPlayerTeam(Scourges[5],1)
  call SetPlayerName(Sentinels[0],GetObjectName('n03N'))
  call SetPlayerName(Scourges[0],GetObjectName('n03O'))
  call SetPlayerName(Neutrals,GetObjectName('n0E8'))
  call HM9()
  if(Sentinels[0]!=Player(0)or Scourges[0]!=Player(6))then
    call HP9()
  endif
  call HK9()
  set HW9=VO8(Force_Elfs)
  set HV9=VO8(Force_Unds)
  set VT8=1
  set VU8=5
  loop
    exitwhen VT8>VU8
    if(IsPlayer(Sentinels[VT8]))then
      call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD,(4375/ HW9))
      call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_LUMBER,0)
    endif
    if(IsPlayer(Scourges[VT8]))then
      call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD,(4375/ HV9))
      call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_LUMBER,0)
    endif
    set VT8=VT8+1
  endloop
  call SetPlayerHandicapXP(Sentinels[1],1)
  call SetPlayerHandicapXP(Sentinels[2],1)
  call SetPlayerHandicapXP(Sentinels[3],1)
  call SetPlayerHandicapXP(Sentinels[4],1)
  call SetPlayerHandicapXP(Sentinels[5],1)
  call SetPlayerHandicapXP(Scourges[1],1)
  call SetPlayerHandicapXP(Scourges[2],1)
  call SetPlayerHandicapXP(Scourges[3],1)
  call SetPlayerHandicapXP(Scourges[4],1)
  call SetPlayerHandicapXP(Scourges[5],1)
  call SetPlayerState(Sentinels[0],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Sentinels[1],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Sentinels[2],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Sentinels[3],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Sentinels[4],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Sentinels[5],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[0],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[1],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[2],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[3],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[4],PLAYER_STATE_GIVES_BOUNTY,1)
  call SetPlayerState(Scourges[5],PLAYER_STATE_GIVES_BOUNTY,1)
  call W18()
  call StorePlayersColorValues()
  call HR9(Sentinels[1])
  call HR9(Sentinels[2])
  call HR9(Sentinels[3])
  call HR9(Sentinels[4])
  call HR9(Sentinels[5])
  call HR9(Scourges[1])
  call HR9(Scourges[2])
  call HR9(Scourges[3])
  call HR9(Scourges[4])
  call HR9(Scourges[5])
  set x=1
  loop
    exitwhen x>5
    if IsPlayer(Sentinels[x])then
      call PlacePickDummies(Sentinels[x])
    endif
    if IsPlayer(Scourges[x])then
      call PlacePickDummies(Scourges[x])
    endif
    set x=x+1
  endloop
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  set i=0
  loop
    set PlayerNames[i]=GetPlayerName(Player(i))
    set i=i+1
    exitwhen i==16
  endloop
  set t=null
  set SpawnSent=null
  set SpawnScourge=null
endfunction

function CHD takes integer id, integer hid, integer did,integer cmid,string icon,string winanim,real scale returns nothing
  set HeroID[id]=hid
  set HeroDummy[id]=did
  set HeroIcon[id]=icon
  call SaveUnitWinAnimation(hid,winanim)
  call SaveUnitModelScale(hid,scale,did)
endfunction

function InitHeroes takes nothing returns nothing
  call CHD(indexid_VS,'Hvwd','h03Z','n09U',"ReplaceableTextures\\CommandButtons\\BTNAvengingWatcher.blp","stand 4",1.35)
  call CHD(indexid_Zeus,'Hmbr','h040','n09A',"ReplaceableTextures\\CommandButtons\\BTNAvatar.blp","attack slam alternate",1.33)
  call CHD(indexid_Enchantress,'Emoo','h041','n099',"ReplaceableTextures\\CommandButtons\\BTNDryad.blp","stand 4",1.)
  call CHD(indexid_Morphling,'O00P','h042','n098',"ReplaceableTextures\\CommandButtons\\BTNSeaElemental.blp","stand 2",1.)
  call CHD(indexid_CM,'Hjai','h043','n09W',"ReplaceableTextures\\CommandButtons\\BTNJaina.blp","stand victory",1.)
  call CHD(indexid_Sven,'H001','h044','n096',"ReplaceableTextures\\CommandButtons\\BTNFelGuardBlue.blp","spell",1.)
  call CHD(indexid_NagaSiren,'HC49','h045','n09P',"ReplaceableTextures\\CommandButtons\\BTNSeaWitch.blp","spell",1.)
  call CHD(indexid_ES,'Otch','h046','n09D',"ReplaceableTextures\\CommandButtons\\BTNTauren.blp","attack slam",1.1)
  call CHD(indexid_Riki,'HC92','h047','n09X',"ReplaceableTextures\\CommandButtons\\BTNSatyrTrickster.blp","stand 4",1.)
  call CHD(indexid_LoneDruid,'N01O','h048','n09Y',"ReplaceableTextures\\CommandButtons\\BTNDruidOfTheClaw.blp","spell slam",1.)
  call SaveUnitModelScale('N013',1.1,0)
  call SaveUnitModelScale('N014',1.2,0)
  call SaveUnitModelScale('N015',1.3,0)
  call SaveUnitModelScale('n004',1.0,0)
  call SaveUnitModelScale('n018',1.1,0)
  call SaveUnitModelScale('n01C',1.2,0)
  call SaveUnitModelScale('n01G',1.3,0)
  call CHD(indexid_Lina,'H004','h049','n09Z',"ReplaceableTextures\\CommandButtons\\BTNSorceress.blp","stand victory",1.2)
  call CHD(indexid_Juggernaut,'Nbbc','h04A','n0A5',"ReplaceableTextures\\CommandButtons\\BTNChaosBlademaster.blp","stand victory",1.)
  call CHD(indexid_Silencer,'N01A','h04B','n097',"ReplaceableTextures\\CommandButtons\\BTNSpellBreaker.blp","stand ready",1.)
  call CHD(indexid_Treant,'Hamg','h04C','n09F',"ReplaceableTextures\\CommandButtons\\BTNTreant.blp","stand 3",.72)
  call CHD(indexid_Chieftain,'O015','h07P','n0GC',"ReplaceableTextures\\CommandButtons\\BTNHeroTaurenChieftain.blp","stand victory",1.1)
  call CHD(indexid_Kotl,'Hblm','h04E','n09G',"ReplaceableTextures\\CommandButtons\\BTNHeroArchMage.blp","stand victory",1.2)
  call SaveUnitModelScale('H06X',1.5,0)
  call SaveUnitModelScale('H06Y',1.5,0)
  call SaveUnitModelScale('H06W',1.5,0)
  call CHD(indexid_Ursa,'Huth','h04F','n09V',"ReplaceableTextures\\CommandButtons\\BTNFurbolgTracker.blp","stand spell",1.2)
  call CHD(indexid_OgreMagi,'Hmkg','h04G','n0A1',"ReplaceableTextures\\CommandButtons\\BTNOgreMagi.blp","sleep",1.4)
  call CHD(indexid_Tinker,'Ntin','h04H','n0AA',"ReplaceableTextures\\CommandButtons\\BTNHeroTinker.blp","stand 2",1.)
  call CHD(indexid_Furion,'Emns','h04I','n0A4',"ReplaceableTextures\\CommandButtons\\BTNFurion.blp","spell",1.2)
  call CHD(indexid_PL,'Ogrh','h04J','n0A3',"ReplaceableTextures\\CommandButtons\\BTNHellScream.blp","stand victory",1.)
  call CHD(indexid_Tiny,'Ucrl','h04K','n0A7',"ReplaceableTextures\\CommandButtons\\BTNMountainGiant.blp","spell",.5)
  call SaveUnitModelScale('U01X',.5,0)
  call CHD(indexid_Techies,'H00K','h04L','n0A9',"ReplaceableTextures\\CommandButtons\\BTNGoblinSapper.blp","stand 2",1.)
  call CHD(indexid_Chen,'H00A','h04M','n0AB',"ReplaceableTextures\\CommandButtons\\BTNHeroFarseer.blp","spell chain lightning",1.)
  call CHD(indexid_Luna,'E005','h04N','n0BE',"ReplaceableTextures\\CommandButtons\\BTNHuntress.blp","spell",1.)
  call CHD(indexid_Sniper,'Usyl','h04O','n0BD',"ReplaceableTextures\\CommandButtons\\BTNRifleman.blp","spell",1.1)
  call CHD(indexid_Troll,'N016','h04P','n0A8',"ReplaceableTextures\\CommandButtons\\BTNForestTroll.blp","stand 3",1.25)
  call SaveUnitModelScale('N02B',1.25,0)
  call SaveUnitModelScale('QTW2',1.25,0)
  call SaveUnitModelScale('QTW3',1.25,0)
  call SaveUnitModelScale('N017',1.25,0)
  call CHD(indexid_Rhasta,'Orkn','h057','n094',"ReplaceableTextures\\CommandButtons\\BTNShadowHunter.blp","stand victory",1.)
  call CHD(indexid_Wisp,'O01F','h0CI','n0KS',"ReplaceableTextures\\CommandButtons\\BTNWispHero.blp","stand 3",1.3)
  call CHD(indexid_Pandaren,'Npbm','h053','n0AO',"ReplaceableTextures\\CommandButtons\\BTNPandarenBrewmaster.blp","stand ready",1.)
  call CHD(indexid_Centaur,'H000','h04X','n0AN',"ReplaceableTextures\\CommandButtons\\BTNCentaurKhan.blp","stand 3",1.75)
  call CHD(indexid_Bounty,'Naka','h052','n0AM',"ReplaceableTextures\\CommandButtons\\BTNakama.blp","stand var4",1.2)
  call CHD(indexid_DK,'Hlgr','h04V','n0AQ',"ReplaceableTextures\\CommandButtons\\BTNTheCaptain.blp","stand victory",1.35)
  call SaveUnitModelScale('H00F',1,0)
  call SaveUnitModelScale('H00G',1,0)
  call SaveUnitModelScale('H00E',1,0)
  call FR9('H00G',255,255,200)
  call FR9('H00F',255,255,200)
  call FR9('H00G',255,200,200)
  call CHD(indexid_AM,'Edem','h04T','n0AR',"ReplaceableTextures\\CommandButtons\\BTNHeroDemonHunter.blp","stand channel",1.)
  call CHD(indexid_Trax,'Nbrn','h055','n0AL',"ReplaceableTextures\\CommandButtons\\BTNBansheeRanger.blp","spell",1.)
  call CHD(indexid_Omni,'Harf','h04Z','n0AS',"ReplaceableTextures\\CommandButtons\\BTNArthas.blp","stand victory",1.1)
  call CHD(indexid_Beastmaster,'H00D','h04S','n0AK',"ReplaceableTextures\\CommandButtons\\BTNBeastMaster.blp","spell slam",1.)
  call CHD(indexid_THD,'E00P','h04R','n0AJ',"ReplaceableTextures\\CommandButtons\\BTNChimaera.blp","stand 3",1.)
  call CHD(indexid_Alchemist,'N01I','h054','n0AI',"ReplaceableTextures\\CommandButtons\\BTNHeroAlchemist.blp","stand 2",1.)
  call SaveUnitModelScale('N01J',1,0)
  call SaveUnitModelScale('N01H',1,0)
  call SaveUnitModelScale('N01T',1,0)
  call SaveUnitModelScale('H600',1,0)
  call SaveUnitModelScale('H601',1,0)
  call SaveUnitModelScale('H602',1,0)
  call CHD(indexid_Potm,'N01V','h04W','n0AH',"ReplaceableTextures\\CommandButtons\\BTNPriestessOfTheMoon.blp","stand ready",1.)
  call CHD(indexid_Storm,'H00S','h04Q','n0AT',"ReplaceableTextures\\CommandButtons\\BTNStorm.blp","spell",1.)
  call CHD(indexid_Huskar,'H00Q','h04Y','n0AG',"ReplaceableTextures\\CommandButtons\\BTNHeadHunterBerserker.blp","stand alternate 3",1.15)
  call CHD(indexid_Lanaya,'E01Y','h058','n0AF',"ReplaceableTextures\\CommandButtons\\BTNAssassin.blp","stand victory",1.2)
  call CHD(indexid_Puck,'N00B','h050','n0AE',"ReplaceableTextures\\CommandButtons\\BTNFaerieDragon.blp","attack spell",1.1)
  call CHD(indexid_Clock,'H00T','h051','n0AU',"ReplaceableTextures\\CommandButtons\\BTNClockWerkGoblin.blp","Birth",1.5)
  call CHD(indexid_Admiral,'H06S','h06T','n0EE',"ReplaceableTextures\\CommandButtons\\BTNProudmoore.blp","stand victory",1.1)
  call CHD(indexid_WR,'N0EG','h07A','n0EH',"ReplaceableTextures\\CommandButtons\\BTNSylvanusWindrunner.blp","stand victory",1.2)
  call CHD(indexid_Gyro,'E02N','h0CC','n0KN',"ReplaceableTextures\\CommandButtons\\BTNFlyingMachine.blp","stand 3",1.1)
  call SaveUnitModelScale('E02O',1.1,0)
  call CHD(indexid_Disruptor,'E02J','h0CD','n0KR',"ReplaceableTextures\\CommandButtons\\BTNThrall.blp","stand 3",1.1)
  call CHD(indexid_Tusk,'E02I','h0C9','n0KK',"ReplaceableTextures\\CommandButtons\\BTNTuskaarBrown.blp","stand 3",1.)
  call CHD(indexid_Phoenix,'E02F','h0C8','n0KM',"ReplaceableTextures\\CommandButtons\\BTNPhoenix.blp","stand 3",1.05)
  call CHD(indexid_BB,'H008','h04U','n0AC',"ReplaceableTextures\\CommandButtons\\BTNRazorback.blp","stand",1.65)
  call CHD(indexid_Rubick,'E02X','h0CT','n0LK',"ReplaceableTextures\\CommandButtons\\BTNMedivh.blp","stand 3",1.15)
  call CHD(indexid_Xin,'N0M0','h0DG','n0M1',"ReplaceableTextures\\CommandButtons\\BTNFireBrewmaster.blp","stand 3",1.)
  call CHD(indexid_Legion,'E02K','h0CA','n0KJ',"ReplaceableTextures\\CommandButtons\\BTNGarithos.blp","stand 3",1.3)
  call CHD(indexid_Skywrath,'H0DO','h0DH','n0M6',"ReplaceableTextures\\CommandButtons\\BTNDragonHawk.blp","stand 3",1.1)
  call CHD(indexid_Timber,'E032','h0EB','n0ME',"ReplaceableTextures\\CommandButtons\\BTNJunkGolem.blp","stand 3",1.)
  set LastSentinelHeroIndexid=57
  set FirstScourgeHeroIndexid=58
  call CHD(indexid_Lycan,'U008','h05H','n0B3',"ReplaceableTextures\\CommandButtons\\BTNKiljaedin.blp","spell",1.2)
  call SaveUnitModelScale('E015',1,0)
  call FR9(HeroID[indexid_Lycan],255,75,255)
  call CHD(indexid_Brood,'U006','h05I','n0B4',"ReplaceableTextures\\CommandButtons\\BTNSpiderBlack.blp","walk",1.36)
  call CHD(indexid_PA,'Ewar','h05J','n0B5',"ReplaceableTextures\\CommandButtons\\BTNHeroWarden.blp","spell slam",1.)
  call CHD(indexid_Medusa,'H00V','h05K','n0B6',"ReplaceableTextures\\CommandButtons\\BTNNagaSeaWitch.blp","stand ready",1.)
  call SaveUnitModelScale('H08D',1,0)
  call SaveUnitModelScale('H08C',1,0)
  call SaveUnitModelScale('H084',1,0)
  call SaveUnitModelScale('H08B',1,0)
  call CHD(indexid_Bala,'Udre','h05L','n0B7',"ReplaceableTextures\\CommandButtons\\BTNTichondrius.blp","spell slam",1.)
  call CHD(indexid_Leoric,'NC00','h05M','n0C0',"ReplaceableTextures\\CommandButtons\\BTNSkeletonArcher.blp","stand victory",1.8)
  call FR9(HeroID[indexid_Leoric],100,125,100)
  call CHD(indexid_Doom,'UC42','h05N','n0BV',"ReplaceableTextures\\CommandButtons\\BTNDoomGuard.blp","stand victory",1.1)
  call CHD(indexid_NA,'U000','h05O','n0BU',"ReplaceableTextures\\CommandButtons\\BTNHeroCryptLord.tga","spell throw",.8)
  call CHD(indexid_Slardar,'UC91','h05P','n0C1',"ReplaceableTextures\\CommandButtons\\BTNNagaMyrmidon.tga","spell",1.)
  call FR9(HeroID[indexid_Slardar],175,75,200)
  call CHD(indexid_QoP,'UC01','h05Q','n0C2',"ReplaceableTextures\\CommandButtons\\BTNBlueDemoness.tga","spell slam",1.3)
  call CHD(indexid_Bone,'E004','h05R','n0BW',"ReplaceableTextures\\CommandButtons\\BTNSkeletonMage.blp","stand victory",1.)
  call CHD(indexid_Void,'EC45','h05S','n0BS',"ReplaceableTextures\\CommandButtons\\BTNFacelessOne.blp","spell slam",1.3)
  call FR9(HeroID[indexid_Void],0,255,150)
  call CHD(indexid_Viper,'EC77','h05T','n0BR',"ReplaceableTextures\\CommandButtons\\BTNNetherDragon.blp","spell slam",1.2)
  call FR9(HeroID[indexid_Viper],75,255,25)
  call CHD(indexid_Razor,'E002','h05U','n0BY',"ReplaceableTextures\\CommandButtons\\BTNRevenant.blp","spell",1.)
  call CHD(indexid_Lifestealer,'U00C','h05V','n0BQ',"ReplaceableTextures\\CommandButtons\\BTNGhoul.blp","victory",1.5)
  call FR9(HeroID[indexid_Lifestealer],100,100,100)
  call CHD(indexid_Pugna,'H00H','h05W','n0BT',"ReplaceableTextures\\CommandButtons\\BTNPugna.BLP","stand ready",1.)
  call CHD(indexid_Tide,'Ofar','h05X','n0BP',"ReplaceableTextures\\CommandButtons\\BTNSeaGiantGreen.blp","attack slam",1.)
  call CHD(indexid_Bane,'Oshd','h05Y','n0BO',"ReplaceableTextures\\CommandButtons\\BTNVoidWalker.blp","spell",1.5)
  call FR9(HeroID[indexid_Bane],150,0,150)
  call CHD(indexid_Necrolyte,'U00E','h05Z','n0B8',"ReplaceableTextures\\CommandButtons\\BTNGhostOfKelThuzad.blp","stand victory",1.3)
  call CHD(indexid_Pudge,'U00F','h060','n0C5',"ReplaceableTextures\\CommandButtons\\BTNAbomination.blp","stand 3",1.)
  call CHD(indexid_Barathum,'O00J','h061','n0C3',"ReplaceableTextures\\CommandButtons\\BTNSpiritWalker.blp","stand ready",1.2)
  call CHD(indexid_Weaver,'Ubal','h062','n0BX',"ReplaceableTextures\\CommandButtons\\BTNNerubianQueen.blp","attack",1.)
  call FR9(HeroID[indexid_Weaver],255,200,200)
  call CHD(indexid_SF,'Nfir','h063','n0BN',"ReplaceableTextures\\CommandButtons\\BTNShade.blp","stand channel",1.15)
  call FR9(HeroID[indexid_SF],0,0,0)
  call CHD(indexid_SK,'U00K','h064','n0C4',"ReplaceableTextures\\CommandButtons\\BTNArachnathidGreen.blp","attack 3",1.)
  call CHD(indexid_Axe,'Opgh','h065','n0BM',"ReplaceableTextures\\CommandButtons\\BTNChaosGrom.blp","stand victory",1.)
  call CHD(indexid_BS,'Hvsh','h066','n0BZ',"ReplaceableTextures\\CommandButtons\\BTNShaman.blp","stand victory",1.25)
  call FR9(HeroID[indexid_BS],250,150,150)
  call CHD(indexid_Abaddon,'Udea','h067','n0BL',"ReplaceableTextures\\CommandButtons\\BTNHeroDeathKnight.blp","stand ready",1.)
  call CHD(indexid_Spectre,'E01B','h068','n0B9',"ReplaceableTextures\\CommandButtons\\BTNvengeanceincarnate.blp","stand ready",.8)
  call CHD(indexid_WD,'E01A','h069','n0BK',"ReplaceableTextures\\CommandButtons\\BTNWitchDoctor.blp","stand victory",1.25)
  call CHD(indexid_OD,'U00P','h06A','n0BA',"ReplaceableTextures\\CommandButtons\\BTNDestroyer.blp","stand alternate 2",.85)
  call CHD(indexid_WL,'E01C','h06C','n0BB',"ReplaceableTextures\\CommandButtons\\BTNGuldan.blp","spell",1.5)
  call CHD(indexid_Geomancer,'H00I','h06D','n0BJ',"ReplaceableTextures\\CommandButtons\\BTNKoboldGeomancer.blp","spell",1.4)
  call SaveUnitModelScale('H00J',1.4,0)
  call CHD(indexid_Dazzle,'N01W','h06E','n0BI',"ReplaceableTextures\\CommandButtons\\BTNDarkTrollShadowPriest.blp","spell",1.2)
  call CHD(indexid_Pit,'N00R','h06F','n0BC',"ReplaceableTextures\\CommandButtons\\BTNPitLord.blp","stand channel",.95)
  call CHD(indexid_Zombie,'H00R','h06G','n0BH',"ReplaceableTextures\\CommandButtons\\BTNZombie.blp","stand",2.)
  call SaveUnitModelScale('H07I',1.3,0)
  call CHD(indexid_DS,'H00N','h06H','n0BG',"ReplaceableTextures\\CommandButtons\\BTNDranaiMage.blp","spell",1.15)
  call CHD(indexid_Kodo,'KODO','ho0E',0,"ReplaceableTextures\\CommandButtons\\BTNChaosKotoBeast.blp","stand victory",1.)
  call CHD(indexid_Enigma,'Uktl','h04D','n0A6',"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_SummonVoidWalker.blp","stand",1.5)
  call CHD(indexid_Batrider,'O016','h07R','n0G9',"ReplaceableTextures\\CommandButtons\\BTNTrollBatRider.blp","stand",1.2)
  call SaveUnitModelScale('O017',1.2,0)
  call CHD(indexid_AA,'N0HP','h0B0','n0HR',"ReplaceableTextures\\CommandButtons\\BTNIcyGhost.blp","stand",1.17)
  call SaveUnitModelScale('N0HP',1.2,0)
  call CHD(indexid_Slark,'H071','h072','n0EF',"ReplaceableTextures\\CommandButtons\\BTNMurgulShadowCaster.blp","stand 3",1.25)
  call CHD(indexid_TB,'Eevi','h056','n0AV',"ReplaceableTextures\\CommandButtons\\BTNEvilIllidan.blp","spell channel",1.)
  call SaveUnitModelScale('Eevm',1,0)
  call SaveUnitModelScale('E02V',1,0)
  call SaveUnitModelScale('E02W',1,0)
  call SaveUnitModelScale('E02U',1,0)
  call CHD(indexid_Leshrak,'Ekee','h059','n0AW',"ReplaceableTextures\\CommandButtons\\BTNKeeperGhostBlue.blp","stand victory",1.)
  call CHD(indexid_SD,'E02H','h0CB','n0KL',"ReplaceableTextures\\CommandButtons\\BTNArchimonde.blp","stand 3",1.25)
  call CHD(indexid_Lich,'Ulic','h05A','n0AX',"ReplaceableTextures\\CommandButtons\\BTNLichVersion2.blp","stand channel",1.3)
  call CHD(indexid_Banshee,'UC76','h05B','n0AY',"ReplaceableTextures\\CommandButtons\\BTNBanshee.blp","spell wail",1.35)
  call CHD(indexid_Lion,'UC18','h05C','n0AZ',"ReplaceableTextures\\CommandButtons\\BTNLion.blp","spell callstorm",1.3)
  call FR9(HeroID[indexid_Lion],50,100,255)
  call CHD(indexid_Veno,'EC57','h05D','n0B0',"ReplaceableTextures\\CommandButtons\\BTNHydralisk.blp","attack",1.)
  call FR9(HeroID[indexid_Veno],150,200,255)
  call CHD(indexid_Magnus,'UC11','h05E','n0A2',"ReplaceableTextures\\CommandButtons\\BTNBlueMagnataur.tga","stand channel",1.)
  call FR9(HeroID[indexid_Magnus],150,150,100)
  call CHD(indexid_Visage,'UC60','h05F','n0B1',"ReplaceableTextures\\CommandButtons\\BTNSpiritWyvern.blp","stand victory",1.)
  call FR9(HeroID[indexid_Visage],150,150,150)
  call CHD(indexid_Nessaj,'U00A','h05G','n0B2',"ReplaceableTextures\\CommandButtons\\BTNChaosWarlord.blp","stand victory",1.05)
  call CHD(indexid_Wyvern,'N0M7','h0DW','n0M8',"ReplaceableTextures\\CommandButtons\\BTNFrostWyrm.blp","stand victory",.9)
  call CHD(indexid_Zet,'N0MK','h0EF','n0ML',"ReplaceableTextures\\CommandButtons\\BTNGnollWarden.blp","stand victory",1.5)
  call CHD(indexid_Earth,'N0MU','ho04',0,"ReplaceableTextures\\CommandButtons\\BTNEarthBrewmaster.blp","stand 3",1.)
  call CHD(indexid_Oracle,'N0MD','ho05',0,"ReplaceableTextures\\CommandButtons\\BTNPriest.blp","stand victory",1.25)
  call CHD(indexid_Crabe,'H503','ho06',0,"ReplaceableTextures\\CommandButtons\\BTNLobstrokkRed.blp","spell",1.)
  call CHD(indexid_Sieger,'H501','ho07',0,"ReplaceableTextures\\CommandButtons\\BTNSeigeEngine.blp","attack",1.)
  call CHD(indexid_Sorcesser,'H502','ho08',0,"ReplaceableTextures\\CommandButtons\\BTNSorceress.blp","spell channel",1.)
  call CHD(indexid_Invoker,'H00U','ho09',0,"ReplaceableTextures\\CommandButtons\\BTNHeroBloodElfPrince.blp","spell",1.)
  call CHD(indexid_Formless,'H500','ho0A',0,"ReplaceableTextures\\CommandButtons\\BTNSpell_Shadow_AntiShadow.blp","attack",1.1)
  call CHD(indexid_SpaceOrc,'H504','ho0B',0,"ReplaceableTextures\\CommandButtons\\BTNChaosSpaceOrc.blp","spell",1.3)
  call CHD(indexid_OgreLord,'H505','ho0C',0,"ReplaceableTextures\\CommandButtons\\BTNOgreLord.blp","sleep",1.7)
  call CHD(indexid_FireLord,'H506','ho0D',0,"ReplaceableTextures\\CommandButtons\\BTNPitLord.blp","spell",1.2)
  call CHD(indexid_Queen,'H507','ho0F',0,"ReplaceableTextures\\CommandButtons\\BTNHippogriffRider.blp","attack",1.0)
  
  set LastScourgeHeroIndexid=indexid_Queen
  
  set AgiHeroesArray[1]='Nbrn'//agility
  set AgiHeroesArray[2]='Edem'
  set AgiHeroesArray[3]='N016'
  set AgiHeroesArray[4]='Nbbc'
  set AgiHeroesArray[5]='Naka'
  set AgiHeroesArray[6]='O00P'
  set AgiHeroesArray[7]='Usyl'
  set AgiHeroesArray[8]='E005'
  set AgiHeroesArray[9]='N01O'
  set AgiHeroesArray[10]='HC92'
  set AgiHeroesArray[11]='Hvwd'
  set AgiHeroesArray[12]='HC49'
  set AgiHeroesArray[13]='Huth'
  set AgiHeroesArray[14]='Ogrh'
  set AgiHeroesArray[15]='U006'
  set AgiHeroesArray[16]='EC57'
  set AgiHeroesArray[17]='Eevi'
  set AgiHeroesArray[18]='Ubal'
  set AgiHeroesArray[19]='E004'
  set AgiHeroesArray[20]='EC77'
  set AgiHeroesArray[21]='Hvsh'
  set AgiHeroesArray[22]='Nfir'
  set AgiHeroesArray[23]='E002'
  set AgiHeroesArray[24]='EC45'
  set AgiHeroesArray[25]='Ewar'
  set AgiHeroesArray[26]='U000'
  set AgiHeroesArray[27]='H00V'
  set AgiHeroesArray[28]='E01B'
  set AgiHeroesArray[29]='N01V'
  set AgiHeroesArray[30]='H00I'
  set AgiHeroesArray[31]='E01Y'
  set AgiHeroesArray[32]='H071'
  set AgiHeroesArray[33]='E02N'
  set AgiHeroesArray[34]='N0M0'
  set AgiHeroesArray[35]='N0MK'
  set AgiHeroesArray[36]='H503'
  set AgiHeroesArray[37]='H507'
  set AgilityHeroesAmount=37
  set StrHeroesArray[1]='Npbm'//strength
  set StrHeroesArray[2]='Hlgr'
  set StrHeroesArray[3]='Harf'
  set StrHeroesArray[4]='H000'
  set StrHeroesArray[5]='H001'
  set StrHeroesArray[6]='Hamg'
  set StrHeroesArray[7]='H008'
  set StrHeroesArray[8]='Ucrl'
  set StrHeroesArray[9]='Otch'
  set StrHeroesArray[10]='NC00'
  set StrHeroesArray[11]='Udre'
  set StrHeroesArray[12]='UC11'
  set StrHeroesArray[13]='Ofar'
  set StrHeroesArray[14]='U00F'
  set StrHeroesArray[15]='U00K'
  set StrHeroesArray[16]='O00J'
  set StrHeroesArray[17]='Udea'
  set StrHeroesArray[18]='Opgh'
  set StrHeroesArray[19]='U00A'
  set StrHeroesArray[20]='U00C'
  set StrHeroesArray[21]='UC91'
  set StrHeroesArray[22]='UC42'
  set StrHeroesArray[23]='U008'
  set StrHeroesArray[24]='H00D'
  set StrHeroesArray[25]='N01I'
  set StrHeroesArray[26]='H00Q'
  set StrHeroesArray[27]='N00R'
  set StrHeroesArray[28]='H00T'
  set StrHeroesArray[29]='H06S'
  set StrHeroesArray[30]='H00R'
  set StrHeroesArray[31]='O015'
  set StrHeroesArray[32]='E02I'
  set StrHeroesArray[33]='E02F'
  set StrHeroesArray[34]='O01F'
  set StrHeroesArray[35]='E032'
  set StrHeroesArray[36]='E02K'
  set StrHeroesArray[37]='N0MU'
  set StrHeroesArray[38]='KODO'
  set StrHeroesArray[39]='H501'
  set StrHeroesArray[40]='H504'
  set StrHeroesArray[41]='H505'
  set StrHeroesArray[42]='H506'
  set StrHeroesAmount=42
  set IntHeroesArray[1]='Orkn'//intel
  set IntHeroesArray[2]='Emoo'
  set IntHeroesArray[3]='Emns'
  set IntHeroesArray[4]='H004'
  set IntHeroesArray[5]='Hjai'
  set IntHeroesArray[6]='Uktl'
  set IntHeroesArray[7]='Hmbr'
  set IntHeroesArray[8]='H00K'
  set IntHeroesArray[9]='Ntin'
  set IntHeroesArray[10]='Hmkg'
  set IntHeroesArray[11]='Hblm'
  set IntHeroesArray[12]='N01A'
  set IntHeroesArray[13]='H00A'
  set IntHeroesArray[14]='Ulic'
  set IntHeroesArray[15]='Ekee'
  set IntHeroesArray[16]='UC76'
  set IntHeroesArray[17]='UC18'
  set IntHeroesArray[18]='UC01'
  set IntHeroesArray[19]='UC60'
  set IntHeroesArray[20]='H00H'
  set IntHeroesArray[21]='Oshd'
  set IntHeroesArray[22]='U00E'
  set IntHeroesArray[23]='E01A'
  set IntHeroesArray[24]='U00P'
  set IntHeroesArray[25]='E00P'
  set IntHeroesArray[26]='E01C'
  set IntHeroesArray[27]='N01W'
  set IntHeroesArray[28]='H00N'
  set IntHeroesArray[29]='N0EG'
  set IntHeroesArray[30]='H00S'
  set IntHeroesArray[31]='N00B'
  set IntHeroesArray[32]='H00U'
  set IntHeroesArray[33]='O016'
  set IntHeroesArray[34]='N0HP'
  set IntHeroesArray[35]='E02H'
  set IntHeroesArray[36]='E02J'
  set IntHeroesArray[37]='E02X'
  set IntHeroesArray[38]='H0DO'
  set IntHeroesArray[39]='N0M7'
  set IntHeroesArray[40]='N0MD'
  set IntHeroesArray[41]='H500'
  set IntHeroesArray[42]='H502'
  set IntHeroesAmount=42
  set RangeHeroesArray[1]='Orkn'//range
  set RangeHeroesArray[2]='Emoo'
  set RangeHeroesArray[3]='Emns'
  set RangeHeroesArray[4]='H004'
  set RangeHeroesArray[5]='Hjai'
  set RangeHeroesArray[6]='Uktl'
  set RangeHeroesArray[7]='Hmbr'
  set RangeHeroesArray[8]='H00K'
  set RangeHeroesArray[9]='Ntin'
  set RangeHeroesArray[10]='Nbrn'
  set RangeHeroesArray[11]='Hblm'
  set RangeHeroesArray[12]='N01A'
  set RangeHeroesArray[13]='H00A'
  set RangeHeroesArray[14]='Ulic'
  set RangeHeroesArray[15]='Ekee'
  set RangeHeroesArray[16]='UC76'
  set RangeHeroesArray[17]='UC18'
  set RangeHeroesArray[18]='UC01'
  set RangeHeroesArray[19]='UC60'
  set RangeHeroesArray[20]='H00H'
  set RangeHeroesArray[21]='Oshd'
  set RangeHeroesArray[22]='U00E'
  set RangeHeroesArray[23]='E01A'
  set RangeHeroesArray[24]='U00P'
  set RangeHeroesArray[25]='E00P'
  set RangeHeroesArray[26]='E01C'
  set RangeHeroesArray[27]='N01W'
  set RangeHeroesArray[28]='N0EG'
  set RangeHeroesArray[29]='H00S'
  set RangeHeroesArray[30]='N00B'
  set RangeHeroesArray[31]='H00U'
  set RangeHeroesArray[32]='N016'
  set RangeHeroesArray[33]='O00P'
  set RangeHeroesArray[34]='Usyl'
  set RangeHeroesArray[35]='E005'
  set RangeHeroesArray[36]='N01O'
  set RangeHeroesArray[37]='E01Y'
  set RangeHeroesArray[38]='Hvwd'
  set RangeHeroesArray[39]='EC57'
  set RangeHeroesArray[40]='Ubal'
  set RangeHeroesArray[41]='E004'
  set RangeHeroesArray[42]='EC77'
  set RangeHeroesArray[43]='Nfir'
  set RangeHeroesArray[44]='E002'
  set RangeHeroesArray[45]='H00V'
  set RangeHeroesArray[46]='N01V'
  set RangeHeroesArray[47]='H00Q'
  set RangeHeroesArray[48]='O016'
  set RangeHeroesArray[49]='N0HP'
  set RangeHeroesArray[50]='O01F'
  set RangeHeroesArray[51]='E02H'
  set RangeHeroesArray[52]='E02N'
  set RangeHeroesArray[53]='E02J'
  set RangeHeroesArray[54]='E02F'
  set RangeHeroesArray[55]='E02X'
  set RangeHeroesArray[56]='H0DO'
  set RangeHeroesArray[57]='N0MK'
  set RangeHeroesArray[58]='N0M7'
  set RangeHeroesArray[59]='H500'
  set RangeHeroesArray[60]='N0MD'
  set RangeHeroesArray[61]='KODO'
  set RangeHeroesArray[62]='H501'
  set RangeHeroesArray[63]='H502'
  set RangeHeroesArray[64]='H507'
  set RangeHeroesAmount=64
  set MeleeHeroesArray[1]='Hmkg'
  set MeleeHeroesArray[2]='H00N'
  set MeleeHeroesArray[3]='Edem'
  set MeleeHeroesArray[4]='Nbbc'
  set MeleeHeroesArray[5]='Naka'
  set MeleeHeroesArray[6]='HC49'
  set MeleeHeroesArray[7]='Huth'
  set MeleeHeroesArray[8]='Ogrh'
  set MeleeHeroesArray[9]='U006'
  set MeleeHeroesArray[10]='Eevi'
  set MeleeHeroesArray[11]='Hvsh'
  set MeleeHeroesArray[12]='EC45'
  set MeleeHeroesArray[13]='Ewar'
  set MeleeHeroesArray[14]='U000'
  set MeleeHeroesArray[15]='E01B'
  set MeleeHeroesArray[16]='H00I'
  set MeleeHeroesArray[17]='HC92'
  set MeleeHeroesArray[18]='Npbm'
  set MeleeHeroesArray[19]='Hlgr'
  set MeleeHeroesArray[20]='Harf'
  set MeleeHeroesArray[21]='H000'
  set MeleeHeroesArray[22]='H001'
  set MeleeHeroesArray[23]='Hamg'
  set MeleeHeroesArray[24]='H008'
  set MeleeHeroesArray[25]='Ucrl'
  set MeleeHeroesArray[26]='Otch'
  set MeleeHeroesArray[27]='NC00'
  set MeleeHeroesArray[28]='Udre'
  set MeleeHeroesArray[29]='UC11'
  set MeleeHeroesArray[30]='Ofar'
  set MeleeHeroesArray[31]='U00F'
  set MeleeHeroesArray[32]='U00K'
  set MeleeHeroesArray[33]='O00J'
  set MeleeHeroesArray[34]='Udea'
  set MeleeHeroesArray[35]='Opgh'
  set MeleeHeroesArray[36]='U00A'
  set MeleeHeroesArray[37]='U00C'
  set MeleeHeroesArray[38]='UC91'
  set MeleeHeroesArray[39]='UC42'
  set MeleeHeroesArray[40]='U008'
  set MeleeHeroesArray[41]='H00D'
  set MeleeHeroesArray[42]='N01I'
  set MeleeHeroesArray[43]='N00R'
  set MeleeHeroesArray[44]='H00T'
  set MeleeHeroesArray[45]='H06S'
  set MeleeHeroesArray[46]='H00R'
  set MeleeHeroesArray[47]='O015'
  set MeleeHeroesArray[48]='H071'
  set MeleeHeroesArray[49]='E02I'
  set MeleeHeroesArray[50]='N0M0'
  set MeleeHeroesArray[51]='E032'
  set MeleeHeroesArray[52]='E02K'
  set MeleeHeroesArray[53]='N0MU'
  set MeleeHeroesArray[54]='H504'
  set MeleeHeroesArray[55]='H505'
  set MeleeHeroesArray[56]='H506'
  set MeleeHeroesArray[57]='H503'
  set MeleeHeroesAmount=57
  
  call SaveUnitWinAnimation('esen',"stand 4")
  call SaveUnitWinAnimation('e00V',"stand 4")
  call SaveUnitWinAnimation('edry',"spell")
  call SaveUnitWinAnimation('e00W',"spell")
  call SaveUnitWinAnimation('ugho',"stand victory")
  call SaveUnitWinAnimation('u001',"stand victory")
  call SaveUnitWinAnimation('unec',"stand channel")
  call SaveUnitWinAnimation('u002',"stand channel")
  call SaveUnitModelScale('n00M',.4,'n00M')
  call SaveUnitModelScale('e02R',.5,'e02R')
  call SaveUnitModelScale('e02T',1.2,'e02T')
  call SaveUnitModelScale('e02S',.5,'e02S')
  call SaveUnitModelScale('e030',.5,'e030')
  call SaveUnitModelScale('n0LS',1,'n0LS')
  
  call VX8()
endfunction

function IsItemAbilityById takes integer id returns boolean
  local integer i=0
  loop
    if ItemsActiveAbilities[i]==id then
      return true
    endif
    set i=i+1
    exitwhen i>ItemsActiveAbilitiesCount
  endloop
  return false
endfunction

function AddItemActiveAbil takes integer id returns nothing
  set ItemsActiveAbilitiesCount=ItemsActiveAbilitiesCount+1
  set ItemsActiveAbilities[ItemsActiveAbilitiesCount]=id
endfunction

function InitItemActAbils takes nothing returns nothing
  call AddItemActiveAbil('A1ZW')
  call AddItemActiveAbil('A1ZW')
  call AddItemActiveAbil('A0B6')
  call AddItemActiveAbil('A0K7')
  call AddItemActiveAbil('A0T7')
  call AddItemActiveAbil('A0T8')
  call AddItemActiveAbil('A11F')
  call AddItemActiveAbil('A11H')
  call AddItemActiveAbil('A2LI')
  call AddItemActiveAbil('A11G')
  call AddItemActiveAbil('A11D')
  call AddItemActiveAbil('A0S3')
  call AddItemActiveAbil('A11E')
  call AddItemActiveAbil('A15W')
  call AddItemActiveAbil('A2HQ')
  call AddItemActiveAbil('A231')
  call AddItemActiveAbil('A2HO')
  call AddItemActiveAbil('A02O')
  call AddItemActiveAbil('A08Y')
  call AddItemActiveAbil('A08Z')
  call AddItemActiveAbil('A090')
  call AddItemActiveAbil('A092')
  call AddItemActiveAbil('AIpg')
  call AddItemActiveAbil('AItb')
  call AddItemActiveAbil('A0H6')
  call AddItemActiveAbil('A1QD')
  call AddItemActiveAbil('A1T7')
  call AddItemActiveAbil('A19M')
  call AddItemActiveAbil('A1AC')
  call AddItemActiveAbil('AChx')
  call AddItemActiveAbil('A28Y')
  call AddItemActiveAbil('AIbk')
  call AddItemActiveAbil('A1EW')
  call AddItemActiveAbil('A017')
  call AddItemActiveAbil('A0JY')
  call AddItemActiveAbil('A0FO')
  call AddItemActiveAbil('A0H7')
  call AddItemActiveAbil('A0B8')
  call AddItemActiveAbil('A1WE')
  call AddItemActiveAbil('AIxk')
  call AddItemActiveAbil('A1ZI')
  call AddItemActiveAbil('A0CK')
  call AddItemActiveAbil('A0JL')
  call AddItemActiveAbil('A1FO')
  call AddItemActiveAbil('AIda')
  call AddItemActiveAbil('A0HB')
  call AddItemActiveAbil('A0D3')
  call AddItemActiveAbil('A0DF')
  call AddItemActiveAbil('A0FD')
  call AddItemActiveAbil('A12W')
  call AddItemActiveAbil('A14A')
  call AddItemActiveAbil('A1FD')
  call AddItemActiveAbil('A1IO')
  call AddItemActiveAbil('A02W')
  call AddItemActiveAbil('A269')
  call AddItemActiveAbil('A2KG')
  call AddItemActiveAbil('A1FP')
  call AddItemActiveAbil('A0T9')
  call AddItemActiveAbil('A1Q8')
  call AddItemActiveAbil('A1MO')
  call AddItemActiveAbil('A28D')
  call AddItemActiveAbil('Aeat')
  call AddItemActiveAbil('ANTG')
  call AddItemActiveAbil('ANLS')
  call AddItemActiveAbil('A0K0')
  call AddItemActiveAbil('AIpl')
  call AddItemActiveAbil('A1WA')
  call AddItemActiveAbil('A0JT')
  call AddItemActiveAbil('AIpr')
  call AddItemActiveAbil('A02X')
  call AddItemActiveAbil('A1R5')
  call AddItemActiveAbil('AIsw')
  call AddItemActiveAbil('A206')
  call AddItemActiveAbil('A1ZH')
  call AddItemActiveAbil('A2EA')
  call AddItemActiveAbil('A2K4')
  call AddItemActiveAbil('A2K7')
  call AddItemActiveAbil('A2K1')
  call AddItemActiveAbil('A2N1')
endfunction

function isDummyAbility takes integer id returns boolean
  return id=='A0ES' or id=='A43P' or id=='A0QN' or id=='A2TH' or id=='A21F' or id=='A21G' or id=='A21H' or id=='A1S9' or id=='A24A' or id=='A24B' or id=='A1S9' or id=='A06K' or id=='A1VG' or id=='A28Q' or id=='A1WF' or id=='A0T8' or id=='A0T7' or id=='A20N' or id=='A1Z2' or id=='A1Z3' or id=='A205' or id=='A14A' or id=='A269' or id=='A2KG' or id=='A21J' or id=='A27X' or id=='A28Y' or id=='A24E' or id=='A1ZH' or id=='A1WO' or id=='A1FQ' or id=='A0TE' or id=='A2JO' or id=='A2FX' or id=='A0MP' or id=='A2KE' or id=='A2KH' or id=='A2K9' or id=='A2JL' or id=='A2O2' or id=='A2MB' or id=='A21J' or id=='A2MC' or id=='A1NH' or id=='A2LI' or id=='A2TK' or id=='A1MO' or id=='A527' or id=='A528'
endfunction

function AddDummyAbility takes integer id returns nothing
  set SomeDummyAbilitiesCounter=SomeDummyAbilitiesCounter+1
  set SomeDummyAbilitiesList[SomeDummyAbilitiesCounter]=id
endfunction

function InitDummyAbils takes nothing returns nothing
  call AddDummyAbility('A0H6')
  call AddDummyAbility('A012')
  call AddDummyAbility('A06K')
  call AddDummyAbility('A0I9')
  call AddDummyAbility('A0HA')
  call AddDummyAbility('A0K5')
  call AddDummyAbility('A0PY')
  call AddDummyAbility('A1FO')
  call AddDummyAbility('A0RT')
  call AddDummyAbility('A0SA')
  call AddDummyAbility('A0T7')
  call AddDummyAbility('A0T8')
  call AddDummyAbility('A14A')
  call AddDummyAbility('A0BE')
  call AddDummyAbility('Anh1')
  call AddDummyAbility('A1OZ')
  call AddDummyAbility('A13D')
  call AddDummyAbility('A026')
  call AddDummyAbility('A1Q8')
  call AddDummyAbility('A0QN')
endfunction

function AddItemAbility takes integer id returns nothing
  set ItemsAbilitiesMax2=ItemsAbilitiesMax2+1
  set ItemsAbilities2[ItemsAbilitiesMax2]=id
endfunction

function InitItemAbils takes nothing returns nothing
  call AddItemAbility('AImt')
  call AddItemAbility('AIda')
  call AddItemAbility('ANtm')
  call AddItemAbility('ACch')
  call AddItemAbility('AIxk')
  call AddItemAbility('A0CK')
  call AddItemAbility('A017')
  call AddItemAbility('A0B8')
  call AddItemAbility('A0HB')
  call AddItemAbility('A0D3')
  call AddItemAbility('A0DF')
  call AddItemAbility('A02W')
  call AddItemAbility('AIpr')
  call AddItemAbility('AIpl')
  call AddItemAbility('A1WA')
  call AddItemAbility('A0FO')
  call AddItemAbility('A0H7')
  call AddItemAbility('A0H6')
  call AddItemAbility('A02X')
  call AddItemAbility('AIsw')
  call AddItemAbility('A0CX')
  call AddItemAbility('A0B6')
  call AddItemAbility('Aeat')
  call AddItemAbility('A08L')
  call AddItemAbility('AIcy')
  call AddItemAbility('AIbk')
  call AddItemAbility('A0DY')
  call AddItemAbility('A0LZ')
  call AddItemAbility('A0OI')
  call AddItemAbility('A0KX')
  call AddItemAbility('A0KW')
  call AddItemAbility('A026')
  call AddItemAbility('A0C4')
  call AddItemAbility('A012')
  call AddItemAbility('A06K')
  call AddItemAbility('A02T')
  call AddItemAbility('AHfa')
  call AddItemAbility('A09V')
  call AddItemAbility('A05Y')
  call AddItemAbility('A0I9')
  call AddItemAbility('A0HA')
  call AddItemAbility('A0K5')
  call AddItemAbility('A0PY')
  call AddItemAbility('A0QN')
  call AddItemAbility('A0RT')
  call AddItemAbility('A0RP')
  call AddItemAbility('A12W')
  call AddItemAbility('A0SA')
  call AddItemAbility('A0T7')
  call AddItemAbility('A0T8')
  call AddItemAbility('A14A')
  call AddItemAbility('A0BE')
  call AddItemAbility('A21X')
  call AddItemAbility('A21W')
  call AddItemAbility('A21V')
  call AddItemAbility('A0MP')
  call AddItemAbility('A13D')
  call AddItemAbility('A0JY')
  call AddItemAbility('A15W')
  call AddItemAbility('A1FO')
  call AddItemAbility('A1FD')
  call AddItemAbility('A1OZ')
  call AddItemAbility('A1MO')
  call AddItemAbility('A1IO')
  call AddItemAbility('A1Q8')
  call AddItemAbility('A1RA')
  call AddItemAbility('A1QV')
  call AddItemAbility('A1WE')
  call AddItemAbility('A1WB')
  call AddItemAbility('A2KG')
  call AddItemAbility('A2N1')
  call AddItemAbility('ANTG')
  call AddItemAbility('ANLS')
  call AddItemAbility('A1R5')
  call AddItemAbility('A02O')
  call AddItemAbility('A08Y')
  call AddItemAbility('A08Z')
  call AddItemAbility('A090')
  call AddItemAbility('A092')
  call AddItemAbility('A449')
endfunction

function InitAbilLists takes nothing returns boolean
  call InitItemAbils()
  call InitDummyAbils()
  call InitItemActAbils()
  return false
endfunction

function InitQuests takes nothing returns nothing
  call CreateQuestBJ(0,"TRIGSTR_50004","TRIGSTR_50005","ReplaceableTextures\\CommandButtons\\BTNSpy.blp")
  call CreateQuestBJ(0,"TRIGSTR_50006","TRIGSTR_50007","ReplaceableTextures\\CommandButtons\\BTNTome.blp")
  call CreateQuestBJ(0,"TRIGSTR_50008","TRIGSTR_50009","ReplaceableTextures\\CommandButtons\\BTNAmbush.blp")
  call CreateQuestBJ(2,"TRIGSTR_50022","TRIGSTR_50023","ReplaceableTextures\\CommandButtons\\BTNSirenMirrorImage.blp")
  call CreateQuestBJ(2,"TRIGSTR_50024","TRIGSTR_50025","ReplaceableTextures\\CommandButtons\\BTNTinyGrow.blp")
  call CreateQuestBJ(2,"TRIGSTR_50020","TRIGSTR_50021","ReplaceableTextures\\CommandButtons\\BTNSlowPoison.blp")
  call CreateQuestBJ(2,"TRIGSTR_50014","TRIGSTR_50015","ReplaceableTextures\\CommandButtons\\BTNOrbOfFrost.blp")
  call CreateQuestBJ(2,"TRIGSTR_50016","TRIGSTR_50017","ReplaceableTextures\\CommandButtons\\BTNOrbOfLightning.blp")
  call CreateQuestBJ(2,"TRIGSTR_50018","TRIGSTR_50019","ReplaceableTextures\\CommandButtons\\BTNOrbOfFire.blp")
  call CreateQuestBJ(2,"TRIGSTR_50010","TRIGSTR_50011","ReplaceableTextures\\CommandButtons\\BTNSilencerSilence.blp")
  call CreateQuestBJ(2,"TRIGSTR_50012","TRIGSTR_50013","ReplaceableTextures\\CommandButtons\\BTNSpellSteal2.blp")
endfunction

function IX9 takes nothing returns boolean
  local string s
  if IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!='H00J' then
    set s=GetUnitName(GetTriggerUnit())+" "+GetObjectName('n0HB')+" "+GetObjectName(GetLearnedSkill())+" ("+GetObjectName('n0HC')+" "+I2S(GetLearnedSkillLevel())+")"
    call DisplayTimedTextToPlayer(udg_Observer1,0,0,3,s)
    call DisplayTimedTextToPlayer(udg_Observer2,0,0,3,s)
  endif
  return false
endfunction

function IY9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
  call TriggerAddCondition(t,Condition(function IX9))
  set t=null
endfunction

function GetUnitPhysicalResistance_Compute takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  local real Damage=LoadReal(HY,h,20)
  local real RealDamage=GetEventDamage()
  local real ManaShieldRatio
  call HealUnitFor(u,RealDamage)
  if GetUnitAbilityLevel(u,'BNms')>0 then //Mana Shield
    set ManaShieldRatio=GetUnitAbilityLevel(u,'A0MP')*0.5
    if GetUnitAbilityLevel(u,'A0MP')<3 then
      set ManaShieldRatio=ManaShieldRatio+.25
    endif
    call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+RealDamage*.5/ManaShieldRatio)
  endif
  set GetUnitPhysicalResistance_Result=RealDamage/Damage
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set u=null
  return false
endfunction

function GetUnitPhysicalResistance takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real Damage=RMinBJ(20,GetWidgetLife(u)/2)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function GetUnitPhysicalResistance_Compute))
  call SaveReal(HY,h,20,Damage)
  set IsRealDamage=false
  call DamageTarget(u,u,2,Damage)
  set IsRealDamage=true
  set t=null
endfunction

function IZ9 takes nothing returns nothing
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,25.,(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|c00ff0303 "+GetObjectName('n02D')+"|r")
endfunction

function IA9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player IB9=(LoadPlayerHandle(HY,h,(78)))
  local integer VT8=1
  local integer IC9
  local integer W98=GetPlayerState(IB9,PLAYER_STATE_RESOURCE_GOLD)
  if HeroHasBeenUnlocked[GetPlayerId(IB9)]==false and Mode_SO then
    if GetTriggerEvalCount(t)==1 then
      if IsPlayerAlly(GetLocalPlayer(),IB9) then
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,6,GetObjectName('n0J3'))
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,6,GetObjectName('n0JG'))
      endif
    endif
    return false
  endif
  if W98>20 then
    call SetPlayerState(IB9,PLAYER_STATE_RESOURCE_GOLD,0)
    set ReliableGold[GetPlayerId(IB9)]=0
    if IsSentinel(IB9)then
      set IC9=CountPlayersInForce(Force_Elfs)
    else
      set IC9=CountPlayersInForce(Force_Unds)
    endif
    if IsSentinel(IB9)then
      loop
        exitwhen VT8>5
        if IsPlayer(Sentinels[VT8])then
          call SetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Sentinels[VT8],PLAYER_STATE_RESOURCE_GOLD)+W98/ IC9)
        endif
        set VT8=VT8+1
      endloop
    else
      loop
        exitwhen VT8>5
        if IsPlayer(Scourges[VT8])then
          call SetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Scourges[VT8],PLAYER_STATE_RESOURCE_GOLD)+W98/ IC9)
        endif
        set VT8=VT8+1
      endloop
    endif
  endif
  set t=null
  return false
endfunction

function I39 takes player IB9 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SavePlayerHandle(HY,h,(78),(IB9))
  call TriggerRegisterTimerEvent(t,2,true)
  call TriggerAddCondition(t,Condition(function IA9))
  set t=null
endfunction

function I69 takes player p returns nothing
  local multiboarditem mbitem=MultiboardGetItem(MainMB,XK7[GetPlayerId(p)],XJ7[GetPlayerId(p)])
  call MultiboardSetItemValue(mbitem,"|c00333333"+(PlayerNames[GetPlayerId((p))])+"|r")
  call MultiboardReleaseItem(mbitem)
  set mbitem=null
endfunction

function PlayerLeave_Act1 takes nothing returns nothing
  local integer HW9=CountPlayersInForce(Force_Elfs)
  local integer HV9=CountPlayersInForce(Force_Unds)
  local integer VT8
  local integer VU8
  local string Time
  local string name
  local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  if Hero==null then
    set name=GetObjectName('n0EW')
  else
    set name=GetUnitName(Hero)
  endif
  if(SecondsForTime<10)then
    set Time=I2S(MinutesForTime)+":0"+I2S(SecondsForTime)
  else
    set Time=I2S(MinutesForTime)+":"+I2S(SecondsForTime)
  endif
  if GameEnded==false then
    set LeftAt[GetPlayerId(GetTriggerPlayer())]="|c00555555"+Time+"|r"
    call RN8(GetPlayerId(GetTriggerPlayer()),true)
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,25.,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+" ("+name+")|r|c00ff0303 "+GetObjectName('n02D')+"|r")
    if(IsSentinel(GetTriggerPlayer()))then
      set VT8=1
      set VU8=5
      loop
        exitwhen VT8>VU8
        if(Sentinels[VT8]!=GetTriggerPlayer())then
          if(IsPlayer(Sentinels[VT8]))then
            call SetPlayerAllianceStateBJ(GetTriggerPlayer(),Sentinels[VT8],4)
          endif
        endif
        set VT8=VT8+1
      endloop
    else
      set VT8=1
      set VU8=5
      loop
        exitwhen VT8>VU8
        if(Scourges[VT8]!=GetTriggerPlayer())then
          if(IsPlayer(Scourges[VT8]))then
            call SetPlayerAllianceStateBJ(GetTriggerPlayer(),Scourges[VT8],4)
          endif
        endif
        set VT8=VT8+1
      endloop
    endif
    if IsSentinel(GetTriggerPlayer())or IsScourge(GetTriggerPlayer())then
      set LeaversCounter=LeaversCounter+1
    endif
    call Traffic_RegisterData("C"+"K"+I2S(PlayerCS[GetPlayerId(GetTriggerPlayer())])+"D"+I2S(CSDenies[GetPlayerId(GetTriggerPlayer())])+"N"+I2S((LoadInteger(HY,(400+GetPlayerId(GetTriggerPlayer())),(79)))),GetPlayerId(GetTriggerPlayer()))
    set ZE7=GetTriggerPlayer()
    call ExeFunc("I19")
    if Mode_SO then
      call CL8(GetTriggerPlayer())
    endif
    set IsPlayerLeftGame[GetPlayerId(GetTriggerPlayer())]=true
    call I69(GetTriggerPlayer())
    call I39(GetTriggerPlayer())
    if LeaversCounter==2 and udg_ObserverMode==false and BL then
      call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60," ")
      call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60," ")
      call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"|c006699CC"+GetObjectName('n0FW')+"|r")
    endif
  else
    set LeftAt[GetPlayerId(GetTriggerPlayer())]="|c00555555End|r"
    call ExeFunc("I59")
  endif
  set Hero=null
endfunction

function UnitRemoveAbility2 takes unit u, integer id returns boolean
  if GetUnitAbilityLevel(u,id)>0 then
    return UnitRemoveAbility(u,id)
  endif
  return false
endfunction

function RemoveStuffFromHero takes unit Hero returns nothing
  call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A11X',false)
  call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A10U',false)
  if GetOwningPlayer(Hero)==GetLocalPlayer()then
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1," ")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1,"|c006699CC"+GetObjectName('n0GR'))
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,1," ")
  endif
  call BY8(XE,GetOwningPlayer(Hero))
  call SetUnitState(Hero,UNIT_STATE_MANA,999999)
  if FindItemByIndex(Hero,indexid_aghanimUpgrader)!=null then
    call HeroAghanim(Hero,false)
  endif
  if LoadInteger(MHT,GetHandleId(Hero),'A32D')>0 then
    call SaveInteger(MHT,GetHandleId(Hero),'A32D',0)
    call SaveBoolean(MHT,GetHandleId(Hero),'A32D',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A32D',false)
  endif
  call SetUnitInvulnerable(Hero,false)
  call UnitRemoveAbility(Hero,'A40F')
  call UnitRemoveAbility(Hero,'A42R')
  call UnitRemoveAbility(Hero,'A42Q')
  call UnitRemoveAbility(Hero,'A43N')
  call UnitRemoveAbility(Hero,'A43O')
  call UnitRemoveAbility(Hero,'A45Y')
  call UnitRemoveAbility(Hero,'A45Z')
  call UnitRemoveAbility(Hero,'B45Y')
  
  call UnitRemoveAbility(Hero,'A42S')
  call UnitRemoveAbility(Hero,'A45O')
  call UnitRemoveAbility(Hero,'A45P')
  call UnitRemoveAbility(Hero,'A45Q')
  call UnitRemoveAbility(Hero,'A45R')
  call UnitRemoveAbility(Hero,LoDBuff_AbilID[10])//phoenix's spirits
  call UnitRemoveAbility(Hero,LoDBuff_BuffID[10])
  call UnitRemoveAbility(Hero,'A40E')
  call UnitRemoveAbility(Hero,'A349')
  call UnitRemoveAbility(Hero,'A348')
  call UnitRemoveAbility(Hero,'A32F')
  call UnitRemoveAbility(Hero,'A347')
  call UnitRemoveAbility(Hero,'B32F')
  call UnitRemoveAbility(Hero,'A335')//overload
  call UnitRemoveAbility(Hero,'A334')//lifebreak
  call UnitRemoveAbility(Hero,'B08B')//overload buff
  call UnitRemoveAbility(Hero,'B083')//lifebreak buff
  call UnitRemoveAbility(Hero,'A32H')
  call UnitRemoveAbility(Hero,'A32I')
  call UnitRemoveAbility(Hero,'A32J')
  call UnitRemoveAbility(Hero,'A32K')
  call UnitRemoveAbility(Hero,'A32L')
  call UnitRemoveAbility(Hero,'A32M')
  call UnitRemoveAbility(Hero,'A32N')
  call UnitRemoveAbility(Hero,'A32O')
  call UnitRemoveAbility(Hero,'A32P')
  call UnitRemoveAbility(Hero,'A32Q')
  call UnitRemoveAbility(Hero,'A32R')
  call UnitRemoveAbility(Hero,'A32S')
  
  call UnitRemoveAbility(Hero,'A021')
  call UnitRemoveAbility(Hero,'QINV')
  call UnitRemoveAbility(Hero,'A31B')
  call UnitRemoveAbility(Hero,'A30B')
  call UnitRemoveAbility(Hero,'B30A')
  call UnitRemoveAbility(Hero,'A319')
  call UnitRemoveAbility(Hero,'A317')
  call UnitRemoveAbility(Hero,'A310')
  call UnitRemoveAbility(Hero,'A313')
  call UnitRemoveAbility(Hero,'A314')
  call UnitRemoveAbility(Hero,'A315')
  call UnitRemoveAbility(Hero,'A30B')
  call UnitRemoveAbility(Hero,'A309')
  call UnitRemoveAbility(Hero,'A305')
  call UnitRemoveAbility(Hero,'NOAT')
  call UnitRemoveAbility(Hero,'QF86')
  call UnitRemoveAbility(Hero,'A0AZ')
  call UnitRemoveAbility(Hero,'A23F')
  call UnitRemoveAbility(Hero,'A0KT')
  call UnitRemoveAbility(Hero,'A0NW')
  call UnitRemoveAbility(Hero,'A0NU')
  call UnitRemoveAbility(Hero,'A0OW')
  call UnitRemoveAbility(Hero,'A0OV')
  call UnitRemoveAbility(Hero,'A0OX')
  call UnitRemoveAbility(Hero,'A0OY')
  call UnitRemoveAbility(Hero,'A0P0')
  call UnitRemoveAbility(Hero,'A17K')
  call UnitRemoveAbility(Hero,'A0PV')
  call UnitRemoveAbility(Hero,'A0QO')
  call UnitRemoveAbility(Hero,'A0RC')
  call UnitRemoveAbility(Hero,'A0RF')
  call UnitRemoveAbility(Hero,'A228')
  call UnitRemoveAbility(Hero,'A10N')
  call UnitRemoveAbility(Hero,'A0S0')
  call UnitRemoveAbility(Hero,'A10O')
  call UnitRemoveAbility(Hero,'A10P')
  call UnitRemoveAbility(Hero,'A0NU')
  call UnitRemoveAbility(Hero,'A0NW')
  call UnitRemoveAbility(Hero,WS7)
  call UnitRemoveAbility(Hero,'A0I5')
  call UnitRemoveAbility(Hero,'A0C9')
  call UnitRemoveAbility(Hero,'A0IH')
  call UnitRemoveAbility(Hero,'B067')
  call UnitRemoveAbility(Hero,'B08L')
  call UnitRemoveAbility(Hero,'A0SR')
  call UnitRemoveAbility(Hero,'A0WO')
  call UnitRemoveAbility(Hero,'A0WR')
  call UnitRemoveAbility(Hero,'A1CN')
  call UnitRemoveAbility(Hero,'A0VH')
  call UnitRemoveAbility(Hero,'A0VJ')
  call UnitRemoveAbility(Hero,'A109')
  call UnitRemoveAbility(Hero,'A0VW')
  call UnitRemoveAbility(Hero,'A0XM')
  call UnitRemoveAbility(Hero,'A11O')
  call UnitRemoveAbility(Hero,'A11R')
  call UnitRemoveAbility(Hero,'A147')
  call UnitRemoveAbility(Hero,'A148')
  call UnitRemoveAbility(Hero,'A11U')
  call UnitRemoveAbility(Hero,'A149')
  call UnitRemoveAbility(Hero,'A121')
  call UnitRemoveAbility(Hero,'A126')
  call UnitRemoveAbility(Hero,'A179')
  call UnitRemoveAbility(Hero,'Aetl')
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[0])
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[1])
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[2])
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[3])
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[4])
  call UnitRemoveAbility(Hero,Razor_EyeOfStormContainers[5])
  call SaveBoolean(HY,(GetHandleId(Hero)),(80),(false))
  call SetUnitPathing(Hero,true)
  call PauseUnit(Hero,false)
  call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
  call SetUnitScale(Hero,U18(Hero),U18(Hero),U18(Hero))
  call UnitRemoveAbility(Hero,'A1CA')
  call UnitRemoveAbility(Hero,'A1C9')
  call UnitRemoveAbility(Hero,'A1CB')
  call UnitRemoveAbility(Hero,'A1CC')
  call UnitRemoveAbility(Hero,'A1GA')
  call UnitRemoveAbility(Hero,'A1W3')
  call UnitRemoveAbility(Hero,'B0DO')
  call UnitRemoveAbility(Hero,'A1UH')
  call UnitRemoveAbility(Hero,'A1UI')
  call UnitRemoveAbility(Hero,'A1ZA')
  call UnitRemoveAbility(Hero,'A266')
  call UnitRemoveAbility(Hero,'A265')
  call UnitRemoveAbility(Hero,'A24L')
  call UnitRemoveAbility(Hero,'B0ED')
  call UnitRemoveAbility(Hero,'A23O')
  call UnitRemoveAbility(Hero,'B0E9')
  call GD9(Hero,0)
  if GetUnitTypeId(Hero)=='E02N' or GetUnitTypeId(Hero)=='E02O' then
    call UnitRemoveAbility2(Hero,'A237')
    call UnitAddAbility(Hero,'A22B')
    call UnitRemoveAbility2(Hero,'A22B')
  endif
  call UnitRemoveAbility2(Hero,'A23F')
  set tt_unit1=Hero
  call ExeFunc("DK_DragonForm_ChangeTail")
  if LoadBoolean(MHT,GetHandleId(Hero),StringHash("morphedburn")) then
    call UnMorphUnit(Hero,LoadInteger(MHT,GetHandleId(Hero),StringHash("second")))
    call UnMorphUnit(Hero,LoadInteger(MHT,GetHandleId(Hero),StringHash("first")))
    call SaveBoolean(MHT,GetHandleId(Hero),StringHash("morphedburn"),false)
  endif
endfunction

function J79 takes nothing returns boolean
  if GetPlayerAlliance(GetOwningPlayer(GetFilterUnit()),SharedControlAlliesTempPlayer,ALLIANCE_SHARED_CONTROL) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false then
    set SharedControlAlliesCount=SharedControlAlliesCount+1
  endif
  return false
endfunction

function J89 takes unit u,player p,real x,real y,boolean J99 returns nothing
  local group g=GetAvailableGroup()
  set SharedControlAlliesCount=0
  set SharedControlAlliesTempPlayer=p
  call GroupEnumUnitsSelected(g,p,Condition(function J79))
  if SharedControlAlliesCount==0 and GetLocalPlayer()==p then
    if J99==false then
      call ClearSelection()
      call SelectUnit(u,true)
    endif
    call PanCameraToTimed(x,y,0)
  endif
  set SharedControlAlliesCount=0
  call KillGroup(g)
  set g=null
endfunction

function JD9 takes unit CE8 returns boolean
  return GetUnitTypeId(CE8)=='H00I' or GetUnitTypeId(CE8)=='H00J'
endfunction

function JE9 takes unit JF9 returns nothing
  local integer JG9
  if FindItemOfType(JF9,Item_Real[indexid_bloodstone])!=null and GetUnitTypeId(JF9)!='H00J' then
    set JG9=R2I(GetItemCharges(FindItemOfType(JF9,Item_Real[indexid_bloodstone]))*.67)
    if GetItemCharges(FindItemOfType(JF9,Item_Real[indexid_bloodstone]))==1 then
      set JG9=0
    endif
    call SetItemCharges(FindItemOfType(JF9,Item_Real[indexid_bloodstone]),JG9)
    call AddHeroXP(JF9,GetHeroXP(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(JF9))]),true)
    call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(JF9))])
  endif
endfunction

function JQ9 takes nothing returns boolean
  call CleanTrigger(GetTriggeringTrigger())
  set X77=false
  return false
endfunction

function HeroRespawn takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local real x
  local real y
  local integer c
  local integer lvl
  set IsImpossibleToBuyback[GetPlayerId(GetOwningPlayer(u))]=false
  set IsHeroDead[GetPlayerId(GetOwningPlayer(u))]=false
  if IsSentinel(GetOwningPlayer(u))then
    set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  
  if advancedTracking then
    if TimerGetRemaining(HeroRespawnTimer[GetPlayerId(p)])>2 then
      call Traffic_RegisterData("LoD_HeroResp_"+I2S(GetPlayerId(p)),1)
    else
      call Traffic_RegisterData("LoD_HeroResp_"+I2S(GetPlayerId(p)),0)
    endif
  endif
  
  call TimerStart(HeroRespawnTimer[GetPlayerId(p)],.0,false,null)
  
  call J89(u,p,x,y,false)
  call SetUnitX(u,x)
  call SetUnitY(u,y)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A344',false)
  call RemoveStuffFromHero(u)//remove stuff from respawnd hero
  call SetUnitPathing(u,true)
  if FindItemOfType(u,Item_Real[indexid_bloodstone])!=null and GetUnitTypeId(u)!='H00J' then
    set c=R2I(GetItemCharges(FindItemOfType(u,Item_Real[indexid_bloodstone]))*.67*1.)
    if GetItemCharges(FindItemOfType(u,Item_Real[indexid_bloodstone]))==1 then
      set c=0
    endif
    call SetItemCharges(FindItemOfType(u,Item_Real[indexid_bloodstone]),c)
    call AddHeroXP(u,GetHeroXP(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(u))]),true)
    call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(u))])
  endif
  if GetUnitAbilityLevel(u,'A2AI')>0 then
    call UnitRemoveAbility(u,'QF0O')
    call SetUnitAbilityLevel(u,'QB0G',GetUnitAbilityLevel(u,'A2AI'))
  endif
  call LoDStat_Set(u,0,"armourneg")
  call RemoveAbilsForUnit(u)
  set u=null
endfunction

function PreloadingSkills_AM takes nothing returns nothing
  call PreloadUnit('h06K')
endfunction

function PreloadingSkills_Viper takes nothing returns nothing
  call AddWrapper("ViperWrappers",-2)
endfunction

function PreloadingSkills_Lanaya takes nothing returns nothing
  call AddWrapper("LanayaBladesWrapper",-2)
endfunction

function PreloadingSkills_Axe takes nothing returns nothing
  call AddWrapper("AxeWrappers",-1)
endfunction

function PreloadingSkills_Riki takes nothing returns nothing
  call AddWrapper("RikiBackStabWrapper",-2)
endfunction

function PreloadingSkills_Wyvern takes nothing returns nothing
  call AddWrapper("WyvernWrapper",-2)
endfunction

function PreloadingSkills_Treant takes nothing returns nothing
  call AddWrapper("TreantInvisWrapper",-1)
endfunction

function PreloadingSkills_Lich takes nothing returns nothing
  call AddWrapper("LichFromArmorWrapper",0)
endfunction

function PreloadingSkills_Leoric takes nothing returns nothing
  call AddWrapper("LeoricLifestealWrapper",0)
endfunction

function PreloadingSkills_Void takes nothing returns nothing
  call AddWrapper("VoidBashWrapper",1)
endfunction

function PreloadingSkills_FireLord takes nothing returns nothing
  call AddWrapper("FireLord_FireshowRangedWrapper",3)
endfunction

function PreloadingSkills_Troll takes nothing returns nothing
  call AddWrapper("TrollWrapper",-2)
endfunction

function PreloadingSkills_Luna takes nothing returns nothing
  call AddWrapper("LunaGlaiveWrapper",0)
endfunction

function PreloadingSkills_Geomancer takes nothing returns nothing
  call AddWrapper("GeoStrikeWrapper",4)
endfunction

function PreloadingSkills_Huskar takes nothing returns nothing
  call AddWrapper("HuskarArrowsWrapper",4)
  call AddWrapper("HuskarBurningSpearsWrapperInit",-2)
endfunction

function PreloadingSkills_SpaceOrc takes nothing returns nothing
  call AddWrapper("OldMarksmanshipWrapper",3)
endfunction

function PreloadingSkills_SK takes nothing returns nothing
  call AddWrapper("CausticFinalWrapper",2)
endfunction

function PreloadingSkills_Spectre takes nothing returns nothing
  call AddWrapper("SpectreWrappers",-1)
  call AddWrapper("SpectreDesolateWrapper",3)
endfunction

function PreloadingSkills_OD takes nothing returns nothing
  call AddWrapper("ODOrbWrapper",3)
endfunction

function PreloadingSkills_Silencer takes nothing returns nothing
  call AddWrapper("SilencerOrbWrapper",3)
endfunction

function PreloadingSkills_Abaddon takes nothing returns nothing
  call AddWrapper("AbaFrostmourneWrapper",3)
  call AddWrapper("AbaFrostmourneWrapperOnAttack",-1)
endfunction

function PreloadingSkills_Bara takes nothing returns nothing
  call AddWrapper("BarabashWrapper",3)
endfunction

function PreloadingSkills_Slark takes nothing returns nothing
  call AddWrapper("SlarkEssenceShiftWrapper",3)
endfunction

function PreloadingSkills_Admiral takes nothing returns nothing
  call AddWrapper("TidebringerWrapper",1)
  call AddWrapper("TidebringerWrapperOnAttack",-2)
endfunction

function PreloadingSkills_Centaur takes nothing returns nothing
  call AddWrapper("CentaurReturnWrapper",-1)
endfunction

function PreloadingSkills_DK takes nothing returns nothing
  call AddWrapper("ElderDragonCorrosiveWrapper",1)
endfunction

function PreloadingSkills_ES takes nothing returns nothing
  call AddWrapper("EnchantTotemWrapper",1)
  call AddWrapper("EnchantTotemWrapperOnAttack",-2)
endfunction

function PreloadingSkills_Ench takes nothing returns nothing
  call AddWrapper("Ench_Impetus_HitWrapper",3)
endfunction

function PreloadingSkills_PL takes nothing returns nothing
  call AddWrapper("PLOnAttackWrapper",-1)
endfunction

function PreloadingSkills_LoneDruid takes nothing returns nothing
  call AddWrapper("SpiritBearDmgWrapper",3)
endfunction

function PreloadingSkills_Ursa takes nothing returns nothing
  call AddWrapper("UrsaSwipesWrapper",3)
endfunction

function PreloadingSkills_Bane takes nothing returns nothing
  call AddWrapper("BaneUltiWrapper",-1)
endfunction

function PreloadingSkills_Lifestealer takes nothing returns nothing
  call AddWrapper("LifestealerWrapper",3)
endfunction

function PreloadingSkills_Veno takes nothing returns nothing
  call AddWrapper("PoisonStingWrapper",3)
endfunction

function PreloadingSkills_WL takes nothing returns nothing
  call AddWrapper("WLFlamingFistWrapper",0)
endfunction

function PreloadingSkills_Legion takes nothing returns nothing
  call AddWrapper("MoCWrapperAdvanced",1)
  call AddWrapper("MoCWrapperOnAttack",-2)
  call AddWrapper("MoCWrapperOnAttacked",-1)
endfunction

function PreloadingSkills_Timber takes nothing returns nothing
  call AddWrapper("ShredderWrapper",-1)
endfunction

function PreloadingSkills_Sniper takes nothing returns nothing
  call AddWrapper("SniperHeadshotWrapper",2)
endfunction

function InitPreloadingSkills takes nothing returns nothing
  call SaveStr(MHT,'A1A3',600,"PreloadingSkills_Viper")
  call SaveStr(MHT,'A0RO',600,"PreloadingSkills_Lanaya")
  call SaveStr(MHT,'A0C6',600,"PreloadingSkills_Axe")
  call SaveStr(MHT,'A0DZ',600,"PreloadingSkills_Riki")
  call SaveStr(MHT,'A332',600,"PreloadingSkills_Wyvern")
  call SaveStr(MHT,'A01Z',600,"PreloadingSkills_Treant")
  call SaveStr(MHT,'A08R',600,"PreloadingSkills_Lich")
  call SaveStr(MHT,'P250',600,"PreloadingSkills_Leoric")
  call SaveStr(MHT,'A081',600,"PreloadingSkills_Void")
  call SaveStr(MHT,'A45B',600,"PreloadingSkills_FireLord")
  call SaveStr(MHT,'A0O0',600,"PreloadingSkills_Troll")
  call SaveStr(MHT,'A041',600,"PreloadingSkills_Luna")
  call SaveStr(MHT,'A0N7',600,"PreloadingSkills_Geomancer")
  call SaveStr(MHT,'A0QN',600,"PreloadingSkills_Huskar")
  call SaveStr(MHT,'A440',600,"PreloadingSkills_SpaceOrc")
  call SaveStr(MHT,'A0FA',600,"PreloadingSkills_SK")
  call SaveStr(MHT,'A0FX',600,"PreloadingSkills_Spectre")
  call SaveStr(MHT,'A0OI',600,"PreloadingSkills_OD")
  call SaveStr(MHT,'A0LZ',600,"PreloadingSkills_Silencer")
  call SaveStr(MHT,'A0MG',600,"PreloadingSkills_Abaddon")
  call SaveStr(MHT,'A0G5',600,"PreloadingSkills_Bara")
  call SaveStr(MHT,'A1HR',600,"PreloadingSkills_Slark")
  call SaveStr(MHT,'A13T',600,"PreloadingSkills_Admiral")
  call SaveStr(MHT,'A00V',600,"PreloadingSkills_Centaur")
  call SaveStr(MHT,'QM00',600,"PreloadingSkills_DK")
  call SaveStr(MHT,'A0DL',600,"PreloadingSkills_ES")
  call SaveStr(MHT,'A0DY',600,"PreloadingSkills_Ench")
  call SaveStr(MHT,'A0DB',600,"PreloadingSkills_PL")
  call SaveStr(MHT,'A0A5',600,"PreloadingSkills_LoneDruid")
  call SaveStr(MHT,'P067',600,"PreloadingSkills_Ursa")
  call SaveStr(MHT,'A02Q',600,"PreloadingSkills_Bane")
  call SaveStr(MHT,'A0SS',600,"PreloadingSkills_Lifestealer")
  call SaveStr(MHT,'A0MY',600,"PreloadingSkills_Veno")
  call SaveStr(MHT,'S008',600,"PreloadingSkills_WL")
  call SaveStr(MHT,'A2EY',600,"PreloadingSkills_Legion")
  call SaveStr(MHT,'A2E4',600,"PreloadingSkills_Timber")
  call SaveStr(MHT,'A03S',600,"PreloadingSkills_Sniper")
  
endfunction

function InitHeroAndSkillsRelated takes integer i, integer k returns nothing
  if(i==indexid_AM)then
    call PreloadUnit('h06K')
  elseif i==indexid_Formless then
    call HideAbility('A40O')
    call HideAbility('A40P')
    call HideAbility('A40Q')
    call HideAbility('A40R')
  elseif i==indexid_Kotl then
    call HideAbility('A10U')
    call HideAbility('A11X')
  elseif i==indexid_Bala then
    call ExeFunc("NIghtstalker_Passive_Global")
  elseif i==indexid_BS then
    set HeroInGame_BS=true
  elseif i==indexid_Earth then
    call ExeFunc("Kaolin_Stones_Reg")
  elseif(i==indexid_THD)then
    call ExeFunc("THD_DualBreath_Preload")
  elseif(i==indexid_Centaur)then
    call ExeFunc("Stampede_Init")
  elseif(i==indexid_ES)then
    call ExeFunc("ES_EchoSlam_Reg")
    call ExeFunc("AfterShock_Orbs") //This actually deals with Enchanted Totem, not aftershock... \:3/
  elseif(i==indexid_Enchantress)then
    call ExeFunc("KU9")
  elseif(i==indexid_Enigma)then
    call ExeFunc("KV9")
  elseif(i==indexid_Juggernaut)then
    call ExeFunc("K39")
  elseif i==indexid_BB then
    call HideAbility('A30P')
  elseif i==indexid_Medusa then
    call HideAbility('A419')
  elseif(i==indexid_Morphling)then
    call ExeFunc("MD9")
    call ExeFunc("MH9")
  elseif(i==indexid_OgreMagi)then
    call ExeFunc("MM9")//Multicast enemies
    call ExeFunc("MN9")//Multicast allies
  elseif i==indexid_Pugna then
    call HideAbility('A43W')
    call HideAbility('A43X')
    call ExeFunc("Oblivion_Ward_Summon")
  elseif(i==indexid_PL)then
    call ExeFunc("MP9")
    call ExeFunc("MR9")
  elseif(i==indexid_Sniper)then
    call ExeFunc("MB9")
  elseif(i==indexid_LoneDruid)then
    call ExeFunc("SpiritBear_Return_Init")
  elseif(i==indexid_Techies)then
    call ExeFunc("NF9")
    call ExeFunc("NG9")
  elseif(i==indexid_Bane)then
    call ExeFunc("N59")
  elseif(i==indexid_Brood)then
    call ExeFunc("OE9")
    call ExeFunc("Brood_RegisterSpinWebAppears")
  elseif(i==indexid_Pudge)then
    call ExeFunc("PG9")
  elseif(i==indexid_SK)then
    call ExeFunc("SK_Epicenter")
  elseif(i==indexid_Veno)then
    call ExeFunc("Venomancer_PlagueWard_Init")
  elseif(i==indexid_Visage)then
    call ExeFunc("Visage_Familiar_StoneForm")
    call ExeFunc("Visage_SoulAssumption_Reg")
    call ExeFunc("Visage_GravekeeperClock_Reg")
  elseif(i==indexid_Weaver)then
    call ExeFunc("Weaver_Swarm_Preload")
  elseif(i==indexid_Spectre)then
    call ExeFunc("Spectre_Dagger_Preload")
    call ExeFunc("Spectre_HauntReg")
  elseif(i==indexid_WD)then
    call ExeFunc("WD_DeathWard_Summon")
  elseif(i==indexid_DK)then
    call ExeFunc("DK_Tail_Preload")
  elseif(i==indexid_WL)then
    call ExeFunc("WL_Upheaval_Preload")
    call ExeFunc("WL_ShadowWord_Preload")
    call ExeFunc("WL_Infernal_Detect")
  elseif i==indexid_Dazzle then
    call ExeFunc("Dazzle_PoisonTouch_Preload")
  elseif i==indexid_Razor then
    call ExeFunc("Razor_EyeOfStorm_Init")
  elseif i==indexid_Pit then
    call ExeFunc("Pit_DarkRift_Preload")
  elseif i==indexid_Puck then
    call ExeFunc("Puck_PhaseShift_Init")
  elseif i==indexid_Queen then
    set HeroInGame_Queen=true
  elseif i==indexid_Slark then
    call ExeFunc("Slark_ShadowDance_Init")
  elseif i==indexid_Barathum then
    call ExeFunc("Spiritbreaker_EmpoweringHaste")
  elseif i==indexid_Lifestealer then
    call ExeFunc("Lifestealer_OpenWounds_Preload")
  elseif i==indexid_Admiral then
    call ExeFunc("Kunkka_Torrent_Preload")
  elseif i==indexid_WR then
    call ExeFunc("WR_Powershot_Endcast")
  elseif i==indexid_Batrider then
    call ExeFunc("Bat_Napalm_Preload")
  elseif i==indexid_AA then
    call ExeFunc("AA_Ulti_Preload")
  elseif i==indexid_Phoenix then
    call ExeFunc("Phoenix_Supernova_Preload")
  elseif i==indexid_Disruptor then
    call ExeFunc("Disruptor_Glimpse_Init")
  elseif i==indexid_Wisp then
    call ExeFunc("Wisp_Relocate_Init")
  elseif i==indexid_Tusk then
    call ExeFunc("Tusk_Sigil_Summon")
  elseif i==indexid_Pandaren then
    call ExeFunc("Pandaren_PrimalSplit_Summon")
  elseif i==indexid_Rubick then
    call ExeFunc("Rubick_Telekinez_Preload")
    call ExeFunc("Rubick_SpellSteal_Init")
  elseif i==indexid_Xin then
    call ExeFunc("Xin_SleightOfFist_Illusions")
    call ExeFunc("Xin_FireRemnantes_Init")
  elseif i==indexid_Legion then
    call ExeFunc("Legion_PtA_Init")
  elseif i==indexid_Skywrath then
    call ExeFunc("Skywrath_Ulti_init")
  elseif i==indexid_Timber then
    call ExeFunc("Timber_Chakram_Preload")
  elseif i==indexid_Kodo then
    call ExeFunc("Kodo_DigestAllItems")
  endif
endfunction

function V79 takes player whichPlayer,string Y38 returns nothing
  if IsPlayerInForce(GetLocalPlayer(),S58(whichPlayer))then
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,I3,40,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r "+Y38)
  endif
endfunction

function V89 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  set QM=true
  call CleanTrigger(t)
  call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_MASKED,-6950,6750,700,false,false))
  call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_MASKED,-6950,6750,700,false,false))
  set t=null
  return false
endfunction

function V99 takes unit u returns boolean
  return GetUnitTypeId(u)!='H00M' and GetUnitTypeId(u)!='H07G' and GetUnitTypeId(u)!='H00Y' and GetUnitTypeId(u)!='H00J' and GetUnitTypeId(u)!='H0B8'
endfunction

function VD9 takes nothing returns boolean
  return(IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and LoadBoolean(HY,GetHandleId(GetTriggerUnit()),TEMPEST)==false and IsUnitIllusion(GetTriggerUnit())==false and HaveSavedBoolean(HY,GetHandleId(GetTriggerUnit()),85)==false and V99(GetTriggerUnit()) and b_isPickTime==false)!=null
endfunction

function VE9 takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='n00C' then
    call RemoveUnit(GetFilterUnit())
  endif
  return false
endfunction

function VG9 takes player p returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,p,Condition(function VE9))
  call KillGroup(g)
  set g=null
endfunction

function VJ9 takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='ncop'
endfunction

function VK9 takes nothing returns nothing
  if Mode_SD then
    call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14F')
    call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14E')
    call UnitRemoveAbility(CirclesOfPower[GetPlayerId(GetOwningPlayer(GetEnumUnit()))],'A14H')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A0I4')==0 then
    call UnitAddAbility(GetEnumUnit(),'A0I4')
  endif
endfunction

function VM9 takes player p returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,p,Condition(function VJ9))
  call ForGroup(g,function VK9)
  call KillGroup(g)
  set g=null
endfunction

function UpdateSkillPickingMB_Switch takes nothing returns nothing
  local integer i=0
  local integer d=0
  local multiboarditem mi
  local integer add=0
  local string s=""
  local real width=.12
  if SentinelsIngame!=0 then
    set i=4+NumberOfExtraAbilities
    set d=1
    loop
      set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
      call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId(Sents[d])]+PlayerNames[GetPlayerId(Sents[d])]+"|r")
      call MultiboardReleaseItem(mi)
      set d=d+1
      exitwhen d==SentinelsIngame+1
    endloop
  endif
  if ScourgesIngame!=0 then
    set i=4+NumberOfExtraAbilities
    set d=2+SentinelsIngame
    loop
      set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
      call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId(Scrgs[d-1-SentinelsIngame])]+PlayerNames[GetPlayerId(Scrgs[d-1-SentinelsIngame])]+"|r")
      set d=d+1
      call MultiboardReleaseItem(mi)
      exitwhen d==SentinelsIngame+ScourgesIngame+2
    endloop
  endif
  set mi=null
endfunction

function VO9 takes nothing returns nothing
  local integer i=0
  local integer d=0
  local multiboarditem mi
  local integer add=0
  local string s=""
  local real width=.12
  set AbilityDraftMultiboard=CreateMultiboard()
  if Mode_Debug then
    set SentinelsIngame=5
    set ScourgesIngame=5
  endif
  
  call MultiboardSetRowCount(AbilityDraftMultiboard,2+SentinelsIngame+ScourgesIngame)
  call MultiboardSetColumnCount(AbilityDraftMultiboard,5+NumberOfExtraAbilities)
  call MultiboardSetItemsWidth(AbilityDraftMultiboard,.015)
  call MultiboardSetTitleText(AbilityDraftMultiboard,"-"+StringCase(ModeForTitle,true))
  call MultiboardSetItemsStyle(AbilityDraftMultiboard,false,true)
  loop
    set mi=MultiboardGetItem(AbilityDraftMultiboard,0,i)
    call MultiboardSetItemStyle(mi,true,false)
    if i==0 then
      call MultiboardSetItemWidth(mi,width)
      call MultiboardSetItemValue(mi,"|c00FF0303The Sentinel|r")
    endif
    call MultiboardReleaseItem(mi)
    set i=i+1
    exitwhen i==MultiboardGetColumnCount(AbilityDraftMultiboard)
  endloop
  set i=0
  loop
    set mi=MultiboardGetItem(AbilityDraftMultiboard,1+SentinelsIngame,i)
    call MultiboardSetItemStyle(mi,true,false)
    if i==0 then
      call MultiboardSetItemWidth(mi,width)
      call MultiboardSetItemValue(mi,"|c0020C000The Scourge|r")
    endif
    call MultiboardReleaseItem(mi)
    set i=i+1
    exitwhen i==MultiboardGetColumnCount(AbilityDraftMultiboard)
  endloop
  if SentinelsIngame!=0 then
    set i=0
    set d=1
    loop
      set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
      if i==(4+NumberOfExtraAbilities) then
        call MultiboardSetItemStyle(mi,true,false)
        call MultiboardSetItemWidth(mi,width)
        call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId((Sents[d]))]+PlayerNames[GetPlayerId((Sents[d]))]+"|r")
      else
        call MultiboardSetItemStyle(mi,false,true)
        call MultiboardSetItemIcon(mi,SkillIcon[0])
      endif
      set i=i+1
      if i>(5+NumberOfExtraAbilities) then
        set d=d+1
        set i=0
      endif
      call MultiboardReleaseItem(mi)
      exitwhen d==SentinelsIngame+1
    endloop
  endif
  if ScourgesIngame!=0 then
    set i=0
    set d=2+SentinelsIngame
    loop
      set mi=MultiboardGetItem(AbilityDraftMultiboard,d,i)
      if i==4+NumberOfExtraAbilities then
        call MultiboardSetItemStyle(mi,true,false)
        call MultiboardSetItemWidth(mi,width)
        call MultiboardSetItemValue(mi,TabTab+udg_Colors[GetPlayerId((Scrgs[d-1-SentinelsIngame]))]+PlayerNames[GetPlayerId((Scrgs[d-1-SentinelsIngame]))]+"|r")
      else
        call MultiboardSetItemStyle(mi,false,true)
        call MultiboardSetItemIcon(mi,SkillIcon[0])
      endif
      set i=i+1
      if i>(5+NumberOfExtraAbilities) then
        set d=d+1
        set i=0
      endif
      call MultiboardReleaseItem(mi)
      exitwhen d==SentinelsIngame+ScourgesIngame+2
    endloop
  endif
  call MultiboardMinimize(AbilityDraftMultiboard,false)
  call MultiboardDisplay(AbilityDraftMultiboard,true)
  set mi=null
endfunction

function VP9 takes unit u,player p returns nothing
  local integer PlayerId=GetPlayerId(p)
  local integer xx=0
  local integer learn
  local integer picked
  local integer id
  set xx=1
  loop
    if PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]!=0 then
      set picked = PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
      set id=SkillID[picked]
      set learn = EngineeringUpgradeSkillID[picked]
      call UnitAddAbility2(u,learn)
      call SetPlayerAbilityAvailable(p,learn,false)
    endif
    set xx=xx+1
    exitwhen xx>4
  endloop
endfunction

function GetCorrectIdForVisSkill takes integer id returns integer
  if id=='A40B' then
    return 'A083'
  endif
  if id=='A0FU' then
    return 'QF00'
  endif
  if id=='A0KX' then
    return 'QF87'
  endif
  if id=='A0OO' then
    return 'A302'
  endif
  if id=='A0LV' then
    return 'A46A'
  endif
  return id
endfunction

function VQ9 takes unit u,integer pid, unit tavern returns nothing
  local integer VR9=(GetUnitPointValue(u)*4)-4
  local integer xx=0
  local integer RG8
  local integer id1=VR9+1
  local integer id2=VR9+2
  local integer id3=VR9+3
  local integer id4=VR9+4
  local integer fixjump=0
  local integer array ids
  set ids[1]=VR9+1
  set ids[2]=VR9+2
  set ids[3]=VR9+3
  set ids[4]=VR9+4
  call FlushChildHashtable(HY,GetHandleId(SpellPickingDummy[pid]))
  call RemoveUnit(SpellPickingDummy[pid])
  call SetPlayerState(Player(pid),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Player(pid),PLAYER_STATE_RESOURCE_GOLD)+250)
  set SpellPickingDummy[pid]=CreateUnit(Player(pid),'hfoo',GetRectMaxX(bj_mapInitialPlayableArea),GetRectMinY(bj_mapInitialPlayableArea),.0)
  call SaveUnitHandle(HY,GetHandleId(SpellPickingDummy[pid]),0,tavern)
  set SelectedSkillHeroPointValue[pid]=GetUnitPointValue(u)
  call RemoveUnit(u)
  if Mode_Debug then
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Hero Number: "+I2S(GetUnitPointValue(u)))
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #1 number: "+I2S(id1))
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #2 number: "+I2S(id2))
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #3 number: "+I2S(id3))
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,20.,"Skill #4 number: "+I2S(id4))
  endif
  if IsSentinel(Player(pid)) then
    set RG8=1
  else
    set RG8=2
  endif
  set xx=1
  loop
    if IsAbilityDoesNotWork[VR9+xx]==false then
      set fixjump=SkillID[VR9+xx]
      set fixjump=GetCorrectIdForVisSkill(fixjump)
      call UnitAddAbility(SpellPickingDummy[pid],fixjump)
      call SetUnitAbilityLevel(SpellPickingDummy[pid],fixjump,4)
      if CheckStacking(VR9+xx,-1,"melee only",null) then
        call UnitAddAbility(SpellPickingDummy[pid],'Z020'+xx-1)
      elseif CheckStacking(VR9+xx,-1,"range only",null) then
        call UnitAddAbility(SpellPickingDummy[pid],'Z024'+xx-1)
      elseif CheckStacking(VR9+xx,-1,"melee morph",null) then
        call UnitAddAbility(SpellPickingDummy[pid],'Z030'+xx-1)
      elseif CheckStacking(VR9+xx,-1,"range morph",null) then
        call UnitAddAbility(SpellPickingDummy[pid],'Z034'+xx-1)
      endif
      
      if(isPlayerPickedAbility(Player(pid),ids[xx])==false)then
        if Mode_OS then
          if OneSkillCheckArray[RG8*OneSkillOffsetCheck+ids[xx]]==0 then
            call UnitAddAbility(SpellPickingDummy[pid],'Z000'+xx-1)
          else
            call UnitAddAbility(SpellPickingDummy[pid],'Z010'+xx-1)
          endif
        else
          call UnitAddAbility(SpellPickingDummy[pid],'Z000'+xx-1)
        endif
      else
        call UnitAddAbility(SpellPickingDummy[pid],'Z004'+xx-1)
      endif
      
      
    else
      call UnitRemoveAbility(SpellPickingDummy[pid],'Z000'-1+xx)
      call UnitAddAbility(SpellPickingDummy[pid],'Z014'-1+xx)
    endif
    set xx=xx+1
    exitwhen xx>4
  endloop
  call ClearSelectionForPlayer(Player(pid))
  call SelectUnitAddForPlayer(SpellPickingDummy[pid],Player(pid))
endfunction

function VS9 takes nothing returns nothing
  call MultiboardDisplay(MainMB,false)
  call VO9()
  call SuspendTimeOfDay(true)
  call DisableTrigger(HeroEnters)
endfunction

function SmoothLvlup_B takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  local integer lvl=LoadInteger(HY,GetHandleId(t),0)
  if lvl>0 then
    call SetHeroLevel(u,GetHeroLevel(u)+1,LoadBoolean(HY,GetHandleId(t),0))
    call SaveInteger(HY,GetHandleId(t),0,lvl-1)
  else
    call AddHeroXP(u,IMaxIF(LoadInteger(HY,GetHandleId(t),1)-GetHeroXP(u),0),LoadBoolean(HY,GetHandleId(t),0))
    call CleanTimer(t)
  endif
  set u=null
  set t=null
endfunction

function SmoothLvlup takes unit u, integer lvl, boolean visuals, integer xp returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.01,true,function SmoothLvlup_B)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveInteger(HY,GetHandleId(t),0,lvl)
  call SaveInteger(HY,GetHandleId(t),1,xp)
  call SaveBoolean(HY,GetHandleId(t),0,visuals)
  set t=null
endfunction

function HidePassivesFunctionSup takes unit u returns nothing
  local integer i=1
  local integer k
  local integer lvl
  local player p=GetOwningPlayer(u)
  local boolean b=false
  loop
    if PassivesUpgradeID[i]>0 then
      call UnitAddAbility2(u,PassivesUpgradeID[i])
      if GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])>0 then
        set lvl=GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
        call UnitRemoveAbility(u,PassivesLearningSkillUpg[i])
        call UnitAddAbility2(u,PassivesLearningSkillUpg[i])
        call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[i],lvl)
      endif
    endif
    set i=i+1
    exitwhen i>PassivesCount
  endloop
  call SetPlayerAbilityAvailable(p,'A13T',b)//tidebringer
  call SetPlayerAbilityAvailable(p,'A0MB',b)//riki's ulty
  call SetPlayerAbilityAvailable(p,'P247',b)// hunter in the night
  call SetPlayerAbilityAvailable(p,'A1IQ',b)//jinada
  if NumberOfExtraAbilities>0 then
    set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+5]])
    if k>0 then
      call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
    endif
  endif
  if NumberOfExtraAbilities>1 then
    set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]])
    if k>0 then
      call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
    endif
  endif
  set u=null
endfunction

function DM_TransferItems takes unit from, unit to returns nothing
  call UnitAddItem(to,UnitItemInSlot(from,0))
  call UnitAddItem(to,UnitItemInSlot(from,1))
  call UnitAddItem(to,UnitItemInSlot(from,2))
  call UnitAddItem(to,UnitItemInSlot(from,3))
  call UnitAddItem(to,UnitItemInSlot(from,4))
  call UnitAddItem(to,UnitItemInSlot(from,5))
endfunction

function HeroEntersMap takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local real x
  local real y
  local region r=CreateRegion()
  local player p2=p
  local item it
  local unit Hero=u
  local trigger t
  local integer xx
  local integer pid=GetPlayerId(p)
  local integer id
  local string dbg=""
  if Mode_Debug then
    call SetHeroLevel(u,25,false)
    call SetPlayerState(GetOwningPlayer(u),PLAYER_STATE_RESOURCE_GOLD,100000)
  endif
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A11X',false)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A10U',false)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34C',false)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A344',false)
  
  
  
  if s_MainMode=="ap" then
    call VP9(u,p)
  elseif s_MainMode=="sd" then
    call VP9(u,p)
  elseif s_MainMode=="md" then
    call VP9(u,p)
  elseif s_MainMode=="ar" then
    call SaveUnitHandle(HY,'hRUT',1,u)
    call ExeFunc("VV9")
    call DisplayTimedTextToPlayer(p,0,0,15,"|cff99ccff Your spells:|r")
    set xx=1
    set dbg=GetPlayerName(p)+": "
    loop
      set id=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
      if id>600 then
        call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00 (Invoker)|r")
      else
        if xx==4 or xx==6 then
          call DisplayTimedTextToPlayer(p,0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
          set dbg=dbg+GetObjectName(SkillID[id])+", "
        else
          call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
          set dbg=dbg+GetObjectName(SkillID[id])+", "
        endif
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  elseif s_MainMode=="rd"then
    call VP9(u,p)
    call DisplayTimedTextToPlayer(p,0,0,15,"|cff99ccff Your spells:|r")
    set xx=1
    loop
      set id=PlayerSkillNumber[pid*PlayerSkillOffset+xx]
      if xx==4 or xx==6 then
        call DisplayTimedTextToPlayer(p,0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
      else
        call DisplayTimedTextToPlayer(p,0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  endif
  if HidePassivesForPlayer[pid] then
    call HidePassivesFunctionSup(u)
  endif
  
  
  set PlayerHaveHero[pid]=true
  if GetUnitAbilityLevel(u,'Y253')>0 then
    call DisplayTimedTextToPlayer(p,0,0,15,"|c00ff0000Passives acquired through Devour are automatically hidden.|r")
  endif
  if Mode_DM==false then
    call GR9(GetOwningPlayer(u))
  endif
  if QM==false and(udg_Hero[GetPlayerId(Sentinels[1])]!=null and udg_Hero[GetPlayerId(Sentinels[2])]!=null and udg_Hero[GetPlayerId(Sentinels[3])]!=null and udg_Hero[GetPlayerId(Sentinels[4])]!=null and udg_Hero[GetPlayerId(Sentinels[5])]!=null and udg_Hero[GetPlayerId(Scourges[1])]!=null and udg_Hero[GetPlayerId(Scourges[2])]!=null and udg_Hero[GetPlayerId(Scourges[3])]!=null and udg_Hero[GetPlayerId(Scourges[4])]!=null and udg_Hero[GetPlayerId(Scourges[5])]!=null)then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,7,false)
    call TriggerAddCondition(t,Condition(function V89))
    set t=null
  endif
  set IsHeroDead[GetPlayerId(GetOwningPlayer((u)))]=false
  call RegionAddRect(r,Rect(-7584.,6176.,-6304.,7552.))
  if IsSentinel(GetOwningPlayer(u))then
    if IsUnitInRegion(r,u)then
      set x=GetRandomReal(GetRectMinX(gg_rct_Hero_Creation_NE),GetRectMaxX(gg_rct_Hero_Creation_NE))
      set y=GetRandomReal(GetRectMinY(gg_rct_Hero_Creation_NE),GetRectMaxY(gg_rct_Hero_Creation_NE))
    else
      set x=GetUnitX(u)
      set y=GetUnitY(u)
    endif
  else
    if IsUnitInRegion(r,u)then
      set x=GetRandomReal(GetRectMinX(gg_rct_Hero_Creation_UD),GetRectMaxX(gg_rct_Hero_Creation_UD))
      set y=GetRandomReal(GetRectMinY(gg_rct_Hero_Creation_UD),GetRectMaxY(gg_rct_Hero_Creation_UD))
    else
      set x=GetUnitX(u)
      set y=GetUnitY(u)
    endif
  endif
  set HasAlreadyPickedHero[pid]=true
  if BB7==false and Mode_CD==false then
    call PanCameraToTimedForPlayer(p,x,y,0)
  endif
  call ClearSelectionForPlayer(p)
  call SelectUnitAddForPlayer(u,p)
  call SetUnitX(u,x)
  call SetUnitY(u,y)
  set udg_Hero[pid]=u
  set HeroTypeId[pid]=GetUnitTypeId(u)
  call SaveInteger(HY,GetPlayerId(GetOwningPlayer(u)),'hHid',GetUnitPointValue(u))
  call Traffic_RegisterPlayerData(p,"9",HeroTypeId[pid])
  call VS8(p)
  call SaveBoolean(HY,(GetHandleId(u)),(85),(true))
  if Mode_DU==false and b_isPickTime==false and tt_bool1==false then
    set b_isHeroPicked[GetUnitPointValue(u)]=true
    set IsHeroIngame[GetUnitPointValue(u)]=true
    call TechHeroForAll(GetUnitTypeId(u))
  endif
  if Mode_DM then
    if IsSentinel(p)then
      set DM_LivesUsed[0]=DM_LivesUsed[0]+1
    else
      set DM_LivesUsed[1]=DM_LivesUsed[1]+1
    endif
    set OO[pid]=OO[pid]+1
    if OO[GetPlayerId(GetOwningPlayer(u))]>1 and u!=DM_PrevHero[GetPlayerId(GetOwningPlayer(u))]then
      call JE9(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])
      call SmoothLvlup(u,GetHeroLevel(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])-1,false,GetHeroXP(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))]))
      call DM_TransferItems(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))],u)
      set IsHeroIngame[GetUnitPointValue(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])]=false
      if IsSentinel(GetOwningPlayer(u)) then
        call FlushChildHashtable(MHT,'SPL0'+GetPlayerId(GetOwningPlayer(u)))
      else
        call FlushChildHashtable(MHT,'SPLH'+GetPlayerId(GetOwningPlayer(u)))
      endif
      
      call RemoveHero(DM_PrevHero[GetPlayerId(GetOwningPlayer(u))])
    endif
  endif
  if Mode_SH==false or p==PlayerModeTyper then
    if(PlayerHaveRealHero[GetPlayerId(GetOwningPlayer(u))] and Mode_SH==false)then
      call V79(p,GetObjectName('n0D5')+" "+GetUnitName(u)+".")
    elseif((HasUsedRandom[pid] and Mode_DM==false)or Mode_AR or Mode_TR)then
      call V79(p,GetObjectName('n0D3')+" "+GetUnitName(u)+".")
    else
      call V79(p,GetObjectName('n0D2')+" "+GetUnitName(u)+".")
    endif
  endif
  if NoHeroLimitOff then
    call VG9(p)
  endif
  if(BB7 or Mode_CD)and NoHeroLimitOff then
    call VG9(p)
  endif
  call VM9(p)
  if isPlayerPickedAbility(p,311)or isPlayerPickedAbility(p,263)or isPlayerPickedAbility(p,275)then
    call DisplayTimedTextToPlayer(p,0,I3,10.," ")
    call DisplayTimedTextToPlayer(p,0,I3,10.,"|c00ff0303"+GetObjectName('n0G3')+"|r")
  endif
  if isPlayerPickedAbility(p,337)then
    call DisplayTimedTextToPlayer(p,0,I3,30.," ")
    call DisplayTimedTextToPlayer(p,0,I3,30.,"|c00ff0303"+GetObjectName('n06P')+" "+GetObjectName('n06U')+"|r")
  endif
  if HaveSavedBoolean(HY,600+GetUnitPointValue(u),87)==false then
    call SaveBoolean(HY,(600+GetUnitPointValue(u)),(87),(true))
  endif
  if hhnActive[GetPlayerId(GetLocalPlayer())]==false then
    call SetPlayerName(p,(PlayerNames[GetPlayerId((p))])+" ("+UQ8(udg_Hero[pid])+")")
  endif
  call BonusDamageSystem(u)
  call RemoveRegion(r)
  set r=null
  set u=null
  set it=null
  set Hero=null
  set t=null
endfunction

function VX9 takes nothing returns boolean
  return(IsUnitType(GetSoldUnit(),UNIT_TYPE_HERO))!=null
endfunction

function TavernHeroSelected takes nothing returns nothing
  local unit Hero=GetSoldUnit()
  local unit tavern=GetSellingUnit()
  local player p=GetOwningPlayer(Hero)
  if b_isPickTime then
    call VQ9(Hero,GetPlayerId(p),tavern)
    return
  endif
  call VS8(p)
  set Hero=null
endfunction

function GoldPerSecTrigger takes nothing returns boolean
  local integer W98=1
  local integer pid
  local integer i=1
  local real time=TimerGetElapsed(GlobalTimer)
  if Mode_EM then
    set W98=2
  endif
  loop
    exitwhen i==6
    if(LoadReal(HeroStats,GetHandleId(Sentinels[i]),25)<time)then
      call SetPlayerState(Sentinels[i],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Sentinels[i],PLAYER_STATE_RESOURCE_GOLD)+W98)
    endif
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i==6
    if(LoadReal(HeroStats,GetHandleId(Scourges[i]),25)<time)then
      call SetPlayerState(Scourges[i],PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Scourges[i],PLAYER_STATE_RESOURCE_GOLD)+W98)
    endif
    set i=i+1
  endloop
  return false
endfunction

function UpdateTime takes nothing returns nothing
  local integer offset=R2I(TimerGetElapsed(GlobalTimer)-GameStartsTime)
  local integer Minutes=offset/ 60-1/ 2
  local integer Seconds=ModuloInteger(offset,60)
  if IsGameStartedAnotherBool then
    call SetTime(Minutes,Seconds,false)
  elseif ModePickedBool==false then
    set offset=R2I(16-TimerGetElapsed(GlobalTimer))
    set Minutes=offset/ 60-1/ 2
    set Seconds=ModuloInteger(offset,60)
    call SetTime(Minutes,Seconds,true)
  endif
  set MinutesForTime = Minutes
  set SecondsForTime = Seconds
endfunction

function VB9 takes nothing returns boolean
  local unit Source=GetTriggerUnit()
  local integer aid=GetSpellAbilityId()
  local integer pid=GetPlayerId(GetOwningPlayer(Source))
  local integer sid=PlayerSkillNumber[pid*PlayerSkillOffset+4]
  local integer cd=LoadInteger(UTable,aid,GetUnitAbilityLevel(Source,aid))
  if IsUnitType(Source,UNIT_TYPE_HERO) and cd > 0 then
    if aid==SkillID[sid] or (AlternateSkillID[sid]!=null and aid==AlternateSkillID[sid]) then
      call TimerStart(PrimUltiTimer[pid],cd,false,null)
    elseif NumberOfExtraAbilities>1 then
      call TimerStart(SecUltiTimer[pid],cd,false,null)
    endif
  endif
  if aid=='A02W' then//refresh
    call TimerStart(PrimUltiTimer[pid],0,false,null)
    call TimerStart(SecUltiTimer[pid],0,false,null)
  endif
  set Source=null
  return false
endfunction

function CUD takes integer id, integer cd1, integer cd2, integer cd3 returns nothing
  call SaveInteger(UTable,id,1,cd1)
  call SaveInteger(UTable,id,2,cd2)
  call SaveInteger(UTable,id,3,cd3)
endfunction

function InitUltiesCD takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer i
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function VB9))
  set t=null
  set i=0
  loop
    exitwhen(i>13)
    set PrimUltiTimer[i]=CreateTimer()
    set SecUltiTimer[i]=CreateTimer()
    set i=i+1
  endloop
  call CUD('A11K',90,80,70)
  call CUD('A0O2',80,75,70)
  call CUD('A289',45,45,45)
  call CUD('A0NS',90,80,70)
  call CUD('A0DH',110,110,110)
  call CUD('A1OB',110,110,110)
  call CUD('A0ER',100,100,100)
  call CUD('A2S8',100,100,100)
  call CUD('A0MQ',140,120,100)
  call CUD('A1B6',140,120,100)
  call CUD('A0WP',80,80,80)
  call CUD('A43D',80,80,80)
  call CUD('A1A1',100,100,100)
  call CUD('A43J',100,100,100)
  call CUD('A07Z',115,105,95)
  call CUD('A44S',115,105,95)
  call CUD('A44V',45,45,45)
  call CUD('A456',60,55,50)
  call CUD('A461',120,100,80)
  call CUD('ANcr',45,45,45)
  call CUD('QB0K',45,45,45)
  call CUD('A0Z8',70,55,40)
  call CUD('A1CV',12,12,12)
  call CUD('A03G',115,115,115)
  call CUD('QM00',115,115,115)
  call CUD('A29L',120,110,100)
  call CUD('A447',120,110,100)
  call CUD('A0QR',12,12,12)
  call CUD('A1B3',4,4,4)
  call CUD('A06R',100,90,80)
  call CUD('A1B4',90,80,70)
  call CUD('A0G4',80,70,60)
  call CUD('A1D8',20,20,20)
  call CUD('A29I',150,150,150)
  call CUD('A0E2',75,65,55)
  call CUD('A1MR',6,6,6)
  call CUD('A03O',100,100,100)
  call CUD('A40C',100,100,100)
  call CUD('A0MU',110,110,110)
  call CUD('A0A2',100,100,100)
  call CUD('A0SW',80,80,80)
  call CUD('A093',100,70,40)
  call CUD('QM02',100,70,40)
  call CUD('A03K',180,150,120)
  call CUD('DRKN',180,150,120)
  call CUD('DRKU',180,150,120)
  call CUD('A0R0',75,65,55)
  call CUD('A0FL',30,30,30)
  call CUD('A1CX',30,30,30)
  call CUD('A034',10,10,10)
  call CUD('QB0C',10,10,10)
  call CUD('QM03',75,75,75)
  call CUD('A0E3',70,70,70)
  call CUD('A04P',20,15,10)
  call CUD('A1AU',5,5,5)
  call CUD('A0M1',130,120,110)
  call CUD('A1AX',110,100,90)
  call CUD('A054',120,120,120)
  call CUD('A00U',120,120,120)
  call CUD('A0G8',80,80,80)
  call CUD('A07U',180,120,60)
  call CUD('A0KU',160,140,120)
  call CUD('A1EJ',30,30,30)
  call CUD('A0B4',10,7,5)
  call CUD('QB0D',10,7,5)
  call CUD('QF89',40,40,40)
  call CUD('A1IN',75,75,75)
  call CUD('A0J1',130,120,110)
  call CUD('A1D7',70,70,70)
  call CUD('A1MI',40,40,40)
  call CUD('A2QE',40,40,40)
  call CUD('A1AO',80,70,60)
  call CUD('A1UV',80,70,60)
  call CUD('A1NE',180,160,140)
  call CUD('A2IG',180,160,140)
  call CUD('A1AT',90,90,90)
  call CUD('QB10',100,100,100)
  call CUD('A2TI',80,80,80)
  call CUD('A2TF',20,20,20)
  call CUD('QB11',40,35,30)
  call CUD('A32G',90,80,70)
  call CUD('A33U',20,20,20)
  call CUD('A0RP',11,8,5)
  call CUD('A449',11,8,5)
  call CUD('A0LC',25,25,25)
  call CUD('A443',25,25,25)
  call CUD('A0IN',45,45,45)
  call CUD('A1AW',10,10,10)
  call CUD('A0LH',70,60,50)
  call CUD('A04Q',45,40,35)
  call CUD('A0WQ',45,45,45)
  call CUD('A09U',70,60,50)
  call CUD('A0CT',60,50,40)
  call CUD('A29J',120,110,100)
  call CUD('A07Q',120,80,40)
  call CUD('A0H9',120,120,120)
  call CUD('A013',100,100,100)
  call CUD('A0A6',100,80,60)
  call CUD('A080',80,50,30)
  call CUD('A1UZ',12,12,12)
  call CUD('A03R',90,80,70)
  call CUD('A0AV',90,80,70)
  call CUD('A0S8',85,85,85)
  call CUD('A1QP',85,85,85)
  call CUD('A0LT',160,140,120)
  call CUD('A1CS',30,30,30)
  call CUD('A11T',80,70,60)
  call CUD('A1W8',90,75,60)
  call CUD('A1W9',90,75,60)
  call CUD('A29G',120,120,120)
  call CUD('A29H',120,120,120)
  call CUD('A0L3',160,160,160)
  call CUD('A2QC',160,160,160)
  call CUD('A01P',120,90,55)
  call CUD('A09Z',120,90,55)
  call CUD('A12P',60,60,60)
  call CUD('A1D6',15,15,15)
  call CUD('A19O',90,70,50)
  call CUD('A0AK',10,10,10)
  call CUD('A1FY',10,10,10)
  call CUD('A07K',6,6,6)
  call CUD('A10Q',40,40,40)
  call CUD('A1DB',40,40,40)
  call CUD('A00H',110,110,110)
  call CUD('A0A1',110,110,110)
  call CUD('A0O5',60,60,60)
  call CUD('A1B1',60,60,60)
  call CUD('A0NT',90,90,90)
  call CUD('A0NX',90,90,90)
  call CUD('A02Q',100,100,100)
  call CUD('A1D9',100,100,100)
  call CUD('A0QK',100,100,100)
  call CUD('A073',100,100,100)
  call CUD('A03J',100,100,100)
  call CUD('A04J',100,100,100)
  call CUD('A04M',100,100,100)
  call CUD('A04N',115,115,115)
  call CUD('A095',160,100,40)
  call CUD('A09W',100,60,20)
  call CUD('A1BX',200,190,180)
  call CUD('A30L',200,190,180)
  call CUD('A05T',120,90,60)
  call CUD('A08H',120,90,60)
  call CUD('A067',100,85,70)
  call CUD('A08P',70,70,70)
  call CUD('A0CC',22,22,22)
  call CUD('A0OK',130,130,130)
  call CUD('A1VW',130,130,130)
  call CUD('A28R',120,110,100)
  call CUD('A28S',40,40,40)
  call CUD('S008',165,165,165)
  call CUD('S00U',165,165,165)
  call CUD('A1TB',90,75,60)
  call CUD('A1U6',85,85,85)
  call CUD('A30N',85,85,85)
  call CUD('A1T5',55,50,45)
  call CUD('A235',55,50,45)
  call CUD('A343',50,50,50)
  call CUD('A1RK',110,110,110)
  call CUD('A43H',110,110,110)
  call CUD('A1YQ',30,24,18)
  call CUD('A27H',20,18,16)
  call CUD('A30J',2,2,2)
  call CUD('A2BG',60,40,20)
  call CUD('A30H',20,10,0)
  call CUD('A2CI',50,50,50)
  call CUD('A2E5',8,8,8)
  call CUD('A43S',8,8,8)
  call CUD('A2O6',50,50,50)
  call CUD('A0Z0',90,80,70)
  call CUD('A504',60,50,40)
  call CUD('A503',90,80,70)
endfunction

function ReliableGoldHandling takes nothing returns boolean
  local player p
  local integer i
  local integer id
  local integer g
  set i=1
  loop
    exitwhen i>5
    set p=Sentinels[i]
    set id=GetPlayerId(p)
    set g=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
    if g<ReliableGold[id]then
      set ReliableGold[id]=g
    endif
    set p=Scourges[i]
    set id=GetPlayerId(p)
    set g=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
    if g<ReliableGold[id]then
      set ReliableGold[id]=g
    endif
    set i=i+1
  endloop
  return false
endfunction

function VL9 takes integer Source,integer Target returns boolean
  local integer i=Assists_Increment-1
  local real V19=0
  local real UK8=(TimerGetElapsed(GlobalTimer))
  local integer Count=0
  loop
    exitwhen i==Assists_Increment or V19>Assists_MaxTime or Count>200
    if i==0 then
      set i=8000-1
    endif
    set Count=Count+1
    set V19=UK8-Assists_LastTimeDamaged[i]
    if Assists_PlayerID[i]==Source and Assists_PlayerIDDamaged[i]==Target and V19<Assists_MaxTime then
      set Assists_PlayerID[i]=0
      set Assists_PlayerIDDamaged[i]=0
      return true
    endif
    set i=i-1
  endloop
  return false
endfunction

function V09 takes integer Source,integer Target returns boolean
  local integer i=Assists_Increment-1
  local real V19=0
  local real UK8=(TimerGetElapsed(GlobalTimer))
  local integer Count=0
  loop
    exitwhen i==Assists_Increment or V19>Assists_MaxTime or Count>200
    if i==0 then
      set i=8000-1
    endif
    set Count=Count+1
    set V19=UK8-Assists_LastTimeDamaged[i]
    if Assists_PlayerID[i]==Source and Assists_PlayerIDDamaged[i]==Target and V19<Assists_MaxTime then
      return true
    endif
    set i=i-1
  endloop
  return false
endfunction

function V59 takes nothing returns nothing
  local integer Source=GetPlayerId(GetOwningPlayer(GetEventDamageSource()))
  local integer Target=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  local real Damage=GetEventDamage()
  set Assists_LastTimeDamaged[Assists_Increment]=(TimerGetElapsed(GlobalTimer))
  set Assists_PlayerID[Assists_Increment]=Source
  set Assists_PlayerIDDamaged[Assists_Increment]=Target
  set Assists_Increment=Assists_Increment+1
  if Assists_Increment==8000 then
    set Assists_Increment=1
  endif
endfunction

function V29 takes unit CE8,unit W49 returns string
  local integer i=1
  local integer W79=GetPlayerId(GetOwningPlayer(CE8))
  local integer W89=GetPlayerId(GetOwningPlayer(W49))
  local integer B78
  local string W99=" "+GetObjectName('n0JY')+" "
  local boolean WD9=false
  loop
    exitwhen i>5
    if IsSentinel(GetOwningPlayer(W49))then
      set B78=GetPlayerId(Sentinels[i])
    else
      set B78=GetPlayerId(Scourges[i])
    endif
    if W89!=B78 and VL9(B78,W79)then
      set Assists[B78]=Assists[B78]+1
      call Traffic_RegisterData("Assist"+I2S(B78),W79)
      if WD9 then
        set W99=W99+"/"+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
      else
        set W99=W99+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
      endif
      set WD9=true
    endif
    set i=i+1
  endloop
  if WD9 then
    return W99
  endif
  return" "
endfunction

function WE9 takes unit CE8,unit W49 returns string
  local integer i=1
  local integer W79=GetPlayerId(GetOwningPlayer(CE8))
  local integer W89=GetPlayerId(GetOwningPlayer(W49))
  local integer B78
  local string W99=""
  local boolean WD9=false
  loop
    exitwhen i>5
    if IsSentinel(GetOwningPlayer(W49))then
      set B78=GetPlayerId(Sentinels[i])
    else
      set B78=GetPlayerId(Scourges[i])
    endif
    if W89!=B78 and V09(B78,W79)then
      if WD9 then
        set W99=W99+"/"+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
      else
        set W99=W99+udg_Colors[B78]+(PlayerNames[GetPlayerId((Player(B78)))])+"|r"
      endif
      set WD9=true
    endif
    set i=i+1
  endloop
  if WD9 then
    return W99
  endif
  return" "
endfunction

function WF9 takes unit CE8,unit W49 returns integer
  local integer i=1
  local integer W79=GetPlayerId(GetOwningPlayer(CE8))
  local integer W89=GetPlayerId(GetOwningPlayer(W49))
  local integer B78
  local integer Count=0
  loop
    exitwhen i>5
    if IsSentinel(GetOwningPlayer(W49))then
      set B78=GetPlayerId(Sentinels[i])
    else
      set B78=GetPlayerId(Scourges[i])
    endif
    if W89!=B78 and V09(B78,W79)then
      set Count=Count+1
    endif
    set i=i+1
  endloop
  return Count
endfunction

function WG9 takes unit CE8,unit W49 returns boolean
  local integer i=1
  local integer W79=GetPlayerId(GetOwningPlayer(CE8))
  local integer W89=GetPlayerId(GetOwningPlayer(W49))
  local integer B78
  local string W99=" Assists: "
  local boolean WD9=false
  local integer x=1
  set Assists_Assisters[1]=null
  set Assists_Assisters[2]=null
  set Assists_Assisters[3]=null
  set Assists_Assisters[4]=null
  set Assists_Assisters[5]=null
  loop
    exitwhen i>5
    if IsSentinel(GetOwningPlayer(W49))then
      set B78=GetPlayerId(Sentinels[i])
    else
      set B78=GetPlayerId(Scourges[i])
    endif
    if W89!=B78 and V09(B78,W79)then
      set Assists_Assisters[x]=Player(B78)
      set x=x+1
      set WD9=true
    endif
    set i=i+1
  endloop
  return WD9
endfunction

function WH9 takes unit CE8,unit W49,real W98 returns nothing
  local integer i=1
  local integer Count=0
  call WG9(CE8,W49)
  loop
    exitwhen i>5
    if Assists_Assisters[i]!=null then
      set Count=Count+1
    endif
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>5
    if Assists_Assisters[i]!=null then
      set ReliableGold[GetPlayerId(Assists_Assisters[i])]=ReliableGold[GetPlayerId(Assists_Assisters[i])]+R2I(W98/ Count)
      call DistribGoldToPlayerForUnit(Assists_Assisters[i],R2I(W98/ Count),udg_Hero[GetPlayerId(Assists_Assisters[i])])
    endif
    set i=i+1
  endloop
endfunction

function IsCreepId takes integer id returns boolean
  return id=='ugho' or id=='unec' or id=='esen' or id=='edry' or id=='u001' or id=='u002' or id=='e00V' or id=='e00W' or id=='ebal' or id=='e026' or id=='umtw' or id=='u00R'
endfunction

function CreepKilledObs takes unit u, integer pid returns nothing
  local texttag t=CreateTextTag()
  call SetTextTagText(t,"$",.027)
  call SetTextTagPosUnit(t,u,0)
  call SetTextTagColorBJ(t,PlayerColors_R[pid],PlayerColors_G[pid],PlayerColors_B[pid],15)
  call SetTextTagVelocity(t,0,.035)
  call SetTextTagFadepoint(t,3)
  call SetTextTagLifespan(t,1.5)
  call SetTextTagPermanent(t,false)
  call SetTextTagVisibility(t,GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)
  set t=null
endfunction

function CreepDenied2 takes unit u,integer pid returns nothing
  local texttag t=CreateTextTag()
  call SetTextTagText(t,"!",.03)
  call SetTextTagPosUnit(t,u,0)
  call SetTextTagColorBJ(t,PlayerColors_R[pid],PlayerColors_G[pid],PlayerColors_B[pid],15)
  call SetTextTagVelocity(t,0,.035)
  call SetTextTagFadepoint(t,3)
  call SetTextTagLifespan(t,1.5)
  call SetTextTagPermanent(t,false)
  call SetTextTagVisibility(t,CSONStatus2[GetPlayerId(GetLocalPlayer())] or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)))
  set t=null
endfunction

function CreepDeath takes unit killer, unit victim returns nothing
  local integer id=GetUnitTypeId(victim)
  local integer pid=GetPlayerId(GetOwningPlayer(killer))
  if GetOwningPlayer(victim)==Neutrals then
    set CSNeutrals[pid]=CSNeutrals[pid]+1
    call SaveInteger(HY,400+pid,79,LoadInteger(HY,400+pid,79)+1)
  else
    if IsCreepId(id) and (GetOwningPlayer(victim)==Sentinels[0] or GetOwningPlayer(victim)==Scourges[0]) then
      if IsUnitAlly(victim,GetOwningPlayer(killer)) then
        set CSDenies[pid]=CSDenies[pid]+1
        call CreepDenied2(victim,pid)
      else
        set PlayerCS[pid]=PlayerCS[pid]+1
        if udg_ObserverMode and IsPlayerBelongToTeams(GetOwningPlayer(killer)) then
          call CreepKilledObs(victim,pid)
        endif
      endif
    endif
  endif
endfunction

function WK9 takes integer i returns nothing
  local integer x=1
  local integer y=1
  set Revive_WhichHero[i]=null
  set Revive_When[i]=0
  set Revive_isShallowGrave[i]=false
  loop
    exitwhen y>Revive_InQueue
    if Revive_When[y]!=0 then
      set Revive_TempUArray[x]=Revive_WhichHero[y]
      set Revive_TempRArray[x]=Revive_When[y]
      set Revive_TempBArray[x]=Revive_isShallowGrave[y]
      set Revive_WhichHero[y]=null
      set Revive_When[y]=0
      set Revive_isShallowGrave[y]=false
      set x=x+1
    endif
    set y=y+1
  endloop
  set Revive_InQueue=x-1
  set x=1
  loop
    exitwhen x>Revive_InQueue
    set Revive_WhichHero[x]=Revive_TempUArray[x]
    set Revive_When[x]=Revive_TempRArray[x]
    set Revive_isShallowGrave[x]=Revive_TempBArray[x]
    set x=x+1
  endloop
endfunction

function WM9 takes unit CE8 returns boolean
  return GetUnitTypeId(CE8)=='H00I' or GetUnitTypeId(CE8)=='H00J'
endfunction

function WO9 takes unit u2 returns boolean
  local integer i=0
  local integer h=GetHandleId(GetOwningPlayer(u2))
  local unit u=LoadUnitHandle(HY,h,699)
  loop
    exitwhen i>5
    if GetItemTypeId(UnitItemInSlot(u,i))==Item_Real[indexid_Aegis]and GetItemCharges(UnitItemInSlot(u,i))>0 then
      set u=null
      return true
    endif
    set i=i+1
  endloop
  set u=null
  return false
endfunction

function WP9 takes unit CE8,location WQ9 returns nothing
  local integer h=GetHandleId(GetOwningPlayer(CE8))
  local unit JJ9=(LoadUnitHandle(HY,h,(699)))
  local unit JK9=(LoadUnitHandle(HY,h,(700)))
  local unit JM9=(LoadUnitHandle(HY,h,(701)))
  local unit JN9=(LoadUnitHandle(HY,h,(702)))
  local unit JO9=(LoadUnitHandle(HY,h,(703)))
  if JJ9!=null then
    call ReviveHeroLoc(JJ9,WQ9,true)
    call RemoveStuffFromHero(JJ9)
  endif
  if JK9!=null then
    call ReviveHeroLoc(JK9,WQ9,true)
    call RemoveStuffFromHero(JK9)
  endif
  if JM9!=null then
    call ReviveHeroLoc(JM9,WQ9,true)
    call RemoveStuffFromHero(JM9)
  endif
  if JN9!=null then
    call ReviveHeroLoc(JN9,WQ9,true)
    call RemoveStuffFromHero(JN9)
  endif
  if JO9!=null then
    call ReviveHeroLoc(JO9,WQ9,true)
    call RemoveStuffFromHero(JO9)
  endif
  set JJ9=null
  set JK9=null
  set JM9=null
  set JN9=null
  set JO9=null
endfunction

function WR9 takes unit Hero,real Time,boolean WS9 returns nothing
  set Revive_InQueue=Revive_InQueue+1
  set Revive_WhichHero[Revive_InQueue]=Hero
  set Revive_When[Revive_InQueue]=(TimerGetElapsed(GlobalTimer))+Time
  set Revive_isShallowGrave[Revive_InQueue]=WS9
endfunction

function ShoppingGarbage takes nothing returns boolean
  if GetItemPlayer(GetFilterItem())==Player(15) then
    call RemoveItem(GetFilterItem())
  endif
  return false
endfunction

function ShoppingClear takes nothing returns nothing
  call EnumItemsInRect(ShoppingSquare,Filter(function ShoppingGarbage),null)
endfunction

function GetItemGoldCostById takes integer id returns integer
  local integer gold
  local integer Diff
  if HaveSavedInteger(ItemCosts,id,'GOLD')==false then
    set gold=GetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD)
    set Diff=50000
    call SetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD,Diff)
    call AddItemToStock(ShoppingUnit,id,1,1)
    call IssueImmediateOrderById(ShoppingUnit,id)
    set Diff = Diff - GetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD)
    call SetPlayerState(Player(15),PLAYER_STATE_RESOURCE_GOLD,gold)
    call SaveInteger(ItemCosts,id,'GOLD',Diff)
    call ShoppingClear()
  else
    set Diff=LoadInteger(ItemCosts,id,'GOLD')
  endif
  return Diff
endfunction

function GetUnitItemsCost takes unit u returns integer
  local integer i=0
  local integer summ=0
  local item it
  loop
    set it=UnitItemInSlot(u,i)
    if it!=null then
      set summ=summ+GetItemGoldCostById(GetItemTypeId(it))
    endif
    set i=i+1
    exitwhen i>5
  endloop
  set it=null
  return summ
endfunction

function NetWorthTT takes integer nw, unit circle returns nothing
  local texttag tt
  local integer h
  local integer hu=GetHandleId(circle)
  local integer id=GetPlayerId(GetOwningPlayer(circle))
  if HaveSavedHandle(HY,hu,'netw') then
    set tt=LoadTextTagHandle(HY,hu,'netw')
  else
    set tt=CreateTextTag()
    call SetTextTagPosUnit(tt,circle,0)
    call SetTextTagVelocity(tt,0,0)
    call SetTextTagPermanent(tt,true)
    call SaveTextTagHandle(HY,hu,'netw',tt)
  endif
  call SetTextTagText(tt,I2S(nw),0.025)
  call SetTextTagVisibility(tt,IsUnitAlly(circle,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
  if DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[id]))*50+50 > GetPlayerState(GetOwningPlayer(circle),PLAYER_STATE_RESOURCE_GOLD) or IsImpossibleToBuyback[id] or BuybackID[id]=='h0D4' then
    call SetTextTagColor(tt,255,75,0,255)
  else
    call SetTextTagColor(tt,255,220,0,255)
  endif
  set tt=null
endfunction

function ShoppingNetworthsCount takes nothing returns nothing
  local integer i=1
  local integer pid
  local player p
  local integer cost
  loop
    set cost=0
    set p=Sentinels[i]
    if IsPlayerExisted(p) then
      set pid=GetPlayerId(p)
      if NetWorthRecount[pid] then
        if udg_Hero[pid]!=null then
          set cost=cost+GetUnitItemsCost(udg_Hero[pid])
          set cost=cost+GetUnitItemsCost(CirclesOfPower[pid])
        endif
        if HaveSavedHandle(HY,GetHandleId(p),333) then//spirit bear exists
          set cost=cost+GetUnitItemsCost(LoadUnitHandle(HY,GetHandleId(p),333))
        endif
        set NetWorthRecount[pid]=false
        set NetWorthsNoGold[pid]=cost
      else
        set cost=NetWorthsNoGold[pid]
      endif
      set NetWorths[pid]=cost+GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
      call NetWorthTT(NetWorths[pid],CirclesOfPower[pid])
    endif
    
    set cost=0
    set p=Scourges[i]
    if IsPlayerExisted(p) then
      set pid=GetPlayerId(p)
      if NetWorthRecount[pid] then
        if udg_Hero[pid]!=null then
          set cost=cost+GetUnitItemsCost(udg_Hero[pid])
          set cost=cost+GetUnitItemsCost(CirclesOfPower[pid])
        endif
        if HaveSavedHandle(HY,GetHandleId(p),333) then//spirit bear exists
          set cost=cost+GetUnitItemsCost(LoadUnitHandle(HY,GetHandleId(p),333))
        endif
        set NetWorthRecount[pid]=false
        set NetWorthsNoGold[pid]=cost
      else
        set cost=NetWorthsNoGold[pid]
      endif
      set NetWorths[pid]=cost+GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
      call NetWorthTT(NetWorths[pid],CirclesOfPower[pid])
    endif
    set i=i+1
    exitwhen i>5
  endloop
endfunction

function InitShopping takes nothing returns nothing
  set ShoppingSquare=Rect(6592,-7872,7392,-7264)
  set ShoppingUnit=CreateUnit(Player(15),'nshe',GetRectCenterX(ShoppingSquare),GetRectCenterY(ShoppingSquare),0)
  call UnitAddAbility(ShoppingUnit,'Asid')
  call UnitRemoveAbility(ShoppingUnit,'Amov')
  call UnitAddAbility(ShoppingUnit,'Aloc')
  call SetUnitX(ShoppingUnit,GetRectCenterX(ShoppingSquare))
  call SetUnitY(ShoppingUnit,GetRectCenterY(ShoppingSquare))
  call ShowUnit(ShoppingUnit,false)
  set ShoppingPeriodic=CreateTimer()
  call TimerStart(ShoppingPeriodic,1,true,function ShoppingNetworthsCount)
endfunction

function WT9 takes integer i returns nothing
  local unit CE8=Revive_WhichHero[i]
  local boolean WS9=Revive_isShallowGrave[i]
  local player WU9=GetOwningPlayer(CE8)
  local location WQ9
  if IsScourge(WU9)then
    set WQ9=GetRectCenter(gg_rct_Hero_Creation_UD)
  else
    set WQ9=GetRectCenter(gg_rct_Hero_Creation_NE)
  endif
  if GameEnded==false and IsDead(CE8)then
    call J89(CE8,WU9,GetLocationX(WQ9),GetLocationY(WQ9),true)
    call ReviveHeroLoc(CE8,WQ9,true)
    call SetUnitState(CE8,UNIT_STATE_MANA,GetUnitState(CE8,UNIT_STATE_MAX_MANA))
  endif
  call RemoveLocation(WQ9)
  call WK9(i)
  set CE8=null
  set WU9=null
  set WQ9=null
endfunction

function RevivingQueue takes nothing returns boolean
  local real r=TimerGetElapsed(GlobalTimer)
  local integer i
  set i=1
  loop
    exitwhen i>Revive_InQueue
    if Revive_When[i]<r and Revive_When[i]!=0 then
      call WT9(i)
    endif
    if Revive_When[i]!=0 and IsDead(Revive_WhichHero[i])==false then
      call WK9(i)
    endif
    set i=i+1
  endloop
  return false
endfunction

function WW9 takes unit killer,unit victim returns nothing
  if DistanceBetweenUnits(killer,victim)>1200 or(IsDead(killer)and GetUnitAbilityLevel(killer,'A06B')>0)then
    call AddHeroXP(killer,GetHeroExpReward(victim),true)
  endif
endfunction

function WZ9 takes nothing returns boolean
  if(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false then
    if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_BSCheck))and FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone])!=null then
      call SetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone]),GetItemCharges(FindItemOfType(GetFilterUnit(),Item_Real[indexid_bloodstone]))+1)
    endif
  endif
  return false
endfunction

function WA9 takes nothing returns boolean
  local item i
  local integer charges
  if TempInt_UrnsCount==0 and(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_UrnCheck))then
    set i = FindItemOfType(GetFilterUnit(),Item_Real[indexid_UrnOfShadows])
    if i!=null then
      set TempInt_UrnsCount=TempInt_UrnsCount+1
      set charges=GetItemCharges(i)
      if charges==0 then
        set charges=2
      else
        set charges=charges+1
      endif
      call SetItemCharges(i,charges)
    endif
    set i = null
  endif
  set i=null
  return false
endfunction

function WB9 takes unit u returns nothing
  local group g=GetAvailableGroup()
  set TempUnit_BSCheck=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1625,Condition(function WZ9))
  call KillGroup(g)
  set g=null
endfunction

function WC9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit W39=(LoadUnitHandle(HY,h,(335)))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real x
  local real y
  local real a
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerUnit()!=W39 then
      call KillUnit(W39)
    endif
  else
    set a=GetUnitFacing(Target)*bj_RADTODEG
    set x=GetUnitX(Target)+75
    set y=GetUnitY(Target)+75
    call SetUnitX(W39,x)
    call SetUnitY(W39,y)
    call IssueTargetOrderById(W39,851983,Target)
  endif
  set t=null
  set W39=null
  set Target=null
  return false
endfunction

function W69 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit W39
  if GetSummoningUnit()==Caster then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set W39=GetSummonedUnit()
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterDeathEvent(t,W39)
    call TriggerRegisterDeathEvent(t,Target)
    call TriggerRegisterTimerEvent(t,.05,true)
    call TriggerAddCondition(t,Condition(function WC9))
    call SaveUnitHandle(HY,h,(335),(W39))
    call SaveUnitHandle(HY,h,17,(Target))
    call UnitAddAbility(W39,'Aloc')
    call SetUnitPosition(W39,GetUnitX(Target)+100,GetUnitY(Target)+100)
    call IssueTargetOrderById(W39,851983,Target)
    call SetUnitMoveSpeed(W39,522)
  endif
  set t=null
  set Target=null
  set Source=null
  set Caster=null
  set W39=null
  return false
endfunction

function WL9 takes unit Source,unit W19 returns nothing
  local unit Target=W19
  local unit Caster
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  if WC8(Target)then
    set Target=(udg_Hero[GetPlayerId(GetOwningPlayer((Target)))])
  endif
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function W69))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call UnitAddAbility2(Caster,'A2E7')
  call IssueTargetOrderById(Caster,852274,Target)
  set t=null
  set Target=null
  set Caster=null
endfunction

function W09 takes nothing returns boolean
  if(AliveNonBuildOrMarker(GetFilterUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitIllusion(GetFilterUnit())==false then
    if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TempUnit_BSCheck))==false and FindItemOfType(GetFilterUnit(),Item_Real[indexid_BladeOfTheReaper])!=null then
    endif
  endif
  return false
endfunction

function W59 takes unit u returns nothing
  local group g=GetAvailableGroup()
  set TempUnit_BSCheck=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1625,Condition(function W09))
  call KillGroup(g)
  set g=null
endfunction

function W29 takes unit u returns nothing
  local group g=GetAvailableGroup()
  set TempInt_UrnsCount=0
  set TempUnit_UrnCheck=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1425,Condition(function WA9))
  call KillGroup(g)
  set TempInt_UrnsCount=0
  set g=null
endfunction

function X49 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer X79=(LoadInteger(HY,h,(88)))
  local integer i=1
  local player p
  local string TR8
  loop
    exitwhen i>5
    if X79==0 then
      set p=Sentinels[i]
      set TR8=udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n03N')+"|r "+GetObjectName('n03P')+" "+udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n03Q')+"|r"
    else
      set p=Scourges[i]
      set TR8=udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n03O')+"|r "+GetObjectName('n03P')+" "+udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n03Q')+"|r"
    endif
    call DisplayTimedTextToPlayer(p,0,0,10,TR8)
    call BY8(Sounds_Ownage,p)
    set i=i+1
  endloop
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set p=null
  return false
endfunction

function X89 takes integer X79 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1.5,false)
  call TriggerAddCondition(t,Condition(function X49))
  call SaveInteger(HY,h,(88),(X79))
  set t=null
endfunction

function X99 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer XD9=(LoadInteger(HY,h,(89)))
  local string TR8=(LoadStr(HY,h,(90)))
  local integer PlayerId=LoadInteger(HY,'0SND','0PID')
  if XD9==1 then
    call BX8(Sounds_DK)
  elseif XD9==2 then
    call BX8(Sounds_TrippleKill)
  elseif XD9==3 then
    call BX8(Sounds_UltraKill)
  elseif XD9==4 then
    call BX8(Sounds_Rampage)
  endif
  call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],TR8)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function XE9 takes string TR8,integer XD9 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1.5,false)
  call TriggerAddCondition(t,Condition(function X99))
  call SaveStr(HY,h,(90),(TR8))
  call SaveInteger(HY,h,(89),(XD9))
  set t=null
endfunction

function XF9 takes player C98,integer CD8 returns nothing
  local integer VT8=1
  local integer IC9
  if IsSentinel(C98)then
    set IC9=CountPlayersInForce(Force_Elfs)
  else
    set IC9=CountPlayersInForce(Force_Unds)
  endif
  if IsSentinel(C98)then
    loop
      exitwhen VT8>5
      if IsPlayer(Sentinels[VT8])then
        set ReliableGold[GetPlayerId(Sentinels[VT8])]=ReliableGold[GetPlayerId(Sentinels[VT8])]+CD8/ IC9
        call DistribGoldToPlayerForUnit(Sentinels[VT8],CD8/ IC9,udg_Hero[GetPlayerId(Sentinels[VT8])])
      endif
      set VT8=VT8+1
    endloop
  else
    loop
      exitwhen VT8>5
      if IsPlayer(Scourges[VT8])then
        set ReliableGold[GetPlayerId(Scourges[VT8])]=ReliableGold[GetPlayerId(Scourges[VT8])]+CD8/ IC9
        call DistribGoldToPlayerForUnit(Scourges[VT8],CD8/ IC9,udg_Hero[GetPlayerId(Scourges[VT8])])
      endif
      set VT8=VT8+1
    endloop
  endif
endfunction

function XG9 takes unit CE8,integer XH9 returns nothing
  local player WU9=GetOwningPlayer(CE8)
  call SetPlayerState(WU9,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(WU9,PLAYER_STATE_RESOURCE_GOLD)-XH9)
  set WU9=null
endfunction

function XI9 takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='o003' then
    call KillUnit(GetFilterUnit())
    return true
  endif
  return false
endfunction

function XJ9 takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function XI9))
  call KillGroup(g)
  set g=null
endfunction

function XM9 takes unit W49,player WU9,player C98 returns boolean
  return W49==null or(IsSentinel(WU9)and IsSentinel(C98))or(IsScourge(WU9)and IsScourge(C98))
endfunction

function XN9 takes nothing returns nothing
  if(GetUnitTypeId((GetEnumUnit()))=='H00J')==false then
    set AssistersAllGlobalCounter=AssistersAllGlobalCounter+1
    if GetOwningPlayer(GetKillingUnit())!=GetOwningPlayer(GetEnumUnit())then
      set AssistersAllWOKillerGlobalCounter=AssistersAllWOKillerGlobalCounter+1
    endif
  endif
endfunction

function XO9 takes nothing returns nothing
  if(GetUnitTypeId((GetEnumUnit()))=='H00J')==false then
    call AddHeroXP(GetEnumUnit(),AssistBonusesExpGlobal,true)
    set AssistsBonusExpCounter[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=AssistsBonusExpCounter[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+AssistBonusesExpGlobal
    if GetOwningPlayer(GetKillingUnit())!=GetOwningPlayer(GetEnumUnit())then
      set AssistsBonusGoldCounter[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=AssistsBonusGoldCounter[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+AssistBonusesGoldGlobal
      set ReliableGold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=ReliableGold[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]+AssistBonusesGoldGlobal
      call DistribGoldToPlayerForUnit(GetOwningPlayer(GetEnumUnit()),AssistBonusesGoldGlobal,GetEnumUnit())
    endif
  endif
endfunction

function GetTeamXP takes integer id returns integer//0 for sent, else for scourges
  local integer i=1
  local integer xp=0
  if id==0 then
    loop
      set xp=xp+GetHeroXP(udg_Hero[GetPlayerId(Sentinels[i])])
      set i=i+1
      exitwhen i>5
    endloop
  else
    loop
      set xp=xp+GetHeroXP(udg_Hero[GetPlayerId(Scourges[i])])
      set i=i+1
      exitwhen i>5
    endloop
  endif
  return xp
endfunction

function GetTeamNW takes integer id returns integer//0 for sent, else for scourges
  local integer i=1
  local integer value=0
  if id==0 then
    loop
      set value=value+NetWorths[GetPlayerId(Sentinels[i])]
      set i=i+1
      exitwhen i>5
    endloop
  else
    loop
      set value=value+NetWorths[GetPlayerId(Scourges[i])]
      set i=i+1
      exitwhen i>5
    endloop
  endif
  return value
endfunction

function AssistBonusesDistrib takes nothing returns boolean
  local integer Level
  local integer xpbonus=0
  local integer gbonus=0
  local group g
  local integer xpally
  local integer xpenemy
  local real xpdiff
  local real xpfactor
  local integer xp
  local unit u=GetTriggerUnit()
  local integer VictimNW
  local integer EnemyTeamNW
  local integer AlliedTeamNW
  local real NWDifference
  local real NWFactor
  if IsUnitType(u,UNIT_TYPE_HERO) and IsUnitIllusion(u)==false and (GetUnitTypeId(u)=='H00J')==false and LoadBoolean(HY,GetHandleId(u),TEMPEST)==false then
    set Level=GetHeroLevel(u)
    set xp=GetHeroXP(u)
    set AssistBonusesExpGlobal=0
    set AssistBonusesGoldGlobal=0
    set g=GetAvailableGroup()
    set AssistersAllGlobalCounter=0
    set AssistersAllWOKillerGlobalCounter=0
    call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1225,Condition(function D89))
    call ForGroup(g,function XN9)
    if IsScourge(GetOwningPlayer(u)) then
      set xpally=GetTeamXP(1)
      set xpenemy=GetTeamXP(0)
      set AlliedTeamNW=GetTeamNW(1)
      set EnemyTeamNW=GetTeamNW(0)
    else
      set xpally=GetTeamXP(0)
      set xpenemy=GetTeamXP(1)
      set AlliedTeamNW=GetTeamNW(0)
      set EnemyTeamNW=GetTeamNW(1)
    endif
    set xpdiff=RMaxIF((xpenemy - xpally)/IMaxIF(xpenemy + xpally,1),0)
    set xpfactor=xpdiff*xp
    if AssistersAllGlobalCounter==1 then
      set xpbonus=20*Level+R2I(xpfactor*0.23)
    elseif AssistersAllGlobalCounter==2 then
      set xpbonus=15*Level+R2I(xpfactor*0.23)
    elseif AssistersAllGlobalCounter==3 then
      set xpbonus=10*Level+R2I(xpfactor*0.2)
    elseif AssistersAllGlobalCounter==4 then
      set xpbonus=7*Level+R2I(xpfactor*0.15)
    elseif AssistersAllGlobalCounter==5 then
      set xpbonus=5*Level+R2I(xpfactor*0.12)
    endif
    set VictimNW=NetWorths[GetPlayerId(GetOwningPlayer(u))]
    set NWDifference=RMinIF(RMaxIF((EnemyTeamNW/IMaxIF(AlliedTeamNW,1))-1,0),1)
    set NWFactor=NWDifference*VictimNW
    if AssistersAllWOKillerGlobalCounter==1 then
      set gbonus=40+7*Level+R2I(NWFactor*0.05)
    elseif AssistersAllWOKillerGlobalCounter==2 then
      set gbonus=30+6*Level+R2I(NWFactor*0.05)
    elseif AssistersAllWOKillerGlobalCounter==3 then
      set gbonus=20+5*Level+R2I(NWFactor*0.05)
    elseif AssistersAllWOKillerGlobalCounter==4 then
      set gbonus=10+4*Level+R2I(NWFactor*0.04)
    elseif AssistersAllWOKillerGlobalCounter==5 then
      set gbonus=10+4*Level+R2I(NWFactor*0.03)
    endif
    set AssistBonusesExpGlobal=xpbonus
    set AssistBonusesGoldGlobal=gbonus
    call ForGroup(g,function XO9)
    call KillGroup(g)
    set g=null
  endif
  set u=null
  return false
endfunction

function ResetMultikillTimer takes nothing returns nothing
  set MultikillCounter[LoadInteger(HY,GetHandleId(GetExpiredTimer()),0)]=0
endfunction

function HeroDeath takes nothing returns nothing
  local boolean isNonPvsPKill=false
  local unit Victim=GetDyingUnit()
  local unit Killer=GetKillingUnit()
  local player PKiller=GetOwningPlayer(Killer)
  local player PVictim=GetOwningPlayer(Victim)
  local integer pidk
  local integer pidv
  local integer GoldReward=0
  local integer GoldPenalty=0
  local boolean isKillerBelongToPlayers=false
  local string tmpStoppedStreakString=""
  local string tmpStreakString=""
  local string assistsStringVar=""
  local integer tmpCurStreakOfKiller
  local string DyingPlayerName
  local string KillingPlayerName
  local string resultingStrngOfKill
  local string GoldRewardStr
  local boolean ShallowGraveStatus=false
  local real ShallowGraveRespTimeMultiplier=1
  local real TechiesSuicideRespTimeMultiplier=1
  local real BloodstoneRespTimeBonus=0
  local integer ReaperScytheFine=0
  local trigger t
  local real RespTime
  local integer AssistantCounter
  local integer unittypeId
  local integer DyingUnitOwnerGold=GetPlayerState(PVictim,PLAYER_STATE_RESOURCE_GOLD)
  local integer DyingUnitOwnerUnreliableGold=DyingUnitOwnerGold-ReliableGold[GetPlayerId(PVictim)]
  local unit tmpKillingUnit
  local unit tmpDyingUnit
  local string Y99
  local boolean KilledByReaper=LoadInteger(HY,GetHandleId(Victim),4418)==1
  local item it
  if KilledByReaper then
    set IsImpossibleToBuyback[GetPlayerId(PVictim)]=true
  endif
  if LoadInteger(HY,GetHandleId(Victim),4333)==1 then
    set Killer=udg_Hero[GetPlayerId(LoadPlayerHandle(HY,GetHandleId(Victim),4333))]
    set PKiller=GetOwningPlayer(Killer)
    set ReaperScytheFine=30
  endif
  if Killer==null and LoadInteger(HY,GetHandleId(Victim),4500)==1 then
    set Killer=OH8
    set PKiller=GetOwningPlayer(Killer)
  endif
  set AssistantCounter=WF9(Victim,Killer)
  if Killer!=null then
    set unittypeId=GetUnitTypeId(Killer)
    call WW9(udg_Hero[GetPlayerId(GetOwningPlayer(Killer))],Victim)
  endif
  if IsPlayerAlly(PKiller,PVictim)==true and((LoadInteger(HY,GetHandleId(Killer),4328))==1)==true and unit_WinterCurseCaster!=null then
    set Killer=unit_WinterCurseCaster
    set PKiller=GetOwningPlayer(Killer)
  endif
  if XM9(Killer,PVictim,PKiller)==false and AssistantCounter==1 and IsPlayerBelongToTeams(PKiller)==false and PKiller!=Neutrals then
    call WG9(Victim,Killer)
    set PKiller=Assists_Assisters[1]
    set Killer=udg_Hero[GetPlayerId(PKiller)]
  endif
  set IsHeroDead[GetPlayerId(GetOwningPlayer(Victim))]=true
  if PKiller==null then
    set PKiller=PVictim
  endif
  if GetUnitAbilityLevel(Killer,'Aloc')>0 then
    set Killer=udg_Hero[GetPlayerId(PKiller)]
  endif
  if IsPlayerEnemy(PKiller,PVictim) and PKiller!=Player(12) then//if enemy and non-neutrals
    call AssistBonusesDistrib()
  endif
  if Mode_ID and GetUnitTypeId(Victim)!='H00J' then
    set it=UnitRemoveItemFromSlot(Victim,GetRandomInt(0,5))
    if GetItemTypeId(it)=='I00K' then
      call CreateItem('I00G',GetItemX(it),GetItemY(it))
      call RemoveItem(it)
    endif
    set it=null
  endif
  set pidk=GetPlayerId(PKiller)
  set pidv=GetPlayerId(PVictim)
  
  if IsSentinel(PVictim)then
    if IsSentinel(PKiller)then
      set isNonPvsPKill=true
      if(PKiller==PVictim)then
        call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03R'))
      else
        call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],F09(PVictim,PKiller))
      endif
    elseif IsScourge(PKiller)then
      set isKillerBelongToPlayers=true
      set Deaths[GetPlayerId(Sentinels[0])]=Deaths[GetPlayerId(Sentinels[0])]+1
      set Kills[GetPlayerId(Scourges[0])]=Kills[GetPlayerId(Scourges[0])]+1
      set OwnageCounters[2]=OwnageCounters[2]+1
      set OwnageCounters[1]=0
      if PKiller!=Scourges[0]then
        set Kills[pidk]=Kills[pidk]+1
        set PlayerKillsStreak[pidk]=PlayerKillsStreak[pidk]+1
      endif
    endif
  elseif IsScourge(PVictim)then
    if IsScourge(PKiller)then
      set isNonPvsPKill=true
      if(PKiller==PVictim)then
        call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+(PlayerNames[pidv])+"|r "+GetObjectName('n03R'))
      else
        call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],F09(PVictim,PKiller))
      endif
    elseif IsSentinel(PKiller)then
      set isKillerBelongToPlayers=true
      set Deaths[GetPlayerId(Scourges[0])]=Deaths[GetPlayerId(Scourges[0])]+1
      set Kills[GetPlayerId(Sentinels[0])]=Kills[GetPlayerId(Sentinels[0])]+1
      set OwnageCounters[1]=OwnageCounters[1]+1
      set OwnageCounters[2]=0
      if PKiller!=Sentinels[0]then
        set Kills[pidk]=Kills[pidk]+1
        set PlayerKillsStreak[pidk]=PlayerKillsStreak[pidk]+1
      endif
    endif
  endif
  if PKiller==Neutrals then
    set isKillerBelongToPlayers=false
    if GetUnitTypeId(Killer)=='n00L' then
      call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03T'))
    else
      call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pidv]+PlayerNames[pidv]+"|r "+GetObjectName('n03U'))
    endif
    set isNonPvsPKill=true
  endif
  if IsRemoteMinesBlast then
    call PlaySoundAtPos(Sound_TechiesLaugh,GetUnitX(Victim),GetUnitY(Victim))
  endif
  call Traffic_RegisterData("Hero"+I2S(pidv),pidk)
  if PlayerKillsStreak[pidk]>PlayerBestStreak[pidk]then
    set PlayerBestStreak[pidk]=PlayerKillsStreak[pidk]
  endif
  set tmpCurStreakOfKiller=PlayerKillsStreak[pidv]
  if tmpCurStreakOfKiller>2 and isNonPvsPKill==false then
    if tmpCurStreakOfKiller==3 then
      set tmpStoppedStreakString="|c0000ff40"+GetObjectName('n04L')+"|r"
    elseif tmpCurStreakOfKiller==4 then
      set tmpStoppedStreakString="|c00400080"+GetObjectName('n04N')+"|r"
    elseif tmpCurStreakOfKiller==5 then
      set tmpStoppedStreakString="|c00ff0080"+GetObjectName('n04M')+"|r"
    elseif tmpCurStreakOfKiller==6 then
      set tmpStoppedStreakString="|c00ff8000"+GetObjectName('n04J')+"|r"
    elseif tmpCurStreakOfKiller==7 then
      set tmpStoppedStreakString="|c00808000"+GetObjectName('n04I')+"|r"
    elseif tmpCurStreakOfKiller==8 then
      set tmpStoppedStreakString="|c00ff80ff"+GetObjectName('n03V')+"|r"
    elseif tmpCurStreakOfKiller==9 then
      set tmpStoppedStreakString="|c00ff0000"+GetObjectName('n03W')+"|r"
    elseif tmpCurStreakOfKiller>=10 then
      set tmpStoppedStreakString="|c00ff8000"+GetObjectName('n03X')+"|r"
    endif
    set GoldReward=(IMinIF(tmpCurStreakOfKiller,10)-2)*60
  endif
  set tmpCurStreakOfKiller=PlayerKillsStreak[pidk]
  set tmpKillingUnit=Killer
  if IsUnitType(tmpKillingUnit,UNIT_TYPE_HERO)==false then
    set tmpKillingUnit=udg_Hero[GetPlayerId(GetOwningPlayer(tmpKillingUnit))]
  endif
  set tmpDyingUnit=Victim
  if IsUnitType(tmpDyingUnit,UNIT_TYPE_HERO)==false then
    set tmpDyingUnit=udg_Hero[GetPlayerId(GetOwningPlayer(tmpDyingUnit))]
  endif
  if isNonPvsPKill==false and isKillerBelongToPlayers then
  endif
  if tmpCurStreakOfKiller>2 and isNonPvsPKill==false then
    if tmpCurStreakOfKiller==3 then
      call BX8(Sounds_KillingSpree)
      set Y99=GetObjectName('n04L')
      set tmpStreakString=" "+GetObjectName('n04K')+" |c0000ff40"+Y99+"|r"+GetObjectName('n049')
    elseif tmpCurStreakOfKiller==4 then
      call BX8(Sounds_Dominating)
      set Y99=GetObjectName('n04N')
      set tmpStreakString=" "+GetObjectName('n04H')+" |c00400080"+Y99+"|r"+GetObjectName('n049')
    elseif tmpCurStreakOfKiller==5 then
      call BX8(Sounds_Megakill)
      set Y99=GetObjectName('n04M')
      set tmpStreakString=" "+GetObjectName('n04G')+" |c00ff0080"+Y99+"|r"+GetObjectName('n049')
    elseif tmpCurStreakOfKiller==6 then
      call BX8(Sounds_Unstoppable)
      set Y99=GetObjectName('n04J')
      set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff8000"+Y99+"|r"+GetObjectName('n04A')
    elseif tmpCurStreakOfKiller==7 then
      call BX8(Sounds_WickedSick)
      set Y99=GetObjectName('n04I')
      set tmpStreakString=" "+GetObjectName('n04H')+" |c00808000"+Y99+"|r"+GetObjectName('n04A')
    elseif tmpCurStreakOfKiller==8 then
      call BX8(Sounds_Monsterkill)
      set Y99=GetObjectName('n03V')
      set tmpStreakString=" "+GetObjectName('n04G')+" |c00ff80ff"+Y99+"|r"+GetObjectName('n04A')
    elseif tmpCurStreakOfKiller==9 then
      call BX8(Sounds_Godlike)
      set Y99=GetObjectName('n03W')
      set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff0000"+Y99+"|r"+GetObjectName('n04B')
    elseif tmpCurStreakOfKiller>=10 then
      call BX8(Sounds_HolyShit)
      set tmpStreakString=" "+GetObjectName('n04H')+" |c00ff8000"+GetObjectName('n03X')+"|r. "+GetObjectName('n04F')+GetObjectName('n04B')
    endif
  endif
  if isNonPvsPKill==false then
    set GoldReward=GoldReward+100+GetHeroLevel(Victim)*5+100
    set DyingPlayerName=udg_Colors[pidv]+(PlayerNames[GetPlayerId((PVictim))])+"|r"
    set KillingPlayerName=udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r"
    set GoldRewardStr="|c00FFDC00"+I2S(GoldReward)+"|r"
    if PKiller==Sentinels[0]or PKiller==Scourges[0]then
      if AssistantCounter==0 then
        if PKiller==Sentinels[0]then
          set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."
          call XF9(PKiller,GoldReward)
        elseif PKiller==Scourges[0]then
          set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."
          call XF9(PKiller,GoldReward)
        endif
      elseif AssistantCounter>1 then
        set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+GetObjectName('n049')+" "+GoldRewardStr+" "+GetObjectName('n044')+"."
        call WH9(Victim,Killer,GoldReward)
      endif
    elseif tmpStoppedStreakString==""and tmpStreakString==""then
      set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+" "+GetObjectName('n04C')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')
    elseif tmpStoppedStreakString==""and tmpStreakString!=""then
      set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n042')+" "+DyingPlayerName+GetObjectName('n043')+" "+GetObjectName('n04C')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')
    elseif tmpStoppedStreakString!=""and tmpStreakString==""then
      set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n048')+" "+DyingPlayerName+GetObjectName('n047')+" "+tmpStoppedStreakString+" "+GetObjectName('n046')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')
    elseif tmpStoppedStreakString!=""and tmpStreakString!=""then
      set resultingStrngOfKill=KillingPlayerName+" "+GetObjectName('n048')+" "+DyingPlayerName+GetObjectName('n047')+" "+tmpStoppedStreakString+" "+GetObjectName('n046')+" "+GoldRewardStr+" "+GetObjectName('n045')+GetObjectName('n049')
    endif
    if isKillerBelongToPlayers then
      set assistsStringVar=V29(Victim,Killer)
    endif
    call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],resultingStrngOfKill+assistsStringVar)
    if tmpStreakString!=""then
      call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],KillingPlayerName+tmpStreakString)
    endif
    set ReliableGold[pidk]=ReliableGold[pidk]+GoldReward
    call DistribGoldToPlayerForUnit(PKiller,GoldReward,Victim)
    set GoldEarnedByKills[pidk]=GoldEarnedByKills[pidk]+GoldReward
    if OwnageCounters[1]>4 then
      call X89(0)
    endif
    if OwnageCounters[2]>4 then
      call X89(1)
    endif
  endif
  set GoldPenalty=GetHeroLevel(Victim)*30
  if FindItemOfType(Victim,Item_Real[indexid_bloodstone])!=null then
    if GetItemCharges(FindItemOfType(Victim,Item_Real[indexid_bloodstone]))>0 then
      set BloodstoneRespTimeBonus=-1*(4*GetItemCharges(FindItemOfType(Victim,Item_Real[indexid_bloodstone])))
      set GoldPenalty=IMaxBJ(R2I(GoldPenalty-25*GetItemCharges(FindItemOfType(Victim,Item_Real[indexid_bloodstone]))),0)
    endif
  endif
  if GoldPenalty>DyingUnitOwnerUnreliableGold then
    set GoldPenalty=DyingUnitOwnerUnreliableGold
  endif
  call WB9(Victim)
  if FindItemOfType(Killer,Item_Real[indexid_bloodstone])!=null and DistanceBetweenUnits(Killer,Victim)>1600 then
    call SetItemCharges(FindItemOfType(Killer,Item_Real[indexid_bloodstone]),GetItemCharges(FindItemOfType(Killer,Item_Real[indexid_bloodstone]))+1)
  endif
  call W29(Victim)
  call W59(Victim)
  set tt_unit1=Victim
  set tt_unit2=Killer
  call ExeFunc("FleshHeapDistr")
  if ShallowGraveStatus==false then
    set PlayerGoldCash[pidv]=PlayerGoldCash[pidv]+GoldPenalty
    call XG9(Victim,GoldPenalty)
  endif
  call SaveInteger(HY,(400+pidk),(450+pidv),((LoadInteger(HY,(400+pidk),(450+pidv)))+1))
  call SaveInteger(HY,(400+pidv),(500+pidk),((LoadInteger(HY,(400+pidv),(500+pidk)))+1))
  call TimerStart(MultikillTimers[pidk],18,false,function ResetMultikillTimer)
  if isNonPvsPKill==false and PKiller!=Sentinels[0]and PKiller!=Scourges[0]and PKiller!=Neutrals then
    set MultikillCounter[pidk]=MultikillCounter[pidk]+1
    if MultikillCounter[pidk]==2 then
      set DoubleKills[pidk]=DoubleKills[pidk]+1
      call SaveInteger(HY,'0SND','0PID',pidk)
      set Y99=GetObjectName('n04S')
      call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c000000ff"+Y99+"|r"+GetObjectName('n049'),1)
    endif
    if MultikillCounter[pidk]==3 then
      set TrippleKills[pidk]=TrippleKills[pidk]+1
      call SaveInteger(HY,'0SND','0PID',pidk)
      set Y99=GetObjectName('n04E')
      call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c0000ff40"+Y99+"|r"+GetObjectName('n04B'),2)
    endif
    if MultikillCounter[pidk]==4 then
      set TrippleKills[pidk]=TrippleKills[pidk]+1
      call SaveInteger(HY,'0SND','0PID',pidk)
      set Y99=GetObjectName('n0HJ')
      call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04D')+" |c0000FFFF"+Y99+"|r"+GetObjectName('n04B'),3)
    endif
    if MultikillCounter[pidk]>4 then
      set TrippleKills[pidk]=TrippleKills[pidk]+1
      call SaveInteger(HY,'0SND','0PID',pidk)
      set Y99=GetObjectName('n0HK')
      call XE9(udg_Colors[pidk]+(PlayerNames[GetPlayerId((PKiller))])+"|r "+GetObjectName('n04K')+" |c0000AAFF"+Y99+"|r"+GetObjectName('n04B'),4)
    endif
  endif
  if(isNonPvsPKill==false)then
    set PlayerKillsStreak[pidv]=0
  endif
  set PlayerKillsStreak[0]=0
  set PlayerKillsStreak[6]=0
  set Deaths[pidv]=Deaths[pidv]+1
  if ShallowGraveStatus then
    set ShallowGraveRespTimeMultiplier=.4
  endif
  if isNonPvsPKill and GetUnitAbilityLevel(Victim,'A06B')>0 then
    set TechiesSuicideRespTimeMultiplier=.5
  endif
  set RespTime=((GetHeroLevel(Victim)*3.8+5+R2I(LoadReal(HeroStats,GetHandleId(Victim),26)))*TechiesSuicideRespTimeMultiplier+ReaperScytheFine)+R2I(BloodstoneRespTimeBonus)
  if Mode_FR then
    set RespTime=RespTime*.5
  endif
  if Mode_NoDeath then
    set PlayerTimeDead[pidv]=0
    call TimerStart(HeroRespawnTimer[pidv],1.,false,null)
  else
    set PlayerTimeDead[pidv]=PlayerTimeDead[pidv]+R2I(RespTime)
    if advancedTracking then
      call Traffic_RegisterData("LoD_DeadFor_"+R2S(RespTime),GetPlayerId(PVictim))
    endif
    call TimerStart(HeroRespawnTimer[pidv],RespTime,false,null)
  endif
  call TriggerExecute(TG)
  if Mode_DM==false then
    call WR9(Victim,RespTime,ShallowGraveStatus)
  else
    if(IsSentinel(PVictim))then
      set DM_Counter[0]=DM_Counter[0]+1
    endif
    if IsScourge(PVictim)then
      set DM_Counter[1]=DM_Counter[1]+1
    endif
    set DM_PrevHero[pidv]=Victim
    if GetUnitTypeId(Victim)=='H00J' then
      set DM_PrevHero[pidv]=(LoadUnitHandle(HY,(GetHandleId(GetOwningPlayer(Victim))),(699)))
    endif
    if DM_Counter[0]==DL then
      call TriggerExecute(JK)
    endif
    if DM_Counter[1]==DL then
      call TriggerExecute(YK)
    endif
    if(GetUnitTypeId(Victim)=='U006')then
      call ExeFunc("XJ9")
    elseif GetUnitTypeId(Victim)=='U008' or GetUnitTypeId(Victim)=='E015' then
      set VK=Victim
      call ExeFunc("YD9")
    elseif GetUnitTypeId(Victim)=='Ucrl' then
      set VK=Victim
      call ExeFunc("YE9")
    endif
  endif
  set Victim=null
  set Killer=null
  set PKiller=null
  set PVictim=null
  set t=null
  set tmpKillingUnit=null
  set tmpDyingUnit=null
endfunction

function FB_Wrap takes unit killer, unit victim returns nothing
  local player p=GetOwningPlayer(killer)
  local string s
  local integer assists=WF9(victim,killer)
  local integer i=1
  local integer pid
  local integer gold=150
  if p==Sentinels[0]or p==Scourges[0]then
    call WH9(victim,killer,gold)
    set s=WE9(victim,killer)+" "+GetObjectName('n04W')+" |c00ff0303"+GetObjectName('n04Y')+GetObjectName('n049')+"|r "
    if assists>1 then
      set s=s+"(+"+I2S(gold)+" "+GetObjectName('n044')+")"
    else
      set s=s+"(+"+I2S(gold)+" "+GetObjectName('n045')+")"
    endif
    loop
      exitwhen i>5
      if IsSentinel(GetOwningPlayer(killer))then
        set pid=GetPlayerId(Sentinels[i])
      else
        set pid=GetPlayerId(Scourges[i])
      endif
      set i=i+1
    endloop
  else
    set pid=GetPlayerId(p)
    set s=udg_Colors[pid]+(PlayerNames[pid])+"|r "+GetObjectName('n04W')+" |c00ff0303"+GetObjectName('n04Y')+GetObjectName('n049')+"|r "
    set s=s+"(+"+I2S(gold)+" "+GetObjectName('n045')+")"
    call DistribGoldToPlayerForUnit(p,gold,udg_Hero[pid])
    set ReliableGold[pid]=ReliableGold[pid]+gold
  endif
  call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],s)
  call BX8(Sounds_FB)
  set FBHappened=true
  set p=null
endfunction

function FB_Check takes unit killer, unit victim returns nothing
  local player pk=GetOwningPlayer(killer)
  if FBHappened==false then
    if pk!=Neutrals and killer!=null and IsPlayerEnemy(GetOwningPlayer(victim),pk) then
      if pk==Sentinels[0]or pk==Scourges[0]then
        if WF9(victim,killer)>0 then
          call FB_Wrap(killer,victim)
        endif
      else
        call FB_Wrap(killer,victim)
      endif
    endif
  endif
endfunction

function YH9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set u=(LoadUnitHandle(HY,h,(53)))
    if RectContainsUnit(RoshanCanWalkHere,u)==false then
      if(LoadBoolean(HY,h,(91))) then
        call SaveBoolean(HY,h,(91),(false))
      else
        call SetUnitX(u,GetRectCenterX(Q4))
        call SetUnitY(u,GetRectCenterY(Q4))
        call SaveBoolean(HY,h,(91),(true))
      endif
    endif
  endif
  set t=null
  set u=null
  return false
endfunction

function YI9 takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,10,true)
  call TriggerAddCondition(t,Condition(function YH9))
  call SaveUnitHandle(HY,h,(53),(u))
  call SaveBoolean(HY,h,(91),(true))
  set t=null
endfunction

function HealHeroForAegisAct takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p
  local real heal
  local unit u
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    
    if IsRealDamage and GetEventDamage()>0 then
      set p=GetOwningPlayer(GetEventDamageSource())
      if (IsSentinel(p) or IsScourge(p)) and IsPlayer(p) then
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      endif
    endif
  else
    if(TimerGetElapsed(GlobalTimer)<LoadReal(HY,h,0))then
      set u=LoadUnitHandle(HY,h,0)
      set heal=GetUnitState(u,UNIT_STATE_MAX_LIFE)*0.2*0.05
      call SetWidgetLife(u,GetWidgetLife(u)+heal)
    else
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set u=null
endfunction

function HealHeroForAegis takes unit u returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.05,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function HealHeroForAegisAct))
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  
  call SaveReal(HY,GetHandleId(t),0,TimerGetElapsed(GlobalTimer)+5)
  set t=null
endfunction

function YN9 takes nothing returns nothing
  local integer i=1
  local unit Hero
  set K27=null
  loop
    exitwhen i>5
    set Hero=udg_Hero[GetPlayerId(Sentinels[i])]
    if Hero!=null and FindItemOfType(Hero,Item_Real[indexid_Aegis])!=null then
      call DisableTrigger(t_manipulateitem)
      call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
      call RemoveItem(FindItemOfType(Hero,Item_Real[indexid_Aegis]))
      call EnableTrigger(t_manipulateitem)
      call HealHeroForAegis(Hero)
    endif
    set Hero=udg_Hero[GetPlayerId(Scourges[i])]
    if Hero!=null and FindItemOfType(Hero,Item_Real[indexid_Aegis])!=null then
      call DisableTrigger(t_manipulateitem)
      call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
      call RemoveItem(FindItemOfType(Hero,Item_Real[indexid_Aegis]))
      call EnableTrigger(t_manipulateitem)
      call HealHeroForAegis(Hero)
    endif
    set i=i+1
  endloop
  set Hero=null
endfunction

function YO9 takes string YP9,string YQ9 returns string
  local string s=GetObjectName('n0CA')
  set s=FA9(s,"$team",YP9)
  set s=FA9(s,"$team",YQ9)
  return s
endfunction

function RoshanSlamFilter takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'BCtc')>0
endfunction

function RoshanSlamDmg takes nothing returns nothing
  call DamageTarget(Roshan,GetEnumUnit(),1, 70+R2I(TimerGetElapsed(GlobalTimer)/240)*20 )
endfunction

function RoshanSlamPost takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Roshan),GetUnitY(Roshan),375,Condition(function RoshanSlamFilter))
  call ForGroup(g,function RoshanSlamDmg)
  call KillGroup(g)
  set g=null
  set t=null
endfunction

function RoshanSlamAct takes nothing returns nothing
  call TimerStart(CreateTimer(),0,false,function RoshanSlamPost)
endfunction

function RoshanSlam takes nothing returns nothing
  if GetTriggerUnit()==Roshan and GetSpellAbilityId()=='ACtc' then
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
      call RoshanSlamAct()
    else
      //call SetUnitAnimationByIndex(Roshan,1)
    endif
  endif
endfunction

function IsHero takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))!=null
endfunction

function RoshanBuffer takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local real time=TimerGetElapsed(GlobalTimer)-GameStartsTime
  local integer level=R2I(time / 600)
  if level>4 then
    set level=4
  endif
  if IsDead(Roshan)==false and level>0 and GameStartsTime>0 then
    call UnitAddAbility2(Roshan,'A43T')
    call UnitAddAbility2(Roshan,'A43U')
    call SetUnitAbilityLevel(Roshan,'A43T',level)
    call SetUnitAbilityLevel(Roshan,'A43U',level)
  endif
  set t=null
endfunction

function YM9 takes nothing returns boolean
  set M77=GetTriggerEvalCount(GetTriggeringTrigger())
  if Roshan!=null and GetWidgetLife(Roshan)>1 then
    call SetPlayerTechResearched(GetOwningPlayer(Roshan),'R00F',M77)
    if GetUnitAbilityLevel(Roshan,'A142')==0 then
      call UnitAddAbility(Roshan,'A142')
    endif
    call SetUnitAbilityLevel(Roshan,'A142',M77+1)
  endif
  return false
endfunction

function YS9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local location YT9
  local real U68
  local integer RespTime=LoadInteger(HY,GetHandleId(t),0)
  if GetTriggerEvalCount(t)==RespTime or ZM7 then
    set ZM7=false
    set YT9=GetRectCenter(Q4)
    call YN9()
    set M97=M97+1
    set Roshan=CreateUnitAtLoc(Player(12),'n00L',YT9,bj_UNIT_FACING)
    call SetUnitAcquireRange(Roshan,150)
    call YI9(Roshan)
    call UnitAddAbility(Roshan,'A142')
    call SetPlayerTechResearched(GetOwningPlayer(Roshan),'R00F',M77)
    call SetUnitAbilityLevel(Roshan,'A142',M77+1)
    call RemoveLocation(YT9)
    if M97>1 then
      call UnitRemoveAbility(Roshan,'A0K2')
      call UnitAddAbility(Roshan,'A0Q6')
      call UnitAddItem(Roshan,CreateItem(Item_Real[indexid_Cheese],0,0))
    endif
    call UnitAddItem(Roshan,CreateItem(Item_Real[indexid_Aegis],0,0))
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)==300 then
    call YN9()
  endif
  set t=null
  set YT9=null
  return false
endfunction

function YU9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function YS9))
  call SaveInteger(HY,GetHandleId(t),0,GetRandomInt(8,11)*60)
  set ZM7=false
  set M47=false
  call CreateUnitAtLoc(Player(12),'e01V',GetRectCenter(Q4),0)
  if(IsSentinel(GetOwningPlayer(GetKillingUnit())))then
    call Traffic_RegisterData("Roshan",0)
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],YO9("|c00ff0000"+GetObjectName('n065')+"|r",GetObjectName('n065')))
    set LastRoshanSlayer=0
    call AdjustPlayerStateBJ(200,Sentinels[1],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Sentinels[2],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Sentinels[3],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Sentinels[4],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Sentinels[5],PLAYER_STATE_RESOURCE_GOLD)
  endif
  if(IsScourge(GetOwningPlayer(GetKillingUnit())))then
    call Traffic_RegisterData("Roshan",1)
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],YO9("|c00004000"+GetObjectName('n06C')+"|r",GetObjectName('n06C')))
    set LastRoshanSlayer=1
    call AdjustPlayerStateBJ(200,Scourges[1],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Scourges[2],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Scourges[3],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Scourges[4],PLAYER_STATE_RESOURCE_GOLD)
    call AdjustPlayerStateBJ(200,Scourges[5],PLAYER_STATE_RESOURCE_GOLD)
  endif
  set t=null
endfunction

function RoshanDeath takes unit victim returns nothing
  if GetUnitTypeId(victim)=='n00L' then
    call YU9()
  endif
endfunction

function Y39 takes player victim,player killer returns string
  local string s=GetObjectName('n0AP')
  set s=FA9(s,"$dead",PlayerNames[GetPlayerId(victim)])
  //call echo(GetPlayerName(killer))
  //set s=s+" by "+udg_Colors[GetPlayerId(killer)]+PlayerNames[GetPlayerId(killer)]+" !"
  return s
endfunction

function Y69 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,false)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function YL9 takes unit Source returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function Y69))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  set Source=null
  set t=null
endfunction

function Y19 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit courier=(LoadUnitHandle(HY,h,2))
  local integer Count=GetTriggerEvalCount(t)
  local integer Y59=LoadInteger(HY,h,0)-Count
  local integer i=1
  local integer id
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  loop
    exitwhen i>5
    if IsPlayerAlly(GetOwningPlayer(courier),Sentinels[0])then
      set id=GetPlayerId(Sentinels[i])
    else
      set id=GetPlayerId(Scourges[i])
    endif
    set i=i+1
    if Y59==0 then
      if IsPlayerAlly(Sentinels[0],Player(id))then
        set CourierDead[GetPlayerId(Sentinels[0])]=false
      endif
      if IsPlayerAlly(Scourges[0],Player(id))then
        set CourierDead[GetPlayerId(Scourges[0])]=false
      endif
    endif
  endloop
  if Y59==2 then
    call SetUnitPosition(courier,x,y)
  endif
  if Y59==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set courier=null
  return false
endfunction

function Y29 takes player whichPlayer,integer W98 returns nothing
  local texttag t
  if W98>0 then
    set t=CreateTextTag()
    call SetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(whichPlayer,PLAYER_STATE_RESOURCE_GOLD)+W98)
    call SetTextTagText(t,"+"+I2S(W98),.025)
    call SetTextTagPosUnit(t,udg_Hero[GetPlayerId(whichPlayer)],0)
    call SetTextTagColor(t,255,220,0,255)
    call SetTextTagVelocity(t,0,.03)
    call SetTextTagVisibility(t,GetLocalPlayer()==whichPlayer)
    call SetTextTagFadepoint(t,2)
    call SetTextTagLifespan(t,3)
    call SetTextTagPermanent(t,false)
  endif
  set t=null
endfunction

function Z49 takes nothing returns boolean
  local real x
  local real y
  local unit courier=GetTriggerUnit()
  local integer i=1
  local integer WE8=175
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  
  if IsBasicCourier(courier) then
    set WE8=150
    call SaveInteger(HY,h,0,140)
    call SaveReal(HY,GetHandleId(courier),'DEAD',TimerGetElapsed(GlobalTimer)+140)
  else
    call SaveInteger(HY,h,0,180)
    call SaveReal(HY,GetHandleId(courier),'DEAD',TimerGetElapsed(GlobalTimer)+180)
  endif
  call Traffic_RegisterData("Courier"+I2S(GetPlayerId(GetOwningPlayer(courier))),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call DisplayTimedTextToForceEx(AllPlayers,10.,Y39(GetOwningPlayer(courier),GetOwningPlayer(GetKillingUnit())))
  call PingMinimapEx(GetUnitX(courier),GetUnitY(courier),6,255,0,0,false)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function Y19))
  call SaveUnitHandle(HY,h,2,(courier))
  
  if IsPlayerAlly(GetOwningPlayer(courier),Sentinels[0]) and CourierDead[GetPlayerId(Sentinels[0])]==false then
    set CourierDead[GetPlayerId(Sentinels[0])]=true
    loop
      exitwhen i>5
      call Y29(Scourges[i],WE8)
      set i=i+1
    endloop
  endif
  set i=1
  if IsPlayerAlly(GetOwningPlayer(courier),Scourges[0]) and CourierDead[GetPlayerId(Scourges[0])]==false then
    set CourierDead[GetPlayerId(Scourges[0])]=true
    loop
      exitwhen i>5
      call Y29(Sentinels[i],WE8)
      set i=i+1
    endloop
  endif
  if IsSentinel(GetOwningPlayer(courier))then
    set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  if IsTerrainPathable(GetUnitX(courier),GetUnitY(courier),PATHING_TYPE_WALKABILITY)then
    call YL9(courier)
  endif
  set t=null
  set courier=null
  return false
endfunction

function Z79 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=HS
  local real y=ZS
  if IsScourge(GetOwningPlayer(Source))then
    set x=EC7
    set y=E37
  endif
  if IsDead(Source)==false then
    if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)<800 then
      call SaveCourierState(Source,"At home")
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function DefineMainCourier takes unit u returns nothing
  local player p=GetOwningPlayer(u)
  if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR')==false then
    call SaveUnitHandle(HeroStats,GetHandleId(p),'COUR',u)
  endif
endfunction

function DetectAllyCourier takes nothing returns boolean
  return IsCourier(GetFilterUnit()) and GetPlayerAlliance(GetOwningPlayer(GetFilterUnit()),tt_player1,ALLIANCE_SHARED_CONTROL)
endfunction

function DefineCourierForPlayer takes player p returns nothing
  if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR') then
    if GetPlayerAlliance(GetOwningPlayer(LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')),p,ALLIANCE_SHARED_CONTROL) then
      return
    endif
  endif
  call SaveUnitHandle(HeroStats,GetHandleId(p),'COUR',GetBestCourier(p))
endfunction

function CourierOrder takes nothing returns nothing
  local integer id
  local unit u
  local integer h=GetHandleId(GetTriggeringTrigger())
  local integer c
  local real x
  local real y
  if GetTriggerEventId()!=EVENT_GAME_TIMER_EXPIRED then
    set id=GetIssuedOrderId()
    if id!='h085' and id!=852663 and id!=851973 and id!='h0DE' and id!='h0BV' and id!=852252 and id!=852247 and id!=852246 and id!=852100 and (GetIssuedOrderId()< 852002 or GetIssuedOrderId()>852013) then//all default buttons
      if IsTriggeredOrder(GetTriggerUnit())==false then
        call SaveCourierState(GetTriggerUnit(),"Manual control")
      endif
    endif
  else
    set u=LoadUnitHandle(HY,h,0)
    if IsDead(u) then
      set u=null
      return
    endif
    set id=GetUnitCurrentOrder(u)
    
    set x=HS
    set y=ZS
    if IsScourge(GetOwningPlayer(u))then
      set x=EC7
      set y=E37
    endif
    if DistanceBetweenXY(GetUnitX(u),GetUnitY(u),x,y)<800 then
      call SaveCourierState(GetTriggerUnit(),"At home")
    elseif id==852001 then//dropitem
      call SaveCourierState(GetTriggerUnit(),"Manual control")
    elseif LoadReal(HY,h,0)==GetUnitX(u) and LoadReal(HY,h,1)==GetUnitY(u) then
      call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
      if LoadInteger(HY,h,0)>=5 then
        call SaveCourierState(u,"Stand still")
      endif
    else
      if LoadInteger(HY,h,0)>0 then
        call SaveInteger(HY,h,0,0)
        call SaveCourierState(u,"Going somewhere")
      endif
      call SaveReal(HY,h,0,GetUnitX(u))
      call SaveReal(HY,h,1,GetUnitY(u))
    endif
  endif
endfunction

function Z89 takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterDeathEvent(t,u)
  call TriggerAddCondition(t,Condition(function Z49))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function Z79))
  call SaveUnitHandle(HY,h,2,(u))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call TriggerAddCondition(t,Condition(function CourierOrder))
  call SaveUnitHandle(HY,h,0,u)
  call DefineMainCourier(u)
  set t=null
endfunction

function CourierDeath takes unit u returns nothing
  local player p=GetOwningPlayer(u)
  local integer pid=GetPlayerId(p)
  if IsCourier(u)and IsUnitIllusion(u)==false then
    call DisplayTimedTextToForceEx(AllPlayers,10.,udg_Colors[pid]+PlayerNames[pid]+"|r's courier has been |c00ff0000PERMANENTLY|r killed. It won't respawn.")
    call PingMinimapEx(GetUnitX(u),GetUnitY(u),6,255,0,0,false)
  endif
endfunction

function GetFakeRune takes integer id returns integer
  if id=='I006' then
    return 'I0QB'
  elseif id=='I007' then
    return 'I0QC'
  elseif id=='I00K' then
    return 'I0QD'
  elseif id=='I008' then
    return 'I0QE'
  elseif id=='I00J' then
    return 'I0QF'
  elseif id=='I0QA' then
    return 'I0QG'
  endif
endfunction

function GetRealRune takes integer id returns integer
  if id=='I0QB' then
    return 'I006'
  elseif id=='I0QC' then
    return 'I007'
  elseif id=='I0QD' then
    return 'I00K'
  elseif id=='I0QE' then
    return 'I008'
  elseif id=='I0QF' then
    return 'I00J'
  elseif id=='I0QG' then
    return 'I0QA'
  endif
endfunction

function IsFakeRune takes integer i returns boolean
  return i=='I0QB' or i=='I0QC' or i=='I0QD' or i=='I0QE' or i=='I0QF' or i=='I0QG'
endfunction

function IsRune takes integer i returns boolean
  return i=='I006' or i=='I008' or i=='I00J' or i=='I00K' or i=='I007' or i=='I0QA'
endfunction

function ZG9 takes nothing returns nothing
  if GetWidgetLife(GetEnumItem())>0 and IsFakeRune(GetItemTypeId(GetEnumItem()))then
    set tt_item1=GetEnumItem()
  endif
endfunction

function ZH9 takes nothing returns integer
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=T77
    set i=GetRandomInt(1,5)
  endloop
  set T77=i
  return i
endfunction

function RuneSpawn takes nothing returns boolean
  local boolean ZJ9=false
  local boolean ZK9=false
  local real x
  local real y
  local real dx
  local real dy
  local real x1
  local real y1
  local real x2
  local real y2
  local integer ZM9
  set x1=GetLocationX(TopRuneSpawn)
  set y1=GetLocationY(TopRuneSpawn)
  set x2=GetLocationX(BottomRuneSpawn)
  set y2=GetLocationY(BottomRuneSpawn)
  set tt_item1=null
  call EnumItemsInRect(TopRuneSpawnRect,Condition(function ReturnTrue),function ZG9)
  set ZJ9=true
  if tt_item1!=null then
    call RemoveItem(tt_item1)
  endif
  set tt_item1=null
  call EnumItemsInRect(BottomRuneSpawnRect,Condition(function ReturnTrue),function ZG9)
  set ZK9=true
  if tt_item1!=null then
    call RemoveItem(tt_item1)
  endif
  set ZM9=ZH9()
  if GetRandomInt(1,2)==1 then
    set x=x1
    set y=y1
    set dx=x2
    set dy=y2
  else
    set x=x2
    set y=y2
    set dx=x1
    set dy=y1
  endif
  if IsRuneFirstSpawn then
    set IsRuneFirstSpawn=false
    call CreateItem(GetFakeRune('I0QA'),dx,dy)
    call CreateItem(GetFakeRune('I0QA'),x,y)
  else
    if ZM9==1 then
      call CreateItem(GetFakeRune('I007'),x,y)
    elseif ZM9==2 then
      call CreateItem(GetFakeRune('I006'),x,y)
    elseif ZM9==3 then
      call CreateItem(GetFakeRune('I00K'),x,y)
    elseif ZM9==4 then
      call CreateItem(GetFakeRune('I008'),x,y)
    elseif ZM9==5 then
      call CreateItem(GetFakeRune('I00J'),x,y)
    endif
    call CreateItem(GetFakeRune('I0QA'),dx,dy)
  endif
  return false
endfunction

function ZP9 takes unit Source returns nothing
  local real x
  local real y
  if IsSentinel(GetOwningPlayer(Source))then
    set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  call CourierIssuePointOrder(Source,851986,x,y)
  call SaveCourierState(Source,"Going home")
endfunction

function ZQ9 takes nothing returns nothing
  local item Item=GetEnumItem()
  if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==U07 and V47==0 then
    set V47=V47+1
    call UnitAddItem(U57,Item)
  endif
  set Item=null
endfunction

function ZR9 takes nothing returns nothing
  local item Item=GetEnumItem()
  if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==U07 then
    call UnitAddItem(U27,Item)
  endif
  set Item=null
endfunction

function ZS9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,2))
  local unit Courier=(LoadUnitHandle(HY,h,(92)))
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local rect r=Rect(x-300,y-300,x+300,y+300)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set U07=p
    set U57=Hero
    set U27=Courier
    call EnumItemsInRect(r,Condition(function ReturnTrue),function ZR9)
  else
    if GetTriggerEvalCount(t)>9 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      set U07=p
      set U57=Hero
      set U27=Courier
      call EnumItemsInRect(r,Condition(function ReturnTrue),function ZR9)
    else
      set U07=p
      set U57=Hero
      set V47=0
      call EnumItemsInRect(r,Condition(function ReturnTrue),function ZQ9)
    endif
  endif
  call RemoveRect(r)
  set t=null
  set Hero=null
  set Courier=null
  set r=null
  return false
endfunction

function ZT9 takes unit Courier,unit Hero returns nothing
  local player p=GetOwningPlayer(Hero)
  local integer i
  local item Item
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetUnitX(Courier)
  local real y=GetUnitY(Courier)
  local integer indexId
  if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)then
    set x=GetUnitX(Hero)
    set y=GetUnitY(Hero)
  endif
  call TriggerRegisterDeathEvent(t,Hero)
  call TriggerRegisterTimerEvent(t,.01,true)
  call TriggerAddCondition(t,Condition(function ZS9))
  call SaveUnitHandle(HY,h,2,(Hero))
  call SaveUnitHandle(HY,h,(92),(Courier))
  call SavePlayerHandle(HY,h,(54),(p))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  set i=0
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(Courier,i)
    set indexId=GetIndex(Item)
    if Item!=null and GetItemPlayer(Item)==p and (indexId!=indexid_BottleInvis and indexId!=indexid_BottleDD and indexId!=indexid_BottleHaste and indexId!=indexid_BottleRegen and indexId!=indexid_BottleIllusion)then
      call UnitRemoveItem(Courier,Item)
      call SetItemPosition(Item,x,y)
    endif
    set i=i+1
  endloop
  set t=null
  set Item=null
endfunction

function IsCourierStunned takes unit Unit returns boolean
  local integer i=GetUnitCurrentOrder(Unit)
  return(i==0)or(i==851973)or(i==851975)or(i==851987)or(i==851993)
endfunction

function CourierReissueDeliveryXY takes integer h returns nothing
  local unit courier=LoadUnitHandle(HY,h,92)
  local unit target=LoadUnitHandle(HY,h,2)
  local real x
  local real y
  local real dist
  local real ms
  local real angle
  local real oldX
  local real oldY
  local real left
  local real anglediff
  local real hx=GetUnitX(target)
  local real hy=GetUnitY(target)
  if(IsCourierStunned(target)==false)then
    set x=GetUnitX(target)
    set y=GetUnitY(target)
    set oldX=LoadReal(HY,h,677)
    set oldY=LoadReal(HY,h,678)
    call SaveReal(HY,h,677,x*1.)
    call SaveReal(HY,h,678,y*1.)
    set angle=Atan2(y-oldY,x-oldX)
    set dist=SquareRoot((x-oldX)*(x-oldX)+(y-oldY)*(y-oldY))/ .2
    set ms=GetUnitMoveSpeedLOD(courier)
    set left=DistanceBetweenXY(GetUnitX(target),GetUnitY(target),GetUnitX(courier),GetUnitY(courier))
    set anglediff=RAbsBJ(angle*bj_RADTODEG-GetUnitFacing(courier))
    if(left < ms-dist and ms > dist)or(left < RMaxBJ(ms,dist)and anglediff >= 90)then
    else
      set hx=x+dist*Cos(angle)
      set hy=y+dist*Sin(angle)
    endif
  endif
  call SaveInteger(HY,h,679,1)
  call CourierIssuePointOrder(courier,851986,hx,hy)
  set courier=null
  set target=null
endfunction

function RemoveSavedI takes hashtable h, integer pk, integer ck returns boolean
  call RemoveSavedInteger(h,pk,ck)
  return true
endfunction

function ReceiveItems takes unit courier, unit hero returns nothing
  local integer i=0
  local item it
  local integer k=0
  local integer lim=0
  local integer j
  local player p=GetOwningPlayer(hero)
  local integer parts
  local integer partsfound
  local string s
  call FlushChildHashtable(HY,'ITEM')
  loop
    set it=UnitItemInSlot(courier,i)
    if it!=null and GetItemPlayer(it)==p then
      call SaveItemHandle(HY,'ITEM',k,it)
      call SaveInteger(HY,'ITEM',k,GetIndex(it))
      set k=k+1
    endif
    set it=UnitItemInSlot(hero,i)
    if it!=null and GetItemPlayer(it)==p then
      call SaveItemHandle(HY,'ITEM',k,it)
      call SaveInteger(HY,'ITEM',k,GetIndex(it))
      set k=k+1
    endif
    set i=i+1
    exitwhen i>5
  endloop
  set it=null
  if k<=6 then
    return
  endif
  set lim=k
  set k=1
  loop
    call SaveInteger(HY,'ITEM',51,Rec_Comp_1[k])
    call SaveInteger(HY,'ITEM',52,Rec_Comp_2[k])
    call SaveInteger(HY,'ITEM',53,Rec_Comp_3[k])
    call SaveInteger(HY,'ITEM',54,Rec_Comp_4[k])
    call SaveInteger(HY,'ITEM',55,Rec_Comp_5[k])
    set partsfound=0
    set parts=0
    set i=0
    if Rec_Comp_1[k]!=0 then
      set parts=parts+1
    endif
    if Rec_Comp_2[k]!=0 then
      set parts=parts+1
    endif
    if Rec_Comp_3[k]!=0 then
      set parts=parts+1
    endif
    if Rec_Comp_4[k]!=0 then
      set parts=parts+1
    endif
    if Rec_Comp_5[k]!=0 then
      set parts=parts+1
    endif
    loop
      set j=LoadInteger(HY,'ITEM',i)
      if j>0 and LoadBoolean(HY,'ITEM',i)!=true then
        if (j==LoadInteger(HY,'ITEM',51) and RemoveSavedI(HY,'ITEM',51)) or (j==LoadInteger(HY,'ITEM',52) and RemoveSavedI(HY,'ITEM',52)) or (j==LoadInteger(HY,'ITEM',53) and RemoveSavedI(HY,'ITEM',53)) or (j==LoadInteger(HY,'ITEM',54) and RemoveSavedI(HY,'ITEM',54)) or (j==LoadInteger(HY,'ITEM',55) and RemoveSavedI(HY,'ITEM',55)) then
          call SaveItemHandle(HY,'ITEM',100+partsfound,LoadItemHandle(HY,'ITEM',i))
          call SaveBoolean(HY,'ITEM',i,true)//taken
          call SaveInteger(HY,'ITEM',200+partsfound,i)
          set partsfound=partsfound+1
        endif
      endif
      set i=i+1
      exitwhen i>=lim
    endloop
    if partsfound>0 then
      set i=100
      loop
        if partsfound==parts then
          set it=LoadItemHandle(HY,'ITEM',i)
          if Rec_Final[k]==indexid_bloodstone then
            call SaveInteger(HY,'ITEM',300,8)
          elseif Rec_Final[k]==indexid_DiffusalBlade then
            call SaveInteger(HY,'ITEM',300,8)
          elseif Rec_Final[k]==indexid_DiffusalBlade_upg then
            if GetIndex(it)==indexid_DiffusalBlade then
              call SaveInteger(HY,'ITEM',300,GetItemCharges(it))
            endif
          elseif Rec_Final[k]==indexid_MagicWand then
            if GetIndex(it)==indexid_MagicStick then
              call SaveInteger(HY,'ITEM',300,GetItemCharges(it))
            endif
          endif
          call RemoveItem(it)
        else
          call RemoveSavedBoolean(HY,'ITEM',LoadInteger(HY,'ITEM',100+i))
        endif
        call RemoveSavedHandle(HY,'ITEM',i)
        set i=i+1
        exitwhen HaveSavedHandle(HY,'ITEM',i)==false
      endloop
    endif
    if partsfound==parts then
      set it=UnitAddItemById(hero,Item_Real[Rec_Final[k]])
      if Rec_Final[k]==indexid_bloodstone or Rec_Final[k]==indexid_MagicWand or Rec_Final[k]==indexid_DiffusalBlade or Rec_Final[k]==indexid_DiffusalBlade_upg then
        if HaveSavedInteger(HY,'ITEM',300) then
          call SetItemCharges(it,LoadInteger(HY,'ITEM',300))
          call RemoveSavedInteger(HY,'ITEM',300)
        endif
      endif
      call SetItemPlayer(it,p,true)
      call SetItemUserData(it,0)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",hero,"origin"))
      set it=null
    endif
    exitwhen k>=Recipe_Max
    set k=k+1
  endloop
endfunction

function ZL9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Courier=(LoadUnitHandle(HY,h,(92)))
  local unit Hero=(LoadUnitHandle(HY,h,2))
  local real x
  local real y
  local integer i
  local player p=GetOwningPlayer(Hero)
  local item Item
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    if GetTriggerUnit()==Hero then
      call ZP9(Courier)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
    if(LoadInteger(HY,h,679))==1 then
      call SaveInteger(HY,h,679,0)
    elseif GetIssuedOrderId()!=852100 and GetIssuedOrderId()!=852090 and (GetIssuedOrderId()< 852002 or GetIssuedOrderId()>852013) then
      call CleanTrigger(t)
      call SaveCourierState(Courier,"Interrupted")
    endif
  else
    if DistanceBetweenUnits(Courier,Hero)<350 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call ReceiveItems(Courier,Hero)
      call ZT9(Courier,Hero)
      call ZP9(Courier)
      call SaveCourierState(Courier,"Going home")
    else
      call CourierReissueDeliveryXY(GetHandleId(t))
      call SaveCourierState(Courier,"Deliver to "+udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+PlayerNames[GetPlayerId(GetOwningPlayer(Hero))]+"|r")
    endif
  endif
  set t=null
  set Courier=null
  set Hero=null
  set Item=null
  return false
endfunction

function Z19 takes unit Hero,boolean Z09 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit courier=GetSellingUnit()
  local integer Z59=(LoadInteger(HY,(GetHandleId(courier)),(8000)))
  if Hero!=null then
    if Hero!=(LoadUnitHandle(HY,(GetHandleId(courier)),(8002+Z59)))and Z09 then
      set Z59=Z59+1
      call SaveInteger(HY,(GetHandleId(courier)),(8000),(Z59))
      call SaveUnitHandle(HY,(GetHandleId(courier)),(8002+Z59),(Hero))
    endif
    call SaveReal(HY,h,(677),((GetUnitX(Hero))*1.))
    call SaveReal(HY,h,(678),((GetUnitY(Hero))*1.))
    call IssueTargetOrderById(courier,851986,Hero)
    call TriggerRegisterDeathEvent(t,courier)
    call TriggerRegisterDeathEvent(t,Hero)
    call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_TARGET_ORDER)
    call TriggerRegisterUnitEvent(t,courier,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterTimerEvent(t,.2,true)
    call TriggerAddCondition(t,Condition(function ZL9))
    call SaveUnitHandle(HY,h,2,(Hero))
    call SaveUnitHandle(HY,h,(92),(courier))
    
  endif
  set t=null
  set courier=null
endfunction

function Z29 takes nothing returns nothing
  local item Item=GetEnumItem()
  local player p=tt_player3
  local integer id=GetPlayerId(p)
  if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p and IsItemVisible(Item) then
    call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
    call UnitAddItem(V87,Item)
  endif
  set Item=null
  set p=null
endfunction

function A49 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,(53)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local player p=LoadPlayerHandle(HY,h,50)
  set tt_player3=p
  set V87=Source
  if IsSentinel(p)then
    call EnumItemsInRect(H5,Condition(function ReturnTrue),function Z29)
  else
    call EnumItemsInRect(Z5,Condition(function ReturnTrue),function Z29)
  endif
  if GetTriggerEvalCount(t)==3 then
    call KillUnit(u)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set u=null
  set Source=null
  return false
endfunction

function A79 takes unit Hero returns nothing
  local unit u=GetSoldUnit()
  local integer i=0
  local item Item
  local integer id=GetPlayerId(GetOwningPlayer(u))
  local region r=CreateRegion()
  local trigger t
  local integer h
  local unit Source=GetSellingUnit()
  local player p=GetOwningPlayer(u)
  if IsSentinel(GetOwningPlayer(u))then
    call RegionAddRect(r,H5)
  else
    call RegionAddRect(r,Z5)
  endif
  if IsUnitInRegion(r,Source)then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.05,true)
    call TriggerAddCondition(t,Condition(function A49))
    call SaveUnitHandle(HY,h,(53),(u))
    call SavePlayerHandle(HY,h,50,p)
    call SaveUnitHandle(HY,h,2,(Source))
    loop
      exitwhen i>5
      set Item=UnitItemInSlot(Source,i)
      if Bottle_IsIndexRune(GetIndex(Item))==false and GetIndex(Item)!=indexid_Aegis then
        call UnitRemoveItemFromSlot(Source,i)
        if IsUnitInRegion(r,Source)and IsPlayerAlly(GetItemPlayer(Item),GetOwningPlayer(Source)) then
          set id=GetPlayerId(GetItemPlayer(Item))
          call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
        endif
      endif
      set i=i+1
    endloop
  endif
  call RemoveRegion(r)
  set u=null
  set r=null
  set t=null
  set Item=null
  set Source=null
endfunction

function A89 takes unit u returns string
  local string s=GetObjectName('n0FO')
  set s=FA9(s,"$hero",udg_Colors[GetPlayerId(GetOwningPlayer(u))]+GetUnitName(u)+"|r")
  return s
endfunction

function A99 takes unit Source returns boolean
  if GetOwningPlayer(Source)!=GetLocalPlayer()then
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,A89(udg_Hero[GetPlayerId(GetOwningPlayer(Source))]))
  endif
  return false
endfunction

function RemoveBuybackVisuals takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A336')
  call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'B0GU')
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function AddBuybackVisuals takes unit u,real r returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,r,false,function RemoveBuybackVisuals)
  call UnitAddAbility2(u,'A336')
  call SaveUnitHandle(HY,h,0,u)
  set t=null
endfunction

function DeliverItems_Main takes nothing returns nothing
  local unit u=GetSoldUnit()
  local player p=GetOwningPlayer(u)
  local integer pid=GetPlayerId(p)
  local real r=0
  if GetUnitTypeId(u)=='h085' then
    if udg_Hero[pid]!=null and IsDead(udg_Hero[pid])==false then
      call Z19(udg_Hero[pid],true)
    endif
    call KillUnit(u)
  elseif GetUnitTypeId(u)=='h0BV' then
    if udg_Hero[pid]!=null then
      call A79(udg_Hero[pid])
    endif
    call KillUnit(u)
  elseif GetUnitTypeId(u)=='h0DE' then
    if udg_Hero[pid]!=null then
      call Z19(LoadUnitHandle(HY,GetHandleId(GetSellingUnit()),8002+LoadInteger(HY,GetHandleId(GetSellingUnit()),8000)-1),false)
    endif
    call KillUnit(u)
  elseif GK9(GetUnitTypeId(u))then
    if udg_Hero[pid]!=null then
      if IsDead(udg_Hero[pid]) and p==GetOwningPlayer(GetSellingUnit()) and LoadInteger(HY,GetHandleId(udg_Hero[pid]),4304)!=1 and IsImpossibleToBuyback[pid]==false then
        set r=TimerGetRemaining(HeroRespawnTimer[pid])
        call SaveReal(HeroStats,GetHandleId(p),25,r+TimerGetElapsed(GlobalTimer))
        call SaveReal(HeroStats,GetHandleId(p),26,r*0.25)
        call A99(udg_Hero[pid])
        //set V77=true
        call ReviveHero(udg_Hero[pid],GetUnitX(u),GetUnitY(u),true)
        call AddBuybackVisuals(udg_Hero[pid],r)
        //set V77=false
        call SetUnitState(udg_Hero[pid],UNIT_STATE_MANA,10000)
        set ReliableGold[pid]=IMaxBJ(0,ReliableGold[pid]-BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetSellingUnit()))]))])
        call GU9(p)
      else
        call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(GetOwningPlayer(GetSellingUnit()))]))])
        if IsImpossibleToBuyback[pid] then
          call Error(p,"Cannot buy back due to Reaper's Scythe")
        endif
      endif
    endif
    call KillUnit(u)
  endif
  set u=null
endfunction

function Fuse_Helper takes player whichPlayer,unit whichUnit,integer resultitem,integer i0,integer i1,integer i2,integer i3,integer i4,integer i5 returns nothing
  local item Item
  call DisableTrigger(GenericItemActionTrigger)
  if i0>0 then
    set Item=UnitItemInSlot(whichUnit,0)
    call DestroyItem(Item)
  endif
  if i1>0 then
    set Item=UnitItemInSlot(whichUnit,1)
    call DestroyItem(Item)
  endif
  if i2>0 then
    set Item=UnitItemInSlot(whichUnit,2)
    call DestroyItem(Item)
  endif
  if i3>0 then
    set Item=UnitItemInSlot(whichUnit,3)
    call DestroyItem(Item)
  endif
  if i4>0 then
    set Item=UnitItemInSlot(whichUnit,4)
    call DestroyItem(Item)
  endif
  if i5>0 then
    set Item=UnitItemInSlot(whichUnit,5)
    call DestroyItem(Item)
  endif
  set Item=UnitAddItemById(whichUnit,Item_Real[resultitem])
  call SetItemPlayer(Item,whichPlayer,true)
  call SetItemUserData(Item,0)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",whichUnit,"origin"))
  if GetIndex(Item)==indexid_bloodstone then
    call SetItemCharges(Item,8)
  endif
  call EnableTrigger(GenericItemActionTrigger)
  if IsPlayerAlly(GetLocalPlayer(),whichPlayer) then
    if resultitem==indexid_Mekansm then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,4,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r |c00ffff00"+GetObjectName('n0LX')+"|r")
    elseif resultitem==indexid_DivineRapier then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,4,udg_Colors[GetPlayerId(whichPlayer)]+(PlayerNames[GetPlayerId((whichPlayer))])+"|r |c00ffff00"+GetObjectName('n0LY')+"|r")
    endif
  endif
  set Item=null
endfunction

function Fuse takes player p,unit whichUnit,integer indexId returns boolean
  local integer i
  local integer x
  local integer y
  local integer array searchItems
  local boolean array searchItems_Active
  local integer array recipeItems
  local boolean array recipeItems_Active
  local boolean array found
  local integer array result
  local player whichPlayer
  local integer MaxSearch=1
  local integer k
  local player array PlayerSearches
  local integer m
  local item Inventory0
  local item Inventory1
  local item Inventory2
  local item Inventory3
  local item Inventory4
  local item Inventory5
  local player InventoryPlayer0
  local player InventoryPlayer1
  local player InventoryPlayer2
  local player InventoryPlayer3
  local player InventoryPlayer4
  local player InventoryPlayer5
  local integer InventoryUserData0
  local integer InventoryUserData1
  local integer InventoryUserData2
  local integer InventoryUserData3
  local integer InventoryUserData4
  local integer InventoryUserData5
  local integer InventoryIndex0
  local integer InventoryIndex1
  local integer InventoryIndex2
  local integer InventoryIndex3
  local integer InventoryIndex4
  local integer InventoryIndex5
  local boolean extrasearch=false
  local boolean resetvars=true
  set Inventory0=UnitItemInSlot(whichUnit,0)
  set Inventory1=UnitItemInSlot(whichUnit,1)
  set Inventory2=UnitItemInSlot(whichUnit,2)
  set Inventory3=UnitItemInSlot(whichUnit,3)
  set Inventory4=UnitItemInSlot(whichUnit,4)
  set Inventory5=UnitItemInSlot(whichUnit,5)
  set InventoryPlayer0=GetItemPlayer(Inventory0)
  set InventoryPlayer1=GetItemPlayer(Inventory1)
  set InventoryPlayer2=GetItemPlayer(Inventory2)
  set InventoryPlayer3=GetItemPlayer(Inventory3)
  set InventoryPlayer4=GetItemPlayer(Inventory4)
  set InventoryPlayer5=GetItemPlayer(Inventory5)
  set InventoryUserData0=GetItemUserData(Inventory0)
  set InventoryUserData1=GetItemUserData(Inventory1)
  set InventoryUserData2=GetItemUserData(Inventory2)
  set InventoryUserData3=GetItemUserData(Inventory3)
  set InventoryUserData4=GetItemUserData(Inventory4)
  set InventoryUserData5=GetItemUserData(Inventory5)
  set InventoryIndex0=GetIndex(Inventory0)
  set InventoryIndex1=GetIndex(Inventory1)
  set InventoryIndex2=GetIndex(Inventory2)
  set InventoryIndex3=GetIndex(Inventory3)
  set InventoryIndex4=GetIndex(Inventory4)
  set InventoryIndex5=GetIndex(Inventory5)
  if(GetPlayerSlotState((p))==PLAYER_SLOT_STATE_LEFT)then
    set MaxSearch=5
    set extrasearch=true
  endif
  set PlayerSearches[1]=p
  if extrasearch then
    set k=2
    set m=1
    loop
      exitwhen k>MaxSearch
      if IsSentinel(p)then
        if p!=Sentinels[m]then
          set PlayerSearches[k]=Sentinels[m]
          set k=k+1
        endif
      else
        if p!=Scourges[m]then
          set PlayerSearches[k]=Scourges[m]
          set k=k+1
        endif
      endif
      set m=m+1
    endloop
  endif
  set k=1
  loop
    exitwhen k>MaxSearch
    set whichPlayer=PlayerSearches[k]
    set i=0
    if Inventory0!=null and InventoryUserData0==1 and(InventoryPlayer0==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer0))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex0
    else
      set searchItems[i+1]=0
    endif
    set i=1
    if Inventory1!=null and InventoryUserData1==1 and(InventoryPlayer1==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer1))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex1
    else
      set searchItems[i+1]=0
    endif
    set i=2
    if Inventory2!=null and InventoryUserData2==1 and(InventoryPlayer2==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer2))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex2
    else
      set searchItems[i+1]=0
    endif
    set i=3
    if Inventory3!=null and InventoryUserData3==1 and(InventoryPlayer3==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer3))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex3
    else
      set searchItems[i+1]=0
    endif
    set i=4
    if Inventory4!=null and InventoryUserData4==1 and(InventoryPlayer4==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer4))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex4
    else
      set searchItems[i+1]=0
    endif
    set i=5
    if Inventory5!=null and InventoryUserData5==1 and(InventoryPlayer5==whichPlayer or Mode_PM or(GetPlayerSlotState((InventoryPlayer5))==PLAYER_SLOT_STATE_LEFT))then
      set searchItems[i+1]=InventoryIndex5
    else
      set searchItems[i+1]=0
    endif
    set searchItems[0]=indexId
    set i=1
    loop
      exitwhen i>(Recipe_Max)
      set recipeItems[0]=Rec_Comp_1[i]
      set recipeItems[1]=Rec_Comp_2[i]
      set recipeItems[2]=Rec_Comp_3[i]
      set recipeItems[3]=Rec_Comp_4[i]
      set recipeItems[4]=Rec_Comp_5[i]
      if resetvars then
        set recipeItems_Active[0]=true
        set recipeItems_Active[1]=true
        set recipeItems_Active[2]=true
        set recipeItems_Active[3]=true
        set recipeItems_Active[4]=true
        set recipeItems_Active[5]=true
        set recipeItems_Active[6]=true
        set searchItems_Active[0]=true
        set searchItems_Active[1]=true
        set searchItems_Active[2]=true
        set searchItems_Active[3]=true
        set searchItems_Active[4]=true
        set searchItems_Active[5]=true
        set searchItems_Active[6]=true
        set result[0]=0
        set result[1]=0
        set result[2]=0
        set result[3]=0
        set result[4]=0
        set result[5]=0
        set result[6]=0
        set resetvars=false
      endif
      set found[0]=false
      set found[1]=false
      set found[2]=false
      set found[3]=false
      set found[4]=false
      set x=0
      loop
        exitwhen x==5
        if recipeItems[x]==0 then
          set found[x]=true
        else
          set y=0
          loop
            if searchItems[y]==recipeItems[x]and searchItems_Active[y]and recipeItems_Active[x]then
              set searchItems_Active[y]=false
              set recipeItems_Active[x]=false
              set found[x]=true
              set result[y]=1
              set y=7
              set resetvars=true
            else
              set y=y+1
            endif
            exitwhen y==7
          endloop
        endif
        if found[x] then
          set x=x+1
        else
          set x=5
        endif
      endloop
      if found[0]and found[1]and found[2]and found[3]and found[4]then
        call Fuse_Helper(whichPlayer,whichUnit,Rec_Final[i],result[1],result[2],result[3],result[4],result[5],result[6])
        set i=Recipe_Max+2
      else
        set i=i+1
      endif
    endloop
    set tt_bool1=result[0]==1
    if i==(Recipe_Max+2)then
      set Inventory0=null
      set Inventory1=null
      set Inventory2=null
      set Inventory3=null
      set Inventory4=null
      set Inventory5=null
      return true
    endif
    set k=k+1
  endloop
  set Inventory0=null
  set Inventory1=null
  set Inventory2=null
  set Inventory3=null
  set Inventory4=null
  set Inventory5=null
  set InventoryPlayer0 =null
  set InventoryPlayer1 =null
  set InventoryPlayer2 =null
  set InventoryPlayer3 =null
  set InventoryPlayer4 =null
  set InventoryPlayer5 =null
  set whichPlayer=null
  return false
endfunction

function AttemptFuse takes player whichPlayer,unit whichUnit,integer indexId returns boolean
  local integer i=1
  local boolean result
  set tt_bool1=false
  set result=Fuse(whichPlayer,whichUnit,indexId)
  return result
endfunction

function FindDestination_Which2 takes nothing returns boolean
  if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and UnitInventorySize(GetFilterUnit())>1 and GetUnitTypeId(GetFilterUnit())!='ncop' and GetPlayerAlliance(GetOwningPlayer(GetFilterUnit()),GetOwningPlayer(tt_unit1),ALLIANCE_SHARED_CONTROL)and GetOwningPlayer(tt_unit1)!=GetOwningPlayer(GetFilterUnit())and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then
    if IsCourier(GetFilterUnit()) then
      set tt_int1=tt_int1+1
      set tt_unit2=GetFilterUnit()
    endif
  endif
  return false
endfunction

function FindDestination_Which takes nothing returns boolean
  if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and UnitInventorySize(GetFilterUnit())>1 and GetUnitTypeId(GetFilterUnit())!='ncop' and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then
    if GetOwningPlayer(tt_unit1)==GetOwningPlayer(GetFilterUnit())then
      if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
        if GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 then
          set tt_unit2=GetFilterUnit()
        endif
      elseif IsUnitType(tt_unit2,UNIT_TYPE_HERO)==false then
        set tt_unit2=GetFilterUnit()
      endif
    endif
  endif
  return false
endfunction

function FindDestination takes unit whichUnit,integer BonusRange returns unit
  local group g=GetAvailableGroup()
  set tt_unit1=whichUnit
  set tt_unit2=null
  call GroupEnumUnitsInRange(g,GetUnitX(tt_unit3),GetUnitY(tt_unit3),1300+BonusRange,Condition(function FindDestination_Which))
  if tt_unit2==null then
    set tt_int1=0
    call KillGroup(g)
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(tt_unit3),GetUnitY(tt_unit3),1100+BonusRange,Condition(function FindDestination_Which2))
    if tt_int1>1 then
      set tt_unit2=null
    endif
  endif
  call KillGroup(g)
  set g=null
  return tt_unit2
endfunction

function CheckFuse takes player whichPlayer,unit whichUnit,unit sellingUnit,integer indexId,real x,real y,integer charges,integer userdata returns nothing
  local unit Destination
  local item newItem
  set tt_unit3=sellingUnit
  //	call echo(I2S(indexId)+" "+Id2String(Item_Real[indexId]))
  if indexId<0 then
    return
  endif
  if GetUnitPointValue(whichUnit)==200 then
    set Destination=FindDestination(whichUnit,0)
    if Destination==null then
      set Destination=FindDestination(whichUnit,300)
    endif
  else
    set Destination=whichUnit
  endif
  if Destination==null or AttemptFuse(whichPlayer,Destination,FindRealIndexId(indexId))==false or tt_bool1==false then
    if IsIndexIdCharged(FindRealIndexId(indexId))then
      if GetEmptyInventorySlots(Destination)==0 or Destination==null then
        call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,charges)
      else
        set newItem=UnitAddItemById(Destination,Item_Real[indexId])
        call SetItemCharges(newItem,charges)
        call SetItemPlayer(newItem,whichPlayer,true)
        call SetItemUserData(newItem,userdata)
      endif
    elseif IsIndexIdConsumable(FindRealIndexId(indexId))then
      if Destination==null or(GetEmptyInventorySlots(Destination)==0 and FindItemOfType(Destination,Item_Real[indexId])==null)then
        call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,true,FG9(indexId))
      else
        set newItem=CreateItem(Item_Dummy[indexId],x,y)
        call SetItemPlayer(newItem,whichPlayer,true)
        call SetItemUserData(newItem,userdata)
        call SetItemCharges(newItem,FG9(indexId))
        call UnitAddItem(Destination,newItem)
      endif
    else
      if GetEmptyInventorySlots(Destination)==0 or Destination==null then
        call DelayedItemCreation(Item_Dummy[indexId],x,y,whichPlayer,false,0)
      else
        if indexId!=indexid_FlyingCourier then
          set newItem=UnitAddItemById(Destination,Item_Real[indexId])
          call SetItemPlayer(newItem,whichPlayer,true)
          call SetItemUserData(newItem,0)
        else
          call MakeFlyingCourier(newItem,whichPlayer)
        endif
      endif
    endif
  else
    if IsUnitType(Destination,UNIT_TYPE_HERO) then
      if userdata==0 then
        call Traffic_RegisterData("PUI_"+I2S(GetPlayerId(GetOwningPlayer(Destination))),Item_Real[FindRealIndexId(indexId)])
      endif
    endif
  endif
  set Destination=null
  set newItem=null
endfunction

function ItemStats_Track takes player p,integer indexId returns nothing
  local integer i=GetPlayerId(p)
  if indexId==indexid_ClarityPotion then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
  elseif indexId==indexid_HealingSalve then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
  elseif indexId==indexid_Tango then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+4
  elseif indexId==indexid_ObserverWards then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
    set ItemStats_Wards[i]=ItemStats_Wards[i]+2
  elseif indexId==indexid_SentryWards then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
    set ItemStats_Wards[i]=ItemStats_Wards[i]+2
  elseif indexId==indexid_ScrollOfTownPortal then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+1
  elseif indexId==indexid_dustofappearance then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
  elseif indexId==indexid_ghostpotion then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
  elseif indexId==indexid_wandofillusions then
    set ItemStats_Consumables[i]=ItemStats_Consumables[i]+2
  endif
endfunction

function UnitItem_RestrictBuying takes unit store,unit buyer returns boolean
  local integer indexId
  if(store==ScourgeBuilding_ShopGraveyard or store==ScourgeBuilding_ShopGateway)and IsUnitAlly(buyer,Scourges[0])then
    return false
  elseif(store==SentinelBuilding_ShopChimaera or store==SentinelBuilding_ShopCache)and IsUnitAlly(buyer,Sentinels[0])then
    return false
  endif
  set indexId=UnitToIndex(buyer)
  if indexId==indexid_ObserverWards or indexId==indexid_Gem or indexId==indexid_Smoke then
    return true
  endif
  return false
endfunction

function UnitItem_GetBestX takes unit sellingUnit,unit soldUnit returns real
  if sellingUnit==SentinelBuilding_ShopCache or sellingUnit==SentinelBuilding_ShopWeapon or sellingUnit==SentinelBuilding_ShopAccessorizer or sellingUnit==SentinelBuilding_ShopChimaera or sellingUnit==SentinelBuilding_Shop1 or sellingUnit==SentinelBuilding_Shop2 or sellingUnit==SentinelBuilding_Shop3 or sellingUnit==SentinelBuilding_Shop4 or sellingUnit==SentinelBuilding_Shop5 or sellingUnit==SentinelBuilding_Shop6 then
    return ItemSpawnX[GetPlayerId(GetOwningPlayer(soldUnit))]
  elseif sellingUnit==ScourgeBuilding_ShopGateway or sellingUnit==ScourgeBuilding_ShopWeapon or sellingUnit==ScourgeBuilding_ShopAccessorizer or sellingUnit==ScourgeBuilding_ShopGraveyard or sellingUnit==ScourgeBuilding_Shop1 or sellingUnit==ScourgeBuilding_Shop2 or sellingUnit==ScourgeBuilding_Shop3 or sellingUnit==ScourgeBuilding_Shop4 or sellingUnit==ScourgeBuilding_Shop5 or sellingUnit==ScourgeBuilding_Shop6 then
    return ItemSpawnX[GetPlayerId(GetOwningPlayer(soldUnit))]
  elseif sellingUnit==GoblinShop_Top or sellingUnit==GoblinMerch_Top then
    return-7133.
  elseif sellingUnit==GoblinShop_Bot or sellingUnit==GoblinMerch_Bot then
    return 7207.
  endif
  return GetUnitX(soldUnit)
endfunction

function UnitItem_GetBestY takes unit sellingUnit,unit soldUnit returns real
  if sellingUnit==SentinelBuilding_ShopCache or sellingUnit==SentinelBuilding_ShopWeapon or sellingUnit==SentinelBuilding_ShopAccessorizer or sellingUnit==SentinelBuilding_ShopChimaera or sellingUnit==SentinelBuilding_Shop1 or sellingUnit==SentinelBuilding_Shop2 or sellingUnit==SentinelBuilding_Shop3 or sellingUnit==SentinelBuilding_Shop4 or sellingUnit==SentinelBuilding_Shop5 or sellingUnit==SentinelBuilding_Shop6 then
    return ItemSpawnY[GetPlayerId(GetOwningPlayer(soldUnit))]
  elseif sellingUnit==ScourgeBuilding_ShopGateway or sellingUnit==ScourgeBuilding_ShopWeapon or sellingUnit==ScourgeBuilding_ShopAccessorizer or sellingUnit==ScourgeBuilding_ShopGraveyard or sellingUnit==ScourgeBuilding_Shop1 or sellingUnit==ScourgeBuilding_Shop2 or sellingUnit==ScourgeBuilding_Shop3 or sellingUnit==ScourgeBuilding_Shop4 or sellingUnit==ScourgeBuilding_Shop5 or sellingUnit==ScourgeBuilding_Shop6 then
    return ItemSpawnY[GetPlayerId(GetOwningPlayer(soldUnit))]
  elseif sellingUnit==GoblinShop_Top or sellingUnit==GoblinMerch_Top then
    return 4317.
  elseif sellingUnit==GoblinShop_Bot or sellingUnit==GoblinMerch_Bot then
    return-4243.
  endif
  return GetUnitY(soldUnit)
endfunction

function UnitItem_GetBestXOld takes unit sellingUnit,unit soldUnit returns real
  if sellingUnit==SentinelBuilding_ShopCache or sellingUnit==SentinelBuilding_ShopWeapon or sellingUnit==SentinelBuilding_ShopAccessorizer or sellingUnit==SentinelBuilding_ShopChimaera or sellingUnit==SentinelBuilding_Shop1 or sellingUnit==SentinelBuilding_Shop2 or sellingUnit==SentinelBuilding_Shop3 or sellingUnit==SentinelBuilding_Shop4 or sellingUnit==SentinelBuilding_Shop5 or sellingUnit==SentinelBuilding_Shop6 then
    return GetRectCenterX(gg_rct_Hero_Creation_NE)
  elseif sellingUnit==ScourgeBuilding_ShopGateway or sellingUnit==ScourgeBuilding_ShopWeapon or sellingUnit==ScourgeBuilding_ShopAccessorizer or sellingUnit==ScourgeBuilding_ShopGraveyard or sellingUnit==ScourgeBuilding_Shop1 or sellingUnit==ScourgeBuilding_Shop2 or sellingUnit==ScourgeBuilding_Shop3 or sellingUnit==ScourgeBuilding_Shop4 or sellingUnit==ScourgeBuilding_Shop5 or sellingUnit==ScourgeBuilding_Shop6 then
    return GetRectCenterX(gg_rct_Hero_Creation_UD)
  endif
  return GetUnitX(soldUnit)
endfunction

function UnitItem_GetBestYOld takes unit sellingUnit,unit soldUnit returns real
  if sellingUnit==SentinelBuilding_ShopCache or sellingUnit==SentinelBuilding_ShopWeapon or sellingUnit==SentinelBuilding_ShopAccessorizer or sellingUnit==SentinelBuilding_ShopChimaera or sellingUnit==SentinelBuilding_Shop1 or sellingUnit==SentinelBuilding_Shop2 or sellingUnit==SentinelBuilding_Shop3 or sellingUnit==SentinelBuilding_Shop4 or sellingUnit==SentinelBuilding_Shop5 or sellingUnit==SentinelBuilding_Shop6 then
    return GetRectCenterY(gg_rct_Hero_Creation_NE)
  elseif sellingUnit==ScourgeBuilding_ShopGateway or sellingUnit==ScourgeBuilding_ShopWeapon or sellingUnit==ScourgeBuilding_ShopAccessorizer or sellingUnit==ScourgeBuilding_ShopGraveyard or sellingUnit==ScourgeBuilding_Shop1 or sellingUnit==ScourgeBuilding_Shop2 or sellingUnit==ScourgeBuilding_Shop3 or sellingUnit==ScourgeBuilding_Shop4 or sellingUnit==ScourgeBuilding_Shop5 or sellingUnit==ScourgeBuilding_Shop6 then
    return GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  return GetUnitY(soldUnit)
endfunction

function UnitItem_Main takes nothing returns nothing
  local unit u=GetSoldUnit()
  local player p=GetOwningPlayer(u)
  local integer indexId=UnitToIndex(u)
  local real x
  local real y
  call UnitAddAbility(u,'Aloc')
  call ShowUnit(u,false)
  call UnitApplyTimedLife(u,'BTLF',2)
  if GetUnitTypeId(u)=='h03Q' and not FlyingCourierAllowed then
    call Error(p,"You can't buy Flying courier until 3 minutes mark.")
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+220)
    set u=null
    return
  endif
  if IsIndexIdConsumable(indexId)==false and Item_Real[indexId]!=0 then
    call SaveInteger(MHT,'ITEM',GetPlayerId(p),Item_Real[indexId])
    call SaveReal(MHT,'ITEM',GetPlayerId(p),TimerGetElapsed(GlobalTimer))
  endif
  if UnitItem_RestrictBuying(GetSellingUnit(),u)then
    call Error(p,GetObjectName('n02G'))
    if IsUnitAlly(u,Sentinels[0])then
      set p=Scourges[0]
    else
      set p=Sentinels[0]
    endif
    set x=UnitItem_GetBestXOld(GetSellingUnit(),u)
    set y=UnitItem_GetBestYOld(GetSellingUnit(),u)
    call DelayedItemCreation(Item_Dummy[UnitToIndex(u)],x,y,p,true,FG9(UnitToIndex(u)))
  else
    call ItemStats_Track(p,FindRealIndexId(indexId))
    if Item_Real[indexId]==0 then
      call Error(p,GetObjectName('n02H'))
    else
      set x=UnitItem_GetBestX(GetSellingUnit(),u)
      set y=UnitItem_GetBestY(GetSellingUnit(),u)
      if indexId==indexid_dustofappearance then
        call CheckFuse(p,u,GetSellingUnit(),FindRealIndexId(indexId),x,y,2,0)
      else
        call CheckFuse(p,u,GetSellingUnit(),FindRealIndexId(indexId),x,y,0,0)
      endif
    endif
  endif
  
  set u=null
  set p=null
endfunction

function AddPickTimeWrapper takes nothing returns nothing
  if b_isPickTime and TimerGetRemaining(NK)>0 and ((IsSentinel(GetTriggerPlayer()) and CanAddTime[0]>0) or (IsScourge(GetTriggerPlayer()) and CanAddTime[1]>0))then
    if IsSentinel(GetTriggerPlayer())then
      set CanAddTime[0]=CanAddTime[0]-1
      if IsDead(AddTime1) then
        call KillUnit(AddTime2)
      else
        call KillUnit(AddTime1)
      endif
    else
      set CanAddTime[1]=CanAddTime[1]-1
      if IsDead(AddTime3) then
        call KillUnit(AddTime4)
      else
        call KillUnit(AddTime3)
      endif
    endif
    call ExeFunc("AddTimeToTimer")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetTriggerPlayer())]+GetPlayerName(GetTriggerPlayer())+"|r"+" has added 1 minute to the picking time.")
  endif
endfunction

function AddTimeBought takes player p returns nothing
  if b_isPickTime and TimerGetRemaining(NK)>0 and ((IsSentinel(p) and CanAddTime[0]>0) or (IsScourge(p) and CanAddTime[1]>0))then
    if IsSentinel(p)then
      set CanAddTime[0]=CanAddTime[0]-1
    else
      set CanAddTime[1]=CanAddTime[1]-1
    endif
    call ExeFunc("AddTimeToTimer")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),.0,.0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(p)]+GetPlayerName(p)+"|r has added 1 minute to the picking time.")
  endif
endfunction

function UnitItem_Enter takes nothing returns boolean
  local unit u=GetSoldUnit()
  local player p=GetLocalPlayer()
  local player buyer=GetOwningPlayer(u)
  local integer pid=GetPlayerId(buyer)
  local integer uid=UnitToIndex(u)
  if GetUnitTypeId(u)=='h304' or GetUnitTypeId(u)=='h305' then
    if (IsSentinel(buyer) and GetUnitTypeId(u)=='h304') or (IsScourge(buyer) and GetUnitTypeId(u)=='h305') then
      call KillUnit(GetSellingUnit())
      call AddTimeBought(GetOwningPlayer(u))
    else
      call Error(buyer,"It's up to enemy to decide. Use Altars placed on your side.")
    endif
    call RemoveUnit(u)
  elseif GetUnitTypeId(u)=='h307' then
    set tt_player1=GetOwningPlayer(u)
    call ExeFunc("ReadyCMDAltar")
    call RemoveUnit(u)
  endif
  if GetUnitPointValue(u)>=200 then
    call UnitItem_Main()
    if IsPlayerAlly(p,buyer)or(udg_ObserverMode and(p==udg_Observer1 or p==udg_Observer2))then
      if uid==indexid_AnimalCourier then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,20,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0HU')+"|r")
      elseif uid==indexid_RecipeFlyingCourier and FlyingCourierAllowed then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KG')+"|r")
      elseif uid==indexid_dustofappearance then
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KO')+"|r")
      elseif uid==indexid_ObserverWards then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KP')+"|r")
      elseif uid==indexid_SentryWards then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KQ')+"|r")
      elseif uid==indexid_RecipeUrnOfShadows then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0KT')+"|r")
      elseif uid==indexid_Gem then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0LB')+"|r")
      elseif uid==indexid_Smoke then
        call PingMinimapEx(GetUnitX(u),GetUnitY(u),3,255,255,255,false)
        call DisplayTimedTextToPlayer(p,0,0,4,udg_Colors[pid]+(PlayerNames[pid])+"|r |c00ffff00"+GetObjectName('n0LP')+"|r")
      endif
    endif
    if uid==indexid_Bottle0Shop then
      if BottlePickupRunesOldfashion[pid]==false then
        call DisplayTimedTextToPlayer(buyer,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|c00FF0000Note|r: you can disable or enable righ-click rune picking using '-orp' chat command. It's enabled by default.")
      endif
    endif
  else
    call DeliverItems_Main()
  endif
  set u=null
  return false
endfunction


function IsDoubleFacedItem takes integer iit returns boolean
  return iit==indexid_EyeOfSkadiRanged or iit==indexid_EyeOfSkadi or iit==indexid_QuellingBladeRanged or iit==indexid_QuellingBlade or iit==indexid_StoutShieldRanged or iit==indexid_StoutShield or iit==indexid_PoormansShieldRanged or iit==indexid_PoormansShield or iit==indexid_VanguardRanged or iit==indexid_Vanguard or iit==indexid_OrbOfVenomRanged or iit==indexid_OrbOfVenom or iit==indexid_MantaStyleRanged or iit==indexid_MantaStyle
endfunction

function RestrictedItems_UpdateMeleeRange takes unit u,item it returns nothing
  local integer uid=GetUnitTypeId(u)
  local integer iid=GetIndexNoMute(it)
  local player p
  if IsDoubleFacedItem(iid)==false then
    return
  endif
  if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) or IsUnitType(u,UNIT_TYPE_HERO)==false then
    if iid==indexid_EyeOfSkadiRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_EyeOfSkadi],p,false,1)
    elseif iid==indexid_QuellingBladeRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_QuellingBlade],p,false,1)
    elseif iid==indexid_StoutShieldRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_StoutShield],p,false,1)
    elseif iid==indexid_PoormansShieldRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_PoormansShield],p,false,1)
    elseif iid==indexid_VanguardRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Vanguard],p,false,1)
    elseif iid==indexid_OrbOfVenomRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_OrbOfVenom],p,false,1)
    elseif iid==indexid_MantaStyleRanged then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_MantaStyle],p,false,1)
    endif
  else
    if iid==indexid_EyeOfSkadi then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_EyeOfSkadiRanged],p,false,1)
    elseif iid==indexid_QuellingBlade then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_QuellingBladeRanged],p,false,1)
    elseif iid==indexid_StoutShield then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_StoutShieldRanged],p,false,1)
    elseif iid==indexid_PoormansShield then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_PoormansShieldRanged],p,false,1)
    elseif iid==indexid_Vanguard then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_VanguardRanged],p,false,1)
    elseif iid==indexid_OrbOfVenom then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_OrbOfVenomRanged],p,false,1)
    elseif iid==indexid_MantaStyle then
      set p=GetItemPlayer(it)
      call DestroyItem(it)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_MantaStyleRanged],p,false,1)
    endif
  endif
endfunction

function RestrictedItems takes unit Hero,item Item returns boolean
  local unit u=Hero
  local integer unitId=GetUnitTypeId(u)
  local integer indexId=GetIndex(Item)
  local real x
  local real y
  local integer i
  local boolean continue=true
  set x=GetUnitX(u)
  set y=GetUnitY(u)
  if indexId==indexid_Bottle0Shop then
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
    call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    call UnitAddItemByIdLoD(Hero,Item_Real[indexid_Bottle3],tt_player1,false,1)
    call UnitRemoveAbility(u,'B0GI')
  endif
  if (indexId)==indexid_DiffusalBlade and GetItemCharges(Item)==0 then
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    call UnitAddItemByIdLoD(Hero,Item_Real[indexid_DiffusalBlade_empty],tt_player1,false,1)
  endif
  if indexId==indexid_janggo and GetItemCharges(Item)==0 then
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    call UnitAddItemByIdLoD(Hero,Item_Real[indexid_janggoempty],tt_player1,false,1)
  endif
  call DisableTrigger(t_manipulateitem)
  if(indexId==indexid_PowerTreadsStrength or indexId==indexid_PowerTreadsAgility or indexId==indexid_PowerTreadsIntelligence)and(FindItemOfTypeEx(u,Item_Real[indexid_PowerTreadsStrength],Item)!=null or FindItemOfTypeEx(u,Item_Real[indexid_PowerTreadsAgility],Item)!=null or FindItemOfTypeEx(u,Item_Real[indexid_PowerTreadsIntelligence],Item)!=null)then
    call Error(GetOwningPlayer(u),GetObjectName('n02L'))
    set tt_player1=GetItemPlayer(Item)
    call RemoveItem(Item)
    set tt_item1=CreateItem(Item_Dummy[indexId],x,y)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  endif
  if(indexId==indexid_ArmletOff or indexId==indexid_ArmletOn or indexId==indexid_ArmletOffCourier or indexId==indexid_ArmletOnCourier)and(FindItemOfTypeEx(u,Item_Real[indexid_ArmletOff],Item)!=null or FindItemOfTypeEx(u,Item_Real[indexid_ArmletOn],Item)!=null or FindItemOfTypeEx(u,Item_Real[indexid_ArmletOffCourier],Item)!=null or FindItemOfTypeEx(u,Item_Real[indexid_ArmletOnCourier],Item)!=null)then
    call Error(GetOwningPlayer(u),GetObjectName('n02C'))
    set tt_player1=GetItemPlayer(Item)
    call RemoveItem(Item)
    set tt_item1=CreateItem(Item_Dummy[indexId],x,y)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  endif
  if(indexId==indexid_BKB10 or indexId==indexid_BKB09 or indexId==indexid_BKB08 or indexId==indexid_BKB07 or indexId==indexid_BKB06 or indexId==indexid_BKB05)then
    set i=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(u)),'0BKB')
    if i==0 and indexId!=indexid_BKB10 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB10],tt_player1,false,1)
    elseif i==9 and indexId!=indexid_BKB09 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB09],tt_player1,false,1)
    elseif i==8 and indexId!=indexid_BKB08 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB08],tt_player1,false,1)
    elseif i==7 and indexId!=indexid_BKB07 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB07],tt_player1,false,1)
    elseif i==6 and indexId!=indexid_BKB06 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB06],tt_player1,false,1)
    elseif i==5 and indexId!=indexid_BKB05 then
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call UnitAddItemByIdLoD(Hero,Item_Real[indexid_BKB05],tt_player1,false,1)
    endif
  endif
  if(indexId==indexid_DivineRapier and IsPlayerEnemy(GetItemPlayer(Item),GetOwningPlayer(u)))then
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=UnitAddItemById(u,Item_Real[indexid_DivineRapierFree])
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  endif
  if(indexId==indexid_Aegis)and(IsFlyingCourier(u)or IsSpiritBear(u))then
    if IsFlyingCourier(u)then
      call Error(GetOwningPlayer(u),GetObjectName('n02K'))
    endif
    set tt_player1=GetItemPlayer(Item)
    set tt_int1=GetItemCharges(Item)
    call RemoveItem(Item)
    if indexId==indexid_Aegis then
      set tt_item1=CreateItem(Item_Dummy[indexId],GetRectCenterX(Q4),GetRectCenterY(Q4))
    endif
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
    if indexId==indexid_Aegis then
      call SetItemCharges(tt_item1,tt_int1)
    endif
  endif
  call EnableTrigger(t_manipulateitem)
  if continue then
    call RestrictedItems_UpdateMeleeRange(Hero,Item)
  endif
  set u=null
  set Item=null
  return false
endfunction

function B69 takes integer indexId returns boolean
  return indexId==indexid_HelmOfTheDominatorCourier or indexId==indexid_ArmletOnCourier or indexId==indexid_ArmletOffCourier or indexId==indexid_ShivasGuardCourier or indexId==indexid_HelmOfTheDominator or indexId==indexid_ArmletOn or indexId==indexid_ArmletOff or indexId==indexid_ShivasGuard or indexId==indexid_Gem or indexId==indexid_GemCourier or indexId==indexid_HandOfMidas or indexId==indexid_HandOfMidasCourier
endfunction

function BL9 takes integer indexId returns boolean
  return indexId==indexid_Gem or indexId==indexid_GemCourier
endfunction

function B19 takes unit Hero,item Item returns boolean
  local integer FN9=0
  local item B38=Item
  local integer indexId=F49(B38)
  local integer B09=0
  local boolean result=false
  local integer B59=F79(B38)
  local boolean B29=false
  if IsUnitType(Hero,UNIT_TYPE_HERO) then
    if indexId==indexid_HelmOfTheDominatorCourier then
      set B09=indexid_HelmOfTheDominator
    endif
    if indexId==indexid_HandOfMidasCourier then
      set B09=indexid_HandOfMidas
    endif
    if indexId==indexid_ArmletOnCourier then
      set B09=indexid_ArmletOn
    endif
    if indexId==indexid_ArmletOffCourier then
      set B09=indexid_ArmletOff
    endif
    if indexId==indexid_ShivasGuardCourier then
      set B09=indexid_ShivasGuard
    endif
    if indexId==indexid_GemCourier then
      set B09=indexid_Gem
    endif
    if B59==indexid_GemCourier then
      set B09=indexid_Gem
      set B29=true
    endif
    if B09!=0 then
      set tt_player1=GetItemPlayer(B38)
      call DestroyItem(B38)
      if B29 then
        set tt_item1=UnitAddItemById(Hero,Item_Mute[B09])
      else
        set tt_item1=UnitAddItemById(Hero,Item_Real[B09])
      endif
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      set result=true
    endif
  else
    if indexId==indexid_HelmOfTheDominator then
      set B09=indexid_HelmOfTheDominatorCourier
    endif
    if IsSpiritBear(Hero)==false then
      if indexId==indexid_HandOfMidas then
        set B09=indexid_HandOfMidasCourier
      endif
    else
      if indexId==indexid_HandOfMidasCourier then
        set B09=indexid_HandOfMidas
      endif
    endif
    if indexId==indexid_ArmletOn then
      set B09=indexid_ArmletOnCourier
    endif
    if indexId==indexid_ArmletOff then
      set B09=indexid_ArmletOffCourier
    endif
    if indexId==indexid_ShivasGuard then
      set B09=indexid_ShivasGuardCourier
    endif
    if indexId==indexid_Gem then
      set B09=indexid_GemCourier
    endif
    if B59==indexid_Gem then
      set B09=indexid_GemCourier
      set B29=true
    endif
    if B09!=0 then
      set tt_player1=GetItemPlayer(B38)
      call DestroyItem(B38)
      if B29 then
        set tt_item1=UnitAddItemById(Hero,Item_Mute[B09])
      else
        set tt_item1=UnitAddItemById(Hero,Item_Real[B09])
      endif
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      set result=true
    endif
  endif
  set B38=null
  return result
endfunction

function CourierFakedItems_Main takes unit Hero,item Item returns boolean
  if B69(F49(Item))or BL9(F79(Item))then
    return B19(Hero,Item)
  endif
  return false
endfunction

function C79 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Unit=(LoadUnitHandle(HY,h,(26)))
  local integer EventType=(LoadInteger(HY,h,(97)))
  local integer indexId=(LoadInteger(HY,h,(93)))
  local boolean temporary=(LoadBoolean(HY,h,(95)))
  local item Item
  local player p=GetOwningPlayer(Unit)
  local player owner
  local integer charges
  local boolean consumable=false
  local item newItem
  local integer scepter_indexid
  local integer scepter_abilityid
  local integer scepter_hiddenabilityid
  local integer newCharges
  local item targetItem
  local integer targetCount
  local item FinalItem
  local boolean finished=false
  local integer i
  local integer k
  local real tt
  local boolean scepterWorks
  call DisableTrigger(GenericItemActionTrigger)
  if temporary then
    set FinalItem=null
    set owner=(LoadPlayerHandle(HY,h,(54)))
    set charges=(LoadInteger(HY,h,(76)))
  else
    set Item=(LoadItemHandle(HY,h,(96)))
    set FinalItem=Item
    set owner=GetItemPlayer(Item)
    set charges=GetItemCharges(Item)
  endif
  if temporary==false and Item==null then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call EnableTrigger(GenericItemActionTrigger)
    set t=null
    set Unit=null
    set p=null
    return false
  endif
  if EventType==1 then
    if p!=owner and GetUnitTypeId(Unit)=='ncop' then
      if IsIndexIdConsumable(FindRealIndexId(indexId))or IsIndexIdCharged(FindRealIndexId(indexId))then
        set consumable=true
      endif
      if IsPlayerEnemy(p,owner)then
        call DelayedItemCreation(Item_Dummy[indexId],ItemSpawnX[GetPlayerId(p)],ItemSpawnY[GetPlayerId(p)],owner,consumable,charges)
      else
        call DelayedItemCreation(Item_Dummy[indexId],ItemSpawnX[GetPlayerId(owner)],ItemSpawnY[GetPlayerId(owner)],owner,consumable,charges)
      endif
      call Error(p,GetObjectName('n0DR'))
      if temporary==false then
        set finished=true
        call DestroyItem(Item)
      endif
    elseif Mode_PM==false and temporary==false and GetItemType(Item)==ITEM_TYPE_CAMPAIGN and MuteToRealId(Item)!=0 and(p==owner or(GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT))then
      if IsIndexIdCharged(indexId)then
        set consumable=true
      else
        set consumable=false
      endif
      if GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT and Bottle_IsIndexRune(indexId)then
      else
        call DestroyItem(Item)
        set finished=true
        set newItem=UnitAddItemById(Unit,Item_Real[indexId])
        set FinalItem=newItem
        call SetItemPlayer(newItem,owner,false)
        call SetItemUserData(newItem,0)
        if consumable or indexId==indexid_Tango or indexId==indexid_HealingSalve or indexId==indexid_ClarityPotion then
          call SetItemCharges(newItem,charges)
        endif
      endif
    elseif Mode_PM==false and temporary==false and GetItemType(Item)==ITEM_TYPE_PERMANENT and p!=owner and Item_Mute[GetIndex(Item)]!=0 and(GetPlayerSlotState(owner)==PLAYER_SLOT_STATE_LEFT)==false then
      if IsIndexIdCharged(indexId)then
        set consumable=true
      else
        set consumable=false
      endif
      call DestroyItem(Item)
      set finished=true
      set newItem=UnitAddItemById(Unit,Item_Mute[indexId])
      set FinalItem=newItem
      call SetItemPlayer(newItem,owner,false)
      call SetItemUserData(newItem,0)
      if consumable then
        call SetItemCharges(newItem,charges)
      endif
    elseif temporary==false and GetItemType(Item)==ITEM_TYPE_PERMANENT and IsAghanim(Item)and IsUnitType(Unit,UNIT_TYPE_HERO) then
      if HeroAghanim(Unit,false) then
        if indexId!=indexid_aghanimUpgrader then
          call DestroyItem(Item)
          set newItem=UnitAddItemById(Unit,Item_Real[indexid_aghanimUpgrader])
          set FinalItem=newItem
          call SetItemPlayer(newItem,owner,false)
          call SetItemUserData(newItem,1)
        endif
      else
        if indexId!=indexid_AghanimBasic then
          call DestroyItem(Item)
          set newItem=UnitAddItemById(Unit,Item_Real[indexid_AghanimBasic])
          set FinalItem=newItem
          call SetItemPlayer(newItem,owner,false)
          call SetItemUserData(newItem,1)
        endif
      endif
    elseif temporary==false and GetItemType(Item)==ITEM_TYPE_ARTIFACT then
      if (p!=owner and IsPlayerLeaver(owner)==false and (indexId==indexid_Tango or indexId==indexid_HealingSalve or indexId==indexid_ClarityPotion)) then
        call DisableTrigger(t_manipulateitem)
        call DestroyItem(Item)
        set newItem=UnitAddItemById(Unit,Item_Mute[indexId])
        set FinalItem=newItem
        call SetItemPlayer(newItem,owner,false)
        call SetItemUserData(newItem,1)
        call SetItemCharges(newItem,charges)
        call EnableTrigger(t_manipulateitem)
      else
        call DisableTrigger(t_manipulateitem)
        set targetItem=FindItemOfIndexExForPlayer(owner,Unit,indexId,Item)
        if targetItem==null then
        else
          call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
          call DestroyItem(Item)
          set FinalItem=null
        endif
        call EnableTrigger(t_manipulateitem)
      endif
    elseif temporary and IsIndexIdConsumable(FindRealIndexId(indexId))then
      if (p==owner) then
        call DisableTrigger(t_manipulateitem)
        if GetEmptyInventorySlots(Unit)==0 and FindItemOfIndexForPlayer(owner,Unit,indexId)==null then
          call Error(p,GetObjectName('n02O'))
          call DelayedItemCreation(Item_Dummy[(indexId)],(((LoadReal(HY,h,6)))*1.),(((LoadReal(HY,h,7)))*1.),(owner),(true),(charges))
        else
          set targetItem=FindItemOfIndexForPlayer(owner,Unit,indexId)
          if targetItem==null then
            call DisableTrigger(t_manipulateitem)
            set newItem=UnitAddItemById(Unit,Item_Real[indexId])
            set FinalItem=newItem
            call SetItemPlayer(newItem,owner,false)
            call SetItemUserData(newItem,1)
            call SetItemCharges(newItem,charges)
          else
            call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
          endif
        endif
        call EnableTrigger(t_manipulateitem)
      else
        if Item_Mute[indexId]>0 then
          set tt_int1=Item_Mute[indexId]
        else
          set tt_int1=Item_Real[indexId]
        endif
        call DisableTrigger(t_manipulateitem)
        set targetItem=FindItemOfIndexForPlayer(owner,Unit,indexId)
        if targetItem==null and GetEmptyInventorySlots(Unit)!=0 then
          set newItem=UnitAddItemById(Unit,tt_int1)
          set FinalItem=newItem
          call SetItemPlayer(newItem,owner,false)
          call SetItemUserData(newItem,1)
          call SetItemCharges(newItem,charges)
        elseif targetItem==null and GetEmptyInventorySlots(Unit)==0 then
          call Error(p,GetObjectName('n02O'))
          call DelayedItemCreation(Item_Dummy[(indexId)],(((LoadReal(HY,h,6)))*1.),(((LoadReal(HY,h,7)))*1.),(owner),(true),(charges))
        else
          call SetItemCharges(targetItem,charges+GetItemCharges(targetItem))
        endif
        call EnableTrigger(t_manipulateitem)
      endif
    elseif temporary then
      call CheckFuse(owner,Unit,null,indexId,LoadReal(HY,h,6),LoadReal(HY,h,7),charges,1)
    elseif temporary==false and(GetItemType(Item)==ITEM_TYPE_PERMANENT or GetItemType(Item)==ITEM_TYPE_CAMPAIGN)then
      call SetItemUserData(Item,1)
      set finished=AttemptFuse(owner,Unit,0)
    endif
    if finished==false and FinalItem!=null and IsItemTemporary(FinalItem)==false then
      set finished=CourierFakedItems_Main(Unit,FinalItem)
    endif
    if finished==false and FinalItem!=null and IsItemTemporary(FinalItem)==false then
      call RestrictedItems(Unit,FinalItem)
    endif
    if indexId==indexid_RadianceOn then
      call ExeFunc("RadiancePick")
    endif
  else
    if GetWidgetLife(Item)>0 then
      set tt_item1=Item
      if IsAghanim(Item) then
        call HeroAghanim(Unit,true)
      endif
      if GetItemUserData(Item)==-500 then
        call RemoveItem(Item)
      elseif IsItemOwned(Item)==false then
        if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(indexId) or indexId==indexid_HealingSalve or indexId==indexid_ClarityPotion or indexId==indexid_Tango then
          set consumable=true
        endif
        call DelayedItemCreation(Item_Dummy[indexId],GetItemX(Item),GetItemY(Item),owner,consumable,charges)
        call DestroyItem(Item)
      endif
    endif
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call EnableTrigger(GenericItemActionTrigger)
  set t=null
  set Item=null
  set Unit=null
  set p=null
  set owner=null
  set newItem=null
  set targetItem=null
  set FinalItem=null
  return false
endfunction



function TranquilsRegister takes nothing returns nothing
  if tranquilsExists==false then
    call AddWrapper("TranquilBootsWrapper",0)
    set tranquilsExists=true
  endif
endfunction

function MjollnirRegister takes nothing returns nothing
  if MjollnirsExists==false then
    call AddWrapper("MjollnirsWrapper",0)
    set MjollnirsExists=true
  endif
endfunction

function QuellingBladeRegister takes nothing returns nothing
  if QuellingBladeExists==false then
    call AddWrapper("QuellingBladeWrapper",0)
    set QuellingBladeExists=true
  endif
endfunction

function DiffusalBladeRegister takes nothing returns nothing
  if DiffusalBladeExists==false then
    call AddWrapper("DiffusalBladeWrapper",0)
    set DiffusalBladeExists=true
  endif
endfunction

function OrbOfVenomRegister takes nothing returns nothing
  if OrbOfVenomExists==false then
    call AddWrapper("OrbOfVenomWrapper",0)
    set OrbOfVenomExists=true
  endif
endfunction

function SkadiRegister takes nothing returns nothing
  if SkadiExists==false then
    call AddWrapper("SkadiWrapper",2)
    set SkadiExists=true
  endif
endfunction



function CM9 takes nothing returns boolean
  local item Item
  local integer EventType
  local unit Unit=GetTriggerUnit()
  local trigger t
  local integer h
  local integer scepter_indexid
  local integer scepter_abilityid
  local integer id
  local integer k
  local item it
  local integer i=GetItemTypeId(GetManipulatedItem())
  set NetWorthRecount[GetPlayerId(GetOwningPlayer(Unit))]=true
  set id=GetPlayerId(GetOwningPlayer(Unit))
  if(IsUnitType(Unit,UNIT_TYPE_HERO) or IsSpiritBear(Unit))and IsUnitIllusion(Unit)==false then
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
      if i==Item_Real[indexid_javelin]then
        set HasItem_Javelin[id]=HasItem_Javelin[id]+1
      elseif i==Item_Real[indexid_KelensDagger]then
        set TotalCount_Dagger=TotalCount_Dagger+1
        set HasItem_Dagger[id]=HasItem_Dagger[id]+1
      elseif i==Item_Real[indexid_bloodstone]then
        set TotalCount_Bloodstone=TotalCount_Bloodstone+1
        set HasItem_Bloodstone[id]=HasItem_Bloodstone[id]+1
      elseif i==Item_Real[indexid_CraniumBasher]or (i)==Item_Real[indexid_AbyssalBlade]then
        set HasItem_CraniumBasher[id]=HasItem_CraniumBasher[id]+1
      elseif i==Item_Real[indexid_HeartOfTarrasque]then
        set TotalCount_Heart=TotalCount_Heart+1
        set HasItem_Heart[id]=HasItem_Heart[id]+1
      elseif i==Item_Real[indexid_LinkensSphere]then
        set TotalCount_LinkenSphere=TotalCount_LinkenSphere+1
        set HasItem_LinkenSphere[id]=HasItem_LinkenSphere[id]+1
        call DisableTrigger(t_manipulateitem)
        set it=CreateItem('I0HM',GetUnitX(Unit),GetUnitY(Unit))
        call UnitAddItem(Unit,it)
        if GetWidgetLife(it)>0 then
          call RemoveItem(it)
        endif
        set it=null
        call EnableTrigger(t_manipulateitem)
      elseif i==Item_Real[indexid_SangeAndYasha]then
        set HasItem_SangeNYasha[id]=HasItem_SangeNYasha[id]+1
      elseif i==Item_Real[indexid_Sange]then
        set HasItem_Sange[id]=HasItem_Sange[id]+1
      elseif (i)==Item_Real[indexid_HeavensHalberd]then
        set HasItem_HeavensHalberd[id]=HasItem_HeavensHalberd[id]+1
      elseif i==Item_Real[indexid_TranquilBoots]then
        set TotalCount_Tranquils=TotalCount_Tranquils+1
        call TranquilsRegister()
        set HasItem_TranquilBoots[id]=HasItem_TranquilBoots[id]+1
      elseif i==Item_Real[indexid_QuellingBlade] or i==Item_Real[indexid_QuellingBladeRanged]then
        call QuellingBladeRegister()
      elseif i==Item_Real[indexid_DiffusalBlade] or i==Item_Real[indexid_DiffusalBlade_upg] or id==Item_Real[indexid_DiffusalBlade_empty] then
        call DiffusalBladeRegister()
      elseif i==Item_Real[indexid_EyeOfSkadi] or i==Item_Real[indexid_EyeOfSkadiRanged] then
        call SkadiRegister()
      elseif i==Item_Real[indexid_OrbOfVenom] or i==Item_Real[indexid_OrbOfVenomRanged] then
        call OrbOfVenomRegister()
      elseif i==Item_Real[indexid_Mjollnir] or i==Item_Real[indexid_Maelstrom] then
        call MjollnirRegister()
      elseif i==Item_Real[indexid_Butterfly] then
        if HaveSavedHandle(HY,GetHandleId(Unit),'AIev')==false then
          call UnitAddAbility2(Unit,'A431')
          call UnitMakeAbilityPermanent(Unit,true,'AIev')
        endif
      endif
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
      if i==Item_Real[indexid_javelin]then
        set HasItem_Javelin[id]=HasItem_Javelin[id]-1
      elseif i==Item_Real[indexid_KelensDagger]then
        set HasItem_Dagger[id]=HasItem_Dagger[id]-1
        set TotalCount_Dagger=TotalCount_Dagger-1
      elseif i==Item_Real[indexid_TranquilBoots]then
        set HasItem_TranquilBoots[id]=HasItem_TranquilBoots[id]-1
        set TotalCount_Tranquils=TotalCount_Tranquils-1
      elseif i==Item_Real[indexid_bloodstone]then
        set HasItem_Bloodstone[id]=HasItem_Bloodstone[id]-1
        set TotalCount_Bloodstone=TotalCount_Bloodstone-1
      elseif i==Item_Real[indexid_CraniumBasher]or (i)==Item_Real[indexid_AbyssalBlade]then
        set HasItem_CraniumBasher[id]=HasItem_CraniumBasher[id]-1
        if HasItem_CraniumBasher[id]<1 or FindItemOfTypeEx(Unit,Item_Real[indexid_CraniumBasher],GetManipulatedItem())==null or FindItemOfTypeEx(Unit,Item_Real[indexid_AbyssalBlade],GetManipulatedItem())==null then
          call UnitRemoveAbility(Unit,'A174')
        endif
      elseif i==Item_Real[indexid_HeartOfTarrasque]then
        set HasItem_Heart[id]=HasItem_Heart[id]-1
        set TotalCount_Heart=TotalCount_Heart-1
      elseif i==Item_Real[indexid_LinkensSphere]or i==Item_Mute[indexid_LinkensSphere]then
        set TotalCount_LinkenSphere=IMaxBJ(TotalCount_LinkenSphere-1,0)
        set HasItem_LinkenSphere[id]=IMaxBJ(HasItem_LinkenSphere[id]-1,0)
        call UnitRemoveAbility(Unit,'B0BI')
      elseif i==Item_Real[indexid_Butterfly] then
        if FindItemOfTypeEx(Unit,Item_Real[indexid_Butterfly],GetManipulatedItem())==null then
          call UnitRemoveAbility(Unit,'A431')
        endif
      endif
    endif
  endif
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
    set Item=GetSoldItem()
    call SetItemUserData(Item,-2)
    set tt_item1=Item
    if IsAghanim(Item) then
      call HeroAghanim(Unit,true)
    endif
  elseif GetItemTypeId(GetManipulatedItem())!='I02M' then
    set Item=GetManipulatedItem()
    if IsUnitIllusion(Unit)or GetItemUserData(Item)==-2 then
      set Item=null
      set Unit=null
      set t=null
      return false
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
      set EventType=1
    else
      set EventType=2
    endif
    if((EventType==1) or(EventType==2 and IsItemTemporary(Item)==false and GetWidgetLife(Item)>0))and GetUnitTypeId(Unit)!='H00J' then
      if IsRune(GetItemTypeId(Item)) or IsFakeRune(GetItemTypeId(Item)) or GetItemTypeId(Item)=='I0HM' then
        set Item=null
        set Unit=null
        set t=null
        return false
      endif
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterTimerEvent(t,0,false)
      call TriggerAddCondition(t,Condition(function C79))
      call SaveUnitHandle(HY,h,(26),(Unit))
      call SaveInteger(HY,h,(97),(EventType))
      call SaveInteger(HY,h,(93),(GetIndex(Item)))
      call SaveItemHandle(HY,h,0,Item)
      if IsItemTemporary(Item)then
        call SaveBoolean(HY,h,(95),(true))
        call SavePlayerHandle(HY,h,(54),(GetItemPlayer(Item)))
        call SaveInteger(HY,h,(76),(GetItemCharges(Item)))
        //call BJDebugMsg(I2S(GetItemCharges(Item)))
        call SaveReal(HY,h,6,((GetItemX(Item))*1.))
        call SaveReal(HY,h,7,((GetItemY(Item))*1.))
      else
        call SaveBoolean(HY,h,(95),(false))
        call SaveItemHandle(HY,h,(96),(Item))
        call SetItemUserData(Item,0)
      endif
    endif
  endif
  set Item=null
  set Unit=null
  set t=null
  return false
endfunction

function CO9 takes unit Hero,integer CP9,boolean CQ9 returns nothing
  local string CR9
  local string s
  local player p=GetOwningPlayer(Hero)
  local real d=2
  local string CS9="Use"
  if CQ9 then
    set CS9="Store"
  endif
  if CP9=='I006' then
    set CR9="|c00ff0000"+GetObjectName('n0JQ')+"|r"
    call Traffic_RegisterData("Rune"+CS9+"1",GetPlayerId(p))
  elseif CP9=='I008' then
    set CR9="|c0000ff00"+GetObjectName('n0JN')+"|r"
    call Traffic_RegisterData("Rune"+CS9+"2",GetPlayerId(p))
  elseif CP9=='I00K' then
    set CR9="|c000000ff"+GetObjectName('n0K3')+"|r"
    call Traffic_RegisterData("Rune"+CS9+"3",GetPlayerId(p))
  elseif CP9=='I007' then
    set CR9="|c00afaf00"+GetObjectName('n0K2')+"|r"
    call Traffic_RegisterData("Rune"+CS9+"4",GetPlayerId(p))
  elseif CP9=='I00J' then
    set CR9="|c00652DC1"+GetObjectName('n0K4')+"|r"
    call Traffic_RegisterData("Rune"+CS9+"5",GetPlayerId(p))
  elseif CP9=='I0QA' then
    set CR9="|c00ffff01"+"Bounty"+"|r"
    call Traffic_RegisterData("Rune"+CS9+"6",GetPlayerId(p))
  endif
  if CQ9 then
    set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GU')+"|r "+CR9+" "+GetObjectName('n0GW')
    set d=1
  else
    if VP7 then
      set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GV')+"|r "+CR9+" "+GetObjectName('n0GW')
    else
      set s=udg_Colors[GetPlayerId(p)]+GetUnitName(Hero)+"|r "+GetObjectName('n0GT')+"|r "+CR9+" "+GetObjectName('n0GW')
    endif
  endif
  if(IsPlayerAlly(GetLocalPlayer(),p)and GetLocalPlayer()!=p)or IsObserver(GetLocalPlayer())then
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,d,s)
  endif
  set p=null
endfunction

function SmoothHealingSystemDurForBottle takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,0)
  local integer buffid=LoadInteger(HY,h,0)
  local real amounthp=LoadReal(HY,h,0)
  local real amountmp=LoadReal(HY,h,1)
  local real duration=LoadReal(HY,h,2)
  if IsDead(target)==false and GetUnitAbilityLevel(target,buffid)>0 then
    if amountmp>0 then
      call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)+amountmp/duration*0.1)
    endif
    if amounthp>0 then
      call SetWidgetLife(target,GetWidgetLife(target)+amounthp/duration*0.1)
    endif
  else
    call SaveBoolean(MHT,GetHandleId(target),buffid,false)
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call DestroyTimer(t)
  endif
  set t=null
  set target=null
endfunction

function SmoothHealingSystemForBottle takes real hp, real mp, real dur, integer buffid, unit target returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.1,true,function SmoothHealingSystemDurForBottle)
  call SaveUnitHandle(HY,h,0,target)
  call SaveBoolean(MHT,GetHandleId(target),buffid,true)
  call SaveInteger(HY,h,0,buffid)
  call SaveReal(HY,h,0,hp)
  call SaveReal(HY,h,1,mp)
  call SaveReal(HY,h,2,dur)
  set t=null
endfunction

function SmoothHealingSystemDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,0)
  local integer htype=LoadInteger(HY,h,1)
  local integer buffid=LoadInteger(HY,h,0)
  local real amount=LoadReal(HY,h,0)
  local real duration=LoadReal(HY,h,1)
  if IsDead(target)==false and GetUnitAbilityLevel(target,buffid)>0 then
    if htype=='00MP' then
      call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)+amount/duration*0.1)
    elseif htype=='00HP' then
      call SetWidgetLife(target,GetWidgetLife(target)+amount/duration*0.1)
    endif
  else
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call DestroyTimer(t)
  endif
  set t=null
  set target=null
endfunction

function SmoothHealingSystem takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local unit target=GetSpellTargetUnit()
  call TimerStart(t,0.1,true,function SmoothHealingSystemDur)
  call SaveUnitHandle(HY,h,0,target)
  if GetSpellAbilityId()=='AIpl' or GetSpellAbilityId()=='A1WA' then//clarity
    call SaveInteger(HY,h,0,'BIrm')
    call SaveInteger(HY,h,1,'00MP')
    call SaveReal(HY,h,0,135)
    call SaveReal(HY,h,1,40)
  else//salve
    call SaveInteger(HY,h,0,'B02Z')
    call SaveInteger(HY,h,1,'00HP')
    call SaveReal(HY,h,0,400)
    call SaveReal(HY,h,1,10)
  endif
  set t=null
  set target=null
endfunction

function CT9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  if GetUnitAbilityLevel(Hero,'B01S')==0 or(GetWidgetLife(Hero)==GetUnitState(Hero,UNIT_STATE_MAX_LIFE)and GetUnitState(Hero,UNIT_STATE_MANA)==GetUnitState(Hero,UNIT_STATE_MAX_MANA)) then
    call UnitRemoveAbility(Hero,'B01S')
    call UnitRemoveAbility(Hero,'B04A')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function CU9 takes unit Hero,item Item returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function CT9))
  call SaveUnitHandle(HY,h,14,Hero)
  set t=null
  if LoadBoolean(MHT,GetHandleId(Hero),'B01S')==false then
    call SmoothHealingSystemForBottle(3000,2000,30,'B01S',Hero)
  endif
endfunction

function CV9 takes unit Hero,item Item returns nothing
  local unit u=Hero
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local unit Caster=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)
  call UnitAddAbility(Caster,'A0GR')
  call IssueTargetOrderById(Caster,852274,u)
  call IssueTargetOrderById(Caster,852274,u)
  set u=null
  set Caster=null
endfunction

function RemoveDefaultString2 takes nothing returns nothing
  local unit cho= LoadUnitHandle(HY,690,1)
  local integer cha=0
  local timer t= GetExpiredTimer()
  loop
    exitwhen cha>6
    if GetItemTypeId(UnitItemInSlot(cho,cha))==0 then
      call UnitRemoveItemFromSlot(cho,cha)
    endif
    set cha=cha + 1
  endloop
  call Timer_End(t)
  set t=null
  set cho=null
endfunction

function RemoveDefaultString takes unit Hero, real i returns nothing
  local timer t =CreateTimer()
  call SaveUnitHandle(HY,690,1,Hero)
  call TimerStart(t,i,false,function RemoveDefaultString2)
  set t=null
endfunction

function BountyRunePickup takes unit u returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",u,"origin"))
  if MinutesForTime<0 then
    set MinutesForTime=0
  endif
  if MinutesForTime<2 then
    call ImitateBountyGain(GetOwningPlayer(u),u,(50+2*MinutesForTime)*2)
  else
    call ImitateBountyGain(GetOwningPlayer(u),u,50+2*MinutesForTime)
  endif
  if IsUnitType(u,UNIT_TYPE_HERO) then
    if MinutesForTime<2 then
      call AddHeroXP(u,(50+5*MinutesForTime)*2,true)
    else
      call AddHeroXP(u,50+5*MinutesForTime,true)
    endif
  endif
endfunction

function ProvideRealRune takes unit u, integer id returns nothing
  local item it=CreateItem(GetRealRune(id),GetUnitX(u),GetUnitY(u))
  if UnitAddItem(u,it) and GetWidgetLife(it)<=0 then
  else
    call RemoveItem(it)
  endif
  set it=null
endfunction

function EPD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,(26)))
  local integer CL9=(LoadInteger(HY,h,(98)))
  local item Item=UnitItemInSlot(u,CL9)
  local integer EQD=(LoadInteger(HY,h,(105)))
  local item EJD
  local integer FO9
  local integer id
  local integer iid=GetIndex(Item)
  if Item!=null and Bottle_IsIndexRune(iid) and GetHandleId(Item)==EQD and IsDead(u)==false and IsDead(u)==false then
    set id=GetRuneFromBottle(iid)
    if id>0 then
      set EJD=CreateItem(id,GetUnitX(u),GetUnitY(u))
    else
      set EJD=null
    endif
    set FO9=GetItemSlot(u,Item)
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle3],FO9)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitAddItem(u,EJD)
  endif
  set t=null
  set u=null
  set Item=null
  set EJD=null
  return false
endfunction

function ERD takes unit u,item EJD returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer CL9=GetItemSlot(u,EJD)
  call SaveInteger(HY,h,(98),(CL9))
  call SaveInteger(HY,h,(105),(GetHandleId(EJD)))
  call SaveUnitHandle(HY,h,(26),(u))
  call TriggerRegisterTimerEvent(t,120,true)
  call TriggerAddCondition(t,Condition(function EPD))
  set t=null
endfunction

function GetBottleWithRuneId takes integer FN9 returns integer
  if FN9=='I006' then
    return indexid_BottleHaste
  elseif FN9=='I008' then
    return indexid_BottleRegen
  elseif FN9=='I00J' then
    return indexid_BottleInvis
  elseif FN9=='I00K' then
    return indexid_BottleDD
  elseif FN9=='I007' then
    return indexid_BottleIllusion
  elseif FN9=='I0QA' then
    return indexid_BottleBounty
  endif
  return-1
endfunction

function CW9 takes unit Hero,item Item returns nothing
  local item it
  local integer i
  local integer k
  local boolean borrowed=false
  if IsFakeRune(GetItemTypeId(Item)) then
    set it=FindItemOfType(Hero,Item_Real[indexid_Bottle0])
    if it==null then
      set it=FindItemOfType(Hero,Item_Real[indexid_Bottle1])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Real[indexid_Bottle2])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Real[indexid_Bottle3])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Mute[indexid_Bottle0])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Mute[indexid_Bottle1])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Mute[indexid_Bottle2])
    endif
    if it==null then
      set it=FindItemOfType(Hero,Item_Mute[indexid_Bottle3])
    endif
    if it!=null then
      if BottlePickupRunesOldfashion[GetPlayerId(GetOwningPlayer(Hero))]==false then
        set i=GetItemSlot(Hero,it)
        set k=GetBottleWithRuneId(GetRealRune(GetItemTypeId(Item)))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Hero,"overhead"))
        set tt_player1=GetItemPlayer(it)
        call DestroyItem(it)
        call DisableTrigger(t_manipulateitem)
        if GetOwningPlayer(Hero)==tt_player1 then
          set tt_item1=AddItemByIdInSlot(Hero,Item_Real[k],i)
        else
          set tt_item1=AddItemByIdInSlot(Hero,Item_Mute[k],i)
        endif
        call EnableTrigger(t_manipulateitem)
        call SetItemPlayer(tt_item1,tt_player1,false)
        call SetItemUserData(tt_item1,1)
        set it=UnitItemInSlot(Hero,i)
        call ERD(Hero,it)
      else
        set i=GetItemSlot(Hero,it)
        set k=indexid_Bottle3
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Hero,"overhead"))
        set tt_player1=GetItemPlayer(it)
        call DestroyItem(it)
        call DisableTrigger(t_manipulateitem)
        if GetOwningPlayer(Hero)==tt_player1 then
          set tt_item1=AddItemByIdInSlot(Hero,Item_Real[k],i)
        else
          set tt_item1=AddItemByIdInSlot(Hero,Item_Mute[k],i)
        endif
        call EnableTrigger(t_manipulateitem)
        call SetItemPlayer(tt_item1,tt_player1,false)
        call SetItemUserData(tt_item1,1)
        call ProvideRealRune(Hero,GetItemTypeId(Item))
      endif
    else
      call ProvideRealRune(Hero,GetItemTypeId(Item))
    endif
  endif
  if IsRune(GetItemTypeId(Item)) then
    call CO9(Hero,GetItemTypeId(Item),false)
  endif
  if GetItemTypeId(Item)=='I007' then
    call CV9(Hero,Item)
  elseif GetItemTypeId(Item)=='I0QA' then
    call BountyRunePickup(Hero)
  elseif GetItemTypeId(Item)=='I00J' then
    if GetUnitAbilityLevel(Hero,'B09Y')>0 then
      call UnitRemoveAbility(Hero,'B09Y')
      call UnitRemoveAbility(Hero,'B01Q')
      call DisableTrigger(GetTriggeringTrigger())
      call UnitAddItemById(Hero,'I00J')
      call EnableTrigger(GetTriggeringTrigger())
    endif
  elseif GetItemTypeId(Item)=='I008' then
    call CU9(Hero,Item)
  endif
  //call RemoveDefaultString(Hero,.5)
  set it=null
endfunction

function CX9 takes unit Hero,item Item returns nothing
  local integer AF8=0
  call UnitRemoveAbility(Hero,'A27S')
  call UnitRemoveAbility(Hero,'A27Q')
  call UnitRemoveAbility(Hero,'A27R')
  call UnitRemoveAbility(Hero,'A27T')
  if GetUnitAbilityLevel(Hero,'A28F')>0 then
    call UnitRemoveAbility(Hero,'A28F')
    call UnitAddAbility(Hero,'A28F')
  endif
  call UnitRemoveAbility(Hero,'Q135')
  call UnitRemoveAbility(Hero,'Q307')
  call UnitRemoveAbility(Hero,'Q279')
  call UnitRemoveAbility(Hero,'Q084')
endfunction

function CY9 takes item Item,unit Source,boolean CZ9 returns nothing
  local integer indexId=GetIndex(Item)
  local integer h=GetHandleId(Source)
  local string s=""
  if(indexId==indexid_Gem and FindItemOfTypeEx(Source,indexid_Gem,Item)==null)or(indexId==indexid_GemCourier and FindItemOfTypeEx(Source,indexid_GemCourier,Item)==null)then
    if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source)) or IsObserver(GetLocalPlayer())then
      set s="Abilities\\Spells\\Human\\MagicSentry\\MagicSentryCaster.mdl"
    endif
    if CZ9 then
      if GetEmptyInventorySlots(Source)>0 or GetItemType(Item)==ITEM_TYPE_PERMANENT or GetItemType(Item)==ITEM_TYPE_CAMPAIGN then
        if GetUnitAbilityLevel(Source,'A26A')==0 and GetUnitAbilityLevel(Source,'A26B')==0 then
          if s=="Abilities\\Spells\\Human\\MagicSentry\\MagicSentryCaster.mdl" then
            call UnitAddAbility2(Source,'A26A')
          else
            call UnitAddAbility2(Source,'A26B')
          endif
        endif
      endif
    else
      if not(GetUnitAbilityLevel(Source,'A26A')==0 and GetUnitAbilityLevel(Source,'A26B')==0)then
        call UnitRemoveAbility(Source,'A26B')
        call UnitRemoveAbility(Source,'A26A')
        call RemoveSavedHandle(HY,h,(670))
      endif
    endif
  endif
endfunction

function ItemSoldPost takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local player p=LoadPlayerHandle(HY,h,0)
  local integer pid=GetPlayerId(p)
  local integer goldold=LoadInteger(HY,h,0)
  local integer gold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
  local integer diff=gold-goldold
  if diff>0 then
    call DisplayTimedTextToPlayer(p,0,0,5,"Newly bought item sold, |cfffffa00"+I2S(diff)+"|r gold refunded.")
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+diff)
    call SaveInteger(MHT,'ITEM',pid,0)
    call SaveReal(MHT,'ITEM',pid,0.0)
  endif
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function IsHealingItem takes item it returns boolean
  return Item_Real[GetIndex(it)]==Item_Real[indexid_RingOfHealth]
endfunction

function ItemSold takes player p, item it returns nothing
  local timer t
  local integer gold
  local integer pid=GetPlayerId(p)
  if Item_Real[GetIndex(it)]==LoadInteger(MHT,'ITEM',pid) and TimerGetElapsed(GlobalTimer)-LoadReal(MHT,'ITEM',pid) < 10.0 and IsHealingItem(it)==false then
    set t=CreateTimer()
    set gold=GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)
    call TimerStart(t,0,false,function ItemSoldPost)
    call SavePlayerHandle(HY,GetHandleId(t),0,p)
    call SaveInteger(HY,GetHandleId(t),0,gold)
    set t=null
  endif
endfunction

function SendInventoryInfoDelayed takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer i=0
  local integer k=UnitInventorySize(u)
  local item it
  local integer pid=GetPlayerId(GetOwningPlayer(u))
  call RemoveSavedHandle(HY,GetHandleId(u),'INVR')
  call DestroyTimer(t)
  loop
    set it=UnitItemInSlot(u,i)
    if it!=null then
      call Traffic_RegisterData("LoD_INV_"+I2S(pid),GetItemTypeId(it))
    endif
    set i=i+1
    exitwhen i>k
  endloop
  set it=null
  set t=null
  set u=null
endfunction

function SendInventoryInfo takes unit u returns nothing
  local timer t
  local integer h
  local integer hu=GetHandleId(u)
  if advancedTracking==false then
    return
  endif
  if HaveSavedHandle(HY,hu,'INVR')==false then
    set t=CreateTimer()
    set h=GetHandleId(t)
    call SaveTimerHandle(HY,hu,'INVR',t)
    call TimerStart(t,0.1,false,function SendInventoryInfoDelayed)
    call SaveUnitHandle(HY,h,0,u)
    set t=null
  else
    call TimerStart(LoadTimerHandle(HY,hu,'INVR'),0.1,false,function SendInventoryInfoDelayed)
  endif
endfunction

function CA9 takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local item Item=GetManipulatedItem()
  local integer id=GetItemTypeId(Item)
  if Item==null or IsUnitIllusion(Hero) or IsUnitType(Hero,UNIT_TYPE_HERO)==false or GetUnitTypeId(Hero)=='H00J' or GetItemTypeId(Item)=='I02M' then
    set Hero=null
    set Item=null
    return false
  endif
  if(GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM and GetItemType(Item)!=ITEM_TYPE_PURCHASABLE)or GetTriggerEventId()==EVENT_PLAYER_UNIT_PAWN_ITEM then
    call ItemSold(GetOwningPlayer(Hero),Item)
    call CY9(Item,Hero,false)
    call Traffic_RegisterData("DRI_"+I2S(GetPlayerId(GetOwningPlayer(Hero))),Item_Real[FindRealIndexId(GetIndex(Item))])
    call SendInventoryInfo(Hero)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
    call CY9(Item,Hero,true)
    call Traffic_RegisterData("PUI_"+I2S(GetPlayerId(GetOwningPlayer(Hero))),Item_Real[FindRealIndexId(GetIndex(Item))])
    call SendInventoryInfo(Hero)
  endif
  //	call RemoveDefaultString(Hero,.1)
  set Hero=null
  set Item=null
  return false
endfunction

function DICCI takes player p, integer dataint, integer id, real x, real y returns nothing
  local item it=CreateItem(Item_Dummy[id],x,y)
  call SetItemPlayer(it,p,false)
  call SetItemUserData(it,dataint)
  set it=null
endfunction

function C59 takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local item it
  local integer i=0
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local integer iid
  local player p
  call DisableTrigger(t_manipulateitem)
  loop
    exitwhen i>5
    set it=UnitItemInSlot(u,i)
    set iid=GetIndex(it)
    set p=GetItemPlayer(it)
    if iid==indexid_Perseverance then
      call RemoveItem(it)
      call DICCI(p,1,indexid_RingOfHealth,x,y)
      call DICCI(p,1,indexid_VoidStone,x,y)
    elseif iid==indexid_RingOfBasilius or iid==indexid_RingOfBasiliusHero then
      call RemoveItem(it)
      call DICCI(p,1,indexid_RingOfProtection,x,y)
      call DICCI(p,1,indexid_SobiMask,x,y)
    elseif iid==indexid_ShivasGuard or iid==indexid_ShivasGuardCourier then
      call RemoveItem(it)
      call DICCI(p,1,indexid_PlateMail,x,y)
      call DICCI(p,1,indexid_MysticStaff,x,y)
      call DICCI(p,1,indexid_RecipeShivasGuard,x,y)
    elseif (iid)==indexid_Mjollnir then
      call RemoveItem(it)
      call DICCI(p,1,indexid_Hyperstone,x,y)
      call DICCI(p,1,indexid_Maelstrom,x,y)
      call DICCI(p,1,indexid_RecipeMjollnir,x,y)
    elseif iid==indexid_ArcaneBoots then
      call RemoveItem(it)
      call DICCI(p,1,indexid_BootsOfSpeed,x,y)
      call DICCI(p,1,indexid_EnergyBooster,x,y)
    elseif iid==indexid_HelmOfTheDominator or iid==indexid_HelmOfTheDominatorCourier then
      call RemoveItem(it)
      call DICCI(p,1,indexid_HelmOfIronWill,x,y)
      call DICCI(p,1,indexid_MaskOfDeath,x,y)
    elseif iid==indexid_MantaStyle or iid==indexid_MantaStyleRanged then
      call RemoveItem(it)
      call DICCI(p,1,indexid_Yasha,x,y)
      call DICCI(p,1,indexid_UltimateOrb,x,y)
      call DICCI(p,1,indexid_RecipeMantaStyle,x,y)
    elseif iid==indexid_EtherealBlade then
      call RemoveItem(it)
      call DICCI(p,1,indexid_Eaglehorn,x,y)
      call DICCI(p,1,indexid_GhostScepter,x,y)
    elseif iid==indexid_SangeAndYasha then
      call RemoveItem(it)
      call DICCI(p,1,indexid_Sange,x,y)
      call DICCI(p,1,indexid_Yasha,x,y)
    elseif iid==indexid_RingOfAquila or iid==indexid_RingOfAquilaHero then
      call RemoveItem(it)
      call DICCI(p,1,indexid_WraithBand,x,y)
      call DICCI(p,1,indexid_RingOfBasilius,x,y)
    elseif iid==indexid_AbyssalBlade then //abyssal
      call RemoveItem(it)
      call DICCI(p,1,indexid_CraniumBasher,x,y)
      call DICCI(p,1,indexid_SacredRelic,x,y)
    endif
    set i=i+1
  endloop
  call EnableTrigger(t_manipulateitem)
  set u=null
  set it=null
endfunction

function Spell_Disassemble takes nothing returns boolean
  if GetSpellAbilityId()=='A0K5' or GetSpellAbilityId()=='A1RF' then
    call C59()
  endif
  return false
endfunction

function L49 takes integer indexId returns boolean
  return indexId!=indexid_DivineRapier and indexId!=indexid_bloodstone and indexId!=indexid_Gem and indexId!=indexid_Aegis
endfunction

function L79 takes nothing returns nothing
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
    call SetItemPawnable(GetManipulatedItem(),false)
  else
    call SetItemPawnable(GetManipulatedItem(),true)
  endif
endfunction

function CourierCantSell takes nothing returns boolean
  if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and L49(F49(GetManipulatedItem()))and IsCourier(GetTriggerUnit())then
    call L79()
  endif
  return false
endfunction

function L99 takes nothing returns nothing
  local integer x=1
  local player p
  loop
    exitwhen x>16
    if FindItemOfType(udg_Hero[x],Item_Real[indexid_bloodstone])!=null then
      call RemoveUnit(BloodstoneHeroes[GetPlayerId(GetOwningPlayer(udg_Hero[x]))])
    endif
    set x=x+1
  endloop
  set p=null
endfunction

function LE9 takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')!=1 and GetWidgetLife(GetFilterUnit())>1)!=null
endfunction

function LG9 takes unit u returns nothing
  local group g=GetAvailableGroup()
  local unit u2
  local real r=500+30*GetItemCharges(FindItemOfType(u,Item_Real[indexid_bloodstone]))
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1700,Condition(function LE9))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    call SetWidgetLife(u2,GetWidgetLife(u2)+r)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BloodstoneHealTarget.mdx",u2,"origin"))
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  set g=null
  set u2=null
endfunction

function BloodStone_Bloodpact takes unit Hero returns nothing
  set BloodstoneHeroes[GetPlayerId(GetOwningPlayer(Hero))]=CreateUnit(GetOwningPlayer(Hero),'H00M',GetUnitX(Hero),GetUnitY(Hero),GetUnitFacing(Hero))
  call LG9(Hero)
endfunction

function BloodStoneWrap takes unit victim returns nothing
  if FindItemOfType(victim,Item_Real[indexid_bloodstone])!=null then
    call BloodStone_Bloodpact(victim)
  endif
endfunction

function LI9 takes unit u returns nothing
  local integer c=GetItemCharges(FindItemOfType(u,Item_Real[indexid_bloodstone]))
  if c>0 then
    call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+c)
  endif
endfunction

function BloodstoneMP takes nothing returns boolean
  local integer i=1
  local unit Hero
  local integer id
  if TotalCount_Bloodstone>0 then
    loop
      exitwhen i>5
      set id=GetPlayerId(Sentinels[i])
      set Hero=udg_Hero[id]
      if HasItem_Bloodstone[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
        call LI9(Hero)
      endif
      set id=GetPlayerId(Scourges[i])
      set Hero=udg_Hero[id]
      if HasItem_Bloodstone[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
        call LI9(Hero)
      endif
      set i=i+1
    endloop
  endif
  set Hero=null
  return false
endfunction

function LM9 takes nothing returns nothing
  local unit LN9=GetSummonedUnit()
  local unit Source=GetSummoningUnit()
  local string fx=""
  if IsPlayerEnemy(GetLocalPlayer(),GetOwningPlayer(Source))and IsObserver(GetLocalPlayer())==false then
    set fx="war3mapImported\\WardMark_T2.mdx"
  endif
  call AddSpecialEffectTarget(fx,LN9,"origin")
  set LN9=null
  set Source=null
endfunction

function LP9 takes unit Hero,unit LN9 returns nothing
  local integer LQ9
  local item LR9
  if GetUnitTypeId(GetSummonedUnit())=='o004' then
    set LQ9=Item_Real[indexid_ObserverWards]
  else
    set LQ9=Item_Real[indexid_SentryWards]
  endif
  call DisableTrigger(t_manipulateitem)
  set LR9=FindItemOfType(Hero,LQ9)
  if LR9==null then
    set tt_player1=GetOwningPlayer(Hero)
    set tt_item1=CreateItem(LQ9,0,0)
    call UnitAddItem(Hero,tt_item1)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  else
    call SetItemCharges(LR9,GetItemCharges(LR9)+1)
  endif
  call EnableTrigger(t_manipulateitem)
  set LR9=null
endfunction

function Autoselection takes nothing returns nothing
  local unit u=GetSummonedUnit()
  local unit caster=GetSummoningUnit()
  local integer uid=GetUnitTypeId(u)
  if GetUnitTypeId(u)=='u012'then
    call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
  endif
  if uid=='osp4' or uid=='o008' or uid=='o009' or uid=='o01C' or uid=='o01D' or uid=='o01E' then
    call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
  elseif uid=='o000' or uid=='o001' or uid=='o00A' or uid=='o00X' then
    call SelectUnitAddForPlayer(u,GetOwningPlayer(u))
  endif
  set u=null
  set caster=null
endfunction

function LT9 takes nothing returns nothing
  local unit u=GetEnumUnit()
  local integer i=0
  local player p=GetOwningPlayer(GetTriggerUnit())
  local item Item
  local integer id=GetPlayerId(p)
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(u,i)
    if Item!=null and GetItemPlayer(Item)==p then
      call UnitRemoveItem(u,Item)
      call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
    endif
    set i=i+1
  endloop
  set u=null
  set p=null
  set Item=null
endfunction

function LU9 takes nothing returns nothing
  local item Item=GetEnumItem()
  local unit u=VX7
  local player p=GetOwningPlayer(u)
  local integer id=GetPlayerId(p)
  if GetWidgetLife(Item)>0 and GetItemPlayer(Item)==p then
    call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
    call UnitAddItem(CirclesOfPower[id],Item)
  endif
  set Item=null
  set u=null
  set p=null
endfunction

function LV9 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,(53)))
  set VX7=u
  if IsSentinel(GetOwningPlayer(VX7))then
    call EnumItemsInRect(H5,Condition(function ReturnTrue),function LU9)
  else
    call EnumItemsInRect(Z5,Condition(function ReturnTrue),function LU9)
  endif
  if GetTriggerEvalCount(t)==2 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set u=null
  return false
endfunction

function LW9 takes nothing returns boolean
  return IsCourier(GetFilterUnit())
endfunction

function LX9 takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer i=0
  local group g=GetAvailableGroup()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1300,Condition(function LW9))
  call ForGroup(g,function LT9)
  call KillGroup(g)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function LV9))
  call SaveUnitHandle(HY,h,(53),(u))
  set u=null
  set g=null
  set t=null
endfunction

function LY9 takes nothing returns nothing
  if GetSpellAbilityId()=='A14D' then
    call LX9()
  endif
endfunction

function LZ9 takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer i=0
  local item Item
  local integer id=GetPlayerId(GetOwningPlayer(u))
  local region r=CreateRegion()
  if IsSentinel(GetOwningPlayer(u))then
    call RegionAddRect(r,H5)
  else
    call RegionAddRect(r,Z5)
  endif
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(u,i)
    if Bottle_IsIndexRune(GetIndex(Item))==false and GetIndex(Item)!=indexid_Aegis then
      call UnitRemoveItemFromSlot(u,i)
      if(GetUnitTypeId(u)=='ncop' or IsUnitInRegion(r,u))and IsPlayerAlly(GetItemPlayer(Item),GetOwningPlayer(u)) then
        set id=GetPlayerId(GetItemPlayer(Item))
        call SetItemPosition(Item,ItemSpawnX[id],ItemSpawnY[id])
      endif
    endif
    set i=i+1
  endloop
  call RemoveRegion(r)
  set u=null
  set Item=null
  set r=null
endfunction

function LA9 takes nothing returns nothing
  if GetSpellAbilityId()=='A138' or GetSpellAbilityId()=='A14C' then
    call LZ9()
  endif
endfunction

function LB9 takes unit Source returns boolean
  local integer h=GetHandleId(Source)
  local integer i=0
  local real Time=(TimerGetElapsed(GlobalTimer))
  local real LC9=13
  if(LoadReal(HY,h,(730)))<Time-LC9 then
    return false
  endif
  return true
endfunction

function TranquilBoots_Attackd takes unit Source returns nothing
  local integer h=GetHandleId(Source)
  call SaveReal(HY,h,730,TimerGetElapsed(GlobalTimer))
endfunction

function CheckTranquils takes unit Hero returns nothing
  local integer i=0
  local item L19
  local integer indexId
  local boolean L09=false
  if LB9(Hero)then
    set L09=true
  endif
  loop
    exitwhen i>5
    set L19=UnitItemInSlot(Hero,i)
    set indexId=F49(L19)
    if indexId==indexid_TranquilBoots and L09 then
      call DisableTrigger(t_manipulateitem)
      set tt_player1=GetItemPlayer(L19)
      call RemoveItem(L19)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_TranquilBootsBroken],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call EnableTrigger(t_manipulateitem)
    endif
    if indexId==indexid_TranquilBootsBroken and L09==false then
      call DisableTrigger(t_manipulateitem)
      set tt_player1=GetItemPlayer(L19)
      call RemoveItem(L19)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_TranquilBoots],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call EnableTrigger(t_manipulateitem)
    endif
    set i=i+1
  endloop
  set Hero=null
  set L19=null
endfunction

function CheckHearts takes unit Hero returns nothing
  local integer i=0
  local item L29
  local integer indexId
  local boolean D4D=false
  local real time=4
  if IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER)==false then
    set time=6
  endif
  if VY7[GetPlayerId(GetOwningPlayer(Hero))]+time>(TimerGetElapsed(GlobalTimer))then
    set D4D=true
  endif
  loop
    exitwhen i>5
    set L29=UnitItemInSlot(Hero,i)
    set indexId=F49(L29)
    if indexId==indexid_HeartOfTarrasque and D4D then
      call DisableTrigger(t_manipulateitem)
      set tt_player1=GetItemPlayer(L29)
      call RemoveItem(L29)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_DisabledHeartOfTarrasque],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call EnableTrigger(t_manipulateitem)
    endif
    if indexId==indexid_DisabledHeartOfTarrasque and D4D==false then
      call DisableTrigger(t_manipulateitem)
      set tt_player1=GetItemPlayer(L29)
      call RemoveItem(L29)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_HeartOfTarrasque],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call EnableTrigger(t_manipulateitem)
    endif
    set i=i+1
  endloop
  set Hero=null
  set L29=null
endfunction

function D7D takes nothing returns nothing
  if IsRealDamage and GetEventDamage()>2 and (IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))or GetUnitTypeId(GetEventDamageSource())=='n00L') and WL7[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]==false then
    if GetEventDamageSource()!=GetTriggerUnit() or GetUnitAbilityLevel(GetTriggerUnit(),'B028')>0  then
      if GetEventDamage()>5 then
        set VY7[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=(TimerGetElapsed(GlobalTimer))
      endif
      if GetEventDamage()>=10 then
        set LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=TimerGetElapsed(GlobalTimer)
      endif
    else
      if GetEventDamage()>=5 then
        set LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=TimerGetElapsed(GlobalTimer)
      endif
    endif
  endif
endfunction

function DummyDagger takes unit u, item it, integer slot returns nothing
  local integer i
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  set tt_player1=GetItemPlayer(it)
  call RemoveItem(it)
  call UnitAddAbility(d,'AInv')
  set it=UnitAddItemById(d,Item_Real[indexid_DisabledKelensDagger])
  call UnitUseItem(d,it)
  call AddItemInSlot(u,it,slot)
  call SetItemPlayer(it,tt_player1,false)
  call SetItemUserData(it,1)
  set d=null
endfunction

function CheckDaggers takes unit Hero returns nothing
  local integer i=0
  local item it
  local integer indexId
  local boolean b=false
  local real diff=LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(Hero))]+3 - TimerGetElapsed(GlobalTimer)
  if diff>=0 then
    set b=true
  endif
  loop
    set it=UnitItemInSlot(Hero,i)
    set indexId=F49(it)
    if (indexId==indexid_KelensDagger and b) or (indexId==indexid_DisabledKelensDagger and diff >= 2.9) then
      call DisableTrigger(t_manipulateitem)
      call DummyDagger(Hero,it,i)
      call EnableTrigger(t_manipulateitem)
    endif
    if indexId==indexid_DisabledKelensDagger and b==false then
      call DisableTrigger(t_manipulateitem)
      set tt_player1=GetItemPlayer(it)
      call RemoveItem(it)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_KelensDagger],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call EnableTrigger(t_manipulateitem)
    endif
    set i=i+1
    exitwhen i>5
  endloop
  set Hero=null
  set it=null
endfunction

function CheckToggleItems takes nothing returns boolean
  local integer i=1
  local unit Hero
  local integer id
  local boolean daggers=TotalCount_Dagger>0
  local boolean hearts=TotalCount_Heart>0
  local integer c=GetTriggerEvalCount(GetTriggeringTrigger())
  set zOffsetDebug=0
  if not(TotalCount_Dagger>0 or TotalCount_Heart>0 or TotalCount_Tranquils>0) then
    return false
  endif
  loop
    exitwhen i>5
    set id=GetPlayerId(Sentinels[i])
    set Hero=udg_Hero[id]
    if Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
      if daggers and HasItem_Dagger[id]>0 then
        call CheckDaggers(Hero)
      endif
      if ModuloInteger(c,3)==1 then
        if HasItem_TranquilBoots[id]>0 then
          call CheckTranquils(Hero)
        endif
        if hearts and HasItem_Heart[id]>0 then
          call CheckHearts(Hero)
        endif
      endif
    endif
    set id=GetPlayerId(Scourges[i])
    set Hero=udg_Hero[id]
    if Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false then
      if daggers and HasItem_Dagger[id]>0 then
        call CheckDaggers(Hero)
      endif
      if ModuloInteger(c,3)==1 then
        if HasItem_TranquilBoots[id]>0 then
          call CheckTranquils(Hero)
        endif
        if hearts and HasItem_Heart[id]>0 then
          call CheckHearts(Hero)
        endif
      endif
    endif
    set i=i+1
  endloop
  set Hero=null
  return false
endfunction

function DFD takes nothing returns nothing
  local unit Hero=GetFilterUnit()
  local integer i=0
  local item Item
  local integer indexId
  loop
    exitwhen i>5
    set Item=UnitItemInSlot(Hero,i)
    set indexId=GetIndex(Item)
    if(indexId==indexid_Bottle0 or indexId==indexid_Bottle1 or indexId==indexid_Bottle2)and GetItemUserData(Item)>0 then
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",Hero,"overhead"))
      call SoundForPlayer(GetOwningPlayer(Hero),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      set tt_item1=AddItemByIdInSlot(Hero,Item_Real[indexid_Bottle3],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
    endif
    set i=i+1
  endloop
  set Hero=null
  set Item=null
endfunction

function DGD takes nothing returns boolean
  if UnitInventorySize(GetFilterUnit())>0 and IsSentinel(GetOwningPlayer(GetFilterUnit()))and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then
    call DFD()
  endif
  return false
endfunction

function DHD takes nothing returns boolean
  if UnitInventorySize(GetFilterUnit())>0 and IsScourge(GetOwningPlayer(GetFilterUnit()))and IsUnitIllusion(GetFilterUnit())==false and IsDead(GetFilterUnit())==false then
    call DFD()
  endif
  return false
endfunction

function BottleRefill takes nothing returns boolean
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,HS,ZS,750,Condition(function DGD))
  call GroupEnumUnitsInRange(g,EC7,E37,750,Condition(function DHD))
  call KillGroup(g)
  set g=null
  return false
endfunction

function DJD takes unit DKD returns boolean
  return false
endfunction

function DND takes nothing returns nothing
  local unit DOD=GetAttacker()
  local integer DPD=UnitInventorySize(DOD)
  local integer x=0
  local item i
  loop
    exitwhen x>DPD
    set i=UnitItemInSlot(DOD,x)
    if F49(i)==indexid_javelin and PRD_Get(DOD,'JAVL',20) and GenericCondition_IsDotAInvis(DOD)==false then
      if IsSpiritBear(DOD)then
        if DJD(DOD)==false then
          if GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then
            call DamageTarget(DOD,GetTriggerUnit(),2,40)
          endif
        endif
      else
        if GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then
          call DamageTarget(DOD,GetTriggerUnit(),2,40)
        endif
      endif
    endif
    set x=x+1
  endloop
  set i=null
  set DOD=null
endfunction

function DQD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real DRD=(LoadReal(HY,(GetHandleId(Source)),(692)))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or DRD<(TimerGetElapsed(GlobalTimer))then
    call UnitRemoveAbility(Source,'A265')
    call UnitRemoveAbility(Source,'B08N')
    call UnitRemoveAbility(Source,'A26C')
    call SaveReal(HY,(GetHandleId(Source)),(692),((0)*1.))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function DSD takes unit Source returns nothing
  local trigger t
  local integer h
  local real DRD=(LoadReal(HY,(GetHandleId(Source)),(692)))
  call SaveReal(HY,(GetHandleId(Source)),(692),(((TimerGetElapsed(GlobalTimer))+4)*1.))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,5+.01,false)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function DQD))
  call SaveUnitHandle(HY,h,2,(Source))
  call UnitAddAbility2(Source,'A265')
  call UnitAddAbility2(Source,'A26C')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A265',false)
  set t=null
endfunction

function DTD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if GetEventDamageSource()==Source and GetEventDamage()>0 then
      if IsRealDamage then
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
        if IsUnitBADWithSpellbooks(Target)==false then
          call DSD(Target)
        endif
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function DUD takes nothing returns nothing
  local unit Source=GetAttacker()
  local unit Target=GetTriggerUnit()
  local trigger t
  local integer h
  if((LoadInteger(HY,(GetHandleId((Source))),((4309))))==1)==false then
    call AddTimedKeyToUnit(Source,4309,.2)
    if PRD_Get(Source,'MAIM'+1,16) then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
      call TriggerRegisterTimerEvent(t,2.5,false)
      call TriggerAddCondition(t,Condition(function DTD))
      call SaveUnitHandle(HY,h,2,(Source))
      call SaveUnitHandle(HY,h,17,(Target))
    endif
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function DVD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real DRD=(LoadReal(HY,(GetHandleId(Source)),(693)))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or DRD<(TimerGetElapsed(GlobalTimer))then
    call UnitRemoveAbility(Source,'A266')
    call UnitRemoveAbility(Source,'B02I')
    call UnitRemoveAbility(Source,'A26C')
    call SaveReal(HY,(GetHandleId(Source)),(693),((0)*1.))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function DWD takes unit Source returns nothing
  local trigger t
  local integer h
  local real DRD=(LoadReal(HY,(GetHandleId(Source)),(693)))
  call SaveReal(HY,(GetHandleId(Source)),(693),(((TimerGetElapsed(GlobalTimer))+4)*1.))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,4+.01,false)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function DVD))
  call SaveUnitHandle(HY,h,2,(Source))
  call UnitAddAbility2(Source,'A266')
  call UnitAddAbility2(Source,'A26C')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A266',false)
  set t=null
endfunction

function DXD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if GetEventDamageSource()==Source and GetEventDamage()>0 then
      if IsRealDamage then
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
        if IsUnitBADWithSpellbooks(Target)==false then
          call DWD(Target)
        endif
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function DYD takes nothing returns nothing
  local unit Source=GetAttacker()
  local unit Target=GetTriggerUnit()
  local trigger t
  local integer h
  if((LoadInteger(HY,(GetHandleId((Source))),((4309))))==1)==false then
    call AddTimedKeyToUnit(Source,4309,.2)
    if PRD_Get(Source,'MAIM',15) then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
      call TriggerRegisterTimerEvent(t,2.5,false)
      call TriggerAddCondition(t,Condition(function DXD))
      call SaveUnitHandle(HY,h,2,(Source))
      call SaveUnitHandle(HY,h,17,(Target))
    endif
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function DZD takes nothing returns nothing
  local unit DOD=GetAttacker()
  local integer DAD=25
  local integer id=GetPlayerId(GetOwningPlayer(GetAttacker()))
  local integer h=GetHandleId(DOD)
  local real UK8=(TimerGetElapsed(GlobalTimer))
  local real DBD=(LoadReal(HY,h,(101)))
  local boolean DCD=(LoadBoolean(HY,h,(99)))
  local boolean D3D=(LoadBoolean(HY,h,(100)))
  local boolean D6D=UK8<DBD
  local boolean DLD=false
  if IsUnitType(DOD,UNIT_TYPE_MELEE_ATTACKER)==false then
    set DAD=10
  endif
  if PRD_Get(DOD,'BASH',DAD) then
    set DLD=true
  endif
  //P263==A0JJ; P275==A081
  if GetUnitAbilityLevel(DOD,'A340')>0 or GetUnitAbilityLevel(DOD,'P263')>0 or GetUnitAbilityLevel(DOD,'P275')>0 or GetUnitAbilityLevel(DOD,'A0G5')>0 or GetUnitAbilityLevel(DOD,'QP1X')>0 or GetUnitAbilityLevel(DOD,'A09E')>0 then
    call UnitRemoveAbility(DOD,'A174')
    set DOD=null
    return
  endif
  if DCD and D6D==false and D3D==false then
    call SaveReal(HY,h,(101),((UK8+2)*1.))
    if DLD==false then
      call SaveBoolean(HY,h,(100),(true))
    endif
  elseif D6D or D3D then
    call UnitRemoveAbility(DOD,'A174')
    call SaveBoolean(HY,h,(99),(false))
    call SaveBoolean(HY,h,(100),(false))
  endif
  if DLD then
    call UnitAddAbility2(DOD,'A174')
    call UnitMakeAbilityPermanent(DOD,true,'A175')
    call SaveBoolean(HY,h,(99),(true))
  endif
  set DOD=null
endfunction

function D1D takes unit u returns unit
  if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')==0 then
    return u
  else
    return udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  endif
endfunction

function NecronomiconKilled takes unit killer, unit victim returns nothing
  local integer id=GetUnitTypeId(victim)
  if (id=='n00J' or id=='n00A' or id=='n006') and IsUnitType(killer,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(victim,GetOwningPlayer(killer)) then
    if id=='n00J' then
      call DamageTarget(victim,D1D(killer),3,400)
    elseif id=='n00A' then
      call DamageTarget(victim,D1D(killer),3,500)
    elseif id=='n006' then
      call DamageTarget(victim,D1D(killer),3,600)
    endif
  endif
endfunction

function D5D takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local integer Level=1
  local integer id='EUL1'
  if FindItemOfType(Hero,Item_Real[indexid_TranquilBootsBroken])!=null then//60
    set Level=4//100
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_BootsOfSpeed],GetManipulatedItem())!=null then//50
    set Level=2//90
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_PhaseBoots],GetManipulatedItem())!=null then//55
    set Level=2//90
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_PowerTreadsAgility],GetManipulatedItem())!=null or FindItemOfTypeEx(Hero,Item_Real[indexid_PowerTreadsStrength],GetManipulatedItem())!=null or FindItemOfTypeEx(Hero,Item_Real[indexid_PowerTreadsIntelligence],GetManipulatedItem())!=null then
    set Level=2//90
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_ArcaneBoots],GetManipulatedItem())!=null then//60
    set Level=3//95
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_TranquilBoots],GetManipulatedItem())!=null then//75
    set id='EUL2'
    set Level=1//125
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_bootsOfTravel],GetManipulatedItem())!=null then//100
    set id='EUL2'
    set Level=2//140
  endif
  if FindItemOfTypeEx(Hero,Item_Real[indexid_Eul],GetManipulatedItem())!=null then
    call UnitAddAbility2(Hero,id)
    call SetUnitAbilityLevel(Hero,id,Level)
  else
    call UnitRemoveAbility(Hero,'EUL1')
    call UnitRemoveAbility(Hero,'EUL2')
  endif
  set Hero=null
  return false
endfunction

function D2D takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local integer Level=1
  local integer id='EUL1'
  if FindItemOfType(Hero,Item_Real[indexid_TranquilBootsBroken])!=null then//60+40
    set Level=4//100
  endif
  if FindItemOfType(Hero,Item_Real[indexid_BootsOfSpeed])!=null then//50+40
    set Level=2//90
  endif
  if FindItemOfType(Hero,Item_Real[indexid_PhaseBoots])!=null then//50+40
    set Level=2//90
  endif
  if FindItemOfType(Hero,Item_Real[indexid_PowerTreadsAgility])!=null or FindItemOfType(Hero,Item_Real[indexid_PowerTreadsStrength])!=null or FindItemOfType(Hero,Item_Real[indexid_PowerTreadsIntelligence])!=null then
    set Level=2//90
  endif
  if FindItemOfType(Hero,Item_Real[indexid_ArcaneBoots])!=null then//55+40
    set Level=3//95
  endif
  if FindItemOfType(Hero,Item_Real[indexid_TranquilBoots])!=null then//90+40
    set Level=1//130
    set id='EUL2'
  endif
  if FindItemOfType(Hero,Item_Real[indexid_bootsOfTravel])!=null then//100+40
    set Level=2//140
    set id='EUL2'
  endif
  if FindItemOfType(Hero,Item_Real[indexid_Eul])!=null then
    call UnitAddAbility2(Hero,id)
    call SetUnitAbilityLevel(Hero,id,Level)
  endif
  set Hero=null
  return false
endfunction


function Armlet_StrBonus takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer z
  local real hp
  if d==0 then
    set hp=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
  endif
  if d<1 then
    call UnitRemoveAbility(u,ArmletStrBonus[0])
    call UnitRemoveAbility(u,ArmletStrBonus[1])
    call UnitRemoveAbility(u,ArmletStrBonus[2])
    call UnitRemoveAbility(u,ArmletStrBonus[3])
    call UnitRemoveAbility(u,ArmletStrBonus[4])
    call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-hp,1))
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set z=4
  set i=0
  loop
    exitwhen i>z
    if b[i]==1 then
      call UnitAddAbility2(u,ArmletStrBonus[i])
    else
      call UnitRemoveAbility(u,ArmletStrBonus[i])
    endif
    set i=i+1
  endloop
endfunction

function Armlet_TogglingOn takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(MHT,h,0)
  local real KXD=LoadReal(MHT,h,0)
  if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    if FindItemOfType(u,Item_Real[indexid_ArmletOn])==null then
      //call Armlet_StrBonus(u,0)
      call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
      call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
      //call SetUnitState(u,UNIT_STATE_LIFE,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
      if IsTriggerEnabled(t)==true then
        call FlushChildHashtable(MHT,h)
        call CleanTrigger(t)
      endif
      set t=null
      set u=null
      return
    endif
    if GetTriggerEvalCount(t)<=25 then
      call SetHeroStr(u,GetHeroStr(u,false)+1,true)
      call SaveInteger(HeroStats,GetHandleId(u),'ARML',GetTriggerEvalCount(t))
      //call Armlet_StrBonus(u,GetTriggerEvalCount(t))
      if IsDead(u)==false then
        //call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
      endif
    endif
  else
    call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
    call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
    //call SetUnitState(u,UNIT_STATE_LIFE,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
    if IsTriggerEnabled(t)==true then
      call FlushChildHashtable(MHT,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set u=null
endfunction



function E4D takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t
  local real KXD
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
    
    if F49(GetManipulatedItem())==indexid_ArmletOff or F49(GetManipulatedItem())==indexid_ArmletOffCourier then
      call UnitRemoveAbility(Hero,'A44Q')
      if F49(GetManipulatedItem())==indexid_ArmletOff then
        call Armlet_StrBonus(Hero,0)
      endif
    endif
    if F49(GetManipulatedItem())==indexid_Satanic then
      call UnitRemoveAbility(Hero,'A1BW')
    endif
    if F49(GetManipulatedItem())==indexid_ArmletOn or F49(GetManipulatedItem())==indexid_ArmletOnCourier then
      call UnitRemoveAbility(Hero,'A44Q')
      call UnitRemoveAbility(Hero,'A0TC')
      call UnitRemoveAbility(Hero,'A0UK')
      if HaveSavedHandle(HY,GetHandleId(Hero),'ARML') then
        call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'ARML'))
      endif
      if F49(GetManipulatedItem())==indexid_ArmletOn then
        //call Armlet_StrBonus(Hero,0)
        
      endif
    endif
  endif
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
    if F49(GetManipulatedItem())==indexid_ArmletOff  or F49(GetManipulatedItem())==indexid_ArmletOffCourier then
      call UnitAddAbility2(Hero,'A44Q')
      if F49(GetManipulatedItem())==indexid_ArmletOff then
        call Armlet_StrBonus(Hero,0)
      endif
    endif
    if F49(GetManipulatedItem())==indexid_Satanic then
      call UnitAddAbility2(Hero,'A1BW')
    endif
    if F49(GetManipulatedItem())==indexid_ArmletOn or F49(GetManipulatedItem())==indexid_ArmletOnCourier then
      call UnitAddAbility2(Hero,'A44Q')
      call UnitAddAbility2(Hero,'A0TC')
      call UnitAddAbility2(Hero,'A0UK')
      if F49(GetManipulatedItem())==indexid_ArmletOn then
        set t=CreateTrigger()
        call TriggerRegisterTimerEvent(t,0.7/25,true)
        set KXD=GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)-GetWidgetLife(GetTriggerUnit())
        call SaveUnitHandle(MHT,GetHandleId(t),0,Hero)
        call SaveBoolean(HeroStats,GetHandleId(Hero),20,true)
        call SaveReal(MHT,GetHandleId(t),0,KXD)
        call TriggerAddCondition(t,Condition(function Armlet_TogglingOn))
        if HaveSavedHandle(HY,GetHandleId(Hero),'ARML') then
          call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'ARML'))
        endif
        call SaveTriggerHandle(HY,GetHandleId(Hero),'ARML',t)
        set t=null
        call AddTimedKeyToUnit(Hero,4298,.7)
      endif
    endif
  endif
  set Hero=null
endfunction

function E7D takes nothing returns boolean
  if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and(F49(GetManipulatedItem())==indexid_ArmletOn or F49(GetManipulatedItem())==indexid_ArmletOff or F49(GetManipulatedItem())==indexid_Satanic or F49(GetManipulatedItem())==indexid_bloodstone)then
    call E4D()
  endif
  return false
endfunction

function E8D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local item Item=(LoadItemHandle(HY,h,(96)))
  if GetTriggerEventId()==EVENT_UNIT_DROP_ITEM and GetManipulatedItem()==Item then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()!=EVENT_UNIT_DROP_ITEM then
    if LoadInteger(HY,GetHandleId(Hero),4310)!=1 then
      call SetWidgetLife(Hero,RMaxIF(GetWidgetLife(Hero)-40.,1))
    endif
  endif
  set t=null
  set Hero=null
  set Item=null
  return false
endfunction

function E9D takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DROP_ITEM)
  call TriggerAddCondition(t,Condition(function E8D))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveItemHandle(HY,h,(96),(GetManipulatedItem()))
  set t=null
  set Hero=null
endfunction

function EDD takes nothing returns boolean
  if GetItemType(GetManipulatedItem())==ITEM_TYPE_PERMANENT and (F49(GetManipulatedItem())==indexid_ArmletOn or (F49(GetManipulatedItem())==indexid_ArmletOnCourier and IsUnitSpiritBear(GetTriggerUnit()))) then
    call E9D()
  endif
  return false
endfunction

function EED takes unit u returns boolean
  local item EFD=CreateItem('I0KK',GetUnitX(u),GetUnitY(u))
  local boolean result=UnitAddItem(u,EFD)
  if result==false then
    call RemoveItem(EFD)
  endif
  set EFD=null
  return result
endfunction

function EGD takes unit Hero,item Item,integer FO9 returns item
  local real x=FI9(Hero)
  local real y=FK9(Hero)
  local integer i=0
  local boolean array FP9
  local item FQ9
  loop
    exitwhen i>(UnitInventorySize(Hero)-1)
    if UnitItemInSlot(Hero,i)==null and i!=FO9 then
      set FQ9=CreateItem('I02M',x,y)
      call UnitAddItem(Hero,FQ9)
      set FP9[i]=true
    else
      set FP9[i]=false
    endif
    if i==FO9 then
      call UnitAddItem(Hero,Item)
    endif
    set i=i+1
  endloop
  set i=0
  loop
    exitwhen i>5
    if FP9[i] then
      call RemoveItem(UnitItemInSlot(Hero,i))
    endif
    set i=i+1
  endloop
  set tt_item1=Item
  set FQ9=null
  return tt_item1
endfunction

function EHD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer i=0
  local item EID
  local integer indexId
  local unit Caster
  local item EJD
  local item it
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SaveBoolean(HY,(GetHandleId(Hero)),(102),(false))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif EED(Hero)==false then
    call TriggerRegisterTimerEvent(t,5.5,false)
  else
    call SaveBoolean(HY,(GetHandleId(Hero)),(102),(false))
    call DisableTrigger(t_manipulateitem)
    if HasItem_LinkenSphere[GetPlayerId(GetOwningPlayer(Hero))]>0 then
      set it=UnitAddItemById(Hero,'I0HM')
      if GetWidgetLife(it)>0 then
        call RemoveItem(it)
      endif
      set it=null
    endif
    loop
      exitwhen i>5
      set EID=UnitItemInSlot(Hero,i)
      set indexId=F49(EID)
      if indexId==indexid_LinkenDummy then
        set tt_player1=GetItemPlayer(EID)
        call RemoveItem(EID)
        set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
        call UnitAddAbility(Caster,'AInv')
        set EJD=UnitAddItemById(Caster,Item_Real[indexid_LinkensSphere])
        call UnitUseItem(Caster,EJD)
        set tt_item1=EGD(Hero,EJD,i)
        call SetItemPlayer(EJD,tt_player1,false)
        call SetItemUserData(EJD,1)
        call UnitRemoveAbility(Caster,'AInv')
        set Caster=null
        set EJD=null
      endif
      set EID=null
      set i=i+1
    endloop
    call EnableTrigger(t_manipulateitem)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set EID=null
  set Caster=null
  set EJD=null
  return false
endfunction

function EKD takes unit Hero returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer i=0
  local item EID
  local integer indexId
  local unit Caster
  local item EJD
  call DisableTrigger(t_manipulateitem)
  call SaveBoolean(HY,(GetHandleId(Hero)),(102),(true))
  call TriggerRegisterTimerEvent(t,17,false)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function EHD))
  call SaveUnitHandle(HY,h,(14),(Hero))
  loop
    exitwhen i>5
    set EID=UnitItemInSlot(Hero,i)
    set indexId=F49(EID)
    if indexId==indexid_LinkensSphere or indexId==indexid_LinkenDummy then
      set tt_player1=GetItemPlayer(EID)
      call RemoveItem(EID)
      set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
      call UnitAddAbility(Caster,'AInv')
      set EJD=UnitAddItemById(Caster,Item_Real[indexid_LinkenDummy])
      call UnitUseItem(Caster,EJD)
      set tt_item1=EGD(Hero,EJD,i)
      call SetItemPlayer(EJD,tt_player1,false)
      call SetItemUserData(EJD,1)
      call UnitRemoveAbility(Caster,'AInv')
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",Hero,"origin"))
      set Caster=null
      set EJD=null
    endif
    set EID=null
    set i=i+1
  endloop
  call EnableTrigger(t_manipulateitem)
  set t=null
endfunction

function LinkensWrapper takes nothing returns boolean
  local integer i=1
  local unit Hero
  local integer id
  if GameEnded then
    return false
  endif
  if TotalCount_LinkenSphere>0 then
    loop
      exitwhen i>5
      set id=GetPlayerId(Sentinels[i])
      set Hero=udg_Hero[id]
      if HasItem_LinkenSphere[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false and LoadBoolean(HY,GetHandleId(Hero),102)==false and IsBlocked(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),129)==false then
        call EKD(Hero)
      endif
      set id=GetPlayerId(Scourges[i])
      set Hero=udg_Hero[id]
      if HasItem_LinkenSphere[id]>0 and Hero!=null and GetUnitTypeId(Hero)>1 and IsUnitType(Hero,UNIT_TYPE_DEAD)==false and LoadBoolean(HY,GetHandleId(Hero),102)==false and IsBlocked(Hero)==false and LoadBoolean(HY,GetHandleId(Hero),129)==false then
        call EKD(Hero)
      endif
      set i=i+1
    endloop
  endif
  set Hero=null
  return false
endfunction

function EOD takes nothing returns boolean
  local integer id
  local unit u
  local integer h
  if GetSpellAbilityId()=='A0H6' then
    set u=GetTriggerUnit()
    set h=GetHandleId(u)
    call SaveUnitHandle(HY,h,103,null)
    call SaveInteger(HY,h,104,0)
    if(FindItemOfType(GetTriggerUnit(),Item_Real[indexid_Bottle0])!=null or FindItemOfType(GetTriggerUnit(),Item_Mute[indexid_Bottle0])!=null)and(GetUnitTypeId(GetSpellTargetUnit())=='nfoh' or GetUnitTypeId(GetSpellTargetUnit())=='ndfl')then
      call SaveUnitHandle(HY,h,103,GetSpellTargetUnit())
    elseif IsFakeRune(GetItemTypeId(GetSpellTargetItem()))then
      set id=GetRealRune(GetItemTypeId(GetSpellTargetItem()))
      call CO9(GetTriggerUnit(),id,true)
      call SaveInteger(HY,h,104,id)
      call DestroyItem(GetSpellTargetItem())
    endif
  endif
  set u=null
  return false
endfunction

function ESD takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local item Item=GetManipulatedItem()
  local integer indexId=GetIndex(Item)
  local unit ETD
  local integer EUD
  local integer FO9
  local item EJD=null
  local integer EVD
  local integer id
  if indexId==indexid_Bottle0 then
    set FO9=GetItemSlot(u,Item)
    set ETD=(LoadUnitHandle(HY,(GetHandleId(u)),(103)))
    set EUD=(LoadInteger(HY,(GetHandleId(u)),(104)))
    if GetUnitTypeId(ETD)=='nfoh' or GetUnitTypeId(ETD)=='ndfl' then
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
      call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle3],FO9)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
    elseif IsRune(EUD)then
      set EVD=GetBottleWithRuneId(EUD)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
      set tt_player1=GetItemPlayer(Item)
      call DestroyItem(Item)
      call DisableTrigger(t_manipulateitem)
      if GetOwningPlayer(u)==tt_player1 then
        set tt_item1=AddItemByIdInSlot(u,Item_Real[EVD],FO9)
      else
        set tt_item1=AddItemByIdInSlot(u,Item_Mute[EVD],FO9)
      endif
      call EnableTrigger(t_manipulateitem)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      set EJD=UnitItemInSlot(u,FO9)
      call ERD(u,EJD)
    endif
  elseif indexId==indexid_Bottle3 then
    set FO9=GetItemSlot(u,Item)
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle2],FO9)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  elseif indexId==indexid_Bottle2 then
    set FO9=GetItemSlot(u,Item)
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle1],FO9)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  elseif indexId==indexid_Bottle1 then
    set FO9=GetItemSlot(u,Item)
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle0],FO9)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,0)
  elseif Bottle_IsIndexRune(indexId)then
    //if(LoadInteger(HY,(GetHandleId(Item)),(GetHandleId(u))))>0 then
    set VP7=true
    set FO9=GetItemSlot(u,Item)
    set id=GetRuneFromBottle(indexId)
    if id>0 then
      set EJD=CreateItem(id,GetUnitX(u),GetUnitY(u))
    else
      set EJD=null
    endif
    set tt_player1=GetItemPlayer(Item)
    call DestroyItem(Item)
    set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle3],FO9)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
    call UnitAddItem(u,EJD)
    set VP7=false
    //endif
  endif
  set u=null
  set Item=null
  set ETD=null
  set EJD=null
endfunction

function EWD takes nothing returns boolean
  if GetIssuedOrderId()==851971 then
    if GetOrderTargetItem()!=null and IsFakeRune(GetItemTypeId(GetOrderTargetItem()))then
      call InterruptUnit(GetTriggerUnit())
      call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LU'))
    endif
  endif
  return false
endfunction

function CourierCantPickupRunes takes unit EYD returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,EYD,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerAddCondition(t,Condition(function EWD))
  set t=null
endfunction

function GetRandomGroundCourierModel takes player p returns integer
  local integer r=GetRandomInt(1,6)
  if IsSentinel(p)then
    if r==1 then
      return 'n00I'
    elseif r==2 then
      return 'n022'
    elseif r==3 then
      return 'n021'
    elseif r==4 then
      return 'n0KY'
    elseif r==5 then
      return 'n0KZ'
    else
      return 'n0LE'
    endif
  else
    if r==1 then
      return 'n023'
    elseif r==2 then
      return 'n024'
    elseif r==3 then
      return 'n025'
    elseif r==4 then
      return 'n0L0'
    elseif r==5 then
      return 'n0L1'
    else
      return 'n0M4'
    endif
  endif
  return 0
endfunction

function GetRandomFlyCourierModel takes player p returns integer
  if GetRandomInt(1,3)==1 then
    return 'e02R'
  elseif IsSentinel(p)then
    return 'e01H'
  else
    return 'e01Z'
  endif
  return 0
endfunction

function EBD takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local real a=GetUnitFacing(u)
  local unit c=CreateUnit(GetOwningPlayer(u),GetRandomGroundCourierModel(GetOwningPlayer(u)),x,y,a)
  call Z89(c)
  call GroupAddUnit(CouriersSummoned,c)
  call SaveUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(u)),'COUR',GetBestCourier(GetOwningPlayer(u)))
  call SetUnitPosition(c,x+25*Cos(a*bj_DEGTORAD),y+25*Sin(a*bj_DEGTORAD))
  if ShowCourierIcon[GetPlayerId(GetOwningPlayer(c))]==false then
    call UnitRemoveType(c,UNIT_TYPE_PEON)
  else
    call UnitAddType(c,UNIT_TYPE_PEON)
  endif
  set c=null
  set u=null
endfunction

function E3D takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit courier=CreateUnit(GetOwningPlayer(u),GetRandomFlyCourierModel(GetOwningPlayer(u)),GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
  call Z89(courier)
  call GroupAddUnit(CouriersSummoned,courier)
  call SaveUnitHandle(HeroStats,GetHandleId(GetOwningPlayer(u)),'COUR',GetBestCourier(GetOwningPlayer(u)))
  if ShowCourierIcon[GetPlayerId(GetOwningPlayer(courier))]==false then
    call UnitRemoveType(courier,UNIT_TYPE_PEON)
  else
    call UnitAddType(courier,UNIT_TYPE_PEON)
  endif
  call CourierCantPickupRunes(courier)
  set courier=null
  set u=null
endfunction

function ELD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,124)
  local integer i=1
  local integer array itemsid
  local integer array charges
  local integer E1D=LoadInteger(HY,h,125)
  set itemsid[1]=LoadInteger(HY,h,106)
  set itemsid[2]=LoadInteger(HY,h,107)
  set itemsid[3]=LoadInteger(HY,h,108)
  set itemsid[4]=LoadInteger(HY,h,109)
  set itemsid[5]=LoadInteger(HY,h,110)
  set itemsid[6]=LoadInteger(HY,h,111)
  set charges[1]=LoadInteger(HY,h,112)
  set charges[2]=LoadInteger(HY,h,113)
  set charges[3]=LoadInteger(HY,h,114)
  set charges[4]=LoadInteger(HY,h,115)
  set charges[5]=LoadInteger(HY,h,116)
  set charges[6]=LoadInteger(HY,h,117)
  call DisableTrigger(t_manipulateitem)
  if GetTriggerEvalCount(t)==1 then
    call UnitAddAbility(u,E1D)
    if ShowCourierIcon[GetPlayerId(GetOwningPlayer(u))]==false then
      call UnitRemoveType(u,UNIT_TYPE_PEON)
    else
      call UnitAddType(u,UNIT_TYPE_PEON)
    endif
  else
    loop
      if itemsid[i]>0 then
        set tt_item1=CreateItem(itemsid[i],GetUnitX(u),GetUnitY(u))
        call UnitAddItem(u,tt_item1)
        call SetItemPlayer(tt_item1,LoadPlayerHandle(HY,h,117+i),false)
        call SetItemUserData(tt_item1,1)
        if charges[i]>0 then
          call SetItemCharges(tt_item1,charges[i])
        endif
      endif
      set i=i+1
      exitwhen i>6
    endloop
    if ShowCourierIcon[GetPlayerId(GetOwningPlayer(u))]==false then
      call UnitRemoveType(u,UNIT_TYPE_PEON)
    else
      call UnitAddType(u,UNIT_TYPE_PEON)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  call EnableTrigger(t_manipulateitem)
  call UnitMakeAbilityPermanent(u,true,'A29M')
  call UnitMakeAbilityPermanent(u,true,'A413')
  set t=null
  set u=null
  return false
endfunction

function itsNewDisabledConsumable takes integer id returns boolean
  return id==indexid_Tango or id==indexid_HealingSalve or id==indexid_ClarityPotion
endfunction

function FID takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit FJD=(LoadUnitHandle(HY,h,2))
  local integer FKD=GetUnitTypeId(FJD)
  local real x=GetUnitX(FJD)
  local real y=GetUnitY(FJD)
  local item FMD
  local item FND
  local item FOD
  local item FPD
  local item FQD
  local item FRD
  local player p0
  local player p1
  local player p2
  local player p3
  local player p4
  local player p5
  local integer E0D
  local integer E5D
  local integer E2D
  local integer F4D
  local integer F7D
  local integer F8D
  local integer F9D=-1
  local integer FDD=-1
  local integer FED=-1
  local integer FFD=-1
  local integer FGD=-1
  local integer FHD=-1
  local integer E1D
  local item Item
  local integer i
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if FJD==null or IsDead(FJD)then
    return false
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set FMD=UnitItemInSlot(FJD,0)
  set FND=UnitItemInSlot(FJD,1)
  set FOD=UnitItemInSlot(FJD,2)
  set FPD=UnitItemInSlot(FJD,3)
  set FQD=UnitItemInSlot(FJD,4)
  set FRD=UnitItemInSlot(FJD,5)
  set E0D=GetItemTypeId(FMD)
  set E5D=GetItemTypeId(FND)
  set E2D=GetItemTypeId(FOD)
  set F4D=GetItemTypeId(FPD)
  set F7D=GetItemTypeId(FQD)
  set F8D=GetItemTypeId(FRD)
  set p0=GetItemPlayer(FMD)
  set p1=GetItemPlayer(FND)
  set p2=GetItemPlayer(FOD)
  set p3=GetItemPlayer(FPD)
  set p4=GetItemPlayer(FQD)
  set p5=GetItemPlayer(FRD)
  set Item=FMD
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set F9D=GetItemCharges(Item)
  endif
  set Item=FND
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set FDD=GetItemCharges(Item)
  endif
  set Item=FOD
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set FED=GetItemCharges(Item)
  endif
  set Item=FPD
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set FFD=GetItemCharges(Item)
  endif
  set Item=FQD
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set FGD=GetItemCharges(Item)
  endif
  set Item=FRD
  set i=GetIndex(Item)
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(i) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(i)) then
    set FHD=GetItemCharges(Item)
  endif
  call DestroyItem(FMD)
  call DestroyItem(FND)
  call DestroyItem(FOD)
  call DestroyItem(FPD)
  call DestroyItem(FQD)
  call DestroyItem(FRD)
  if FKD=='n00I' then
    set E1D='S009'
  elseif FKD=='n022' then
    set E1D='S00V'
  elseif FKD=='n021' then
    set E1D='S00C'
  elseif FKD=='n023' then
    set E1D='S00E'
  elseif FKD=='n024' then
    set E1D='S00B'
  elseif FKD=='n025' then
    set E1D='S00F'
  elseif FKD=='n0KY' then
    set E1D='S00W'
  elseif FKD=='n0KZ' then
    set E1D='S00Y'
  elseif FKD=='n0L0' then
    set E1D='S00X'
  elseif FKD=='n0L1' then
    set E1D='S00D'
  elseif FKD=='n0LE' then
    set E1D='S01F'
  elseif FKD=='n0M4' then
    set E1D='S015'
  endif
  if GetRandomInt(1,10)==1 then
    set E1D='S00G'
  endif
  if GetRandomInt(1,10)<3 then
    set E1D='S016'
  endif
  if FKD=='n00M' then
    set E1D='S00L'
  elseif FKD=='n0LS' then
    set E1D='S00L'
  elseif FKD=='n0HV' then
    set E1D='S00F'
  endif
  if FKD=='e01H' then
    set E1D='S012'
  elseif FKD=='e01Z' then
    set E1D='S010'
  elseif FKD=='e02R' then
    set E1D='S014'
  elseif FKD=='e02T' then
    set E1D='S011'
  elseif FKD=='e02S' then
    set E1D='S017'
  elseif FKD=='e030' then
    set E1D='S013'
  endif
  call SavePlayerHandle(HY,h,(118),(p0))
  call SavePlayerHandle(HY,h,(119),(p1))
  call SavePlayerHandle(HY,h,(120),(p2))
  call SavePlayerHandle(HY,h,(121),(p3))
  call SavePlayerHandle(HY,h,(122),(p4))
  call SavePlayerHandle(HY,h,(123),(p5))
  call SaveInteger(HY,h,(106),(E0D))
  call SaveInteger(HY,h,(107),(E5D))
  call SaveInteger(HY,h,(108),(E2D))
  call SaveInteger(HY,h,(109),(F4D))
  call SaveInteger(HY,h,(110),(F7D))
  call SaveInteger(HY,h,(111),(F8D))
  call SaveInteger(HY,h,(112),(F9D))
  call SaveInteger(HY,h,(113),(FDD))
  call SaveInteger(HY,h,(114),(FED))
  call SaveInteger(HY,h,(115),(FFD))
  call SaveInteger(HY,h,(116),(FGD))
  call SaveInteger(HY,h,(117),(FHD))
  call SaveUnitHandle(HY,h,(124),(FJD))
  call SaveInteger(HY,h,(125),(E1D))
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function ELD))
  set t=null
  set FJD=null
  set FMD=null
  set FND=null
  set FOD=null
  set FPD=null
  set FQD=null
  set FRD=null
  set p0=null
  set p1=null
  set p2=null
  set p3=null
  set p4=null
  set p5=null
  set Item=null
  return false
endfunction

function FSD takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.05,false)
  call TriggerAddCondition(t,Condition(function FID))
  call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
  set t=null
endfunction

function FUD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit ECD=(LoadUnitHandle(HY,h,(124)))
  local integer E1D=(LoadInteger(HY,h,(125)))
  local integer E0D=(LoadInteger(HY,h,(106)))
  local integer E5D=(LoadInteger(HY,h,(107)))
  local integer E2D=(LoadInteger(HY,h,(108)))
  local integer F4D=(LoadInteger(HY,h,(109)))
  local integer F7D=(LoadInteger(HY,h,(110)))
  local integer F8D=(LoadInteger(HY,h,(111)))
  local player p0=(LoadPlayerHandle(HY,h,(118)))
  local player p1=(LoadPlayerHandle(HY,h,(119)))
  local player p2=(LoadPlayerHandle(HY,h,(120)))
  local player p3=(LoadPlayerHandle(HY,h,(121)))
  local player p4=(LoadPlayerHandle(HY,h,(122)))
  local player p5=(LoadPlayerHandle(HY,h,(123)))
  local integer F9D=(LoadInteger(HY,h,(112)))
  local integer FDD=(LoadInteger(HY,h,(113)))
  local integer FED=(LoadInteger(HY,h,(114)))
  local integer FFD=(LoadInteger(HY,h,(115)))
  local integer FGD=(LoadInteger(HY,h,(116)))
  local integer FHD=(LoadInteger(HY,h,(117)))
  call DisableTrigger(t_manipulateitem)
  if GetTriggerEvalCount(t)==1 then
    call UnitAddAbility(ECD,E1D)
    if ShowCourierIcon[GetPlayerId(GetOwningPlayer(ECD))]==false then
      call UnitRemoveType(ECD,UNIT_TYPE_PEON)
    else
      call UnitAddType(ECD,UNIT_TYPE_PEON)
    endif
  else
    if E0D>0 then
      set tt_item1=CreateItem(E0D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p0,false)
      call SetItemUserData(tt_item1,1)
    endif
    if F9D>0 then
      call SetItemCharges(tt_item1,F9D)
    endif
    if E5D>0 then
      set tt_item1=CreateItem(E5D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p1,false)
      call SetItemUserData(tt_item1,1)
    endif
    if FDD>0 then
      call SetItemCharges(tt_item1,FDD)
    endif
    if E2D>0 then
      set tt_item1=CreateItem(E2D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p2,false)
      call SetItemUserData(tt_item1,1)
    endif
    if FED>0 then
      call SetItemCharges(tt_item1,FED)
    endif
    if F4D>0 then
      set tt_item1=CreateItem(F4D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p3,false)
      call SetItemUserData(tt_item1,1)
    endif
    if FFD>0 then
      call SetItemCharges(tt_item1,FFD)
    endif
    if F7D>0 then
      set tt_item1=CreateItem(F7D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p4,false)
      call SetItemUserData(tt_item1,1)
    endif
    if FGD>0 then
      call SetItemCharges(tt_item1,FGD)
    endif
    if F8D>0 then
      set tt_item1=CreateItem(F8D,GetUnitX(ECD),GetUnitY(ECD))
      call UnitAddItem(ECD,tt_item1)
      call SetItemPlayer(tt_item1,p5,false)
      call SetItemUserData(tt_item1,1)
    endif
    if FHD>0 then
      call SetItemCharges(tt_item1,FHD)
    endif
    if ShowCourierIcon[GetPlayerId(GetOwningPlayer(ECD))]==false then
      call UnitRemoveType(ECD,UNIT_TYPE_PEON)
    else
      call UnitAddType(ECD,UNIT_TYPE_PEON)
    endif
    call SetUnitFlyHeight(ECD,240,0)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  call EnableTrigger(t_manipulateitem)
  set t=null
  set ECD=null
  set p0=null
  set p1=null
  set p2=null
  set p3=null
  set p4=null
  set p5=null
  return false
endfunction

function FVD takes unit FJD returns nothing
  local integer FKD=GetUnitTypeId(FJD)
  local real x=GetUnitX(FJD)
  local real y=GetUnitY(FJD)
  local item FMD
  local item FND
  local item FOD
  local item FPD
  local item FQD
  local item FRD
  local player p0
  local player p1
  local player p2
  local player p3
  local player p4
  local player p5
  local integer E0D
  local integer E5D
  local integer E2D
  local integer F4D
  local integer F7D
  local integer F8D
  local integer F9D=-1
  local integer FDD=-1
  local integer FED=-1
  local integer FFD=-1
  local integer FGD=-1
  local integer FHD=-1
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer E1D
  local item Item
  local integer i
  local item FWD
  set i=0
  loop
    exitwhen i>5
    set FWD=UnitItemInSlot(FJD,i)
    if GetIndex(FWD)==indexid_Gem then
      call UnitRemoveItem(FJD,FWD)
    endif
    set i=i+1
  endloop
  set FMD=UnitItemInSlot(FJD,0)
  set FND=UnitItemInSlot(FJD,1)
  set FOD=UnitItemInSlot(FJD,2)
  set FPD=UnitItemInSlot(FJD,3)
  set FQD=UnitItemInSlot(FJD,4)
  set FRD=UnitItemInSlot(FJD,5)
  set E0D=GetItemTypeId(FMD)
  set E5D=GetItemTypeId(FND)
  set E2D=GetItemTypeId(FOD)
  set F4D=GetItemTypeId(FPD)
  set F7D=GetItemTypeId(FQD)
  set F8D=GetItemTypeId(FRD)
  set p0=GetItemPlayer(FMD)
  set p1=GetItemPlayer(FND)
  set p2=GetItemPlayer(FOD)
  set p3=GetItemPlayer(FPD)
  set p4=GetItemPlayer(FQD)
  set p5=GetItemPlayer(FRD)
  set Item=FMD
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set F9D=GetItemCharges(Item)
  endif
  set Item=FND
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set FDD=GetItemCharges(Item)
  endif
  set Item=FOD
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set FED=GetItemCharges(Item)
  endif
  set Item=FPD
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set FFD=GetItemCharges(Item)
  endif
  set Item=FQD
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set FGD=GetItemCharges(Item)
  endif
  set Item=FRD
  if GetItemType(Item)==ITEM_TYPE_ARTIFACT or IsIndexIdCharged(GetIndex(Item)) or (GetItemType(Item)==ITEM_TYPE_CAMPAIGN and itsNewDisabledConsumable(GetIndex(Item)))then
    set FHD=GetItemCharges(Item)
  endif
  call DestroyItem(FMD)
  call DestroyItem(FND)
  call DestroyItem(FOD)
  call DestroyItem(FPD)
  call DestroyItem(FQD)
  call DestroyItem(FRD)
  if IsSentinel(GetOwningPlayer(FJD))then
    set E1D='S00I'
  else
    set E1D='S00J'
  endif
  if GetRandomInt(1,3)==1 then
    set E1D='S00Z'
  endif
  call SavePlayerHandle(HY,h,(118),(p0))
  call SavePlayerHandle(HY,h,(119),(p1))
  call SavePlayerHandle(HY,h,(120),(p2))
  call SavePlayerHandle(HY,h,(121),(p3))
  call SavePlayerHandle(HY,h,(122),(p4))
  call SavePlayerHandle(HY,h,(123),(p5))
  call SaveInteger(HY,h,(106),(E0D))
  call SaveInteger(HY,h,(107),(E5D))
  call SaveInteger(HY,h,(108),(E2D))
  call SaveInteger(HY,h,(109),(F4D))
  call SaveInteger(HY,h,(110),(F7D))
  call SaveInteger(HY,h,(111),(F8D))
  call SaveInteger(HY,h,(112),(F9D))
  call SaveInteger(HY,h,(113),(FDD))
  call SaveInteger(HY,h,(114),(FED))
  call SaveInteger(HY,h,(115),(FFD))
  call SaveInteger(HY,h,(116),(FGD))
  call SaveInteger(HY,h,(117),(FHD))
  call SaveUnitHandle(HY,h,(124),(FJD))
  call SaveInteger(HY,h,(125),(E1D))
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function FUD))
  set t=null
  set FJD=null
  set FMD=null
  set FND=null
  set FOD=null
  set FPD=null
  set FQD=null
  set FRD=null
  set p0=null
  set p1=null
  set p2=null
  set p3=null
  set p4=null
  set p5=null
  set Item=null
  set FWD=null
endfunction

function FXD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local item FYD=ZE8(Source,Item_Real[indexid_RecipeFlyingCourier])
  local boolean forced=LoadBoolean(HY,h,0)
  if forced==false then
    if FYD==null then
      set FYD=ZE8(Source,Item_Mute[indexid_RecipeFlyingCourier])
    endif
  endif
  if FYD!=null or forced then
    if forced==false then
      call RemoveItem(FYD)
    endif
    call FVD(Source)
  else
    call Error(GetOwningPlayer(Source),GetObjectName('n02Q'))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set FYD=null
  return false
endfunction

function FZD takes unit Source, boolean forced returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call CourierCantPickupRunes(Source)
  call TriggerRegisterTimerEvent(t,.05,false)
  call TriggerAddCondition(t,Condition(function FXD))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveBoolean(HY,h,0,forced)
  set t=null
endfunction

function LongCourierUp takes nothing returns nothing
  call FZD(tt_unit1,true)
endfunction

function FAD takes nothing returns boolean
  if GetSpellAbilityId()=='A0GD' then
    call FZD(GetTriggerUnit(),false)
  endif
  return false
endfunction

function AghanimPickup takes unit u, item it returns nothing
  local player p=GetOwningPlayer(u)
  local integer pid=GetPlayerId(p)
  if isPlayerPickedAbility(p,12) then
    if Mode_MA or PlayerSkillNumber[pid*PlayerSkillOffset+4]==12 then
      call SetPlayerTechResearched(p,'R00J',1)
    endif
  endif
  if isPlayerPickedAbility(p,88) then
    if Mode_MA or PlayerSkillNumber[pid*PlayerSkillOffset+4]==88 then
      call UnitAddAbility2(u,'A2KK')
      call UnitMakeAbilityPermanent(u,true,'A1W0')
      call UnitMakeAbilityPermanent(u,true,'A1W4')
      call SetPlayerAbilityAvailable(p,'A2KK',false)
      call SetPlayerTechResearched(p,'R00K',1)
      if GetUnitTypeId(u)=='Ucrl' then
        call UnitAddAbility(u,'A2KB')
        call UnitRemoveAbility(u,'A2KB')
        set HeroTypeId[pid]='U01X'
        call AddUnitAnimationProperties(u,"upgrade",true)
        call SetPlayerTechResearched(p,'R00K',1)
      endif
    endif
  endif
endfunction

function FBD takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local item Item=GetManipulatedItem()
  local integer id=GetItemTypeId(Item)
  local integer i
  if(id==Item_Real[indexid_ScrollOfTownPortal]or id==Item_Real[indexid_bootsOfTravel])and IsUnitType(Hero,UNIT_TYPE_HERO) then
    set V17[GetPlayerId(GetOwningPlayer(Hero))]=GetItemX(Item)
    set V07[GetPlayerId(GetOwningPlayer(Hero))]=GetItemY(Item)
  endif
  call CW9(Hero,Item)
  //	call RemoveDefaultString(Hero,1)
  call CX9(Hero,Item)
  if(GetItemTypeId(Item)==Item_Real[indexid_ArmletOn]or GetItemTypeId(Item)==Item_Real[indexid_ArmletOff])and IsCourier(Hero)then
    call UnitRemoveItem(Hero,Item)
  elseif (GetItemTypeId(Item))==Item_Real[indexid_MagicWand]and IsUnitType(Hero,UNIT_TYPE_HERO) then
    set i=LoadInteger(HY,GetHandleId(Hero),750)
    if i>0 then
      if(LoadBoolean(HY,GetHandleId(Hero),751))==false then
        call SaveBoolean(HY,GetHandleId(Hero),751,true)
        call SetItemCharges(Item,i)
      endif
    endif
  elseif GetItemTypeId(Item)==Item_Real[indexid_Aegis]and GetUnitTypeId(Hero)!='n00L' and M47==false then
    set K27=Hero
    set M47=true
    call Traffic_RegisterData("AegisOn",GetPlayerId(GetOwningPlayer(Hero)))
    if (IsSentinel(GetOwningPlayer(Hero)) and LastRoshanSlayer==0) or (IsScourge(GetOwningPlayer(Hero)) and LastRoshanSlayer==1) then
      call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+GetUnitName(Hero)+"|r "+GetObjectName('n0EQ'))
    else
      call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[GetPlayerId(GetOwningPlayer(Hero))]+GetUnitName(Hero)+"|r "+"snatched Aegis of the Immortal!")
    endif
  elseif GetItemTypeId(Item)==Item_Real[indexid_RecipeFlyingCourier] and IsBasicCourier(Hero)then
    call FZD(Hero,false)
  endif
  set Hero=null
  set Item=null
  return false
endfunction

function F3D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Count=(LoadInteger(HY,h,(34)))
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='Aeat' or (GetSpellAbilityId()=='ANTG' and GetSpellTargetDestructable()!=null) then
      call SaveInteger(HY,h,(34),(16))
    endif
  elseif IsDead(Source)or GetTriggerEventId()==EVENT_UNIT_DEATH or Count==0 then
    call UnitRemoveAbility(Source,'A0PV')
    call UnitRemoveAbility(Source,'B07L')
    call SaveInteger(HY,(GetHandleId((Source))),((4255)),2)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetWidgetLife(Source,GetWidgetLife(Source)+115/ 16)
    call SaveInteger(HY,h,(34),(Count-1))
  endif
  set t=null
  set Source=null
  return false
endfunction

function F6D takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveInteger(HY,(GetHandleId((Source))),((4255)),(1))
  call UnitAddAbility2(Source,'A0PV')
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(34),(16))
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function F3D))
  call TriggerEvaluate(t)
  set Source=null
  set t=null
endfunction

function TangoShare takes unit towho returns nothing
  call UnitAddItemById(towho,Item_Real[indexid_TangoSec])
endfunction

function TangoUsed takes nothing returns nothing
  if GetSpellTargetDestructable()!=null and LoadInteger(HY,GetHandleId(GetTriggerUnit()),4255)!=1 then
    call F6D()
  elseif GetSpellTargetDestructable()==null and GetSpellTargetUnit()!=null then
    call TangoShare(GetSpellTargetUnit())
  endif
endfunction

function FLD takes nothing returns nothing
  if GetSpellAbilityId()=='ANTG' then
    call TangoUsed()
  endif
  if GetSpellAbilityId()=='Aeat' and LoadInteger(HY,GetHandleId(GetTriggerUnit()),4255)!=1 then
    call F6D()
  endif
endfunction

function F1D takes integer id,real x,real y returns nothing
  if IsPointInRegion(WE7,x,y)==false then
    set W87=W87+1
    set V57[W87]=Player(id)
    set V27[W87]=x
    set W47[W87]=y
    set W77[W87]=(TimerGetElapsed(GlobalTimer))
  endif
endfunction

function F0D takes integer id,real x,real y returns integer
  local real Time=(TimerGetElapsed(GlobalTimer))
  local integer i=0
  local integer Count=0
  if IsPointInRegion(WE7,x,y) then
    return Count
  endif
  loop
    exitwhen i>W87
    if(Time<W77[i]+25)and(DistanceBetweenXY(x,y,V27[i],W47[i])<WD7*2+50)and IsPlayerAlly(Player(id),V57[i]) then
      set Count=Count+1
    endif
    set i=i+1
  endloop
  return Count
endfunction

function F5D takes integer ZG8 returns integer
  if ZG8==GetPlayerId(Sentinels[1])then
    return 'h0BI'
  elseif ZG8==GetPlayerId(Sentinels[2])then
    return 'h0BK'
  elseif ZG8==GetPlayerId(Sentinels[3])then
    return 'h0BG'
  elseif ZG8==GetPlayerId(Sentinels[4])then
    return 'h0BF'
  elseif ZG8==GetPlayerId(Sentinels[5])then
    return 'h0BL'
  elseif ZG8==GetPlayerId(Scourges[1])then
    return 'h0BH'
  elseif ZG8==GetPlayerId(Scourges[2])then
    return 'h0BJ'
  elseif ZG8==GetPlayerId(Scourges[3])then
    return 'h0BM'
  elseif ZG8==GetPlayerId(Scourges[4])then
    return 'h0A5'
  elseif ZG8==GetPlayerId(Scourges[5])then
    return 'h0BN'
  endif
  return 'h0BN'
endfunction

function F2D takes integer ZG8 returns integer
  return 'h0AX'
endfunction

function G4D takes integer ZG8 returns string
  if ZG8==GetPlayerId(Sentinels[1])then
    return"war3mapImported\\TeleportTarget_Blue.mdx"
  elseif ZG8==GetPlayerId(Sentinels[2])then
    return"war3mapImported\\TeleportTarget_Teal.mdx"
  elseif ZG8==GetPlayerId(Sentinels[3])then
    return"war3mapImported\\TeleportTarget_Purple.mdx"
  elseif ZG8==GetPlayerId(Sentinels[4])then
    return"war3mapImported\\TeleportTarget_Yellow.mdx"
  elseif ZG8==GetPlayerId(Sentinels[5])then
    return"war3mapImported\\TeleportTarget_Orange.mdx"
  elseif ZG8==GetPlayerId(Scourges[1])then
    return"war3mapImported\\TeleportTarget_Pink.mdx"
  elseif ZG8==GetPlayerId(Scourges[2])then
    return"war3mapImported\\TeleportTarget_Gray.mdx"
  elseif ZG8==GetPlayerId(Scourges[3])then
    return"war3mapImported\\TeleportTarget_LightBlue.mdx"
  elseif ZG8==GetPlayerId(Scourges[4])then
    return"war3mapImported\\TeleportTarget_DarkGreen.mdx"
  elseif ZG8==GetPlayerId(Scourges[5])then
    return"war3mapImported\\TeleportTarget_Brown.mdx"
  endif
  return"Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl"
endfunction

function G7D takes integer ZG8 returns string
  return"Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl"
endfunction

function G8D takes nothing returns boolean
  local real d
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)and GetWidgetLife(GetFilterUnit())>0 and GetUnitAbilityLevel(GetFilterUnit(),'Asud')==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit2)) and GetUnitTypeId(GetFilterUnit())!='u00S' and GetUnitTypeId(GetFilterUnit())!='ncop' and GetUnitTypeId(GetFilterUnit())!='emow' and GetUnitTypeId(GetFilterUnit())!='uzig' and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false then
    set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
    if d<tt_real1 then
      set tt_real1=d
      set tt_unit1=GetFilterUnit()
    endif
  endif
  return false
endfunction

function G9D takes unit whichUnit,real x,real y returns unit
  local group g=GetAvailableGroup()
  set tt_unit1=null
  set tt_unit2=whichUnit
  set tt_real1=99999
  set TJ=x
  set RJ=y
  call GroupEnumUnitsInRange(g,x,y,99999,Condition(function G8D))
  call KillGroup(g)
  set g=null
  return tt_unit1
endfunction

function GDD takes unit u returns boolean
  local integer id=GetUnitTypeId(u)
  return id=='n0FH' or id=='n0F6' or id=='n0FI' or id=='n0FJ'
endfunction

function IsSiegeUnit takes unit u returns boolean
  local integer id=GetUnitTypeId(u)
  return id=='u00R' or id=='umtw' or id=='e026' or id=='ebal'
endfunction

function GFD takes nothing returns boolean
  local real d
  if(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsSiegeUnit(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())=='nfoh' or GetUnitTypeId(GetFilterUnit())=='ndfl' or GDD(GetFilterUnit()))and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'Asud')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit2)) and GetOwningPlayer(GetFilterUnit())!=Player15 and IsUnitIllusion(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_FLYING)==false and GetUnitTypeId(GetFilterUnit())!='n0F5' then
    set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
    if d<tt_real1 then
      set tt_real1=d
      set tt_unit1=GetFilterUnit()
    endif
  endif
  return false
endfunction

function GGD takes unit whichUnit,real x,real y returns unit
  local group g=GetAvailableGroup()
  set tt_unit1=null
  set tt_unit2=whichUnit
  set tt_real1=99999
  set TJ=x
  set RJ=y
  call GroupEnumUnitsInRange(g,x,y,99999,Condition(function GFD))
  call KillGroup(g)
  set g=null
  return tt_unit1
endfunction

function GHD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local unit GID=(LoadUnitHandle(HY,h,(448)))
  local unit GJD=(LoadUnitHandle(HY,h,(447)))
  local ubersplat Splat=(LoadUbersplatHandle(HY,h,(131)))
  local integer Count=(LoadInteger(HY,h,(34)))
  local real DP9=(LoadReal(HY,h,(57)))
  local real Time=(LoadReal(HY,h,(442)))
  local integer id=GetPlayerId(GetOwningPlayer(Hero))
  local boolean GKD=false
  local integer i=0
  local integer charges
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    if GetSpellAbilityId()=='A1R5' then
      set GKD=true
    endif
  else
    set Count=Count+1
    call SaveInteger(HY,h,(34),(Count))
    if Count==1 then
      if DP9>3 then
        call SetUnitAnimationByIndex(GID,1)
        call SetUnitAnimationByIndex(GJD,1)
      endif
    elseif Count==2 then
      set GKD=true
    else
    endif
  endif
  if GKD then
    call SaveInteger(HY,(GetHandleId((Hero))),((4256)),2)
    call KillUnit(GID)
    call KillUnit(GJD)
    call DestroyUbersplat(Splat)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if Count==2 then
      call DestroyEffect(AddSpecialEffect(G7D(id),GetUnitX(Hero),GetUnitY(Hero)))
      call DestroyEffect(AddSpecialEffect(G4D(id),x,y))
      call SetUnitX(Hero,x)
      call SetUnitY(Hero,y)
      call PauseUnit(Hero,true)
      call PauseUnit(Hero,false)
      call KillTrees(x,y,240)
    endif
  endif
  set t=null
  set Hero=null
  set GID=null
  set GJD=null
  set Splat=null
  return false
endfunction

function GMD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local unit GID=(LoadUnitHandle(HY,h,(448)))
  local unit GJD=(LoadUnitHandle(HY,h,(447)))
  local ubersplat Splat=(LoadUbersplatHandle(HY,h,(131)))
  local integer Count=(LoadInteger(HY,h,(34)))
  local real DP9=(LoadReal(HY,h,(57)))
  local real Time=(LoadReal(HY,h,(442)))
  local integer id=GetPlayerId(GetOwningPlayer(Hero))
  local boolean GKD=false
  local integer i=0
  local integer charges
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    if GetSpellAbilityId()=='A231' then
      call DestroyEffect((LoadEffectHandle(HY,h,(175))))
      call DestroyEffect((LoadEffectHandle(HY,h,(176))))
      call DestroyEffect((LoadEffectHandle(HY,h,(177))))
      call SaveInteger(HY,(GetHandleId((Hero))),((4256)),2)
      call KillUnit(GID)
      call KillUnit(GJD)
      call DestroyUbersplat(Splat)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UnitRemoveType(Target,UNIT_TYPE_PEON)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call UnitRemoveType(Target,UNIT_TYPE_PEON)
    call SaveInteger(HY,(GetHandleId((Hero))),((4256)),2)
    call KillUnit(GID)
    call KillUnit(GJD)
    call DestroyUbersplat(Splat)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
    call SaveInteger(HY,(GetHandleId((Hero))),((4256)),2)
    call KillUnit(GID)
    call KillUnit(GJD)
    call DestroyUbersplat(Splat)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveType(Target,UNIT_TYPE_PEON)
    call SetUnitX(Hero,GetUnitX(Target)-1)
    call SetUnitY(Hero,GetUnitY(Target)-1)
    call PauseUnit(Hero,true)
    call PauseUnit(Hero,false)
    call KillTrees(x,y,240)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(Hero),GetUnitY(Hero)))
  endif
  set t=null
  set Hero=null
  set GID=null
  set GJD=null
  set Splat=null
  set Target=null
  return false
endfunction

function ShowTPTimer takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit hero=LoadUnitHandle(HY,h,0)
  local real time=LoadReal(HY,h,0)
  local real curtime=GetTriggerEvalCount(t)*0.5-0.5
  local texttag tt
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST or curtime>=time then
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  else
    set tt=CreateTextTag()
    call SetTextTagText(tt,R2SW(time-curtime,1,1),.03)
    call SetTextTagPosUnit(tt,hero,0)
    call SetTextTagColorBJ(tt,150,75,255,15)
    call SetTextTagVelocity(tt,0,.035)
    call SetTextTagFadepoint(tt,3)
    call SetTextTagLifespan(tt,.5)
    call SetTextTagPermanent(tt,false)
    call SetTextTagVisibility(tt,IsUnitAlly(hero,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
    set tt=null
  endif
  set t=null
  set hero=null
endfunction

function GND takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x
  local real y
  local real a
  local trigger t
  local integer h
  local unit GID
  local unit GJD
  local ubersplat Splat
  local integer id=GetPlayerId(GetOwningPlayer(Hero))
  local integer Count
  local real GOD
  local trigger tt
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveInteger(HY,(GetHandleId((Hero))),((4256)),(1))
  if Target==null then
    set x=GetSpellTargetX()
    set y=GetSpellTargetY()
    if x==V17[id]and y==V07[id]then
      if IsSentinel(GetOwningPlayer(Hero))then
        set x=GetUnitX(SentFountain)
        set y=GetUnitY(SentFountain)
      else
        set x=GetUnitX(ScourgeFountain)
        set y=GetUnitY(ScourgeFountain)
      endif
    endif
    set Target=G9D(Hero,x,y)
  else
    set x=GetUnitX(Target)
    set y=GetUnitY(Target)
  endif
  if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))>WD7 then
    set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
    set x=GetUnitX(Target)+WD7*Cos(a)
    set y=GetUnitY(Target)+WD7*Sin(a)
  elseif DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<50 then
    set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
    set x=GetUnitX(Target)+120*Cos(a)
    set y=GetUnitY(Target)+120*Sin(a)
  endif
  if IsPointInRegion(RestrictedRegion,x,y) then
    set a=Atan2(y-GetUnitY(Target),x-GetUnitX(Target))
    set x=GetUnitX(Target)+200*Cos(a)
    set y=GetUnitY(Target)+200*Sin(a)
  endif
  set x=SafeX50(x)
  set y=SafeY50(y)
  if(IsUnitAlly(Hero,GetLocalPlayer())and GetLocalPlayer()!=GetOwningPlayer(Hero))or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))then
    call PingMinimapEx(x,y,3,255,255,255,false)
  endif
  set GJD=CreateUnit(GetOwningPlayer(Hero),F5D(id),x,y,0)
  set GID=CreateUnit(GetOwningPlayer(Hero),F2D(id),GetUnitX(Hero),GetUnitY(Hero),0)
  set Splat=CreateUbersplat(GetUnitX(Hero),GetUnitY(Hero),"SCTP",255,255,255,255,false,false)
  call SetUbersplatRenderAlways(Splat,IsUnitVisible(Hero,GetLocalPlayer()))
  set Count=F0D(GetPlayerId(GetOwningPlayer(Hero)),x,y)
  set GOD=3
  if Count>0 then
    set GOD=4.5+0.5*Count
  endif
  call F1D(GetPlayerId(GetOwningPlayer(Hero)),x,y)
  if Count>0 then
    call SetUnitAnimationByIndex(GID,2)
    call SetUnitAnimationByIndex(GJD,2)
  endif
  call TriggerRegisterTimerEvent(t,GOD-3,false)
  call TriggerRegisterTimerEvent(t,GOD,false)
  
  set tt=CreateTrigger()
  call TriggerRegisterTimerEvent(tt,0.5,true)
  call TriggerRegisterTimerEvent(tt,0,false)
  call SaveUnitHandle(HY,GetHandleId(tt),0,Hero)
  call SaveReal(HY,GetHandleId(tt),0,GOD)
  call TriggerAddCondition(tt,Condition(function ShowTPTimer))
  call TriggerRegisterUnitEvent(tt,Hero,EVENT_UNIT_SPELL_ENDCAST)
  
  set tt=null
  
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function GHD))
  call TimedReveal(GetOwningPlayer(Hero),GOD,x,y,200)
  call SaveUnitHandle(HY,h,(447),(GJD))
  call SaveUnitHandle(HY,h,(448),(GID))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SaveReal(HY,h,(442),(((TimerGetElapsed(GlobalTimer)))*1.))
  call SaveReal(HY,h,(57),((GOD)*1.))
  call SaveUbersplatHandle(HY,h,(131),(Splat))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,(34),(0))
  call BB8(Hero,ZF,x,y,2400)
  set Hero=null
  set Target=null
  set GID=null
  set GJD=null
  set t=null
  set Splat=null
endfunction

function BootsOfTravelFilter2 takes nothing returns boolean
  local real d
  if GetWidgetLife(GetFilterUnit())>0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and GetUnitAbilityLevel(GetFilterUnit(),'Asud')==0 and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsSiegeUnit(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())=='nfoh' or GetUnitTypeId(GetFilterUnit())=='ndfl' or GDD(GetFilterUnit())) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit2)) and GetOwningPlayer(GetFilterUnit())!=Player15 and IsUnitIllusion(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_FLYING)==false and GetUnitTypeId(GetFilterUnit())!='n0F5'  then
    set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
    if d<tt_real1 then
      set tt_real1=d
      set tt_unit1=GetFilterUnit()
    endif
  endif
  return false
endfunction

function BootsOfTravelFilter takes unit whichUnit,real x,real y returns unit
  local group g=GetAvailableGroup()
  set tt_unit1=null
  set tt_unit2=whichUnit
  set tt_real1=99999
  set TJ=x
  set RJ=y
  call GroupEnumUnitsInRange(g,x,y,99999,Condition(function BootsOfTravelFilter2))
  call KillGroup(g)
  return tt_unit1
endfunction

function GPD takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x
  local real y
  local real a
  local trigger t
  local integer h
  local unit GID
  local unit GJD
  local ubersplat Splat
  local integer id=GetPlayerId(GetOwningPlayer(Hero))
  local integer Count
  local real GOD
  set t=CreateTrigger()
  set h=GetHandleId(t)
  if Target==null then
    set x=GetSpellTargetX()
    set y=GetSpellTargetY()
    if x==V17[id]and y==V07[id]then
      if IsSentinel(GetOwningPlayer(Hero))then
        set x=GetUnitX(SentFountain)
        set y=GetUnitY(SentFountain)
      else
        set x=GetUnitX(ScourgeFountain)
        set y=GetUnitY(ScourgeFountain)
      endif
    endif
    set Target=BootsOfTravelFilter(Hero,x,y)
  endif
  set x=GetUnitX(Target)
  set y=GetUnitY(Target)
  if(IsUnitAlly(Hero,GetLocalPlayer())and GetLocalPlayer()!=GetOwningPlayer(Hero))or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))then
    call PingMinimapEx(x,y,3,255,255,255,false)
  endif
  set Splat=CreateUbersplat(GetUnitX(Hero),GetUnitY(Hero),"SCTP",255,255,255,255,false,false)
  call SetUbersplatRenderAlways(Splat,IsUnitVisible(Hero,GetLocalPlayer()))
  set GOD=3
  call UnitAddType(Target,UNIT_TYPE_PEON)
  call TriggerRegisterTimerEvent(t,GOD,false)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function GMD))
  call TimedReveal(GetOwningPlayer(Hero),GOD,x,y,200)
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SaveReal(HY,h,(442),(((TimerGetElapsed(GlobalTimer)))*1.))
  call SaveReal(HY,h,(57),((GOD)*1.))
  call SaveUbersplatHandle(HY,h,(131),(Splat))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,(34),(0))
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Hero,"origin")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",Hero,"origin")))
  call SaveEffectHandle(HY,h,(177),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Target,"origin")))
  call BB8(Hero,ZF,x,y,2400)
  set Hero=null
  set Target=null
  set GID=null
  set GJD=null
  set t=null
  set Splat=null
endfunction

function GQD takes nothing returns nothing
  if GetSpellAbilityId()=='A1R5' and IsCourier(GetTriggerUnit())==false then
    call GND()
  endif
  if GetSpellAbilityId()=='A231' then
    call GPD()
  endif
endfunction

function GRD takes nothing returns nothing
  call KillUnit(GetEnumUnit())
endfunction

function GSD takes nothing returns boolean
  local integer i=GetUnitTypeId(GetFilterUnit())
  return i=='n00H' or i=='n00G' or i=='n00K' or i=='n00J' or i=='n00A' or i=='n006'
endfunction

function GTD takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function GSD))
  call ForGroup(g,function GRD)
  call KillGroup(g)
  set g=null
endfunction

function GUD takes nothing returns nothing
  if GetSpellAbilityId()=='A0HB' or GetSpellAbilityId()=='A0D3' or GetSpellAbilityId()=='A0DF' then
    call GTD()
  endif
endfunction

function GVD takes nothing returns nothing
  if GetSpellAbilityId()=='A1FP' then
    call Z48("Abilities\\Spells\\Items\\VampiricPotion\\VampPotionCaster.mdl",GetTriggerUnit(),"origin",3.5)
    call AddTimedAbility(GetTriggerUnit(),'A1CN',1,3.5)
  endif
endfunction

function GWDb takes nothing returns nothing
  local unit u= GetSpellTargetUnit()
  local integer info
  local integer pid=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  if IsSentinel(Player(pid)) then
    call UnitShareVision(u,Scourges[0],false)
    call UnitShareVision(u,Scourges[1],false)
    call UnitShareVision(u,Scourges[2],false)
    call UnitShareVision(u,Scourges[3],false)
    call UnitShareVision(u,Scourges[4],false)
    call UnitShareVision(u,Scourges[5],false)
  else
    call UnitShareVision(u,Sentinels[0],false)
    call UnitShareVision(u,Sentinels[1],false)
    call UnitShareVision(u,Sentinels[2],false)
    call UnitShareVision(u,Sentinels[3],false)
    call UnitShareVision(u,Sentinels[4],false)
    call UnitShareVision(u,Sentinels[5],false)
  endif
  call UnitAddAbility(u,'Aeth')
  call UnitAddAbility(u,'ACrk')
  call UnitRefillMana(u)
  set info = GetHandleId(GetTriggerUnit())
  call KillUnit(LoadUnitHandle(MHT,info,'ACch'))
  call SaveUnitHandle(MHT,info,'ACch',u)
  call UnitAddAbility2(u,'A435')
  set u = null
endfunction

function GXD takes integer i returns integer//bkb shells 10-4
  local integer lvl=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(GetTriggerUnit())),'0BKB')
  if (i=='A11F' or i=='A11E' or i=='A0S3' or i=='A11D' or i=='A11G' or i=='A11H')==false then
    return 0
  endif
  if lvl==0 then
    return 'A11B'
  elseif lvl==9 then
    return 'A11A'
  elseif lvl==8 then
    return 'A0S2'
  elseif lvl==7 then
    return 'A119'
  elseif lvl==6 then
    return 'A11C'
  elseif lvl==5 then
    return 'A118'
  endif
  return 0
endfunction

function GYD takes integer i returns integer
  local integer lvl=LoadInteger(HeroStats,GetHandleId(GetOwningPlayer(GetTriggerUnit())),'0BKB')
  if lvl==0 then
    return 10
  else
    return lvl
  endif
  return 0
endfunction

function GZD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  if IsDead(Hero)==false and Hero!=null then
    call SetUnitScale(Hero,U18(Hero),U18(Hero),U18(Hero))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function GAD takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  local trigger t=CreateTrigger()
  local real DP9=GYD(GetSpellAbilityId())
  call A68(Hero,WS7,DP9)
  call UnitMakeAbilityPermanent(Hero,true,WS7)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),WS7,false)
  call UnitAddAbility(Caster,GXD(GetSpellAbilityId()))
  call IssueTargetOrderById(Caster,852186,Hero)
  call SetNapalmFactory(Hero,0,0)
  if IsCourier(Hero)then
    call AA8(Hero,DP9,3)
  else
    call AA8(Hero,DP9,1.4)
  endif
  call TriggerRegisterTimerEvent(t,DP9+7,false)
  call TriggerAddCondition(t,Condition(function GZD))
  call SaveUnitHandle(HY,(GetHandleId(t)),(14),(Hero))
  set t=null
  set Hero=null
  set Caster=null
endfunction

function GBD takes nothing returns nothing
  if GXD(GetSpellAbilityId())>0 then
    call GAD()
  endif
endfunction

function GCD takes nothing returns nothing
  if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),((4258))))==1) then
    call Error(GetOwningPlayer(GetEnumUnit()),GetObjectName('n02M')+" "+GetUnitName(GetEnumUnit())+" "+GetObjectName('n02S'))
  else
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
      call AddTimedKeyToUnit(GetEnumUnit(),4258,25)
    endif
    call SetWidgetLife(GetEnumUnit(),GetWidgetLife(GetEnumUnit())+250)
  endif
endfunction

function G3D takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),775,Condition(function L18))
  call ForGroup(g,function GCD)
  call KillGroup(g)
  set Source=null
  set g=null
endfunction

function GLD takes nothing returns nothing
  if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),((4278))))==1) then
    call Error(GetOwningPlayer(GetEnumUnit()),GetObjectName('n02M'))
  else
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
      call AddTimedKeyToUnit(GetEnumUnit(),4278,50)
    endif
    if GetUnitAbilityLevel(GetEnumUnit(),'B0BT')==0 and GetUnitAbilityLevel(GetEnumUnit(),'B0BU')==0 then
      call IssueTargetOrderById(WT7,852186,GetEnumUnit())
    endif
  endif
endfunction

function G1D takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  set WT7=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  call UnitAddAbility(WT7,'A1EV')
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function L28))
  call ForGroup(g,function GLD)
  call KillGroup(g)
  set Source=null
  set g=null
endfunction

function G5D takes nothing returns nothing
  if GetSpellAbilityId()=='A02W' then
    call UnitResetCooldown(GetTriggerUnit())
    call RemoveAbilsForUnit(GetTriggerUnit())
  endif
endfunction

function G2D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local real Damage=(LoadReal(HY,h,(20)))
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED or GetUnitAbilityLevel(GetTriggerUnit(),'B031')==0 then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call DamageTarget(Source,Target,1,Damage)
    if Damage>0 then
      call TextTagOnUnit("+"+I2S(R2I(Damage)),1,Target,.023,255,0,0,216)
    endif
  elseif GetEventDamage()>1 then
    if IsRealDamage then
      call SaveReal(HY,h,(20),Damage+GetEventDamage()*0.3)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function H4D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Silence\\SilenceTarget.mdl",Target,"overhead")))
  call SaveReal(HY,h,(20),0)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,5,false)
  call TriggerAddCondition(t,Condition(function G2D))
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function H7D takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function H4D))
  call SaveUnitHandle(HY,h,17,(GetSpellTargetUnit()))
  call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
  set t=null
endfunction

function H8D takes nothing returns nothing
  if GetSpellAbilityId()=='A0FD' and IsBlocked(GetSpellTargetUnit())==false then
    call H7D()
  endif
endfunction

function H9D takes unit u,real d returns boolean
  if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')>0 then
    return d>5
  endif
  return true
endfunction

function HDD takes unit u returns unit
  local group g
  if GetUnitAbilityLevel(u,'A04R')==0 then
    return u
  endif
  set tt_unit1=WV7
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),900,Condition(function DefaultEnemyFilter))
  set WU7=FirstOfGroup(g)
  call KillGroup(g)
  set g=null
  return WU7
endfunction

function StaticChargeAoE takes nothing returns nothing
  local unit u
  if StaticChargeCounter>0 then
    set StaticChargeCounter=StaticChargeCounter-1
    set u=CreateUnit(GetOwningPlayer(StaticChargeCaster),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
    call UnitAddAbility(u,'A0K6')
    call IssueTargetOrder(u,"forkedlightning",GetEnumUnit())
    set u=null
  endif
endfunction

function HED takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster
  local unit Source
  local group g
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set Source=(LoadUnitHandle(HY,h,2))
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
    call AddTimedKeyToUnit(GetTriggerUnit(),4257,1)
    call UnitAddAbility(Caster,'A0K6')
    set StaticChargeCaster=Source
    set StaticChargeCounter=6
    call GroupEnumUnitsInRange(g,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),925,Condition(function NonImmuneEnemyFilter))
    if DistanceBetweenUnits(GetTriggerUnit(),GetEventDamageSource())<900 then
      if IssueTargetOrderById(Caster,852587,HDD(GetEventDamageSource())) then
        set StaticChargeCounter=5
      endif
    endif
    call ForGroup(g,function StaticChargeAoE)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Caster=null
  set Source=null
endfunction

function HFD takes nothing returns boolean
  if(GetTriggerEventId()==EVENT_UNIT_DAMAGED and H9D(GetEventDamageSource(),GetEventDamage())and GetRandomInt(1,100)<21 and((LoadInteger(HY,(GetHandleId((GetTriggerUnit()))),((4257))))==1)==false)or GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call HED()
  endif
  return false
endfunction

function HGD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  if Target==null then
    set Target=Source
  endif
  call AddTimedKeyToUnit(Target,4279,15)
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function HFD))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\LightningShield\\LightningShieldTarget.mdl",Target,"origin")))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=null
  set Source=null
  set Target=null
endfunction

function HHD takes nothing returns nothing
  if GetSpellAbilityId()=='A0JL' and((LoadInteger(HY,(GetHandleId((GetSpellTargetUnit()))),((4279))))==1)==false then
    call HGD()
  endif
endfunction

function MjollnirLightnings takes unit attacker, unit target returns nothing
  local integer id=0
  local integer chance=0
  local unit dummy
  if GetUnitAbilityLevel(UDSG_Attacker,'A0JH')>0 then
    set id='A0JK'
    set chance=25
  else
    set id='A0FK'
    set chance=25
  endif
  if PRD_Get(attacker,id,chance) then
    set dummy=CreateUnit(GetOwningPlayer(attacker),'e00E',GetUnitX(attacker),GetUnitY(attacker),0)
    call UnitAddAbility(dummy,id)
    call IssueTargetOrder(dummy,"chainlightning",target)
    set dummy=null
  endif
endfunction

function HID takes nothing returns nothing
  local unit HJD=GetTriggerUnit()
  local item FYD=ZE8(HJD,Item_Real[indexid_RecipeFlyingCourier])
  if FYD==null then
    set FYD=ZE8(HJD,Item_Mute[indexid_RecipeFlyingCourier])
  endif
  if FYD!=null then
    call DestroyItem(FYD)
    call UnitRemoveAbility(HJD,'A0VR')
    call UnitAddAbility(HJD,'A0VU')
    call SetUnitState(HJD,UNIT_STATE_MANA,400)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",HJD,"origin"))
  else
    call Error(GetOwningPlayer(HJD),GetObjectName('n02Q'))
  endif
  set HJD=null
  set FYD=null
endfunction

function HMD takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local group HND=WW7
  local unit Source=WX7
  if IsUnitInGroup(Target,HND)==false then
    call GroupAddUnit(HND,Target)
    call IssueTargetOrderById(WY7,852075,Target)
    call DamageTarget(Source,Target,1,200)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl",Target,"origin"))
  endif
  set Target=null
  set HND=null
  set Source=null
endfunction

function HOD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local real d
  local real x
  local real x0=GetUnitX(Source)
  local real y
  local real y0=GetUnitY(Source)
  local group g=GetAvailableGroup()
  local integer Count=GetTriggerEvalCount(t)
  local integer i
  call SetUnitX(Caster,GetUnitX(Source))
  call SetUnitY(Caster,GetUnitY(Source))
  set WW7=HND
  set WX7=Source
  set WY7=(LoadUnitHandle(HY,h,(132)))
  if GetTriggerEvalCount(t)>33 then
    call KillUnit(Caster)
    call KillGroup(HND)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set d=Count*21
    set i=0
    loop
      exitwhen i>36
      set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
      set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,150,Condition(function LT8))
      call ForGroup(g,function HMD)
      set i=i+1
    endloop
  endif
  call KillGroup(g)
  set t=null
  set Caster=null
  set HND=null
  set Source=null
  set g=null
  return false
endfunction

function HPD takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local group HND=GetAvailableGroup()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h091',x,y,0)
  local unit HQD=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  call UnitAddAbility(HQD,'A0T0')
  call SaveGroupHandle(HY,h,(133),(HND))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,(132),(HQD))
  call SaveUnitHandle(HY,h,2,(Hero))
  call TriggerRegisterTimerEvent(t,.06,true)
  call TriggerAddCondition(t,Condition(function HOD))
  set t=null
  set HND=null
  set Caster=null
  set HQD=null
  set Hero=null
endfunction

function HSD takes unit Source,integer HTD returns nothing
  local integer h=GetHandleId(Source)
  call SaveInteger(HY,h,(750),(HTD))
endfunction

function HUD takes nothing returns nothing
  local integer i=0
  local integer charges=0
  local boolean HVD=false
  if GetSpellAbilityId()=='A0JY' then
    loop
      exitwhen i>5
      if (F49(UnitItemInSlot(GetTriggerUnit(),i)))==indexid_MagicStick or (F49(UnitItemInSlot(GetTriggerUnit(),i)))==indexid_MagicWand then
        set charges=GetItemCharges(UnitItemInSlot(GetTriggerUnit(),i))
        if charges>0 then
          call SetItemCharges(UnitItemInSlot(GetTriggerUnit(),i),0)
          call HSD(GetTriggerUnit(),0)
          if HVD==false then
            set HVD=true
            call SetUnitState(GetTriggerUnit(),UNIT_STATE_MANA,GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)+15*charges)
            call SetWidgetLife(GetTriggerUnit(),GetWidgetLife(GetTriggerUnit())+15*charges)
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIre\\AIreTarget.mdl",GetTriggerUnit(),"origin"))
          endif
        endif
        return
      endif
      set i=i+1
    endloop
  endif
endfunction

function IsNotADummyAbility takes integer id returns boolean
  local integer i=1
  loop
    exitwhen i>SomeDummyAbilitiesCounter
    if id==SomeDummyAbilitiesList[i]then
      return false
    endif
    set i=i+1
  endloop
  return true
endfunction

function HXD takes unit HYD,unit Source returns nothing
  if IsUnitVisible(HYD,GetOwningPlayer(Source))==false and GetRandomInt(1,100)<10 then
    call PlaySoundOnUnitBJ(PE,100,Source)
  endif
endfunction

function HZD takes nothing returns nothing
  local unit u=GetEnumUnit()
  local integer i=0
  local integer c
  local integer id
  local integer lim
  local item it
  if IsUnitVisible(GetTriggerUnit(),GetOwningPlayer(u)) then
    loop
      set it=UnitItemInSlot(u,i)
      set id=F49(it)
      if id==indexid_MagicStick or id==indexid_MagicWand then
        if id==indexid_MagicStick then
          set lim=10
        else
          set lim=17
        endif
        set c=GetItemCharges(it)
        call HSD(u,IMinIF(c+1,lim))
        call SetItemCharges(it,IMinIF(c+1,lim))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"chest"))
        set i=5
      endif
      set i=i+1
      exitwhen i>5
    endloop
  endif
  set it=null
  set u=null
endfunction

function HAD takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  call GroupEnumUnitsInRange(g,x,y,1225,Condition(function D89))
  call ForGroup(g,function HZD)
  call KillGroup(g)
  set g=null
  set Source=null
endfunction

function HBD takes nothing returns nothing
  if IsNotADummyAbility(GetSpellAbilityId()) and isAintItemAbility(GetSpellAbilityId()) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 and isDummyAbility(GetSpellAbilityId())==false then
    call HAD()
  endif
endfunction

function HCD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit H3D=(LoadUnitHandle(HY,h,(134)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call UnitRemoveAbility(H3D,'A17R')
    call UnitRemoveAbility(H3D,'A24F')
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set H3D=null
  return false
endfunction

function H6D takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)and GetWidgetLife(GetFilterUnit())>.5 and IsUnitAlly(GetFilterUnit(),WZ7) and GetOwningPlayer(GetFilterUnit())!=Player15 and GetUnitTypeId(GetFilterUnit())!='ncop' and GetUnitTypeId(GetFilterUnit())!='n0FJ' and GetUnitTypeId(GetFilterUnit())!='n0FI' and GetUnitTypeId(GetFilterUnit())!='n0F6' and GetUnitTypeId(GetFilterUnit())!='n0FH')!=null
endfunction

function HLD takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit H3D=GetEnumUnit()
  local string s
  call UnitAddAbility(H3D,'A17R')
  call UnitAddAbility(H3D,'A24F')
  if IsSentinel(WZ7)then
    set s="effects\\GlyphSent.mdx"
  else
    set s="effects\\GlyphScourge.mdx"
  endif
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget(s,H3D,"origin")))
  call SaveUnitHandle(HY,h,(134),(H3D))
  call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,4,false)
  call TriggerAddCondition(t,Condition(function HCD))
  set t=null
  set H3D=null
endfunction

function H1D takes unit u,player p returns nothing
  local integer i
  if IsSentinel(p)then
    set i=1
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=2
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=3
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=4
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=5
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
  else
    set i=7
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=8
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=9
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=10
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
    set i=11
    if u!=CirclesOfPower[i]then
      call IssueImmediateOrderById(CirclesOfPower[i],852244)
    endif
  endif
endfunction

function H5D takes nothing returns nothing
  local group g
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  if(IsSentinel(p)and WA7==false)or(IsSentinel(p)==false and WB7==false)then
    set g=GetAvailableGroup()
    set WZ7=p
    call GroupEnumUnitsInRange(g,0,0,12000,Condition(function H6D))
    call ForGroup(g,function HLD)
    call KillGroup(g)
    if IsSentinel(p)then
      set WA7=true
      call H1D(u,p)
      set WA7=false
    else
      set WB7=true
      call H1D(u,p)
      set WB7=false
    endif
    if (IsPlayerAlly(p,GetLocalPlayer()) or (udg_ObserverMode and IsObserver(GetLocalPlayer()))) and p!=GetLocalPlayer() then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,5,udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId((p))]+"|r ordered to use Glyph of Fortification")
    endif
  endif
  set g=null
  set u=null
  set p=null
endfunction

function I4D takes nothing returns nothing
  if GetSpellAbilityId()=='A12W' and GetUnitAbilityLevel(GetTriggerUnit(),'Bpsh')>0 then
    call UnitRemoveAbility(GetTriggerUnit(),'Bpsh')
  endif
endfunction

function I7D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer c=LoadInteger(HY,GetHandleId(u),'BMON')-1
  if c==0 then
    call RemoveSavedBoolean(HY,GetHandleId(u),'BMON')
    call RemoveSavedInteger(HY,GetHandleId(u),'BMON')
    call UnitRemoveAbility(u,'A43C')
  else
    call SaveInteger(HY,GetHandleId(u),'BMON',c)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set u=null
  set t=null
  return false
endfunction

function BladeMailSpell takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  //call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,4.5,false)
  call TriggerAddCondition(t,Condition(function I7D))
  call UnitAddAbility2(Source,'A43C')
  call SaveBoolean(HY,GetHandleId(Source),'BMON',true)
  call SaveInteger(HY,GetHandleId(Source),'BMON',LoadInteger(HY,GetHandleId(Source),'BMON')+1)
  call SaveUnitHandle(HY,h,0,Source)
  set t=null
  set Source=null
endfunction

function IDD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real a=(LoadReal(HY,h,(137)))
  local real d=(LoadReal(HY,h,(138)))
  local real x=SafeX50(GetUnitX(Target)+d/ 10*Cos(a*bj_DEGTORAD))
  local real y=SafeY50(GetUnitY(Target)+d/ 10*Sin(a*bj_DEGTORAD))
  if GetTriggerEvalCount(t)==11 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x,y))
    if((LoadInteger(HY,(GetHandleId((Target))),((4306))))==1)==false and GetUnitAbilityLevel(Target,'B08V')==0 then
      call KillTrees(x,y,150)
      if IsUnitType(Target,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
      endif
      call SetUnitX(Target,x)
      call SetUnitY(Target,y)
    endif
  endif
  set Target=null
  set t=null
  return false
endfunction

function IED takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x
  local real y
  local real d
  local real a
  local integer i=-1
  local boolean IFD=false
  if GetSpellTargetItem()!=null then
    set Target=GetTriggerUnit()
  endif
  call AddTimedKeyToUnit(Target,4414,3)
  set a=GetUnitFacing(Target)
  loop
    exitwhen IFD or i==23
    set i=i+1
    set x=SafeX50(GetUnitX(Target)+(600-i*25)*Cos(a*bj_DEGTORAD))
    set y=SafeY50(GetUnitY(Target)+(600-i*25)*Sin(a*bj_DEGTORAD))
    if(IsPointInRegion(RestrictedRegion,((x)*1.),((y)*1.)))==false then
      set IFD=true
    endif
  endloop
  set d=DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))
  call TriggerRegisterTimerEvent(t,.04,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function IDD))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveReal(HY,h,(138),((d)*1.))
  set Target=null
  set t=null
endfunction

function IsHomingMissile takes integer i returns boolean
  return i=='h0CH' or i=='h0CF' or i=='h0C1' or i=='h0CG'
endfunction

function IsUnitWard takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_SUMMONED) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER)==false 
endfunction

function IGD takes nothing returns nothing
  local unit u=GetSpellTargetUnit()
  if GetUnitTypeId(u)!='n00L' and GetUnitAbilityLevel(u,'B0FG')==0 and LoadBoolean(HY,GetHandleId(u),4306)==false then
    if IsUnitEnemy(u,GetOwningPlayer(GetTriggerUnit())) or ((LoadBoolean(HY,(GetHandleId(GetOwningPlayer(u))),(139)))==false or GetOwningPlayer(u)==GetOwningPlayer(GetTriggerUnit())) and ((IsUnitWard(u)==false and GetUnitAbilityLevel(u,'A04R')==0) or IsHomingMissile(GetUnitTypeId(u))) then
      call IED()
    endif
  endif
  set u=null
endfunction

function IHD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if (GetTriggerEvalCount(t)>30) or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Source,'A1QC')
    call UnitRemoveAbility(Source,'B0CY')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Source=null
  set t=null
  return false
endfunction

function IID takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if (GetTriggerEvalCount(t)>LoadInteger(HY,h,2))then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif LoadInteger(HY,GetHandleId(Source),4256)==1 then
    call UnitRemoveAbility(Source,'Aetl')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Source=null
  set t=null
  return false
endfunction

function IJD takes unit u,boolean enemy returns nothing
  local unit Source=u
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer c=40
  if enemy then
    set c=30
  endif
  call UnitAddAbilityTimedExF(Source,'Aetl',1,R2I(c/10),0)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'Aetl',false)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function IID))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,2,c)
  set Source=null
  set t=null
endfunction

function IKD takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real Damage=(LoadReal(HY,h,(20)))
  local trigger t
  if Source!=Target then
    call IJD(Target,LoadBoolean(HY,h,0))
    if LoadBoolean(HY,h,0)then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call UnitAddAbilityTimedExF(Target,'A1QB',1,4,'B0CY')
      call TriggerRegisterTimerEvent(t,.1,true)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
      call TriggerAddCondition(t,Condition(function IHD))
      call SaveUnitHandle(HY,h,2,(Target))
      call TextTagOnUnit("+"+I2S(R2I(Damage)),2,Target,.027,3,216,120,216)
      call DamageTarget(Source,Target,1,Damage)
    endif
  endif
  call IJD(Source,LoadBoolean(HY,h,0))
  set t=null
  set Source=null
  set Target=null
endfunction

function IMD takes boolean b, unit Target returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t2=AddProjectile(Source,Target,'h0BS',"IKD",1200,false)
  local integer Cache2=GetHandleId(t2)
  local integer stat = GetUnitPrimaryAttribute(Source)
  local real amount
  if b then
    if stat==1 then
      set amount = GetHeroInt(Source,true)*2.+75
    elseif stat==2 then
      set amount = GetHeroAgi(Source,true)*2.+75
    elseif stat==3 then
      set amount = GetHeroStr(Source,true)*2.+75
    endif
    
    call SaveReal(HY,(Cache2),(20),amount)
  endif
  
  call SaveBoolean(HY,Cache2,0,b)
  
  set Source=null
  set t2=null
endfunction

function IOD takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit t = GetSpellTargetUnit()
  local item it=GetSpellTargetItem()
  local boolean b
  if it!=null then
    set t = u
  endif
  set it=null
  if GetSpellAbilityId()=='A1QD' and (IsBlocked(t)==false or IsUnitAlly(u,GetOwningPlayer(t))) then
    call IMD(IsUnitEnemy(u,GetOwningPlayer(t)),t)
  endif
  
  set u = null
  set t = null
endfunction

function IPD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if GetTriggerEvalCount(t)>40 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif LoadInteger(HY,GetHandleId(Source),4256)==1 or IsMagicImmune(Source) then
    call UnitRemoveAbility(Source,'Aetl')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Source=null
  set t=null
  return false
endfunction

function IQD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t
  local integer h
  if IsCourier(Source)==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call UnitAddAbilityTimedExF(Source,'Aetl',1,4,0)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'Aetl',false)
    call TriggerRegisterTimerEvent(t,.1,true)
    call TriggerAddCondition(t,Condition(function IPD))
    call SaveUnitHandle(HY,h,2,(Source))
  endif
  set Source=null
  set t=null
endfunction

function IRD takes nothing returns nothing
  if GetSpellAbilityId()=='A1AC' and IsMagicImmune(GetTriggerUnit())==false then
    call IQD()
  endif
endfunction

function ISD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real ITD=(LoadReal(HY,h,(529)))
  local real IUD=(LoadReal(HY,h,(530)))
  local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
  local real IWD=GetUnitState(Source,UNIT_STATE_MAX_MANA)
  local real IXD=(LoadReal(HY,h,(668)))
  local real IYD=GetUnitStatePercent(Source,UNIT_STATE_MANA,UNIT_STATE_MAX_MANA)
  local real IZD=(IXD-IYD)/ 100
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)==20*10 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if ITD<150 then
      call SetUnitState(Source,UNIT_STATE_MANA,IVD-(150-ITD-IUD))
    endif
  else
    if IZD>0 then
      set ITD=ITD+IZD*IWD
      if IUD>0 then
        if IZD*IWD>IUD then
          call SetUnitState(Source,UNIT_STATE_MANA,IVD+IUD)
          set IUD=0
        else
          if IUD>(IWD-IVD)then
            set IUD=IUD-(IWD-IVD)
            call SetUnitState(Source,UNIT_STATE_MANA,IWD)
          else
            set IUD=IUD-IZD*IWD
            call SetUnitState(Source,UNIT_STATE_MANA,IVD+IZD*IWD)
          endif
        endif
      endif
    endif
    set IXD=IYD
    call SaveReal(HY,h,(668),((IXD)*1.))
    call SaveReal(HY,h,(529),((ITD)*1.))
    call SaveReal(HY,h,(530),((IUD)*1.))
  endif
  set t=null
  set Source=null
  return false
endfunction

function IAD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real IBD=GetWidgetLife(Source)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
  if IBD>151 then
    call SetWidgetLife(Source,IBD-150)
  else
    call SetWidgetLife(Source,1)
  endif
  call Z48("Abilities\\Spells\\Orc\\SpiritLink\\SpiritLinkZapTarget.mdl",Source,"origin",2)
  call SetUnitState(Source,UNIT_STATE_MANA,IVD+150)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function ISD))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,(242),((GetUnitState(Source,UNIT_STATE_MANA))*1.))
  call SaveReal(HY,h,(529),((0)*1.))
  call SaveReal(HY,h,(668),((GetUnitStatePercent(Source,UNIT_STATE_MANA,UNIT_STATE_MAX_MANA))*1.))
  if(IVD+150)>GetUnitState(Source,UNIT_STATE_MAX_MANA)then
    call SaveReal(HY,h,(530),(((IVD+150)-GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
  endif
  set Source=null
  set t=null
endfunction

function I3D takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x
  local real y
  if IsSentinel(GetOwningPlayer(Source))then
    set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  //call IssuePointOrderById(Source,851986,x,y)
  call CourierIssuePointOrder(Source,851986,x,y)
  call SaveCourierState(Source,"Going home")
  set Source=null
endfunction

function BSO takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x
  local real y
  if IsSentinel(GetOwningPlayer(Source))then
    set x=-4533
    set y=1158
  else
    set x=3190
    set y=-35
  endif
  call CourierIssuePointOrder(Source,851986,x,y)
  call SaveCourierState(Source,"To the Secret Shop")
  set Source=null
endfunction

function ILD takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  call SaveBoolean(HY,(GetHandleId(Hero)),(129),(true))
  set Hero=null
endfunction

function I1D takes nothing returns nothing
  if(GetSpellAbilityId()=='A0B8' or GetSpellAbilityId()=='A1WE')and IsBlocked(GetTriggerUnit()) then
    call ILD()
  endif
endfunction

function I5D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>8 then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DamageTarget(Source,Target,3,150./8.)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function I2D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and(IsCreepId(GetUnitTypeId(GetEventDamageSource()))==false and(GetOwningPlayer(GetEventDamageSource())!=Neutrals or GetUnitTypeId(GetEventDamageSource())=='n00L')and GetEventDamage()>0)or W67)then
    call UnitRemoveAbility(Target,'B0CG')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function J4D takes nothing returns nothing
  local trigger t
  local integer h
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster
  local integer i=0
  local boolean found=false
  local boolean IFD=false
  local integer charges
  if Target==null then
    set Target=GetTriggerUnit()
  endif
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  loop
    exitwhen i>5 or IFD
    if F49(UnitItemInSlot(Source,i))==indexid_UrnOfShadows then
      set charges=GetItemCharges(UnitItemInSlot(Source,i))
      if charges>0 then
        set found=true
        set charges=charges-1
      else
        set IFD=true
        set found=false
      endif
    endif
    set i=i+1
  endloop
  if found then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    if IsUnitAlly(Target,GetOwningPlayer(Source)) then
      if GetUnitAbilityLevel(Target,'B0CG')==0 then
        call UnitAddAbility(Caster,'A1MM')
        call IssueTargetOrderById(Caster,852609,Target)
        call SmoothHealingSystemForBottle(400,0,8,'B0CG',Target)
      endif
      call SaveUnitHandle(HY,h,17,Target)
      call TriggerRegisterTimerEvent(t,8,false)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
      call TriggerAddCondition(t,Condition(function I2D))
    else
      call SaveUnitHandle(HY,h,17,Target)
      call SaveUnitHandle(HY,h,2,Source)
      call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\Urn_Enemy.mdx",Target,"overhead"))
      call TriggerRegisterTimerEvent(t,1,true)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
      call TriggerAddCondition(t,Condition(function I5D))
    endif
  endif
  set Source=null
  set Caster=null
  set Target=null
  set t=null
endfunction

function Spectre_Dispersion_Init takes nothing returns nothing
  local integer i=0
  loop
    exitwhen i>16
    set WL7[i]=false
    set i=i+1
  endloop
endfunction

function J9D takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())==false then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(GetEnumUnit()),'A1ZX',false)
    call UnitAddAbilityTimedEx(GetEnumUnit(),'A1ZX',1,6,'B0DX')
  endif
endfunction

function JDD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer i=0
  local boolean found=false
  local boolean IFD=false
  local integer charges
  local group g
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),925,Condition(function LL8))
  call ForGroup(g,function J9D)
  call KillGroup(g)
  set g=null
  set Source=null
endfunction

function JFD takes unit u returns boolean
  local integer U58=GetUnitTypeId(u)
  return U58=='H0B8' or U58=='n0FJ' or U58=='n0FI' or U58=='n0F6' or U58=='n0FH' or U58=='u00S'
endfunction

//primal spirit pandas
function AKG takes integer W78 returns boolean
  return(W78=='npn3' or W78=='npn6' or W78=='n010' or W78=='n0GZ')or(W78=='npn2' or W78=='npn5' or W78=='n012' or W78=='n0H1')or(W78=='npn1' or W78=='npn4' or W78=='n011' or W78=='n0H0')
endfunction

function JGD takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),W57)and AKG(GetUnitTypeId(GetFilterUnit()))==false  and IsDead(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) or IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE))and JFD(GetFilterUnit())==false)!=null
endfunction

function JHD takes unit Source returns boolean
  local group g=GetAvailableGroup()
  local boolean found
  set W57=GetOwningPlayer(Source)
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1050,Condition(function JGD))
  set found=FirstOfGroup(g)!=null
  call KillGroup(g)
  set g=null
  return found
endfunction

function JID takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local group g
  local integer Count
  local boolean JJD
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==Source then
      call UnitRemoveAbility(Source,'A20L')
      call UnitRemoveAbility(Source,'A20S')
      call UnitRemoveAbility(Source,'B0E2')
      call UnitRemoveAbility(Source,'B09Y')
      if((LoadInteger(HY,(GetHandleId((Source))),((4302))))==1)==false then
        call UnitSetUsesAltIcon(Source,false)
      endif
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    set JJD=(LoadBoolean(HY,h,(671)))
    set Count=(LoadInteger(HY,h,(34)))
    set Count=Count+1
    call SaveInteger(HY,h,(34),(Count))
    set g=GetAvailableGroup()
    set W57=GetOwningPlayer(Source)
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1050,Condition(function JGD))
    if GetUnitAbilityLevel(Source,'B09Y')>0 then
      call SaveBoolean(HY,h,(671),(true))
    elseif JJD then
      call SaveBoolean(HY,h,(671),(false))
      call UnitRemoveAbility(Source,'A20L')
      call UnitAddAbility2(Source,'A20L')
    endif
    if Count>350 or FirstOfGroup(g)!=null then
      call UnitRemoveAbility(Source,'A20L')
      call UnitRemoveAbility(Source,'A20S')
      call UnitRemoveAbility(Source,'B0E2')
      call UnitRemoveAbility(Source,'B09Y')
      if((LoadInteger(HY,(GetHandleId((Source))),((4302))))==1)==false then
        call UnitSetUsesAltIcon(Source,false)
      endif
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
    call KillGroup(g)
  endif
  set t=null
  set Source=null
  set g=null
  return false
endfunction

function JKD takes nothing returns nothing
  local unit Source=GetEnumUnit()
  local trigger t
  local integer h
  if IsPlayerBelongToTeams(GetOwningPlayer(Source))and JHD(Source)==false then
    if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source))==false and IsObserver(GetLocalPlayer())==false then
      call UnitSetUsesAltIcon(Source,true)
    endif
    call UnitAddAbility2(Source,'A20L')
    call UnitMakeAbilityPermanent(Source,true,'A20L')
    if IsUnitBADWithSpellbooks(Source)==false then
      call UnitAddAbility2(Source,'A20S')
      call UnitMakeAbilityPermanent(Source,true,'A20S')
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20S',false)
    endif
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveInteger(HY,h,(34),(0))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveBoolean(HY,h,(671),(false))
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\SmokeOfDeceit.mdx",Source,"chest")))
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerRegisterTimerEvent(t,.1,true)
    call TriggerAddCondition(t,Condition(function JID))
    set t=null
  endif
  set Source=null
endfunction

function JMD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1225,Condition(function L68))
  call ForGroup(g,function JKD)
  call KillGroup(g)
  set Source=null
  set g=null
endfunction

function JOD takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())==false then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(GetEnumUnit()),'A28F',false)
    call UnitAddAbilityTimedEx(GetEnumUnit(),'A28F',1,25,'B0EQ')
  endif
endfunction

function JPD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call GroupEnumUnitsInRange(g,x,y,625,Condition(function LR8))
  call ForGroup(g,function JOD)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffect("war3mapImported\\DarkLightningNova.mdx",x,y))
  set Source=null
  set g=null
endfunction

function Item_QuellingBlade_Start takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))==false then
    call DamageTarget(GetTriggerUnit(),GetSpellTargetUnit(),2,100)
  endif
endfunction

function Item_QuellingBlade_Reg takes nothing returns nothing
  if GetSpellAbilityId()=='A1FD' then
    if GetUnitTypeId(GetSpellTargetUnit())=='o004' or GetUnitTypeId(GetSpellTargetUnit())=='oeye' then
      call Item_QuellingBlade_Start()
    endif
  endif
endfunction

function JTD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility(Caster,'A2K3')
  call IssueTargetOrderById(Caster,852075,Target)
  set Source=null
  set Target=null
  set Caster=null
endfunction

function JUD takes nothing returns nothing
  if GetSpellAbilityId()=='A2EA' and IsBlocked(GetSpellTargetUnit())==false then
    call JTD()
  endif
endfunction

function JVD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Count=(LoadInteger(HY,h,(34)))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count==20 or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetEventDamage()>20)then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    set Count=Count+1
    call SaveInteger(HY,h,(34),(Count))
    call SetWidgetLife(Source,GetWidgetLife(Source)+12.5)
  endif
  set t=null
  set Source=null
  return false
endfunction

function JWD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function JVD))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(34),(0))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\TranquilBootsHeal.mdx",Source,"origin")))
  set Source=null
  set t=null
endfunction

function Item_Dust_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==true and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())
endfunction

function Item_Dust_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,2))
  if GetUnitAbilityLevel(u,'Bdet')==0 then
    call UnitRemoveAbility(u,'A2SJ')
    call UnitRemoveAbility(u,'B0GR')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if GenericCondition_IsDotAInvis(u)==true then
      if GetUnitAbilityLevel(u,'B0GR')==0 then
        call UnitAddAbility2(u,'A2SJ')
      endif
    else
      if GetUnitAbilityLevel(u,'B0GR')>0 then
        call UnitRemoveAbility(u,'A2SJ')
        call UnitRemoveAbility(u,'B0GR')
      endif
    endif
  endif
  set u=null
  set t=null
  return false
endfunction

function Item_Dust_Start takes nothing returns nothing
  local unit u=GetEnumUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerRegisterDeathEvent(t,u)
  call TriggerAddCondition(t,Condition(function Item_Dust_Duration))
  call SaveUnitHandle(HY,h,2,(u))
  set t=null
  set u=null
endfunction

function Item_Dust_Init takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit u=GetTriggerUnit()
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1075,Condition(function Item_Dust_Filter))
  call ForGroup(g,function Item_Dust_Start)
  call KillGroup(g)
  set g=null
  set u=null
endfunction

function Item_Bloodstone_Act takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  call SetItemCharges(FindItemOfType(caster,Item_Real[indexid_bloodstone]),GetItemCharges(FindItemOfType(caster,Item_Real[indexid_bloodstone]))+1)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call KillUnit(caster)
  set caster=null
  set t=null
  return false
endfunction

function Item_Bloodstone_Init takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(caster))
  call TriggerAddCondition(t,Condition(function Item_Bloodstone_Act))
  call TriggerRegisterTimerEvent(t,0.01,false)
  set t=null
  set caster=null
endfunction

function Halberd_Start takes nothing returns nothing
  local unit u = GetSpellTargetUnit()
  if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==true then
    call Attack_Disable(u,3,LoDBuff_AbilID[33],LoDBuff_BuffID[33])
  else
    call Attack_Disable(u,4.5,LoDBuff_AbilID[33],LoDBuff_BuffID[33])
  endif
  set u = null
endfunction

function JAD takes integer Level,unit Source,unit Target returns nothing
  call DamageTarget(Source,Target,1,300+100*Level)
endfunction

function JBD takes nothing returns nothing
  local integer JCD=0
  if GetSpellAbilityId()=='A02O' then
    set JCD=1
  endif
  if GetSpellAbilityId()=='A08Y' then
    set JCD=2
  endif
  if GetSpellAbilityId()=='A08Z' then
    set JCD=3
  endif
  if GetSpellAbilityId()=='A090' then
    set JCD=4
  endif
  if GetSpellAbilityId()=='A092' then
    set JCD=5
  endif
  if JCD>0 and IsBlocked(GetSpellTargetUnit())==false then
    call JAD(JCD,GetTriggerUnit(),GetSpellTargetUnit())
  endif
endfunction

function J3D takes nothing returns nothing
  if GetSpellAbilityId()=='A2HQ' then
    call WL9(GetTriggerUnit(),GetSpellTargetUnit())
  endif
endfunction

function Linken_ReApply2 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local item it
  local unit u=LoadUnitHandle(HY,h,0)
  call DisableTrigger(t_manipulateitem)
  set it=CreateItem('I0HM',GetUnitX(u),GetUnitY(u))
  call UnitAddItem(u,it)
  if GetWidgetLife(it)>0 then
    call RemoveItem(it)
  endif
  set it=null
  call EnableTrigger(t_manipulateitem)
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set u=null
endfunction

function Linken_ReApply takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.1,false,function Linken_ReApply2)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function LinkenSphere_ShareRemove takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetUnitAbilityLevel(u,'B0BI')==0 or GetTriggerEvalCount(t)>170 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(u,'B0BI')
    call DestroyEffect(LoadEffectHandle(HY,h,1))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set u=null
endfunction

function LinkenSphere_SpreadOn takes unit u, boolean byItem returns nothing
  local trigger t
  local item it
  if IsUnitIllusion(u)==false then
    if byItem then
      call EKD(GetTriggerUnit())
      call UnitRemoveAbility(GetTriggerUnit(),'B0BI')
    endif
    call DisableTrigger(t_manipulateitem)
    set it=CreateItem('I0HM',GetUnitX(u),GetUnitY(u))
    if UnitAddItem(u,it) and GetWidgetLife(it)<=0 then
      set t=CreateTrigger()
      call TriggerRegisterTimerEvent(t,0.1,true)
      call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
      call TriggerAddCondition(t,Condition(function LinkenSphere_ShareRemove))
      call SaveEffectHandle(HY,GetHandleId(t),1,AddSpecialEffectTarget("effects\\Linkens_Main.mdx",u,"chest"))
      call SaveUnitHandle(HY,GetHandleId(t),0,u)
    else
      call RemoveItem(it)
    endif
    call EnableTrigger(t_manipulateitem)
  endif
  set it=null
  set t=null
endfunction

function LinkenSphere_Share takes nothing returns nothing
  call LinkenSphere_SpreadOn(GetSpellTargetUnit(),true)
endfunction

function J6D takes unit Source,integer W78,real x,real y returns nothing
  local unit JLD=CreateUnit(GetOwningPlayer(Source),W78,x,y,0)
  call UnitApplyTimedLife(JLD,'BTLF',15)
  set JLD=null
endfunction

function J1D takes nothing returns nothing
  local unit JLD
  local real x
  local real y
  if GetSpellAbilityId()=='A1ZL' then
    set x=GetDestructableX(GetSpellTargetDestructable())
    set y=GetDestructableY(GetSpellTargetDestructable())
    call J6D(GetTriggerUnit(),'n0LM',x,y)
  elseif GetSpellAbilityId()=='A1ZM' then
    set x=GetDestructableX(GetSpellTargetDestructable())
    set y=GetDestructableY(GetSpellTargetDestructable())
    call J6D(GetTriggerUnit(),'n0LN',x,y)
  endif
  set JLD=null
endfunction

function J0D takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  call UnitRemoveAbility(Source,'A1ZJ')
  call UnitRemoveAbility(Target,LoadInteger(HY,h,0))
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
  set Source=null
  set Target=null
endfunction

function J5D takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  call TimerStart(t,7,false,function J0D)
  call SaveUnitHandle(HY,h,2,u)
  call SaveUnitHandle(HY,h,17,target)
  call UnitAddAbility2(u,'A1ZJ')
  if IsUnitEnemy(u,GetOwningPlayer(target)) then
    call UnitAddAbility2(target,'A1ZJ')
    call SaveInteger(HY,h,0,'A1ZJ')
  else
    call UnitAddAbility2(target,'A44N')
    call SaveInteger(HY,h,0,'A44N')
  endif
  set t=null
  set u=null
  set target=null
endfunction

function K4D takes nothing returns nothing
  local unit whichUnit=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(whichUnit),'e00E',GetUnitX(whichUnit),GetUnitY(whichUnit),0)
  if GetSpellAbilityId()=='AIpl' then
    call UnitAddAbility(Caster,'A1WA')
  elseif GetSpellAbilityId()=='AIpr' then
    call UnitAddAbility(Caster,'AIpr')
  endif
  call IssueTargetOrderById(Caster,852609,whichUnit)
  set whichUnit=null
  set Caster=null
endfunction

function K7D takes nothing returns nothing
  if GetSpellAbilityId()=='AIpl' or GetSpellAbilityId()=='AIpr' or GetSpellAbilityId()=='A1WA' then
    if GetSpellTargetItem()!=null then
      call K4D()
    else
      if (GetUnitAbilityLevel(GetSpellTargetUnit(),'BIrm')==0 and GetSpellAbilityId()!='AIpr') then
        call SmoothHealingSystemForBottle(0,150,30,'BIrm',GetSpellTargetUnit())
      elseif (GetUnitAbilityLevel(GetSpellTargetUnit(),'B02Z')==0 and GetSpellAbilityId()=='AIpr') then
        call SmoothHealingSystemForBottle(400,0,10,'B02Z',GetSpellTargetUnit())
      endif
    endif
  elseif GetSpellAbilityId()=='A0FO' and GetUnitAbilityLevel(GetTriggerUnit(),'B04A')==0 then
    call SmoothHealingSystemForBottle(135,70,3,'B04A',GetTriggerUnit())
  endif
endfunction


function RestoreWardIfFail takes unit Hero, integer ward returns nothing
  local integer indexid
  local item it
  if ward=='o004' then
    set indexid=Item_Real[indexid_ObserverWards]
  else
    set indexid=Item_Real[indexid_SentryWards]
  endif
  call DisableTrigger(t_manipulateitem)
  set it=FindItemOfType(Hero,indexid)
  if it==null then
    set tt_player1=GetOwningPlayer(Hero)
    set tt_item1=CreateItem(indexid,0,0)
    call UnitAddItem(Hero,tt_item1)
    call SetItemPlayer(tt_item1,tt_player1,false)
    call SetItemUserData(tt_item1,1)
  else
    call SetItemCharges(it,GetItemCharges(it)+1)
  endif
  call EnableTrigger(t_manipulateitem)
  set it=null
endfunction

function NewWards takes nothing returns nothing
  local integer id=GetSpellAbilityId()
  local unit d
  local unit caster
  local real x
  local real y
  local item it
  local integer semiid
  local integer realid
  local integer index
  local real dur=0
  if id=='A02X' or id=='AIsw' then//observer ward
    if id=='A02X' then
      set semiid='o004'
      set realid='A33D'
      set dur=420
      set index=indexid_ObserverWards
    else
      set semiid='oeye'
      set realid='A33E'
      set dur=240
      set index=indexid_SentryWards
    endif
    set caster=GetTriggerUnit()
    set x=GetSpellTargetX()
    set y=GetSpellTargetY()
    if GetSpellTargetUnit()==null then
      if IsPointInRegion(ZJ7,x,y) then
        call RestoreWardIfFail(caster,semiid)
      else
        set d=CreateUnit(GetOwningPlayer(caster),semiid,x,y,0)
        call SetUnitPathing(d,false)
        call SetUnitPosition(d,x,y)
        call UnitAddAbility(d,'A0XB')
        call UnitApplyTimedLife(d,'BTFL',dur)
        set d=null
      endif
    else
      set d=GetSpellTargetUnit()
      set it=FindItemOfType(d,index)
      if it!=null then
        call SetItemCharges(it,GetItemCharges(it)+1)
      elseif GetEmptyInventorySlots(d)>0 then
        set it=CreateItem(Item_Real[index],0,0)
        call SetItemCharges(it,1)
        call UnitAddItem(d,it)
      else
        call DisplayTimedTextToPlayer(GetOwningPlayer(caster),0,0,5,"Target's inventory is full")
        call RestoreWardIfFail(caster,semiid)
      endif
      set it=null
    endif
  endif
  
  set caster=null
  set d=null
endfunction

function K9D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,(34)))
  if(GetTriggerEventId()==EVENT_UNIT_DEATH and GetKillingUnit()==Source)or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetUnitAbilityLevel(Target,'B0ES')>0)then
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\PileofGold.mdl",GetUnitX(Target),GetUnitY(Target)))
    if (IsUnitType(Source,UNIT_TYPE_HERO)==true) then
      call AddHeroXP(Source,R2I(LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)*2.5),true)
    else
      call AddHeroXP(udg_Hero[GetPlayerId(GetOwningPlayer(Source))],R2I(LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)*2.5),true)
    endif
    call ImitateBountyGain(GetOwningPlayer(Source),Target,190)
    set ReliableGold[GetPlayerId(GetOwningPlayer(Source))]=ReliableGold[GetPlayerId(GetOwningPlayer(Source))]+190
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Target)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function KDD takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitLevel(Target)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,(34),(Level))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function K9D))
  set t=null
  set Source=null
  set Target=null
endfunction

function KFD takes nothing returns nothing
  call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)+135)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",GetEnumUnit(),"origin"))
endfunction

function KGD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+600,Condition(function L08))
  call ForGroup(g,function KFD)
  call KillGroup(g)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set g=null
  set Source=null
  set t=null
  return false
endfunction

function KHD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t
  if GetSpellAbilityId()=='A0K7' then
    if GetUnitTypeId(Source)!='H00J' then
      set t=CreateTrigger()
      call TriggerRegisterTimerEvent(t,0,false)
      call TriggerAddCondition(t,Condition(function KGD))
      call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
      set t=null
    elseif GetUnitTypeId(Source)=='H00J' then
      call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+25)
    endif
  endif
  set Source=null
endfunction

function Eul_Damage takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call DamageTarget(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),1,50)
  call CleanTimer(t)
  set t=null
endfunction

function KID takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster
  local timer t
  if GetSpellAbilityId()=='A1T7' and(IsBlocked(GetSpellTargetUnit())==false or IsPlayerAlly(GetOwningPlayer(Source),GetOwningPlayer(Target)))then
    if GetSpellTargetItem()!=null then
      set Target=GetTriggerUnit()
    endif
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
    call UnitAddAbility(Caster,'AIcy')
    call IssueTargetOrderById(Caster,852144,Target)
    if IsPlayerAlly(GetOwningPlayer(Source),GetOwningPlayer(Target))==false then
      set t=CreateTimer()
      call TimerStart(t,2.51,false,function Eul_Damage)
      call SaveUnitHandle(HY,GetHandleId(t),0,Caster)
      call SaveUnitHandle(HY,GetHandleId(t),1,Target)
      set t=null
    endif
  endif
  set Source=null
  set Target=null
  set Caster=null
endfunction

function Courier_Burst_SpeedEnd takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call CustomSpeed(LoadUnitHandle(HY,h,0),0,0)
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function Courier_Burst_Speed takes unit u returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,0,u)
  call CustomSpeed(u,999,650)
  call TimerStart(t,4.0,false,function Courier_Burst_SpeedEnd)
  set t=null
endfunction

function Courier_Burst takes nothing returns nothing
  if GetSpellAbilityId()=='A0JZ' then
    call Courier_Burst_Speed(GetTriggerUnit())
  endif
endfunction

function VariousItemSpells takes nothing returns boolean
  local integer id=GetSpellAbilityId()
  call K7D()//heals
  if GetUnitTypeId(GetTriggerUnit())=='e00E' then
    return false
  endif
  if HaveSavedString(MHT,id,12) then
    call ExeFunc(LoadStr(MHT,id,12))
  endif
  call HBD()//stick charging
  if GetSpellAbilityId()=='A2K7' and IsBlocked(GetSpellTargetUnit())==false then
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LevelerStunFX.mdx",GetSpellTargetUnit(),"head"))
  endif
  return false
endfunction

function KKD takes unit Hero returns nothing
  call SetWidgetLife(Hero,GetUnitState(Hero,UNIT_STATE_MAX_LIFE))
  call SetUnitState(Hero,UNIT_STATE_MANA,GetUnitState(Hero,UNIT_STATE_MAX_MANA))
endfunction

function KND takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  call KKD(Hero)
  call RemoveStuffFromHero(Hero)
  call ClearSelectionForPlayer(GetOwningPlayer(Hero))
  call SelectUnitAddForPlayer(Hero,GetOwningPlayer(Hero))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function KPD takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x
  local real y
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call Traffic_RegisterData("AegisOff",GetPlayerId(GetOwningPlayer(Hero)))
  set K27=null
  call TriggerRegisterTimerEvent(t,5,false)
  call TriggerAddCondition(t,Condition(function KND))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call AddTimedKeyToUnit(Hero,4304,5)
  set t=null
  set Hero=null
endfunction

function KQD takes nothing returns nothing
  if F49(GetManipulatedItem())==indexid_Aegis then
    call KPD()
  endif
endfunction

function ReplaceItemByIdInSlotLoD takes unit u, integer id, integer dataint, item replaced returns nothing
  local item it
  local integer slot=GetItemSlot(u,replaced)
  local player p=GetItemPlayer(replaced)
  call DisableTrigger(t_manipulateitem)
  call RemoveItem(replaced)
  set it=AddItemByIdInSlot(u,Item_Real[id],slot)
  call SetItemPlayer(it,p,false)
  call SetItemUserData(it,dataint)
  call EnableTrigger(t_manipulateitem)
  set it=null
endfunction

function KSD takes integer indexId returns nothing
  local unit u=GetTriggerUnit()
  local item it=GetManipulatedItem()
  local integer slot
  local player p
  if indexId==indexid_RingOfBasilius then
    call ReplaceItemByIdInSlotLoD(u,indexid_RingOfBasiliusHero,1,it)
  elseif indexId==indexid_RingOfBasiliusHero then
    call ReplaceItemByIdInSlotLoD(u,indexid_RingOfBasilius,1,it)
  elseif indexId==indexid_RingOfAquila then
    call ReplaceItemByIdInSlotLoD(u,indexid_RingOfAquilaHero,1,it)
  elseif indexId==indexid_RingOfAquilaHero then
    call ReplaceItemByIdInSlotLoD(u,indexid_RingOfAquila,1,it)
  elseif indexId==indexid_MKBOn then
    call ReplaceItemByIdInSlotLoD(u,indexid_MKBOff,1,it)
  elseif indexId==indexid_MKBOff then
    call ReplaceItemByIdInSlotLoD(u,indexid_MKBOn,1,it)
  endif
  if indexId==indexid_RadianceOn then
    call ReplaceItemByIdInSlotLoD(u,indexid_RadianceOff,1,it)
  elseif indexId==indexid_RadianceOff then
    call ReplaceItemByIdInSlotLoD(u,indexid_RadianceOn,1,it)
  endif
  if indexId==indexid_PowerTreadsAgility then
    call ReplaceItemByIdInSlotLoD(u,indexid_PowerTreadsStrength,1,it)
  elseif indexId==indexid_PowerTreadsStrength then
    call ReplaceItemByIdInSlotLoD(u,indexid_PowerTreadsIntelligence,1,it)
  elseif indexId==indexid_PowerTreadsIntelligence then
    call ReplaceItemByIdInSlotLoD(u,indexid_PowerTreadsAgility,1,it)
  endif
  if indexId==indexid_DiffusalBlade and GetItemCharges(it)==0 then
    call ReplaceItemByIdInSlotLoD(u,indexid_DiffusalBlade_empty,1,it)
  elseif indexId==indexid_DiffusalBlade_upg and GetItemCharges(it)==0 then
    call ReplaceItemByIdInSlotLoD(u,indexid_DiffusalBlade_upg_empty,1,it)
  elseif indexId==indexid_janggo and GetItemCharges(it)==0 then
    call ReplaceItemByIdInSlotLoD(u,indexid_janggoempty,1,it)
  endif
  set u=null
  set it=null
endfunction

function KVD takes integer indexId returns nothing
  local unit u=GetTriggerUnit()
  local item it=GetManipulatedItem()
  local player p=GetItemPlayer(it)
  local integer i=LoadInteger(HeroStats,GetHandleId(p),'0BKB')
  local integer rid=0
  if i==0 then
    set rid=indexid_BKB09
  elseif i==9 then
    set rid=indexid_BKB08
  elseif i==8 then
    set rid=indexid_BKB07
  elseif i==7 then
    set rid=indexid_BKB06
  elseif i==6 then
    set rid=indexid_BKB05
  endif
  if indexId==indexid_BKB10 or indexId==indexid_BKB09 or indexId==indexid_BKB08 or indexId==indexid_BKB07 or indexId==indexid_BKB06 then
    call ReplaceItemByIdInSlotLoD(u,rid,1,it)
    if i==0 then
      call SaveInteger(HeroStats,GetHandleId(p),'0BKB',9)
    else
      call SaveInteger(HeroStats,GetHandleId(p),'0BKB',IMaxIF(i-1,5))
    endif
  endif
  set u=null
  set it=null
endfunction

function KWD takes integer id returns boolean
  local real KXD
  local trigger t
  local real hp
  local unit u=GetTriggerUnit()
  local item it=GetManipulatedItem()
  if id==indexid_ArmletOff then
    set KXD=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
    set hp=GetWidgetLife(u)
    call ReplaceItemByIdInSlotLoD(u,indexid_ArmletOn,1,it)
    //		//call SetWidgetLife(u,hp)
    //		set t=CreateTrigger()
    //		call TriggerRegisterTimerEvent(t,0.7/25,true)
    //		call SaveUnitHandle(MHT,GetHandleId(t),0,u)
    //		call SaveBoolean(HeroStats,GetHandleId(u),20,true)
    //		call SaveReal(MHT,GetHandleId(t),0,KXD)
    //		call echo("started")
    //		call TriggerAddCondition(t,Condition(function Armlet_TogglingOn))
    //		set t=null
    call AddTimedKeyToUnit(u,4298,.7)
  elseif id==indexid_ArmletOn then
    set KXD=GetUnitState(u,UNIT_STATE_MAX_LIFE)-GetWidgetLife(u)
    call ReplaceItemByIdInSlotLoD(u,indexid_ArmletOff,1,it)
    call SaveBoolean(HeroStats,GetHandleId(u),20,false)
    //call Armlet_StrBonus(u,0)
    call SetHeroStr(u,IMaxIF(GetHeroStr(u,false)-LoadInteger(HeroStats,GetHandleId(u),'ARML'),1),true)
    call SaveInteger(HeroStats,GetHandleId(u),'ARML',0)
    //call SetWidgetLife(u,RMaxIF(GetUnitState(u,UNIT_STATE_MAX_LIFE)-KXD,1))
  endif
  set u=null
  set it=null
  return false
endfunction

function KZD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local item it
  if EED(Source)then
    call DisableTrigger(t_manipulateitem)
    set it=CreateItem('I0HM',GetUnitX(Source),GetUnitY(Source))
    call UnitAddItem(Source,it)
    if GetWidgetLife(it)>0 then
      call RemoveItem(it)
    endif
    set it=null
    call EnableTrigger(t_manipulateitem)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call SaveBoolean(HY,(GetHandleId(Source)),(129),(false))
  set t=null
  set Source=null
  return false
endfunction

function KAD takes integer indexId returns nothing
  local unit Source=GetTriggerUnit()
  local item B38=GetManipulatedItem()
  local trigger t
  if(indexId==indexid_MantaStyle or indexId==indexid_MantaStyleRanged)and(LoadBoolean(HY,(GetHandleId(Source)),(129))) then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,.41,false)
    call TriggerAddCondition(t,Condition(function KZD))
    call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
    set t=null
  endif
  set Source=null
  set B38=null
endfunction

function KBD takes nothing returns boolean
  local real x
  local real y
  local real a
  local integer id=F49(GetManipulatedItem())
  call KSD(id)
  call ESD()
  call KQD()
  call KWD(id)
  call KVD(id)
  call KAD(id)
  return false
endfunction

function NeutralsCounter takes unit killer returns nothing
  call SaveInteger(HY,400+GetPlayerId(GetOwningPlayer(killer)),79,LoadInteger(HY,400+GetPlayerId(GetOwningPlayer(killer)),79)+1)
endfunction

function KLD takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,FrozenThroneLoc)
  elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,TreeOfLifeLoc)
  endif
  return false
endfunction

function K1D takes nothing returns nothing
  set RangeCreepsAmount=RangeCreepsAmount+1
endfunction

function K0D takes nothing returns nothing
  set MeleeCreepsAmount=MeleeCreepsAmount+1
endfunction

function K5D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,MidCreepsWaypoint)
  endif
  return false
endfunction

function K2D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,MidCreepsWaypoint)
  endif
  return false
endfunction

function M4D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,TopCreepsWaypoint)
  endif
  return false
endfunction

function M7D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,TopCreepsWaypoint)
  endif
  return false
endfunction

function M8D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,BottomCreepsWaypoint)
  endif
  return false
endfunction

function M9D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,BottomCreepsWaypoint)
  endif
  return false
endfunction

function MDD takes nothing returns nothing
  local integer i=1
  local integer id
  loop
    exitwhen i>5
    set id=GetPlayerId(Sentinels[i])
    call Traffic_RegisterData("CSK"+I2S(id),PlayerCS[id])
    call Traffic_RegisterData("CSD"+I2S(id),CSDenies[id])
    call Traffic_RegisterData("NK"+I2S(id),(LoadInteger(HY,(400+id),(79))))
    set id=GetPlayerId(Scourges[i])
    call Traffic_RegisterData("CSK"+I2S(id),PlayerCS[id])
    call Traffic_RegisterData("CSD"+I2S(id),CSDenies[id])
    call Traffic_RegisterData("NK"+I2S(id),(LoadInteger(HY,(400+id),(79))))
    set i=i+1
  endloop
endfunction

function MED takes boolean MFD returns nothing
  local unit u
  local string MGD="stand work alternate"
  local string MHD="stand work"
  local string MID="stand alternate"
  local string MJD="stand"
  set u=Elf_Rax_Melee_Top
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Elf_Rax_Melee_Mid
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Elf_Rax_Melee_Bot
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Elf_Rax_Range_Top
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Elf_Rax_Range_Mid
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Elf_Rax_Range_Bot
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MGD)
    else
      call SetUnitAnimation(u,MID)
    endif
  endif
  set u=Und_Rax_Melee_Top
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=Und_Rax_Melee_Mid
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=Und_Rax_Melee_Bot
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=Und_Rax_Range_Top
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=Und_Rax_Range_Mid
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=Und_Rax_Range_Bot
  if IsDead(u)==false then
    if MFD then
      call SetUnitAnimation(u,MHD)
    else
      call SetUnitAnimation(u,MJD)
    endif
  endif
  set u=null
endfunction

function MKD takes nothing returns boolean
  call MED(true)
  return false
endfunction

function MMD takes group g,integer MOD returns nothing
  local unit u
  loop
    set u=FirstOfGroup(g)
    exitwhen(u==null)
    call GroupRemoveUnit(g,u)
    call SetUnitAbilityLevel(u,WaypointAbilID,MOD)
    call IssuePointOrderByIdLoc(u,851983,WaypointLocations[MOD])//attack
  endloop
  set u=null
endfunction


function BoostOfflaneEnd takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call SetUnitMoveSpeed(u,LoadReal(HY,h,25))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set u=null
endfunction

function BoostOfflane takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real m
  local real d=10
  if TempInteger==1 then
    set m=1.25
  else
    set m=0.75
  endif
  call SaveReal(HY,h,25,GetUnitMoveSpeed(GetEnumUnit()))
  call SetUnitMoveSpeed(GetEnumUnit(),GetUnitMoveSpeed(GetEnumUnit())*m)
  call SaveUnitHandle(HY,h,0,GetEnumUnit())
  call TriggerRegisterTimerEvent(t,d,false)
  call TriggerAddCondition(t,Condition(function BoostOfflaneEnd))
  set t=null
endfunction

function CreepSpawning takes nothing returns nothing
  local boolean MQD=ModuloInteger(GetTriggerExecCount(AG),7)==0
  if CreepSpawnDisabled then
    return
  endif
  call MED(false)
  if MQD then
    call MDD()
  endif
  if GetTriggerExecCount(AG)==1 and Mode_OM==false then
    call UnitResetCooldown(CirclesOfPower[1])
    call UnitResetCooldown(CirclesOfPower[2])
    call UnitResetCooldown(CirclesOfPower[3])
    call UnitResetCooldown(CirclesOfPower[4])
    call UnitResetCooldown(CirclesOfPower[5])
    call UnitResetCooldown(CirclesOfPower[7])
    call UnitResetCooldown(CirclesOfPower[8])
    call UnitResetCooldown(CirclesOfPower[9])
    call UnitResetCooldown(CirclesOfPower[10])
    call UnitResetCooldown(CirclesOfPower[11])
    call UnitRemoveAbility(Towers_Sent_Top_1,'Avul')
    call UnitRemoveAbility(Towers_Sent_Mid_1,'Avul')
    call UnitRemoveAbility(Towers_Sent_Bot_1,'Avul')
    call UnitRemoveAbility(Towers_Scourge_Top_1,'Avul')
    call UnitRemoveAbility(Towers_Scourge_Mid_1,'Avul')
    call UnitRemoveAbility(Towers_Scourge_Bot_1,'Avul')
  elseif GetTriggerExecCount(AG)==1 and Mode_OM then
    call UnitRemoveAbility(Towers_Sent_Mid_1,'Avul')
    call UnitRemoveAbility(Towers_Scourge_Mid_1,'Avul')
  endif
  if GetTriggerExecCount(AG)==1 then
    call EnableTrigger(TriggerGoldPerSecond)
  endif
  if Mode_OM==false and Mode_NT==false then
    if(ElfTopRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeTopMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeTopMeleeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=1
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,2)
  endif
  if Mode_NM==false then
    if(ElfMidRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeMidMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeMidMeleeSpawn,bj_UNIT_FACING)
    endif
    call MMD(bj_lastCreatedGroup,3)
  endif
  if Mode_OM==false and Mode_NB==false then
    if(ElfBotRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'ugho',Scourges[0],ScourgeBottomMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'u001',Scourges[0],ScourgeBottomMeleeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=2
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,4)
    
  endif
  if Mode_OM==false and Mode_NT==false then
    if(ElfTopRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=1
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,2)
  endif
  if Mode_NM==false then
    if(ElfMidRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)
    endif
    call MMD(bj_lastCreatedGroup,3)
  endif
  if Mode_OM==false and Mode_NB==false then
    if(ElfBotRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'unec',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'u002',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=2
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,4)
  endif
  if MQD then
    if Mode_OM==false and Mode_NT==false then
      if(ElfTopRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeTopRangeSpawn,bj_UNIT_FACING)
      endif
      if NeedBoost then
        set TempInteger=1
        call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
      endif
      call MMD(bj_lastCreatedGroup,2)
    endif
    if Mode_NM==false then
      if(ElfMidRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeMidRangeSpawn,bj_UNIT_FACING)
      endif
      call MMD(bj_lastCreatedGroup,3)
    endif
    if Mode_OM==false and Mode_NB==false then
      if(ElfBotRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'umtw',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'u00R',Scourges[0],ScourgeBottomRangeSpawn,bj_UNIT_FACING)
      endif
      if NeedBoost then
        set TempInteger=2
        call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
      endif
      call MMD(bj_lastCreatedGroup,4)
    endif
  endif
  if Mode_OM==false and Mode_NT==false then
    if(UndTopRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelTopMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelTopMeleeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=2
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,2)
  endif
  if Mode_NM==false then
    if(UndMidRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelMidMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelMidMeleeSpawn,bj_UNIT_FACING)
    endif
    call MMD(bj_lastCreatedGroup,3)
  endif
  if Mode_OM==false and Mode_NB==false then
    if(UndBotRaxMExists)then
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'esen',Sentinels[0],SentinelBottomMeleeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(MeleeCreepsAmount,'e00V',Sentinels[0],SentinelBottomMeleeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=1
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,4)
  endif
  if Mode_OM==false and Mode_NT==false then
    if(UndTopRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=2
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,2)
  endif
  if Mode_NM==false then
    if(UndMidRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)
    endif
    call MMD(bj_lastCreatedGroup,3)
  endif
  if Mode_OM==false and Mode_NB==false then
    if(UndBotRaxRExists)then
      call CreateNUnitsAtLoc(RangeCreepsAmount,'edry',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)
    else
      call CreateNUnitsAtLoc(RangeCreepsAmount,'e00W',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)
    endif
    if NeedBoost then
      set TempInteger=1
      call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
    endif
    call MMD(bj_lastCreatedGroup,4)
  endif
  if MQD then
    if Mode_OM==false and Mode_NT==false then
      if(UndBotRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelTopRangeSpawn,bj_UNIT_FACING)
      endif
      if NeedBoost then
        set TempInteger=2
        call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
      endif
      call MMD(bj_lastCreatedGroup,2)
    endif
    if Mode_NM==false then
      if(UndMidRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelMidRangeSpawn,bj_UNIT_FACING)
      endif
      call MMD(bj_lastCreatedGroup,3)
    endif
    if Mode_OM==false and Mode_NB==false then
      if(UndBotRaxRExists)then
        call CreateNUnitsAtLoc(RangeCreepsAmount,'ebal',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)
      else
        call CreateNUnitsAtLoc(RangeCreepsAmount,'e026',Sentinels[0],SentinelBottomRangeSpawn,bj_UNIT_FACING)
      endif
      if NeedBoost then
        set TempInteger=1
        call ForGroup(bj_lastCreatedGroup,function BoostOfflane)
      endif
      call MMD(bj_lastCreatedGroup,4)
    endif
  endif
endfunction

function MRD takes nothing returns nothing
  set ElfTopRaxRExists=false
  call DisableTrigger(BG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(0)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MSD takes nothing returns nothing
  set ElfMidRaxRExists=false
  call DisableTrigger(CG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(1)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MTD takes nothing returns nothing
  set ElfBotRaxRExists=false
  call DisableTrigger(DG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(2)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MUD takes nothing returns nothing
  set ElfTopRaxMExists=false
  call DisableTrigger(EG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(0)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function MVD takes nothing returns nothing
  set ElfMidRaxMExists=false
  call DisableTrigger(FG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(1)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function MWD takes nothing returns nothing
  set ElfBotRaxMExists=false
  call DisableTrigger(GG)
  call Traffic_RegisterData("Rax"+I2S(0)+I2S(2)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function MXD takes nothing returns nothing
  set UndTopRaxRExists=false
  call DisableTrigger(HG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(0)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MYD takes nothing returns nothing
  set UndMidRaxRExists=false
  call DisableTrigger(ZG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(1)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MZD takes nothing returns nothing
  set UndBotRaxRExists=false
  call DisableTrigger(VG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(2)+I2S(1),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),true)
endfunction

function MAD takes nothing returns nothing
  set UndTopRaxMExists=false
  call DisableTrigger(WG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(0)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function MBD takes nothing returns nothing
  set UndMidRaxMExists=false
  call DisableTrigger(XG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(1)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function MCD takes nothing returns nothing
  set UndBotRaxMExists=false
  call DisableTrigger(YG)
  call Traffic_RegisterData("Rax"+I2S(1)+I2S(2)+I2S(0),GetPlayerId(GetOwningPlayer(GetKillingUnit())))
  call RaxKill(GetKillingUnit(),false)
endfunction

function M3D takes nothing returns boolean
  local real M6D=GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)
  if M6D<.75 and XI7==false then
    set XI7=true
    call Traffic_RegisterData("Tree",75)
  endif
  if M6D<.5 and XH7==false then
    set XH7=true
    call Traffic_RegisterData("Tree",50)
  endif
  if M6D<.25 and XG7==false then
    set XG7=true
    call Traffic_RegisterData("Tree",25)
  endif
  if M6D<.1 and XF7==false then
    set XF7=true
    call Traffic_RegisterData("Tree",10)
  endif
  return false
endfunction

function MLD takes nothing returns boolean
  local real M6D=GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)
  if M6D<.75 and XE7==false then
    set XE7=true
    call Traffic_RegisterData("Throne",75)
  endif
  if M6D<.5 and XD7==false then
    set XD7=true
    call Traffic_RegisterData("Throne",50)
  endif
  if M6D<.25 and X97==false then
    set X97=true
    call Traffic_RegisterData("Throne",25)
  endif
  if M6D<.1 and X87==false then
    set X87=true
    call Traffic_RegisterData("Throne",10)
  endif
  return false
endfunction

function M1D takes nothing returns boolean
  return( not(UndTopRaxMExists or UndMidRaxMExists or UndBotRaxMExists or UndTopRaxRExists or UndMidRaxRExists or UndBotRaxRExists))
endfunction

function MegaCreepsSent takes nothing returns nothing
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())]*2,GetObjectName('n04O')+" "+GetObjectName('n0C7'))
  call SetPlayerTechResearchedSwap('R00D',(GetPlayerTechCountSimple('R00D',Sentinels[0])+30),Sentinels[0])
  call SetPlayerTechResearchedSwap('R00C',(GetPlayerTechCountSimple('R00C',Sentinels[0])+30),Sentinels[0])
  call DisableTrigger(JG)
endfunction

function M5D takes nothing returns boolean
  return( not(ElfTopRaxMExists or ElfMidRaxMExists or ElfBotRaxMExists or ElfTopRaxRExists or ElfMidRaxRExists or ElfBotRaxRExists))
endfunction

function MegaCreepsScourge takes nothing returns nothing
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())]*2,GetObjectName('n04X')+" "+GetObjectName('n0C9'))
  call SetPlayerTechResearchedSwap('R009',(GetPlayerTechCountSimple('R009',Scourges[0])+30),Scourges[0])
  call SetPlayerTechResearchedSwap('R00B',(GetPlayerTechCountSimple('R00B',Scourges[0])+30),Scourges[0])
  call DisableTrigger(KG)
endfunction

function CreepUpgradeTime takes nothing returns nothing
  call SetPlayerTechResearchedSwap('R007',(GetPlayerTechCountSimple('R007',Sentinels[0])+1),Sentinels[0])
  call SetPlayerTechResearchedSwap('R00C',(GetPlayerTechCountSimple('R00C',Sentinels[0])+1),Sentinels[0])
  call SetPlayerTechResearchedSwap('R008',(GetPlayerTechCountSimple('R008',Sentinels[0])+1),Sentinels[0])
  call SetPlayerTechResearchedSwap('R00D',(GetPlayerTechCountSimple('R00D',Sentinels[0])+1),Sentinels[0])
  call SetPlayerTechResearchedSwap('R009',(GetPlayerTechCountSimple('R009',Scourges[0])+1),Scourges[0])
  call SetPlayerTechResearchedSwap('R003',(GetPlayerTechCountSimple('R003',Scourges[0])+1),Scourges[0])
  call SetPlayerTechResearchedSwap('R00A',(GetPlayerTechCountSimple('R00A',Scourges[0])+1),Scourges[0])
  call SetPlayerTechResearchedSwap('R00B',(GetPlayerTechCountSimple('R00B',Scourges[0])+1),Scourges[0])
  set NeedBoost=false
endfunction

function PreloadNeutrals takes nothing returns nothing
  local location YT9=GetRectCenter(J5)
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbdo',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbds',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngst',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'n026',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nggr',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbdk',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nbwm',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nogm',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nomg',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfpc',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfpu',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nsth',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nstl',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nsat',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nwlg',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkol',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkob',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nkot',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ncnk',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ncen',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngns',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nftb',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nfsh',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ngh1',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'npfl',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nowe',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nowb',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrm',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrr',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'nmrl',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ndtr',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'ndtw',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'n0LC',YT9,bj_UNIT_FACING))
  call RemoveUnit(CreateUnitAtLoc(Neutrals,'n0LD',YT9,bj_UNIT_FACING))
  call RemoveLocation(YT9)
  set YT9=null
endfunction

function N8D takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'n0HW',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n0HX',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n0HW',x,y,0),x,y)
endfunction

function N9D takes real x,real y returns nothing
  local unit u
  set u=CreateUnit(Neutrals,'njg1',x,y,0)
  call SetUnitPosition(u,x,y)
  set u=CreateUnit(Neutrals,'njg1',x,y,0)
  call SetUnitPosition(u,x,y)
  set u=CreateUnit(Neutrals,'njga',x,y,0)
  call SetUnitPosition(u,x,y)
  set u=null
endfunction

function NDD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nbdo',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nbdo',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nbds',x,y,0),x,y)
endfunction

function NED takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nbdk',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nbdk',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nbwm',x,y,0),x,y)
endfunction

function NFD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'ngst',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ngst',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nggr',x,y,0),x,y)
endfunction

function NGD takes real x,real y returns nothing
  local unit u
  set u=CreateUnit(Neutrals,'n0LC',x,y,0)
  call SetUnitPosition(u,x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n0LD',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n0LD',x,y,0),x,y)
  set u=null
endfunction

function NHD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nogm',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nogm',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nomg',x,y,0),x,y)
endfunction

function NID takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nfpc',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nfpu',x,y,0),x,y)
endfunction

function NJD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nsth',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)
endfunction

function NKD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nstl',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nsat',x,y,0),x,y)
endfunction

function NMD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nwlg',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nwlg',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n00S',x,y,0),x,y)
endfunction

function NND takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'n026',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'n026',x,y,0),x,y)
endfunction

function NOD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nkol',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nkob',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nkot',x,y,0),x,y)
endfunction

function NPD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nfsh',x,y,0),x,y)
endfunction

function NQD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'ncen',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ncnk',x,y,0),x,y)
endfunction

function NRD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ngns',x,y,0),x,y)
endfunction

function NSD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nftb',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nkol',x,y,0),x,y)
endfunction

function NTD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'ngh1',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'npfl',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'npfl',x,y,0),x,y)
endfunction

function NUD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'nowe',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nowb',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'nowb',x,y,0),x,y)
endfunction

function NVD takes real x,real y returns nothing
  call SetUnitPosition(CreateUnit(Neutrals,'ndtr',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ndtr',x,y,0),x,y)
  call SetUnitPosition(CreateUnit(Neutrals,'ndtw',x,y,0),x,y)
endfunction

function NWD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[0]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[0]=i
  if i==1 then
    call NID(x,y)
  elseif i==2 then
    call NJD(x,y)
  elseif i==3 then
    call NUD(x,y)
  elseif i==4 then
    call NVD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NXD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[1]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[1]=i
  if i==1 then
    call NID(x,y)
  elseif i==2 then
    call NJD(x,y)
  elseif i==3 then
    call NUD(x,y)
  elseif i==4 then
    call NVD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NYD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[2]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[2]=i
  if i==1 then
    call NID(x,y)
  elseif i==2 then
    call NJD(x,y)
  elseif i==3 then
    call NUD(x,y)
  elseif i==4 then
    call NVD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NZD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[3]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[3]=i
  if i==1 then
    call NID(x,y)
  elseif i==2 then
    call NJD(x,y)
  elseif i==3 then
    call NUD(x,y)
  elseif i==4 then
    call NVD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NAD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[4]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[4]=i
  if i==1 then
    call NND(x,y)
  elseif i==2 then
    call NHD(x,y)
  elseif i==3 then
    call NKD(x,y)
  elseif i==4 then
    call NMD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NBD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[5]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[5]=i
  if i==1 then
    call NND(x,y)
  elseif i==2 then
    call NHD(x,y)
  elseif i==3 then
    call NKD(x,y)
  elseif i==4 then
    call NMD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function NCD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[6]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[6]=i
  if i==1 then
    call NND(x,y)
  elseif i==2 then
    call NHD(x,y)
  elseif i==3 then
    call NKD(x,y)
  elseif i==4 then
    call NMD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function N3D takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[7]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[7]=i
  if i==1 then
    call NND(x,y)
  elseif i==2 then
    call NHD(x,y)
  elseif i==3 then
    call NKD(x,y)
  elseif i==4 then
    call NMD(x,y)
  elseif i==5 then
    call NQD(x,y)
  endif
endfunction

function N6D takes real x,real y returns nothing
  local integer i=GetRandomInt(1,6)
  loop
    exitwhen i!=SpawnHistory[8]
    set i=GetRandomInt(1,6)
  endloop
  set SpawnHistory[8]=i
  if i==1 then
    call NTD(x,y)
  elseif i==2 then
    call NSD(x,y)
  elseif i==3 then
    call NRD(x,y)
  elseif i==4 then
    call NOD(x,y)
  elseif i==5 then
    call NPD(x,y)
  elseif i==6 then
    call N8D(x,y)
  endif
endfunction

function NLD takes real x,real y returns nothing
  local integer i=GetRandomInt(1,6)
  loop
    exitwhen i!=SpawnHistory[9]
    set i=GetRandomInt(1,6)
  endloop
  set SpawnHistory[9]=i
  if i==1 then
    call NTD(x,y)
  elseif i==2 then
    call NSD(x,y)
  elseif i==3 then
    call NRD(x,y)
  elseif i==4 then
    call NOD(x,y)
  elseif i==5 then
    call NPD(x,y)
  elseif i==6 then
    call N8D(x,y)
  endif
endfunction

function N1D takes real x,real y returns nothing//scourge's ancients
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[10]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[10]=i
  if i==1 then
    call N9D(x,y)
  elseif i==2 then
    call NDD(x,y)
  elseif i==3 then
    call NED(x,y)
  elseif i==4 then
    call NFD(x,y)
  elseif i==5 then
    call NGD(x,y)
  endif
endfunction

function N0D takes real x,real y returns nothing
  local integer i=GetRandomInt(1,5)
  loop
    exitwhen i!=SpawnHistory[11]
    set i=GetRandomInt(1,5)
  endloop
  set SpawnHistory[11]=i
  if i==1 then
    call N9D(x,y)
  elseif i==2 then
    call NDD(x,y)
  elseif i==3 then
    call NED(x,y)
  elseif i==4 then
    call NFD(x,y)
  elseif i==5 then
    call NGD(x,y)
  endif
endfunction

function N5D takes nothing returns nothing
  if GetUnitAbilityLevel(GetEnumUnit(),'A0P4')!=0 or GetUnitTypeId(GetEnumUnit())=='o003' or GetUnitTypeId(GetEnumUnit())=='o01X' or IsDead(GetEnumUnit()) or IsCourier(GetEnumUnit()) then
    call GroupRemoveUnit(TempGroup2,GetEnumUnit())
  endif
endfunction

function N2D takes group g returns boolean
  set TempGroup2=g
  call ForGroup(g,function N5D)
  return FirstOfGroup(g)==null
endfunction

function NeutralsRespawn takes nothing returns boolean
  local group g
  local rect r1
  local rect r2
  if Mode_NN then
    return false
  endif
  set r1=NR_Und_A
  set r2=NR_Und_Ar
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call N1D(GetRectCenterX(r2),GetRectCenterY(r2))//scourge ancients
  endif
  call KillGroup(g)
  set r1=NR_Elf_A
  set r2=NR_Elf_Ar
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call N0D(GetRectCenterX(r2),GetRectCenterY(r2))//sent ancients
  endif
  call KillGroup(g)
  set r1=NR_Elf_C
  set r2=NR_Elf_Cr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NWD(GetRectCenterX(r2),GetRectCenterY(r2))//sent center
  endif
  call KillGroup(g)
  set r1=NR_Und_Bp
  set r2=NR_Und_Bpr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NYD(GetRectCenterX(r2),GetRectCenterY(r2))//scourge big pulled
  endif
  call KillGroup(g)
  set r1=NR_Und_P
  set r2=NR_Und_Pr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NLD(GetRectCenterX(r2),GetRectCenterY(r2))//scourge pulling
  endif
  call KillGroup(g)
  set r1=NR_Elf_P
  set r2=NR_Elf_Pr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call N6D(GetRectCenterX(r2),GetRectCenterY(r2))//sent pulling
  endif
  call KillGroup(g)
  set r1=NR_Und_TR
  set r2=NR_Und_TRr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NCD(GetRectCenterX(r2),GetRectCenterY(r2))//scourge toprune
  endif
  call KillGroup(g)
  set r1=NR_Elf_BR
  set r2=NR_Elf_BRr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call N3D(GetRectCenterX(r2),GetRectCenterY(r2))//sent runewiev
  endif
  call KillGroup(g)
  set r1=NR_Und_BB
  set r2=NR_Und_BBr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NZD(GetRectCenterX(r2),GetRectCenterY(r2))//scourge big near base
  endif
  call KillGroup(g)
  set r1=NR_Elf_OldSm
  set r2=NR_Elf_OldSmr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NAD(GetRectCenterX(r2),GetRectCenterY(r2))//sentinel old small
  endif
  call KillGroup(g)
  set r1=NR_Uld_OldSm
  set r2=NR_Uld_OldSmr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NBD(GetRectCenterX(r2),GetRectCenterY(r2))//scourge old small
  endif
  call KillGroup(g)
  set r1=NR_Elf_Roof
  set r2=NR_Elf_Roofr
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,r1,Condition(function ReturnTrue))
  if N2D(g)then
    call NXD(GetRectCenterX(r2),GetRectCenterY(r2))
  endif
  call KillGroup(g)
  set r1=null
  set r2=null
  set g=null
  return false
endfunction

function SuperCreeps takes nothing returns nothing
  local integer i=0
  local group g
  local unit u=null
  local real x1
  local real y1
  local real x2
  local real y2
  local integer array creepid
  local integer cid=GetRandomInt(0,2)
  local integer rid=0
  local string s=""
  local unit u2
  if Mode_NM and Mode_NT and Mode_NB then//fuck it?
    return
  endif
  set creepid[0]='n003'
  set creepid[1]='n00E'
  set creepid[2]='n00D'
  set rid=creepid[cid]//Result ID = rid, creeps being spawnd id
  set cid=GetRandomInt(0,2)//get path: 0=middle, 1=bottom, 2=top
  if Mode_OM then
    set cid=0
  endif
  if (Mode_NM and cid==0) or (Mode_NT and cid==2) or (Mode_NB and cid==1) then
    loop
      set cid=GetRandomInt(0,2)
      exitwhen (Mode_NM and cid!=0) or (Mode_NT and cid!=2) or (Mode_NB and cid!=1)
    endloop
  endif
  if cid==0 then
    set x1=GetRectCenterX(Waypoints_SentMidSpawn)
    set y1=GetRectCenterY(Waypoints_SentMidSpawn)
    set x2=GetRectCenterX(Waypoints_ScMidSpawn)
    set y2=GetRectCenterY(Waypoints_ScMidSpawn)
    set i=2
    set s="middle"
  elseif cid==1 then
    set x1=GetRectCenterX(Waypoints_SentBotSpawn)
    set y1=GetRectCenterY(Waypoints_SentBotSpawn)
    set x2=GetRectCenterX(Waypoints_ScBotSpawn)
    set y2=GetRectCenterY(Waypoints_ScBotSpawn)
    set i=3
    set s="bottom"
  else
    set x1=GetRectCenterX(Waypoints_SentTopSpawn)
    set y1=GetRectCenterY(Waypoints_SentTopSpawn)
    set x2=GetRectCenterX(Waypoints_ScTopSpawn)
    set y2=GetRectCenterY(Waypoints_ScTopSpawn)
    set i=4
    set s="top"
  endif
  if rid>0 then
    set g=GetAvailableGroup()
    set u=CreateUnit(Sentinels[0],rid,x1,y1,90)
    call GroupAddUnit(g,u)
    set u2=CreateUnit(Scourges[0],rid,x2,y2,90)
    call GroupAddUnit(g,u2)
    call MMD(g,i)
    if NeedBoost and cid!=0 then
      call GroupClear(g)
      if cid==1 then
        set TempInteger=1
        call GroupAddUnit(g,u)
        call ForGroup(g,function BoostOfflane)
        call GroupClear(g)
        set TempInteger=2
        call GroupAddUnit(g,u2)
        call ForGroup(g,function BoostOfflane)
      else
        set TempInteger=1
        call GroupAddUnit(g,u2)
        call ForGroup(g,function BoostOfflane)
        call GroupClear(g)
        set TempInteger=2
        call GroupAddUnit(g,u)
        call ForGroup(g,function BoostOfflane)
      endif
    endif
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,TxtDur[GetPlayerId(GetLocalPlayer())],"|c000000ff"+GetObjectName(rid)+"|r has been spawned for both teams and is taking the "+s+" path")
    call KillGroup(g)
  endif
  set g=null
  set u=null
  set u2=null
endfunction

function Trig_display_leaderboard_Actions takes nothing returns nothing
  local integer k
  local integer j
  local integer n
  local integer m
  local integer i
  local player p
  local integer pid
  local string sred
  local string sgreen
  local string sblue
  set XM7=XM7+1
  set SentinelsIngame=0
  set ScourgesIngame=0
  set i=0
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if IsPlayerExisted(p)then
      set SentinelsIngame=SentinelsIngame+1
    endif
    set p=Scourges[i]
    if IsPlayerExisted(p)then
      set ScourgesIngame=ScourgesIngame+1
    endif
    set i=i+1
  endloop
  if YM==false then
    set M1=SentinelsIngame
    set N1=ScourgesIngame
  endif
  set k=1
  set j=5
  set n=1
  loop
    exitwhen k>j
    set p=Sentinels[k]
    if IsPlayerExisted(p)then
      set Sents[n]=p
      set n=n+1
    endif
    set k=k+1
  endloop
  set k=1
  set j=5
  set n=1
  loop
    exitwhen k>j
    set p=Scourges[k]
    if IsPlayerExisted(p)then
      set Scrgs[n]=p
      set n=n+1
    endif
    set k=k+1
  endloop
  if XM7==1 then
    set MainMB=CreateMultiboardBJ(8+6,3+ScourgesIngame+SentinelsIngame," ")
    call MultiboardMinimize(MainMB,true)
  endif
  if NumberOfExtraAbilities>=2 then
    call MBSetText(MainMB,2,1,"CD1")
    call MBSetText(MainMB,3,1,"CD2")
  else
    call MBSetText(MainMB,2,1,"CD")
    call MBSetText(MainMB,3,1," ")
  endif
  call MBSetText(MainMB,4,1,"|c00838B8BL|r")
  call MBSetText(MainMB,5,1,RED+"K|r")
  call MBSetText(MainMB,6,1,BLUE+"D|r")
  call MBSetText(MainMB,7,1,GREY+"A|r")
  call MBSetText(MainMB,1,2,GetObjectName('n0DK'))
  call MBSetText(MainMB,5,2,RED+"0|r")
  call MBSetText(MainMB,6,2,BLUE+"0|r")
  call MBSetText(MainMB,1,3+SentinelsIngame,GetObjectName('n0DO'))
  call MBSetText(MainMB,5,3+SentinelsIngame,RED+"0|r")
  call MBSetText(MainMB,6,3+SentinelsIngame,BLUE+"0|r")
  set pid=GetPlayerId(Sentinels[0])
  call MBSetColor(MainMB,1,2,VL8(SubString(udg_Colors[pid],4,6))/255.*100, VL8(SubString(udg_Colors[pid],6,8))/255.*100, VL8(SubString(udg_Colors[pid],8,10))/255.*100,0)
  set pid=GetPlayerId(Scourges[0])
  call MBSetColor(MainMB,1,3+SentinelsIngame,VL8(SubString(udg_Colors[pid],4,6))/255.*100, VL8(SubString(udg_Colors[pid],6,8))/255.*100, VL8(SubString(udg_Colors[pid],8,10))/255.*100,0)
  set k=1
  set j=3+ScourgesIngame+SentinelsIngame
  loop
    exitwhen k>j
    call MBSetWidth(MainMB,1,k,10.8)
    call MBSetWidth(MainMB,2,k,2)
    if NumberOfExtraAbilities>=2 then
      call MBSetWidth(MainMB,3,k,2)
    else
      call MBSetWidth(MainMB,3,k,.01)
    endif
    call MBSetWidth(MainMB,4,k,2)
    call MBSetWidth(MainMB,5,k,1.3)
    call MBSetWidth(MainMB,6,k,1.3)
    call MBSetWidth(MainMB,7,k,1.3)
    call MBSetWidth(MainMB,8,k,2.5)
    call MBSetWidth(MainMB,9,k,.01)
    call MBSetWidth(MainMB,10,k,.01)
    call MBSetWidth(MainMB,11,k,.01)
    call MBSetWidth(MainMB,12,k,.01)
    call MBSetWidth(MainMB,13,k,.01)
    call MBSetWidth(MainMB,14,k,.01)
    set k=k+1
  endloop
  set k=1
  set j=8+6
  loop
    exitwhen k>j
    set n=1
    set m=3+ScourgesIngame+SentinelsIngame
    loop
      exitwhen n>m
      call MBSetStyle(MainMB,k,n,true,false)
      set n=n+1
    endloop
    set k=k+1
  endloop
  set k=1
  set j=SentinelsIngame
  loop
    exitwhen k>j
    call MBSetStyle(MainMB,1,k+2,true,true)
    call MBSetColor(MainMB,8,k+2,255,204,0,0)
    set pid=GetPlayerId(Sents[k])
    set XJ7[pid]=1-1
    set XK7[pid]=k+2-1
    call MBSetText(MainMB,1,k+2,(PlayerNames[pid]))
    if IsPlayer(Sents[k])then
      set sred=SubString(udg_Colors[pid],4,6)
      set sgreen=SubString(udg_Colors[pid],6,8)
      set sblue=SubString(udg_Colors[pid],8,10)
      call MBSetColor(MainMB,1,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
      call MBSetColor(MainMB,2,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
      call MBSetColor(MainMB,3,k+2,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
    else
      call MBSetText(MainMB,1,k+2,"|c00333333"+(PlayerNames[pid])+"|r")
    endif
    call MBSetText(MainMB,5,k+2,RED+"0|r")
    call MBSetText(MainMB,6,k+2,BLUE+"0|r")
    call MBSetText(MainMB,7,k+2,GREY+"0|r")
    set k=k+1
  endloop
  set k=1
  set j=ScourgesIngame
  loop
    exitwhen k>j
    call MBSetStyle(MainMB,1,k+3+SentinelsIngame,true,true)
    call MBSetColor(MainMB,8,k+3+SentinelsIngame,255,204,0,0)
    set pid=GetPlayerId(Scrgs[k])
    set XJ7[pid]=1-1
    set XK7[pid]=k+3+SentinelsIngame-1
    call MBSetText(MainMB,1,k+3+SentinelsIngame,(PlayerNames[pid]))
    if IsPlayer(Scrgs[k])then
      set sred=SubString(udg_Colors[pid],4,6)
      set sgreen=SubString(udg_Colors[pid],6,8)
      set sblue=SubString(udg_Colors[pid],8,10)
      call MBSetColor(MainMB,1,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
      call MBSetColor(MainMB,2,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
      call MBSetColor(MainMB,3,k+3+SentinelsIngame,VL8(sred)/255.*100,VL8(sgreen)/255.*100,VL8(sblue)/255.*100,0)
    else
      call MBSetText(MainMB,1,k+3+SentinelsIngame,"|c00333333"+(PlayerNames[pid])+"|r")
    endif
    call MBSetText(MainMB,5,k+3+SentinelsIngame,RED+"0|r")
    call MBSetText(MainMB,6,k+3+SentinelsIngame,BLUE+"0|r")
    call MBSetText(MainMB,7,k+3+SentinelsIngame,GREY+"0|r")
    set k=k+1
  endloop
  if udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)and XM7==1 then
    call MultiboardDisplay(MainMB,false)
  endif
  call MBSetStyle(MainMB,8,1,false,true)
  call MBSetIcon(MainMB,8,1,"UI\\Feedback\\Resources\\ResourceGold.blp")
  if XM7>1 then
    call TriggerExecute(TG)
  endif
  set p=null
endfunction

function RefreshBoard takes nothing returns nothing
  local integer i
  local integer k
  call MBSetText(MainMB,5,2,RED+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r")
  call MBSetText(MainMB,6,2,BLUE+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r")
  call MBSetText(MainMB,5,3+SentinelsIngame,RED+I2S(Kills[GetPlayerId(Scourges[0])])+"|r")
  call MBSetText(MainMB,6,3+SentinelsIngame,BLUE+I2S(Deaths[GetPlayerId(Scourges[0])])+"|r")
  set i=1
  set k=SentinelsIngame
  loop
    exitwhen i>k
    call MBSetText(MainMB,5,(i+2),RED+I2S(Kills[GetPlayerId(Sents[i])])+"|r")
    call MBSetText(MainMB,6,(i+2),BLUE+I2S(Deaths[GetPlayerId(Sents[i])])+"|r")
    call MBSetText(MainMB,7,(i+2),GREY+I2S(Assists[GetPlayerId(Sents[i])])+"|r")
    set i=i+1
  endloop
  set i=1
  set k=ScourgesIngame
  loop
    exitwhen i>k
    call MBSetText(MainMB,5,(i+3+SentinelsIngame),RED+I2S(Kills[GetPlayerId(Scrgs[i])])+"|r")
    call MBSetText(MainMB,6,(i+3+SentinelsIngame),BLUE+I2S(Deaths[GetPlayerId(Scrgs[i])])+"|r")
    call MBSetText(MainMB,7,(i+3+SentinelsIngame),GREY+I2S(Assists[GetPlayerId(Scrgs[i])])+"|r")
    set i=i+1
  endloop
endfunction

function OJD takes integer a returns integer
  local integer i=0
  local integer x=0
  local string s=I2S(a)
  loop
    exitwhen i>StringLength(s)
    if SubString(s,i,i+1)=="1"then
      set x=x+1
    endif
    set i=i+1
  endloop
  return x
endfunction

function OKD takes player p,integer k returns string
  if IsPlayerAlly(GetLocalPlayer(),p) then
    if SpellInfoShown[GetPlayerId(GetLocalPlayer())] then
      if k<=4+NumberOfExtraAbilities then
        return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
      else
        return EmptySlotPath
      endif
    endif
    return FD9(UnitItemInSlot(udg_Hero[GetPlayerId(p)],k-1))
    //	elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())] then
    //		if IsSentinel(p) then
    //			if LoadBoolean(MHT,'SPL0'+GetPlayerId(p),SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]])then
    //				return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
    //			else
    //				return EmptySlotPath
    //			endif
    //		else
    //			if LoadBoolean(MHT,'SPLH'+GetPlayerId(p),SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]])then
    //				return SkillIcon[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+k]]
    //			else
    //				return EmptySlotPath
    //			endif
    //		endif
  else
    return EmptySlotPath
  endif
endfunction

function BigRefreshBoard takes nothing returns nothing
  local integer VT8
  local integer VU8
  local string Time
  local real YO8
  local string s1=" "
  local integer r
  local integer i
  local integer array time_1a
  local string array color_1a
  local integer index_1a=0
  local integer array time_1b
  local string array color_1b
  local integer index_1b=0
  local integer x=0
  local integer id
  local string OOD
  local string OPD
  local string OQD
  local string ORD
  local string OSD
  local string s2=" "
  local string s
  local string sbis
  local real OTD
  local real OTDbis
  local string spacer
  local integer OUD=0
  local string OVD=""
  local string OWD=""
  local integer OXD=0
  local integer OYD=0
  local string OZD=""
  local integer pid
  if MainMB==null then
    return
  endif
  set i=1
  loop
    exitwhen i>5
    set pid=GetPlayerId(Sentinels[i])
    set r=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
    if r>0 then
      set OUD=OUD+OJD(r)
      if OXD==0 then
        if r<10 then
          set OVD=udg_Colors[pid]+"0"+I2S(r)+" |r"
        else
          set OVD=udg_Colors[pid]+I2S(r)+" |r"
        endif
      else
        if r<10 then
          set OVD=OVD+WHITE+"| |r"+udg_Colors[pid]+"0"+I2S(r)+" |r"
        else
          set OVD=OVD+WHITE+"| |r"+udg_Colors[pid]+I2S(r)+" |r"
        endif
      endif
      set OXD=OXD+1
    endif
    set i=i+1
  endloop
  if OXD>0 then
    if IsPlayerAlly(GetLocalPlayer(),Sentinels[0]) then
      set OVD=WHITE+"["+GetObjectName('n0JS')+" |r"+OVD+WHITE+"]|r"
    else
      set OVD=RED2+"["+GetObjectName('n0JR')+" |r"+OVD+RED2+"]|r"
    endif
  endif
  set i=1
  loop
    exitwhen i>5
    set pid=GetPlayerId(Scourges[i])
    set r=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
    if r>0 then
      set OUD=OUD+OJD(r)
      if OYD==0 then
        if r<10 then
          set OWD=udg_Colors[pid]+"0"+I2S(r)+" |r"
        else
          set OWD=udg_Colors[pid]+I2S(r)+" |r"
        endif
      else
        if r<10 then
          set OWD=OWD+WHITE+"| |r"+udg_Colors[pid]+"0"+I2S(r)+" |r"
        else
          set OWD=OWD+WHITE+"| |r"+udg_Colors[pid]+I2S(r)+" |r"
        endif
      endif
      set OYD=OYD+1
    endif
    set i=i+1
  endloop
  if OYD>0 then
    if IsPlayerAlly(GetLocalPlayer(),Scourges[0]) then
      set OWD=WHITE+"["+GetObjectName('n0JS')+" |r"+OWD+WHITE+"]|r"
    else
      set OWD=RED2+"["+GetObjectName('n0JR')+" |r"+OWD+RED2+"]|r"
    endif
  endif
  if MainMB!=null then
    set id=GetPlayerId(GetLocalPlayer())
    if id>=0 and id<16 then
      if CSONStatus1[x]then
        set OOD=I2S(Kills[id])
        set OPD=I2S(Deaths[id])
        set OQD=I2S(Assists[id])
        set ORD=I2S(PlayerCS[id])
        set OSD=I2S(CSDenies[id])
        set s2=" |c00838B8B("+OOD+"/"+OPD+"/"+OQD+" - "+ORD+"/"+OSD+" - |r|c00FFDC00"+I2S(ReliableGold[id])+"|r |c00838B8B)|r"
      endif
    endif
  endif
  if OYD==0 and OXD==0 then
    call MultiboardSetTitleText(MainMB,s2)
  else
    if IsPlayerAlly(GetLocalPlayer(),Sentinels[0]) then
      call MultiboardSetTitleText(MainMB,OWD+" "+OVD+" "+s2)
    else
      call MultiboardSetTitleText(MainMB,OVD+" "+OWD+" "+s2)
    endif
  endif
  if not b_isPickTime then
    if(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))==false then
      call MultiboardDisplay(MainMB,true)
    endif
  endif
  if CustomWaterColor[GetPlayerId(GetLocalPlayer())]==false then
    call SetWaterBaseColor(0,0,255,255)
  endif
  set VT8=1
  set VU8=SentinelsIngame
  loop
    exitwhen VT8>VU8
    set pid=GetPlayerId(Sents[VT8])
    call MBSetIcon(MainMB,1,VT8+2,US8(udg_Hero[pid]))
    call MBSetText(MainMB,4,VT8+2,"|c00838B8B"+I2S(GetHeroLevel(udg_Hero[pid]))+"|r")
    if ItemInfoShown[GetPlayerId(GetLocalPlayer())]then
      call MBSetWidth(MainMB,8,1,3)
      call MBSetWidth(MainMB,9,1,2.8)
      call MBSetWidth(MainMB,10,1,.8)
      call MBSetWidth(MainMB,11,1,.8)
      call MBSetWidth(MainMB,12,1,.8)
      call MBSetWidth(MainMB,13,1,.8)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+2,3)
      call MBSetWidth(MainMB,9,VT8+2,1.1)
      call MBSetWidth(MainMB,10,VT8+2,1.1)
      call MBSetWidth(MainMB,11,VT8+2,1.1)
      call MBSetWidth(MainMB,12,VT8+2,1.1)
      call MBSetWidth(MainMB,13,VT8+2,1.1)
      call MBSetWidth(MainMB,14,VT8+2,.1)
      call MBSetStyle(MainMB,9,VT8+2,false,true)
      call MBSetStyle(MainMB,10,VT8+2,false,true)
      call MBSetStyle(MainMB,11,VT8+2,false,true)
      call MBSetStyle(MainMB,12,VT8+2,false,true)
      call MBSetStyle(MainMB,13,VT8+2,false,true)
      call MBSetStyle(MainMB,14,VT8+2,false,true)
      call MBSetText(MainMB,9,1,"Items")
    elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())]then
      call MBSetWidth(MainMB,8,1,3)
      call MBSetWidth(MainMB,9,1,2.8)
      call MBSetWidth(MainMB,10,1,.8)
      call MBSetWidth(MainMB,11,1,.8)
      call MBSetWidth(MainMB,12,1,.8)
      call MBSetWidth(MainMB,13,1,.8)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+2,3)
      call MBSetWidth(MainMB,9,VT8+2,1.1)
      call MBSetWidth(MainMB,10,VT8+2,1.1)
      call MBSetWidth(MainMB,11,VT8+2,1.1)
      if NumberOfExtraAbilities>=1 then
        call MBSetWidth(MainMB,12,VT8+2,1.1)
      else
        call MBSetWidth(MainMB,12,VT8+2,.1)
      endif
      if NumberOfExtraAbilities>=2 then
        call MBSetWidth(MainMB,13,VT8+2,1.1)
      else
        call MBSetWidth(MainMB,13,VT8+2,.1)
      endif
      call MBSetWidth(MainMB,14,VT8+2,.1)
      call MBSetStyle(MainMB,9,VT8+2,false,true)
      call MBSetStyle(MainMB,10,VT8+2,false,true)
      call MBSetStyle(MainMB,11,VT8+2,false,true)
      call MBSetStyle(MainMB,12,VT8+2,false,true)
      if NumberOfExtraAbilities>=1 then
        call MBSetStyle(MainMB,13,VT8+2,false,true)
      else
        call MBSetStyle(MainMB,13,VT8+2,false,false)
      endif
      if NumberOfExtraAbilities>=2 then
        call MBSetStyle(MainMB,14,VT8+2,false,true)
      else
        call MBSetStyle(MainMB,14,VT8+2,false,false)
      endif
      call MBSetText(MainMB,9,1,"Spells")
    else
      call MBSetWidth(MainMB,8,1,2)
      call MBSetWidth(MainMB,9,1,.1)
      call MBSetWidth(MainMB,10,1,.1)
      call MBSetWidth(MainMB,11,1,.1)
      call MBSetWidth(MainMB,12,1,.1)
      call MBSetWidth(MainMB,13,1,.1)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+2,2.5)
      call MBSetWidth(MainMB,9,VT8+2,.1)
      call MBSetWidth(MainMB,10,VT8+2,.1)
      call MBSetWidth(MainMB,11,VT8+2,.1)
      call MBSetWidth(MainMB,12,VT8+2,.1)
      call MBSetWidth(MainMB,13,VT8+2,.1)
      call MBSetWidth(MainMB,14,VT8+2,.1)
      call MBSetStyle(MainMB,9,VT8+2,false,false)
      call MBSetStyle(MainMB,10,VT8+2,false,false)
      call MBSetStyle(MainMB,11,VT8+2,false,false)
      call MBSetStyle(MainMB,12,VT8+2,false,false)
      call MBSetStyle(MainMB,13,VT8+2,false,false)
      call MBSetStyle(MainMB,14,VT8+2,false,false)
      call MBSetText(MainMB,9,1," ")
    endif
    call MBSetIcon(MainMB,9,VT8+2,OKD(Sents[VT8],1))
    call MBSetIcon(MainMB,10,VT8+2,OKD(Sents[VT8],2))
    call MBSetIcon(MainMB,11,VT8+2,OKD(Sents[VT8],3))
    call MBSetIcon(MainMB,12,VT8+2,OKD(Sents[VT8],4))
    call MBSetIcon(MainMB,13,VT8+2,OKD(Sents[VT8],5))
    call MBSetIcon(MainMB,14,VT8+2,OKD(Sents[VT8],6))
    set pid=GetPlayerId(Sents[VT8])
    if(UA8(udg_Hero[pid])and udg_Hero[pid]!=null and TimerGetRemaining(HeroRespawnTimer[pid])>0)then
      if IsPlayerAlly(GetLocalPlayer(),Sents[VT8])then
        set OZD=WHITE+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
      else
        set OZD=RED2+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
      endif
    else
      set OZD="  "
    endif
    if IsPlayerLeftGame[pid]then
      call MBSetText(MainMB,1,VT8+2,TabTab+"|c00333333"+(PlayerNames[pid])+"|r"+OZD)
    else
      call MBSetText(MainMB,1,VT8+2,TabTab+(PlayerNames[pid])+OZD)
    endif
    set OTD=(TimerGetRemaining(PrimUltiTimer[pid]))
    if OTD>0 then
      set s=I2S(R2I(OTD))
    else
      set s=" "
    endif
    set OTDbis=(TimerGetRemaining(SecUltiTimer[pid]))
    if OTDbis>0 then
      set sbis=I2S(R2I(OTDbis))
    else
      set sbis=" "
    endif
    if IsPlayerAlly(GetLocalPlayer(),Sents[VT8])==false then
      call MBSetText(MainMB,8,VT8+2," ")
      set s=" "
      set sbis=" "
    else
      call MBSetText(MainMB,8,VT8+2,"|cffffcc00"+I2S(R2I(GetPlayerState(Sents[VT8],PLAYER_STATE_RESOURCE_GOLD)))+"|r")
    endif
    call MBSetText(MainMB,2,VT8+2,s)
    call MBSetText(MainMB,3,VT8+2,sbis)
    set VT8=VT8+1
  endloop
  set VT8=1
  set VU8=ScourgesIngame
  loop
    exitwhen VT8>VU8
    set pid=GetPlayerId(Scrgs[VT8])
    call MBSetIcon(MainMB,1,VT8+3+SentinelsIngame,US8(udg_Hero[pid]))
    call MBSetText(MainMB,4,VT8+3+SentinelsIngame,"|c00838B8B"+I2S(GetHeroLevel(udg_Hero[pid]))+"|r")
    if ItemInfoShown[GetPlayerId(GetLocalPlayer())]then
      call MBSetWidth(MainMB,8,1,3)
      call MBSetWidth(MainMB,9,1,2.8)
      call MBSetWidth(MainMB,10,1,.8)
      call MBSetWidth(MainMB,11,1,.8)
      call MBSetWidth(MainMB,12,1,.8)
      call MBSetWidth(MainMB,13,1,.8)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,3)
      call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
      call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,true)
      call MBSetText(MainMB,9,1,"Items")
    elseif SpellInfoShown[GetPlayerId(GetLocalPlayer())]then
      call MBSetWidth(MainMB,8,1,3)
      call MBSetWidth(MainMB,9,1,2.8)
      call MBSetWidth(MainMB,10,1,.8)
      call MBSetWidth(MainMB,11,1,.8)
      call MBSetWidth(MainMB,12,1,.8)
      call MBSetWidth(MainMB,13,1,.8)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,3)
      call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,1.1)
      call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,1.1)
      if NumberOfExtraAbilities>=1 then
        call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,1.1)
      else
        call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,.1)
      endif
      if NumberOfExtraAbilities>=2 then
        call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,1.1)
      else
        call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,.1)
      endif
      call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
      call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,true)
      call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,true)
      if NumberOfExtraAbilities>=1 then
        call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,true)
      else
        call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,false)
      endif
      if NumberOfExtraAbilities>=2 then
        call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,true)
      else
        call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,false)
      endif
      call MBSetText(MainMB,9,1,"Spells")
    else
      call MBSetWidth(MainMB,8,1,2)
      call MBSetWidth(MainMB,9,1,.1)
      call MBSetWidth(MainMB,10,1,.1)
      call MBSetWidth(MainMB,11,1,.1)
      call MBSetWidth(MainMB,12,1,.1)
      call MBSetWidth(MainMB,13,1,.1)
      call MBSetWidth(MainMB,14,1,.1)
      call MBSetWidth(MainMB,8,VT8+3+SentinelsIngame,2.5)
      call MBSetWidth(MainMB,9,VT8+3+SentinelsIngame,.1)
      call MBSetWidth(MainMB,10,VT8+3+SentinelsIngame,.1)
      call MBSetWidth(MainMB,11,VT8+3+SentinelsIngame,.1)
      call MBSetWidth(MainMB,12,VT8+3+SentinelsIngame,.1)
      call MBSetWidth(MainMB,13,VT8+3+SentinelsIngame,.1)
      call MBSetWidth(MainMB,14,VT8+3+SentinelsIngame,.1)
      call MBSetStyle(MainMB,9,VT8+3+SentinelsIngame,false,false)
      call MBSetStyle(MainMB,10,VT8+3+SentinelsIngame,false,false)
      call MBSetStyle(MainMB,11,VT8+3+SentinelsIngame,false,false)
      call MBSetStyle(MainMB,12,VT8+3+SentinelsIngame,false,false)
      call MBSetStyle(MainMB,13,VT8+3+SentinelsIngame,false,false)
      call MBSetStyle(MainMB,14,VT8+3+SentinelsIngame,false,false)
      call MBSetText(MainMB,9,1," ")
    endif
    call MBSetIcon(MainMB,9,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],1))
    call MBSetIcon(MainMB,10,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],2))
    call MBSetIcon(MainMB,11,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],3))
    call MBSetIcon(MainMB,12,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],4))
    call MBSetIcon(MainMB,13,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],5))
    call MBSetIcon(MainMB,14,VT8+3+SentinelsIngame,OKD(Scrgs[VT8],6))
    set pid=GetPlayerId(Scrgs[VT8])
    if(UA8(udg_Hero[pid])and udg_Hero[pid]!=null and TimerGetRemaining(HeroRespawnTimer[pid])>0)then
      if IsPlayerAlly(GetLocalPlayer(),Scrgs[VT8])then
        set OZD=WHITE+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
      else
        set OZD=RED2+" ("+I2S(R2I(TimerGetRemaining(HeroRespawnTimer[pid])))+")|r"
      endif
    else
      set OZD="  "
    endif
    if IsPlayerLeftGame[pid]then
      call MBSetText(MainMB,1,VT8+3+SentinelsIngame,TabTab+"|c00333333"+(PlayerNames[pid])+"|r"+OZD)
    else
      call MBSetText(MainMB,1,VT8+3+SentinelsIngame,TabTab+(PlayerNames[pid])+OZD)
    endif
    set OTD=TimerGetRemaining(PrimUltiTimer[pid])
    if OTD>0 then
      set s=I2S(R2I(OTD))
    else
      set s=" "
    endif
    set OTDbis=TimerGetRemaining(SecUltiTimer[pid])
    if OTDbis>0 then
      set sbis=I2S(R2I(OTDbis))
    else
      set sbis=" "
    endif
    if IsPlayerAlly(GetLocalPlayer(),Scrgs[VT8])==false then
      call MBSetText(MainMB,8,VT8+3+SentinelsIngame," ")
      set s=" "
      set sbis=" "
    else
      call MBSetText(MainMB,8,VT8+3+SentinelsIngame,"|cffffcc00"+I2S(R2I(GetPlayerState(Scrgs[VT8],PLAYER_STATE_RESOURCE_GOLD)))+"|r")
    endif
    call MBSetText(MainMB,2,VT8+3+SentinelsIngame,s)
    call MBSetText(MainMB,3,VT8+3+SentinelsIngame,sbis)
    set VT8=VT8+1
  endloop
endfunction

function OAD takes player p returns string
  return udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId(p)]+"|r"
endfunction

function OBD takes player p returns string
  local string OCD=I2S(AssistsBonusGoldCounter[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function O6D takes player p returns string
  local string OCD=I2S(AssistsBonusExpCounter[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function I59 takes nothing returns nothing
  local integer i=1
  local multiboarditem mbitem
  loop
    exitwhen i>XA7
    if(LeftAt[GetPlayerId((XZ7[i]))])!="Here"then
      set mbitem=MultiboardGetItem(FinalMB,XX7[i],XY7[i])
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemValue(mbitem,"|c00555555"+(LeftAt[GetPlayerId((XZ7[i]))])+"|r")
      call MultiboardSetItemWidth(mbitem,.07)
      call MultiboardReleaseItem(mbitem)
    endif
    set i=i+1
  endloop
  set mbitem=null
endfunction

function OLD takes player p returns string
  local string OCD=I2S(GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function O1D takes player p returns string
  local string OCD=I2S(ItemStats_Consumables[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function O0D takes player p returns string
  local string OCD=I2S(GetUnitLevel(udg_Hero[GetPlayerId(p)]))
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function O5D takes player p returns string
  local string OCD=I2S(ItemStats_Wards[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function O2D takes player p returns string
  local string OCD=I2S(GoldEarnedByKills[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function P4D takes player p returns string
  local string OCD=I2S(PlayerGoldCash[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function P7D takes player p returns string
  local string OCD=I2S(Assists[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function P8D takes player p returns string
  local string OCD=I2S(Kills[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function P9D takes player p returns string
  local string OCD=I2S(Deaths[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PDD takes player p returns string
  local string OCD=I2S(PlayerCS[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PED takes player p returns string
  local string OCD=I2S(CSDenies[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PFD takes player p returns string
  local string OCD=I2S((LoadInteger(HY,(400+GetPlayerId(p)),(79))))
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PGD takes player p returns string
  local string OCD=I2S(DoubleKills[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PHD takes player p returns string
  local string OCD=I2S(TrippleKills[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PID takes player p returns string
  local string OCD=I2S(PlayerBestStreak[GetPlayerId(p)])
  local string O3D=OCD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+OCD+"|r"
  endif
  return O3D
endfunction

function PJD takes player p returns string
  local string PKD
  local string PMD
  local string O3D
  local integer k=PlayerTowersKilled[GetPlayerId(p)]
  local integer d=PlayerTowersDenied[GetPlayerId(p)]
  if k<1 then
    set k=0
  endif
  if d<1 then
    set d=0
  endif
  set PKD=I2S(k)
  set PMD=I2S(d)
  set O3D=PKD+"/"+PMD
  if p==GetLocalPlayer()then
    set O3D=ORANGE+PKD+"|r/"+ORANGE+PMD+"|r"
  endif
  return O3D
endfunction

function PND takes player p returns string
  local integer POD=PlayerTimeDead[GetPlayerId(p)]
  local string Time
  local integer Minutes
  local integer Seconds
  set Minutes=(POD/ 60)-(1/ 2)
  set Seconds=ModuloInteger(POD,60)
  if(Seconds<10)then
    set Time=I2S(Minutes)+":0"+I2S(Seconds)
  else
    set Time=I2S(Minutes)+":"+I2S(Seconds)
  endif
  if p==GetLocalPlayer()then
    set Time=ORANGE+Time+"|r"
  endif
  return Time
endfunction

function PPD takes player Source,player Target returns string
  local string PKD
  local string PMD
  local string O3D
  local integer k=LoadInteger(HY,400+GetPlayerId(Source),450+GetPlayerId(Target))
  local integer d=LoadInteger(HY,400+GetPlayerId(Source),500+GetPlayerId(Target))
  if k<1 then
    set k=0
  endif
  if d<1 then
    set d=0
  endif
  set PKD=I2S(k)
  set PMD=I2S(d)
  set O3D=PKD+"/"+PMD
  if Source==GetLocalPlayer()then
    set O3D=ORANGE+PKD+"|r/"+ORANGE+PMD+"|r"
  endif
  return O3D
endfunction

function DisplayFinalMB takes nothing returns nothing
  local integer elf=SentinelsIngame
  local integer und=ScourgesIngame
  local player array PTD
  local player array PUD
  local integer curRow
  local integer curCol
  local integer numRows=21+IMaxIF(elf,und)+1
  local integer numCols=1+(elf+und)*2
  local multiboarditem mbitem
  local integer i
  local integer x
  local string e="|r"
  local string c0="|cff99ccff"
  local integer PZD
  local integer PAD
  call DisableTrigger(QG)
  call DestroyMultiboard(MainMB)
  if elf>0 and und>0 then
    set numRows=numRows+2
  endif
  set FinalMB=CreateMultiboard()
  call MultiboardSetItemsWidth(FinalMB,0)
  call MultiboardSetRowCount(FinalMB,numRows)
  call MultiboardSetColumnCount(FinalMB,numCols)
  call MultiboardSetTitleText(FinalMB,GetObjectName('n0E3')+" "+" - "+(QK))
  call MultiboardMinimize(FinalMB,true)
  call MultiboardSetItemsStyle(FinalMB,false,false)
  call MultiboardDisplay(FinalMB,true)
  call MultiboardMinimize(FinalMB,false)
  call MultiboardSetTitleText(FinalMB,GetObjectName('n0E3')+" "+" - "+(QK)+" - "+("|c00ff0303"+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r/|c0020c000"+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r"))
  set x=1
  set i=1
  loop
    exitwhen i>5
    if IsPlayer(Sentinels[i])or GetPlayerSlotState(Sentinels[i])==PLAYER_SLOT_STATE_LEFT then
      set PTD[x]=Sentinels[i]
      set x=x+1
    endif
    set i=i+1
  endloop
  set x=1
  set i=1
  loop
    exitwhen i>5
    if IsPlayer(Scourges[i])or GetPlayerSlotState(Scourges[i])==PLAYER_SLOT_STATE_LEFT then
      set PUD[x]=Scourges[i]
      set x=x+1
    endif
    set i=i+1
  endloop
  set i=0
  set curCol=0
  loop
    exitwhen i>numRows
    set mbitem=MultiboardGetItem(FinalMB,i,curCol)
    call MultiboardSetItemWidth(mbitem,.075)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=0
  set curCol=0
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem," ")
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,false,false)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OAD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OAD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,false,false)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,true)
    call MultiboardSetItemValue(mbitem,O0D(PTD[i]))
    call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,true)
    call MultiboardSetItemValue(mbitem,O0D(PUD[i]))
    call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0EB')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],(1)-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],2-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],(1)-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],2-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],(3)-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],(4)-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],(3)-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],(4)-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],5-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId((PTD[i]))],6-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],5-1))))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,(FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],6-1))))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E2')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OLD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OLD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E1')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P8D(PTD[i])+"/"+P9D(PTD[i])+"/"+P7D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P8D(PUD[i])+"/"+P9D(PUD[i])+"/"+P7D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DZ')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PDD(PTD[i])+"/"+PED(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PDD(PUD[i])+"/"+PED(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0JU')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OBD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,OBD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0KF')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O6D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O6D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E0')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O5D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O5D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DT')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PJD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PJD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DY')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PFD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PFD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DU')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O2D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O2D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DV')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PND(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PND(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DW')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P4D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P4D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DN')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O1D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,O1D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0D8')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PGD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PGD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DI')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PHD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PHD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DM')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PID(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PID(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  if elf>0 and und>0 then
    set curCol=0
    set PZD=curRow
    set PAD=curCol
    set curRow=curRow+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DL')+e)
    call MultiboardReleaseItem(mbitem)
    set curRow=PZD
    set x=1
    loop
      exitwhen x>elf
      set curCol=0
      set curRow=PZD
      set i=1
      loop
        exitwhen i>und
        set curCol=x+(x-1)
        set curRow=curRow+1
        set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,false,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[x]))])))
        call MultiboardSetItemWidth(mbitem,.01)
        call MultiboardReleaseItem(mbitem)
        set curCol=curCol+1
        set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,true,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
        call MultiboardSetItemValue(mbitem," "+PPD(PTD[x],PUD[i]))
        call MultiboardSetItemWidth(mbitem,.059)
        call MultiboardReleaseItem(mbitem)
        set i=i+1
      endloop
      set x=x+1
    endloop
    set x=elf+1
    loop
      exitwhen x>(und+elf)
      set curCol=0
      set curRow=PZD
      set i=1
      loop
        exitwhen i>elf
        set curCol=x+(x-1)
        set curRow=curRow+1
        set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,false,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PUD[x-elf]))])))
        call MultiboardSetItemWidth(mbitem,.01)
        call MultiboardReleaseItem(mbitem)
        set curCol=curCol+1
        set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,true,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
        call MultiboardSetItemValue(mbitem," "+PPD(PUD[x-elf],PTD[i]))
        call MultiboardSetItemWidth(mbitem,.059)
        call MultiboardReleaseItem(mbitem)
        set i=i+1
      endloop
      set x=x+1
    endloop
  endif
  set curRow=curRow+1
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0CZ')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>elf
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(LeftAt[GetPlayerId((PTD[i]))]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set XA7=XA7+1
    set XX7[XA7]=curRow
    set XY7[XA7]=curCol
    set XZ7[XA7]=PTD[i]
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>und
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(LeftAt[GetPlayerId(PUD[i])]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set XA7=XA7+1
    set XX7[XA7]=curRow
    set XY7[XA7]=curCol
    set XZ7[XA7]=PUD[i]
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0D9')+e)
  call MultiboardReleaseItem(mbitem)
  set mbitem=MultiboardGetItem(FinalMB,curRow,curCol+1)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,(K3))
  call MultiboardSetItemWidth(mbitem,.07)
  call MultiboardReleaseItem(mbitem)
  call MultiboardMinimize(FinalMB,true)
  call MultiboardMinimize(FinalMB,false)
  set mbitem=null
endfunction

function PBD takes player p returns string
  return udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"
endfunction

function PCD takes player p returns string
  local integer k=PlayerTowersKilled[GetPlayerId(p)]
  local integer d=PlayerTowersDenied[GetPlayerId(p)]
  if k<1 then
    set k=0
  endif
  if d<1 then
    set d=0
  endif
  return I2S(k)+"/"+I2S(d)
endfunction

function P3D takes player p returns string
  local integer POD=PlayerTimeDead[GetPlayerId(p)]
  local string Time
  local integer Minutes
  local integer Seconds
  set Minutes=(POD/ 60)-(1/ 2)
  set Seconds=ModuloInteger(POD,60)
  if(Seconds<10)then
    set Time=I2S(Minutes)+":0"+I2S(Seconds)
  else
    set Time=I2S(Minutes)+":"+I2S(Seconds)
  endif
  return Time
endfunction

function P6D takes player Source,player Target returns string
  local integer k=(LoadInteger(HY,(400+GetPlayerId(Source)),(450+GetPlayerId(Target))))
  local integer d=(LoadInteger(HY,(400+GetPlayerId(Source)),(500+GetPlayerId(Target))))
  if k<1 then
    set k=0
  endif
  if d<1 then
    set d=0
  endif
  return I2S(k)+"/"+I2S(d)
endfunction

function PLD takes player Source returns string
  local string P1D
  if IsDead(udg_Hero[GetPlayerId(Source)])then
    set P1D=I2S(R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Source)])))
  else
    set P1D=" "
  endif
  return P1D
endfunction

function P0D takes player Source returns string
  local real r=(TimerGetRemaining(PrimUltiTimer[GetPlayerId((Source))]))
  local string P1D
  if r>0 then
    set P1D=I2S(R2I(r))
  else
    set P1D=" "
  endif
  return P1D
endfunction

function P5D takes integer P2D,integer Q4D returns nothing
  set ObsBoard=CreateMultiboard()
  call MultiboardSetItemsWidth(ObsBoard,0)
  call MultiboardSetRowCount(ObsBoard,P2D)
  call MultiboardSetColumnCount(ObsBoard,Q4D)
  call MultiboardSetTitleText(ObsBoard,GetObjectName('n0E3')+" "+" - "+(QK))
  call MultiboardMinimize(ObsBoard,true)
  call MultiboardSetItemsStyle(ObsBoard,false,false)
  if (GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2) then
    call MultiboardDisplay(ObsBoard,true)
  endif
endfunction

function Q7D takes nothing returns nothing
  local integer PRD=M1
  local integer PSD=N1
  local player array PTD
  local player array PUD
  local integer curRow
  local integer curCol
  local integer numRows=1+21+IMaxIF(PRD,PSD)
  local integer numCols=1+(PRD+PSD)*2
  local multiboarditem mbitem
  local integer i
  local integer x
  local string e="|r"
  local string c0="|cff99ccff"
  local integer PZD
  local integer PAD
  local integer Q8D=131
  local integer Q9D=139
  local integer QDD=139
  local integer QED=255
  local integer OUD=0
  local string OVD=""
  local string OWD=""
  local integer OXD=0
  local integer OYD=0
  local integer r
  if PRD>0 and PSD>0 then
    set numRows=numRows+2
  endif
  if GetTriggerExecCount(GetTriggeringTrigger())==1 then
    call P5D(numRows,numCols)
  endif
  if udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2) then
    call MultiboardDisplay(ObsBoard,true)
  endif
  set i=1
  loop
    exitwhen i>5
    set r=R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Sentinels[i])]))
    if r>0 then
      set OUD=OUD+OJD(r)
      if OXD==0 then
        if r<10 then
          set OVD=udg_Colors[GetPlayerId(Sentinels[i])]+"0"+I2S(r)+" |r"
        else
          set OVD=udg_Colors[GetPlayerId(Sentinels[i])]+I2S(r)+" |r"
        endif
      else
        if r<10 then
          set OVD=OVD+WHITE+"| |r"+udg_Colors[GetPlayerId(Sentinels[i])]+"0"+I2S(r)+" |r"
        else
          set OVD=OVD+WHITE+"| |r"+udg_Colors[GetPlayerId(Sentinels[i])]+I2S(r)+" |r"
        endif
      endif
      set OXD=OXD+1
    endif
    set i=i+1
  endloop
  if OXD>0 then
    set OVD=WHITE+"[Sentinel: |r"+OVD+WHITE+"]|r"
  endif
  set i=1
  loop
    exitwhen i>5
    set r=R2I(TimerGetRemaining(HeroRespawnTimer[GetPlayerId(Scourges[i])]))
    if r>0 then
      set OUD=OUD+OJD(r)
      if OYD==0 then
        if r<10 then
          set OWD=udg_Colors[GetPlayerId(Scourges[i])]+"0"+I2S(r)+" |r"
        else
          set OWD=udg_Colors[GetPlayerId(Scourges[i])]+I2S(r)+" |r"
        endif
      else
        if r<10 then
          set OWD=OWD+WHITE+"| |r"+udg_Colors[GetPlayerId(Scourges[i])]+"0"+I2S(r)+" |r"
        else
          set OWD=OWD+WHITE+"| |r"+udg_Colors[GetPlayerId(Scourges[i])]+I2S(r)+" |r"
        endif
      endif
      set OYD=OYD+1
    endif
    set i=i+1
  endloop
  if OYD>0 then
    set OWD=WHITE+"[Scourge: |r"+OWD+WHITE+"]|r"
  endif
  call MultiboardSetTitleText(ObsBoard,OVD+" "+OWD+" "+GetObjectName('n0E3')+" "+" - "+(QK)+" - "+("|c00ff0303"+I2S(Kills[GetPlayerId(Sentinels[0])])+"|r/|c0020c000"+I2S(Deaths[GetPlayerId(Sentinels[0])])+"|r"))
  set x=1
  set i=1
  loop
    exitwhen i>5
    if IsPlayer(Sentinels[i])or GetPlayerSlotState(Sentinels[i])==PLAYER_SLOT_STATE_LEFT then
      set PTD[x]=Sentinels[i]
      set x=x+1
    endif
    set i=i+1
  endloop
  set x=1
  set i=1
  loop
    exitwhen i>5
    if IsPlayer(Scourges[i])or GetPlayerSlotState(Scourges[i])==PLAYER_SLOT_STATE_LEFT then
      set PUD[x]=Scourges[i]
      set x=x+1
    endif
    set i=i+1
  endloop
  set i=0
  set curCol=0
  loop
    exitwhen i>numRows
    set mbitem=MultiboardGetItem(ObsBoard,i,curCol)
    call MultiboardSetItemWidth(mbitem,.075)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=0
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem," ")
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,false,false)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PBD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PBD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,false,false)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,true)
    call MultiboardSetItemValue(mbitem,"("+(I2S(GetUnitLevel(udg_Hero[GetPlayerId((PTD[i]))])))+")")
    call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,true)
    call MultiboardSetItemValue(mbitem,"("+I2S(GetUnitLevel(udg_Hero[GetPlayerId(PUD[i])]))+")")
    call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0EB')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],1-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],2-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],1-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],2-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],3-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],4-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],3-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],4-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],5-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PTD[i])],6-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],5-1)))
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,FD9(UnitItemInSlot(udg_Hero[GetPlayerId(PUD[i])],6-1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E2')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetPlayerState(PTD[i],PLAYER_STATE_RESOURCE_GOLD)))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(GetPlayerState(PUD[i],PLAYER_STATE_RESOURCE_GOLD))))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0LT')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId((PTD[i]))]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(BuybackUnitCost[DefineBuybackUnitIndex(GetHeroLevel(udg_Hero[GetPlayerId(PUD[i])]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DZ')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(PlayerCS[GetPlayerId((PTD[i]))]))+"/"+(I2S(CSDenies[GetPlayerId((PTD[i]))]))+"/"+(I2S((LoadInteger(HY,(400+GetPlayerId((PTD[i]))),(79))))))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(PlayerCS[GetPlayerId(PUD[i])]))+"/"+(I2S(CSDenies[GetPlayerId(PUD[i])]))+"/"+(I2S((LoadInteger(HY,(400+GetPlayerId(PUD[i])),(79))))))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E1')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(Kills[GetPlayerId((PTD[i]))]))+"/"+(I2S(Deaths[GetPlayerId((PTD[i]))]))+"/"+(I2S(Assists[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(Kills[GetPlayerId(PUD[i])]))+"/"+(I2S(Deaths[GetPlayerId(PUD[i])]))+"/"+(I2S(Assists[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E0')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Wards[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Wards[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DT')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PCD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,PCD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DU')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(GoldEarnedByKills[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(GoldEarnedByKills[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+"Skills"+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+1]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+1]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],1)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+2]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],2)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+2]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],2)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+3]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],3)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+3]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],3)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curRow=curRow+1
  set curCol=0
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+" "+e)
  call MultiboardReleaseItem(mbitem)
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+4]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],4)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,false,true)
    call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+4]])
    call MultiboardSetItemWidth(mbitem,.015)
    call MultiboardReleaseItem(mbitem)
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],4)))
    call MultiboardSetItemWidth(mbitem,.054)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  if NumberOfExtraAbilities>=1 then
    set curRow=curRow+1
    set curCol=0
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,c0+" "+e)
    call MultiboardReleaseItem(mbitem)
    set i=1
    loop
      exitwhen i>PRD
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,false,true)
      call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+5]])
      call MultiboardSetItemWidth(mbitem,.015)
      call MultiboardReleaseItem(mbitem)
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],5)))
      call MultiboardSetItemWidth(mbitem,.054)
      call MultiboardReleaseItem(mbitem)
      set i=i+1
    endloop
    set i=1
    loop
      exitwhen i>PSD
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,false,true)
      call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+5]])
      call MultiboardSetItemWidth(mbitem,.015)
      call MultiboardReleaseItem(mbitem)
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],5)))
      call MultiboardSetItemWidth(mbitem,.054)
      call MultiboardReleaseItem(mbitem)
      set i=i+1
    endloop
  endif
  if NumberOfExtraAbilities>=2 then
    set curRow=curRow+1
    set curCol=0
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,c0+" "+e)
    call MultiboardReleaseItem(mbitem)
    set i=1
    loop
      exitwhen i>PRD
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,false,true)
      call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PTD[i])*PlayerSkillOffset+6]])
      call MultiboardSetItemWidth(mbitem,.015)
      call MultiboardReleaseItem(mbitem)
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId((PTD[i]))],6)))
      call MultiboardSetItemWidth(mbitem,.054)
      call MultiboardReleaseItem(mbitem)
      set i=i+1
    endloop
    set i=1
    loop
      exitwhen i>PSD
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,false,true)
      call MultiboardSetItemIcon(mbitem,SkillIcon[PlayerSkillNumber[GetPlayerId(PUD[i])*PlayerSkillOffset+6]])
      call MultiboardSetItemWidth(mbitem,.015)
      call MultiboardReleaseItem(mbitem)
      set curCol=curCol+1
      set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemValue(mbitem,I2S(GetHeroAbilityLevel(udg_Hero[GetPlayerId(PUD[i])],6)))
      call MultiboardSetItemWidth(mbitem,.054)
      call MultiboardReleaseItem(mbitem)
      set i=i+1
    endloop
  endif
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DV')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P3D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,P3D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DW')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(PlayerGoldCash[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(PlayerGoldCash[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DN')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Consumables[GetPlayerId((PTD[i]))])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,(I2S(ItemStats_Consumables[GetPlayerId(PUD[i])])))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  if PRD>0 and PSD>0 then
    set curCol=0
    set PZD=curRow
    set PAD=curCol
    set curRow=curRow+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemStyle(mbitem,true,false)
    call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0DL')+e)
    call MultiboardReleaseItem(mbitem)
    set curRow=PZD
    set x=1
    loop
      exitwhen x>PRD
      set curCol=0
      set curRow=PZD
      set i=1
      loop
        exitwhen i>PSD
        set curCol=x+(x-1)
        set curRow=curRow+1
        set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,false,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[x]))])))
        call MultiboardSetItemWidth(mbitem,.01)
        call MultiboardReleaseItem(mbitem)
        set curCol=curCol+1
        set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,true,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
        call MultiboardSetItemValue(mbitem," "+P6D(PTD[x],PUD[i]))
        call MultiboardSetItemWidth(mbitem,.059)
        call MultiboardReleaseItem(mbitem)
        set i=i+1
      endloop
      set x=x+1
    endloop
    set x=PRD+1
    loop
      exitwhen x>(PSD+PRD)
      set curCol=0
      set curRow=PZD
      set i=1
      loop
        exitwhen i>PRD
        set curCol=x+(x-1)
        set curRow=curRow+1
        set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,false,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PUD[x-PRD]))])))
        call MultiboardSetItemWidth(mbitem,.01)
        call MultiboardReleaseItem(mbitem)
        set curCol=curCol+1
        set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
        call MultiboardSetItemStyle(mbitem,true,true)
        call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
        call MultiboardSetItemValue(mbitem," "+P6D(PUD[x-PRD],PTD[i]))
        call MultiboardSetItemWidth(mbitem,.059)
        call MultiboardReleaseItem(mbitem)
        set i=i+1
      endloop
      set x=x+1
    endloop
  endif
  set curRow=curRow+1
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0HS')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    if PLD(PTD[i])==" "then
      call MultiboardSetItemStyle(mbitem,true,false)
    else
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
    endif
    call MultiboardSetItemValue(mbitem,P0D(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    call MultiboardSetItemValueColor(mbitem,Q8D,Q9D,QDD,QED)
    if PLD(PUD[i])==" "then
      call MultiboardSetItemStyle(mbitem,true,false)
    else
      call MultiboardSetItemStyle(mbitem,true,false)
      call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
    endif
    call MultiboardSetItemValue(mbitem,P0D(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set curCol=0
  set curRow=curRow+1
  set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
  call MultiboardSetItemStyle(mbitem,true,false)
  call MultiboardSetItemValue(mbitem,c0+GetObjectName('n0E4')+e)
  call MultiboardReleaseItem(mbitem)
  set curCol=0
  set i=1
  loop
    exitwhen i>PRD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    if PLD(PTD[i])==" "then
      call MultiboardSetItemStyle(mbitem,true,false)
    else
      call MultiboardSetItemStyle(mbitem,true,true)
      call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId((PTD[i]))])))
    endif
    call MultiboardSetItemValue(mbitem,PLD(PTD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>PSD
    set curCol=curCol+1
    set mbitem=MultiboardGetItem(ObsBoard,curRow,curCol)
    if PLD(PUD[i])==" "then
      call MultiboardSetItemStyle(mbitem,true,false)
    else
      call MultiboardSetItemStyle(mbitem,true,true)
      call MultiboardSetItemIcon(mbitem,(US8(udg_Hero[GetPlayerId(PUD[i])])))
    endif
    call MultiboardSetItemValue(mbitem,PLD(PUD[i]))
    call MultiboardSetItemWidth(mbitem,.07)
    call MultiboardReleaseItem(mbitem)
    set i=i+1
  endloop
  set mbitem=null
endfunction

function CreateObsBoard takes nothing returns nothing
  local trigger t
  if udg_ObserverMode then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddAction(t,function Q7D)
    set X37=t
  endif
  set t=null
endfunction

function IsUnitShop takes unit u returns boolean
  local integer i=GetUnitTypeId(u)
  return i=='hC95' or i=='n01K' or i=='nC38' or i=='n00V' or i=='n00W' or i=='n002' or i=='n00X' or i=='n009' or i=='n0HE' or i=='nC35' or i=='u00Q' or i=='uC74' or i=='u010' or i=='u00Z'
endfunction

function Add2Log takes string p, real time, string target returns nothing
  local integer i=LoadInteger(UTable,-1,0)
  local integer mins=R2I(time/60 - 1/2)
  local integer seconds=R2I(time-mins*60)
  call SaveStr(UTable,-1,i,p+" selected "+target+" at "+I2S(mins)+":"+I2S(seconds))
  call SaveInteger(UTable,-1,0,i+1)
endfunction

function UnitSelected takes unit u returns nothing
  if GetUnitTypeId(u)!='hfoo' and IsUnitVisible(u,GetTriggerPlayer())==false then
    call Add2Log(PlayerNames[GetPlayerId(GetTriggerPlayer())],TimerGetElapsed(GlobalTimer),GetUnitName(u))
    //call echo("fog click by "+PlayerNames[GetPlayerId(GetTriggerPlayer())])
  endif
endfunction

function ShopAnimation takes nothing returns boolean
  local unit u=GetTriggerUnit()
  local integer id=GetUnitTypeId(u)
  local boolean b=GetOwningPlayer(u)==Player(15) and IsUnitShop(u) and GetLocalPlayer()==GetTriggerPlayer()
  local string s=""
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_DESELECTED then
    if b then
      call ResetUnitAnimation(u)
    endif
  else
    if Mode_AH then
      call UnitSelected(u)
    endif
    if b then
      if id=='hC95' or id=='n00X' or id=='n009' or id=='nC35' or id=='u00Q' or id=='u010' or id=='u00Z' then
        set s="stand work"
      elseif id=='n01K' then
        set s="stand third"
      elseif id=='nC38' then
        call SetUnitAnimationByIndex(u,3)
      elseif id=='n00V' then
        set s="spell attack"
      elseif id=='n00W' then
        set s="spell"
      elseif id=='n002' then
        call SetUnitAnimationByIndex(u,3)
      elseif id=='n0HE' then
        set s="stand victory"
      elseif id=='uC74' then
        set s="stand work gold"
      endif
      if s!=""then
        call SetUnitAnimation(u,s)
        call QueueUnitAnimation(u,s)
      endif
    endif
  endif
  set u=null
  return false
endfunction

function AntiBackdoorHealing takes unit u, unit source, real dmg returns nothing
  local real mult=.25
  if Mode_AB then
    set mult=1
  endif
  call SetWidgetLife(u,GetWidgetLife(u)+mult*dmg)
endfunction

function IsCreep takes unit u returns boolean
  return (GetOwningPlayer(u)==Sentinels[0] or GetOwningPlayer(u)==Scourges[0]) and GetUnitTypeId(u)!='hFFD'
endfunction

function IsCreepFilter takes nothing returns boolean
  return (GetOwningPlayer(GetFilterUnit())==Sentinels[0] or GetOwningPlayer(GetFilterUnit())==Scourges[0]) and GetUnitTypeId(GetFilterUnit())!='hFFD'
endfunction

function TowerDamage takes unit target, unit attacker returns nothing
  local player p=GetOwningPlayer(attacker)
  if IsUnitEnemy(target,p) then
    call SaveReal(HeroStats,GetHandleId(p),'Tdmg',LoadReal(HeroStats,GetHandleId(p),'Tdmg')+GetEventDamage())
  endif
endfunction

function ABD takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer hu=GetHandleId(u)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetUnitAbilityLevel(u,'A17R')==0 then
      if LoadBoolean(MHT,hu,'isBD') and IsUnitEnemy(u,GetOwningPlayer(GetEventDamageSource())) then
        call AntiBackdoorHealing(u,GetEventDamageSource(),GetEventDamage())
      else
        call SaveReal(MHT,hu,'DMGR',LoadReal(MHT,hu,'DMGR')+GetEventDamage())
        call TowerDamage(u,GetEventDamageSource())
      endif
    else
      call HealUnitFor(u,GetEventDamage())
    endif
  else
    call FlushChildHashtable(MHT,hu)
    call GroupRemoveUnit(ABDGroup,u)
  endif
  set u=null
endfunction

function ABD_Check takes unit u returns nothing
  local integer hu
  local rect r
  local group g
  local unit u2=null
  local boolean b=false
  local player p=Sentinels[0]
  local integer i=0
  if IsDead(u) then
    return
  endif
  set hu=GetHandleId(u)
  set g=GetAvailableGroup()
  if GetOwningPlayer(u)==Sentinels[0] then
    set p=Scourges[0]
  endif
  loop
    set r=LoadRectHandle(MHT,hu,'ABDr'+i)
    call GroupEnumUnitsInRect(g,r,Condition(function IsCreepFilter))
    loop
      set u2=FirstOfGroup(g)
      exitwhen b or u2==null
      if GetOwningPlayer(u2)==p then
        set b=true
      else
        call GroupRemoveUnit(g,u2)
      endif
    endloop
    set i=i+1
    exitwhen b or HaveSavedHandle(MHT,hu,'ABDr'+i)==false
  endloop
  call SaveBoolean(MHT,hu,'isBD',b==false)
  call KillGroup(g)
  set u2=null
  set g=null
  set r=null
endfunction

function ABD_Timer takes nothing returns nothing
  local unit u
  local group g=GetAvailableGroup()
  call GroupAddGroup(ABDGroup,g)
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    call ABD_Check(u)
    call GroupRemoveUnit(g,u)
  endloop
  call KillGroup(g)
  set g=null
  set u=null
endfunction

function ABD_Heal takes nothing returns nothing
  local unit u=GetEnumUnit()
  local integer hu=GetHandleId(u)
  local real life
  local real life2
  if hu==0 or IsDead(u) or GetUnitState(u,UNIT_STATE_MAX_LIFE)==GetWidgetLife(u) then
    return
  endif
  set life=GetWidgetLife(u)
  set life2=GetUnitState(u,UNIT_STATE_MAX_LIFE)-LoadReal(MHT,hu,'DMGR')
  if life <= life2 then
    if life+AntiBDRegenRate <= life2 then
      call SetWidgetLife(u,life+AntiBDRegenRate)
    else
      call SetWidgetLife(u,life2)
    endif
  endif
  set u=null
endfunction

function ABD_HealTimer takes nothing returns nothing
  call ForGroup(ABDGroup,function ABD_Heal)
endfunction

function FixCameraHeight takes nothing returns nothing
  if HaveSavedReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD') and GetCameraField(CAMERA_FIELD_TARGET_DISTANCE)!=LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD') and LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD')!=1650 then
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_TARGET_DISTANCE,LoadReal(HeroStats,GetHandleId(GetLocalPlayer()),'CAMD'),0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_FARZ,100000,0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ZOFFSET,0,0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ROTATION,90,0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ANGLE_OF_ATTACK,304,0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_ROLL,0,0)
    call SetCameraFieldForPlayer(GetLocalPlayer(),CAMERA_FIELD_FIELD_OF_VIEW,70,0)
  endif
endfunction

function SaveBaseRects takes unit u returns nothing
  local integer hu=GetHandleId(u)
  call GroupAddUnit(ABDGroup,u)
  if GetOwningPlayer(u)==Sentinels[0] then
    call SaveRectHandle(MHT,hu,'ABDr'+0,Rect(-8160.,-8192.,-3712.,-4352.))
    call SaveRectHandle(MHT,hu,'ABDr'+1,Rect(-8192.,-4960.,-4640.,-3552.))
    call SaveRectHandle(MHT,hu,'ABDr'+2,Rect(-4000.,-7744.,-3072.,-5152.))
    call SaveRectHandle(MHT,hu,'ABDr'+3,Rect(-3328.,-7200.,-2464.,-6368.))
    call SaveRectHandle(MHT,hu,'ABDr'+4,Rect(-4288.,-4544.,-3424.,-3712.))
    call SaveRectHandle(MHT,hu,'ABDr'+5,Rect(-6784.,-3616.,-5920.,-2784.))
  else
    call SaveRectHandle(MHT,hu,'ABDr'+0,Rect(2304.,4064.,8032.,7776.))
    call SaveRectHandle(MHT,hu,'ABDr'+1,Rect(4640.,1952.,8000.,4384.))
    call SaveRectHandle(MHT,hu,'ABDr'+2,Rect(3136.,2816.,5216.,4960.))
    call SaveRectHandle(MHT,hu,'ABDr'+3,Rect(5984.,1152.,6848.,1984.))
    call SaveRectHandle(MHT,hu,'ABDr'+4,Rect(1472.,5440.,2336.,6272.))
    call SaveRectHandle(MHT,hu,'ABDr'+5,Rect(2656.,2336.,3520.,3168.))
  endif
endfunction

function RSD takes nothing returns boolean
  call CleanTrigger(GetTriggeringTrigger())
  call TriggerEvaluate(NG)
  return false
endfunction

function RTD takes nothing returns boolean
  local real r=TimerGetRemaining(NK)
  local real Y59=r
  local integer YO8=R2I(Y59)
  local integer Minutes=YO8/60 - 1/2
  local integer Seconds=ModuloInteger(YO8,60)
  local trigger t
  local integer i
  local integer pid
  if r==0 then
    if b_isPickTime then
      set b_isPickTime=false
      call RemoveUnit(AddTime1)
      call RemoveUnit(AddTime2)
      call RemoveUnit(AddTime3)
      call RemoveUnit(AddTime4)
      call RemoveUnit(AltarOfRandom)
      call ExeFunc("RUD")
      return false
    endif
    set YL7=true
    call Traffic_RegisterData("GameStart",1)
    set i=1
    call ThrowLog()
    loop
      if IsPlayer(Player(i)) then
        set pid=GetPlayerId(Player(i))
        call Traffic_RegisterData("SP1_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
        call Traffic_RegisterData("SP2_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
        call Traffic_RegisterData("SP3_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
        call Traffic_RegisterData("SP4_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
        if NumberOfExtraAbilities>=1 then
          call Traffic_RegisterData("SP5_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+5]])
        endif
        if NumberOfExtraAbilities>=2 then
          call Traffic_RegisterData("SP6_"+I2S(i),SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+6]])
        endif
      endif
      set i=i+1
      if i==6 then//skip scourge
        set i=7
      endif
      exitwhen i>11
    endloop
    call SetTime(Minutes,Seconds,true)
    set IsGameStartedAnotherBool=true
    set GameStartsTime=TimerGetElapsed(GlobalTimer)
    call CleanTrigger(GetTriggeringTrigger())
    call SetFloatGameState(GAME_STATE_TIME_OF_DAY,6.)
    call SuspendTimeOfDay(false)
    if Mode_NP==false then
      call TriggerRegisterTimerEvent(RuneSpawnTrigger,120,true)
      call TriggerEvaluate(RuneSpawnTrigger)
    endif
    call TriggerRegisterTimerEvent(NG,60,true)
    if not Mode_FN then
      set t=CreateTrigger()
      call TriggerRegisterTimerEvent(t,30,false)
      call TriggerAddCondition(t,Condition(function RSD))
      set t=null
    endif
    call TriggerRegisterTimerEvent(AG,30,true)
    call TriggerExecute(AG)
    call TriggerRegisterTimerEvent(LG,450,true)
    call TriggerRegisterTimerEvent(IG,2699,false)
    call TriggerRegisterTimerEvent(OG,999,false)
    call TriggerRegisterTimerEvent(OG,1999,false)
    call TriggerRegisterTimerEvent(OG,2999,false)
    call TriggerRegisterTimerEvent(M87,300,true)
    call TriggerRegisterTimerEvent(ZI7,300,true)
    call TriggerRegisterTimerEvent(PN,30,true)
    call TriggerEvaluate(PN)
    if Mode_SC then
      call TriggerRegisterTimerEvent(SG,600,true)
    endif
  elseif r==7 and not b_isPickTime then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,30,true)
    call TriggerAddCondition(t,Condition(function MKD))
  elseif Y59<12 and PK==false and not b_isPickTime then
    set PK=true
    call PlaySoundBJ(QD)
    call SetTime(Minutes,Seconds,true)
  elseif Y59==20 then
    
  elseif Y59==15 and b_isPickTime and (CanAddTime[0]>0 or CanAddTime[1]>0) then
    if not b_isPlayerReady[GetPlayerId(GetLocalPlayer())] then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|c006699CC"+"If you need more time to pick your skills, enter -addtime"+"|r")
    endif
  else
    call SetTime(Minutes,Seconds,true)
  endif
  return false
endfunction

function RWD takes nothing returns boolean
  if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetAttacker()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetAttacker()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false and GetOwningPlayer(GetFilterUnit())!=Neutrals then
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
      set Y17=GetFilterUnit()
    else
      set Y07=GetFilterUnit()
    endif
  endif
  return false
endfunction

function RXD takes nothing returns nothing
  local unit MQD=GetAttacker()
  local unit Target=GetTriggerUnit()
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(MQD),GetUnitY(MQD),900,Condition(function RWD))
  call KillGroup(g)
  call DisableTrigger(GetTriggeringTrigger())
  if Y17!=null then
    call IssueTargetOrderById(MQD,851983,Y17)
    call GroupAddUnit(Y57,MQD)
  elseif IsUnitType(Target,UNIT_TYPE_HERO) and Y07!=null then
    call IssueTargetOrderById(MQD,851983,Y07)
    call GroupAddUnit(Y57,MQD)
  endif
  call EnableTrigger(GetTriggeringTrigger())
  set Y17=null
  set Y07=null
  set MQD=null
  set Target=null
  set g=null
endfunction

function RYD takes nothing returns nothing
  if GetWidgetLife(GetEnumUnit())<1 then
    call GroupRemoveUnit(Y57,GetEnumUnit())
  endif
  if GetUnitCurrentOrder(GetEnumUnit())!=851983then
    call GroupRemoveUnit(Y57,GetEnumUnit())
    call IssuePointOrderByIdLoc(GetEnumUnit(),851983,WaypointLocations[GetUnitAbilityLevel(GetEnumUnit(),WaypointAbilID)])
  endif
endfunction

function RZD takes nothing returns boolean
  call ForGroup(Y57,function RYD)
  return false
endfunction

function RAD takes string s returns nothing
  set Z77=Z77+1
  set Z87[Z77]=s
endfunction

function RBD takes nothing returns boolean
  local integer i=1
  loop
    exitwhen i>Z77
    call ExeFunc(Z87[i])
    set i=i+1
  endloop
  call ExeFunc("V59")
  call ExeFunc("D7D")
  return false
endfunction

function RCD takes unit Hero returns nothing
  local trigger t=CreateTrigger()
  call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),(38),(true))
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function RBD))
  set t=null
endfunction

function R3D takes nothing returns boolean
  if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) and GetUnitTypeId(GetTriggerUnit())!='H0B8' and GetUnitTypeId(GetTriggerUnit())!='H00M' and GetUnitTypeId(GetTriggerUnit())!='H07G' and GetUnitTypeId(GetTriggerUnit())!='H00Y' and IsUnitIllusion(GetTriggerUnit())==false and HaveSavedBoolean(HY,GetHandleId(GetTriggerUnit()),38)==false then
    if (GetUnitTypeId(GetTriggerUnit())!='O00P')then
      call RCD(GetTriggerUnit())
    endif
  endif
  return false
endfunction

function S7D takes nothing returns nothing
  if IsCourier(GetEnumUnit())and IsUnitAlly(GetEnumUnit(),Sentinels[0])==false and GetWidgetLife(GetEnumUnit())>.5 then
    call UnitRemoveAbility(GetEnumUnit(),'B08H')
    call DamageTarget(SentFountain,GetEnumUnit(),2,500)
  endif
endfunction

function S8D takes nothing returns nothing
  if IsCourier(GetEnumUnit())and IsUnitAlly(GetEnumUnit(),Scourges[0])==false and GetWidgetLife(GetEnumUnit())>.5 then
    call UnitRemoveAbility(GetEnumUnit(),'B08H')
    call DamageTarget(ScourgeFountain,GetEnumUnit(),2,500)
  endif
endfunction

function CourierFountainCheck takes nothing returns boolean
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,H5,Condition(function ReturnTrue))
  call ForGroup(g,function S7D)
  call GroupClear(g)
  call GroupEnumUnitsInRect(g,Z5,Condition(function ReturnTrue))
  call ForGroup(g,function S8D)
  call KillGroup(g)
  set g=null
  return false
endfunction

function DumpLogs takes nothing returns nothing
  local integer i=LoadInteger(UTable,-1,0)
  local integer k=0
  call PreloadEndEx()
  call PreloadGenClear()
  call PreloadGenStart()
  loop
    if HaveSavedString(UTable,-1,k)then
      call Preload(LoadStr(UTable,-1,k))
    endif
    set k=k+1
    exitwhen k>i
  endloop
  call PreloadGenEnd("FogClicks.txt")
  call PreloadGenClear()
  
endfunction

function SDD takes string winner returns nothing
  local integer i
  local player p
  local string id
  local integer YO8=R2I(TimerGetElapsed(GlobalTimer)-GameStartsTime)
  local integer Minutes=YO8/ 60-1/ 2
  local integer Seconds=ModuloInteger(YO8,60)
  local integer pid
  if winner=="1" then
    //31 = Slots 0-5
    call Traffic_RegisterCustomGlobalData("w","0",31)
  else
    //992 = Slots 6-10
    call Traffic_RegisterCustomGlobalData("w","0",992)
  endif
  call W18()
  if Mode_AH then
    call DumpLogs()
  endif
  set i=1
  loop
    exitwhen i>5
    set p=Sentinels[i]
    set id=I2S(GetPlayerId(p))
    set pid=GetPlayerId(p)
    call StoreInteger(GCM,id,"1",Kills[pid])
    call StoreInteger(GCM,id,"2",Deaths[pid])
    call StoreInteger(GCM,id,"3",PlayerCS[pid])
    call StoreInteger(GCM,id,"4",CSDenies[pid])
    call StoreInteger(GCM,id,"5",Assists[pid])
    call StoreInteger(GCM,id,"6",GetPlayerState((p),PLAYER_STATE_RESOURCE_GOLD))
    call StoreInteger(GCM,id,"7",LoadInteger(HY,400+pid,79))
    call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
    call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
    call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
    call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
    call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
    call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
    call StoreInteger(GCM,id,"9",HeroTypeId[pid])
    call StoreInteger(GCM,id,"id",i)
    set p=Scourges[i]
    set pid=GetPlayerId(p)
    set id=I2S(pid)
    call StoreInteger(GCM,id,"1",Kills[pid])
    call StoreInteger(GCM,id,"2",Deaths[pid])
    call StoreInteger(GCM,id,"3",PlayerCS[pid])
    call StoreInteger(GCM,id,"4",CSDenies[pid])
    call StoreInteger(GCM,id,"5",Assists[pid])
    call StoreInteger(GCM,id,"6",GetPlayerState((p),PLAYER_STATE_RESOURCE_GOLD))
    call StoreInteger(GCM,id,"7",LoadInteger(HY,400+pid,79))
    call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
    call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
    call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
    call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
    call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
    call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
    call StoreInteger(GCM,id,"9",HeroTypeId[pid])
    call StoreInteger(GCM,id,"id",i+5)
    if GetLocalPlayer()==PlayerModeTyper then
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"1")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"2")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"3")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"4")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"5")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"6")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"7")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_0")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_1")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_2")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_3")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_4")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"8_5")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"9")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"id")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"1")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"2")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"3")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"4")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"5")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"6")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"7")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_0")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_1")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_2")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_3")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_4")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"8_5")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"9")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"id")
    endif
    set i=i+1
  endloop
  call StoreInteger(GCM,"Global","Winner",ZD7)
  call StoreInteger(GCM,"Global","m",Minutes)
  call StoreInteger(GCM,"Global","s",Seconds)
  if GetLocalPlayer()==PlayerModeTyper then
    call SyncStoredInteger(GCM,"Global","Winner")
    call SyncStoredInteger(GCM,"Global","m")
    call SyncStoredInteger(GCM,"Global","s")
  endif
  set p=null
endfunction

function I09 takes nothing returns nothing
  call SDD("1")
endfunction

function I19 takes nothing returns nothing
  local player p=ZE7
  local integer pid=GetPlayerId(p)
  local string id=I2S(pid)
  call StoreInteger(GCM,id,"8_0",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],0)))
  call StoreInteger(GCM,id,"8_1",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],1)))
  call StoreInteger(GCM,id,"8_2",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],2)))
  call StoreInteger(GCM,id,"8_3",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],3)))
  call StoreInteger(GCM,id,"8_4",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],4)))
  call StoreInteger(GCM,id,"8_5",GetItemTypeId(UnitItemInSlot(udg_Hero[pid],5)))
  if GetLocalPlayer()==PlayerModeTyper then
    call SyncStoredInteger(GCM,id,"8_0")
    call SyncStoredInteger(GCM,id,"8_1")
    call SyncStoredInteger(GCM,id,"8_2")
    call SyncStoredInteger(GCM,id,"8_3")
    call SyncStoredInteger(GCM,id,"8_4")
    call SyncStoredInteger(GCM,id,"8_5")
  endif
  set p=null
endfunction

function SED takes nothing returns boolean
  call ExeFunc("DisplayFinalMB")
  return false
endfunction

function SFD takes nothing returns nothing
  call V78(GetEnumUnit())
endfunction

function SGD takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,12000,Condition(function LR8))
  call ForGroup(g,function SFD)
  call KillGroup(g)
  set g=null
endfunction

function SHD takes nothing returns nothing
  local integer i=1
  local player p
  set bj_changeLevelShowScores=true
  call DisableTrigger(YK)
  call DisableTrigger(JK)
  call ExeFunc("L99")
  if udg_ObserverMode then
    call DisableTrigger(X37)
  endif
  call DisableTrigger(TriggerUpdateGameTime)
  call ClearTextMessages()
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,60,K3+" "+GetObjectName('n054')+" www.legendsofdota.com.")
  set GameEnded=true
  call AD8()
  call DisableTrigger(AG)
  call DisableTrigger(QG)
  call DisableTrigger(TriggerGoldPerSecond)
  call RMD_SendStats()
  call GroupsClose()
endfunction

function SID takes nothing returns nothing
  local trigger t=CreateTrigger()
  call PanCameraToTimed(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
  call TriggerRegisterTimerEvent(t,2.5,false)
  call TriggerAddCondition(t,Condition(function SED))
  set ZD7=2
  set K3="|c0020c000"+GetObjectName('n03O')+"|r"
  call SHD()
  call SGD()
  call SDD("2")
  set t=null
endfunction

function SJD takes nothing returns boolean
  call SetUnitVertexColorBJ(FrozenThrone,100,100,100,GetTriggerEvalCount(GetTriggeringTrigger()))
  if GetTriggerEvalCount(GetTriggeringTrigger())==100 then
    call ShowUnit(FrozenThrone,false)
    call CleanTrigger(GetTriggeringTrigger())
  endif
  return false
endfunction

function SKD takes nothing returns nothing
  local trigger t=CreateTrigger()
  call PanCameraToTimed(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
  call TriggerRegisterTimerEvent(t,1.5,false)
  call TriggerAddCondition(t,Condition(function SED))
  set ZD7=1
  set K3="|c00ff0303"+GetObjectName('n03N')+"|r"
  call SHD()
  call SGD()
  call SDD("1")
  call AddSpecialEffect("war3mapImported\\FrozenThronesDeath2.mdx",GetUnitX(FrozenThrone)+150,GetUnitY(FrozenThrone)+100)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function SJD))
  set t=null
endfunction

function SMD takes real Y08 returns boolean
  return(100*GetWidgetLife(GetTriggerUnit())/ GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE))<Y08
endfunction

function IsUnitUnderDenySpell takes unit u returns boolean
  return GetUnitAbilityLevel(u,'BNdo')>0 or GetUnitAbilityLevel(u,'BEsh')>0 or GetUnitAbilityLevel(u,'B001')>0 or GetUnitAbilityLevel(u,'B0AQ')>0 or GetUnitAbilityLevel(u,'B0AP')>0
endfunction

function SOD takes nothing returns nothing
  if not((SMD(10)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) and GetUnitTypeId(GetTriggerUnit())!='etol' and GetUnitTypeId(GetTriggerUnit())!='unpl')or(SMD(25)and IsUnitUnderDenySpell(GetTriggerUnit()))or(SMD(50)and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false and(IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false or IsSiegeUnit(GetTriggerUnit())))or(GetUnitTypeId(GetTriggerUnit())=='u00S' or GetUnitTypeId(GetTriggerUnit())=='o01V') or (LoadInteger(HY,GetHandleId(GetAttacker()),4328)==1)==true) then
    call IssueImmediateOrderById(GetAttacker(),851972)
  endif
endfunction

function SPD takes nothing returns boolean
  local boolean b
  if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetAttacker()))then
    call SOD()
  elseif IsUnitType(GetAttacker(),UNIT_TYPE_HERO) or IsSpiritBear(GetAttacker())then
    set b=IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(GetAttacker())==false
    set ZF7=GetPlayerId(GetOwningPlayer(GetAttacker()))
    if HasItem_Javelin[ZF7]>0 and b and GetUnitTypeId(GetTriggerUnit())!='n00L'and EM9(GetAttacker(),Item_Real[indexid_javelin]) then
      call DND()
    endif
    if HasItem_CraniumBasher[ZF7]>0 and b and(EM9(GetAttacker(),Item_Real[indexid_CraniumBasher]) or EM9(GetAttacker(),Item_Real[indexid_AbyssalBlade]))then
      call DZD()
    endif
    if HasItem_SangeNYasha[ZF7]>0 and b and EM9(GetAttacker(),Item_Real[indexid_SangeAndYasha]) then
      call DUD()
    elseif(HasItem_Sange[ZF7]>0 or HasItem_HeavensHalberd[ZF7]>0) and b and(EM9(GetAttacker(),Item_Real[indexid_Sange]) or EM9(GetAttacker(),Item_Real[indexid_HeavensHalberd]))then
      call DYD()
    endif
  elseif GetUnitAbilityLevel(GetAttacker(),'A17S')>0 and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
    call RXD()
  endif
  return false
endfunction

function SRD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT or LoadBoolean(HY,GetHandleId(Hero),140) then
    if LoadBoolean(HY,GetHandleId(Hero),140) then
      call SaveBoolean(HY,GetHandleId(Hero),140,false)
      call SaveInteger(HY,GetHandleId(Hero),4259,2)
      call UnitRemoveAbility(Hero,'A04R')
      call UnitRemoveAbility(Hero,'Avul')
      call PauseUnit(Hero,false)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    elseif GetSpellTargetUnit()==Hero and GetSpellAbilityId()==ZH7 and(GetPlayerSlotState(GetOwningPlayer(Hero))==PLAYER_SLOT_STATE_LEFT)and LoadInteger(HY,GetHandleId(Hero),4259)==1 then
      call SaveInteger(HY,GetHandleId(Hero),4259,2)
      call UnitRemoveAbility(Hero,'A04R')
      call UnitRemoveAbility(Hero,'Avul')
      call PauseUnit(Hero,false)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif IsDead(Hero)==false then
    call SetUnitX(Hero,x)
    call SetUnitY(Hero,y)
    call SaveInteger(HY,GetHandleId(Hero),4259,1)
    call UnitAddAbility(Hero,'A04R')
    call UnitAddAbility2(Hero,'Avul')
    call PauseUnit(Hero,true)
  endif
  set Hero=null
  set t=null
  return false
endfunction

function SSD takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetSpellTargetUnit()
  call SaveBoolean(HY,GetHandleId(Hero),140,false)
  call SaveInteger(HY,GetHandleId(Hero),4259,1)
  call UnitAddAbility(Hero,'A04R')
  call UnitAddAbility2(Hero,'Avul')
  call PauseUnit(Hero,true)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveReal(HY,h,6,GetUnitX(Hero)*1.)
  call SaveReal(HY,h,7,GetUnitY(Hero)*1.)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function SRD))
  set t=null
  set Hero=null
endfunction

function STD takes nothing returns boolean
  if GetSpellAbilityId()==ZG7 and GetPlayerSlotState(GetOwningPlayer(GetSpellTargetUnit()))==PLAYER_SLOT_STATE_LEFT and LoadInteger(HY,GetHandleId(GetSpellTargetUnit()),4259)!=1 then
    call SSD()
  elseif (GetSpellAbilityId()==ZH7 or GetSpellAbilityId()==ZG7) and GetPlayerSlotState(GetOwningPlayer(GetSpellTargetUnit()))!=PLAYER_SLOT_STATE_LEFT then
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n02N'))
  endif
  if IsPurge(GetSpellAbilityId()) then
    call ExeFunc("OnPurge")
  endif
  return false
endfunction

function SUD takes destructable d returns boolean
  local real x=GetDestructableX(d)
  local real y=GetDestructableY(d)
  local group g=GetAvailableGroup()
  local boolean SVD
  call GroupEnumUnitsInRange(g,x,y,250,Condition(function DI9))
  set SVD=FirstOfGroup(g)!=null
  call KillGroup(g)
  set g=null
  return SVD
endfunction

function SWD takes nothing returns nothing
  if IsValidTree(GetEnumDestructable())and GetDestructableLife(GetEnumDestructable())<1 and GetDestructableTypeId(GetEnumDestructable())!='B002' and GetDestructableTypeId(GetEnumDestructable())!='B003' then
    if SUD(GetEnumDestructable())==false then
      call DestructableRestoreLife(GetEnumDestructable(),GetDestructableMaxLife(GetEnumDestructable()),false)
      call SetDestructableAnimation(GetEnumDestructable(),"birth")
      if SL[GetPlayerId(GetLocalPlayer())]==1 and GetDestructableTypeId(GetEnumDestructable())=='ATtr' then
        call SetDestructableAnimation(GetEnumDestructable(),"stand alternate")
      endif
    endif
  endif
endfunction

function SXD takes nothing returns nothing
  call EnumDestructablesInRectAll(bj_mapInitialPlayableArea,function SWD)
endfunction

function Roshan_IllusionKiller takes nothing returns boolean
  if GetUnitTypeId(GetTriggerUnit())=='n00L' then
    if IsUnitIllusion(GetAttacker()) then
      call KillUnit(GetAttacker())
    elseif IsUnitInRegion(ZJ7,GetAttacker())==false then
      call Error(GetOwningPlayer(GetAttacker()),GetObjectName('n035'))
      call IssueImmediateOrderById(GetAttacker(),851972)
    endif
  endif
  return false
endfunction

function SZD takes nothing returns boolean
  return GetUnitTypeId(GetEnteringUnit())=='e00E' or GetUnitTypeId(GetEnteringUnit())=='e022'
endfunction

function DummyUtilize takes nothing returns nothing
  call ShowUnitHide(GetEnteringUnit())
  call SetUnitPathing(GetEnteringUnit(),false)
  call SetUnitInvulnerable(GetEnteringUnit(),true)
  call UnitApplyTimedLifeBJ(20.,'BTLF',GetEnteringUnit())
endfunction

function SBD takes nothing returns boolean
  return(GetUnitTypeId(GetDyingUnit())=='e00R')or(GetUnitTypeId(GetDyingUnit())=='e011')or(GetUnitTypeId(GetDyingUnit())=='e00S')or(GetUnitTypeId(GetDyingUnit())=='e019')
endfunction

function RefreshCircles takes integer id returns nothing
  if id==0 then
    call UnitResetCooldown(CirclesOfPower_1)
    call UnitResetCooldown(CirclesOfPower_2)
    call UnitResetCooldown(CirclesOfPower_3)
    call UnitResetCooldown(CirclesOfPower_4)
    call UnitResetCooldown(CirclesOfPower_5)
  else
    call UnitResetCooldown(CirclesOfPower_7)
    call UnitResetCooldown(CirclesOfPower_8)
    call UnitResetCooldown(CirclesOfPower_9)
    call UnitResetCooldown(CirclesOfPower_10)
    call UnitResetCooldown(CirclesOfPower_11)
  endif
endfunction

function TowerKillWrap takes unit tower, unit killer returns nothing
  local player p=GetOwningPlayer(killer)
  local integer pid=GetPlayerId(p)
  if IsUnitAlly(tower,p)then
    set PlayerTowersDenied[pid]=PlayerTowersDenied[pid]+1
    call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+PlayerNames[pid]+"|r "+GetObjectName('n04P')+".")
  else
    set PlayerTowersKilled[pid]=PlayerTowersKilled[pid]+1
    call DisplayTimedTextToForceEx(AllPlayers,TxtDur[GetPlayerId(GetLocalPlayer())],udg_Colors[pid]+PlayerNames[pid]+"|r "+GetObjectName('n0EN')+".")
  endif
endfunction

function S6D takes nothing returns nothing
  local unit u=GetDyingUnit()
  local unit killer=GetKillingUnit()
  local player pk=GetOwningPlayer(killer)
  local integer pid=GetPlayerId(pk)
  call TowerKillWrap(u,killer)
  if u==Towers_Sent_Top_1 or u==Towers_Sent_Mid_1 or u==Towers_Sent_Bot_1 then
    call TowerKill(killer,1)
    if IsUnitAlly(u,pk)==false then
      call RefreshCircles(0)
    endif
    if u==Towers_Sent_Top_1 then
      call Traffic_RegisterData("Tower010",pid)
      call UnitRemoveAbility(Towers_Sent_Top_2,'Avul')
    elseif u==Towers_Sent_Mid_1 then
      call Traffic_RegisterData("Tower011",pid)
      call UnitRemoveAbility(Towers_Sent_Mid_2,'Avul')
    else
      call Traffic_RegisterData("Tower012",pid)
      call UnitRemoveAbility(Towers_Sent_Bot_2,'Avul')
    endif
  elseif u==Towers_Sent_Top_2 or u==Towers_Sent_Mid_2 or u==Towers_Sent_Bot_2 then
    call TowerKill(killer,2)
    if u==Towers_Sent_Top_2 then
      call Traffic_RegisterData("Tower020",pid)
      call UnitRemoveAbility(Towers_Sent_Top_3,'Avul')
    elseif u==Towers_Sent_Mid_2 then
      call Traffic_RegisterData("Tower021",pid)
      call UnitRemoveAbility(Towers_Sent_Mid_3,'Avul')
    else
      call Traffic_RegisterData("Tower022",pid)
      call UnitRemoveAbility(Towers_Sent_Bot_3,'Avul')
    endif
  elseif u==Towers_Sent_Top_3 or u==Towers_Sent_Mid_3 or u==Towers_Sent_Bot_3 then
    call TowerKill(killer,3)
    call UnitRemoveAbility(Towers_Sent_Tree1,'Avul')
    call UnitRemoveAbility(Towers_Sent_Tree2,'Avul')
    call UnitRemoveAbility(EW7,'Avul')
    call UnitRemoveAbility(EX7,'Avul')
    call UnitRemoveAbility(EY7,'Avul')
    call UnitRemoveAbility(EZ7,'Avul')
    call UnitRemoveAbility(EK7,'Avul')
    call UnitRemoveAbility(EM7,'Avul')
    call UnitRemoveAbility(EN7,'Avul')
    call UnitRemoveAbility(EO7,'Avul')
    call UnitRemoveAbility(EP7,'Avul')
    call UnitRemoveAbility(EQ7,'Avul')
    call UnitRemoveAbility(ER7,'Avul')
    call UnitRemoveAbility(ES7,'Avul')
    call UnitRemoveAbility(ET7,'Avul')
    call UnitRemoveAbility(EU7,'Avul')
    call UnitRemoveAbility(EV7,'Avul')
    if u==Towers_Sent_Top_3 then
      call Traffic_RegisterData("Tower030",pid)
      call UnitRemoveAbility(Elf_Rax_Melee_Top,'Avul')
      call UnitRemoveAbility(Elf_Rax_Range_Top,'Avul')
    elseif u==Towers_Sent_Mid_3 then
      call Traffic_RegisterData("Tower031",pid)
      call UnitRemoveAbility(Elf_Rax_Melee_Mid,'Avul')
      call UnitRemoveAbility(Elf_Rax_Range_Mid,'Avul')
    else
      call Traffic_RegisterData("Tower032",pid)
      call UnitRemoveAbility(Elf_Rax_Melee_Bot,'Avul')
      call UnitRemoveAbility(Elf_Rax_Range_Bot,'Avul')
    endif
  elseif u==Towers_Sent_Tree1 or u==Towers_Sent_Tree2 then
    call Traffic_RegisterData("Tower041",pid)
    call TowerKill(killer,4)
    if (u==Towers_Sent_Tree1 and IsDead(Towers_Sent_Tree2)) or (u==Towers_Sent_Tree2 and IsDead(Towers_Sent_Tree1)) then
      call UnitRemoveAbility(TreeOfLife,'Avul')
    endif
  endif
  set u=null
  set killer=null
endfunction

function SLD takes nothing returns boolean
  return(GetUnitTypeId(GetDyingUnit())=='u00M')or(GetUnitTypeId(GetDyingUnit())=='u00D')or(GetUnitTypeId(GetDyingUnit())=='u00N')or(GetUnitTypeId(GetDyingUnit())=='u00T')
endfunction

function S5D takes nothing returns nothing
  local unit u=GetDyingUnit()
  local unit killer=GetKillingUnit()
  local player pk=GetOwningPlayer(killer)
  local integer pid=GetPlayerId(pk)
  call TowerKillWrap(u,killer)
  if u==Towers_Scourge_Top_1 or u==Towers_Scourge_Mid_1 or u==Towers_Scourge_Bot_1 then
    call TowerKill(killer,1)
    if IsUnitAlly(u,pk)==false then
      call RefreshCircles(1)
    endif
    if u==Towers_Scourge_Top_1 then
      call Traffic_RegisterData("Tower110",pid)
      call UnitRemoveAbility(Towers_Scourge_Top_2,'Avul')
    elseif u==Towers_Scourge_Mid_1 then
      call Traffic_RegisterData("Tower111",pid)
      call UnitRemoveAbility(Towers_Scourge_Mid_2,'Avul')
    else
      call Traffic_RegisterData("Tower112",pid)
      call UnitRemoveAbility(Towers_Scourge_Bot_2,'Avul')
    endif
  elseif u==Towers_Scourge_Top_2 or u==Towers_Scourge_Mid_2 or u==Towers_Scourge_Bot_2 then
    call TowerKill(killer,2)
    if u==Towers_Scourge_Top_2 then
      call Traffic_RegisterData("Tower120",pid)
      call UnitRemoveAbility(Towers_Scourge_Top_3,'Avul')
    elseif u==Towers_Scourge_Mid_2 then
      call Traffic_RegisterData("Tower121",pid)
      call UnitRemoveAbility(Towers_Scourge_Mid_3,'Avul')
    else
      call Traffic_RegisterData("Tower122",pid)
      call UnitRemoveAbility(Towers_Scourge_Bot_3,'Avul')
    endif
  elseif u==Towers_Scourge_Top_3 or u==Towers_Scourge_Mid_3 or u==Towers_Scourge_Bot_3 then
    call TowerKill(killer,3)
    call UnitRemoveAbility(Towers_Scourge_Throne1,'Avul')
    call UnitRemoveAbility(Towers_Scourge_Throne2,'Avul')
    call UnitRemoveAbility(IM7,'Avul')
    call UnitRemoveAbility(IN7,'Avul')
    call UnitRemoveAbility(IO7,'Avul')
    call UnitRemoveAbility(IP7,'Avul')
    call UnitRemoveAbility(I77,'Avul')
    call UnitRemoveAbility(I87,'Avul')
    call UnitRemoveAbility(I97,'Avul')
    call UnitRemoveAbility(ID7,'Avul')
    call UnitRemoveAbility(IE7,'Avul')
    call UnitRemoveAbility(IF7,'Avul')
    call UnitRemoveAbility(IG7,'Avul')
    call UnitRemoveAbility(IH7,'Avul')
    call UnitRemoveAbility(II7,'Avul')
    call UnitRemoveAbility(IJ7,'Avul')
    call UnitRemoveAbility(IK7,'Avul')
    if u==Towers_Scourge_Top_3 then
      call Traffic_RegisterData("Tower130",pid)
      call UnitRemoveAbility(Und_Rax_Melee_Top,'Avul')
      call UnitRemoveAbility(Und_Rax_Range_Top,'Avul')
    elseif u==Towers_Scourge_Mid_3 then
      call Traffic_RegisterData("Tower131",pid)
      call UnitRemoveAbility(Und_Rax_Melee_Mid,'Avul')
      call UnitRemoveAbility(Und_Rax_Range_Mid,'Avul')
    else
      call Traffic_RegisterData("Tower132",pid)
      call UnitRemoveAbility(Und_Rax_Melee_Bot,'Avul')
      call UnitRemoveAbility(Und_Rax_Range_Bot,'Avul')
    endif
  elseif u==Towers_Scourge_Throne1 or u==Towers_Scourge_Throne2 then
    call Traffic_RegisterData("Tower141",pid)
    call TowerKill(killer,4)
    if (u==Towers_Scourge_Throne1 and IsDead(Towers_Scourge_Throne2)) or (u==Towers_Scourge_Throne2 and IsDead(Towers_Scourge_Throne1)) then
      call UnitRemoveAbility(FrozenThrone,'Avul')
    endif
  endif
  set u=null
  set killer=null
endfunction

function S2D takes nothing returns boolean
  local integer x=0
  if GetPlayerSlotState(Sentinels[1])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Sentinels[2])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Sentinels[3])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Sentinels[4])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Sentinels[5])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Scourges[1])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Scourges[2])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Scourges[3])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Scourges[4])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  if GetPlayerSlotState(Scourges[5])==PLAYER_SLOT_STATE_EMPTY then
    set x=x+1
  endif
  return x==9
endfunction

function Testmode_Spawnon takes nothing returns nothing
  set CreepSpawnDisabled=false
endfunction

function Testmode_Roshan takes nothing returns nothing
  set ZM7=true
endfunction

function Testmode_Spawnoff takes nothing returns nothing
  set CreepSpawnDisabled=true
endfunction

function Testmode_NHL takes nothing returns nothing
  set NoHeroLimitOff=false
endfunction

function TDD takes nothing returns boolean
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false then
    call KillUnit(GetFilterUnit())
  endif
  return false
endfunction

function Testmode_KillScrg takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function TDD))
  call KillGroup(g)
  set g=null
endfunction

function Testmode_KillSent takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function TDD))
  call KillGroup(g)
  set g=null
endfunction

function TGD takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='o004' or GetUnitTypeId(GetFilterUnit())=='oeye' then
    call KillUnit(GetFilterUnit())
  endif
  return false
endfunction

function Testmode_KillWards takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,9999,Condition(function TGD))
  call KillGroup(g)
  set g=null
endfunction

function Testmode_KillAll takes nothing returns nothing
  call Testmode_KillSent()
  call Testmode_KillScrg()
endfunction

function TJD takes nothing returns boolean
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
    call SmoothLvlup(GetFilterUnit(),IMaxIF(tt_int1,1),true,0)
  endif
  return false
endfunction

function Testmode_Lvlup takes nothing returns nothing
  local string TMD=SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString()))
  local integer Level=S2I(TMD)
  local group g=GetAvailableGroup()
  if Level<1 then
    set Level=1
  endif
  set tt_int1=Level
  call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function TJD))
  call KillGroup(g)
  set g=null
endfunction

function Testmode_Spawncreeps takes nothing returns nothing
  call TriggerExecute(AG)
endfunction

function TOD takes nothing returns boolean
  local unit u = GetFilterUnit()
  if IsUnitType(u,UNIT_TYPE_HERO) then
    call UnitResetCooldown(u)
    call TimerStart(PrimUltiTimer[GetPlayerId((GetOwningPlayer(u)))],0,false,null)
    call TimerStart(SecUltiTimer[GetPlayerId((GetOwningPlayer(u)))],0,false,null)
    call SetWidgetLife(u,GetUnitState(u,UNIT_STATE_MAX_LIFE))
    call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MAX_MANA))
  endif
  set u = null
  return false
endfunction

function Testmode_Refresh takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function TOD))
  call KillGroup(g)
  set g=null
endfunction

function Testmode_Kill takes nothing returns nothing
  call KillUnit(udg_Hero[GetPlayerId(GetTriggerPlayer())])
endfunction

function Testmode_Time takes nothing returns nothing
  local string TSD=SubString(GetEventPlayerChatString(),5,StringLength(GetEventPlayerChatString()))
  local integer Time=S2I(TSD)
  if Time<0 or Time>24 then
    set Time=0
  endif
  call SetFloatGameState(GAME_STATE_TIME_OF_DAY,Time)
endfunction

function Testmode_Gold takes nothing returns nothing
  local string TUD=SubString(GetEventPlayerChatString(),5,StringLength(GetEventPlayerChatString()))
  local integer W98=S2I(TUD)
  call SetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)+W98)
endfunction

function Testmode_Respawn takes nothing returns nothing
  local unit CE8=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  local player WU9=GetTriggerPlayer()
  local location WQ9
  if IsScourge(WU9)then
    set WQ9=GetRectCenter(gg_rct_Hero_Creation_UD)
  else
    set WQ9=GetRectCenter(gg_rct_Hero_Creation_NE)
  endif
  if GameEnded==false and IsDead(CE8)then
    call J89(CE8,WU9,GetLocationX(WQ9),GetLocationY(WQ9),true)
    if WM9(CE8)==false or GetUnitAbilityLevel(CE8,'A0MW')==0 then
      call ReviveHeroLoc(CE8,WQ9,true)
    else
      call WP9(CE8,WQ9)
    endif
  endif
  call RemoveLocation(WQ9)
  set CE8=null
  set WU9=null
  set WQ9=null
endfunction

function Testmode_Dummy takes nothing returns nothing
  local unit Source=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  local player TXD
  local unit TYD
  local real x=GetRectCenterX(J5)
  local real y=GetRectCenterX(J5)
  if IsScourge(GetOwningPlayer(Source))then
    set TXD=Sentinels[1]
  else
    set TXD=Scourges[1]
  endif
  set TYD=CreateUnit(Scourges[1],'H000',-400,-400,0)
  call SetHeroLevel(TYD,10,false)
  set udg_Hero[GetPlayerId(Scourges[1])]=TYD
  set Source=null
  set TYD=null
  set TXD=null
endfunction

function Testmode_Powerup takes nothing returns nothing
  call TriggerEvaluate(RuneSpawnTrigger)
endfunction

function Testmode_Neutrals takes nothing returns nothing
  call TriggerEvaluate(NG)
endfunction

function Testmode_Trees takes nothing returns nothing
  call EnumDestructablesInRectAll(bj_mapInitialPlayableArea,function SWD)
endfunction

function TCD takes nothing returns boolean
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"**** REMINDER ****")
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"Single player commands enabled. You may use commands like -lvlup xx, -refresh, -spawncreeps, -powerup, -neutrals, -kill, -gold xxxx, -time xx, -killsent, -killscourge, -killall, -noherolimit, -trees, -killwards, -spawnoff, -spawnon, -roshan, -respawn, -dummy")
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"**** REMINDER ****")
  return false
endfunction

function T3D takes nothing returns nothing
  local player OnlyPlayer=PlayerModeTyper
  local trigger t
  set quest_test=true
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60,"Single player commands enabled. You may use commands like -lvlup xx, -refresh, -spawncreeps, -powerup, -neutrals, -kill, -gold xxxx, -time xx, -killsent, -killscourge, -killall, -noherolimit, -trees, -killwards, -spawnoff, -spawnon, -roshan, -respawn, -dummy")
  set t=CreateTrigger()
  call TriggerAddCondition(t,Condition(function TCD))
  call TriggerRegisterTimerEvent(t,GetRandomReal(60,100),false)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-lvlup",false)
  call TriggerAddAction(t,function Testmode_Lvlup)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-spawncreeps",true)
  call TriggerRegisterPlayersChat(t,"-sc",true)
  call TriggerAddAction(t,function Testmode_Spawncreeps)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-refresh",true)
  call TriggerAddAction(t,function Testmode_Refresh)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-kill",true)
  call TriggerAddAction(t,function Testmode_Kill)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-gold",false)
  call TriggerAddAction(t,function Testmode_Gold)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-time",false)
  call TriggerAddAction(t,function Testmode_Time)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-powerup",true)
  call TriggerAddAction(t,function Testmode_Powerup)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-killall",true)
  call TriggerAddAction(t,function Testmode_KillAll)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-killsent",true)
  call TriggerAddAction(t,function Testmode_KillSent)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-killscourge",true)
  call TriggerAddAction(t,function Testmode_KillScrg)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-neutrals",true)
  call TriggerAddAction(t,function Testmode_Neutrals)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-noherolimit",true)
  call TriggerAddAction(t,function Testmode_NHL)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-trees",true)
  call TriggerAddAction(t,function Testmode_Trees)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-killwards",true)
  call TriggerAddAction(t,function Testmode_KillWards)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-spawnoff",true)
  call TriggerAddAction(t,function Testmode_Spawnoff)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-spawnon",true)
  call TriggerAddAction(t,function Testmode_Spawnon)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-roshan",true)
  call TriggerAddAction(t,function Testmode_Roshan)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-respawn",true)
  call TriggerAddAction(t,function Testmode_Respawn)
  set t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-dummy",true)
  call TriggerAddAction(t,function Testmode_Dummy)
  set OnlyPlayer=null
  set t=null
endfunction

function T6D takes nothing returns boolean
  return not IsHeroesAvailable
endfunction

function TLD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Unit=(LoadUnitHandle(HY,h,(26)))
  if GetUnitTypeId(Unit)!='ncop' then
    call UnitResetCooldown(Unit)
    call SetUnitManaPercentBJ(Unit,100)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Unit=null
  return false
endfunction

function T1D takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function TLD))
  call SaveUnitHandle(HY,h,(26),(GetTriggerUnit()))
  set t=null
endfunction

function T0D takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer T5D=CountPlayersInForce(Force_Elfs)+CountPlayersInForce(Force_Unds)
  local integer NumRequired=IMinIF(T5D,T5D/ 2+1)
  local integer h=GetHandleId(t)
  if AQ7==false then
    set ZN7=true
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,60.," ")
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,90.,GetObjectName('n077'))
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,90.,GetObjectName('n078'))
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddAction(t,function T1D)
  endif
  set t=null
endfunction

function T2D takes nothing returns boolean
  if V99(GetTriggerUnit())and IsUnitIllusion(GetTriggerUnit())==false then
    call GR9(GetOwningPlayer(GetTriggerUnit()))
    call Traffic_RegisterData("Level"+I2S(GetHeroLevel(GetTriggerUnit())),GetPlayerId(GetOwningPlayer(GetTriggerUnit())))
  endif
  return false
endfunction

function U4D takes nothing returns nothing
  if AQ7==false then
    call T3D()
    call CleanTrigger(GetTriggeringTrigger())
  endif
endfunction

function U7D takes nothing returns boolean
  if IsHeroesAvailable==false and(bj_isSinglePlayer and S2D())==false then
    call U4D()
  endif
  return false
endfunction

function UGD takes nothing returns boolean
  local integer i=1
  local unit Hero
  loop
    exitwhen i>5
    set Hero=udg_Hero[GetPlayerId(Sentinels[i])]
    if Hero!=null and IsDead(Hero)==false and IsUnitEnemy(Hero,GetLocalPlayer()) then
      if (udg_ObserverMode==false or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)))then
        if IsUnitVisible(Hero,GetLocalPlayer())==false then
          if LK==2 then
            call FU9(Hero)
          endif
        else
          if LK==2 then
            call FS9(Hero)
          endif
        endif
      endif
    endif
    set Hero=udg_Hero[GetPlayerId(Scourges[i])]
    if Hero!=null and IsDead(Hero)==false and IsUnitEnemy(Hero,GetLocalPlayer()) then
      if (udg_ObserverMode==false or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2)))then
        if IsUnitVisible(Hero,GetLocalPlayer())==false then
          if LK==2 then
            call FU9(Hero)
          endif
        else
          if LK==2 then
            call FS9(Hero)
          endif
        endif
      endif
    endif
    set i=i+1
  endloop
  set Hero=null
  return false
endfunction

function UHD takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerAddCondition(t,Condition(function UGD))
  set t=null
endfunction

function UID takes nothing returns nothing
  call UHD()
endfunction

function RestoreNormalCreepsAggro takes nothing returns nothing
  call SetUnitUserData(GetEnumUnit(),0)
  call IssuePointOrderByIdLoc(GetEnumUnit(),851983,(WaypointLocations[GetUnitAbilityLevel((GetEnumUnit()),WaypointAbilID)]))
endfunction

function AggroCreepOnTarget takes nothing returns nothing
  call IssueTargetOrderById(GetEnumUnit(),851983,HeroAttackedLogic_TempUnit)
  call GroupAddUnit(HeroAttackedLogic_TempGroup,GetEnumUnit())
  call SetUnitUserData(GetEnumUnit(),HeroAttackedLogic_TempInt)
endfunction

function HeroAttackedLogic_CreepsFilter takes nothing returns boolean
  local integer id=GetUnitTypeId(GetFilterUnit())
  if id=='ebal' or id=='e026' or id=='umtw' or id=='u00R' then
    return false
  endif
  if IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(HeroAttackedLogic_TempUnit))and(GetOwningPlayer(GetFilterUnit())==Sentinels[0]or GetOwningPlayer(GetFilterUnit())==Scourges[0])and GetUnitUserData(GetFilterUnit())==0 then
    return true
  endif
  return false
endfunction

function RestoreNormalCreepsAggroIf2Far takes nothing returns nothing
  if GetUnitCurrentOrder(GetEnumUnit())==0 and IsUnitInRange(GetEnumUnit(),HeroAttackedLogic_TempUnit,GetUnitAcquireRange(GetEnumUnit()))==false then
    call GroupRemoveUnit(HeroAttackedLogic_TempGroup,GetEnumUnit())
    call SetUnitUserData(GetEnumUnit(),0)
    call IssuePointOrderByIdLoc(GetEnumUnit(),851983,(WaypointLocations[GetUnitAbilityLevel((GetEnumUnit()),WaypointAbilID)]))
  endif
endfunction

function HeroAttackedLogic_RestoreDefault takes nothing returns nothing
  local integer h=GetHandleId((LoadUnitHandle(HY,(GetHandleId(GetExpiredTimer())),2)))
  local integer id=(LoadInteger(HY,h,(143)))
  local group associatedGroup=(LoadGroupHandle(HY,h,(144)))
  set HeroAttackedLogic_Attackers[id]=null
  call ForGroup(associatedGroup,function RestoreNormalCreepsAggro)
  call GroupClear(associatedGroup)
  set associatedGroup=null
endfunction

function HeroAttackedLogic_Action takes unit victim,unit aggressor returns nothing
  local integer h=GetHandleId(victim)
  local group associatedGroup=LoadGroupHandle(HY,h,144)
  local integer id=LoadInteger(HY,h,143)
  local unit haunted=HeroAttackedLogic_Attackers[id]
  local group g
  if haunted!=null and haunted!=aggressor then
    call ForGroup(associatedGroup,function RestoreNormalCreepsAggro)
    call GroupClear(associatedGroup)
  endif
  set HeroAttackedLogic_Attackers[id]=aggressor
  set HeroAttackedLogic_TempGroup=associatedGroup
  set HeroAttackedLogic_TempUnit=aggressor
  set HeroAttackedLogic_TempInt=id
  call ForGroup(associatedGroup,function RestoreNormalCreepsAggroIf2Far)
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(aggressor),GetUnitY(aggressor),500,Condition(function HeroAttackedLogic_CreepsFilter))
  call ForGroup(g,function AggroCreepOnTarget)
  call KillGroup(g)
  call TimerStart(LoadTimerHandle(HY,h,141),2,false,function HeroAttackedLogic_RestoreDefault)
  set associatedGroup=null
  set haunted=null
  set g=null
endfunction

function HeroAttackedLogic_OrderIssued takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local unit Target=GetOrderTargetUnit()
  local integer order=GetIssuedOrderId()
  local integer id
  if IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitIllusion(Target)==false and(order==851983 or order==851971)and IsUnitEnemy(Target,GetOwningPlayer(Hero))and IsUnitVisible(Hero,GetOwningPlayer(Target)) and IsOrbAttack==false then
    set id=(LoadInteger(HY,(GetHandleId(Target)),(143)))
    if HeroAttackedLogic_Attackers[id]==null or HeroAttackedLogic_Attackers[id]==Target or IsDead(HeroAttackedLogic_Attackers[id])then
      call HeroAttackedLogic_Action(Target,Hero)
    endif
  endif
  set Hero=null
  set Target=null
  return false
endfunction

function HeroAttackedLogic_Attacked takes nothing returns boolean
  local unit u=GetAttacker()
  local unit Hero=GetTriggerUnit()
  local integer id
  if IsCreep(u)==false and IsOrbAttack==false then
    set id=(LoadInteger(HY,(GetHandleId(Hero)),(143)))//load internal hero's number
    if HeroAttackedLogic_Attackers[id]==null or HeroAttackedLogic_Attackers[id]==Hero or IsDead(HeroAttackedLogic_Attackers[id])then//if 
      call HeroAttackedLogic_Action(Hero,u)
    endif
  endif
  set u=null
  set Hero=null
  return false
endfunction

function HeroAttackedLogic_Register takes unit Hero returns nothing
  local group g
  local trigger t
  local timer tm
  local integer h=GetHandleId(Hero)
  set HeroAttackedLogic_Counter=HeroAttackedLogic_Counter+1
  call SaveBoolean(HY,h,(142),(true))
  call SaveInteger(HY,h,(143),(HeroAttackedLogic_Counter))
  set g=GetAvailableGroup()
  call SaveGroupHandle(HY,h,(144),(g))
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerAddCondition(t,Condition(function HeroAttackedLogic_OrderIssued))
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function HeroAttackedLogic_Attacked))
  set tm=CreateTimer()
  call SaveTimerHandle(HY,(GetHandleId(Hero)),(141),(tm))
  call SaveUnitHandle(HY,(GetHandleId(tm)),2,(Hero))
  set g=null
  set t=null
  set tm=null
endfunction

function HeroAttackedLogic_Init takes nothing returns boolean
  if IsRealHero(GetTriggerUnit())and(LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),(142)))==false and (not b_isPickTime) then
    call HeroAttackedLogic_Register(GetTriggerUnit())
  endif
  return false
endfunction

function UZD takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    call SetUnitAbilityLevel(GetTriggerUnit(),WaypointAbilID,5)
    if HeroAttackedLogic_Attackers[GetUnitUserData(GetTriggerUnit())]==null then
      call SetUnitUserData(GetTriggerUnit(),0)
      call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,(WaypointLocations[GetUnitAbilityLevel((GetTriggerUnit()),WaypointAbilID)]))
    endif
  elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    call SetUnitAbilityLevel(GetTriggerUnit(),WaypointAbilID,1)
    if HeroAttackedLogic_Attackers[GetUnitUserData(GetTriggerUnit())]==null then
      call SetUnitUserData(GetTriggerUnit(),0)
      call IssuePointOrderByIdLoc(GetTriggerUnit(),851983,(WaypointLocations[GetUnitAbilityLevel((GetTriggerUnit()),WaypointAbilID)]))
    endif
  endif
  return false
endfunction

function UAD takes nothing returns nothing
  local unit H3D=GetTriggerUnit()
  local unit UBD=(LoadUnitHandle(HY,(GetHandleId(H3D)),(145)))
  call RemoveUnit(UBD)
  set H3D=null
  set UBD=null
endfunction

function UCD takes nothing returns nothing
  local group g
  local unit H3D
  local unit UBD
  local trigger t
  local integer i
  set t=CreateTrigger()
  call TriggerAddAction(t,function UAD)
  set g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
  loop
    set H3D=FirstOfGroup(g)
    exitwhen H3D==null
    call GroupRemoveUnit(g,H3D)
    if GetUnitAbilityLevel(H3D,'Adts')>0 or GetUnitAbilityLevel(H3D,'Atru')>0 then
      call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
      set UBD=CreateUnit(Sentinels[1],('u00B'),-5000,-5100,0)
      call SetUnitScale(UBD,0,0,0)
      call SetUnitPathing(UBD,false)
      call SetUnitInvulnerable(UBD,true)
      call SetUnitX(UBD,GetUnitX(H3D))
      call SetUnitY(UBD,GetUnitY(H3D))
      call SaveUnitHandle(HY,(GetHandleId(H3D)),(145),(UBD))
    endif
  endloop
  call KillGroup(g)
  set g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
  loop
    set H3D=FirstOfGroup(g)
    exitwhen H3D==null
    call GroupRemoveUnit(g,H3D)
    if GetUnitAbilityLevel(H3D,'Adts')>0 or GetUnitAbilityLevel(H3D,'Atru')>0 then
      call TriggerRegisterUnitEvent(t,H3D,EVENT_UNIT_DEATH)
      set UBD=CreateUnit(Scourges[1],('u00B'),3400,4400,0)
      call SetUnitScale(UBD,0,0,0)
      call SetUnitPathing(UBD,false)
      call SetUnitInvulnerable(UBD,true)
      call SetUnitX(UBD,GetUnitX(H3D))
      call SetUnitY(UBD,GetUnitY(H3D))
      call SaveUnitHandle(HY,(GetHandleId(H3D)),(145),(UBD))
    endif
  endloop
  call KillGroup(g)
  set g=null
  set t=null
  set UBD=null
  set H3D=null
endfunction

function U3D takes nothing returns nothing
  local unit U6D=GetTriggerUnit()
  local unit Target=HeroAttackedLogic_Attackers[GetUnitUserData(U6D)]
  call SetUnitPosition(U6D,GetUnitX(U6D),GetUnitY(U6D))
  if Target!=null and IsDead(Target)==false and IsUnitVisible(Target,GetOwningPlayer(Target))then
    call IssueTargetOrderById(U6D,851983,Target)
  else
    call DisableTrigger(GetTriggeringTrigger())
    call IssuePointOrderByIdLoc(U6D,851983,(WaypointLocations[GetUnitAbilityLevel((U6D),WaypointAbilID)]))
    call EnableTrigger(GetTriggeringTrigger())
  endif
  set U6D=null
  set Target=null
endfunction

function ULD takes nothing returns boolean
  if IsCreep(GetTriggerUnit())then
    call U3D()
  endif
  return false
endfunction

function U1D takes nothing returns nothing
  local unit U6D=GetTriggerUnit()
  local unit Target=HeroAttackedLogic_Attackers[GetUnitUserData(U6D)]
  call SetUnitPosition(U6D,GetUnitX(U6D),GetUnitY(U6D))
  if Target!=null and IsDead(Target)==false and IsUnitVisible(Target,GetOwningPlayer(Target))then
    call IssueTargetOrderById(U6D,851983,Target)//attack
  else
    call DisableTrigger(GetTriggeringTrigger())
    call IssuePointOrderByIdLoc(U6D,851983,(WaypointLocations[GetUnitAbilityLevel((U6D),WaypointAbilID)]))//attack
    call EnableTrigger(GetTriggeringTrigger())
  endif
  set U6D=null
  set Target=null
endfunction

function U0D takes nothing returns boolean
  if GetIssuedOrderId()==851986 then//move
    call U1D()
  endif
  return false
endfunction

function U5D takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())==Sentinels[0]then
    if IsUnitFogged(GetAttacker(),Sentinels[1])or IsUnitFogged(GetAttacker(),Scourges[1])then
      call A28(CreateFogModifierRadius(Sentinels[1],FOG_OF_WAR_VISIBLE,GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),128,true,false),1)
    endif
  elseif GetOwningPlayer(GetTriggerUnit())==Scourges[0]then
    if IsUnitFogged(GetAttacker(),Sentinels[1])or IsUnitFogged(GetAttacker(),Scourges[1])then
      call A28(CreateFogModifierRadius(Scourges[1],FOG_OF_WAR_VISIBLE,GetUnitX(GetAttacker()),GetUnitY(GetAttacker()),128,true,false),1)
    endif
  endif
  return false
endfunction

function U2D takes nothing returns boolean
  local trigger t
  local group g
  local unit u
  if udg_ObserverMode then
    set t=CreateTrigger()
    call TriggerRegisterPlayerUnitEvent(t,Sentinels[0],EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
    call TriggerRegisterPlayerUnitEvent(t,Scourges[0],EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
    call TriggerAddCondition(t,Condition(function U0D))
    set t=CreateTrigger()
    set g=GetAvailableGroup()
    call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      call GroupRemoveUnit(g,u)
      if GetUnitAcquireRange(u)!=0 then
        call TriggerRegisterUnitInRange(t,u,600,Condition(function ReturnTrue))
      endif
    endloop
    call KillGroup(g)
    set g=GetAvailableGroup()
    call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      call GroupRemoveUnit(g,u)
      if GetUnitAcquireRange(u)!=0 and IsUnitType(u,UNIT_TYPE_STRUCTURE)then
        call TriggerRegisterUnitInRange(t,u,600,Condition(function ReturnTrue))
      endif
    endloop
    call KillGroup(g)
    call TriggerAddCondition(t,Condition(function ULD))
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerAddCondition(t,Condition(function U5D))
  endif
  call CleanTrigger(GetTriggeringTrigger())
  set t=null
  set g=null
  set u=null
  return false
endfunction

function V4D takes unit whichUnit returns nothing
  local integer i=0
  loop
    exitwhen(i==16)
    if IsUnitAlly(whichUnit,Player(i))then
      call UnitShareVision(whichUnit,Player(i),true)
    endif
    set i=i+1
  endloop
endfunction

function V7D takes nothing returns nothing
  call V4D(GetEnumUnit())
endfunction

function V8D takes nothing returns nothing
  local integer x
  local group g
  set x=1
  loop
    exitwhen x>5
    call SetPlayerAlliance(Sentinels[0],Sentinels[x],ConvertAllianceType(5),false)
    call SetPlayerAlliance(Scourges[0],Scourges[x],ConvertAllianceType(5),false)
    set x=x+1
  endloop
  set g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Sentinels[0],Condition(function ReturnTrue))
  call ForGroup(g,function V7D)
  call KillGroup(g)
  set g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,Scourges[0],Condition(function ReturnTrue))
  call ForGroup(g,function V7D)
  call KillGroup(g)
  set g=null
endfunction

function V9D takes nothing returns nothing
  local integer x
  set x=0
  loop
    exitwhen x>5
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(0),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(1),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(2),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(3),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(4),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(5),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(6),false)
    call SetPlayerAlliance(Sentinels[x],Neutrals,ConvertAllianceType(7),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(0),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(1),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(2),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(3),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(4),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(5),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(6),false)
    call SetPlayerAlliance(Scourges[x],Neutrals,ConvertAllianceType(7),false)
    
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(0),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(1),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(2),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(3),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(4),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(5),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(6),false)
    call SetPlayerAlliance(Neutrals,Sentinels[x],ConvertAllianceType(7),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(0),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(1),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(2),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(3),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(4),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(5),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(6),false)
    call SetPlayerAlliance(Neutrals,Scourges[x],ConvertAllianceType(7),false)
    set x=x+1
  endloop
endfunction

function VDD takes nothing returns boolean
  return IsCreep(GetTriggerUnit())
endfunction

function VED takes nothing returns nothing
  call V4D(GetTriggerUnit())
endfunction

function VFD takes nothing returns nothing
  local trigger t
  if not udg_ObserverMode then
    return
  endif
  call V8D()
  call V9D()
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function VDD))
  call TriggerAddAction(t,function VED)
  set t=null
endfunction

function LOLWTF_OHGODWHAT takes nothing returns boolean
  local integer PlayerId=1
  local integer i
  local unit Hero
  local integer MorphID1
  local integer MorphID2
  loop
    exitwhen PlayerId>11
    set Hero=udg_Hero[PlayerId]
    if Hero!=null and IsDead(Hero)==false and GetUnitTypeId(Hero)==HeroTypeId[PlayerId] and IsHexed(Hero)==false then
      loop
        set i=GetRandomInt(1,108)
        exitwhen (IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER) and IsUnitIdType(HeroTypeId[PlayerId],UNIT_TYPE_MELEE_ATTACKER)) or (IsUnitIdType(HeroID[i],UNIT_TYPE_RANGED_ATTACKER) and IsUnitIdType(HeroTypeId[PlayerId],UNIT_TYPE_RANGED_ATTACKER))
      endloop
      call SaveInteger(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Hero),'0PAS')),100,1)
      call TriggerEvaluate(LoadTriggerHandle(HY,GetHandleId(Hero),'0PAS'))  //FORCE DISABLE PASSIVES WHEN MORPHING
      set MorphID1=GetMorphId(HeroTypeId[PlayerId])
      set MorphID2=GetMorphId(HeroID[i])
      call UnitAddAbility(Hero,MorphID1)
      call UnitRemoveAbility(Hero,MorphID1)
      call UnitAddAbility(Hero,MorphID2+1)
      call UnitRemoveAbility(Hero,MorphID2+1)
      set HeroTypeId[PlayerId]=HeroID[i]
    endif
    set PlayerId=PlayerId+1
  endloop
  set Hero=null
  return false
endfunction

function RemoveAntihack2 takes nothing returns nothing
  call UnitRemoveAbility(GetEnumUnit(),'A44F')
endfunction

function RemoveAntihack takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,18000,Condition(function ReturnTrue))
  call ForGroup(g,function RemoveAntihack2)
  call KillGroup(g)
  set g=null
endfunction

function TESTMYFAITH takes nothing returns nothing
  if bj_isSinglePlayer then
    call SetPlayerAlliance(Player(0),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(1),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(2),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(3),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(4),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(5),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(6),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(7),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(8),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(9),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(10),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(11),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(12),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(13),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(14),Player(1),ConvertAllianceType(6),true)
    call SetPlayerAlliance(Player(15),Player(1),ConvertAllianceType(6),true)
    call RemoveAntihack()
    set IsControlled=true
    call ClearTextMessages()
  endif
endfunction
//
//function FogClickSaver takes nothing returns nothing
//	local integer i=1
//	local player p=Sentinels[0]
//	loop
//		if i>5 then
//			set p=Scourges[0]
//		endif
//		if IsUnitVisible(udg_Hero[i],p) then
//			if 
//			call SaveReal(HeroStats,GetHandleId(udg_Hero[i]),106,TimerGetElapsed(GlobalTimer))
//		endif
//		set i=i+1
//		exitwhen i>11
//	endloop
//	
//endfunction

function ShowSkillsOnSelecting takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local player t=GetOwningPlayer(GetTriggerUnit())
  local integer i
  if p!=t and ShowSkills[GetPlayerId(p)] and GetTriggerUnit()==udg_Hero[GetPlayerId(t)] and IsPlayerAlly(p,t) then
    set i=PlayerSkillNumber[GetPlayerId(t)*PlayerSkillOffset]
    call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+1])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),1))+"|r")
    call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+2])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),2))+"|r")
    call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+3])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),3))+"|r")
    call DisplayTimedTextToPlayer(p,0,0,10,"|c00ff54f2"+GetObjectName(SkillID[i+4])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),4))+"|r")
    if NumberOfExtraAbilities>0 then
      call DisplayTimedTextToPlayer(p,0,0,10,"|c00a0a0f8"+GetObjectName(SkillID[i+5])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),5))+"|r")
      if(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]]>0)then
        call DisplayTimedTextToPlayer(p,0,0,10,"|c00ff54f2"+GetObjectName(SkillID[i+6])+"|r level: |c00f8a0a0"+I2S(GetHeroAbilityLevel(GetTriggerUnit(),6))+"|r")
      endif
    endif
  endif
  if GetUnitTypeId(GetTriggerUnit())!='hfoo' and IsUnitEnemy(GetTriggerUnit(),p) and IsUnitVisible(GetTriggerUnit(),p)==false then
    if GetObjectName('TEST')=="L1ch" then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,"|c00ff0303Possible MH click by|r "+udg_Colors[GetPlayerId(p)]+PlayerNames[GetPlayerId(p)]+"|r on "+GetUnitName(GetTriggerUnit()))
    endif
  endif
  
endfunction

function OwnerChanging takes nothing returns nothing
  //call echo("change from "+GetPlayerName(GetChangingUnitPrevOwner())+" by "+GetUnitName(GetChangingUnit()))
  call UnitRemoveAbility(GetChangingUnit(),'A44F')
endfunction

function HelpPlayerIfNotReady takes nothing returns nothing
  local integer i
  local integer aid
  local integer rnd
  local player p
  local integer k=1
  local integer te=0
  
  loop
    set p=Player(k)
    set i=k
    if b_isPlayerReady[i]==false and GetPlayerController(p)==MAP_CONTROL_USER and GetPlayerSlotState(p)==PLAYER_SLOT_STATE_PLAYING then
      loop
        exitwhen b_isPlayerReady[i]
        if s_MainMode=="sd" or s_MainMode=="md" then
          loop
            set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
            exitwhen(b_HeroAvailableForPlayer[i*NumberOfHeroes+rnd] and IsHeroIngame[rnd]==false) 
          endloop
          set aid=(rnd*4)-4
          set aid=aid+GetRandomInt(1,4)
          call SaveInteger(HY,'0REA','0PID',i)
          call SaveInteger(HY,'0REA','0SID',aid)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
        else
          loop
            set aid=(GetRandomInt(1,NumberOfHeroes*4))
            set te=AdjustHeroNumber((aid+3)/4)
            exitwhen IsHeroIngame[te]==false// and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[te])>0
          endloop
          //set aid=GetRandomInt(1,NumberOfHeroes*4)
          call SaveInteger(HY,'0REA','0PID',i)
          call SaveInteger(HY,'0REA','0SID',aid)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
        endif
      endloop
    endif
    set k=k+1
    if k==6 then
      set k=7
    endif
    exitwhen k>11
  endloop
  
  call ExeFunc("BMD")
endfunction

function AddSkillForGroup takes nothing returns nothing
  call UnitAddAbility2(GetEnumUnit(),TempInteger)
  if TempReal==1.0 then
    call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),TempInteger,false)
    set TempReal=.0
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),TempInteger)==0 then
    call AddUnitToStock(GetEnumUnit(),TempInteger,1,1)
    call echo(Id2String(TempInteger)+" ("+GetObjectName(TempInteger)+") added")
  endif
endfunction

function AddSkillFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,99999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set TempReal=.0
    if SubString(said,0,2)=="QU" then
      set TempReal=1.0
    endif
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function AddSkillForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function RSkillForGroup takes nothing returns nothing
  call UnitRemoveAbility(GetEnumUnit(),TempInteger)
endfunction

function RSkillFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,99999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function RSkillForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function GSkillForGroup takes nothing returns nothing
  call BJDebugMsg(GetObjectName(GetUnitTypeId(GetEnumUnit()))+"'s lvl of "+Id2String(TempInteger)+" is "+I2S(GetUnitAbilityLevel(GetEnumUnit(),TempInteger)))
endfunction

function GSkillFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,99999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function GSkillForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function HSkillForGroup takes nothing returns nothing
  call SetPlayerAbilityAvailable(GetOwningPlayer(GetEnumUnit()),TempInteger,false)
endfunction

function HSkillFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,99999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function HSkillForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function AddItemDebugForGroup takes nothing returns nothing
  local item it=UnitAddItemById(GetEnumUnit(),TempInteger)
  call SetItemPlayer(it,GetOwningPlayer(GetEnumUnit()),false)
  set it=null
endfunction

function AddItemDebug takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,99999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function AddItemDebugForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function OUnitForGroup takes nothing returns nothing
  call SetUnitOwner(GetEnumUnit(),Player(TempInteger),true)
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)then
    set udg_Hero[TempInteger]=GetEnumUnit()
  endif
endfunction

function OUnitFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),3,5)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=S2I(said)
    if TempInteger<0 or TempInteger>15 then
      return
    endif
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function OUnitForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function HidePassivesFunction takes unit u returns nothing
  local integer i=1
  local integer k
  local integer lvl
  local player p=GetOwningPlayer(u)
  local boolean b=HidePassivesForPlayer[GetPlayerId(p)]
  set HidePassivesForPlayer[GetPlayerId(p)]=not b
  if HidePassivesForPlayer[GetPlayerId(p)] then
    call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|cffff0000[SP]|r |c006699CCHiding Passives.|r")
    loop
      if PassivesUpgradeID[i]>0 and PassivesLearningSkill[i]!='A0YK' then
        call UnitAddAbility2(u,PassivesUpgradeID[i])
        if GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])>0 then
          set lvl=GetUnitAbilityLevel(u,PassivesLearningSkillUpg[i])
          call UnitRemoveAbility(u,PassivesLearningSkillUpg[i])
          call UnitAddAbility2(u,PassivesLearningSkillUpg[i])
          call SetUnitAbilityLevel(u,PassivesLearningSkillUpg[i],lvl)
        endif
      endif
      set i=i+1
      exitwhen i>PassivesCount
    endloop
    call SetPlayerAbilityAvailable(p,'A13T',b)//tidebringer
    call SetPlayerAbilityAvailable(p,'A0MB',b)//riki's ulty
    call SetPlayerAbilityAvailable(p,'P247',b)// hunter in the night
    call SetPlayerAbilityAvailable(p,'A1IQ',b)//jinada
    if NumberOfExtraAbilities>0 then
      set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+5]])
      if k>0 then
        call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
      endif
    endif
    if NumberOfExtraAbilities>1 then
      set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]])
      if k>0 then
        call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
      endif
    endif
  else
    call DisplayTimedTextToPlayer(p,0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"|cffff0000[SP]|r |c006699CCShowing Passives.|r")
    loop
      if PassivesUpgradeID[i]>0 and PassivesLearningSkill[i]!='A0YK' then
        call UnitRemoveAbility(u,PassivesUpgradeID[i])
        if GetUnitAbilityLevel(u,PassivesLearningSkill[i])>0 then
          set lvl=GetUnitAbilityLevel(u,PassivesLearningSkill[i])
          call UnitRemoveAbility(u,PassivesLearningSkill[i])
          call UnitAddAbility2(u,PassivesLearningSkill[i])
          call SetUnitAbilityLevel(u,PassivesLearningSkill[i],lvl)
        endif
      endif
      set i=i+1
      exitwhen i>PassivesCount
    endloop
    call SetPlayerAbilityAvailable(p,'A13T',b)
    call SetPlayerAbilityAvailable(p,'A0MB',b)
    call SetPlayerAbilityAvailable(p,'P247',b)
    call SetPlayerAbilityAvailable(p,'A1IQ',b)
    if NumberOfExtraAbilities>0 then
      set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+5]])
      if k>0 then
        call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
      endif
    endif
    if NumberOfExtraAbilities>1 then
      set k=GetPassiveLearnNumber(SkillID[PlayerSkillNumber[GetPlayerId(p)*PlayerSkillOffset+6]])
      if k>0 then
        call SetPlayerAbilityAvailable(p,PassivesLearningSkill[k],b)
      endif
    endif
  endif
  set u=null
endfunction

function HidePassivesOnLearn takes nothing returns nothing
  call HidePassivesFunctionSup(TEMPUNIT)
endfunction

function HidePassivesFunctionInit takes nothing returns nothing
  local unit u=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  if u!=null and IsDead(u)==false and b_isPickTime==false  then//and Z3
    call HidePassivesFunction(u)
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],"You cant use this command for a while")
  endif
  set u=null
endfunction

function DebugRemoveBuggedItem takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),18,19)
  local integer i=S2I(said)
  if i>0 and i<7 then
    if UnitItemInSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1)!=null and GetIndex(UnitItemInSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1))<0 then
      call UnitRemoveItemFromSlot(udg_Hero[GetPlayerId(GetTriggerPlayer())],i-1)
    else
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"This item isnt considered as bugged")
    endif
  endif
  
endfunction

function SetmsForGroup takes nothing returns nothing
  call SetUnitMoveSpeed(GetEnumUnit(),(TempReal))
endfunction


function setmsfunc takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),7,999)
  local group g
  if bj_isSinglePlayer then
    set TempReal=S2R(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function SetmsForGroup)
    call KillGroup(g)
  endif
  set g=null
  
endfunction


function ispawnableitemForGroup takes nothing returns nothing
  if IsItemPawnable(UnitItemInSlot(GetEnumUnit(),TempInteger)) then
    call BJDebugMsg("pawn")
  else
    call BJDebugMsg("unpawn")
  endif
endfunction

function ispawnableitem takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=S2I(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function ispawnableitemForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function AddTypeForGroup takes nothing returns nothing
  call UnitAddType(GetEnumUnit(),ConvertUnitType(TempInteger))
  if IsUnitType(GetEnumUnit(),ConvertUnitType(TempInteger)) then
    call BJDebugMsg("added")
  endif
endfunction

function AddTypeDebug takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,999)
  local group g
  if bj_isSinglePlayer then
    set TempInteger=S2I(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function AddTypeForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function SelectHeroF takes nothing returns nothing
  if bj_isSinglePlayer then
    
  endif
endfunction

function SetAnimFnForGroup takes nothing returns nothing
  call SetUnitAnimationByIndex(GetEnumUnit(),TempInteger)
  call ClearTextMessages()
  call BJDebugMsg(I2S(TempInteger))
endfunction

function SetAnimFn takes nothing returns nothing
  local string s=SubString(GetEventPlayerChatString(),6,999)
  local group g
  local integer i=S2I(s)
  local boolean b=false
  local unit u
  if I2S(i)!=s then
    set b=true//string
  endif
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    if b then
      call SetUnitAnimation(u,s)
    else
      call SetUnitAnimationByIndex(u,i)
    endif
    call GroupRemoveUnit(g,u)
  endloop
  call KillGroup(g)
  set g=null
endfunction

function SetHPFnForGroup takes nothing returns nothing
  call SetWidgetLife(GetEnumUnit(),TempInteger)
endfunction

function SetHPFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,999)
  local group g
  local integer i=S2I(said)
  if bj_isSinglePlayer then
    set TempInteger=S2I(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function SetHPFnForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function SetMPFnForGroup takes nothing returns nothing
  call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,TempInteger)
endfunction

function SetMPFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,999)
  local group g
  local integer i=S2I(said)
  if bj_isSinglePlayer then
    set TempInteger=S2I(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function SetMPFnForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function AddRuneFnForGroup takes nothing returns nothing
  call CreateItem(TempInteger,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
endfunction

function AddRuneFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),4,9)
  local group g
  local integer i=S2I(said)
  if bj_isSinglePlayer then
    set TempInteger=String2Id(said)
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function AddRuneFnForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function GetXYofUnitForGroup takes nothing returns nothing
  call BJDebugMsg(R2S(GetUnitX(GetEnumUnit()))+" "+R2S(GetUnitY(GetEnumUnit())))
endfunction

function GetXYofUnit takes nothing returns nothing
  local group g
  if bj_isSinglePlayer then
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function GetXYofUnitForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function ChangeCamDistance takes nothing returns nothing
  local real r=S2R(SubString(GetEventPlayerChatString(),5,9))
  if r<=0 then
    call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,1650,0)
    call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',1650)
    call Error(GetTriggerPlayer(),"Incorrect multiplier, camera changed to default.")
  elseif r>0 and r<3 then
    call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,1650*r,0)
    call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',1650*r)
    //call Error(GetTriggerPlayer(),"Incorrect multiplier, camera changed to 3x distance.")
  elseif r>=600 and r<=4500 then
    call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_TARGET_DISTANCE,r,0)
    call SaveReal(HeroStats,GetHandleId(GetTriggerPlayer()),'CAMD',r)
  else 
    call Error(GetTriggerPlayer(),"Incorrect camera distance.")
  endif
  call SetCameraFieldForPlayer(GetTriggerPlayer(),CAMERA_FIELD_FARZ,100000,0)
endfunction


function RemoveUnitFnForGroup takes nothing returns nothing
  call RemoveUnit(GetEnumUnit())
endfunction

function RemoveUnitFn takes nothing returns nothing
  local group g
  if bj_isSinglePlayer then
    set g=GetAvailableGroup()
    call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
    call ForGroup(g,function RemoveUnitFnForGroup)
    call KillGroup(g)
  endif
  set g=null
endfunction

function RGCFFSendStats takes nothing returns nothing
  local integer i=1
  local integer k=5
  local integer votes=0
  local integer pid=GetPlayerId(GetTriggerPlayer())
  
  if RGCFFed[pid]==false then
    if pid>6 then
      set k=11
      set i=7
    endif
    loop
      if RGCFFed[i] then
        set votes=votes+1
      endif
      set i=i+1
      exitwhen i>k
    endloop
    if votes==4 then
      call RMD_SendStats()
      if pid<7 then
        call KillUnit(TreeOfLife)
      else
        call KillUnit(FrozenThrone)
      endif
    endif
    set RGCFFed[pid]=true
  endif
endfunction

function RemoveMorphIconFn takes nothing returns nothing
  local integer pid=GetPlayerId(GetTriggerPlayer())
  local unit u=udg_Hero[pid]
  if(u!=null and IsDead(u)==false)then
    if GetUnitAbilityLevel(u,'A0KW')>0 then
      call SetPlayerAbilityAvailable(Player(pid),'A0KW',HideMorphIcon[pid])
      call SetPlayerAbilityAvailable(Player(pid),'A0KX',HideMorphIcon[pid])
      set HideMorphIcon[pid]=not HideMorphIcon[pid]
    else
      call Error(GetTriggerPlayer(),"No Morph")
    endif
  else
    call Error(GetTriggerPlayer(),"No hero")
  endif
  set u=null
endfunction

function AltHUD takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local integer i=1
  if IsScourge(p) then
    set i=7
  endif
  call SetPlayerAlliance(Player(i+0),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+0),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
  call SetPlayerAlliance(Player(i+1),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+1),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
  call SetPlayerAlliance(Player(i+2),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+2),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
  call SetPlayerAlliance(Player(i+3),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+3),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
  call SetPlayerAlliance(Player(i+4),p,ALLIANCE_SHARED_ADVANCED_CONTROL,not GetPlayerAlliance(Player(i+4),p,ALLIANCE_SHARED_ADVANCED_CONTROL))
  
endfunction

function changecolorf takes nothing returns nothing
  
endfunction

function CMDShowMyNetworth takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Your Networth is "+I2S(NetWorths[GetPlayerId(GetTriggerPlayer())]))
endfunction

function ToggleStatusWindow takes nothing returns nothing
  local boolean b=LoadBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'UIds')
  if b then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|c00aeae00Status window enabled|r")
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|c00fcfa00Status window disabled|r")
  endif
  call SaveBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'UIds',not b)
endfunction

function FastClear takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local integer pid=GetPlayerId(p)
  if TxtDur[pid]==1. then
    call DisplayTimedTextToPlayer(p,0,0,3,"|c00aeae00 Fast Clear disabled|r - all death messages lasts 10 seconds.")
    set TxtDur[pid]=10.
  else
    call DisplayTimedTextToPlayer(p,0,0,3,"|c00fcfa00 Fast Clear enabled|r - all death messages lasts 3 seconds.")
    set TxtDur[pid]=1.
  endif
endfunction

function NoSameHotkeyCmd takes nothing returns nothing
  call SaveBoolean(HeroStats,GetHandleId(GetTriggerPlayer()),'NSHK',true)
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"|c00aeae00 No same hotkey|r option disabled - you can get any possible ability, regardless hotkey")
endfunction

function getunitidFn takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit u
  local integer i=0
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  set u=FirstOfGroup(g)
  loop
    exitwhen u==null
    call echo(Id2String(GetUnitTypeId(u)))
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
  set g=null
endfunction

function InitSCMD takes nothing returns nothing
  call SaveStr(SCMD,StringHash("-gameinfo"),0,"WYD")
  call SaveStr(SCMD,StringHash("-recreate"),0,"WAD")
  call SaveStr(SCMD,StringHash("-unstuck"),0,"WBD")
  call SaveStr(SCMD,StringHash("-matchup"),0,"WCD")
  call SaveStr(SCMD,StringHash("-ma"),0,"WCD")
  call SaveStr(SCMD,StringHash("-movespeed"),0,"W3D")
  call SaveStr(SCMD,StringHash("-ms"),0,"W3D")
  call SaveStr(SCMD,StringHash("-nh"),0,"NoSameHotkeyCmd")
  call SaveStr(SCMD,StringHash("-mc"),0,"CheckWhatIsMulticast")
  
  call SaveStr(SCMD,StringHash("-msa"),0,"W6D")
  call SaveStr(SCMD,StringHash("-disablehelp"),0,"WLD")
  call SaveStr(SCMD,StringHash("-enablehelp"),0,"W1D")
  call SaveStr(SCMD,StringHash("-creepstats"),0,"W0D")
  call SaveStr(SCMD,StringHash("-cs"),0,"W0D")
  call SaveStr(SCMD,StringHash("-cson"),0,"W5D")
  call SaveStr(SCMD,StringHash("-csoff"),0,"W5D")
  call SaveStr(SCMD,StringHash("-hidemsg"),0,"W2D")
  call SaveStr(SCMD,StringHash("-showmsg"),0,"X4D")
  call SaveStr(SCMD,StringHash("-weather snow"),0,"X7D")
  call SaveStr(SCMD,StringHash("-weather rain"),0,"X7D")
  call SaveStr(SCMD,StringHash("-weather off"),0,"X7D")
  call SaveStr(SCMD,StringHash("-weather random"),0,"X7D")
  call SaveStr(SCMD,StringHash("-weather wind"),0,"X7D")
  call SaveStr(SCMD,StringHash("-weather moonlight"),0,"X7D")
  call SaveStr(SCMD,StringHash("-showdeny"),0,"X8D")
  call SaveStr(SCMD,StringHash("-hidedeny"),0,"X8D")
  call SaveStr(SCMD,StringHash("-denyinfo"),0,"X9D")
  call SaveStr(SCMD,StringHash("-di"),0,"X9D")
  call SaveStr(SCMD,StringHash("-don"),0,"XDD")
  call SaveStr(SCMD,StringHash("-deathon"),0,"XDD")
  call SaveStr(SCMD,StringHash("-doff"),0,"XDD")
  call SaveStr(SCMD,StringHash("-deathoff"),0,"XDD")
  call SaveStr(SCMD,StringHash("-hhn"),0,"XFD")
  call SaveStr(SCMD,StringHash("-ui"),0,"ToggleStatusWindow")
  call SaveStr(SCMD,StringHash("-hideheronames"),0,"XFD")
  call SaveStr(SCMD,StringHash("-mute"),0,"XGD")
  call SaveStr(SCMD,StringHash("-afk"),0,"XHD")
  call SaveStr(SCMD,StringHash("-apm"),0,"XJD")
  call SaveStr(SCMD,StringHash("-clear"),0,"XKD")
  call SaveStr(SCMD,StringHash("-fc"),0,"FastClear")
  call SaveStr(SCMD,StringHash("-courier"),0,"XMD")
  //call SaveStr(SCMD,StringHash("-ah"),0,"XND")
  call SaveStr(SCMD,StringHash("-rolloff"),0,"XQD")
  call SaveStr(SCMD,StringHash("-rollon"),0,"XRD")
  call SaveStr(SCMD,StringHash("-bonus"),0,"XXD")
  call SaveStr(SCMD,StringHash("-rollhero"),0,"XYD")
  call SaveStr(SCMD,StringHash("-rh"),0,"XYD")
  call SaveStr(SCMD,StringHash("-ii"),0,"XBD")
  call SaveStr(SCMD,StringHash("-iteminfo"),0,"XBD")
  call SaveStr(SCMD,StringHash("-si"),0,"ShowSpellInfo")
  call SaveStr(SCMD,StringHash("-skillinfo"),0,"ShowSpellInfo")
  call SaveStr(SCMD,StringHash("-spellinfo"),0,"ShowSpellInfo")
  call SaveStr(SCMD,StringHash("-ss"),0,"ToggleSkillShowing")
  call SaveStr(SCMD,StringHash("-disableselection"),0,"XLD")
  call SaveStr(SCMD,StringHash("-ds"),0,"XLD")
  call SaveStr(SCMD,StringHash("-enableselection"),0,"X1D")
  call SaveStr(SCMD,StringHash("-unlock"),0,"X6D")
  
  call SaveStr(SCMD,StringHash("-es"),0,"X1D")
  call SaveStr(SCMD,StringHash("-sleep"),0,"X0D")
  call SaveStr(SCMD,StringHash("-calm"),0,"X2D")
  call SaveStr(SCMD,StringHash("-st"),0,"X5D")
  call SaveStr(SCMD,StringHash("-sp"),0,"HidePassivesFunctionInit")
  call SaveStr(SCMD,StringHash("-show"),0,"Techies_ShowDetonateIcon")
  //call SaveStr(SCMD,StringHash("-cd"),0,"TogglePassiveCooldown")
  call SaveStr(SCMD,StringHash("-cooldown"),0,"TogglePassiveCooldown")
  call SaveStr(SCMD,StringHash("-fix"),0,"FixPassivesPlz")
  call SaveStr(SCMD,StringHash("-reset"),0,"ResetSpells")
  call SaveStr(SCMD,StringHash("-remove"),0,"RemoveUnitFn")
  call SaveStr(SCMD,StringHash("-morph"),0,"RemoveMorphIconFn")
  call SaveStr(SCMD,StringHash("-hud"),0,"AltHUD")
  call SaveStr(SCMD,StringHash("-sddon"),0,"ToggleSDD")
  call SaveStr(SCMD,StringHash("-sddoff"),0,"ToggleSDD")
  call SaveStr(SCMD,StringHash("-ff"),0,"ffWrapper")
  //call SaveStr(SCMD,StringHash("!ff"),0,"ffWrapper")
  call SaveStr(SCMD,StringHash("!ff"),0,"RGCFFWrapper")//RGC has failed here, replacing with our own FF
  call SaveStr(SCMD,StringHash("-wff"),0,"whoffWrapper")
  call SaveStr(SCMD,StringHash("-addtime"),0,"AddPickTimeWrapper")
  call SaveStr(SCMD,StringHash("-ready"),0,"ReadyCMDWrapper")
  call SaveStr(SCMD,StringHash("-lolwtf"),0,"LOLWTFWrapper")
  call SaveStr(SCMD,StringHash("-random"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-random int"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-random agi"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-random str"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-random melee"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-random range"),0,"RandomHeroWrapper")
  call SaveStr(SCMD,StringHash("-repick"),0,"RepickHeroWrapper")
  call SaveStr(SCMD,StringHash("-ok"),0,"SwitchChatCmd")
  call SaveStr(SCMD,StringHash("-no"),0,"SwitchChatCmd")
  
  call SaveStr(SCMD,StringHash("-nw"),0,"CMDShowMyNetworth")
  call SaveStr(SCMD,StringHash("-orp"),0,"OldRunePickupStyle")
  call SaveStr(SCMD,StringHash("-tdmg"),0,"CMDShowMyTowerDamage")
  call SaveStr(SCMD,StringHash("-shaking"),0,"CMDShakingToggle")
endfunction

function CMDShakingToggle takes nothing returns nothing
  local integer pid=GetPlayerId(GetTriggerPlayer())
  set ShakingOn[pid]=ShakingOn[pid]==false
  if ShakingOn[pid] then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Camera shaking turned |c0000FF00ON|r")
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Camera shaking turned |c00FF0000OFF|r")
  endif
endfunction

function CMDShowMyTowerDamage takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"You dealt "+I2S(R2I(LoadReal(HeroStats,GetHandleId(GetTriggerPlayer()),'Tdmg')))+" damage to enemy structures")
endfunction

function OldRunePickupStyle takes nothing returns nothing
  local integer pid=GetPlayerId(GetTriggerPlayer())
  set BottlePickupRunesOldfashion[pid]=BottlePickupRunesOldfashion[pid]==false
  if BottlePickupRunesOldfashion[pid] then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|cffff0000Runes|r |c00FF0000won't|r go into bottle on right click")
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"|cffff0000Runes|r now |c0000FF00will|r go into bottle on right click")
  endif
endfunction

function ToggleSkillShowing takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local integer pid=GetPlayerId(p)
  if ShowSkills[pid] then
    call DisplayTimedTextToPlayer(p,0,0,5,"|cffff0000Show Skill|r turned |c00FF0000OFF|r")
  else
    call DisplayTimedTextToPlayer(p,0,0,5,"|cffff0000Show Skill|r turned |c0000FF00ON|r")
  endif
  set ShowSkills[pid]=not ShowSkills[pid]
endfunction

function ToggleSDD takes nothing returns nothing
  if GetEventPlayerChatString()=="-sddon" then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),.0,.0,10.,"|cffff0000[SDD] |r"+"|c006699CC"+"System Display Damage |c0000FF00ON|r"+"|c006699CC"+"."+"|r")
    set b_isDamageShowed[GetPlayerId(GetTriggerPlayer())]=true
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),.0,.0,10.,"|cffff0000[SDD] |r"+"|c006699CC"+"System Display Damage |c00FF0000OFF|r"+"|c006699CC"+"."+"|r")
    set b_isDamageShowed[GetPlayerId(GetTriggerPlayer())]=false
  endif
endfunction

function Techies_ShowDetonateIcon takes nothing returns nothing
  local integer pid=GetPlayerId(GetTriggerPlayer())
  if GetUnitAbilityLevel(udg_Hero[pid],'A0AK')>0 or GetUnitAbilityLevel(udg_Hero[pid],'A1FY')>0 then
    if GetUnitAbilityLevel(udg_Hero[pid],'A1WF')==0 then
      call UnitAddAbility2(udg_Hero[pid],'A1WF')
    else
      call UnitRemoveAbility(udg_Hero[pid],'A1WF')
    endif
  endif
endfunction

function TogglePassiveCooldown takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local boolean CD = LoadBoolean(MHT,GetHandleId(p),4)
  if CD then
    call DisplayTimedTextToPlayer(p,.0,.0,10.,"Turning passive cooldown display |c00FF0000OFF|r")
    call SaveBoolean(MHT,GetHandleId(p),4,false)
  else
    call DisplayTimedTextToPlayer(p,.0,.0,10.,"Turning passive cooldown display |c0000FF00ON|r")
    call SaveBoolean(MHT,GetHandleId(p),4,true)
  endif
endfunction

function ffWrapper takes nothing returns nothing
  if Mode_FF then
    call RN8(GetPlayerId(GetTriggerPlayer()),false)
  endif
endfunction

function whoffWrapper takes nothing returns nothing
  if Mode_FF then
    call RO8(GetTriggerPlayer())
  endif
endfunction

function AddTimeToTimer takes nothing returns nothing
  local integer i=R2I(TimerGetRemaining(NK))
  call TimerStart(NK,i+60,false,function HelpPlayerIfNotReady)
endfunction

function ReadyCMD takes player p returns nothing
  local integer BJD
  local integer SJ8
  local integer i
  local integer te
  if b_isPickTime then
    if TimerGetElapsed(GlobalTimer)>ReadyCooldown[GetPlayerId(p)] then
      if IsHeroesAvailable==false then
        call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You cannot use this command yet."+"|r")
      else
        if b_isPlayerReady[GetPlayerId(p)] then
          call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You have already chosen all your spells."+"|r")
        else
          set ReadyCooldown[GetPlayerId(p)]=TimerGetElapsed(GlobalTimer)+4
          set i=GetPlayerId(p)
          loop
            exitwhen b_isPlayerReady[i]
            if s_MainMode=="sd" or s_MainMode=="md" then
              loop
                set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
                exitwhen(b_HeroAvailableForPlayer[i*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false) 
              endloop
              set SJ8=(BJD*4)-4
              set SJ8=SJ8+GetRandomInt(1,4)
              call SaveInteger(HY,'0REA','0PID',i)
              call SaveInteger(HY,'0REA','0SID',SJ8)
              call SaveBoolean(HY,'0REA','000B',false)
              call ExeFunc("BUD")
            else
              loop
                set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
                set te=AdjustHeroNumber((SJ8+3)/4)
                exitwhen(IsHeroIngame[te]==false and GetPlayerTechMaxAllowed(p,HeroID[te])>0)
              endloop
              call SaveInteger(HY,'0REA','0PID',i)
              call SaveInteger(HY,'0REA','0SID',SJ8)
              call SaveBoolean(HY,'0REA','000B',false)
              call ExeFunc("BUD")
            endif
          endloop
          call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccff"+"You are now ready, your remaining spells have been chosen randomly."+"|r")
          call ExeFunc("BMD")
        endif
      endif
    else
      call DisplayTimedTextToPlayer(p,.0,.0,10.,"|cff99ccffYou can't use this command so often. Wait.|r")
    endif
  endif
endfunction

function ReadyCMDWrapper takes nothing returns nothing
  call ReadyCMD(GetTriggerPlayer())
endfunction

function ReadyCMDAltar takes nothing returns nothing
  call ReadyCMD(tt_player1)
endfunction

function LOLWTFWrapper takes nothing returns nothing
  if false then //HERPDERP
    if LOLWTF==false then
      set LOLWTF=true
      set LOLWTF_Trig=CreateTrigger()
      call TriggerRegisterTimerEvent(LOLWTF_Trig,2,true)
      call TriggerAddCondition(LOLWTF_Trig,Condition(function LOLWTF_OHGODWHAT))
    else
      call CleanTrigger(LOLWTF_Trig)
    endif
  endif
endfunction

function RandomHeroWrapper takes nothing returns nothing
  if b_isPickTime==false and s_MainMode!="md" then
    call ExeFunc("WWD")
  endif
endfunction

function RepickHeroWrapper takes nothing returns nothing
  if b_isPickTime==false  then
    call ExeFunc("WXD")
  endif
endfunction

function RGCFFWrapper takes nothing returns nothing
  if TimerGetElapsed(GlobalTimer)>300 and IsRGC then
    call ExeFunc("RGCFFSendStats")
  endif
endfunction

function SetUnitAbiLvlForGroup takes nothing returns nothing
  call SetUnitAbilityLevel(GetEnumUnit(),TempInteger,tt_int1)
endfunction

function SetUnitAbiLvl takes nothing returns nothing
  local string id=SubString(GetEventPlayerChatString(),4,8)
  local integer lvl=S2I(SubString(GetEventPlayerChatString(),9,11))
  local group g
  set TempInteger=String2Id(id)
  set tt_int1=lvl
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call ForGroup(g,function SetUnitAbiLvlForGroup)
  call KillGroup(g)
  set g=null
endfunction

function AddUnitOnMap takes nothing returns nothing
  local integer id=String2Id(SubString(GetEventPlayerChatString(),4,8))
  if id>0 then
    set tt_bool1=true
    call CreateUnit(Player(4),id,-510,-512,0)
    set tt_bool1=false
  endif
endfunction

function nerfedstunsFnFG takes nothing returns nothing
  call StunTargetLod(GetEnumUnit(),1)
endfunction

function nerfedstunsFn takes nothing returns nothing
  local group g
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call ForGroup(g,function nerfedstunsFnFG)
  call KillGroup(g)
  set g=null
endfunction

function orderstun takes nothing returns nothing
  //call echo("Bonus: "+I2S(TempInteger)+"; Limit: "+I2S(tt_int1))
  //call CustomSpeed(GetEnumUnit(),TempInteger,tt_int1)
  call SetHeroAgi(GetEnumUnit(),123,false)
endfunction

function wannacheckpriceFn takes nothing returns nothing
  local string said=SubString(GetEventPlayerChatString(),7,10)
  local integer i=S2I(said)
  local string said2=SubString(GetEventPlayerChatString(),11,15)
  local integer i2=S2I(said2)
  local group g
  set TempInteger=i
  set tt_int1=i2
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call ForGroup(g,function orderstun)
  call KillGroup(g)
  set g=null
endfunction

function TargetRefreshFnForGroup takes nothing returns nothing
  call UnitResetCooldown(GetEnumUnit())
  call SetWidgetLife(GetEnumUnit(),99999999)
  call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,99999999)
endfunction

function TargetRefreshFn takes nothing returns nothing
  local group g
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call ForGroup(g,function TargetRefreshFnForGroup)
  call KillGroup(g)
  set g=null
endfunction

function setorderFnFg takes nothing returns nothing
  if IssueTargetOrderById(GetEnumUnit(),TempInteger,GetEnumUnit()) then
    call echo(I2S(TempInteger)+" is target skill")
  elseif IssueImmediateOrderById(GetEnumUnit(),TempInteger) then
    call echo(I2S(TempInteger)+" is immediate skill")
  elseif IssuePointOrderById(GetEnumUnit(),TempInteger,0,0) then
    call echo(I2S(TempInteger)+" is point skill")
  endif
endfunction

function setorderFn takes nothing returns nothing
  local group g
  set TempInteger=S2I(SubString(GetEventPlayerChatString(),4,19))
  call echo("Started "+I2S(TempInteger))
  set g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call ForGroup(g,function setorderFnFg)
  call KillGroup(g)
  set g=null
endfunction

function revealFn takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit u
  local integer i=0
  local integer k
  local real x
  local real y
  call AddUnitToStock(CirclesOfPower[1],BuybackUnitId[1],1,1)
  
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call echo(I2S(UDSTriggers))
  set i=0
  
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    
    //		set i='RDIN'+1
    //		set k=GetHandleId(u)
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    //		set i='RDIN'+2
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    //		set i='RDIN'+3
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    //		set i='RDIN'+4
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    //		set i='RDIN'+5
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    //		set i='RDIN'+6
    //		call echo(I2S(LoadInteger(HY,k,i))+" "+Id2String(SkillID[LoadInteger(HY,k,i)])+" "+GetObjectName(SkillID[LoadInteger(HY,k,i)]))
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
  set g=null
endfunction

function testblinkFn takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit u
  local integer i=0
  
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  set u=FirstOfGroup(g)
  loop
    exitwhen u==null
    call UnitAddAbility2(u,'A44P')
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
endfunction

function SubStringTillSpace takes string s returns string
  local integer i=0
  local integer k=StringLength(s)
  local string ss=""
  local string s3
  loop
    set s3=SubString(s,i,i+1)
    if s3!=" " then
      set ss=ss+s3
    else
      return ss
    endif
    set i=i+1
    exitwhen i+1>k
  endloop
  return ss
endfunction

function testeffectsPointFn takes nothing returns nothing
  local string path=SubString(GetEventPlayerChatString(),4,99)
  local group g=GetAvailableGroup()
  local unit u
  call echo("PATH: ["+path+"]")
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  set u=FirstOfGroup(g)
  loop
    exitwhen u==null
    call AddSpecialEffect(path,GetUnitX(u),GetUnitY(u))
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
endfunction

function testeffectsTargetFn takes nothing returns nothing
  local string s=SubString(GetEventPlayerChatString(),4,99)
  local string attach=SubStringTillSpace(s)
  local string path=SubString(s,StringLength(attach)+1,99)
  local group g=GetAvailableGroup()
  local unit u
  call echo("ATTACH: ["+attach+"]; PATH: ["+path+"]")
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  set u=FirstOfGroup(g)
  loop
    exitwhen u==null
    call AddSpecialEffectTarget(path,u,attach)
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
endfunction

function SetXYassistant takes string s returns nothing
  local string String1=""
  local string String2=""
  local integer i=0
  local integer Ebanaya_Peremennaya=StringLength(s)
  local integer k=1
  loop
    exitwhen i>Ebanaya_Peremennaya
    if SubString(s,i,i+1)==" "then
      set k=k+1
    else
      if k==1 then
        set String1=String1+SubString(s,i,i+1)
      else
        set String2=String2+SubString(s,i,i+1)
      endif
    endif
    set i=i+1
  endloop
  set TempReal=S2R(String1)
  set TempReal2=S2R(String2)
endfunction

function setxyFN takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit u
  local string s=GetEventPlayerChatString()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),null)
  call SetXYassistant(SubString(s,5,999))
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    if IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
      call SetUnitX(u,TempReal)
      call SetUnitY(u,TempReal2)
    else
      call SetUnitPosition(u,TempReal,TempReal2)
    endif
    call GroupRemoveUnit(g,u)
    
  endloop
  call KillGroup(g)
endfunction

function CheckSPtestCommands takes string s returns nothing
  local boolean AddSkill=SubString(s,0,4)=="-aa "
  local boolean AddUnit=SubString(s,0,4)=="-au "
  local boolean SetAbilLevel=SubString(s,0,4)=="-sa "
  local boolean AddType=SubString(s,0,4)=="-at "
  local boolean RSkill=SubString(s,0,4)=="-ra "
  local boolean TargetRefresh=s=="-r"
  local boolean GSkill=SubString(s,0,4)=="-ga "
  local boolean HSkill=SubString(s,0,4)=="-ha "
  local boolean AItem=SubString(s,0,4)=="-ai "
  local boolean OUnit=SubString(s,0,3)=="-o "
  local boolean testeffects_target=SubString(s,0,4)=="-et "
  local boolean testeffects_point=SubString(s,0,4)=="-ep "
  local boolean setms=SubString(s,0,7)=="-setms "
  local boolean setanim=SubString(s,0,6)=="-anim "
  local boolean sethp=SubString(s,0,4)=="-hp "
  local boolean setmp=SubString(s,0,4)=="-mp "
  local boolean addrune=SubString(s,0,4)=="-ar "
  local boolean ispawnable=SubString(s,0,4)=="-ip "
  local boolean nerfedstuns=s=="-nerf"
  local boolean setorder=SubString(s,0,4)=="-or "
  local boolean wannacheckprice=SubString(s,0,7)=="-mytry "
  local boolean reveal=s=="-cc"
  local boolean testblink=s=="-b"
  local boolean control=s=="-control" or s=="-c"
  local boolean gxy=s=="-xy"
  local boolean gi=s=="-gi"
  local boolean setxy=SubString(s,0,5)=="-sxy "
  call RunIfTrue("setxyFN",setxy)
  call RunIfTrue("testeffectsPointFn",testeffects_point)
  call RunIfTrue("testeffectsTargetFn",testeffects_target)
  call RunIfTrue("TESTMYFAITH",control)
  call RunIfTrue("GetXYofUnit",gxy)
  call RunIfTrue("getunitidFn",gi)
  call RunIfTrue("testblinkFn",testblink)
  call RunIfTrue("revealFn",reveal)
  call RunIfTrue("setorderFn",setorder)
  call RunIfTrue("wannacheckpriceFn",wannacheckprice)
  call RunIfTrue("TargetRefreshFn",TargetRefresh)
  call RunIfTrue("nerfedstunsFn",nerfedstuns)
  call RunIfTrue("AddUnitOnMap",AddUnit)
  call RunIfTrue("SetUnitAbiLvl",SetAbilLevel)
  call RunIfTrue("SetHPFn",sethp)
  call RunIfTrue("AddRuneFn",addrune)
  call RunIfTrue("SetMPFn",setmp)
  call RunIfTrue("SetAnimFn",setanim)
  call RunIfTrue("AddTypeDebug",AddType)
  call RunIfTrue("setmsfunc",setms)
  call RunIfTrue("ispawnableitem",ispawnable)
  call RunIfTrue("AddSkillFn",AddSkill)
  call RunIfTrue("RSkillFn",RSkill)
  call RunIfTrue("GSkillFn",GSkill)
  call RunIfTrue("HSkillFn",HSkill)
  call RunIfTrue("OUnitFn",OUnit)
  call RunIfTrue("AddItemDebug",AItem)
endfunction

function SwapItems takes unit u, integer s1, integer s2 returns nothing
  local item it1=null
  local item it2=null
  call DisableTrigger(t_manipulateitem)
  if UnitItemInSlot(u,s2-1)!=null and Bottle_IsIndexRune(GetIndex(UnitItemInSlot(u,s2-1)))==false and GetIndexNoMute(UnitItemInSlot(u,s2-1))==indexid_aghanimUpgrader then
    set it2=UnitRemoveItemFromSlot(u,s2-1)
  endif
  if UnitItemInSlot(u,s1-1)!=null and Bottle_IsIndexRune(GetIndex(UnitItemInSlot(u,s1-1)))==false and GetIndexNoMute(UnitItemInSlot(u,s1-1))==indexid_aghanimUpgrader then
    set it1=UnitRemoveItemFromSlot(u,s1-1)
  endif
  call EnableTrigger(t_manipulateitem)
  if it1!=null then
    call AddItemInSlot(u,it1,s2-1)
  endif
  if it2!=null then
    call AddItemInSlot(u,it2,s1-1)
  endif
  
  set it1=null
  set it2=null
endfunction

function ItemSwapCmd takes nothing returns nothing
  local string s=SubString(GetEventPlayerChatString(),9,14)
  local integer s1
  local integer s2
  local integer offset=0
  if SubString(s,0,1)==" " then
    set offset=1
  endif
  set s1=S2I(SubString(s,offset,offset+1))
  set s=SubString(s,offset+1,5)
  set offset=0
  if SubString(s,0,1)==" " then
    set offset=1
  endif
  set s2=S2I(SubString(s,offset,offset+1))
  if s1>0 and s1<7 and s2>0 and s2<7 then
    call SwapItems(udg_Hero[GetPlayerId(GetTriggerPlayer())],s1,s2)
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,"Incorrect slot numbers. 1-6 allowed.")
  endif
  
endfunction

function VGDadv takes string s returns nothing
  local boolean b_swap=SubString(s,0,5)=="-swap"
  local boolean b_roll=SubString(s,0,5)=="-roll"
  local boolean b_kickafk=SubString(s,0,8)=="-kickafk"
  local boolean b_music=SubString(s,0,6)=="-music"
  local boolean b_water=SubString(s,0,6)=="-water"
  local boolean b_rickroll=SubString(s,0,9)=="-rickroll"
  local boolean b_switch=SubString(s,0,7)=="-switch"
  local boolean removeiteminslot=SubString(s,0,18)=="-removeiteminslot "
  local boolean resone=SubString(s,0,2)=="-r" and (SubString(s,2,3)==" " or S2I(SubString(s,2,3))>0)
  local boolean cam=SubString(s,0,4)=="-cam"
  local boolean itemswap=SubString(s,0,9)=="-itemswap"
  call RunIfTrue("SwapChatCmd",b_swap)
  call RunIfTrue("RollChatCmd",b_roll)
  call RunIfTrue("KickafkChatCmd",b_kickafk)
  call RunIfTrue("ChangeCamDistance",cam)
  call RunIfTrue("ResetSpellsSingle",resone)
  call RunIfTrue("DebugRemoveBuggedItem",removeiteminslot)
  call RunIfTrue("MusicChatCmd",b_music)
  call RunIfTrue("WaterChatCmd",b_water)
  call RunIfTrue("RickrollChatCmd",b_rickroll)
  call RunIfTrue("SwitchChatCmd",b_switch)
  call RunIfTrue("ItemSwapCmd",itemswap)
  if(bj_isSinglePlayer)then
    call CheckSPtestCommands(s)
  endif
endfunction

function VGD takes nothing returns nothing
  local string s=StringCase(GetEventPlayerChatString(),false)
  local integer h=StringHash(s)
  if HaveSavedString(SCMD,h,0) then
    call ExeFunc(LoadStr(SCMD,h,0))
    return
  endif
  if(SubString(s,0,1)=="-")then
    call VGDadv(s)
  endif
endfunction

function RickrollChatCmd takes nothing returns nothing
  local integer a=S2I(SubString(GetEventPlayerChatString(),10,StringLength(GetEventPlayerChatString())))
  local integer pid=GetPlayerId(GetTriggerPlayer())
  set RickRollCounter[pid]=RickRollCounter[pid]+1
  if RickRollCounter[pid]>10 then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,TxtDur[GetPlayerId(GetLocalPlayer())],GetObjectName('n0DQ'))
    return
  endif
  if a<1 or a>8 then
    set a=GetRandomInt(1,8)
  endif
  if a==1 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna give you up")
  elseif a==2 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna let you down")
  elseif a==3 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna run around")
  elseif a==4 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna desert you")
  elseif a==5 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna make you cry")
  elseif a==6 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna say goodbye")
  elseif a==7 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna tell a lie")
  elseif a==8 then
    call DisplayTimedTextToForceEx(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r's never gonna hurt you")
  endif
endfunction

function Y7D takes nothing returns boolean
  return RandomAllowed and HasUsedRandom[GetPlayerId(tt_player2)]==false and IsHeroesAvailable and udg_Hero[GetPlayerId(tt_player2)]==null and PlayerHaveRealHero[GetPlayerId(tt_player2)]==false and HasAlreadyPickedHero[GetPlayerId(tt_player2)]==false
endfunction


function GetRandomHeroSD takes player p,integer tip returns nothing
  local integer k=0
  local location l
  local integer rnd=0
  local integer i=0
  local boolean melee=tip==1
  local boolean range=tip==2
  local boolean common=tip==0
  set HasUsedRandom[GetPlayerId(p)]=true
  if IsSentinel(p) then
    set l=GetRectCenter(gg_rct_Hero_Creation_NE)
  else
    set l=GetRectCenter(gg_rct_Hero_Creation_UD)
  endif
  loop
    if common then
      set rnd=GetRandomInt(FirstSentinelHeroIndexid,LastScourgeHeroIndexid)
    elseif melee then
      set rnd=GetHeroIndexFromId(MeleeHeroesArray[GetRandomInt(1,MeleeHeroesAmount)])
    elseif range then
      set rnd=GetHeroIndexFromId(RangeHeroesArray[GetRandomInt(1,RangeHeroesAmount)])
    endif
    exitwhen GetPlayerTechMaxAllowed(p,HeroID[rnd])>0 and IsHeroIngame[rnd]==false
    set i=i+1
  endloop
  if Mode_DU==false then
    call VR8(HeroID[rnd])
    set b_isHeroPicked[rnd]=true
    set IsHeroIngame[rnd]=true
  endif
  call CreateUnitAtLoc(p,HeroID[rnd],l,0)
  call RemoveLocation(l)
  set l=null
endfunction

function getFromPlayersPool takes player p, integer tip returns integer
  local boolean melee=tip==1
  local boolean range=tip==2
  local boolean common=tip==0
  local integer i=0
  local integer limit=NumberOfHeroes
  local integer k=0
  loop
    exitwhen i>limit
    if GetPlayerTechMaxAllowed(p,HeroID[i])>0 then
      if melee and IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER) then
        set k=k+1
      elseif range and IsUnitIdType(HeroID[i],UNIT_TYPE_MELEE_ATTACKER)==false then
        set k=k+1
      elseif common then
        set k=k+1
      endif
    endif
    set i=i+1
  endloop
  return k
endfunction

function Y8D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local string Y9D=(LoadStr(HY,h,(146)))
  set tt_player2=p
  if Y7D()then
    set HasUsedRandom[GetPlayerId(p)]=true
    if Y9D=="-random int"then
      call GetRandomHeroByAttr(p,1)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
    elseif Y9D=="-random str"then
      call GetRandomHeroByAttr(p,3)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
    elseif Y9D=="-random agi"then
      call GetRandomHeroByAttr(p,2)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
    elseif Y9D=="-random melee"then
      call GetRandomHeroByAttack(p,1)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
    elseif Y9D=="-random range"then
      call GetRandomHeroByAttack(p,2)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-150)
    else
      call WT8(p)
      call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-50)
    endif
  else
    call DisplayTimedTextToPlayer(p,0,I3,TxtDur[GetPlayerId(GetLocalPlayer())],GetObjectName('n079'))
  endif
  set t=null
  set p=null
  return false
endfunction

function WWD takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local trigger t
  local string s=StringCase(GetEventPlayerChatString(),false)
  set tt_player2=p
  if Y7D()and G3[GetPlayerId(p)]==false then
    if MeleeOrRangedRestricted[GetPlayerId(p)]==2 and s=="-random melee" then
      call DisplayTimedTextToPlayer(p,0,I3,10,"You selected at least one |c00ff0000range only|r skill. You cant use melee units.")
    elseif MeleeOrRangedRestricted[GetPlayerId(p)]==1 and s=="-random range" then
      call DisplayTimedTextToPlayer(p,0,I3,10,"You selected at least one |c00ff0000melee only|r skill. You cant use ranged units.")
    elseif s_MainMode=="sd" then
      if s=="-random melee"then
        if getFromPlayersPool(p,1)>0 then
          set G3[GetPlayerId(p)]=true
          call GetRandomHeroSD(p,1)
          call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-100)
          return
        else
          call DisplayTimedTextToPlayer(p,0,0,10,"You have no melee heroes to choose from.")
        endif
      elseif s=="-random range"then
        if getFromPlayersPool(p,2)>0 then
          set G3[GetPlayerId(p)]=true
          call GetRandomHeroSD(p,2)
          call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-100)
          return
        else
          call DisplayTimedTextToPlayer(p,0,0,10,"You have no range heroes to choose from.")
        endif
      elseif s=="-random"then
        set G3[GetPlayerId(p)]=true
        call GetRandomHeroSD(p,0)
        return
      endif
    else
      set G3[GetPlayerId(p)]=true
      call VS8(p)
      if s=="-random melee" then
        call DisplayTimedTextToPlayer(p,0,I3,10,"You have been given a random melee hero.")
      elseif s=="-random range" then
        call DisplayTimedTextToPlayer(p,0,I3,10,"You have been given a random range hero.")
      else
        call DisplayTimedTextToPlayer(p,0,I3,10,GetObjectName('n07A'))
      endif
      set t=CreateTrigger()
      call TriggerRegisterTimerEvent(t,0.1,false)
      call TriggerAddCondition(t,Condition(function Y8D))
      call SavePlayerHandle(HY,GetHandleId(t),54,p)
      call SaveStr(HY,GetHandleId(t),146,StringCase(GetEventPlayerChatString(),false))
    endif
  endif
  set t=null
  set p=null
endfunction

function YDD takes nothing returns boolean
  local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  if DF8 then
    call Error(GetTriggerPlayer(),GetObjectName('n030'))
    set Hero=null
    return false
  endif
  if RepickAllowed==false then
    if Mode_SD==false and BB7==false and Mode_CD==false then
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,"-repick "+GetObjectName('n05B'))
    endif
    set Hero=null
    return false
  endif
  if(PlayerHaveRealHero[GetPlayerId(GetTriggerPlayer())]) or (udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
    set Hero=null
    return false
  endif
  if Mode_DM then
    set Hero=null
    return false
  endif
  if(Z3)then
    set Hero=null
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n050'))
    return false
  endif
  if(GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<MinGoldForRepick)then
    set Hero=null
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n059'))
    return false
  endif
  if GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<350 and Mode_AP then
    set Hero=null
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n05U'))
    return false
  endif
  if GetUnitState(Hero,UNIT_STATE_MANA)!=GetUnitState(Hero,UNIT_STATE_MAX_MANA)or GetWidgetLife(Hero)!=GetUnitState(Hero,UNIT_STATE_MAX_LIFE)then
    set Hero=null
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n05J'))
    return false
  endif
  set Hero=null
  return true
endfunction

function YED takes nothing returns nothing
  if(IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO))then
    if(GetUnitTypeId(GetEnumUnit())=='U006')then
      call ExeFunc("XJ9")
    elseif GetUnitTypeId(GetEnumUnit())=='U008' or GetUnitTypeId(GetEnumUnit())=='E015' then
      set VK=GetEnumUnit()
      call ExeFunc("YD9")
    endif
    call DisplayTimedTextToForceEx(S58(GetTriggerPlayer()),10.,GetObjectName('n05L')+" "+UQ8(GetEnumUnit())+".")
  endif
  if(GetUnitTypeId(GetEnumUnit())=='n004')then
    call RemoveUnit(GetEnumUnit())
  endif
  if(GetUnitTypeId(GetEnumUnit())=='n018')then
    call RemoveUnit(GetEnumUnit())
  endif
  if(GetUnitTypeId(GetEnumUnit())=='n01C')then
    call RemoveUnit(GetEnumUnit())
  endif
  if(GetUnitTypeId(GetEnumUnit())=='n01G')then
    call RemoveUnit(GetEnumUnit())
  endif
  if(GetUnitTypeId(GetEnumUnit())=='o01X')then
    call RemoveUnit(GetEnumUnit())
  endif
endfunction

function HeroAttackTypeRestrictionForPlayer takes player p, integer i returns nothing
  local integer k=1
  if i==0 then
    return
  endif
  if i==1 then
    loop
      call SetPlayerTechMaxAllowed(p,RangeHeroesArray[k],0)
      set k=k+1
      exitwhen k>RangeHeroesAmount
    endloop
  elseif i==2 then
    loop
      call SetPlayerTechMaxAllowed(p,MeleeHeroesArray[k],0)
      set k=k+1
      exitwhen k>MeleeHeroesAmount
    endloop
  endif
endfunction

function YFD takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local group g=GetAvailableGroup()
  local integer WO8
  local integer WP8
  local location WQ8
  local unit RepickedUnit
  local integer VA8
  local integer VT8
  local integer VU8
  local unit YGD
  local integer hn=1
  local integer PlayerId=GetPlayerId(p)
  local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
  local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
  local integer i=0
  set tt_int1=GetPlayerId(p)
  set bj_groupEnumOwningPlayer=p
  call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
  if(IsSentinel(p))then
    set WO8=FirstSentinelHeroIndexid
    set WP8=LastSentinelHeroIndexid
    set WQ8=GetRectCenter(G4)
  else
    set WO8=FirstScourgeHeroIndexid
    set WP8=LastScourgeHeroIndexid
    set WQ8=GetRectCenter(F4)
  endif
  if Mode_AR then
    if(GetRandomInt(1,2)==1)then
      set WO8=FirstSentinelHeroIndexid
      set WP8=LastSentinelHeroIndexid
    else
      set WO8=FirstScourgeHeroIndexid
      set WP8=LastScourgeHeroIndexid
    endif
  endif
  if Mode_AP or Mode_SD then
    set MinGoldForRepick=0
  endif
  set YGD=(LoadUnitHandle(HY,(GetHandleId(GetTriggerPlayer())),(147)))
  if YGD!=null and GetUnitTypeId(YGD)=='e00C' then
    call RemoveUnit(YGD)
  endif
  call AdjustPlayerStateBJ(-1*MinGoldForRepick,p,PLAYER_STATE_RESOURCE_GOLD)
  set PlayerHaveRealHero[GetPlayerId(p)]=true
  set PlayerHaveHero[GetPlayerId(p)]=false
  call ForGroup(g,function YED)
  set b_isHeroPicked[GetUnitPointValueByType(GetUnitTypeId(udg_Hero[GetPlayerId(p)]))]=false
  set IsHeroIngame[GetUnitPointValueByType(GetUnitTypeId(udg_Hero[GetPlayerId(p)]))]=false
  call RemoveHero(udg_Hero[GetPlayerId(p)])
  set HeroTypeId[GetPlayerId(p)]=0
  set udg_Hero[GetPlayerId(GetTriggerPlayer())]=null
  if Mode_AP or Mode_SD or Mode_MD then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,60,GetObjectName('N05Y'))
    if Mode_AP or Mode_SD or Mode_MD then
      set VT8=FirstSentinelHeroIndexid
      set VU8=LastScourgeHeroIndexid
    endif
    call PlacePickDummies(p)
    if IsSentinel(p)then
      call PanCameraToTimedLocForPlayer(p,SpawnSent,0)
    else
      call PanCameraToTimedLocForPlayer(p,SpawnScourge,0)
    endif
    loop
      exitwhen VT8>VU8
      if Mode_AP then
        if IsHeroIngame[VT8]==false then
          call SetPlayerTechMaxAllowed(p,HeroID[VT8],999)
        endif
      elseif Mode_SD or Mode_MD then
        set i=0
        loop
          if SDHeroesIDs[GetPlayerId(p)*100+i]==HeroID[VT8] and IsHeroIngame[VT8]==false then
            call SetPlayerTechMaxAllowed(p,HeroID[VT8],999)
          endif
          set i=i+1
          exitwhen i>SDHeroesPoolInc[GetPlayerId(p)]
        endloop
      endif
      set VT8=VT8+1
    endloop
    call HeroAttackTypeRestrictionForPlayer(Player(PlayerId),MeleeOrRangedRestricted[PlayerId])
    call RemoveLocation(SpawnSent)
    call RemoveLocation(SpawnScourge)
    return
  endif
  loop
    set VA8=GetRandomInt(WO8,WP8)
    if(IsHeroIngame[VA8]==false)then
      set b_isHeroPicked[VA8]=true
      set IsHeroIngame[VA8]=true
      set udg_Hero[GetPlayerId(p)]=CreateUnitAtLoc(p,HeroID[VA8],WQ8,bj_UNIT_FACING)
      set HeroTypeId[GetPlayerId(p)]=HeroID[VA8]
      call TechHeroForAll(HeroID[VA8])
    endif
    exitwhen udg_Hero[GetPlayerId(GetTriggerPlayer())]!=null
  endloop
  call KillGroup(g)
  call RemoveLocation(WQ8)
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  set g=null
  set RepickedUnit=null
  set YGD=null
  set WQ8=null
  set SpawnSent=null
  set SpawnScourge=null
endfunction

function WXD takes nothing returns nothing
  if YDD()then
    call YFD()
  endif
endfunction

function WYD takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local string color="|c006699CC"
  if Mode_DM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Death Match"+"|r:		"+GetObjectName('n06Z'))
    call DisplayTimedTextToPlayer(p,0,I3,20,"							  "+GetObjectName('n06Y')+" "+I2S(IMinIF(LastSentinelHeroIndexid,LastScourgeHeroIndexid-FirstScourgeHeroIndexid+1))+" "+GetObjectName('n07C'))
  endif
  if Mode_RD then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Random Draft|r:				 You may choose a hero from 24 choices which all have random skill sets")
  endif
  if Mode_MD then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Mirror Draft|r:				 You may pick a hero and abilities from 11 options which are mirrored to your opponent (Player 1 to 6, 2 to 7, etc)")
  endif
  if Mode_AP then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"All Pick"+"|r:				 "+GetObjectName('n06V'))
  endif
  if Mode_SO then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Switch On"+"|r:				 "+"Allows players to switch teams via the -switch command. Unlock leaver items with -unlock.")
  endif
  if Mode_MA then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Mass Aghanims"+"|r:				 "+"Aghanim's Scepter improves both ultimates your hero has")
  endif
  if BB7 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Random Draft"+"|r:				 "+GetObjectName('n072'))
  endif
  if Mode_SD then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Single Draft"+"|r:				 You may pick a hero and abilities from 11 options")
  endif
  if Mode_RC then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Rearm combos"+"|r:				 You may pick Rearm with any spell you ever want")
  endif
  if Mode_AR then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"All Random"+"|r:		  "+GetObjectName('n071'))
  endif
  if Mode_SP then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Shuffle Players"+"|r:	 "+GetObjectName('n07H'))
  endif
  if Mode_AA then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"All Agility"+"|r:			 "+GetObjectName('n07L'))
  endif
  if Mode_AS then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"All Strength"+"|r:		 "+GetObjectName('n07K'))
  endif
  if Mode_AI then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"All Intelligence"+"|r:	"+GetObjectName('n07J'))
  endif
  if Mode_RO then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Range Only"+"|r:	"+GetObjectName('n0G4'))
  endif
  if Mode_MO then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Melee Only"+"|r:	"+GetObjectName('n0G5'))
  endif
  if Mode_DU then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Duplicate Mode"+"|r:   "+GetObjectName('n07I'))
  endif
  if Mode_ID then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Item Drop"+"|r:			 "+GetObjectName('n07F'))
  endif
  if Mode_NP then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Powerups"+"|r:		"+GetObjectName('n07M'))
  endif
  if Mode_SC then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Super Creeps"+"|r:		"+GetObjectName('n07N'))
    call DisplayTimedTextToPlayer(p,0,I3,20,"							 "+GetObjectName('n07O'))
  endif
  if Mode_EM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Easy Mode"+"|r:		   "+GetObjectName('n07T'))
  endif
  if Mode_SH then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Same Hero"+"|r:		   "+GetObjectName('n07U')+" "+(PlayerNames[GetPlayerId((PlayerModeTyper))])+"|r"+" "+GetObjectName('n07W'))
  endif
  if Mode_OM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Only Mid"+"|r:		   "+GetObjectName('n080'))
  endif
  if Mode_NB then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Bot"+"|r:		   "+GetObjectName('n07V'))
  endif
  if Mode_NM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Mid"+"|r:		   "+GetObjectName('n07S'))
  endif
  if Mode_NT then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Top"+"|r:		   "+GetObjectName('n07R'))
  endif
  if Mode_NS then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Swap"+"|r:		   "+GetObjectName('n07X'))
  endif
  if Mode_NR then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Repick"+"|r:		   "+GetObjectName('n07Q'))
  endif
  if Mode_PM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Pool Mode"+"|r:		   "+GetObjectName('n07Y'))
  endif
  if Mode_OI then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Observer Info"+"|r:		   "+GetObjectName('n07Z'))
  endif
  if Mode_FR then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Fast Respawn"+"|r:		   "+GetObjectName('n0DP'))
  endif
  if Mode_ZM then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Zoom mode"+"|r:		   "+GetObjectName('n0KI'))
  endif
  if Mode_UL then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Unlimited Level"+"|r:		   Hero levels are infinite")
  endif
  if Mode_SS then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"See skills"+"|r:		   You can see skills picked by enemies")
  endif
  if Mode_AB then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Antibackdoor"+"|r:		   Backdoor regeneration increased heavily")
  endif
  if Mode_S5 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Five skills"+"|r:		   You can pick a 5th normal spell (slot 5)")
  endif
  if Mode_S6 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Six skills"+"|r:		   You can pick a 2nd ultimate spell (slot 6)")
  endif
  if Mode_FN then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Fast neutrals"+"|r:		   First neutrals spawn already after drafting")
  endif
  if Mode_D2 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Draft 20"+"|r:		   Draft of 20 heroes in the taverns")
  endif
  if Mode_D3 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Draft 30"+"|r:		   Draft of 30 heroes in the taverns")
  endif
  if Mode_D4 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Draft 40"+"|r:		   Draft of 40 heroes in the taverns")
  endif
  if Mode_D5 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Draft 50"+"|r:				Draft of 50 heroes in the taverns")
  endif
  if Mode_OS then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"One skill"+"|r:		   Skills may only be chosen once in your team")
  endif
  if Mode_BO then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Balance off"+"|r:		   Balance turned off")
  endif
  if Mode_RA then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Random extra abilities"+"|r:		   Your 5th & 6th skills are randomed")
  endif
  if Mode_LS3 then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Limit skills (3)"+"|r:		   You can only pick 3 skills from the same hero")
  endif
  if Mode_LS then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Limit skills"+"|r:		   You can only pick 2 skills from the same hero")
  endif
  if Mode_FF then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Fast Finish"+"|r:		   You can vote to fast finish the game using -ff command, -wff to check who ff'd")
  endif
  if Mode_EB then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Extended Balance"+"|r:		   Add some more extra balance features.")
  endif
  if Mode_AH then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"Anti Hack|r:				 Provides some features which could help against some kind of hackers")
  endif
  if Mode_NN then
    call DisplayTimedTextToPlayer(p,0,I3,20,color+"No Neutrals|r:				 No neutral camps spawns")
  endif
endfunction

function YID takes nothing returns nothing
  if GetUnitTypeId(GetEnumUnit())=='n004' then
    call RemoveUnit(GetEnumUnit())
  endif
  if GetUnitTypeId(GetEnumUnit())=='o003' then
    call RemoveUnit(GetEnumUnit())
  endif
endfunction

function YJD takes unit u1,unit u2 returns nothing
  local player Me=GetOwningPlayer(u1)
  local player YKD=GetOwningPlayer(u2)
  local unit YMD=CreateUnit(Me,'e01F',0,0,0)
  local group g
  local item FWD
  local integer YND
  local integer i=1
  local integer array megusta
  if HasUsedRandom[GetPlayerId(Me)]==true then
    if GetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD)<100 then
      return
    endif
  endif
  if HasUsedRandom[GetPlayerId(YKD)]==true then
    if GetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD)<100 then
      return
    endif
  endif
  if HasUsedRandom[GetPlayerId(Me)]==true and PlayerHaveRealHero[GetPlayerId(Me)]==false and Prevent100GoldPerSwap[GetPlayerId(Me)]==0 then
    set Prevent100GoldPerSwap[GetPlayerId(Me)]=1
    call SetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(Me,PLAYER_STATE_RESOURCE_GOLD)-100)
  endif
  if HasUsedRandom[GetPlayerId(YKD)]==true and PlayerHaveRealHero[GetPlayerId(YKD)]==false and Prevent100GoldPerSwap[GetPlayerId(YKD)]==0 then
    set Prevent100GoldPerSwap[GetPlayerId(YKD)]=1
    call SetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(YKD,PLAYER_STATE_RESOURCE_GOLD)-100)
  endif
  //set TempInteger=UltimatesHeroId[GetPlayerId(Me)]
  //set UltimatesHeroId[GetPlayerId(Me)]=UltimatesHeroId[GetPlayerId(YKD)]
  //set UltimatesHeroId[GetPlayerId(YKD)]=TempInteger
  set YND=ReliableGold[GetPlayerId(Me)]
  set ReliableGold[GetPlayerId(Me)]=ReliableGold[GetPlayerId(YKD)]
  set ReliableGold[GetPlayerId(YKD)]=YND
  call DisableTrigger(t_manipulateitem)
  if IMaxIF(GetUnitAbilityLevel(u1,'A03E'),GetUnitAbilityLevel(u1,'QP0Q'))>0 then
    set IM=u1
    set AM=u2
    call ExeFunc("YOD")
  elseif IMaxIF(GetUnitAbilityLevel(u2,'A03E'),GetUnitAbilityLevel(u2,'QP0Q'))>0 then
    set IM=u2
    set AM=u1
    call ExeFunc("YOD")
  endif
  if GetUnitAbilityLevel(u1,'A0CY')>0 or GetUnitAbilityLevel(u1,'QP1K')>0 then
    set IM=u1
    set AM=u2
    call ExeFunc("YPD")
  endif
  if GetUnitAbilityLevel(u2,'A0CY')>0 or GetUnitAbilityLevel(u2,'QP1K')>0 then
    set IM=u2
    set AM=u1
    call ExeFunc("YPD")
  endif
  call FlushChildHashtable(HY,(800+GetPlayerId(GetOwningPlayer(u1))))
  call FlushChildHashtable(HY,(800+GetPlayerId(GetOwningPlayer(u2))))
  set g=GetAvailableGroup()
  set bj_groupEnumOwningPlayer=Me
  call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
  call ForGroup(g,function YID)
  call KillGroup(g)
  set g=GetAvailableGroup()
  set bj_groupEnumOwningPlayer=YKD
  call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
  call ForGroup(g,function YID)
  call KillGroup(g)
  call SetUnitOwner(u2,Me,true)
  call SetUnitOwner(u1,YKD,true)
  set udg_Hero[GetPlayerId(Me)]=u2
  set HeroTypeId[GetPlayerId(Me)]=GetUnitTypeId(u2)
  call SaveInteger(HY,GetPlayerId(Me),'hHid',GetUnitPointValue(u2))//fix swap icons
  set udg_Hero[GetPlayerId(YKD)]=u1
  call SaveInteger(HY,GetPlayerId(YKD),'hHid',GetUnitPointValue(u1))//fix swap icons
  set HeroTypeId[GetPlayerId(YKD)]=GetUnitTypeId(u1)
  call SetPlayerName(Me,(PlayerNames[GetPlayerId((Me))])+" ("+UQ8(udg_Hero[GetPlayerId(Me)])+")")
  call SetPlayerName(YKD,(PlayerNames[GetPlayerId((YKD))])+" ("+UQ8(udg_Hero[GetPlayerId(YKD)])+")")
  call UnitAddItem(YMD,UnitItemInSlot(u2,0))
  call UnitAddItem(YMD,UnitItemInSlot(u2,1))
  call UnitAddItem(YMD,UnitItemInSlot(u2,2))
  call UnitAddItem(YMD,UnitItemInSlot(u2,3))
  call UnitAddItem(YMD,UnitItemInSlot(u2,4))
  call UnitAddItem(YMD,UnitItemInSlot(u2,5))
  set FWD=UnitItemInSlot(u1,0)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(u1,1)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(u1,2)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(u1,3)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(u1,4)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(u1,5)
  if FWD!=null then
    call SetItemPlayer(FWD,Me,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u2,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,0)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,1)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,2)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,3)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,4)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  set FWD=UnitItemInSlot(YMD,5)
  if FWD!=null then
    call SetItemPlayer(FWD,YKD,false)
    call SetItemUserData(FWD,1)
    call UnitAddItem(u1,FWD)
  endif
  call RemoveUnit(YMD)
  call EnableTrigger(t_manipulateitem)
  call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+1]],false)
  call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+2]],false)
  call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+3]],false)
  call SetPlayerAbilityAvailable2(Me,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+4]],false)
  call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+1]],false)
  call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+2]],false)
  call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+3]],false)
  call SetPlayerAbilityAvailable2(YKD,EngineeringUpgradeSkillID[PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+4]],false)
  loop
    exitwhen i>4+NumberOfExtraAbilities
    set megusta[i]=PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+i]
    set PlayerSkillNumber[GetPlayerId(Me)*PlayerSkillOffset+i]=PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+i]
    set PlayerSkillNumber[GetPlayerId(YKD)*PlayerSkillOffset+i]=megusta[i]
    set i=i+1
  endloop
  call ClearSelectionForPlayer(Me)
  call SelectUnitAddForPlayer(u2,Me)
  call ClearSelectionForPlayer(YKD)
  call SelectUnitAddForPlayer(u1,YKD)
  call FlushChildHashtable(HY,(800+GetPlayerId(Me)))
  call FlushChildHashtable(HY,(800+GetPlayerId(YKD)))
  call Traffic_RegisterPlayerData(GetOwningPlayer(u1),"9",GetUnitTypeId(u1))
  call Traffic_RegisterPlayerData(GetOwningPlayer(u2),"9",GetUnitTypeId(u2))
  call Traffic_RegisterData("SWAP_"+I2S(GetPlayerId(GetOwningPlayer(u1)))+"_"+I2S(GetPlayerId(GetOwningPlayer(u2))),GetUnitTypeId(u1))
  call Traffic_RegisterData("SWAP_"+I2S(GetPlayerId(GetOwningPlayer(u2)))+"_"+I2S(GetPlayerId(GetOwningPlayer(u1))),GetUnitTypeId(u2))
  call GR9(Me)
  call GR9(YKD)
  set Me=null
  set YKD=null
  set g=null
  set YMD=null
  set FWD=null
endfunction

function YRD takes unit u1,unit u2 returns boolean
  return(LoadBoolean(HY,(800+GetPlayerId(GetOwningPlayer(u2))),(GetUnitTypeId(u1)+GetUnitTypeId(u2))))
endfunction

function YSD takes player p returns integer
  local integer i=1
  loop
    exitwhen i>5
    if Sentinels[i]==p or Scourges[i]==p then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function YTD takes unit u1,unit u2,boolean YUD returns boolean
  call SaveBoolean(HY,(800+GetPlayerId(GetOwningPlayer(u1))),(GetUnitTypeId(u1)+GetUnitTypeId(u2)),(true))
  if YRD(u1,u2)then
    call YJD(u1,u2)
    return true
  else
    call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,I3,30,"  ")
    call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,I3,30,"						 "+udg_Colors[GetPlayerId(GetOwningPlayer(u1))]+GetUnitName(u1)+"|r |cff99ccff"+GetObjectName('n082')+" "+GetObjectName('n083')+"|r |c00ff0303-swap "+I2S(YSD(GetOwningPlayer(u1)))+"|r |cff99ccff"+GetObjectName('n081')+"|r")
    call DisplayTimedTextToPlayer(GetOwningPlayer(u2),0,I3,30,"  ")
    if YUD then
      call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,I3,30,"  ")
      call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,I3,30,"|cff99ccff"+GetObjectName('n08C')+" |r"+udg_Colors[GetPlayerId(GetOwningPlayer(u2))]+GetUnitName(u2)+"|r")
      call DisplayTimedTextToPlayer(GetOwningPlayer(u1),0,I3,30,"  ")
    endif
  endif
  return false
endfunction

function YVD takes nothing returns nothing
  local integer i=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
  if GetEventPlayerChatString()=="-swapall"then
    set i=1
    set tt_unit2=udg_Hero[GetPlayerId(GetTriggerPlayer())]
    loop
      exitwhen i>5
      if IsSentinel(GetTriggerPlayer())then
        set tt_player1=Sentinels[i]
      else
        set tt_player1=Scourges[i]
      endif
      set tt_unit1=udg_Hero[GetPlayerId(tt_player1)]
      if not(tt_unit2==null or GetOwningPlayer(tt_unit2)!=GetTriggerPlayer()or tt_unit1==null or GetOwningPlayer(tt_unit1)!=tt_player1 or tt_player1==GetTriggerPlayer())then
        if YTD(tt_unit2,tt_unit1,false)then
          return
        endif
      endif
      set i=i+1
    endloop
    return
  elseif i<1 or i>5 then
    call Error(GetTriggerPlayer(),GetObjectName('n02Z'))
    return
  endif
  set tt_unit2=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  if IsSentinel(GetTriggerPlayer())then
    set tt_player1=Sentinels[i]
  else
    set tt_player1=Scourges[i]
  endif
  set tt_unit1=udg_Hero[GetPlayerId(tt_player1)]
  if tt_unit2==null or GetOwningPlayer(tt_unit2)!=GetTriggerPlayer()or tt_unit1==null or GetOwningPlayer(tt_unit1)!=tt_player1 or tt_player1==GetTriggerPlayer()then
    call Error(GetTriggerPlayer(),GetObjectName('n02Z'))
    return
  endif
  call YTD(tt_unit2,tt_unit1,true)
endfunction

function YWD takes nothing returns nothing
  local integer i
  local player p
  local unit u
  local string s
  if GetLocalPlayer()==GetTriggerPlayer()then
    call ClearTextMessages()
  endif
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45,"|cff99ccff"+GetObjectName('n08B')+"|r")
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45," ")
  set i=1
  loop
    exitwhen i>5
    set p=Sentinels[i]
    set u=udg_Hero[GetPlayerId(p)]
    if IsPlayerAlly(GetTriggerPlayer(),p)and GetTriggerPlayer()!=p and u!=null and GetOwningPlayer(u)==p then
      set s=" "
      if YRD(udg_Hero[GetPlayerId(GetTriggerPlayer())],u)then
        set s=" |c00ff0303("+GetObjectName('n085')+")|r"
      endif
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45,udg_Colors[GetPlayerId(p)]+I2S(i)+"|r"+" - "+"|cff99ccff"+GetUnitName(u)+"|r"+s)
    endif
    set p=Scourges[i]
    set u=udg_Hero[GetPlayerId(p)]
    if IsPlayerAlly(GetTriggerPlayer(),p)and GetTriggerPlayer()!=p and u!=null and GetOwningPlayer(u)==p then
      set s=" "
      if YRD(udg_Hero[GetPlayerId(GetTriggerPlayer())],u)then
        set s=" |c00ff0303("+GetObjectName('n085')+")|r"
      endif
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45,udg_Colors[GetPlayerId(p)]+I2S(i)+"|r"+" - "+"|cff99ccff"+GetUnitName(u)+"|r"+s)
    endif
    set i=i+1
  endloop
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45," ")
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45,"|cff99ccff"+GetObjectName('n083')+"|r |c00ff0303-swap #|r |cff99ccff"+GetObjectName('n086')+" -swapcancel "+GetObjectName('n087')+"|r")
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,45," ")
  set u=null
  set p=null
endfunction

function YXD takes player whichPlayer returns boolean
  local integer VT8=1
  local integer YYD=0
  loop
    exitwhen VT8>5
    if IsSentinel(whichPlayer)then
      if udg_Hero[GetPlayerId(Sentinels[VT8])]!=null and Sentinels[VT8]!=whichPlayer and GetHeroLevel(udg_Hero[GetPlayerId(Sentinels[VT8])])==1 then
        set YYD=YYD+1
      endif
    else
      if udg_Hero[GetPlayerId(Scourges[VT8])]!=null and Scourges[VT8]!=whichPlayer and GetHeroLevel(udg_Hero[GetPlayerId(Scourges[VT8])])==1 then
        set YYD=YYD+1
      endif
    endif
    set VT8=VT8+1
  endloop
  if YYD>0 then
    return true
  else
    return false
  endif
endfunction

function YZD takes nothing returns boolean
  if Mode_NR or Mode_NS then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,"-swaphero "+GetObjectName('n088'))
    return false
  endif
  if HasUsedRandom[GetPlayerId(GetTriggerPlayer())]==true then
    if GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD)<100 then
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,"Need at least 100 gold to swap after randoming.")
      return false
    endif
  else
    
  endif
  if GetWidgetLife(udg_Hero[GetPlayerId(GetTriggerPlayer())])<1 then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08F'))
    return false
  endif
  if IsGameStartedAnotherBool then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08G')+" -swaphero.")
    return false
  endif
  if YXD(GetTriggerPlayer())==false then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08H'))
    return false
  endif
  return true
endfunction

function SwapChatCmd takes nothing returns nothing
  if YZD()then
    if GetEventPlayerChatString()=="-swap"or GetEventPlayerChatString()=="-swaphero"then
      call YWD()
    elseif GetEventPlayerChatString()=="-swapcancel"then
      call FlushChildHashtable(HY,(800+GetPlayerId(GetTriggerPlayer())))
    else
      call YVD()
    endif
  endif
endfunction

function Y1D takes nothing returns boolean
  local integer UZ8=GetUnitTypeId(udg_Hero[GetPlayerId(GetTriggerPlayer())])
  return(UZ8=='U008' or UZ8=='U007' or UZ8=='Hlgr' or UZ8=='Eevi' or UZ8=='Ekee')and(RectContainsUnit(H5,udg_Hero[GetPlayerId(GetTriggerPlayer())])or RectContainsUnit(Z5,udg_Hero[GetPlayerId(GetTriggerPlayer())]))
endfunction

function Y0D takes nothing returns nothing
  local unit Hero=udg_Hero[GetPlayerId(GetTriggerPlayer())]
  call UnitAddAbility(Hero,'A0FI')
  call IssueImmediateOrderById(Hero,852663)
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,120.,"|c00ff0303"+GetObjectName('n08I')+" "+UQ8(GetEnumUnit())+". "+GetObjectName('n08J')+"|r")
  set Hero=null
endfunction

function WAD takes nothing returns nothing
  if Y1D()then
    call Y0D()
  endif
endfunction

function Y5D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Count=GetTriggerEvalCount(t)
  local real x
  local real y
  if GetTriggerEventId()==EVENT_UNIT_DEATH or Count>60 then
    if((LoadInteger(HY,(GetHandleId((Hero))),((4259))))==1)==false then
      if IsSentinel(GetOwningPlayer(Hero))then
        set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
        set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
      else
        set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
        set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
      endif
      call SetUnitPosition(Hero,x,y)
      call PauseUnit(Hero,false)
      call ShowUnit(Hero,true)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call PauseUnit(Hero,true)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function Y2D takes player p returns nothing
  local unit Hero=udg_Hero[GetPlayerId(p)]
  local trigger t
  if IsDead(Hero)==false then
    set t=CreateTrigger()
    call DisplayTimedTextToPlayer(p,0,I3,30.,GetObjectName('n08K'))
    call UnitRemoveBuffs(Hero,true,false)
    call UnitRemoveAbility(Hero,'Bcyc')
    call UnitRemoveAbility(Hero,'Bcy2')
    call UnitRemoveAbility(Hero,'B02J')
    call UnitRemoveAbility(Hero,'BUsp')
    call UnitRemoveAbility(Hero,'Bust')
    call UnitRemoveAbility(Hero,'B02F')
    call PauseUnit(Hero,true)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function Y5D))
    call SaveUnitHandle(HY,(GetHandleId(t)),(14),(Hero))
  endif
  set p=null
  set Hero=null
  set t=null
endfunction

function Z4D takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=(LoadPlayerHandle(HY,h,(54)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call Y2D(p)
  endif
  set t=null
  set p=null
  return false
endfunction

function WBD takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local unit Hero=udg_Hero[GetPlayerId(p)]
  local trigger t
  if IsDead(Hero)==false then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,3.5,false)
    call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function Z4D))
    call SavePlayerHandle(HY,(GetHandleId(t)),(54),(p))
  endif
  set p=null
  set Hero=null
  set t=null
endfunction

function Z7D takes player p returns string
  local string s=LeftAt[GetPlayerId(p)]
  if LeftAt[GetPlayerId(p)]!="Here"then
    return" |c00ff0303("+GetObjectName('n089')+" at "+SubString(s,10,StringLength(s))+"|c00ff0303)|r"
  endif
  return" "
endfunction

function WCD takes nothing returns nothing
  local integer VT8=1
  local integer VU8=5
  local integer ZG8
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,20," ")
  if(IsScourge(GetTriggerPlayer()))then
    loop
      exitwhen VT8>VU8
      set ZG8=GetPlayerId(Sentinels[VT8])
      if(udg_Hero[ZG8]!=null)then
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,20,udg_Colors[ZG8]+(PlayerNames[GetPlayerId((Sentinels[VT8]))])+"|r "+GetObjectName('n08M')+" "+GetUnitName(udg_Hero[ZG8])+" ("+GetObjectName('n08L')+" "+I2S(GetUnitLevel(udg_Hero[ZG8]))+")"+Z7D(Sentinels[VT8]))
      endif
      set VT8=VT8+1
    endloop
  else
    loop
      exitwhen VT8>VU8
      set ZG8=GetPlayerId(Scourges[VT8])
      if(udg_Hero[ZG8]!=null)then
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,20,udg_Colors[ZG8]+(PlayerNames[GetPlayerId((Scourges[VT8]))])+"|r "+GetObjectName('n08M')+" "+GetUnitName(udg_Hero[ZG8])+" ("+GetObjectName('n08L')+" "+I2S(GetUnitLevel(udg_Hero[ZG8]))+")"+Z7D(Scourges[VT8]))
      endif
      set VT8=VT8+1
    endloop
  endif
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,20," ")
endfunction

function Z8D takes unit u returns boolean
  return GetUnitTypeId(u)=='N01O' or GetUnitTypeId(u)=='N013' or GetUnitTypeId(u)=='N014' or GetUnitTypeId(u)=='N015'
endfunction

function Z9D takes unit u returns unit
  local integer h=GetHandleId(GetOwningPlayer(u))
  return(LoadUnitHandle(HY,h,(333)))
endfunction

function W3D takes nothing returns nothing
  local unit u
  local integer i=0
  if(udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetObjectName('n08A'))
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetUnitName(udg_Hero[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(udg_Hero[GetPlayerId(GetTriggerPlayer())]))))
    if Z8D(udg_Hero[GetPlayerId(GetTriggerPlayer())])then
      set u=Z9D(udg_Hero[GetPlayerId(GetTriggerPlayer())])
      if u!=null then
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))
      endif
    endif
  endif
  set u=null
endfunction

function W6D takes nothing returns nothing
  local unit u
  local integer i=0
  if(udg_Hero[GetPlayerId(GetTriggerPlayer())]==null)then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetObjectName('n08A'))
  else
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetUnitName(udg_Hero[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(udg_Hero[GetPlayerId(GetTriggerPlayer())]))))
    if Z8D(udg_Hero[GetPlayerId(GetTriggerPlayer())])then
      set u=Z9D(udg_Hero[GetPlayerId(GetTriggerPlayer())])
      if u!=null then
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))
      endif
    endif
    loop
      exitwhen i>16
      set u=udg_Hero[i]
      if u!=null and u!=udg_Hero[GetPlayerId(GetTriggerPlayer())]and IsUnitAlly(u,GetTriggerPlayer()) then
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetUnitName(u)+" "+GetObjectName('n08N')+" "+I2S(R2I(.5+GetUnitMoveSpeedLOD(u))))
      endif
      set i=i+1
    endloop
  endif
  set u=null
endfunction

function WLD takes nothing returns nothing
  call SaveBoolean(HY,GetHandleId(GetTriggerPlayer()),139,true)
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08R'))
endfunction

function W1D takes nothing returns nothing
  call SaveBoolean(HY,GetHandleId(GetTriggerPlayer()),139,false)
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08O'))
endfunction

function W0D takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,"   "+GetObjectName('n08P')+" "+I2S(PlayerCS[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08Q')+" "+I2S(CSDenies[GetPlayerId(GetTriggerPlayer())])+" "+GetObjectName('n08S')+" "+I2S(CSNeutrals[GetPlayerId(GetTriggerPlayer())]))
endfunction

function W5D takes nothing returns nothing
  local integer x=GetPlayerId(GetTriggerPlayer())
  if(GetEventPlayerChatString()=="-cson")then
    set CSONStatus1[x]=true
    set CSONStatus2[x]=true
  else
    set CSONStatus1[x]=false
    set CSONStatus2[x]=false
  endif
endfunction

function ZDD takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer i=(LoadInteger(HY,h,(34)))
  local real x
  local real y
  if FixedCameraOnHero[i]==false then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif udg_Hero[i]!=null and IsDead(udg_Hero[i])==false then
    set x=GetUnitX(udg_Hero[i])
    set y=GetUnitY(udg_Hero[i])
    call PanCameraToTimedForPlayer(Player(i),x,y,0)
  endif
  set t=null
  return false
endfunction

function X3D takes nothing returns nothing
  local integer x=GetPlayerId(GetTriggerPlayer())
  local trigger t
  local integer h
  local integer i
  if FixedCameraOnHero[x]==false and(GetEventPlayerChatString()=="-center"or GetEventPlayerChatString()=="-c")then
    set FixedCameraOnHero[x]=true
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.01,true)
    call TriggerAddCondition(t,Condition(function ZDD))
    call SaveInteger(HY,h,(34),(x))
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0JW'))
  elseif GetEventPlayerChatString()=="-centeroff"or GetEventPlayerChatString()=="-co"then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0JX'))
    set FixedCameraOnHero[x]=false
  endif
  set t=null
endfunction

function XLD takes nothing returns nothing
  set AutoselectionStatus[GetPlayerId(GetTriggerPlayer())]=false
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,GetObjectName('n0JZ'))
endfunction

function X1D takes nothing returns nothing
  set AutoselectionStatus[GetPlayerId(GetTriggerPlayer())]=true
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,5,GetObjectName('n0K0'))
endfunction

function X6D takes nothing returns nothing
  local integer i=0
  local integer id=GetPlayerId(GetTriggerPlayer())
  local integer Count=0
  local integer ZED=0
  local player p
  if SwitchUnlockingAvailable==false or Mode_SO==false then
    return
  endif
  if ZA7+90<(TimerGetElapsed(GlobalTimer))then
    loop
      exitwhen i>15
      set ZZ7[i]=false
      set i=i+1
    endloop
  endif
  set ZA7=(TimerGetElapsed(GlobalTimer))+90
  set ZZ7[id]=true
  set i=0
  loop
    exitwhen i>15
    if IsSentinel(GetTriggerPlayer())then
      if IsSentinel(Player(i))and IsPlayer(Player(i))then
        set ZED=ZED+1
        if ZZ7[i]then
          set Count=Count+1
        endif
      endif
    else
      if IsScourge(Player(i))and IsPlayer(Player(i))then
        set ZED=ZED+1
        if ZZ7[i]then
          set Count=Count+1
        endif
      endif
    endif
    set i=i+1
  endloop
  if Count*2>ZED then
    if IsSentinel(GetTriggerPlayer())then
      set i=0
      loop
        exitwhen i>5
        set p=Sentinels[i]
        if IsPlayerLeftGame[GetPlayerId(p)] and HeroHasBeenUnlocked[GetPlayerId(p)]==false then
          call DisplayTimedTextToForceEx(Force_Elfs,10,GetObjectName('n0KD')+" "+(PlayerNames[GetPlayerId((p))]))
          call C08(p)
          set HeroHasBeenUnlocked[GetPlayerId(p)]=true
        endif
        set i=i+1
      endloop
    else
      set i=0
      loop
        exitwhen i>5
        set p=Scourges[i]
        if IsPlayerLeftGame[GetPlayerId(p)] and HeroHasBeenUnlocked[GetPlayerId(p)]==false then
          call DisplayTimedTextToForceEx(Force_Unds,10,GetObjectName('n0KD')+" "+(PlayerNames[GetPlayerId((p))]))
          call C08(p)
          set HeroHasBeenUnlocked[GetPlayerId(p)]=true
        endif
        set i=i+1
      endloop
    endif
  else
    if IsSentinel(GetTriggerPlayer())then
      call DisplayTimedTextToForceEx(Force_Elfs,10,GetObjectName('n0KB')+" "+I2S(Count)+"/"+I2S(ZED)+" ("+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+")")
    else
      call DisplayTimedTextToForceEx(Force_Unds,10,GetObjectName('n0KB')+" "+I2S(Count)+"/"+I2S(ZED)+" ("+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+")")
    endif
  endif
  set p=null
endfunction

function UpdateMyLb takes nothing returns nothing
  local integer i=1
  local integer pid
  local boolean deadtimer
  local boolean courier
  local boolean movespeed
  local player p
  local boolean deadtimeron=not(Mode_NoDeath or GameEnded)
  local string s=""
  local integer time
  local integer lines
  local real speed
  local unit u
  local integer pid2
  local integer k=1
  local integer c=LoadInteger(HY,GetHandleId(GetExpiredTimer()),0)+1
  call SaveInteger(HY,GetHandleId(GetExpiredTimer()),0,c)
  loop
    set i=1
    loop
      set lines=0
      set s="	"
      if k==1 then
        set p=Sentinels[i]
      else
        set p=Scourges[i]
      endif
      if IsPlayer(p)!=false then
        set pid=GetPlayerId(p)
        set time=R2I(TimerGetRemaining(HeroRespawnTimer[pid]))
        set deadtimer=time>0 and ShowDeathTimer[pid] and deadtimeron
        //				set speed=GetUnitMoveSpeedLOD(udg_Hero[pid])
        //				set movespeed=false and speed>0
        if deadtimer then
          set s=s+"Respawn in: "+I2S(time)+"|n"
          set lines=1
        endif
        //				if movespeed then
        //					set s=s+"Hero's movespeed: "+I2S(R2I(speed))+"|n"
        //					set lines=1
        //				endif
        if ModuloInteger(c,2)==1 then
          call DefineCourierForPlayer(p)
        endif
        if HaveSavedHandle(HeroStats,GetHandleId(p),'COUR') and (LoadBoolean(HeroStats,GetHandleId(p),'UIds') or IsDead(LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')))  then
          set lines=1
          set u=LoadUnitHandle(HeroStats,GetHandleId(p),'COUR')
          set pid2=GetPlayerId(GetOwningPlayer(u))
          set s=s+udg_Colors[pid2]+"Courier|r: "
          if IsDead(u) then
            set s=s+"|c00ff0000Dead|r ("+I2S(R2I(TimerGetElapsed(GlobalTimer)-LoadReal(HY,GetHandleId(u),'DEAD'))*-1)+"s)"
          else
            set s=s+LoadStr(HeroStats,GetHandleId(u),'ORDR')
          endif
        endif
        if lines>0 then
          call LeaderboardDisplay(MyLB[pid],true)
          call LeaderboardSetLabel(MyLB[pid],s)
          
          call PlayerSetLeaderboard(p,MyLB[pid])
        elseif IsLeaderboardDisplayed(MyLB[pid]) then
          call LeaderboardDisplay(MyLB[pid],false)
          //call LeaderboardSetLabel(MyLB[pid],"")
        endif
      endif
      set i=i+1
      exitwhen i>5
    endloop
    set k=k+1
    exitwhen k>2
  endloop
  
  set u=null
endfunction

function InitMyLb takes nothing returns nothing
  local integer i=1
  local integer pid
  local timer t=CreateTimer()
  call TimerStart(t,1,true,function UpdateMyLb)
  set t=null
  loop
    
    set pid=GetPlayerId(Sentinels[i])
    set MyLB[pid]=CreateLeaderboard()
    call PlayerSetLeaderboard(Sentinels[i],MyLB[pid])
    call LeaderboardDisplay(MyLB[pid],false)
    call LeaderboardSetLabel(MyLB[pid],"Default string")
    
    set pid=GetPlayerId(Scourges[i])
    set MyLB[pid]=CreateLeaderboard()
    call PlayerSetLeaderboard(Scourges[i],MyLB[pid])
    call LeaderboardDisplay(MyLB[pid],false)
    call LeaderboardSetLabel(MyLB[pid],"Default string")
    
    set i=i+1
    exitwhen i>5
  endloop
  
endfunction

function XDD takes nothing returns nothing
  local integer x=GetPlayerId(GetTriggerPlayer())
  if GetEventPlayerChatString()=="-don"or GetEventPlayerChatString()=="-deathon"then
    set ShowDeathTimer[x]=true
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08W'))
  else
    set ShowDeathTimer[x]=false
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08X'))
  endif
endfunction

function X8D takes nothing returns nothing
  if(GetEventPlayerChatString()=="-showdeny")then
    set CSONStatus2[GetPlayerId(GetTriggerPlayer())]=true
  else
    set CSONStatus2[GetPlayerId(GetTriggerPlayer())]=false
  endif
endfunction

function X9D takes nothing returns nothing
  call Error(GetTriggerPlayer(),GetObjectName('n0HG'))
endfunction

function W2D takes nothing returns nothing
  call ForceRemovePlayer(AllPlayers,GetTriggerPlayer())
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08U'))
endfunction

function X4D takes nothing returns nothing
  call ForceAddPlayer(AllPlayers,GetTriggerPlayer())
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n08Z'))
endfunction

function ZJD takes nothing returns boolean
  local integer x=GetRandomInt(1,4)
  if x==1 then
    set ZL7=Weather_Snow
  elseif x==2 then
    set ZL7=Weather_Rain
  elseif x==3 then
    set ZL7=Weather_Moonlight
  elseif x==4 then
    set ZL7=Weather_Wind
  endif
  if Z17[GetPlayerId(GetLocalPlayer())]then
    call EnableWeatherEffect(Weather_Snow,false)
    call EnableWeatherEffect(Weather_Rain,false)
    call EnableWeatherEffect(Weather_Moonlight,false)
    call EnableWeatherEffect(Weather_Wind,false)
    call EnableWeatherEffect(ZL7,true)
  endif
  return false
endfunction

function ZKD takes nothing returns nothing
  local integer x=GetRandomInt(1,4)
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,300,true)
  call TriggerAddCondition(t,Condition(function ZJD))
  set Z17[GetPlayerId(Sentinels[1])]=false
  set Z17[GetPlayerId(Sentinels[2])]=false
  set Z17[GetPlayerId(Sentinels[3])]=false
  set Z17[GetPlayerId(Sentinels[4])]=false
  set Z17[GetPlayerId(Sentinels[5])]=false
  set Z17[GetPlayerId(Scourges[1])]=false
  set Z17[GetPlayerId(Scourges[2])]=false
  set Z17[GetPlayerId(Scourges[3])]=false
  set Z17[GetPlayerId(Scourges[4])]=false
  set Z17[GetPlayerId(Scourges[5])]=false
  if udg_ObserverMode then
    set Z17[GetPlayerId(udg_Observer1)]=false
    set Z17[GetPlayerId(udg_Observer2)]=false
  endif
  if x==1 then
    set ZL7=Weather_Snow
  elseif x==2 then
    set ZL7=Weather_Rain
  elseif x==3 then
    set ZL7=Weather_Moonlight
  elseif x==4 then
    set ZL7=Weather_Wind
  endif
  set t=null
endfunction

function X7D takes nothing returns nothing
  local string VHD=StringCase(GetEventPlayerChatString(),false)
  if Z67 then
    set Z67=false
    call ZKD()
  endif
  if VHD=="-weather snow"and GetLocalPlayer()==GetTriggerPlayer()then
    set Z17[GetPlayerId(GetTriggerPlayer())]=false
    call EnableWeatherEffect(Weather_Snow,true)
    call EnableWeatherEffect(Weather_Rain,false)
    call EnableWeatherEffect(Weather_Moonlight,false)
    call EnableWeatherEffect(Weather_Wind,false)
  endif
  if VHD=="-weather rain"and GetLocalPlayer()==GetTriggerPlayer()then
    set Z17[GetPlayerId(GetTriggerPlayer())]=false
    call EnableWeatherEffect(Weather_Snow,false)
    call EnableWeatherEffect(Weather_Rain,true)
    call EnableWeatherEffect(Weather_Moonlight,false)
    call EnableWeatherEffect(Weather_Wind,false)
  endif
  if VHD=="-weather moonlight"and GetLocalPlayer()==GetTriggerPlayer()then
    set Z17[GetPlayerId(GetTriggerPlayer())]=false
    call EnableWeatherEffect(Weather_Snow,false)
    call EnableWeatherEffect(Weather_Rain,false)
    call EnableWeatherEffect(Weather_Moonlight,true)
    call EnableWeatherEffect(Weather_Wind,false)
  endif
  if VHD=="-weather wind"and GetLocalPlayer()==GetTriggerPlayer()then
    set Z17[GetPlayerId(GetTriggerPlayer())]=false
    call EnableWeatherEffect(Weather_Snow,false)
    call EnableWeatherEffect(Weather_Rain,false)
    call EnableWeatherEffect(Weather_Moonlight,false)
    call EnableWeatherEffect(Weather_Wind,true)
  endif
  if VHD=="-weather off"and GetLocalPlayer()==GetTriggerPlayer()then
    set Z17[GetPlayerId(GetTriggerPlayer())]=false
    call EnableWeatherEffect(Weather_Snow,false)
    call EnableWeatherEffect(Weather_Rain,false)
    call EnableWeatherEffect(Weather_Moonlight,false)
    call EnableWeatherEffect(Weather_Wind,false)
  endif
  if VHD=="-weather random"then
    set Z17[GetPlayerId(GetTriggerPlayer())]=true
    if GetLocalPlayer()==GetTriggerPlayer()then
      call EnableWeatherEffect(Weather_Snow,false)
      call EnableWeatherEffect(Weather_Rain,false)
      call EnableWeatherEffect(Weather_Moonlight,false)
      call EnableWeatherEffect(Weather_Wind,false)
      call EnableWeatherEffect(ZL7,true)
    endif
  endif
endfunction

function RollChatCmd takes nothing returns nothing
  local integer a=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
  local integer ZG8=GetPlayerId(GetTriggerPlayer())
  set TL[ZG8]=TL[ZG8]+1
  if TL[ZG8]>20 then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0DQ'))
    return
  endif
  if GetEventPlayerChatString()=="-rollon"or GetEventPlayerChatString()=="-rolloff"then
    return
  endif
  if a==0 then
    set a=100
  endif
  if a>0 and a<2001 then
    call YL8(AllPlayers,5,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r "+GetObjectName('n05I')+" "+I2S(GetRandomInt(1,a))+" "+GetObjectName('n05M')+" "+I2S(a))
  else
    call Error(GetTriggerPlayer(),GetObjectName('n02Y'))
  endif
endfunction

function XYD takes nothing returns nothing
  local integer a
  if GetRandomInt(1,2)==1 then
    set a=GetRandomInt(FirstScourgeHeroIndexid,LastScourgeHeroIndexid)
  else
    set a=GetRandomInt(FirstSentinelHeroIndexid,LastSentinelHeroIndexid)
  endif
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0GS')+" "+UR8(a))
endfunction

function CMChatCmd takes nothing returns nothing
endfunction

function XQD takes nothing returns nothing
  set ShowRollNumbers[GetPlayerId(GetTriggerPlayer())]=false
endfunction

function XRD takes nothing returns nothing
  set ShowRollNumbers[GetPlayerId(GetTriggerPlayer())]=true
endfunction

function XFD takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n090'))
  set hhnActive[GetPlayerId(GetTriggerPlayer())]=true
  if GetLocalPlayer()==GetTriggerPlayer()then
    call SetPlayerName(Sentinels[1],PlayerNames[GetPlayerId(Sentinels[1])])
    call SetPlayerName(Sentinels[2],PlayerNames[GetPlayerId(Sentinels[2])])
    call SetPlayerName(Sentinels[3],PlayerNames[GetPlayerId(Sentinels[3])])
    call SetPlayerName(Sentinels[4],PlayerNames[GetPlayerId(Sentinels[4])])
    call SetPlayerName(Sentinels[5],PlayerNames[GetPlayerId(Sentinels[5])])
    call SetPlayerName(Scourges[1],PlayerNames[GetPlayerId(Scourges[1])])
    call SetPlayerName(Scourges[2],PlayerNames[GetPlayerId(Scourges[2])])
    call SetPlayerName(Scourges[3],PlayerNames[GetPlayerId(Scourges[3])])
    call SetPlayerName(Scourges[4],PlayerNames[GetPlayerId(Scourges[4])])
    call SetPlayerName(Scourges[5],PlayerNames[GetPlayerId(Scourges[5])])
  endif
endfunction

function XGD takes nothing returns nothing
  local integer id=GetPlayerId(GetTriggerPlayer())
  if SoundsMuted[id] then
    set SoundsMuted[id]=false
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n08T'))
  else
    set SoundsMuted[id]=true
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n091'))
  endif
endfunction

function ShowSpellInfo takes nothing returns nothing
  local integer id=GetPlayerId(GetTriggerPlayer())
  set ItemInfoShown[id]=false
  set SpellInfoShown[id]=true
endfunction

function XBD takes nothing returns nothing
  local integer id=GetPlayerId(GetTriggerPlayer())
  set ItemInfoShown[id]=true
  set SpellInfoShown[id]=false
endfunction

function XJD takes nothing returns nothing
  local integer i=1
  local player p
  local real ZMD
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if IsPlayer(p)then
      set ZMD=PlayerAPM[GetPlayerId(p)]/(TimerGetElapsed(GlobalTimer))*60
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n084')+" "+R2S(ZMD))
    endif
    set p=Scourges[i]
    if IsPlayer(p)then
      set ZMD=PlayerAPM[GetPlayerId(p)]/(TimerGetElapsed(GlobalTimer))*60
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n084')+" "+R2S(ZMD))
    endif
    set i=i+1
  endloop
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.," ")
  set p=null
endfunction

function XKD takes nothing returns nothing
  call BL8(GetTriggerPlayer())
  set ClearCounter[GetPlayerId(GetTriggerPlayer())]=ClearCounter[GetPlayerId(GetTriggerPlayer())]+1
  if(ClearCounter[GetPlayerId(GetTriggerPlayer())]==5)then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Use command |c00ff0505-fc|r to reduce a duration of kill messages")
  endif
endfunction

function ZPD takes player whichPlayer returns nothing
  local integer ZQD
  local player ZRD
  set ZQD=0
  loop
    set ZRD=Player(ZQD)
    if(PlayersAreCoAllied(whichPlayer,ZRD)and whichPlayer!=ZRD)then
      call SetPlayerAlliance(whichPlayer,ZRD,ALLIANCE_SHARED_VISION,true)
      call SetPlayerAlliance(whichPlayer,ZRD,ALLIANCE_SHARED_CONTROL,true)
      call SetPlayerAlliance(ZRD,whichPlayer,ALLIANCE_SHARED_CONTROL,true)
    endif
    set ZQD=ZQD+1
    exitwhen ZQD==12
  endloop
  set ZRD=null
endfunction

function KickafkChatCmd takes nothing returns nothing
  local integer ZG8=S2I(SubString(GetEventPlayerChatString(),9,StringLength(GetEventPlayerChatString())))
  local integer i=1
  local player p
  local string Time
  if AFK_Check then
    if(SecondsForTime<10)then
      set Time=I2S(MinutesForTime)+":0"+I2S(SecondsForTime)
    else
      set Time=I2S(MinutesForTime)+":"+I2S(SecondsForTime)
    endif
    if ZG8<1 or A47[ZG8]==false then
      loop
        exitwhen i>5
        set p=Sentinels[i]
        if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false and b_isPickTime==false then
          set A47[GetPlayerId(p)]=true
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.," ")
        endif
        set p=Scourges[i]
        if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false and b_isPickTime==false then
          set A47[GetPlayerId(p)]=true
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.," ")
        endif
        set i=i+1
      endloop
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.," ")
    elseif IsPlayer(Player(ZG8)) and IsPlayerAlly(GetTriggerPlayer(),Player(ZG8)) then
      call DisplayTimedTextToPlayer(Player(ZG8),0,I3,3600,"|c00ff0303"+GetObjectName('n05E')+"|r")
      call I69(Player(ZG8))
      set LeftAt[GetPlayerId(Player(ZG8))]="|c00555555"+Time+"|r"
      call RemovePlayer(Player(ZG8),PLAYER_GAME_RESULT_DEFEAT)
      call ZPD(Player(ZG8))
      if Mode_SO then
        call CL8(Player(ZG8))
      endif
      set IsPlayerLeftGame[GetPlayerId(Player(ZG8))]=true
      call I39(Player(ZG8))
      call DisplayTimedTextToForceEx(AllPlayers,30.,"|c00ff0303"+(PlayerNames[GetPlayerId((Player(ZG8)))])+" "+GetObjectName('n05E')+"|r")
    endif
  endif
  set p=null
endfunction

function XHD takes nothing returns nothing
  local integer i=1
  local player p
  local integer x=0
  if AFK_Check then
    loop
      exitwhen i>5
      set p=Sentinels[i]
      if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60>.2 then
        set x=x+1
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05D')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
      endif
      set p=Scourges[i]
      if IsPlayer(p)and((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60>.2 then
        set x=x+1
        call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05D')+" "+R2S(((TimerGetElapsed(GlobalTimer))-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
      endif
      set i=i+1
    endloop
    if x<1 then
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.,GetObjectName('N05Q'))
    else
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,15.," ")
    endif
  endif
  set p=null
endfunction

function HeroGPS takes nothing returns nothing
  local integer i=1
  local player p
  local integer pid
  local integer k=0
  loop
    set k=0
    set p=Sentinels[i]
    if IsPlayer(p)then
      set pid=GetPlayerId(p)
      call Traffic_RegisterData("LoD_HeroX_"+I2S(R2I(GetUnitX(udg_Hero[pid]))),pid)
      call Traffic_RegisterData("LoD_HeroY_"+I2S(R2I(GetUnitY(udg_Hero[pid]))),pid)
    endif
    set p=Scourges[i]
    if IsPlayer(p)then
      set pid=GetPlayerId(p)
      call Traffic_RegisterData("LoD_HeroX_"+I2S(R2I(GetUnitX(udg_Hero[pid]))),pid)
      call Traffic_RegisterData("LoD_HeroY_"+I2S(R2I(GetUnitY(udg_Hero[pid]))),pid)
    endif
    set i=i+1
    exitwhen i>5
  endloop
  
endfunction

function ZSD takes nothing returns boolean
  local integer i=1
  local player p
  local real Time=(TimerGetElapsed(GlobalTimer))
  if AFK_Check then
    loop
      exitwhen i>5
      set p=Sentinels[i]
      if IsPlayer(p)and(Time-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false then
        set A47[GetPlayerId(p)]=true
        call DisplayTimedTextToForceEx(Force_Elfs,15,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S((Time-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
        call DisplayTimedTextToForceEx(Force_Elfs,15,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))
        call DisplayTimedTextToForceEx(Force_Elfs,15," ")
      endif
      set p=Scourges[i]
      if IsPlayer(p)and(Time-LastTimeActivity[GetPlayerId(p)])>300. and A47[GetPlayerId(p)]==false then
        set A47[GetPlayerId(p)]=true
        call DisplayTimedTextToForceEx(Force_Unds,15,udg_Colors[GetPlayerId(p)]+(PlayerNames[GetPlayerId((p))])+"|r"+" "+GetObjectName('n05G')+" "+R2S((Time-LastTimeActivity[GetPlayerId(p)])/ 60)+" "+GetObjectName('N05F'))
        call DisplayTimedTextToForceEx(Force_Unds,15,GetObjectName('n05O')+" |cff99ccff-kickafk "+I2S(GetPlayerId(p))+" |r "+GetObjectName('n05P'))
        call DisplayTimedTextToForceEx(Force_Unds,15," ")
      endif
      set i=i+1
    endloop
  endif
  if advancedTracking then
    call HeroGPS()
  endif
  set p=null
  return false
endfunction

function ZTD takes nothing returns boolean
  if GetOwningPlayer(GetTriggerUnit())!=Sentinels[0]and GetOwningPlayer(GetTriggerUnit())!=Scourges[0]then
    set PlayerAPM[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=PlayerAPM[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]+1
    if GetIssuedOrderId()!=851983 then
      set LastTimeActivity[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=(TimerGetElapsed(GlobalTimer))
      set A47[GetPlayerId(GetOwningPlayer(GetTriggerUnit()))]=false
    endif
    if(GetIssuedOrderId()==851983 or GetIssuedOrderId()==851971)and GetOrderTargetItem()!=null then
      if GetIssuedOrderId()==851983 or(GetIssuedOrderId()==851971 and(LoadBoolean(HY,(GetHandleId(GetItemPlayer(GetOrderTargetItem()))),(139))))then
        if GetItemPlayer(GetOrderTargetItem())!=GetOwningPlayer(GetTriggerUnit())and IsPointInRegion(KK,GetItemX(GetOrderTargetItem()),GetItemY(GetOrderTargetItem())) then
          call DisableTrigger(GetTriggeringTrigger())
          call InterruptUnit(GetTriggerUnit())
          call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0G7'))
          call EnableTrigger(GetTriggeringTrigger())
        endif
      endif
    endif
  endif
  return false
endfunction

function ZUD takes nothing returns boolean
  return IsCourier(GetFilterUnit())and GetOwningPlayer(GetFilterUnit())==GetTriggerPlayer()
endfunction

function XMD takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,12000,Condition(function ZUD))
  call KillGroup(g)
  set g=null
endfunction

function XND takes nothing returns nothing
  if(TimerGetElapsed(GlobalTimer))>60 then
    call ErrorDefault2s(GetTriggerPlayer(),GetObjectName('n02X'))
    return
  elseif(TimerGetElapsed(GlobalTimer))<15 then
    call ErrorDefault2s(GetTriggerPlayer(),GetObjectName('n02X'))
    return
  endif
  if GetTriggerPlayer()!=PlayerModeTyper then
    call ErrorDefault2s(GetTriggerPlayer(),GetObjectName('n02W'))
    return
  endif
  if MK==false then
    set MK=true
    set LK=2
    call UID()
    call DisplayTimedTextToForceEx(AllPlayers,15,GetObjectName('n05N')+" "+GetObjectName('n055'))
    call DisplayTimedTextToForceEx(AllPlayers,15,GetObjectName('n05R'))
  else
    call Error(GetTriggerPlayer(),GetObjectName('n02V'))
  endif
endfunction

function ZZD takes string s returns nothing
  call StopMusic(true)
  call PlayMusic(s)
endfunction

function MusicChatCmd takes nothing returns nothing
  local string s=GetEventPlayerChatString()
  local integer VA8=GetRandomInt(1,A87)
  if GetLocalPlayer()==GetTriggerPlayer()then
    if s=="-music off"then
      call StopMusic(false)
    elseif s=="-music random"then
      call ZZD(A77[VA8])
    elseif s=="-music nightelf1"then
      call ZZD(QC)
    elseif s=="-music nightelf2"then
      call ZZD(UC)
    elseif s=="-music nightelf3"then
      call ZZD(OD)
    elseif s=="-music human1"then
      call ZZD(XC)
    elseif s=="-music human2"then
      call ZZD(YC)
    elseif s=="-music human3"then
      call ZZD(JC)
    elseif s=="-music orc1"then
      call ZZD(BD)
    elseif s=="-music orc2"then
      call ZZD(DD)
    elseif s=="-music orc3"then
      call ZZD(ED)
    elseif s=="-music undead1"then
      call ZZD(IE)
    elseif s=="-music undead2"then
      call ZZD(OE)
    elseif s=="-music undead3"then
      call ZZD(AE)
    elseif s=="-music other1"then
      call ZZD(FD)
    elseif s=="-music other2"then
      call ZZD(GD)
    elseif s=="-music other3"then
      call ZZD(HD)
    elseif s=="-music other4"then
      call ZZD(ZD)
    elseif s=="-music other5"then
      call ZZD(VD)
    elseif s=="-music other6"then
      call ZZD(DF)
    elseif s=="-music other7"then
      call ZZD(EF)
    elseif s=="-music other8"then
      call ZZD(FF)
    elseif s=="-music other9"then
      call ZZD(GF)
    elseif s=="-music special"then
      call ZZD(A97)
    else
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,GetObjectName('n0CW')+" ")
      call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10,"off, random, nightelf1, nightelf2, nightelf3, human1, human2, human3, orc1, orc2, orc3, undead1, undead2, undead3, other1, other2, other3, other4, other5, other6, other7, other8, other9, special")
    endif
  endif
endfunction

function ZAD takes nothing returns boolean
  set A87=A87+1
  set A77[A87]=QC
  set A87=A87+1
  set A77[A87]=UC
  set A87=A87+1
  set A77[A87]=OD
  set A87=A87+1
  set A77[A87]=XC
  set A87=A87+1
  set A77[A87]=YC
  set A87=A87+1
  set A77[A87]=JC
  set A87=A87+1
  set A77[A87]=BD
  set A87=A87+1
  set A77[A87]=DD
  set A87=A87+1
  set A77[A87]=ED
  set A87=A87+1
  set A77[A87]=IE
  set A87=A87+1
  set A77[A87]=OE
  set A87=A87+1
  set A77[A87]=AE
  set A87=A87+1
  set A77[A87]=FD
  set A87=A87+1
  set A77[A87]=GD
  set A87=A87+1
  set A77[A87]=HD
  set A87=A87+1
  set A77[A87]=ZD
  set A87=A87+1
  set A77[A87]=VD
  set A87=A87+1
  set A77[A87]=DF
  set A87=A87+1
  set A77[A87]=EF
  set A87=A87+1
  set A77[A87]=FF
  set A87=A87+1
  set A77[A87]=GF
  set A87=A87+1
  set A77[A87]=A97
  return false
endfunction

function ZBD takes player p,integer r,integer g,integer b,integer a returns nothing
  if GetLocalPlayer()==p then
    call SetWaterBaseColor(r,g,b,a)
  endif
endfunction

function ZCD takes string s returns nothing
  local string Z3D=""
  local string Z6D=""
  local string ZLD=""
  local integer i=0
  local integer E29=StringLength(s)
  local integer Z1D=1
  loop
    exitwhen i>E29
    if SubString(s,i,i+1)==" "then
      set Z1D=Z1D+1
    else
      if Z1D==1 then
        set Z3D=Z3D+SubString(s,i,i+1)
      elseif Z1D==2 then
        set Z6D=Z6D+SubString(s,i,i+1)
      else
        set ZLD=ZLD+SubString(s,i,i+1)
      endif
    endif
    set i=i+1
  endloop
  set AE7=S2I(Z3D)
  set AF7=S2I(Z6D)
  set AG7=S2I(ZLD)
endfunction

function WaterChatCmd takes nothing returns nothing
  local string Z0D=SubString(GetEventPlayerChatString(),7,StringLength(GetEventPlayerChatString()))
  local player p=GetTriggerPlayer()
  local integer r
  local integer g
  local integer b
  set CustomWaterColor[GetPlayerId(p)]=true
  if Z0D=="red"then
    call ZBD(p,255,0,0,255)
  elseif Z0D=="blue"then
    call ZBD(p,0,0,255,255)
  elseif Z0D=="green"then
    call ZBD(p,0,255,0,255)
  elseif Z0D=="default"then
    call ZBD(p,0,0,255,255)
  elseif Z0D=="random"then
    set r=GetRandomInt(0,255)
    set g=GetRandomInt(0,255)
    set b=GetRandomInt(0,255)
    call ZBD(p,r,g,b,255)
    call DisplayTimedTextToPlayer(p,0,0,5,GetObjectName('n0HD')+" r="+I2S(r)+" g="+I2S(g)+" b="+I2S(b))
  else
    call ZCD(Z0D)
    set r=AE7
    set g=AF7
    set b=AG7
    if r==0 and g==0 and b==0 and Z0D!="0 0 0"then
      return
    endif
    if r>=0 and r<=255 and g>=0 and g<=255 and b>=0 and b<=255 then
      call ZBD(p,r,g,b,255)
    endif
  endif
  set p=null
endfunction

function XXD takes nothing returns boolean
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,"Total Bonus XP/Gold: "+I2S(AssistsBonusExpCounter[GetPlayerId(GetTriggerPlayer())])+"/"+I2S(AssistsBonusGoldCounter[GetPlayerId(GetTriggerPlayer())]))
  return false
endfunction

function SFSoulsStats takes player p returns nothing
  local unit Hero=udg_Hero[GetPlayerId(p)]
  local integer i=GetUnitAbilityLevel(Hero,'A0CQ')-1
  local integer souls=0
  local integer Level=GetUnitAbilityLevel(Hero,'A0BR')
  if Level==1 then
    set souls=12
  elseif Level==2 then
    set souls=20
  elseif Level==3 then
    set souls=28
  elseif Level==4 then
    set souls=36
  endif
  set i=IMaxBJ(IMinBJ(i,souls),0)
  if isPlayerPickedAbility(p,318)and i>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0KE')+" "+I2S(i)+"/"+I2S(souls))
  endif
  set Hero=null
endfunction

function X5D takes nothing returns boolean
  local player p=GetTriggerPlayer()
  local integer pid=GetPlayerId(p)
  local integer h=GetHandleId(p)
  local integer i
  local integer k
  if E48>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0LO')+": "+I2S(E48))
  endif
  if LoadInteger(HeroStats,h,'DUEL')>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,"Duels: "+I2S(LoadInteger(HeroStats,h,'DUEL'))+" wins, "+I2S(LoadInteger(HeroStats,h,'DDUE'))+" bonus damage")
  endif
  if LoadInteger(MHT,h,'A0O3')>0 then
    call DisplayTimedTextToPlayer(p,0,0,10.,GetObjectName('n0GQ')+" "+I2S(LoadInteger(MHT,h,'A0O3')))
  endif
  set i=LoadInteger(HeroStats,h,'ARRH')
  set k=LoadInteger(HeroStats,h,'ARRS')
  if k>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0GM')+" "+R2S(I2R(i)/ I2R(k)*100)+"% ("+I2S(i)+"/"+I2S(k)+")")
  endif
  if LoadInteger(HeroStats,h,'MC_T')>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0JH')+" "+I2S(LoadInteger(HeroStats,h,'MC_T')))
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0JM')+" "+I2S(LoadInteger(HeroStats,h,'MC_2')+LoadInteger(HeroStats,h,'MC_3')+LoadInteger(HeroStats,h,'MC_4'))+" ("+I2S((LoadInteger(HeroStats,h,'MC_2')+LoadInteger(HeroStats,h,'MC_3')+LoadInteger(HeroStats,h,'MC_4'))*100/ LoadInteger(HeroStats,h,'MC_T'))+"%)")
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0JL')+" "+I2S(LoadInteger(HeroStats,h,'MC_2'))+" ("+I2S(100*LoadInteger(HeroStats,h,'MC_2')/ LoadInteger(HeroStats,h,'MC_T'))+"%)")
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0JK')+" "+I2S(LoadInteger(HeroStats,h,'MC_3'))+" ("+I2S(100*LoadInteger(HeroStats,h,'MC_3')/ LoadInteger(HeroStats,h,'MC_T'))+"%)")
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0JJ')+" "+I2S(LoadInteger(HeroStats,h,'MC_4'))+" ("+I2S(100*LoadInteger(HeroStats,h,'MC_4')/ LoadInteger(HeroStats,h,'MC_T'))+"%)")
  endif
  if StolenInt[pid]>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0HM')+" "+I2S(StolenInt[pid]))
  endif
  call SFSoulsStats(p)
  if FleshHeapCount[pid]>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,"Flesh Heap victims count : "+I2S(FleshHeapCount[pid]))
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n09R')+" "+I2S(LoadInteger(MHT,GetHandleId(udg_Hero[pid]),'A06D'))+" "+GetObjectName('n09S'))
  endif
  set i=LoadInteger(HeroStats,h,'HK_H')
  set k=LoadInteger(HeroStats,h,'HK_T')
  if k>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0EL')+" "+R2S(I2R(i)/ I2R(k)*100)+"% ("+I2S(i)+"/"+I2S(k)+")")
  endif
  if TrackBonusBounty[pid]>0 then
    call DisplayTimedTextToPlayer(p,0,0,10,"Track bonus gold: "+I2S(TrackBonusBounty[pid]))
  endif
  
  return false
endfunction

function Z5D takes player p1 returns string
  local string s=GetObjectName('n0GB')
  set s=FA9(s,"$c1","|c00ff0303")
  set s=FA9(s,"$p1",udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r")
  return s
endfunction

function Z2D takes nothing returns string
  local string s=GetObjectName('n0GA')//$c1If you want veto this, type |r $c2-no|r
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c2","|c00ff0303")
  return s
endfunction

function A4D takes nothing returns nothing
  local integer i=1
  local unit Hero
  if MK then
    loop
      exitwhen i>5
      set Hero=udg_Hero[GetPlayerId(Sentinels[i])]
      if Hero!=null then
        if LK==2 then
          call FS9(Hero)
        endif
        call UnitSetUsesAltIcon(Hero,false)
      endif
      set Hero=udg_Hero[GetPlayerId(Scourges[i])]
      if Hero!=null then
        if LK==2 then
          call FS9(Hero)
        endif
        call UnitSetUsesAltIcon(Hero,false)
      endif
      set i=i+1
    endloop
    set Hero=null
  endif
endfunction

function A7D takes player p1,player p2 returns string
  local string s=GetObjectName('n0G2')//$c1Type|r $c2-switch accept|r $c1or|r $c2-ok|r $c1to allow|r $p1 $c1to switch with|r $p2
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c2","|c00ff0303")
  set s=FA9(s,"$c2","|c00ff0303")
  set s=FA9(s,"$p1",udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r")
  set s=FA9(s,"$p2",udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r")
  return s
endfunction

function A8D takes string A9D,string ADD returns string
  local string s=GetObjectName('n0FV')
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$c1","|c006699CC")
  set s=FA9(s,"$p1",A9D)
  set s=FA9(s,"$p2",ADD)
  return s
endfunction

function AED takes player p2 returns string
  local string s=GetObjectName('n0FS')
  set s=FA9(s,"$p2",udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r")
  set s=FA9(s,"$c1","|c006699CC")
  return s
endfunction

function AFD takes player p returns nothing
  local integer VT8
  local integer VU8
  if(IsSentinel(p))then
    set VT8=1
    set VU8=5
    loop
      exitwhen VT8>VU8
      if(Sentinels[VT8]!=p)then
        if(IsPlayer(Sentinels[VT8]))then
          call SetPlayerAllianceStateBJ(p,Sentinels[VT8],4)
        endif
      endif
      set VT8=VT8+1
    endloop
  else
    set VT8=1
    set VU8=5
    loop
      exitwhen VT8>VU8
      if(Scourges[VT8]!=p)then
        if(IsPlayer(Scourges[VT8]))then
          call SetPlayerAllianceStateBJ(p,Scourges[VT8],4)
        endif
      endif
      set VT8=VT8+1
    endloop
  endif
endfunction

function AGD takes nothing returns nothing
  if GetOwningPlayer(GetEnumUnit())==FM then
    call SetUnitOwner(GetEnumUnit(),GM,true)
  elseif GetOwningPlayer(GetEnumUnit())==GM then
    call SetUnitOwner(GetEnumUnit(),FM,true)
  endif
endfunction

function AHD takes unit u,player p returns nothing
  local real x1
  local real y1
  local real x2
  local real y2
  local integer i
  local item Item
  if IsSentinel(p)then
    set x1=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y1=GetRectCenterY(gg_rct_Hero_Creation_UD)
    set x2=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y2=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x1=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y1=GetRectCenterY(gg_rct_Hero_Creation_NE)
    set x2=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y2=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  call SetUnitX(u,x1)
  call SetUnitY(u,y1)
  if IsCourier(u)then
    call IssueImmediateOrderById(u,852246)
  endif
  if IsUnitType(u,UNIT_TYPE_HERO) then
    call SaveBoolean(HY,(GetHandleId(u)),(140),(true))
    call SaveInteger(HY,(GetHandleId((u))),((4259)),2)
    call UnitRemoveAbility(u,'A04R')
    call SetUnitInvulnerable(u,false)
    call PauseUnit(u,false)
    set i=0
    loop
      exitwhen i>5
      set Item=UnitItemInSlot(u,i)
      if GetUnitTypeId(u)!='H00J' and Item!=null and(GetItemPlayer(Item)!=GetOwningPlayer(u)and GetIndex(Item)!=indexid_DivineRapier and GetIndex(Item)!=indexid_DivineRapierFree)and GetItemTypeId(Item)!=Item_Real[indexid_Aegis]then
        call UnitRemoveItem(u,Item)
      endif
      set i=i+1
    endloop
  endif
  call SetUnitX(u,x2)
  call SetUnitY(u,y2)
  call SetUnitColor(u,GetPlayerColor(p))
  set Item=null
endfunction

function AID takes nothing returns boolean
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) or IsCourier(GetFilterUnit())then
    call AHD(GetFilterUnit(),WM)
  elseif GetUnitTypeId(GetFilterUnit())=='ncop' then
    call IssueImmediateOrderById(GetFilterUnit(),852246)//drop item from circle
  elseif GetUnitTypeId(GetFilterUnit())=='u00B' then
    return true
  endif
  return false
endfunction

function AJD takes item i,player p returns nothing
  local real x
  local real y
  if IsSentinel(p)then
    set x=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y=GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y=GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  call SetItemPosition(i,x,y)
endfunction

function AKD takes nothing returns nothing
  if GetItemPlayer(GetEnumItem())==WM then
    call AJD(GetEnumItem(),WM)
  endif
endfunction

function AMD takes player p1,player p2 returns nothing
  local group g1=GetAvailableGroup()
  local group g2=GetAvailableGroup()
  set WM=p1
  call GroupEnumUnitsOfPlayer(g1,p1,Condition(function AID))
  set WM=p2
  call GroupEnumUnitsOfPlayer(g2,p2,Condition(function AID))
  call ForGroup(g1,function AGD)
  call ForGroup(g2,function AGD)
  set WM=p1
  call EnumItemsInRect(GetWorldBounds(),Condition(function ReturnTrue),function AKD)
  set WM=p2
  call EnumItemsInRect(GetWorldBounds(),Condition(function ReturnTrue),function AKD)
  call KillGroup(g1)
  call KillGroup(g2)
  set g1=null
  set g2=null
endfunction

function NeverTakesSuchName takes player p1,player p2 returns nothing
  local integer x
  local integer y
  local integer i
  local integer i1
  local integer i2
  local real x1
  local real y1
  local real x2
  local real y2
  local player p
  local string A9D=udg_Colors[GetPlayerId(p1)]+(PlayerNames[GetPlayerId((p1))])+"|r"
  local string ADD=udg_Colors[GetPlayerId(p2)]+(PlayerNames[GetPlayerId((p2))])+"|r"
  local integer YND
  local integer AOD
  local integer APD
  set YND=ReliableGold[GetPlayerId(p1)]
  set ReliableGold[GetPlayerId(p1)]=ReliableGold[GetPlayerId(p2)]
  set ReliableGold[GetPlayerId(p2)]=YND
  call Traffic_RegisterData("SWITCH_"+I2S(GetPlayerId(p1))+"_"+I2S(GetPlayerId(p2)),0)
  call Traffic_RegisterData("SWITCH_"+I2S(GetPlayerId(p2))+"_"+I2S(GetPlayerId(p1)),0)
  if IsSentinel(p1)then
    set x1=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y1=GetRectCenterY(gg_rct_Hero_Creation_UD)
  else
    set x1=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y1=GetRectCenterY(gg_rct_Hero_Creation_NE)
  endif
  if IsSentinel(p2)then
    set x2=GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y2=GetRectCenterY(gg_rct_Hero_Creation_UD)
  else
    set x2=GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y2=GetRectCenterY(gg_rct_Hero_Creation_NE)
  endif
  set i=1
  loop
    exitwhen i>5
    if Sentinels[i]==p1 or Scourges[i]==p1 then
      set i1=i
    endif
    if Sentinels[i]==p2 or Scourges[i]==p2 then
      set i2=i
    endif
    set i=i+1
  endloop
  if IsSentinel(p1)then
    set Scourges[i2]=p1
    set Sentinels[i1]=p2
  else
    set Sentinels[i2]=p1
    set Scourges[i1]=p2
  endif
  call SetPlayerTeam(Sentinels[0],0)
  call SetPlayerTeam(Sentinels[1],0)
  call SetPlayerTeam(Sentinels[2],0)
  call SetPlayerTeam(Sentinels[3],0)
  call SetPlayerTeam(Sentinels[4],0)
  call SetPlayerTeam(Sentinels[5],0)
  call SetPlayerTeam(Scourges[0],1)
  call SetPlayerTeam(Scourges[1],1)
  call SetPlayerTeam(Scourges[2],1)
  call SetPlayerTeam(Scourges[3],1)
  call SetPlayerTeam(Scourges[4],1)
  call SetPlayerTeam(Scourges[5],1)
  call HK9()
  set x=0
  set y=0
  loop
    exitwhen x>5
    loop
      exitwhen y>5
      call SetPlayerAllianceStateBJ(Sentinels[x],Sentinels[y],3)
      call SetPlayerAllianceStateBJ(Scourges[x],Scourges[y],3)
      call SetPlayerAllianceStateBJ(Sentinels[x],Scourges[y],0)
      call SetPlayerAllianceStateBJ(Scourges[x],Sentinels[y],0)
      set y=y+1
    endloop
    set y=0
    set x=x+1
  endloop
  call ForceClear(Force_Elfs)
  call ForceClear(Force_Unds)
  call ForceAddPlayer(Force_Elfs,Sentinels[0])
  call ForceAddPlayer(Force_Elfs,Sentinels[1])
  call ForceAddPlayer(Force_Elfs,Sentinels[2])
  call ForceAddPlayer(Force_Elfs,Sentinels[3])
  call ForceAddPlayer(Force_Elfs,Sentinels[4])
  call ForceAddPlayer(Force_Elfs,Sentinels[5])
  call ForceAddPlayer(Force_Unds,Scourges[0])
  call ForceAddPlayer(Force_Unds,Scourges[1])
  call ForceAddPlayer(Force_Unds,Scourges[2])
  call ForceAddPlayer(Force_Unds,Scourges[3])
  call ForceAddPlayer(Force_Unds,Scourges[4])
  call ForceAddPlayer(Force_Unds,Scourges[5])
  call ExeFunc("HM9")
  call AMD(p1,p2)
  set YM=true
  if AbilityDraftMultiboard==null then
    call PanCameraToTimedForPlayer(p1,x1,y1,0)
    call PanCameraToTimedForPlayer(p2,x2,y2,0)
  endif
  call StorePlayersColorValues()
  set BM=false
  if XM!=null then
    call TriggerEvaluate(XM)
  endif
  if GetPlayerSlotState(p2)==PLAYER_SLOT_STATE_EMPTY then
    set PlayerNames[GetPlayerId(p2)]=GetPlayerName(p2)
  endif
  set i=1
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if IsPlayerLeaver(p)then
      call AFD(p)
    endif
    set p=Scourges[i]
    if IsPlayerLeaver(p)then
      call AFD(p)
    endif
    set i=i+1
  endloop
  call A4D()
  call Trig_display_leaderboard_Actions()
  call ClearTextMessages()
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20," ")
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,A8D(A9D,ADD))
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20," ")
  call GP9(p1)
  call GP9(p2)
  set AOD=RH8(GetPlayerId(p1))
  set APD=RH8(GetPlayerId(p2))
  set YND=PlayersId[AOD]
  set PlayersId[AOD]=PlayersId[APD]
  set PlayersId[APD]=YND
  set PlayerFFed[GetPlayerId(p1)]=false
  set PlayerFFed[GetPlayerId(p2)]=false
  if AbilityDraftMultiboard!=null then
    call UpdateSkillPickingMB_Switch()
  endif
  set p=null
endfunction

function AQD takes nothing returns nothing
  local integer i=1
  local player p
  set JM=0
  set KM=0
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if IsPlayer(p)then
      set KM=KM+1
      if HM[GetPlayerId(p)] then
        set JM=JM+1
      endif
    endif
    set p=Scourges[i]
    if IsPlayer(p)then
      set KM=KM+1
      if HM[GetPlayerId(p)] then
        set JM=JM+1
      endif
    endif
    set i=i+1
  endloop
  set p=null
endfunction

function ARD takes nothing returns nothing
  set BM=false
  if XM!=null then
    call TriggerEvaluate(XM)
  endif
  call ClearTextMessages()
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,Z5D(GetTriggerPlayer()))
endfunction

function ASD takes nothing returns nothing
  local integer i=1
  local player p
  local integer ATD=0
  local integer AUD=0
  local integer AVD=0
  if HM[GetPlayerId(GetTriggerPlayer())]==false then
    set HM[GetPlayerId(GetTriggerPlayer())]=true
    call AQD()
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,udg_Colors[GetPlayerId(GetTriggerPlayer())]+(PlayerNames[GetPlayerId((GetTriggerPlayer()))])+"|r|c006699CC "+GetObjectName('n0FT')+"|r ("+I2S(JM)+"/"+I2S(KM)+")")
  endif
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if IsPlayer(p)and HM[GetPlayerId(p)]==false then
      set ATD=ATD+1
      set AVD=AVD+1
    endif
    if IsPlayer(p)and HM[GetPlayerId(p)] then
      set AUD=AUD+1
      set AVD=AVD+1
    endif
    set p=Scourges[i]
    if IsPlayer(p)and HM[GetPlayerId(p)]==false then
      set ATD=ATD+1
      set AVD=AVD+1
    endif
    if IsPlayer(p)and HM[GetPlayerId(p)] then
      set AUD=AUD+1
      set AVD=AVD+1
    endif
    set i=i+1
  endloop
  if ATD<2 and AUD>=R2I(AVD/ 2)then
    if(AVD==2 and AUD>1)or AVD!=2 then
      call NeverTakesSuchName(FM,GM)
    endif
  endif
  set p=null
endfunction

function AWD takes nothing returns nothing
  local integer i=1
  local player p=GetTriggerPlayer()
  local player AXD
  local string s
  local string s2
  loop
    exitwhen i>5
    set s=""
    set s2=""
    if IsSentinel(p)then
      set AXD=Scourges[i]
    else
      set AXD=Sentinels[i]
    endif
    if GetPlayerSlotState(AXD)==PLAYER_SLOT_STATE_LEFT and GetPlayerController(AXD)==MAP_CONTROL_USER then
      set s="|c00ff0303["+GetObjectName('n0FY')+"]|r"
    endif
    if udg_Hero[GetPlayerId(AXD)]!=null then
      set s2=" ("+GetUnitName(udg_Hero[GetPlayerId(AXD)])+")"
    endif
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,15,GetObjectName('n083')+"|c006699CC "+"-switch "+I2S(i)+"|r "+GetObjectName('n0FQ')+" "+udg_Colors[GetPlayerId(AXD)]+(PlayerNames[GetPlayerId((AXD))])+s2+"|r "+s)
    set i=i+1
  endloop
  set p=null
endfunction

function AYD takes nothing returns boolean
  local integer i=0
  if BM then
    call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,"|c00ff0303"+GetObjectName('n0FU')+"|r")
  endif
  set SwitchUnlockingAvailable=true
  set BM=false
  set FM=null
  set GM=null
  loop
    exitwhen i>16
    set HM[i]=false
    set i=i+1
  endloop
  call CleanTrigger(GetTriggeringTrigger())
  set XM=null
  return false
endfunction

function AZD takes player p1,player p2 returns nothing
  local trigger t=CreateTrigger()
  local integer i=0
  local string s
  local string OZD
  local string msg2
  local string msg3
  local player p
  local string s2
  set SwitchUnlockingAvailable=false
  set BM=true
  set FM=p1
  set GM=p2
  loop
    exitwhen i>16
    set HM[i]=false
    set i=i+1
  endloop
  set HM[GetPlayerId(FM)]=true
  call TriggerRegisterTimerEvent(t,60,false)
  call TriggerAddCondition(t,Condition(function AYD))
  set XM=t
  set s=A7D(p1,p2)
  set s2=Z2D()
  set i=1
  loop
    exitwhen i>5
    set p=Sentinels[i]
    if p!=p1 then
      call DisplayTimedTextToPlayer(p,0,0,20,s)
      call DisplayTimedTextToPlayer(p,0,0,20,s2)
    endif
    set p=Scourges[i]
    if p!=p1 then
      call DisplayTimedTextToPlayer(p,0,0,20,s)
      call DisplayTimedTextToPlayer(p,0,0,20,s2)
    endif
    set i=i+1
  endloop
  set s=AED(p2)
  call DisplayTimedTextToPlayer(p1,0,0,20,s)
  set t=null
  set p=null
endfunction

function SwitchChatCmd takes nothing returns nothing
  if Mode_SO==false then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0GX'))
    return
  endif
  if GetEventPlayerChatString()=="-switch accept"or GetEventPlayerChatString()=="-ok"then
    if BM then
      call ASD()
    endif
  elseif GetEventPlayerChatString()=="-no"then
    if BM then
      call ARD()
    endif
  elseif GetEventPlayerChatString()=="-switch"then
    if BM==false then
      call AWD()
    endif
  elseif BM==false then
    set VM=S2I(SubString(GetEventPlayerChatString(),8,StringLength(GetEventPlayerChatString())))
    if VM>0 and VM<6 then
      if IsSentinel(GetTriggerPlayer())then
        if HeroHasBeenUnlocked[GetPlayerId(Scourges[VM])]==false then
          call AZD(GetTriggerPlayer(),Scourges[VM])
        else
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0HY'))//The enemy team has unlocked that hero's items. He cannot be switched.
        endif
      else
        if HeroHasBeenUnlocked[GetPlayerId(Sentinels[VM])]==false then
          call AZD(GetTriggerPlayer(),Sentinels[VM])
        else
          call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,GetObjectName('n0HY'))
        endif
      endif
    endif
  endif
endfunction

function X0D takes nothing returns nothing
  call SetUnitAnimation(udg_Hero[GetPlayerId(GetTriggerPlayer())],"sleep")
endfunction

function X2D takes nothing returns nothing
  call SetUnitAnimationByIndex(udg_Hero[GetPlayerId(GetTriggerPlayer())],23)
endfunction

function RemindAboutSP takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer i=1
  local player p
  loop
    set p=Player(i)
    if HidePassivesForPlayer[i]==false then
      call DisplayTimedTextToPlayer(p,0,0,15,"|c006699CCTIP: Hide passive spells by writing -SP (You can still level them)|r")
    endif
    set i=i+1
    exitwhen i>11
  endloop
  call DestroyTimer(t)
  set t=null
endfunction

function RemindAboutSI takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer i=1
  local player p
  loop
    set p=Player(i)
    if SpellInfoShown[i]==false then
      call DisplayTimedTextToPlayer(p,0,0,15,"|c006699CCTIP: View your allies' spells in the scoreboard by writing -SI|r")
    endif
    
    set i=i+1
    exitwhen i>11
  endloop
  call DestroyTimer(t)
  set t=null
endfunction

function ModePicked takes nothing returns nothing
  local trigger t
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function RTD))
  set NK=CreateTimer()
  if b_isPickTime then
    if s_MainMode=="sd" then
      set CreepSpawnTime=CreepSpawnTimeForSD+(NumberOfExtraAbilities*30)
    elseif s_MainMode=="md" then
      set CreepSpawnTime=CreepSpawnTimeForMD+(NumberOfExtraAbilities*30)
    elseif s_MainMode=="ap" then
      set CreepSpawnTime=baseCreepSpawnTime+(NumberOfExtraAbilities*30)
    else
      set CreepSpawnTime=90
    endif
    if Mode_RA then
      set CreepSpawnTime=CreepSpawnTime-(NumberOfExtraAbilities*30)
    endif
  else
    if s_MainMode=="rd"then
      set CreepSpawnTime=CreepSpawnTimeForRD
    else
      set CreepSpawnTime=90
    endif
  endif
  call TimerStart(NK,CreepSpawnTime+1,false,function HelpPlayerIfNotReady)
  
  set TIMERIMG[1]=false
  set TIMERIMG[2]=false
  set TIMERIMG[3]=false
  if Mode_AR==false and Mode_RD==false then
    call ExeFunc("ShowTimersInit")
  endif
  set t=null
endfunction

function IsInvokersOrbs takes integer spell returns boolean
  return spell=='A21V' or spell=='A21W' or spell=='A21X'
endfunction

function Reduced_Spell takes integer spell returns boolean
  return spell=='A0FW' or spell=='A0GP' or spell=='A1EL' or spell=='A2BE' or spell=='A1S4' or spell=='A020' or spell=='A02Z'
endfunction

function Reduced_Spell_Proc takes unit u, integer spell returns boolean
  local integer info = GetHandleId(u)
  local boolean b = LoadBoolean(MHT,info,spell)
  call SaveBoolean(MHT,info,spell,b==false)
  return b==false
endfunction

function Semi_Valid_Spell takes integer spell returns boolean
  if IsInvokersOrbs(spell) then
    return false
  endif
  if Reduced_Spell(spell)then
    return LoadBoolean(MHT,GetHandleId(GetTriggerUnit()),spell)
  endif
  return true
endfunction

function isItemSpellOrNoCd takes integer x returns boolean
  return x=='QM01' or x=='A0JT' or x=='A2TH' or x=='A0DI' or x=='A231' or x=='A1ZH' or x=='A1ZI' or x=='A1ZW' or x=='A28D' or x=='A2KG' or x=='A2K3' or x=='A2EA' or x=='A2K1' or x=='A2K4' or x=='A2K7' or x=='A06X' or x=='A0AQ' or x=='A14O' or x=='A0NE' or x=='A14O' or x=='A1C0' or x=='A418' or x=='A0K7' or x=='A1AC' or x=='A1QD' or x=='A0JL' or x=='AIpg' or x=='A11F' or x=='A0T9' or x=='A1T7' or x=='AIcy' or x=='A19M' or x=='A02O' or x=='A0FD' or x=='AChx' or x=='A1EW' or x=='A332' or x=='A2N1' or x=='A590' or x=='A591' or x=='A592' or x=='A593' or x=='A02Z' or x=='A0GC'
endfunction

function isFormlessAbility takes integer id returns boolean
  return id=='A40K' or id=='A40L' or id=='A40M' or id=='A40N' or id=='A590' or id=='A591' or id=='A592' or id=='A593'
endfunction

function isSkillWithZeroCD takes integer spell returns boolean
  return spell=='A02Z'
endfunction

function Valid_Spell takes integer spell returns boolean
  return spell!=0 and Semi_Valid_Spell(spell) and isPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and IsItemAbilityById(spell)==false and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 and isFormlessAbility(spell)==false and isSkillWithZeroCD(spell)==false
endfunction

function IsSpellInMulticastRestrictionList takes integer id returns boolean
  return id=='A2T5' or id=='A2TJ' or id=='A2QI' or id=='A43J' or id=='A1A1' or id=='A1B3' or id=='A0QR' or id=='A0JC' or id=='A1DP' or id=='A461'
endfunction

function BalanceOffSpellChecker takes integer spell returns boolean
  return isPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and IsItemAbilityById(spell)==false and isFormlessAbility(spell)==false
endfunction

function MulticastSpellRestriction takes integer si returns boolean
  return IsSpellInMulticastRestrictionList(si)==false and isItemSpellOrNoCd(si)==false and isDummyAbility(si)==false and isAintItemAbility(si) and IsItemAbilityById(si)==false and IsInvokersOrbs(si)==false and si!='A2M0' and si!='A32G' and si!='A32E' and si!='A32D' and si!='A32C' and si!='A32A' and si!='A0ZF'
endfunction

function BHD takes nothing returns nothing
  local integer PlayerId
  local integer hn
  local integer xx
  local integer id
  set PlayerId=0
  
  if IsObserver(GetLocalPlayer())==false then
    call ClearSelection()
  endif
  
  loop
    if IsObserver(Player(PlayerId))==false then
      call BL8(Player(PlayerId))
      call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|cff99ccff"+" "+"Your spells:"+"|r")
      set xx=1
      loop
        set id=PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]
        if id>600 then
          call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+"Invoker"+")"+"|r")
        else
          if xx==4 or xx==6 then
            call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+"|c00ff0303"+GetObjectName(SkillID[id])+"|r"+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
          else
            call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"	"+GetObjectName(SkillID[id])+"|cffffcc00"+" ("+GetObjectName(HeroID[(id+3)/4])+")"+"|r")
          endif
        endif
        set xx=xx+1
        exitwhen xx>4+NumberOfExtraAbilities
      endloop
      if MeleeOrRangedRestricted[PlayerId]==1 then
        call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
        call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|c00FF0000[LoD]|r|c006699CC"+" "+"You can only pick MELEE heroes."+"|r")
      elseif MeleeOrRangedRestricted[PlayerId]==2 then
        call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
        call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|c00FF0000[LoD]|r|c006699CC"+" "+"You can only pick RANGED heroes."+"|r")
      endif
      call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
      call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
      call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15,"|cff99ccff"+"You can now pick your hero."+"|r")
      call DisplayTimedTextToPlayer(Player(PlayerId),0,0,15," ")
      call SoundForPlayer(Player(PlayerId),"Sound\\Interface\\Rescue.wav")
      call SuspendTimeOfDay(false)
      set hn=1
      call HeroAttackTypeRestrictionForPlayer(Player(PlayerId),MeleeOrRangedRestricted[PlayerId])
    endif
    set PlayerId=PlayerId+1
    exitwhen PlayerId>11
  endloop
endfunction

function BID takes integer i returns nothing
  local integer k=R2I((I2R(i)+3.)/ 4.)
  if k>151 then
    set k=151
  endif
  if not(b_IsHeroAlreadyPreloaded[k])then
    call InitHeroAndSkillsRelated(k,i)
    set b_IsHeroAlreadyPreloaded[k]=true
  endif
  if HaveSavedString(MHT,SkillID[i],600) and LoadBoolean(MHT,SkillID[i],600)==false then
    call SaveBoolean(MHT,SkillID[i],600,true)
    call ExeFunc(LoadStr(MHT,SkillID[i],600))
    call echo(LoadStr(MHT,SkillID[i],600)+" preloaded")
  endif
endfunction

function BKD takes integer PlayerId returns nothing
  local integer xx=1
  loop
    call BID(PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx])
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
endfunction

function DelayedUpgradedCourier_Go takes nothing returns nothing
  call DestroyTimer(GetExpiredTimer())//n0KG
  set FlyingCourierAllowed=true
endfunction

function AddFlyingCourierIfSolo takes nothing returns nothing
  local unit u
  set FlyingCourierAllowed=true
  call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h03Q',1,1)
  call AddUnitToStock(SentinelBuilding_ShopChimaera,'h03Q',1,1)
  set u=CreateUnit(Player(15),'uC74',-7360-128,-6388,270)
  call SetUnitVertexColor(u,255,100,0,255)
  set u=CreateUnit(Player(15),'uC74',6724,6592,270)
  call SetUnitVertexColor(u,255,100,0,255)
  set u=null
endfunction

function DisableRepick takes nothing returns nothing
  set Z3=true
endfunction

function ShowCredits takes nothing returns nothing
  if Mode_S5 or Mode_S6 then
    call TimerStart(CreateTimer(),20+180,false,function RemindAboutSP)
  endif
  call TimerStart(CreateTimer(),20+300,false,function RemindAboutSI)
  call TimerStart(CreateTimer(),20,false,function DisableRepick)
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c00FF0000MAP by:  DracoL1ch & ResQ|r")
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c006699CCGet updates about LoD, view changelogs|r")
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,"|c006699CCand post any suggestions on:|r")
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," ")
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15," |cFFFF8000www.LegendsOfDotA.com|r")
  call TimerStart(CreateTimer(),20+180,false,function DelayedUpgradedCourier_Go)
endfunction

function CleanTaverns takes nothing returns nothing
  //call TechHeroForAll('HIV2')
  //call TechHeroForAll('HIV3')
  //call TechHeroForAll('HnUT')
endfunction

function IsPickingDummy takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='n00C'
endfunction

function ShowPickDummy takes nothing returns nothing
  call ShowUnit(GetEnumUnit(),true)
endfunction

function HidePickDummy takes nothing returns nothing
  call ShowUnit(GetEnumUnit(),false)
endfunction

function RevealPickers takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group g=LoadGroupHandle(HY,h,0)
  call ForGroup(g,function ShowPickDummy)
  call KillGroup(g)
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set g=null
  set t=null
endfunction

function PrePickHiding takes integer pid returns nothing
  local timer t=CreateTimer()
  local group g=GetAvailableGroup()
  call TimerStart(t,4,false,function RevealPickers)
  call GroupEnumUnitsOfPlayer(g,Player(pid),Condition(function IsPickingDummy))
  call ForGroup(g,function HidePickDummy)
  call SaveGroupHandle(HY,GetHandleId(t),0,g)
  set g=null
  set t=null
endfunction

function BMD takes nothing returns nothing
  local trigger t
  local integer PlayerId
  local timer credits
  if Mode_RD then
    return
  endif
  set PlayerId=0
  if TimerGetRemaining(NK)>0 then
    loop
      if QV8(PlayerId)then
        if not(b_isPlayerReady[PlayerId]) then
          return
        endif
      endif
      set PlayerId=PlayerId+1
      exitwhen PlayerId>12
    endloop
  endif
  set b_AllPlayersReady=true
  set PlayerId=0
  loop
    if QV8(PlayerId)then
      call VG9(Player(PlayerId))
      call PlacePickDummies(Player(PlayerId))
      call BKD(PlayerId)
    endif
    if bj_isSinglePlayer==false then
      call PrePickHiding(PlayerId)
    endif
    call FlushChildHashtable(HY,GetHandleId(SpellPickingDummy[PlayerId]))
    call RemoveUnit(SpellPickingDummy[PlayerId])
    set PlayerId=PlayerId+1
    exitwhen PlayerId>12
  endloop
  call PanCameraToTimed(-6990.,6840.,.0)   //-7008.,6816.	changed because it was strangecam
  call RemoveUnit(AddTime1)
  call RemoveUnit(AddTime2)
  call RemoveUnit(AddTime3)
  call RemoveUnit(AddTime4)
  call RemoveUnit(AltarOfRandom)
  call CleanTaverns()
  call DestroyMultiboard(AbilityDraftMultiboard)
  call MultiboardDisplay(MainMB,true)
  call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',1,2)
  call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',1,2)
  call ClearSelection()
  set b_isPickTime=false
  call DestroyTimer(NK)
  set NK=CreateTimer()
  call TimerStart(NK,90+1,false,null)
  set credits=CreateTimer()
  call TimerStart(credits,70,false,function ShowCredits)
  if Mode_FN then
    call NeutralsRespawn()
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,30,false)
    call TriggerRegisterTimerEvent(t,90,false)
    call TriggerAddCondition(t,Condition(function NeutralsRespawn))
    set t=null
  endif
  call EnableTrigger(HeroEnters)
  set credits=null
  call BHD()
endfunction

function UpdateAbilityDraftMB takes integer pid,integer sn,integer aid returns nothing
  local multiboarditem mi
  local string s=SkillIcon[aid]
  if Mode_Debug then
    if IsScourge(Player(pid)) then
      set mi=MultiboardGetItem(AbilityDraftMultiboard,(pid+2)-1,sn-1)
    else
      set mi=MultiboardGetItem(AbilityDraftMultiboard,(pid+1)-1,sn-1)
    endif
  else
    set mi=MultiboardGetItem(AbilityDraftMultiboard,XK7[pid]-1,sn-1)
  endif
  if IsSentinel(Player(pid)) and Mode_SS==false then
    if IsScourge(GetLocalPlayer()) then
      if aid==0 then
        set s=SkillIcon[0]
      else
        set s="ReplaceableTextures\\CommandButtons\\BTNQuestion.blp"
      endif
    endif
  elseif IsScourge(Player(pid)) and Mode_SS==false then
    if IsSentinel(GetLocalPlayer()) then
      if aid==0 then
        set s=SkillIcon[0]
      else
        set s="ReplaceableTextures\\CommandButtons\\BTNQuestion.blp"
      endif
    endif
  endif
  call MultiboardSetItemIcon(mi,s)
  call MultiboardReleaseItem(mi)
  set mi=null
endfunction

function BSFC takes integer id returns nothing
  set DisablesList[DisablesListCount]=id
  set DisablesListCount=DisablesListCount+1
endfunction

function BanStunsFomComboing takes nothing returns nothing
  call BSFC((indexid_ES-1)*4+1)//Fissure
  call BSFC((indexid_Sven-1)*4+1)//Storm bolt
  call BSFC((indexid_Tiny-1)*4+1)//Avalanche
  call BSFC((indexid_Admiral-1)*4+1)//Torrent
  call BSFC((indexid_Beastmaster-1)*4+4)//Primal roar
  call BSFC((indexid_DK-1)*4+2)//Dragon tail
  call BSFC((indexid_Alchemist-1)*4+2)//Unstable Conconction
  call BSFC((indexid_Treant-1)*4+4)//Overgrowth
  call BSFC((indexid_Centaur-1)*4+4)//Hoof stomp
  call BSFC((indexid_Pudge-1)*4+4)//Dismember
  call BSFC((indexid_SK-1)*4+1)//Burrowstrike
  call BSFC((indexid_Slardar-1)*4+2)//Slithereen crush
  call BSFC((indexid_Tide-1)*4+4)//Ravage
  call BSFC((indexid_Leoric-1)*4+1)//Hellfire blast
  call BSFC((indexid_Nessaj-1)*4+1)//Chaos bolt
  call BSFC((indexid_Magnus-1)*4+4)//Reverse polarity
  call BSFC((indexid_VS-1)*4+1)//Magic missile
  call BSFC((indexid_Potm-1)*4+2)//Elunes arrow
  call BSFC((indexid_Gyro-1)*4+2)//Homing missile
  call BSFC((indexid_NagaSiren-1)*4+2)//Ensnare
  call BSFC((indexid_Xin-1)*4+1)//Xin's chains
  call BSFC((indexid_Void-1)*4+4)//Chronosphere
  call BSFC((indexid_Geomancer-1)*4+1)//Earthbind
  call BSFC((indexid_NA-1)*4+1)//Impale
  call BSFC((indexid_Medusa-1)*4+4)//Stone gaze
  call BSFC((indexid_CM-1)*4+2)//Frostbite
  call BSFC((indexid_Storm-1)*4+2)//Storm's thing
  call BSFC((indexid_WR-1)*4+1)//Shackleshot
  call BSFC((indexid_Lina-1)*4+2)//Light strike array
  call BSFC((indexid_Rhasta-1)*4+2)//Hex
  call BSFC((indexid_Rhasta-1)*4+3)//Rhasta's net
  call BSFC((indexid_THD-1)*4+2)//Ice path
  call BSFC((indexid_OgreMagi-1)*4+1)//Fireblast
  call BSFC((indexid_Rubick-1)*4+1)//Telekinesis
  call BSFC((indexid_Bane-1)*4+3)//Nightmare
  call BSFC((indexid_Bane-1)*4+4)//Bane's ulti
  call BSFC((indexid_Lion-1)*4+1)//Impale
  call BSFC((indexid_Lion-1)*4+2)//Hex
  call BSFC((indexid_WD-1)*4+1)//Sounds_Ownage's casks
  call BSFC((indexid_Enigma-1)*4+1)//Malefice
  call BSFC((indexid_Leshrak-1)*4+1)//Split earth
  call BSFC((indexid_AA-1)*4+1)//Cold feet
  call BSFC((indexid_OD-1)*4+2)//Astral imprisonment
  call BSFC((indexid_SD-1)*4+1)//Disruption
  call BSFC((indexid_Oracle-1)*4+1)//Oracle's purge
  call BSFC((indexid_Centaur-1)*4+1)//Hoof stomp
  call BSFC((indexid_Admiral-1)*4+4)//Ghost ship
  call BSFC((indexid_Earth-1)*4+1)//Boulder Smash
  call BSFC((indexid_Barathum-1)*4+1)//Charge of darkness
  call BSFC((indexid_Kodo-1)*4+2)//Trample
  call BSFC((indexid_Morphling-1)*4+2)//Adaptive strike
  call BSFC((indexid_FireLord-1)*4+2)//Fire stomp
  
endfunction

function CheckDisablesPicked takes integer pid returns integer
  local integer k=0
  local integer c=0
  loop
    if DisablesList[k]!=0 then
      if PlayerSkillNumber[pid*PlayerSkillOffset+1]==DisablesList[k] or PlayerSkillNumber[pid*PlayerSkillOffset+2]==DisablesList[k]  or PlayerSkillNumber[pid*PlayerSkillOffset+3]==DisablesList[k] or PlayerSkillNumber[pid*PlayerSkillOffset+4]==DisablesList[k] or (NumberOfExtraAbilities>=1 and PlayerSkillNumber[pid*PlayerSkillOffset+5]==DisablesList[k]) or (NumberOfExtraAbilities>=2 and PlayerSkillNumber[pid*PlayerSkillOffset+6]==DisablesList[k]) then
        set c=c+1
      endif
    endif
    set k=k+1
    exitwhen k>DisablesListCount
  endloop
  return c
endfunction

function IfTrueshotPicked takes integer pid returns boolean
  local integer id=34*4+3
  local integer d=pid*PlayerSkillOffset
  if PlayerSkillNumber[d+1]==id or PlayerSkillNumber[d+2]==id  or PlayerSkillNumber[d+3]==id or PlayerSkillNumber[d+4]==id or (NumberOfExtraAbilities>=1 and PlayerSkillNumber[d+5]==id) or (NumberOfExtraAbilities>=2 and PlayerSkillNumber[d+6]==id) then
    return true
  endif
  return false
endfunction

function IsDisableSkill takes integer skillid returns boolean
  local integer k=0
  local boolean b=false
  loop
    if skillid==DisablesList[k] then
      set b=true
    endif
    set k=k+1
    exitwhen b or k>DisablesListCount
  endloop
  return b
endfunction

function IsMeleeUnitById takes integer hid returns boolean
  local integer i=1
  loop
    if HeroID[hid]==MeleeHeroesArray[i] then
      return true
    endif
    set i=i+1
    exitwhen i>MeleeHeroesAmount
  endloop
  return false
endfunction

function CheckAbilitiesForStacking takes integer newindex,integer PlayerId,boolean showMsgs returns boolean
  local boolean BRD=I2R(newindex/ 4)==I2R(newindex)/ 4.
  local boolean pr=true
  local integer ns=0  //stacking id for passives and number of abilities from the same hero
  local integer ns2=0 //2nd id
  local integer ns3=0 //3rd id
  local integer xx=0
  local integer RG8=0
  local integer BSD=0
  local integer BTD=0
  local string desc=""
  local integer abilityhero=0
  local integer abilityhero2=0
  local boolean toomanydisables=false
  local boolean toomanydisablescauseteam=false
  local player p=Player(PlayerId)
  local boolean isMeleeMorph
  local boolean isRangeMorph
  local boolean isMeleeOnly
  local boolean isRangeOnly
  local integer pidoff=PlayerId*PlayerSkillOffset
  local integer disablesmax
  local unit u
  if PlayerSkillNumber[pidoff+1]==newindex or PlayerSkillNumber[pidoff+2]==newindex or PlayerSkillNumber[pidoff+3]==newindex or PlayerSkillNumber[pidoff+4]==newindex or PlayerSkillNumber[pidoff+5]==newindex or PlayerSkillNumber[pidoff+6]==newindex then
    return false
  endif
  if newindex==(116-1)*4+4 or newindex==(115-1)*4+4  or newindex==(114-1)*4+4 then //Invoker has no ult :<
    set BRD=false
  endif
  if b_isPlayerReady[PlayerId]then
    call QB8(p,showMsgs,"You are ready")
    return false
  endif
  if IsAbilityDoesNotWork[newindex] then
    call QB8(p,showMsgs,"This skill doesn't work :(")
    return false
  endif
  if Mode_DM or s_MainMode=="ar" then
    if IsPermanentAbility[newindex] then
      return false
    endif
  endif
  if Mode_OS then
    if IsSentinel(p) then
      set RG8=1
    else
      set RG8=2
    endif
    if OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]!=0 then
      call QB8(p,showMsgs,"A player has already picked this ability: "+udg_Colors[OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]]+PlayerNames[OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]]+"|r")
      return false
    endif
  endif
  set xx=1
  loop
    if BRD then
      if xx==4 or xx==6 then
        if PlayerSkillNumber[pidoff+xx]==0 then
          set BTD=xx
          exitwhen true
        endif
      endif
    else
      if not(xx==4 or xx==6)then
        if PlayerSkillNumber[pidoff+xx]==0 then
          set BSD=xx
          exitwhen true
        endif
      endif
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  if BTD==0 and BRD then
    call QB8(p,showMsgs,"You need to pick a regular skill (not an ultimate).")
    return false
  endif
  if BSD==0 and not(BRD)then
    call QB8(p,showMsgs,"You need to pick an ultimate.")
    return false
  endif
  if Mode_RA then
    if PlayerSkillNumber[pidoff+5]==0 and NumberOfExtraAbilities>=1 then
      set BSD=5
    endif
    if PlayerSkillNumber[pidoff+6]==0 and NumberOfExtraAbilities>=2 then
      set BTD=6
    endif
  endif
  set isMeleeOnly=CheckStacking(newindex,-1,"melee only",null)
  set isMeleeMorph=CheckStacking(newindex,-1,"melee morph",null)
  set isRangeOnly=CheckStacking(newindex,-1,"range only",null)
  set isRangeMorph=CheckStacking(newindex,-1,"range morph",null)
  if PlayerId==0 then
    set u=LoadUnitHandle(HY,'0REA','000U')
    if u!=null then
      if IsMeleeUnitById(GetUnitUserData(u))then
        if isRangeOnly then
          set u=null
          return false
        endif
      else
        if isMeleeOnly then
          set u=null
          return false
        endif
      endif
    endif
  endif
  if isMeleeOnly or isMeleeMorph then
    set xx=1
    loop
      if CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"range only",null)or CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"range morph",null)then
        set ns=xx
        if isMeleeMorph then
          set desc="You cannot pick a melee transformation skill"
        else
          set desc="You cannot pick a melee only skill"
        endif
        exitwhen true
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
    set xx=1
    loop
      if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,"melee only")then
        set ns=xx
        set desc="buggy/orderids"
        exitwhen true
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  elseif isRangeOnly or isRangeMorph then
    set xx=1
    loop
      if CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"melee only",null)or CheckStacking(PlayerSkillNumber[pidoff+xx],-1,"melee morph",null)then
        set ns=xx
        if isRangeMorph then
          set desc="You cannot pick a ranged transformation skill"
        else
          set desc="You cannot pick a ranged only skill"
        endif
        exitwhen true
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
    set xx=1
    loop
      if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,"range only")then
        set ns=xx
        set desc="buggy/orderids"
        exitwhen true
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  else
    set xx=1
    loop
      if CheckStacking(PlayerSkillNumber[pidoff+xx],newindex,null,null)then
        set ns=xx
        set desc="buggy/orderids"
        exitwhen true
      endif
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  endif
  if IsMultiIconAbility[newindex] and (Mode_S5 or Mode_S6) then
    call QA8(p,showMsgs,"WARNING: This skill is Multi-icon type.")
  endif
  if newindex==(indexid_Trax-1)*4+3 then//trueshot wrapper
    if IsSentinel(p) then
      if IfTrueshotPicked(GetPlayerId(Sentinels[1])) or IfTrueshotPicked(GetPlayerId(Sentinels[2])) or IfTrueshotPicked(GetPlayerId(Sentinels[3])) or IfTrueshotPicked(GetPlayerId(Sentinels[4])) or IfTrueshotPicked(GetPlayerId(Sentinels[5])) then
        call QB8(p,showMsgs,"Your teammate already took this ability. Can't have another one.")
        return false
      endif
    else
      if IfTrueshotPicked(GetPlayerId(Scourges[1])) or IfTrueshotPicked(GetPlayerId(Scourges[2])) or IfTrueshotPicked(GetPlayerId(Scourges[3])) or IfTrueshotPicked(GetPlayerId(Scourges[4])) or IfTrueshotPicked(GetPlayerId(Scourges[5])) then
        call QB8(p,showMsgs,"Your teammate already took this ability. Can't have another one.")
        return false
      endif
    endif
  endif
  //	if ns==0 then
  //		if IsPassiveAbility[newindex] and (Mode_LS) then
  //			set xx=1
  //			loop
  //				if IsPassiveAbility[PlayerSkillNumber[pidoff+xx]] then
  //					if ns2==0 then
  //						set ns2=xx
  //					elseif Mode_LS3 then
  //						if ns3==0 then
  //							set ns3=xx
  //						else
  //							set ns=xx
  //							set desc="no more than 3 passives"
  //							exitwhen true
  //						endif
  //					else
  //						set ns=xx
  //						set desc="no more than 2 passives"
  //						exitwhen true
  //					endif
  //				endif
  //				set xx=xx+1
  //				exitwhen (xx>4+NumberOfExtraAbilities) or (xx>4 and Mode_RA)
  //			endloop
  //		endif
  //	endif
  if Mode_EB then
    set disablesmax=1
  else
    set disablesmax=2
  endif
  if IsDisableSkill(newindex) then
    set toomanydisables=CheckDisablesPicked(PlayerId)>=disablesmax
    if toomanydisables==false then
      if IsSentinel(p) then
        set toomanydisables=(CheckDisablesPicked(GetPlayerId(Sentinels[1]))+CheckDisablesPicked(GetPlayerId(Sentinels[2]))+CheckDisablesPicked(GetPlayerId(Sentinels[3]))+CheckDisablesPicked(GetPlayerId(Sentinels[4]))+CheckDisablesPicked(GetPlayerId(Sentinels[5])))>=7
      else
        set toomanydisables=(CheckDisablesPicked(GetPlayerId(Scourges[1]))+CheckDisablesPicked(GetPlayerId(Scourges[2]))+CheckDisablesPicked(GetPlayerId(Scourges[3]))+CheckDisablesPicked(GetPlayerId(Scourges[4]))+CheckDisablesPicked(GetPlayerId(Scourges[5])))>=7
      endif
      //call echo(I2S(CheckDisablesPicked(GetPlayerId(Sentinels[1]))+CheckDisablesPicked(GetPlayerId(Sentinels[2]))+CheckDisablesPicked(GetPlayerId(Sentinels[3]))+CheckDisablesPicked(GetPlayerId(Sentinels[4]))+CheckDisablesPicked(GetPlayerId(Sentinels[5]))))
      set toomanydisablescauseteam=toomanydisables
    endif
  endif
  if ns==0 then
    if (Mode_LS) then
      if toomanydisables==false then
        set ns2=0
        set ns3=0
        set abilityhero=(newindex-1)/4
        set xx=1
        loop
          if PlayerSkillNumber[pidoff+xx]!=0  then
            set abilityhero2=(PlayerSkillNumber[pidoff+xx]-1)/4
            if (abilityhero2==abilityhero) then
              if ns2==0 then
                set ns2=xx
              elseif Mode_LS3 then
                if ns3==0 then
                  set ns3=xx
                else
                  set ns=xx
                  set desc="no more than 3 abilities from the same hero"
                  exitwhen true
                endif
              else
                set ns=xx
                set desc="no more than 2 abilities from the same hero"
                exitwhen true
              endif
            endif
          endif
          set xx=xx+1
          exitwhen (xx>4+NumberOfExtraAbilities) or (xx>4 and Mode_RA)
        endloop
      endif
    endif
  endif
  if ns!=0 then
    if desc!="" then
      if ns3!=0 then
        call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns2]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns3]])+" ("+desc+")")
      elseif ns2!=0 then
        call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+"/"+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns2]])+" ("+desc+")")
      else
        call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]])+" ("+desc+")")
      endif
    else
      call QB8(p,showMsgs,"Does not stack with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+ns]]))
    endif
    return false
  endif
  if toomanydisables then
    if toomanydisablescauseteam==false then
      if disablesmax==2 then
        call QB8(p,showMsgs,"This spell cannot be picked, you already have 2 disables!")
      else
        call QB8(p,showMsgs,"This spell cannot be picked, you already have 1 disable and Extended Balance active!")
      endif
    else
      call QB8(p,showMsgs,"You cannot pick this disable! Your team already has 7 disables!")
    endif
    return false
  endif
  if HaveSavedString(UTable,SkillID[newindex],HOTKEY) then
    set xx=1
    loop
      if PlayerSkillNumber[pidoff+xx] > 0 and HaveSavedString(UTable,SkillID[PlayerSkillNumber[pidoff+xx]],HOTKEY) then
        if LoadStr(UTable,SkillID[newindex],HOTKEY)==LoadStr(UTable,SkillID[PlayerSkillNumber[pidoff+xx]],HOTKEY) then
          call QB8(p,showMsgs,"Hotkey issue with : "+GetObjectName(SkillID[PlayerSkillNumber[pidoff+xx]]))
          if HaveSavedBoolean(HeroStats,GetHandleId(Player(PlayerId)),'NSHK') and Mode_AR then
            return false
          endif
        endif
      endif
      set xx=xx+1
      exitwhen (xx>4+NumberOfExtraAbilities)
    endloop
  endif
  
  if BRD then
    set PlayerSkillNumber[pidoff+BTD]=newindex
    call UpdateAbilityDraftMB(PlayerId,BTD,newindex)
  else
    set PlayerSkillNumber[pidoff+BSD]=newindex
    call UpdateAbilityDraftMB(PlayerId,BSD,newindex)
  endif
  if Mode_OS then
    if OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]==0 then
      set OneSkillCheckArray[RG8*OneSkillOffsetCheck+newindex]=PlayerId
    endif
  endif
  set xx=1
  loop
    if PlayerSkillNumber[pidoff+xx]==0 then
      set pr=false
      exitwhen true
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  set b_isPlayerReady[PlayerId]=pr
  if isMeleeOnly then
    set MeleeOrRangedRestricted[PlayerId]=1
    call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is melee only.")
  elseif isRangeOnly then
    set MeleeOrRangedRestricted[PlayerId]=2
    call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is ranged only.")
  endif
  if isMeleeMorph then
    call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is a melee transformation.")
  elseif isRangeMorph then
    call DisplayWithoutClear(p,showMsgs,"WARNING: This skill is a ranged transformation.")
  endif
  if SkillID[newindex]=='A2CI' then//Duel
    call DisplayWithoutClear(p,showMsgs,"WARNING: Duel disables most passives on both the target and the caster.")
  endif
  if (not(Mode_BO)and BalanceStrings[newindex]!=null)then
    call DisplayWithoutClear(p,showMsgs,"BALANCE: "+BalanceStrings[newindex])
  endif
  if (Mode_EB and ExBalanceStrings[newindex]!=null)then
    call DisplayWithoutClear(p,showMsgs,"EXTENDED BALANCE: "+ExBalanceStrings[newindex])
  endif
  return true
endfunction

function VV9 takes nothing returns nothing
  local unit u=LoadUnitHandle(HY,'hRUT',1)
  local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
  local integer SJ8
  local integer i=0
  local integer te
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+1]=LoadInteger(HY,'hRUT',2)
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+2]=LoadInteger(HY,'hRUT',3)
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+3]=LoadInteger(HY,'hRUT',4)
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+4]=LoadInteger(HY,'hRUT',5)
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]=LoadInteger(HY,'hRUT',6)
  set PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]=LoadInteger(HY,'hRUT',7)
  set ExtraAbilityLevel[PlayerId*2+1]=LoadInteger(HY,'hRUT',8)
  set ExtraAbilityLevel[PlayerId*2+2]=LoadInteger(HY,'hRUT',9)
  //set UltimatesHeroId[PlayerId]=LoadInteger(HY,'hRUT',10)
  loop
    set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
    if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)then
      if not CheckStacking(SJ8,-1,"range only",null)then
        call SaveInteger(HY,'0REA','0PID',PlayerId)
        call SaveInteger(HY,'0REA','0SID',SJ8)
        call SaveBoolean(HY,'0REA','000B',false)
        call ExeFunc("BUD")
      endif
    else
      if not CheckStacking(SJ8,-1,"melee only",null)then
        call SaveInteger(HY,'0REA','0PID',PlayerId)
        call SaveInteger(HY,'0REA','0SID',SJ8)
        call SaveBoolean(HY,'0REA','000B',false)
        call ExeFunc("BUD")
      endif
    endif
    set i=i+1
    exitwhen b_isPlayerReady[PlayerId]
  endloop
  if not b_isPlayerReady[PlayerId] then
    call SaveInteger(HY,'hRUT',2,PlayerSkillNumber[PlayerId*PlayerSkillOffset+1])
    call SaveInteger(HY,'hRUT',3,PlayerSkillNumber[PlayerId*PlayerSkillOffset+2])
    call SaveInteger(HY,'hRUT',4,PlayerSkillNumber[PlayerId*PlayerSkillOffset+3])
    call SaveInteger(HY,'hRUT',5,PlayerSkillNumber[PlayerId*PlayerSkillOffset+4])
    call SaveInteger(HY,'hRUT',6,PlayerSkillNumber[PlayerId*PlayerSkillOffset+5])
    call SaveInteger(HY,'hRUT',7,PlayerSkillNumber[PlayerId*PlayerSkillOffset+6])
    call SaveInteger(HY,'hRUT',8,ExtraAbilityLevel[PlayerId*2+1])
    call SaveInteger(HY,'hRUT',9,ExtraAbilityLevel[PlayerId*2+2])
    //call SaveInteger(HY,'hRUT',10,UltimatesHeroId[PlayerId])
    call ExeFunc("VV9")
  endif
  call FlushChildHashtable(HY,'hRUT')
  call VP9(u,Player(PlayerId))
  call BKD(PlayerId)
  set b_isPlayerReady[PlayerId]=false
  set u=null
endfunction

function RUD takes nothing returns nothing
  local integer SJ8
  local integer BJD
  local integer PlayerId
  local integer te
  set PlayerId=0
  loop
    if QV8(PlayerId)then
      loop
        exitwhen b_isPlayerReady[PlayerId]
        if s_MainMode=="sd" or s_MainMode=="md" then
          loop
            set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
            exitwhen(b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false)
          endloop
          set SJ8=(BJD*4)-4
          set SJ8=SJ8+GetRandomInt(1,4)
          call SaveInteger(HY,'0REA','0PID',PlayerId)
          call SaveInteger(HY,'0REA','0SID',SJ8)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
        else
          loop
            set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
            set te=AdjustHeroNumber((SJ8+3)/4)
            exitwhen(IsHeroIngame[te]==false and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[te])>0)
          endloop
          call SaveInteger(HY,'0REA','0PID',PlayerId)
          call SaveInteger(HY,'0REA','0SID',SJ8)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
        endif
      endloop
      call BMD()
    endif
    set PlayerId=PlayerId+1
    exitwhen PlayerId>12
  endloop
endfunction

function BVD takes integer pid,integer sid returns boolean
  local integer xx
  local integer RG8
  local integer sn
  local integer pid2
  set sn=R2I((I2R(sid)+3.)/ 4.)
  set sn=sid-((sn-1)*4)
  if Mode_RA then
    if PlayerSkillNumber[pid*PlayerSkillOffset+5]==sid and NumberOfExtraAbilities>=1 then
      call QB8(Player(pid),true,"You cannot remove this skill on \"Random Extra Abilities\" mode.")
      return false
    endif
    if PlayerSkillNumber[pid*PlayerSkillOffset+6]==sid and NumberOfExtraAbilities>=2 then
      call QB8(Player(pid),true,"You cannot remove this skill on \"Random Extra Abilities\" mode.")
      return false
    endif
  endif
  set xx=1
  loop
    if(PlayerSkillNumber[pid*PlayerSkillOffset+xx]==sid)then
      set PlayerSkillNumber[pid*PlayerSkillOffset+xx]=0
      call UpdateAbilityDraftMB(pid,xx,0)
      exitwhen true
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  set MeleeOrRangedRestricted[pid]=0
  set xx=1
  loop
    if CheckStacking(PlayerSkillNumber[pid*PlayerSkillOffset+xx],-1,"melee only",null)then
      set MeleeOrRangedRestricted[pid]=1
      exitwhen true
    elseif CheckStacking(PlayerSkillNumber[pid*PlayerSkillOffset+xx],-1,"range only",null)then
      set MeleeOrRangedRestricted[pid]=2
      exitwhen true
    endif
    set xx=xx+1
    exitwhen xx>4+NumberOfExtraAbilities
  endloop
  call UnitRemoveAbility(SpellPickingDummy[pid],('Z004'-1)+sn)
  call UnitAddAbility(SpellPickingDummy[pid],('Z000'-1)+sn)
  if Mode_OS then
    set xx=0
    loop
      if IsSentinel(Player(pid)) then
        set pid2=GetPlayerId(Sentinels[xx])
      else
        set pid2=GetPlayerId(Scourges[xx])
      endif
      if GetUnitAbilityLevel(SpellPickingDummy[pid2],SkillID[sid])>0 then
        call UnitRemoveAbility(SpellPickingDummy[pid2],('Z010'-1)+sn)
        call UnitAddAbility(SpellPickingDummy[pid2],('Z000'-1)+sn)
      endif
      set xx=xx+1
      exitwhen xx>5
    endloop
    if IsSentinel(Player(pid)) then
      set RG8=1
    else
      set RG8=2
    endif
    if OneSkillCheckArray[RG8*OneSkillOffsetCheck+sid]==pid then
      set OneSkillCheckArray[RG8*OneSkillOffsetCheck+sid]=0
    endif
  endif
  return true
endfunction

function ResetSpellsSingle takes nothing returns nothing
  local integer PlayerId=GetPlayerId(GetTriggerPlayer())
  local integer i=S2I(SubString(GetEventPlayerChatString(),2,3))
  if i==0 then
    set i=S2I(SubString(GetEventPlayerChatString(),3,4))
  endif
  if b_isPickTime==true then
    if TimerGetElapsed(GlobalTimer)>ResetCooldown[PlayerId]+2 then
      if i<7 and i>0 then
        set ResetCooldown[PlayerId]=TimerGetElapsed(GlobalTimer)
        call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+i])
        set b_isPlayerReady[PlayerId]=false
      else
        call Error(GetTriggerPlayer(),"Wrong index, try [1-6]")
      endif
    else
      call Error(GetTriggerPlayer(),"Do not spam. Try later.")
    endif
  endif
endfunction

function ResetSpells takes nothing returns nothing
  local integer PlayerId=GetPlayerId(GetTriggerPlayer())
  if b_isPickTime==true then
    if TimerGetElapsed(GlobalTimer)>ResetCooldown[PlayerId]+2 then
      set ResetCooldown[PlayerId]=TimerGetElapsed(GlobalTimer)
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+1])
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+2])
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+3])
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+4])
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+5])
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+6])
      set b_isPlayerReady[PlayerId]=false
    else
      call Error(GetTriggerPlayer(),"Do not spam. Try later.")
    endif
  endif
endfunction

function PlayerLeave_DropSkills takes nothing returns nothing
  local integer PlayerId=GetPlayerId(GetTriggerPlayer())
  local integer xx
  if not(b_AllPlayersReady)and s_MainMode!="ar" then
    set xx=1
    loop
      call BVD(PlayerId,PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx])
      set xx=xx+1
      exitwhen xx>4+NumberOfExtraAbilities
    endloop
  endif
endfunction

function BXD takes nothing returns nothing
  local integer PlayerId=GetPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))
  local integer VR9=(SelectedSkillHeroPointValue[PlayerId]*4)-4
  local integer sn
  if GetSpellAbilityId()=='Z004' then
    set VR9=VR9+1
    set sn=1
  elseif GetSpellAbilityId()=='Z005' then
    set VR9=VR9+2
    set sn=2
  elseif GetSpellAbilityId()=='Z006' then
    set VR9=VR9+3
    set sn=3
  elseif GetSpellAbilityId()=='Z007' then
    set VR9=VR9+4
    set sn=4
  else
    return
  endif
  if BVD(PlayerId,VR9)then
    set b_isPlayerReady[PlayerId]=false
  endif
endfunction

function BYD takes nothing returns nothing
  local integer pid=GetPlayerId(GetOwningPlayer(GetSpellAbilityUnit()))
  local integer VR9=(SelectedSkillHeroPointValue[pid]*4)-4
  local integer sn
  local integer xx
  local integer PlayerId2
  if not ((GetSpellAbilityId()>='Z000' and GetSpellAbilityId()<='Z003') or (GetSpellAbilityId()>='Z010' and GetSpellAbilityId()<='Z013')) then
    return
  endif
  if GetSpellAbilityId()=='Z000' or GetSpellAbilityId()=='Z010' then
    set VR9=VR9+1
    set sn=1
  elseif GetSpellAbilityId()=='Z001' or GetSpellAbilityId()=='Z011' then
    set VR9=VR9+2
    set sn=2
  elseif GetSpellAbilityId()=='Z002' or GetSpellAbilityId()=='Z012' then
    set VR9=VR9+3
    set sn=3
  elseif GetSpellAbilityId()=='Z003' or GetSpellAbilityId()=='Z013' then
    set VR9=VR9+4
    set sn=4
  else
    return
  endif
  if not CheckAbilitiesForStacking(VR9,pid,true) then
    return
  endif
  if isPlayerPickedAbility(Player(pid),VR9)then
    call UnitRemoveAbility(SpellPickingDummy[pid],('Z000'-1)+sn)
    call UnitAddAbility(SpellPickingDummy[pid],('Z004'-1)+sn)
    if Mode_OS then
      set xx=1
      loop
        if IsSentinel(Player(pid)) then
          set PlayerId2=GetPlayerId(Sentinels[xx])
        else
          set PlayerId2=GetPlayerId(Scourges[xx])
        endif
        if GetUnitAbilityLevel(SpellPickingDummy[PlayerId2],SkillID[VR9])>0 and pid!=PlayerId2 then
          call UnitRemoveAbility(SpellPickingDummy[PlayerId2],('Z000'-1)+sn)
          call UnitAddAbility(SpellPickingDummy[PlayerId2],('Z010'-1)+sn)
        endif
        set xx=xx+1
        exitwhen xx>5
      endloop
    endif
  endif
  if b_isPlayerReady[pid]then
    call BMD()
  endif
endfunction

function BZD takes integer PlayerId,integer i returns nothing
  local integer rnd
  local integer PlayerId1=GetPlayerId(Sentinels[PlayerId])
  local integer PlayerId2=GetPlayerId(Scourges[PlayerId])
  local integer herocount=11
  local unit u
  if PlayerId==0 or PlayerId==6 or i==0 then
    return
  endif
  if IsPlayer(Player(PlayerId))==false then
    //return
  endif
  if i_BonusDraftAmount>0 then
    if i>(PlayerId*20)-20 and i<=(PlayerId*20) then
      call SetPlayerTechMaxAllowed(Player(PlayerId1),HeroID[HeroNumArrayRandomized[i]],999)
      set b_HeroAvailableForPlayer[PlayerId1*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
      call SetPlayerTechMaxAllowed(Player(PlayerId2),HeroID[HeroNumArrayRandomized[i]],999)
      set b_HeroAvailableForPlayer[PlayerId2*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
    endif
  else
    if i>(PlayerId*herocount)-herocount and i<=(PlayerId*herocount) then
      call SetPlayerTechMaxAllowed(Player(PlayerId1),HeroID[HeroNumArrayRandomized[i]],999)
      set b_HeroAvailableForPlayer[PlayerId1*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
      set SDHeroesPool[PlayerId1*100+SDHeroesPoolInc[PlayerId1]]=HeroIcon[HeroNumArrayRandomized[i]]
      set SDHeroesIDs[PlayerId1*100+SDHeroesPoolInc[PlayerId1]]=HeroID[HeroNumArrayRandomized[i]]
      set SDHeroesPoolInc[PlayerId1]=SDHeroesPoolInc[PlayerId1]+1
      //			set u=CreateUnit(Player(PlayerId1),HeroDummy[HeroNumArrayRandomized[i]],-7400 + 120*((i-1)-11*(PlayerId1-1)),7075-200*(PlayerId1-1),270)
      //			call UnitAddAbility(u,'A1HW')
      
      call SetPlayerTechMaxAllowed(Player(PlayerId2),HeroID[HeroNumArrayRandomized[i]],999)
      set b_HeroAvailableForPlayer[PlayerId2*NumberOfHeroes+HeroNumArrayRandomized[i]]=true
      set SDHeroesPool[PlayerId2*100+SDHeroesPoolInc[PlayerId2]]=HeroIcon[HeroNumArrayRandomized[i]]
      set SDHeroesIDs[PlayerId2*100+SDHeroesPoolInc[PlayerId2]]=HeroID[HeroNumArrayRandomized[i]]
      set SDHeroesPoolInc[PlayerId2]=SDHeroesPoolInc[PlayerId2]+1
      //			set u=CreateUnit(Player(PlayerId2),HeroDummy[HeroNumArrayRandomized[i]],-7400 + 120*((i-1)-11*(PlayerId1-1)),7075-200*(PlayerId1-1),270)
      //			call UnitAddAbility(u,'A1HW')
      //			call SetUnitPathing(u,false)
      //			call SetUnitPosition(u,-7400 + 120*((i-1)-11*(PlayerId1-1)),7075-200*(PlayerId1-1))
    endif
  endif
  if i_BonusHeroCounter[PlayerId]<i_BonusDraftAmount-10 then
    if i_BonusDraftAmount>0 then
      loop
        set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
        exitwhen((rnd>(PlayerId*20))or(rnd<=(PlayerId*20)-20)) and IsHeroIngame[rnd]==false
      endloop
    else
      loop
        set rnd=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
        exitwhen((rnd>(PlayerId*herocount))or(rnd<=(PlayerId*herocount)-herocount)) and IsHeroIngame[rnd]==false
      endloop
    endif
    call SetPlayerTechMaxAllowed(Player(PlayerId1),HeroID[HeroNumArrayRandomized[rnd]],999)
    set b_HeroAvailableForPlayer[PlayerId1*NumberOfHeroes+HeroNumArrayRandomized[rnd]]=true
    call SetPlayerTechMaxAllowed(Player(PlayerId2),HeroID[HeroNumArrayRandomized[rnd]],999)
    set b_HeroAvailableForPlayer[PlayerId2*NumberOfHeroes+HeroNumArrayRandomized[rnd]]=true
    set i_BonusHeroCounter[PlayerId]=i_BonusHeroCounter[PlayerId]+1
  endif
endfunction

function CleanTavernArea takes nothing returns nothing
  if IsValidTree(GetEnumDestructable())then
    call KillDestructable(GetEnumDestructable())
  endif
endfunction

function PrepareForMD takes nothing returns nothing
  local rect r=Rect(GetRectMinX(bj_mapInitialPlayableArea),GetRectMaxY(bj_mapInitialPlayableArea),GetRectMinX(bj_mapInitialPlayableArea)+2000,GetRectMaxY(bj_mapInitialPlayableArea)-2000)
  set PickHighlightExtended=CreateFogModifierRect(Sentinels[0],FOG_OF_WAR_VISIBLE,r,true,true)
  call EnumDestructablesInRect(r,Condition(function ReturnTrue),function CleanTavernArea)
  call RemoveUnit(TavernIntSent1)
  call RemoveUnit(TavernIntSent2)
  call RemoveUnit(TavernIntScourge1)
  call RemoveUnit(TavernIntScourge2)
  call RemoveUnit(TavernAgiSent1)
  call RemoveUnit(TavernAgiSent2)
  call RemoveUnit(TavernAgiScourge1)
  call RemoveUnit(TavernAgiScourge2)
  call RemoveUnit(TavernStrSent1)
  call RemoveUnit(TavernStrSent2)
  call RemoveUnit(TavernStrScourge1)
  call RemoveUnit(TavernStrScourge2)
  call FogModifierStart(PickHighlightExtended)
  
  //call FogModifierStop(f)
  //call DestroyFogModifier(f)
endfunction

function BAD takes nothing returns nothing
  local integer PlayerId=0
  local integer i
  local integer j
  local integer n
  local integer f
  set i=0
  set i=0
  loop
    set HeroNumArrayRandomized[i]=AdjustHeroNumber(i)
    set i=i+1
    exitwhen(i>NumberOfHeroes)
  endloop
  set i=0
  loop
    set j=(GetRandomInt(1,NumberOfHeroes))
    set n=(GetRandomInt(1,NumberOfHeroes))
    set f=HeroNumArrayRandomized[j]
    set HeroNumArrayRandomized[j]=HeroNumArrayRandomized[n]
    set HeroNumArrayRandomized[n]=f
    set i=i+1
    exitwhen(i>NumberOfHeroes*4)
  endloop
  set PlayerId=0
  loop
    set i=0
    loop
      call SetPlayerTechMaxAllowed(Player(PlayerId),HeroID[HeroNumArrayRandomized[i]],0)
      set b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+i]=false
      set i=i+1
      exitwhen(i>NumberOfHeroes)
    endloop
    set PlayerId=PlayerId+1
    exitwhen(PlayerId>12)
  endloop
  set PlayerId=0
  call CleanTaverns()
  //call ExeFunc("RollSpellsForInvokerSD")
  if i_BonusDraftAmount==0 then
    //call PrepareForMD()
  endif
  loop
    set i=0
    loop
      call BZD(PlayerId,i)
      set i=i+1
      exitwhen(i>NumberOfHeroes)
    endloop
    set PlayerId=PlayerId+1
    exitwhen(PlayerId>5)
  endloop
  call VS9()
  call PanCameraToTimed(-7008.,6816.,.0)
endfunction

function SunStrikeUniqueness takes integer id, integer id1, integer id2, integer id3, integer id4 returns nothing
  if Mode_RC==false and Mode_BO==false then
    if id1=='Z601' then
      call ST(id*4+1,"r23")
    elseif id2=='Z601' then
      call ST(id*4+2,"r23")
    elseif id3=='Z601' then
      call ST(id*4+3,"r23")
    elseif id4=='Z601' then
      call ST(id*4+4,"r23")
    endif
  endif
endfunction

function RollSpellsForInvokerSD takes nothing returns nothing
  local integer i=1
  local integer k=0
  local integer j=1
  local integer array s
  local string array imgs
  local string array orders
  local string array hotkeys
  local integer array ids
  local integer array upg
  local integer tmp
  local integer rndIndex
  set s[1]=1
  set s[2]=2
  set s[3]=3
  set s[4]=4
  set s[5]=5
  set s[6]=6
  set s[7]=7
  set s[8]=8
  set s[9]=9
  set s[10]=10
  set hotkeys[1]="t"
  set hotkeys[2]="d"
  set hotkeys[3]="f"
  set hotkeys[4]="y"
  set hotkeys[5]="v"
  set hotkeys[6]="g"
  set hotkeys[7]="z"
  set hotkeys[8]="x"
  set hotkeys[9]="c"
  set hotkeys[10]="b"
  loop
    exitwhen( i == 10 )
    set k = GetRandomInt(1,10)
    set tmp = s[i]
    set s[i] = s[k]
    set s[k] = tmp
    set i = i + 1
  endloop
  set imgs[1]="ReplaceableTextures\\CommandButtons\\BTNSunstrike.blp"
  set imgs[2]="ReplaceableTextures\\CommandButtons\\BTNFireRocks.blp"
  set imgs[3]="ReplaceableTextures\\CommandButtons\\BTNLavaSpawn.blp"
  set imgs[4]="ReplaceableTextures\\CommandButtons\\BTNLament.blp"
  set imgs[5]="ReplaceableTextures\\CommandButtons\\BTNManaShield.blp"
  set imgs[6]="ReplaceableTextures\\CommandButtons\\BTNFreezingBreath.blp"
  set imgs[7]="ReplaceableTextures\\CommandButtons\\BTNAnimalWarTraining.blp"
  set imgs[8]="ReplaceableTextures\\CommandButtons\\BTNInvokeTornado.blp"
  set imgs[9]="ReplaceableTextures\\CommandButtons\\BTNEMP.blp"
  set imgs[10]="ReplaceableTextures\\CommandButtons\\BTNScatterRockets.blp"
  
  set orders[1]="request_hero"
  set orders[2]="mechanicalcritter"
  set orders[3]="militia"
  set orders[4]="militiaconvert"
  set orders[5]="windwalk"
  set orders[6]="militiaoff"
  set orders[7]="militiaunconvert"
  set orders[8]="mindrot"
  set orders[9]="monsoon"
  set orders[10]="mount"
  set i=1
  loop
    set ids[i]='Z600'+i
    set upg[i]='Y600'+i
    set i=i+1
    exitwhen i>9
  endloop
  set ids[10]='Z610'
  set upg[10]='Y610'
  
  set i=indexid_Sieger-1
  call CSD(i*4+1,imgs[s[1]],ST(i*4+1,orders[s[1]]),ids[s[1]],0,upg[s[1]],null,null,false,hotkeys[s[1]])
  call CSD(i*4+2,imgs[s[2]],ST(i*4+2,orders[s[2]]),ids[s[2]],0,upg[s[2]],null,null,false,hotkeys[s[2]])
  call CSD(i*4+3,imgs[s[3]],ST(i*4+3,orders[s[3]]),ids[s[3]],0,upg[s[3]],null,null,false,hotkeys[s[3]])
  call CSD(i*4+4,null,null,0,0,0,null,null,false,"_")
  set IsAbilityDoesNotWork[i*4+4]=true
  call SunStrikeUniqueness(i,ids[s[1]],ids[s[2]],ids[s[3]],0)
  set i=indexid_Sorcesser-1
  call CSD(i*4+1,imgs[s[4]],ST(i*4+1,orders[s[4]]),ids[s[4]],0,upg[s[4]],null,null,false,hotkeys[s[4]])
  call CSD(i*4+2,imgs[s[5]],ST(i*4+2,orders[s[5]]),ids[s[5]],0,upg[s[5]],null,null,false,hotkeys[s[5]])
  call CSD(i*4+3,imgs[s[6]],ST(i*4+3,orders[s[6]]),ids[s[6]],0,upg[s[6]],null,null,false,hotkeys[s[6]])
  call CSD(i*4+4,null,null,0,0,0,null,null,false,"_")
  set IsAbilityDoesNotWork[i*4+4]=true
  call SunStrikeUniqueness(i,ids[s[4]],ids[s[5]],ids[s[6]],0)
  set i=indexid_Invoker-1
  call CSD(i*4+1,imgs[s[7]],ST(i*4+1,orders[s[7]]),ids[s[7]],0,upg[s[7]],null,null,false,hotkeys[s[7]])
  call CSD(i*4+2,imgs[s[8]],ST(i*4+2,orders[s[8]]),ids[s[8]],0,upg[s[8]],null,null,false,hotkeys[s[8]])
  call CSD(i*4+3,imgs[s[9]],ST(i*4+3,orders[s[9]]),ids[s[9]],0,upg[s[9]],null,null,false,hotkeys[s[9]])
  call CSD(i*4+4,imgs[s[10]],ST(i*4+4,orders[s[10]]),ids[s[10]],0,upg[s[10]],null,null,false,hotkeys[s[10]])
  call SunStrikeUniqueness(i,ids[s[7]],ids[s[8]],ids[s[9]],ids[s[10]])
  
endfunction

function BBD takes integer pid,integer i returns nothing//SD mode
  local integer num
  local integer AdjID=pid
  local integer herocount=11
  
  if pid==0 or pid==6 or i==0 then
    return
  endif
  if pid>6 then
    set AdjID=AdjID-1
  endif
  
  if i>(AdjID*herocount)-herocount and i<=(AdjID*herocount) then
    call SetPlayerTechMaxAllowed(Player(pid),HeroID[(HeroNumArrayRandomized[i])],999)
    set b_HeroAvailableForPlayer[pid*NumberOfHeroes+(HeroNumArrayRandomized[i])]=true
    set SDHeroesPool[pid*100+SDHeroesPoolInc[pid]]=HeroIcon[HeroNumArrayRandomized[i]]
    set SDHeroesIDs[pid*100+SDHeroesPoolInc[pid]]=HeroID[HeroNumArrayRandomized[i]]
    set SDHeroesPoolInc[pid]=SDHeroesPoolInc[pid]+1
    //call AddUnitToStock(TavernStrSent1,HeroID[(HeroNumArrayRandomized[i])],1,1)
  endif
  if i_BonusHeroCounter[pid]<i_BonusDraftAmount then
    loop
      set num=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
      exitwhen((num>(AdjID*herocount))or(num<=(AdjID*herocount)-herocount))
    endloop
    call SetPlayerTechMaxAllowed(Player(pid),HeroID[HeroNumArrayRandomized[num]],999)
    set b_HeroAvailableForPlayer[pid*NumberOfHeroes+HeroNumArrayRandomized[num]]=true
    set i_BonusHeroCounter[pid]=i_BonusHeroCounter[pid]+1
  endif
endfunction

function BCD takes nothing returns nothing
  local integer PlayerId=0
  local integer i
  local integer j
  local integer n
  local integer f
  set i=1
  loop
    set HeroNumArrayRandomized[i]=AdjustHeroNumber(i)
    set i=i+1
    exitwhen(i>NumberOfHeroes)
  endloop
  set i=1
  loop
    set j=(GetRandomInt(1,NumberOfHeroes))
    set n=(GetRandomInt(1,NumberOfHeroes))
    set f=HeroNumArrayRandomized[j]
    set HeroNumArrayRandomized[j]=HeroNumArrayRandomized[n]
    set HeroNumArrayRandomized[n]=f
    set i=i+1
    exitwhen(i>NumberOfHeroes*4) 
  endloop
  set PlayerId=0
  loop
    set i=1
    loop
      call SetPlayerTechMaxAllowed(Player(PlayerId),HeroID[HeroNumArrayRandomized[i]],0)
      set b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+i]=false
      set i=i+1
      exitwhen(i>NumberOfHeroes)
    endloop
    set PlayerId=PlayerId+1
    exitwhen(PlayerId>12)
  endloop
  set PlayerId=0
  call CleanTaverns()
  //call RollSpellsForInvokerSD()
  loop
    set i=1
    loop
      call BBD(PlayerId,i)
      set i=i+1
      exitwhen(i>NumberOfHeroes)
    endloop
    set PlayerId=PlayerId+1
    if PlayerId==6 then
      set PlayerId=7
    endif
    exitwhen(PlayerId>12)
  endloop
  call VS9()
  call PanCameraToTimed(-7008.,6816.,.0)
endfunction

function BUD takes nothing returns nothing
  local integer PlayerId=LoadInteger(HY,'0REA','0PID')
  local integer SJ8=LoadInteger(HY,'0REA','0SID')
  local boolean QY8=LoadBoolean(HY,'0REA','000B')
  call CheckAbilitiesForStacking(SJ8,PlayerId,QY8)
endfunction

function B3D takes nothing returns nothing
  local integer PlayerId=0
  local integer SJ8=0
  local integer BJD=0
  set PlayerId=0
  loop
    if QV8(PlayerId)then
      if NumberOfExtraAbilities>=1 then
        loop
          if s_MainMode=="sd" or s_MainMode=="md" then
            loop
              set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
              exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false
            endloop
            set BJD=HeroNumArrayRandomized[BJD]
          else
            loop
              set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
              exitwhen(IsHeroIngame[BJD]==false and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[BJD-1])>0)
            endloop
          endif
          set SJ8=(BJD-1)*4
          set SJ8=SJ8+GetRandomInt(1,3)
          call SaveInteger(HY,'0REA','0PID',PlayerId)
          call SaveInteger(HY,'0REA','0SID',SJ8)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
          exitwhen PlayerSkillNumber[PlayerId*PlayerSkillOffset+5]!=0
        endloop
      endif
      if NumberOfExtraAbilities>=2 then
        loop
          if s_MainMode=="sd" or s_MainMode=="md" then
            loop
              set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
              exitwhen b_HeroAvailableForPlayer[PlayerId*NumberOfHeroes+BJD] and IsHeroIngame[BJD]==false
            endloop
            set BJD=HeroNumArrayRandomized[BJD]
          else
            loop
              set BJD=AdjustHeroNumber(GetRandomInt(1,NumberOfHeroes))
              exitwhen(IsHeroIngame[BJD]==false and GetPlayerTechMaxAllowed(GetTriggerPlayer(),HeroID[BJD])>0)
            endloop
          endif
          set SJ8=(BJD-1)*4+4
          call SaveInteger(HY,'0REA','0PID',PlayerId)
          call SaveInteger(HY,'0REA','0SID',SJ8)
          call SaveBoolean(HY,'0REA','000B',false)
          call ExeFunc("BUD")
          exitwhen PlayerSkillNumber[PlayerId*PlayerSkillOffset+6]!=0
        endloop
      endif
    endif
    set PlayerId=PlayerId+1
    exitwhen(PlayerId>12)
  endloop
endfunction

function RDDisplayTimers takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local image im
  local integer delay=LoadInteger(HY,h,0)-1
  local real x=LoadReal(HY,h,10)
  local real y=LoadReal(HY,h,11)
  local string s
  set im=LoadImageHandle(HY,h,1)
  call DestroyImage(im)
  set im=LoadImageHandle(HY,h,2)
  call DestroyImage(im)
  if delay<0 then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
    set t=null
    return
  endif
  set s=I2S(delay)
  
  if delay<10 then
    set s="0"+s
  endif
  call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",60,60,x,y,0,true)
  call SaveImageHandle(HY,h,1,tt_image1)
  call SetImageColor(tt_image1,255,255,255,255)
  call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",60,60,x+40,y,0,true)
  call SaveImageHandle(HY,h,2,tt_image1)
  call SetImageColor(tt_image1,255,255,255,255)
  
  call SaveInteger(HY,h,0,delay)
  
  set t=null
endfunction

function RDDisplayTimersInit takes real delay returns nothing
  local integer ht=GetHandleId(GetTriggeringTrigger())
  local timer oldtimer=LoadTimerHandle(HY,ht,5)
  local integer oh=GetHandleId(oldtimer)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local image im1
  local image im2
  local string s=I2S(R2I(delay))
  local real x=-7030
  local real y=6766
  if oh>1 then
    set im1=LoadImageHandle(HY,oh,1)
    set im2=LoadImageHandle(HY,oh,2)
    call DestroyImage(im1)
    call DestroyImage(im2)
    call PauseTimer(oldtimer)
    call DestroyTimer(oldtimer)
    call FlushChildHashtable(HY,oh)
  endif
  call SaveTimerHandle(HY,ht,5,t)
  call SaveReal(HY,h,10,x)
  call SaveReal(HY,h,11,y)
  call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",60,60,x,y,0,true)
  call SaveImageHandle(HY,h,1,tt_image1)
  call SetImageColor(tt_image1,255,255,255,255)
  call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",60,60,x+40,y,0,true)
  call SaveImageHandle(HY,h,2,tt_image1)
  call SetImageColor(tt_image1,255,255,255,255)
  call TimerStart(t,1,true,function RDDisplayTimers)
  call SaveInteger(HY,h,0,R2I(delay))
  set oldtimer=null
  set t=null
endfunction

function RDShowNoteYourPick takes integer h, real x, real y returns nothing
  local integer i=0
  local string s="YOUR PICK"
  local integer k=0
  call WriteImageOnGround("Fonts\\Y.blp",60,60,x-40*4,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+0,tt_image1)
  call WriteImageOnGround("Fonts\\O.blp",60,60,x-40*3,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+1,tt_image1)
  call WriteImageOnGround("Fonts\\U.blp",60,60,x-40*2,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+2,tt_image1)
  call WriteImageOnGround("Fonts\\R.blp",60,60,x-40*1,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+3,tt_image1)
  call WriteImageOnGround("Fonts\\P.blp",60,60,x+40*1,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+4,tt_image1)
  call WriteImageOnGround("Fonts\\I.blp",60,60,x+40*2,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+5,tt_image1)
  call WriteImageOnGround("Fonts\\C.blp",60,60,x+40*2.5,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+6,tt_image1)
  call WriteImageOnGround("Fonts\\K.blp",60,60,x+40*3.5,y,0,true)
  call SetImageColor(tt_image1,255,0,0,k)
  call SaveImageHandle(HY,h,200+7,tt_image1)
endfunction

function RDSpawnHero takes player p, unit seller returns nothing
  local integer pid=GetPlayerId(p)
  local unit u
  local integer hu=GetHandleId(seller)
  local integer h=GetHandleId(GetTriggeringTrigger())
  local integer i=LoadInteger(HY,hu,0)
  set b_isPlayerReady[pid]=true
  set PlayerSkillNumber[pid*PlayerSkillOffset+1]=LoadInteger(HY,h,100*i+1)
  set PlayerSkillNumber[pid*PlayerSkillOffset+2]=LoadInteger(HY,h,100*i+2)
  set PlayerSkillNumber[pid*PlayerSkillOffset+3]=LoadInteger(HY,h,100*i+3)
  set PlayerSkillNumber[pid*PlayerSkillOffset+4]=LoadInteger(HY,h,100*i+4)
  set PlayerSkillNumber[pid*PlayerSkillOffset+5]=LoadInteger(HY,h,100*i+5)
  set PlayerSkillNumber[pid*PlayerSkillOffset+6]=LoadInteger(HY,h,100*i+6)
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+1])
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+2])
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+3])
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+4])
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+5])
  call BID(PlayerSkillNumber[pid*PlayerSkillOffset+6])
  call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)-250)
  if IsSentinel(p)then
    set udg_Hero[pid]=CreateUnit(p,HeroID[GetUnitUserData(seller)],GetRectCenterX(gg_rct_Hero_Creation_NE),GetRectCenterY(gg_rct_Hero_Creation_NE),0)
    call ShowUnit(seller,false)
    call UnitApplyTimedLife(seller,'BTLF',120)
    set u=CreateUnit(p,HeroDummy[GetUnitUserData(seller)],-7250+(GetPlayerId(p)-1)*110,6900,270)
  else
    set udg_Hero[pid]=CreateUnit(p,HeroID[GetUnitUserData(seller)],GetRectCenterX(gg_rct_Hero_Creation_UD),GetRectCenterY(gg_rct_Hero_Creation_UD),0)
    call ShowUnit(seller,false)
    call UnitApplyTimedLife(seller,'BTLF',120)
    set u=CreateUnit(p,HeroDummy[GetUnitUserData(seller)],-7250+(GetPlayerId(p)-7)*110,6590,90)
  endif
  call PauseUnit(u,true)
  call SaveUnitHandle(HY,h,100+i,u)
  call SetUnitUserData(seller,0)
  set u=null
endfunction

function RDGetRandomHero takes integer pid returns nothing
  local player p=Player(pid)
  local integer i=0
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit u
  loop
    set i=GetRandomInt(1,Mode_RD_Count)
    set u=LoadUnitHandle(HY,h,50+i)
    exitwhen GetUnitUserData(u)!=0
  endloop
  call RDSpawnHero(p,u)
  set u=null
endfunction

function RDUnitSold takes nothing returns nothing
  local unit u=GetSoldUnit()
  local player p=GetOwningPlayer(u)
  local integer pid=GetPlayerId(p)
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit seller
  if GetUnitTypeId(u)=='h06N'then
    call RemoveUnit(u)
    set u=null
    if pid!=LoadInteger(HY,h,10) and pid!=LoadInteger(HY,h,11) then
      call Error(p,"It's not your turn.")
    else
      set seller=GetSellingUnit()
      call RDSpawnHero(p,seller)
      if pid==LoadInteger(HY,h,10) then
        call RemoveSavedInteger(HY,h,10)
      else
        call RemoveSavedInteger(HY,h,11)
      endif
      
    endif
  endif
endfunction

function RDDestroyYourPickLabel takes integer h returns nothing
  call DestroyImage(LoadImageHandle(HY,h,200+0))
  call DestroyImage(LoadImageHandle(HY,h,200+1))
  call DestroyImage(LoadImageHandle(HY,h,200+2))
  call DestroyImage(LoadImageHandle(HY,h,200+3))
  call DestroyImage(LoadImageHandle(HY,h,200+4))
  call DestroyImage(LoadImageHandle(HY,h,200+5))
  call DestroyImage(LoadImageHandle(HY,h,200+6))
  call DestroyImage(LoadImageHandle(HY,h,200+7))
endfunction

function RDHideYourPickLabel takes integer h returns nothing
  call SetImageColor(LoadImageHandle(HY,h,200+0),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+1),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+2),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+3),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+4),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+5),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+6),255,0,0,0)
  call SetImageColor(LoadImageHandle(HY,h,200+7),255,0,0,0)
endfunction

function RDShowYourPickLabel takes integer h returns nothing
  call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10,GetObjectName('n068'))
  call SetImageColor(LoadImageHandle(HY,h,200+0),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+1),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+2),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+3),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+4),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+5),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+6),255,0,0,255)
  call SetImageColor(LoadImageHandle(HY,h,200+7),255,0,0,255)
endfunction

function RDPickingGoGo takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local integer c=LoadInteger(HY,h,0)
  local integer i
  local string s
  local string s1
  local string s2
  local integer pid1
  local integer pid2
  local integer UDc
  local integer NEc
  if GetTriggerEventId()==EVENT_UNIT_SELL then
    call RDUnitSold()
    set t=null
    return false
  endif
  if LoadBoolean(HY,h,0) then//self destruct
    set i=1
    call DestroyMultiboard(AbilityDraftMultiboard)
    call MultiboardDisplay(MainMB,true)
    call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',1,2)
    call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',1,2)
    loop
      set u=LoadUnitHandle(HY,h,50+i)
      call FlushChildHashtable(HY,GetHandleId(u))
      call RemoveUnit(u)
      if HaveSavedHandle(HY,h,100+i)then
        set u=LoadUnitHandle(HY,h,100+i)
        call FlushChildHashtable(HY,GetHandleId(u))
        call RemoveUnit(u)
      endif
      set i=i+1
      exitwhen i>Mode_RD_Count
    endloop
    call RDDestroyYourPickLabel(h)
    call FogModifierStop(LoadFogModifierHandle(HY,h,220))
    call DestroyFogModifier(LoadFogModifierHandle(HY,h,220))
    call FogModifierStop(LoadFogModifierHandle(HY,h,221))
    call DestroyFogModifier(LoadFogModifierHandle(HY,h,221))
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
    set t=null
    return false
  endif
  if c==0 then
    set i=GetRandomInt(1,2)
    if i==1 then
      set s="1221122112"
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[0])]+GetObjectName('n065')+"|r will now begin the 1-2-2-2-2-1 draft")
    else
      set s="2112211221"
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[0])]+GetObjectName('n06C')+"|r will now begin the 1-2-2-2-2-1 draft")
    endif
    call SaveStr(HY,h,0,s)
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15.00," ")
    
  endif
  set s=LoadStr(HY,h,0)
  if LoadInteger(HY,h,10)>0 and udg_Hero[LoadInteger(HY,h,10)]==null then
    call RDGetRandomHero(LoadInteger(HY,h,10))
  endif
  if LoadInteger(HY,h,11)>0 and udg_Hero[LoadInteger(HY,h,11)]==null then
    call RDGetRandomHero(LoadInteger(HY,h,11))
  endif
  
  if StringLength(s)>=c+1 then
    call RDHideYourPickLabel(h)
    set s1=SubString(s,c,c+1)
    set s2=SubString(s,c+1,c+2)
    set NEc=LoadInteger(HY,h,5)+1
    set UDc=LoadInteger(HY,h,6)+1
    set pid1=S2I(s1)
    set pid2=S2I(s2)
    if pid1!=pid2 then
      if pid1==1 then
        call SaveInteger(HY,h,10,GetPlayerId(Sentinels[NEc]))
        call SaveInteger(HY,h,5,NEc)
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc])]+PlayerNames[GetPlayerId(Sentinels[NEc])]+"|r "+GetObjectName('n064'))
        if GetLocalPlayer()==Sentinels[NEc] then
          call RDShowYourPickLabel(h)
        endif
      else
        call SaveInteger(HY,h,10,GetPlayerId(Scourges[UDc]))
        call SaveInteger(HY,h,6,UDc)
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc])]+PlayerNames[GetPlayerId(Scourges[UDc])]+"|r "+GetObjectName('n064'))
        if GetLocalPlayer()==Scourges[UDc] then
          call RDShowYourPickLabel(h)
        endif
      endif
      call SaveInteger(HY,h,0,c+1)
    else
      if pid1==1 then
        call SaveInteger(HY,h,10,GetPlayerId(Sentinels[NEc]))
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc])]+PlayerNames[GetPlayerId(Sentinels[NEc])]+"|r "+GetObjectName('n064'))
        if GetLocalPlayer()==Sentinels[NEc] then
          call RDShowYourPickLabel(h)
        endif
        if NEc+1<6 then
          call SaveInteger(HY,h,11,GetPlayerId(Sentinels[NEc+1]))
          call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Sentinels[NEc+1])]+PlayerNames[GetPlayerId(Sentinels[NEc+1])]+"|r "+GetObjectName('n064'))
          if GetLocalPlayer()==Sentinels[NEc+1] then
            call RDShowYourPickLabel(h)
          endif
        endif
        call SaveInteger(HY,h,5,NEc+1)
      else
        call SaveInteger(HY,h,10,GetPlayerId(Scourges[UDc]))
        call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc])]+PlayerNames[GetPlayerId(Scourges[UDc])]+"|r "+GetObjectName('n064'))
        if GetLocalPlayer()==Scourges[UDc] then
          call RDShowYourPickLabel(h)
        endif
        if UDc+1<6 then
          call SaveInteger(HY,h,11,GetPlayerId(Scourges[UDc+1]))
          call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,15,udg_Colors[GetPlayerId(Scourges[UDc+1])]+PlayerNames[GetPlayerId(Scourges[UDc+1])]+"|r "+GetObjectName('n064'))
          if GetLocalPlayer()==Scourges[UDc+1] then
            call RDShowYourPickLabel(h)
          endif
        endif
        call SaveInteger(HY,h,6,UDc+1)
      endif
      call SaveInteger(HY,h,0,c+2)
    endif
    call TriggerRegisterTimerEvent(t,20,false)
    call RDDisplayTimersInit(20)
  else
    call SaveBoolean(HY,h,0,true)//self-destroy
    call TriggerRegisterTimerEvent(t,20,false)
  endif
  set t=null
  return false
endfunction

function PrepareSkillsRD takes integer c, unit u, integer h returns nothing
  local integer i=0
  local integer SJ8
  local integer te
  set b_isPlayerReady[i]=false
  set PlayerSkillNumber[1]=0
  set PlayerSkillNumber[2]=0
  set PlayerSkillNumber[3]=0
  set PlayerSkillNumber[4]=0
  set PlayerSkillNumber[5]=0
  set PlayerSkillNumber[6]=0
  loop
    exitwhen b_isPlayerReady[i]
    set SJ8=(GetRandomInt(1,NumberOfHeroes*4))
    set te=((SJ8+3)/4)
    call SaveInteger(HY,'0REA','0PID',i)
    call SaveInteger(HY,'0REA','0SID',SJ8)
    call SaveBoolean(HY,'0REA','000B',false)
    call SaveUnitHandle(HY,'0REA','000U',u)
    call ExeFunc("BUD")
  endloop
  call SaveInteger(HY,h,100*c+1,PlayerSkillNumber[1])
  call SaveInteger(HY,h,100*c+2,PlayerSkillNumber[2])
  call SaveInteger(HY,h,100*c+3,PlayerSkillNumber[3])
  call SaveInteger(HY,h,100*c+4,PlayerSkillNumber[4])
  call SaveInteger(HY,h,100*c+5,PlayerSkillNumber[5])
  call SaveInteger(HY,h,100*c+6,PlayerSkillNumber[6])
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[1]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[1]]),4)
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[2]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[2]]),4)
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[3]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[3]]),4)
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[4]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[4]]),4)
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[5]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[5]]),4)
  call UnitAddAbility(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[6]]))
  call SetUnitAbilityLevel(u,GetCorrectIdForVisSkill(SkillID[PlayerSkillNumber[6]]),4)
  call SaveInteger(HY,GetHandleId(u),'RDIN'+1,PlayerSkillNumber[1])
  call SaveInteger(HY,GetHandleId(u),'RDIN'+2,PlayerSkillNumber[2])
  call SaveInteger(HY,GetHandleId(u),'RDIN'+3,PlayerSkillNumber[3])
  call SaveInteger(HY,GetHandleId(u),'RDIN'+4,PlayerSkillNumber[4])
  call SaveInteger(HY,GetHandleId(u),'RDIN'+5,PlayerSkillNumber[5])
  call SaveInteger(HY,GetHandleId(u),'RDIN'+6,PlayerSkillNumber[6])
endfunction

function ModeRDInit takes nothing returns nothing
  local integer array ids
  local integer i=1
  local integer rnd=0
  local unit u
  local real x
  local real y
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local fogmodifier fm
  local timer credits=CreateTimer()
  call TimerStart(credits,180,false,function ShowCredits)
  set credits=null
  call RDShowNoteYourPick(h,-7000,7080)
  set b_isPickTime=false
  set RepickAllowed=false
  set RandomAllowed=false
  call ShowUnit(TavernIntSent1,false)
  call ShowUnit(TavernIntSent2,false)
  call ShowUnit(TavernIntScourge1,false)
  call ShowUnit(TavernIntScourge2,false)
  call ShowUnit(TavernAgiSent1,false)
  call ShowUnit(TavernAgiSent2,false)
  call ShowUnit(TavernAgiScourge1,false)
  call ShowUnit(TavernAgiScourge2,false)
  call ShowUnit(TavernStrSent1,false)
  call ShowUnit(TavernStrSent2,false)
  call ShowUnit(TavernStrScourge1,false)
  call ShowUnit(TavernStrScourge2,false)
  loop
    loop
      set rnd=GetRandomInt(1,NumberOfHeroes)
      exitwhen HaveSavedBoolean(HY,'00RD',rnd)==false
    endloop
    call SaveBoolean(HY,'00RD',rnd,true)
    set x=-7030+450*Cos(i*(360. / Mode_RD_Count * 1.)*bj_DEGTORAD)
    set y=6766+450*Sin(i*(360. / Mode_RD_Count * 1.)*bj_DEGTORAD)
    set u=CreateUnit(Player(15),HeroDummy[rnd],x,y,AngleBetweenXY(x,y,-7030,6766))
    call SetUnitPathing(u,false)
    call SetUnitPosition(u,x,y)
    call SetUnitUserData(u,rnd)
    call SaveUnitHandle(HY,h,50+i,u)
    set ids[i]=rnd
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SELL)
    call PrepareSkillsRD(i,u,h)
    call SaveInteger(HY,GetHandleId(u),0,i)
    set i=i+1
    exitwhen i>Mode_RD_Count
  endloop
  set fm=CreateFogModifierRadius(Sentinels[1],FOG_OF_WAR_VISIBLE,-7030,6766,900,true,true)
  call SaveFogModifierHandle(HY,h,220,fm)
  call FogModifierStart(fm)
  set fm=CreateFogModifierRadius(Scourges[1],FOG_OF_WAR_VISIBLE,-7030,6766,900,true,true)
  call SaveFogModifierHandle(HY,h,221,fm)
  call FogModifierStart(fm)
  set fm=null
  set u=CreateUnit(Scourges[0],'e00E',-7030,6766,0)
  call UnitAddAbility(u,'A457')
  call IssuePointOrder(u,"silence",-7030,6766)
  call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,20,"All players have 60 seconds to prepare before pick starts")
  call TriggerRegisterTimerEvent(t,60,false)
  call TriggerAddCondition(t,Condition(function RDPickingGoGo))
  if Mode_FN then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,210,false)
    call TriggerAddCondition(t,Condition(function NeutralsRespawn))
    set t=null
  endif
  set t=null
  set u=null
endfunction

function B6D takes nothing returns nothing
  local string mn=MainModeInTxt
  local trigger t
  local timer credits
  if mn=="Allrandom" or mn=="Deathmatch" then
    set s_MainMode="ar"
    set b_isPickTime=false
    call AddUnitToStock(ScourgeBuilding_ShopGraveyard,'h02C',1,2)
    call AddUnitToStock(SentinelBuilding_ShopChimaera,'h02C',1,2)
    call CleanTaverns()
    set credits=CreateTimer()
    call TimerStart(credits,70,false,function ShowCredits)
    set credits=null
    if Mode_FN then
      call NeutralsRespawn()
      set t=CreateTrigger()
      call TriggerRegisterTimerEvent(t,30,false)
      call TriggerRegisterTimerEvent(t,90,false)
      call TriggerAddCondition(t,Condition(function NeutralsRespawn))
      set t=null
    endif
  elseif mn=="Allpick" then
    set s_MainMode="ap"
    call VS9()
    if Mode_RA then
      call B3D()
    endif
  elseif mn=="Randomdraft" then
    set s_MainMode="rd"
    call ModeRDInit()
  elseif mn=="Singledraft" then
    set s_MainMode="sd"
    call BCD()
    if Mode_RA then
      call B3D()
    endif
  elseif mn=="Mirrordraft" then
    set s_MainMode="md"
    call BAD()
    if Mode_RA then
      call B3D()
    endif
  endif
endfunction

function Abaddon_Frostmourne_Tick takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u
  if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) or GetUnitAbilityLevel(LoadUnitHandle(HY,h,0),'QH00')==0 then
    set u=LoadUnitHandle(HY,h,0)
    call UnitRemoveAbility(u,'C104')
    call UnitRemoveAbility(u,'C105')
    call UnitRemoveAbility(u,'C106')
    call UnitRemoveAbility(u,'C107')
    call UnitRemoveAbility(u,'QH00')
    call UnitRemoveAbility(u,'D107')
    call RemoveSavedHandle(HY,GetHandleId(u),'A0MG')
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
    set u=null
  endif
  set t=null
endfunction

function Abaddon_Frostmourne_Apply takes unit attacker, unit target returns nothing
  local timer t=LoadTimerHandle(HY,GetHandleId(target),'A0MG')
  local integer h
  if t!=null then
    set h=GetHandleId(t)
  else
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,0.1,true,function Abaddon_Frostmourne_Tick)
    call UnitAddAbility2(target,'C103'+GetUnitAbilityLevel(attacker,'A0MG')+GetUnitAbilityLevel(attacker,'QP18'))
    call UnitAddAbility2(target,'QH00')
    call SaveUnitHandle(HY,h,0,target)
    call SaveTimerHandle(HY,GetHandleId(target),'A0MG',t)
  endif
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2.5)
  set t=null
endfunction

function Abbadon_Frostmourne_Attack takes unit u, unit t returns nothing
  local integer level=GetUnitAbilityLevel(u,'A0MG')+GetUnitAbilityLevel(u,'QP18')
  if IsUnitType(u,UNIT_TYPE_STRUCTURE)==true or IsUnitType(t,UNIT_TYPE_STRUCTURE)==true or IsUnitAlly(u,GetOwningPlayer(t)) then
    return
  endif
  if level>0 then
    call Buff_Add(u,'C107' + level,'D105',4.5)
    set level = GetHandleId(t)
    if LoadBoolean(MHT,level,1)==false then
      call SaveBoolean(MHT,level,1,true)
      call TriggerRegisterUnitEvent(GAME_TRIGGER,t,EVENT_UNIT_DAMAGED)
    endif
    return
  endif
  if GetUnitAbilityLevel(t,'D107')==1 then
    set level=GetUnitAbilityLevel(t,'C104') + 2*GetUnitAbilityLevel(t,'C105') + 3*GetUnitAbilityLevel(t,'C106') +  4*GetUnitAbilityLevel(t,'C107')
    if level > 4 then
      set level = 4
    endif
    if level>0 then
      call Buff_Add(u,'C107' + level,'D105',4.5)
    endif
  endif
endfunction

function StoreAllUnitsSightRange takes nothing returns nothing
  
  call SaveInteger(UnitStats,'ugho',SIGHT,850)
  call SaveInteger(UnitStats,'u001',SIGHT,850)
  call SaveInteger(UnitStats,'unec',SIGHT,850)
  call SaveInteger(UnitStats,'u002',SIGHT,850)
  
  call SaveInteger(UnitStats,'esen',SIGHT,850)
  call SaveInteger(UnitStats,'e00V',SIGHT,850)
  call SaveInteger(UnitStats,'edry',SIGHT,850)
  call SaveInteger(UnitStats,'e00W',SIGHT,850)
  
  call SaveInteger(UnitStats,'ebal',SIGHT,850)
  call SaveInteger(UnitStats,'ebal',NSIGHT,850)
  call SaveInteger(UnitStats,'e026',SIGHT,850)
  call SaveInteger(UnitStats,'e026',NSIGHT,850)
  call SaveInteger(UnitStats,'umtw',SIGHT,850)
  call SaveInteger(UnitStats,'umtw',NSIGHT,850)
  call SaveInteger(UnitStats,'u00R',SIGHT,850)
  call SaveInteger(UnitStats,'u00R',NSIGHT,850)
  
  call SaveInteger(UnitStats,'u00T',SIGHT,1900)
  call SaveInteger(UnitStats,'u00N',SIGHT,1900)
  call SaveInteger(UnitStats,'u00D',SIGHT,1900)
  call SaveInteger(UnitStats,'u00M',SIGHT,1900)
  
  call SaveInteger(UnitStats,'e00R',SIGHT,1900)
  call SaveInteger(UnitStats,'e011',SIGHT,1900)
  call SaveInteger(UnitStats,'e00S',SIGHT,1900)
  call SaveInteger(UnitStats,'e019',SIGHT,1900)
  
  call SaveInteger(UnitStats,'h308',SIGHT,700)
  call SaveInteger(UnitStats,'h308',NSIGHT,700)
  
  call SaveInteger(UnitStats,'n01Q',SIGHT,1000)
  
  call SaveInteger(UnitStats,'n01R',SIGHT,1300)
  call SaveInteger(UnitStats,'n01R',NSIGHT,900)
  
  call SaveInteger(UnitStats,'h309',SIGHT,1600)
  call SaveInteger(UnitStats,'h309',NSIGHT,1000)
  
  call SaveInteger(UnitStats,'n01M',SIGHT,1400)
  
  call SaveInteger(UnitStats,'n01S',SIGHT,1400)
  
  
  call SaveInteger(UnitStats,'n004',SIGHT,1400)
  call SaveInteger(UnitStats,'n018',SIGHT,1400)
  call SaveInteger(UnitStats,'n01C',SIGHT,1400)
  call SaveInteger(UnitStats,'n01G',SIGHT,1400)
  
  call SaveInteger(UnitStats,'efon',SIGHT,1200)
  call SaveInteger(UnitStats,'osp4',SIGHT,1200)
  call SaveInteger(UnitStats,'o008',SIGHT,1200)
  call SaveInteger(UnitStats,'o009',SIGHT,1200)
  call SaveInteger(UnitStats,'o01C',SIGHT,1200)
  call SaveInteger(UnitStats,'o01D',SIGHT,1200)
  call SaveInteger(UnitStats,'o01E',SIGHT,1200)
  
  call SaveInteger(UnitStats,'o005',SIGHT,1200)
  call SaveInteger(UnitStats,'o006',SIGHT,1200)
  call SaveInteger(UnitStats,'o007',SIGHT,1200)
  call SaveInteger(UnitStats,'o00F',SIGHT,1200)
  
  call SaveInteger(UnitStats,'o00T',SIGHT,1200)
  call SaveInteger(UnitStats,'o00U',SIGHT,1200)
  call SaveInteger(UnitStats,'o00V',SIGHT,1200)
  call SaveInteger(UnitStats,'o00W',SIGHT,1200)
  call SaveInteger(UnitStats,'o00T',NSIGHT,800)
  call SaveInteger(UnitStats,'o00U',NSIGHT,800)
  call SaveInteger(UnitStats,'o00V',NSIGHT,800)
  call SaveInteger(UnitStats,'o00W',NSIGHT,800)
  
  call SaveInteger(UnitStats,'hwat',SIGHT,1200)
  call SaveInteger(UnitStats,'hwt2',SIGHT,1200)
  call SaveInteger(UnitStats,'hwt3',SIGHT,1200)
  call SaveInteger(UnitStats,'h006',SIGHT,1200)
  
  call SaveInteger(UnitStats,'n00U',NSIGHT,1800)
  call SaveInteger(UnitStats,'n00Y',NSIGHT,1800)
  call SaveInteger(UnitStats,'n00Z',NSIGHT,1800)
  
  call SaveInteger(UnitStats,'n0KU',NSIGHT,1800)
  call SaveInteger(UnitStats,'n0KV',NSIGHT,1800)
  call SaveInteger(UnitStats,'n0KW',NSIGHT,1800)
  
  call SaveInteger(UnitStats,'n027',SIGHT,1200)
  
  call SaveInteger(UnitStats,'o004',SIGHT,1600)
  call SaveInteger(UnitStats,'o004',NSIGHT,1600)
  
  call SaveInteger(UnitStats,'Usyl',NSIGHT,1000)
  call SaveInteger(UnitStats,'Naka',NSIGHT,1000)
  
  call SaveInteger(UnitStats,'N01I',NSIGHT,1400)
  call SaveInteger(UnitStats,'N01H',NSIGHT,1400)
  call SaveInteger(UnitStats,'N01T',NSIGHT,1400)
  call SaveInteger(UnitStats,'N01J',NSIGHT,1400)
  call SaveInteger(UnitStats,'N0HT',NSIGHT,1400)
  call SaveInteger(UnitStats,'H600',NSIGHT,1400)
  call SaveInteger(UnitStats,'H601',NSIGHT,1400)
  call SaveInteger(UnitStats,'H602',NSIGHT,1400)
  
  call SaveInteger(UnitStats,'Udre',SIGHT,1200)
  call SaveInteger(UnitStats,'Udre',NSIGHT,1800)
  call SaveInteger(UnitStats,'H071',NSIGHT,1800)
  call SaveInteger(UnitStats,'o01N',NSIGHT,1800)
  
  
endfunction

function StoreAllUnitsBounty takes nothing returns nothing
  //Bounty - gold per kill; LastTimeActivity - lower, H - higher. Hope 
  //Exp - exp per kill
  
  //creeps
  call SaveInteger(UnitStats,'ugho',BOUNTYL,38) //ghouls
  call SaveInteger(UnitStats,'ugho',BOUNTYH,48)
  call SaveInteger(UnitStats,'ugho',EXP,62)
  call SaveInteger(UnitStats,'u001',BOUNTYL,18) //mega ghouls
  call SaveInteger(UnitStats,'u001',BOUNTYH,26)
  call SaveInteger(UnitStats,'u001',EXP,25)
  call SaveInteger(UnitStats,'unec',BOUNTYL,43) //necros
  call SaveInteger(UnitStats,'unec',BOUNTYH,53)
  call SaveInteger(UnitStats,'unec',EXP,41)
  call SaveInteger(UnitStats,'u002',BOUNTYL,18) //mega necros
  call SaveInteger(UnitStats,'u002',BOUNTYH,26)
  call SaveInteger(UnitStats,'u002',EXP,25)
  
  call SaveInteger(UnitStats,'esen',BOUNTYL,38) //treant
  call SaveInteger(UnitStats,'esen',BOUNTYH,48)
  call SaveInteger(UnitStats,'esen',EXP,62)
  call SaveInteger(UnitStats,'e00V',BOUNTYL,18) //mega treant
  call SaveInteger(UnitStats,'e00V',BOUNTYH,26)
  call SaveInteger(UnitStats,'e00V',EXP,25)
  call SaveInteger(UnitStats,'edry',BOUNTYL,43) //druids
  call SaveInteger(UnitStats,'edry',BOUNTYH,53)
  call SaveInteger(UnitStats,'edry',EXP,41)
  call SaveInteger(UnitStats,'e00W',BOUNTYL,18) //mega druids
  call SaveInteger(UnitStats,'e00W',BOUNTYH,26)
  call SaveInteger(UnitStats,'e00W',EXP,25)
  
  call SaveInteger(UnitStats,'ebal',BOUNTYL,66) //ballista
  call SaveInteger(UnitStats,'ebal',BOUNTYH,80)
  call SaveInteger(UnitStats,'ebal',EXP,88)
  call SaveInteger(UnitStats,'e026',BOUNTYL,66) //mega ballista
  call SaveInteger(UnitStats,'e026',BOUNTYH,80)
  call SaveInteger(UnitStats,'e026',EXP,88)
  call SaveInteger(UnitStats,'umtw',BOUNTYL,66) //meat wagon
  call SaveInteger(UnitStats,'umtw',BOUNTYH,80)
  call SaveInteger(UnitStats,'umtw',EXP,88)
  call SaveInteger(UnitStats,'u00R',BOUNTYL,66) //mega meat wagon
  call SaveInteger(UnitStats,'u00R',BOUNTYH,80)
  call SaveInteger(UnitStats,'u00R',EXP,88)
  
  //buildings sent
  call SaveInteger(UnitStats,'e019',BOUNTYL,150) //Ancient protector Tier 4
  call SaveInteger(UnitStats,'e019',BOUNTYH,250)
  call SaveInteger(UnitStats,'e019',EXP,25)
  call SaveInteger(UnitStats,'e00S',BOUNTYL,150) //Ancient protector Tier 3
  call SaveInteger(UnitStats,'e00S',BOUNTYH,250)
  call SaveInteger(UnitStats,'e00S',EXP,25)
  call SaveInteger(UnitStats,'e011',BOUNTYL,150) //Ancient protector Tier 2
  call SaveInteger(UnitStats,'e011',BOUNTYH,250)
  call SaveInteger(UnitStats,'e011',EXP,25)
  call SaveInteger(UnitStats,'e00R',BOUNTYL,150) //Ancient protector Tier 1
  call SaveInteger(UnitStats,'e00R',BOUNTYH,250)
  call SaveInteger(UnitStats,'e00R',EXP,25)
  
  call SaveInteger(UnitStats,'eaom',BOUNTYL,100) //Melee rax (Ancient of war)
  call SaveInteger(UnitStats,'eaom',BOUNTYH,150)
  call SaveInteger(UnitStats,'eaom',EXP,25)
  call SaveInteger(UnitStats,'eaoe',BOUNTYL,100) //Ranged rax (Ancient of Lore)
  call SaveInteger(UnitStats,'eaoe',BOUNTYH,150)
  call SaveInteger(UnitStats,'eaoe',EXP,25)
  
  call SaveInteger(UnitStats,'edob',BOUNTYL,252) //Hunters Hall
  call SaveInteger(UnitStats,'edob',BOUNTYH,270)
  call SaveInteger(UnitStats,'edob',EXP,0)
  call SaveInteger(UnitStats,'eaow',BOUNTYL,302) //Ancient of wind
  call SaveInteger(UnitStats,'eaow',BOUNTYH,320)
  call SaveInteger(UnitStats,'eaow',EXP,25)
  call SaveInteger(UnitStats,'emow',BOUNTYL,102) //Moon wells
  call SaveInteger(UnitStats,'emow',BOUNTYH,120)
  call SaveInteger(UnitStats,'emow',EXP,25)
  
  //buildings scourge
  call SaveInteger(UnitStats,'u00T',BOUNTYL,150) //Zigg Tier 4
  call SaveInteger(UnitStats,'u00T',BOUNTYH,250)
  call SaveInteger(UnitStats,'u00T',EXP,25)
  call SaveInteger(UnitStats,'u00N',BOUNTYL,150) //Zigg Tier 3
  call SaveInteger(UnitStats,'u00N',BOUNTYH,250)
  call SaveInteger(UnitStats,'u00N',EXP,25)
  call SaveInteger(UnitStats,'u00D',BOUNTYL,150) //Zigg Tier 2
  call SaveInteger(UnitStats,'u00D',BOUNTYH,250)
  call SaveInteger(UnitStats,'u00D',EXP,25)
  call SaveInteger(UnitStats,'u00M',BOUNTYL,150) //Zigg Tier 1
  call SaveInteger(UnitStats,'u00M',BOUNTYH,250)
  call SaveInteger(UnitStats,'u00M',EXP,25)
  
  call SaveInteger(UnitStats,'usep',BOUNTYL,100) //Melee rax
  call SaveInteger(UnitStats,'usep',BOUNTYH,150)
  call SaveInteger(UnitStats,'usep',EXP,25)
  call SaveInteger(UnitStats,'utod',BOUNTYL,100) //Ranged rax
  call SaveInteger(UnitStats,'utod',BOUNTYH,150)
  call SaveInteger(UnitStats,'utod',EXP,25)
  
  call SaveInteger(UnitStats,'ubon',BOUNTYL,252) //Wyrm nest
  call SaveInteger(UnitStats,'ubon',BOUNTYH,270)
  call SaveInteger(UnitStats,'ubon',EXP,0)
  call SaveInteger(UnitStats,'usap',BOUNTYL,302) //Sacrifice pit
  call SaveInteger(UnitStats,'usap',BOUNTYH,320)
  call SaveInteger(UnitStats,'usap',EXP,25)
  call SaveInteger(UnitStats,'uzig',BOUNTYL,102) //Ziggs
  call SaveInteger(UnitStats,'uzig',BOUNTYH,120)
  call SaveInteger(UnitStats,'uzig',EXP,25)
  
  //neutrals
  call SaveInteger(UnitStats,'ndtw',BOUNTYL,54) //Dark troll warlord
  call SaveInteger(UnitStats,'ndtw',BOUNTYH,62)
  call SaveInteger(UnitStats,'ndtw',EXP,119)
  call SaveInteger(UnitStats,'ndtr',BOUNTYL,26) //Dark troll
  call SaveInteger(UnitStats,'ndtr',BOUNTYH,33)
  call SaveInteger(UnitStats,'ndtr',EXP,62)
  call SaveInteger(UnitStats,'uske',BOUNTYL,6) //Skeleton warrior
  call SaveInteger(UnitStats,'uske',BOUNTYH,12)
  call SaveInteger(UnitStats,'uske',EXP,25)
  
  
  call SaveInteger(UnitStats,'nfsh',BOUNTYL,21) //Forest troll priest
  call SaveInteger(UnitStats,'nfsh',BOUNTYH,25)
  call SaveInteger(UnitStats,'nfsh',EXP,41)
  call SaveInteger(UnitStats,'nftb',BOUNTYL,22) //Forest troll berserker
  call SaveInteger(UnitStats,'nftb',BOUNTYH,26)
  call SaveInteger(UnitStats,'nftb',EXP,41)
  call SaveInteger(UnitStats,'nkol',BOUNTYL,23) //Kobold Taskmaster
  call SaveInteger(UnitStats,'nkol',BOUNTYH,29)
  call SaveInteger(UnitStats,'nkol',EXP,41)
  
  call SaveInteger(UnitStats,'nowe',BOUNTYL,67) //Enraged wildkin
  call SaveInteger(UnitStats,'nowe',BOUNTYH,87)
  call SaveInteger(UnitStats,'nowe',EXP,119)
  call SaveInteger(UnitStats,'nowb',BOUNTYL,15) //Wildkin
  call SaveInteger(UnitStats,'nowb',BOUNTYH,20)
  call SaveInteger(UnitStats,'nowb',EXP,25)
  
  call SaveInteger(UnitStats,'nomg',BOUNTYL,43) //Ogre magi
  call SaveInteger(UnitStats,'nomg',BOUNTYH,61)
  call SaveInteger(UnitStats,'nomg',EXP,62)
  call SaveInteger(UnitStats,'nogm',BOUNTYL,23) //Ogre Mauler
  call SaveInteger(UnitStats,'nogm',BOUNTYH,47)
  call SaveInteger(UnitStats,'nogm',EXP,41)
  
  call SaveInteger(UnitStats,'n026',BOUNTYL,54) //Mud golem
  call SaveInteger(UnitStats,'n026',BOUNTYH,62)
  call SaveInteger(UnitStats,'n026',EXP,119)
  
  call SaveInteger(UnitStats,'ncnk',BOUNTYL,66) //Centaur Khan
  call SaveInteger(UnitStats,'ncnk',BOUNTYH,78)
  call SaveInteger(UnitStats,'ncnk',EXP,119)
  call SaveInteger(UnitStats,'ncen',BOUNTYL,20) //Centaur outrunner
  call SaveInteger(UnitStats,'ncen',BOUNTYH,24)
  call SaveInteger(UnitStats,'ncen',EXP,41)
  
  call SaveInteger(UnitStats,'ngns',BOUNTYL,21) //Gnoll Assassin
  call SaveInteger(UnitStats,'ngns',BOUNTYH,29)
  call SaveInteger(UnitStats,'ngns',EXP,41)
  
  call SaveInteger(UnitStats,'nfpu',BOUNTYL,76) //Polar Furbolg Ursa Warrior
  call SaveInteger(UnitStats,'nfpu',BOUNTYH,86)
  call SaveInteger(UnitStats,'nfpu',EXP,119)
  call SaveInteger(UnitStats,'nfpc',BOUNTYL,60) //Polar Furbolg Champion
  call SaveInteger(UnitStats,'nfpc',BOUNTYH,70)
  call SaveInteger(UnitStats,'nfpc',EXP,88)
  
  call SaveInteger(UnitStats,'n0HW',BOUNTYL,24) //Harpy Scout
  call SaveInteger(UnitStats,'n0HW',BOUNTYH,27)
  call SaveInteger(UnitStats,'n0HW',EXP,41)
  call SaveInteger(UnitStats,'n0HX',BOUNTYL,34) //Harpy Storm
  call SaveInteger(UnitStats,'n0HX',BOUNTYH,37)
  call SaveInteger(UnitStats,'n0HX',EXP,62)
  
  call SaveInteger(UnitStats,'ngh1',BOUNTYL,30) //Ghost
  call SaveInteger(UnitStats,'ngh1',BOUNTYH,40)
  call SaveInteger(UnitStats,'ngh1',EXP,62)
  call SaveInteger(UnitStats,'npfl',BOUNTYL,20) //Fel Beast
  call SaveInteger(UnitStats,'npfl',BOUNTYH,24)
  call SaveInteger(UnitStats,'npfl',EXP,41)
  
  call SaveInteger(UnitStats,'nkot',BOUNTYL,17) //Kobold Tunneler
  call SaveInteger(UnitStats,'nkot',BOUNTYH,19)
  call SaveInteger(UnitStats,'nkot',EXP,25)
  call SaveInteger(UnitStats,'nkob',BOUNTYL,7) //Kobold
  call SaveInteger(UnitStats,'nkob',BOUNTYH,9)
  call SaveInteger(UnitStats,'nkob',EXP,25)
  
  call SaveInteger(UnitStats,'nsat',BOUNTYL,15) //Satyr Trickster
  call SaveInteger(UnitStats,'nsat',BOUNTYH,17)
  call SaveInteger(UnitStats,'nsat',EXP,41)
  call SaveInteger(UnitStats,'nstl',BOUNTYL,27) //Satyr Soulstealer
  call SaveInteger(UnitStats,'nstl',BOUNTYH,33)
  call SaveInteger(UnitStats,'nstl',EXP,62)
  call SaveInteger(UnitStats,'nsth',BOUNTYL,97) //Satyr Hellcaster
  call SaveInteger(UnitStats,'nsth',BOUNTYH,111)
  call SaveInteger(UnitStats,'nsth',EXP,119)
  
  call SaveInteger(UnitStats,'n00S',BOUNTYL,22) //Alpha wolf
  call SaveInteger(UnitStats,'n00S',BOUNTYH,26)
  call SaveInteger(UnitStats,'n00S',EXP,62)
  call SaveInteger(UnitStats,'nwlg',BOUNTYL,22) //Giant wolf
  call SaveInteger(UnitStats,'nwlg',BOUNTYH,26)
  call SaveInteger(UnitStats,'nwlg',EXP,62)
  
  
  
  //Ancients
  call SaveInteger(UnitStats,'ngst',BOUNTYL,54) //Rock golem
  call SaveInteger(UnitStats,'ngst',BOUNTYH,62)
  call SaveInteger(UnitStats,'ngst',EXP,119)
  call SaveInteger(UnitStats,'nggr',BOUNTYL,107) //Emerald Golem
  call SaveInteger(UnitStats,'nggr',BOUNTYH,121)
  call SaveInteger(UnitStats,'nggr',EXP,155)
  
  call SaveInteger(UnitStats,'nbwm',BOUNTYL,164) //Black dragon
  call SaveInteger(UnitStats,'nbwm',BOUNTYH,234)
  call SaveInteger(UnitStats,'nbwm',EXP,155)
  call SaveInteger(UnitStats,'nbdk',BOUNTYL,44) //Black drake
  call SaveInteger(UnitStats,'nbdk',BOUNTYH,56)
  call SaveInteger(UnitStats,'nbdk',EXP,62)
  
  call SaveInteger(UnitStats,'njga',BOUNTYL,152) //Elder Jungle stalker
  call SaveInteger(UnitStats,'njga',BOUNTYH,170)
  call SaveInteger(UnitStats,'njga',EXP,155)
  call SaveInteger(UnitStats,'njg1',BOUNTYL,52) //Jungle Stalker
  call SaveInteger(UnitStats,'njg1',BOUNTYH,70)
  call SaveInteger(UnitStats,'njg1',EXP,119)
  
  call SaveInteger(UnitStats,'nbdo',BOUNTYL,86) //Blue Dragonspawn overseer
  call SaveInteger(UnitStats,'nbdo',BOUNTYH,98)
  call SaveInteger(UnitStats,'nbdo',EXP,119)
  call SaveInteger(UnitStats,'nbds',BOUNTYL,74) //Blue Dragonspawn Sorcerer
  call SaveInteger(UnitStats,'nbds',BOUNTYH,82)
  call SaveInteger(UnitStats,'nbds',EXP,62)
  
  call SaveInteger(UnitStats,'n0LC',BOUNTYL,89) //Thunder Lizard big
  call SaveInteger(UnitStats,'n0LC',BOUNTYH,97)
  call SaveInteger(UnitStats,'n0LC',EXP,155)
  call SaveInteger(UnitStats,'n0LD',BOUNTYL,79) //Thunder Lizard
  call SaveInteger(UnitStats,'n0LD',BOUNTYH,87)
  call SaveInteger(UnitStats,'n0LD',EXP,119)
  //super creeps
  call SaveInteger(UnitStats,'n003',BOUNTYL,106) //Siege golem
  call SaveInteger(UnitStats,'n003',BOUNTYH,700)
  call SaveInteger(UnitStats,'n003',EXP,349)
  call SaveInteger(UnitStats,'n00E',BOUNTYL,158) //Scary Fish
  call SaveInteger(UnitStats,'n00E',BOUNTYH,950)
  call SaveInteger(UnitStats,'n00E',EXP,410)
  call SaveInteger(UnitStats,'n00D',BOUNTYL,111) //Ancient Hydra
  call SaveInteger(UnitStats,'n00D',BOUNTYH,1200)
  call SaveInteger(UnitStats,'n00D',EXP,476)
  
  //Roshan
  call SaveInteger(UnitStats,'n00L',BOUNTYL,150) //Roshan
  call SaveInteger(UnitStats,'n00L',BOUNTYH,400)
  call SaveInteger(UnitStats,'n00L',EXP,1789)
  
  //Summons
  //Rexxar
  call SaveInteger(UnitStats,'h308',BOUNTYL,30) //Hawk
  call SaveInteger(UnitStats,'h308',BOUNTYH,30)
  call SaveInteger(UnitStats,'h308',EXP,41)
  call SaveInteger(UnitStats,'n01Q',BOUNTYL,40) //Scout Hawk
  call SaveInteger(UnitStats,'n01Q',BOUNTYH,40)
  call SaveInteger(UnitStats,'n01Q',EXP,41)
  call SaveInteger(UnitStats,'n01R',BOUNTYL,50) //Greater Scout Hawk
  call SaveInteger(UnitStats,'n01R',BOUNTYH,50)
  call SaveInteger(UnitStats,'n01R',EXP,155)
  call SaveInteger(UnitStats,'h309',BOUNTYL,60) //Legendary Hawk
  call SaveInteger(UnitStats,'h309',BOUNTYH,60)
  call SaveInteger(UnitStats,'h309',EXP,155)
  
  call SaveInteger(UnitStats,'h30A',BOUNTYL,26) //Baby Quilbeast
  call SaveInteger(UnitStats,'h30A',BOUNTYH,38)
  call SaveInteger(UnitStats,'h30A',EXP,119)
  call SaveInteger(UnitStats,'n01M',BOUNTYL,26) //Quilbeast
  call SaveInteger(UnitStats,'n01M',BOUNTYH,38)
  call SaveInteger(UnitStats,'n01M',EXP,119)
  call SaveInteger(UnitStats,'n01S',BOUNTYL,26) //Greater Quilbeast
  call SaveInteger(UnitStats,'n01S',BOUNTYH,38)
  call SaveInteger(UnitStats,'n01S',EXP,119)
  call SaveInteger(UnitStats,'h30B',BOUNTYL,26) //Legendary Quilbeast
  call SaveInteger(UnitStats,'h30B',BOUNTYH,38)
  call SaveInteger(UnitStats,'h30B',EXP,119)
  
  //Brewmaster primal split
  call SaveInteger(UnitStats,'npn1',BOUNTYL,11) //Fire 1
  call SaveInteger(UnitStats,'npn1',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn1',EXP,196)
  call SaveInteger(UnitStats,'npn4',BOUNTYL,11) //Fire 2
  call SaveInteger(UnitStats,'npn4',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn4',EXP,242)
  call SaveInteger(UnitStats,'n011',BOUNTYL,31) //Fire 3
  call SaveInteger(UnitStats,'n011',BOUNTYH,35)
  call SaveInteger(UnitStats,'n011',EXP,242)
  
  call SaveInteger(UnitStats,'npn2',BOUNTYL,11) //Storm 1
  call SaveInteger(UnitStats,'npn2',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn2',EXP,196)
  call SaveInteger(UnitStats,'npn5',BOUNTYL,11) //Storm 2
  call SaveInteger(UnitStats,'npn5',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn5',EXP,242)
  call SaveInteger(UnitStats,'n012',BOUNTYL,31) //Storm 3
  call SaveInteger(UnitStats,'n012',BOUNTYH,35)
  call SaveInteger(UnitStats,'n012',EXP,242)
  
  call SaveInteger(UnitStats,'npn3',BOUNTYL,11) //Earth 1
  call SaveInteger(UnitStats,'npn3',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn3',EXP,196)
  call SaveInteger(UnitStats,'npn5',BOUNTYL,11) //Earth 2
  call SaveInteger(UnitStats,'npn5',BOUNTYH,15)
  call SaveInteger(UnitStats,'npn5',EXP,242)
  call SaveInteger(UnitStats,'n010',BOUNTYL,31) //Earth 3
  call SaveInteger(UnitStats,'n010',BOUNTYH,35)
  call SaveInteger(UnitStats,'n010',EXP,242)
  
  //Tuskar
  call SaveInteger(UnitStats,'o01J',BOUNTYL,90) //Frozen Sigil 1
  call SaveInteger(UnitStats,'o01J',BOUNTYH,90)
  call SaveInteger(UnitStats,'o01J',EXP,0)
  call SaveInteger(UnitStats,'o01K',BOUNTYL,100) //Frozen Sigil 2
  call SaveInteger(UnitStats,'o01K',BOUNTYH,100)
  call SaveInteger(UnitStats,'o01K',EXP,0)
  call SaveInteger(UnitStats,'o01L',BOUNTYL,110) //Frozen Sigil 3
  call SaveInteger(UnitStats,'o01L',BOUNTYH,110)
  call SaveInteger(UnitStats,'o01L',EXP,0)
  call SaveInteger(UnitStats,'o01M',BOUNTYL,120) //Frozen Sigil 4
  call SaveInteger(UnitStats,'o01M',BOUNTYH,120)
  call SaveInteger(UnitStats,'o01M',EXP,0)
  
  //Lone druid
  call SaveInteger(UnitStats,'n004',BOUNTYL,300) //Spirit Bear 1
  call SaveInteger(UnitStats,'n004',BOUNTYH,300)
  call SaveInteger(UnitStats,'n004',EXP,300)
  call SaveInteger(UnitStats,'n018',BOUNTYL,300) //Spirit Bear 2
  call SaveInteger(UnitStats,'n018',BOUNTYH,300)
  call SaveInteger(UnitStats,'n018',EXP,300)
  call SaveInteger(UnitStats,'n01C',BOUNTYL,300) //Spirit Bear 3
  call SaveInteger(UnitStats,'n01C',BOUNTYH,300)
  call SaveInteger(UnitStats,'n01C',EXP,300)
  call SaveInteger(UnitStats,'n01G',BOUNTYL,300) //Spirit Bear 4
  call SaveInteger(UnitStats,'n01G',BOUNTYH,300)
  call SaveInteger(UnitStats,'n01G',EXP,300)
  
  //Prophet furion
  call SaveInteger(UnitStats,'efon',BOUNTYL,14) //Force of nature
  call SaveInteger(UnitStats,'efon',BOUNTYH,20)
  call SaveInteger(UnitStats,'efon',EXP,30)
  
  //Rhasta Shadow Shaman
  call SaveInteger(UnitStats,'osp4',BOUNTYL,26) //Mass serpents 1
  call SaveInteger(UnitStats,'osp4',BOUNTYH,38)
  call SaveInteger(UnitStats,'osp4',EXP,62)
  call SaveInteger(UnitStats,'o008',BOUNTYL,26) //Mass serpents 2
  call SaveInteger(UnitStats,'o008',BOUNTYH,38)
  call SaveInteger(UnitStats,'o008',EXP,62)
  call SaveInteger(UnitStats,'o009',BOUNTYL,26) //Mass serpents 3
  call SaveInteger(UnitStats,'o009',BOUNTYH,38)
  call SaveInteger(UnitStats,'o009',EXP,62)
  call SaveInteger(UnitStats,'o01C',BOUNTYL,26) //Mass serpents 1
  call SaveInteger(UnitStats,'o01C',BOUNTYH,38)
  call SaveInteger(UnitStats,'o01C',EXP,62)
  call SaveInteger(UnitStats,'o01D',BOUNTYL,26) //Mass serpents 2
  call SaveInteger(UnitStats,'o01D',BOUNTYH,38)
  call SaveInteger(UnitStats,'o01D',EXP,62)
  call SaveInteger(UnitStats,'o01E',BOUNTYL,26) //Mass serpents 3
  call SaveInteger(UnitStats,'o01E',BOUNTYH,38)
  call SaveInteger(UnitStats,'o01E',EXP,62)
  
  //Lycan Wolf
  call SaveInteger(UnitStats,'o005',BOUNTYL,21) //Wolves 1
  call SaveInteger(UnitStats,'o005',BOUNTYH,21)
  call SaveInteger(UnitStats,'o005',EXP,41)
  call SaveInteger(UnitStats,'o006',BOUNTYL,26) //Wolves 2
  call SaveInteger(UnitStats,'o006',BOUNTYH,26)
  call SaveInteger(UnitStats,'o006',EXP,41)
  call SaveInteger(UnitStats,'o007',BOUNTYL,36) //Wolves 3
  call SaveInteger(UnitStats,'o007',BOUNTYH,36)
  call SaveInteger(UnitStats,'o007',EXP,41)
  call SaveInteger(UnitStats,'o00F',BOUNTYL,41) //Wolves 4
  call SaveInteger(UnitStats,'o00F',BOUNTYH,41)
  call SaveInteger(UnitStats,'o00F',EXP,41)
  
  //urna swarm
  call SaveInteger(UnitStats,'u012',BOUNTYL,26)//little bitches urna swarm
  call SaveInteger(UnitStats,'u012',BOUNTYH,38)
  call SaveInteger(UnitStats,'u012',EXP,41)
  
  //Undying old zombie
  call SaveInteger(UnitStats,'n020',BOUNTYL,14) //Raise dead
  call SaveInteger(UnitStats,'n020',BOUNTYH,28)
  call SaveInteger(UnitStats,'n020',EXP,62)
  
  call SaveInteger(UnitStats,'n0FJ',BOUNTYL,75) //Tombstone 1
  call SaveInteger(UnitStats,'n0FJ',BOUNTYH,75)
  call SaveInteger(UnitStats,'n0FJ',EXP,0)
  call SaveInteger(UnitStats,'n0FI',BOUNTYL,100) //Tombstone 2
  call SaveInteger(UnitStats,'n0FI',BOUNTYH,100)
  call SaveInteger(UnitStats,'n0FI',EXP,0)
  call SaveInteger(UnitStats,'n0F6',BOUNTYL,125) //Tombstone 3
  call SaveInteger(UnitStats,'n0F6',BOUNTYH,125)
  call SaveInteger(UnitStats,'n0F6',EXP,0)
  call SaveInteger(UnitStats,'n0FH',BOUNTYL,150) //Tombstone 4
  call SaveInteger(UnitStats,'n0FH',BOUNTYH,150)
  call SaveInteger(UnitStats,'n0FH',EXP,0)
  
  call SaveInteger(UnitStats,'h0CH',BOUNTYL,20) //Homing missile
  call SaveInteger(UnitStats,'h0CH',BOUNTYH,30)
  call SaveInteger(UnitStats,'h0CF',BOUNTYL,20) //Homing missile
  call SaveInteger(UnitStats,'h0CF',BOUNTYH,30)
  call SaveInteger(UnitStats,'h0C1',BOUNTYL,20) //Homing missile
  call SaveInteger(UnitStats,'h0C1',BOUNTYH,30)
  call SaveInteger(UnitStats,'h0CG',BOUNTYL,20) //Homing missile
  call SaveInteger(UnitStats,'h0CG',BOUNTYH,30)
  
  //Brood
  call SaveInteger(UnitStats,'n019',BOUNTYL,11) //Spiderling
  call SaveInteger(UnitStats,'n019',BOUNTYH,13)
  call SaveInteger(UnitStats,'n019',EXP,62)
  call SaveInteger(UnitStats,'n01E',BOUNTYL,16) //Spiderite
  call SaveInteger(UnitStats,'n01E',BOUNTYH,21)
  call SaveInteger(UnitStats,'n01E',EXP,41)
  
  //Weaver
  call SaveInteger(UnitStats,'u01K',BOUNTYL,32) //Swarm 1
  call SaveInteger(UnitStats,'u01K',BOUNTYH,34)
  call SaveInteger(UnitStats,'u01K',EXP,41)
  call SaveInteger(UnitStats,'u01H',BOUNTYL,32) //Swarm 2
  call SaveInteger(UnitStats,'u01H',BOUNTYH,34)
  call SaveInteger(UnitStats,'u01H',EXP,41)
  call SaveInteger(UnitStats,'u01J',BOUNTYL,32) //Swarm 3
  call SaveInteger(UnitStats,'u01J',BOUNTYH,34)
  call SaveInteger(UnitStats,'u01J',EXP,41)
  call SaveInteger(UnitStats,'u01L',BOUNTYL,32) //Swarm 4
  call SaveInteger(UnitStats,'u01L',BOUNTYH,34)
  call SaveInteger(UnitStats,'u01L',EXP,41)
  
  //Venomancer
  call SaveInteger(UnitStats,'o00T',BOUNTYL,14) //Plague ward 1
  call SaveInteger(UnitStats,'o00T',BOUNTYH,17)
  call SaveInteger(UnitStats,'o00T',EXP,20)
  call SaveInteger(UnitStats,'o00U',BOUNTYL,14) //Plague ward 2
  call SaveInteger(UnitStats,'o00U',BOUNTYH,17)
  call SaveInteger(UnitStats,'o00U',EXP,25)
  call SaveInteger(UnitStats,'o00V',BOUNTYL,14) //Plague ward 3
  call SaveInteger(UnitStats,'o00V',BOUNTYH,17)
  call SaveInteger(UnitStats,'o00V',EXP,30)
  call SaveInteger(UnitStats,'o00W',BOUNTYL,14) //Plague ward 4
  call SaveInteger(UnitStats,'o00W',BOUNTYH,17)
  call SaveInteger(UnitStats,'o00W',EXP,35)
  
  //Enigma
  call SaveInteger(UnitStats,'hwat',BOUNTYL,22) //Lesser eidolon
  call SaveInteger(UnitStats,'hwat',BOUNTYH,36)
  call SaveInteger(UnitStats,'hwat',EXP,25)
  call SaveInteger(UnitStats,'hwt2',BOUNTYL,22) //Eidolon
  call SaveInteger(UnitStats,'hwt2',BOUNTYH,36)
  call SaveInteger(UnitStats,'hwt2',EXP,25)
  call SaveInteger(UnitStats,'hwt3',BOUNTYL,22) //Greater eidolon
  call SaveInteger(UnitStats,'hwt3',BOUNTYH,36)
  call SaveInteger(UnitStats,'hwt3',EXP,25)
  call SaveInteger(UnitStats,'h006',BOUNTYL,22) //Dire eidolon
  call SaveInteger(UnitStats,'h006',BOUNTYH,36)
  call SaveInteger(UnitStats,'h006',EXP,25)
  
  //Oblivion Pugna
  call SaveInteger(UnitStats,'o00M',BOUNTYL,20) //Nether ward 1
  call SaveInteger(UnitStats,'o00M',BOUNTYH,20)
  call SaveInteger(UnitStats,'o00M',EXP,0)
  call SaveInteger(UnitStats,'o00L',BOUNTYL,40) //Nether ward 2
  call SaveInteger(UnitStats,'o00L',BOUNTYH,40)
  call SaveInteger(UnitStats,'o00L',EXP,0)
  call SaveInteger(UnitStats,'o00O',BOUNTYL,60) //Nether ward 3
  call SaveInteger(UnitStats,'o00O',BOUNTYH,60)
  call SaveInteger(UnitStats,'o00O',EXP,0)
  call SaveInteger(UnitStats,'o00N',BOUNTYL,80) //Nether ward 4
  call SaveInteger(UnitStats,'o00N',BOUNTYH,80)
  call SaveInteger(UnitStats,'o00N',EXP,0)
  
  //Warlock WL
  call SaveInteger(UnitStats,'n00U',BOUNTYL,100) //Rain of Chaos 1
  call SaveInteger(UnitStats,'n00U',BOUNTYH,100)
  call SaveInteger(UnitStats,'n00U',EXP,196)
  call SaveInteger(UnitStats,'n00Y',BOUNTYL,150) //Rain of Chaos 2
  call SaveInteger(UnitStats,'n00Y',BOUNTYH,150)
  call SaveInteger(UnitStats,'n00Y',EXP,196)
  call SaveInteger(UnitStats,'n00Z',BOUNTYL,200) //Rain of Chaos 3
  call SaveInteger(UnitStats,'n00Z',BOUNTYH,200)
  call SaveInteger(UnitStats,'n00Z',EXP,196)
  
  call SaveInteger(UnitStats,'n0KU',BOUNTYL,50) //Rain of Chaos upg 1
  call SaveInteger(UnitStats,'n0KU',BOUNTYH,50)
  call SaveInteger(UnitStats,'n0KU',EXP,196)
  call SaveInteger(UnitStats,'n0KV',BOUNTYL,75) //Rain of Chaos upg 2
  call SaveInteger(UnitStats,'n0KV',BOUNTYH,75)
  call SaveInteger(UnitStats,'n0KV',EXP,196)
  call SaveInteger(UnitStats,'n0KW',BOUNTYL,100) //Rain of Chaos upg 3
  call SaveInteger(UnitStats,'n0KW',BOUNTYH,100)
  call SaveInteger(UnitStats,'n0KW',EXP,196)
  
  //Invoker Forge
  call SaveInteger(UnitStats,'n027',BOUNTYL,32) //Forge spirit
  call SaveInteger(UnitStats,'n027',BOUNTYH,46)
  call SaveInteger(UnitStats,'n027',EXP,62)
  
  call SaveInteger(UnitStats,'fRG1',BOUNTYL,32) //Forge spirit
  call SaveInteger(UnitStats,'fRG1',BOUNTYH,46)
  call SaveInteger(UnitStats,'fRG1',EXP,62)
  
  call SaveInteger(UnitStats,'fRG2',BOUNTYL,32) //Forge spirit
  call SaveInteger(UnitStats,'fRG2',BOUNTYH,46)
  call SaveInteger(UnitStats,'fRG2',EXP,62)
  
  call SaveInteger(UnitStats,'fRG3',BOUNTYL,32) //Forge spirit
  call SaveInteger(UnitStats,'fRG3',BOUNTYH,46)
  call SaveInteger(UnitStats,'fRG3',EXP,62)
  
  call SaveInteger(UnitStats,'fRG4',BOUNTYL,32) //Forge spirit
  call SaveInteger(UnitStats,'fRG4',BOUNTYH,46)
  call SaveInteger(UnitStats,'fRG4',EXP,62)
  
  //Clockwerk Cogs
  call SaveInteger(UnitStats,'u00S',BOUNTYL,16) //Cogs
  call SaveInteger(UnitStats,'u00S',BOUNTYH,20)
  call SaveInteger(UnitStats,'u00S',EXP,0)
  //Visage
  call SaveInteger(UnitStats,'u014',BOUNTYL,100) //Familiar 1-1
  call SaveInteger(UnitStats,'u014',BOUNTYH,100)
  call SaveInteger(UnitStats,'u014',EXP,41)
  call SaveInteger(UnitStats,'u01D',BOUNTYL,100) //Familiar 1-2
  call SaveInteger(UnitStats,'u01D',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01D',EXP,41)
  call SaveInteger(UnitStats,'u01R',BOUNTYL,100) //Familiar 1-3
  call SaveInteger(UnitStats,'u01R',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01R',EXP,41)
  
  call SaveInteger(UnitStats,'u015',BOUNTYL,100) //Familiar 2-1
  call SaveInteger(UnitStats,'u015',BOUNTYH,100)
  call SaveInteger(UnitStats,'u015',EXP,41)
  call SaveInteger(UnitStats,'u01E',BOUNTYL,100) //Familiar 2-2
  call SaveInteger(UnitStats,'u01E',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01E',EXP,41)
  call SaveInteger(UnitStats,'u01S',BOUNTYL,100) //Familiar 2-3
  call SaveInteger(UnitStats,'u01S',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01S',EXP,41)
  
  call SaveInteger(UnitStats,'u016',BOUNTYL,100) //Familiar 3-1
  call SaveInteger(UnitStats,'u016',BOUNTYH,100)
  call SaveInteger(UnitStats,'u016',EXP,41)
  call SaveInteger(UnitStats,'u01F',BOUNTYL,100) //Familiar 3-2
  call SaveInteger(UnitStats,'u01F',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01F',EXP,41)
  call SaveInteger(UnitStats,'u01T',BOUNTYL,100) //Familiar 3-3
  call SaveInteger(UnitStats,'u01T',BOUNTYH,100)
  call SaveInteger(UnitStats,'u01T',EXP,41)
  
  //Items
  //Necro
  call SaveInteger(UnitStats,'n00J',BOUNTYL,100) //warrior 1
  call SaveInteger(UnitStats,'n00J',BOUNTYH,100)
  call SaveInteger(UnitStats,'n00J',EXP,200)
  call SaveInteger(UnitStats,'n00H',BOUNTYL,100) //archer 1
  call SaveInteger(UnitStats,'n00H',BOUNTYH,100)
  call SaveInteger(UnitStats,'n00H',EXP,119)
  call SaveInteger(UnitStats,'n00A',BOUNTYL,150) //warrior 2
  call SaveInteger(UnitStats,'n00A',BOUNTYH,150)
  call SaveInteger(UnitStats,'n00A',EXP,300)
  call SaveInteger(UnitStats,'n00G',BOUNTYL,150) //archer 2
  call SaveInteger(UnitStats,'n00G',BOUNTYH,150)
  call SaveInteger(UnitStats,'n00G',EXP,119)
  call SaveInteger(UnitStats,'n006',BOUNTYL,200) //warrior 3
  call SaveInteger(UnitStats,'n006',BOUNTYH,200)
  call SaveInteger(UnitStats,'n006',EXP,400)
  call SaveInteger(UnitStats,'n00K',BOUNTYL,200) //archer 3
  call SaveInteger(UnitStats,'n00K',BOUNTYH,200)
  call SaveInteger(UnitStats,'n00K',EXP,119)
  
  call SaveInteger(UnitStats,'o004',BOUNTYL,50) //observer wards
  call SaveInteger(UnitStats,'o004',BOUNTYH,50)
  call SaveInteger(UnitStats,'o004',EXP,0)
endfunction

function StoreAllTints takes nothing returns nothing
  call UMD_SaveTints('o007',20,20,20)
  call UMD_SaveTints('H506',255,100,100)
  call UMD_SaveTints('o00F',20,20,20)
  call UMD_SaveTints('E031',50,50,50)
  call UMD_SaveTints('h05C',50,100,-1)
  call UMD_SaveTints('n0F7',50,50,50)
  call UMD_SaveTints('n0F8',50,50,50)
  call UMD_SaveTints('UC18',50,100,-1)
  call UMD_SaveTints('e02S',75,-1,75)
  call UMD_SaveTints('EC77',75,-1,25)
  call UMD_SaveTints('h05T',75,-1,25)
  call UMD_SaveTints('h003',100,100,100)
  call UMD_SaveTints('h05M',100,125,100)
  call UMD_SaveTints('h05V',100,100,100)
  call UMD_SaveTints('NC00',100,125,100)
  call UMD_SaveTints('ndtr',100,200,-1)
  call UMD_SaveTints('ngns',100,100,-1)
  call UMD_SaveTints('U00C',100,100,100)
  call UMD_SaveTints('u00V',100,100,100)
  call UMD_SaveTints('u01N',100,100,100)
  call UMD_SaveTints('u01Q',100,100,100)
  call UMD_SaveTints('ngh1',110,150,-1)
  call UMD_SaveTints('n010',125,125,125)
  call UMD_SaveTints('n011',125,125,125)
  call UMD_SaveTints('n012',125,125,125)
  call UMD_SaveTints('n0F6',125,125,125)
  call UMD_SaveTints('n0FH',125,125,125)
  call UMD_SaveTints('n0FI',125,125,125)
  call UMD_SaveTints('n0FJ',125,125,125)
  call UMD_SaveTints('n0GZ',125,125,125)
  call UMD_SaveTints('n0H0',125,125,125)
  call UMD_SaveTints('n0H1',125,125,125)
  call UMD_SaveTints('npn1',125,125,125)
  call UMD_SaveTints('npn2',125,125,125)
  call UMD_SaveTints('npn3',125,125,125)
  call UMD_SaveTints('npn4',125,125,125)
  call UMD_SaveTints('npn5',125,125,125)
  call UMD_SaveTints('npn6',125,125,125)
  call UMD_SaveTints('h047',130,100,-1)
  call UMD_SaveTints('HC92',130,100,-1)
  call UMD_SaveTints('nfsh',130,-1,130)
  call UMD_SaveTints('nftb',130,-1,130)
  call UMD_SaveTints('EC57',150,200,-1)
  call UMD_SaveTints('h05E',150,150,100)
  call UMD_SaveTints('h05Y',150,0,150)
  call UMD_SaveTints('h07M',150,150,150)
  call UMD_SaveTints('h07N',150,150,150)
  call UMD_SaveTints('h07O',150,150,150)
  call UMD_SaveTints('h0B2',150,150,150)
  call UMD_SaveTints('h0B3',150,150,150)
  call UMD_SaveTints('h0B5',150,150,150)
  call UMD_SaveTints('n00L',150,100,-1)
  call UMD_SaveTints('n026',150,110,70)
  call UMD_SaveTints('n0LD',150,150,150)
  call UMD_SaveTints('ndr3',150,150,150)
  call UMD_SaveTints('njga',150,150,150)
  call UMD_SaveTints('nwlg',150,120,-1)
  call UMD_SaveTints('Oshd',150,0,150)
  call UMD_SaveTints('UC11',150,150,100)
  call UMD_SaveTints('UC60',150,150,150)
  call UMD_SaveTints('nfa1',155,155,-1)
  call UMD_SaveTints('nfa2',155,155,-1)
  call UMD_SaveTints('nfac',155,155,-1)
  call UMD_SaveTints('osw2',170,170,-1)
  call UMD_SaveTints('u012',170,170,-1)
  call UMD_SaveTints('u013',170,170,-1)
  call UMD_SaveTints('h05P',175,75,200)
  call UMD_SaveTints('u00O',175,175,-1)
  call UMD_SaveTints('UC91',175,75,200)
  call UMD_SaveTints('N01W',190,-1,-1)
  call UMD_SaveTints('h070',200,-1,-1)
  call UMD_SaveTints('n019',200,200,-1)
  call UMD_SaveTints('n01E',200,150,-1)
  call UMD_SaveTints('nanm',200,200,-1)
  call UMD_SaveTints('nbnb',200,200,-1)
  call UMD_SaveTints('ndr2',200,200,200)
  call UMD_SaveTints('nmrl',200,-1,200)
  call UMD_SaveTints('o006',200,125,50)
  call UMD_SaveTints('ndr1',230,230,230)
  call UMD_SaveTints('npfl',240,-1,240)
  call UMD_SaveTints('h066',250,150,150)
  call UMD_SaveTints('Hvsh',250,150,150)
  call UMD_SaveTints('h06J',-1,25,100)
  call UMD_SaveTints('h05H',-1,75,-1)
  call UMD_SaveTints('U008',-1,75,-1)
  call UMD_SaveTints('E015',-1,100,-1)
  call UMD_SaveTints('h00L',0,100,100)
  call UMD_SaveTints('H004',-1,120,120)
  call UMD_SaveTints('h049',-1,120,120)
  call UMD_SaveTints('n003',-1,120,180)
  call UMD_SaveTints('n09Z',-1,120,120)
  call UMD_SaveTints('nfpc',-1,120,150)
  call UMD_SaveTints('nsat',-1,120,-1)
  call UMD_SaveTints('nstl',-1,130,150)
  call UMD_SaveTints('nkot',-1,150,180)
  call UMD_SaveTints('nowe',-1,150,150)
  call UMD_SaveTints('nogm',-1,160,160)
  call UMD_SaveTints('o005',-1,170,170)
  call UMD_SaveTints('osw3',-1,170,170)
  call UMD_SaveTints('H00E',-1,200,200)
  call UMD_SaveTints('nbdk',-1,200,-1)
  call UMD_SaveTints('nbrg',-1,200,150)
  call UMD_SaveTints('nbwm',-1,200,200)
  call UMD_SaveTints('ndtw',-1,200,110)
  call UMD_SaveTints('nmrm',-1,200,200)
  call UMD_SaveTints('Ubal',-1,200,200)
  call UMD_SaveTints('nsth',-1,-1,140)
  call UMD_SaveTints('EC45',0,-1,150)
  call UMD_SaveTints('h05S',0,-1,150)
  call UMD_SaveTints('nggr',0,-1,155)
  call UMD_SaveTints('nkob',-1,-1,165)
  call UMD_SaveTints('ncen',-1,-1,170)
  call UMD_SaveTints('nowb',-1,-1,170)
  call UMD_SaveTints('H00F',-1,-1,200)
  call UMD_SaveTints('H00G',-1,-1,200)
  call UMD_SaveTints('n002',-1,-1,200)
  call UMD_SaveTints('n009',-1,-1,200)
  call UMD_SaveTints('n00V',-1,-1,200)
  call UMD_SaveTints('n00W',-1,-1,200)
  call UMD_SaveTints('n00X',-1,-1,200)
  call UMD_SaveTints('n0HE',-1,-1,200)
  call UMD_SaveTints('h094',-1,0,200)
  call UMD_SaveTints('n006',0,-1,-1)
  call UMD_SaveTints('n00A',0,-1,-1)
  call UMD_SaveTints('n00J',0,-1,-1)
  call UMD_SaveTints('E01P',-1,0,-1)
  call UMD_SaveTints('h08Z',-1,0,-1)
  call UMD_SaveTints('nfro',0,0,-1)
  call UMD_SaveTints('n00G',-1,-1,0)
  call UMD_SaveTints('n00H',-1,-1,0)
  call UMD_SaveTints('n00K',-1,-1,0)
  call UMD_SaveTints('E024',0,-1,0)
  call UMD_SaveTints('o00T',0,-1,0)
  call UMD_SaveTints('o00U',0,-1,0)
  call UMD_SaveTints('o00V',0,-1,0)
  call UMD_SaveTints('o00W',0,-1,0)
  call UMD_SaveTints('e01K',-1,0,0)
  call UMD_SaveTints('e01L',-1,0,0)
  call UMD_SaveTints('E021',-1,0,0)
  call UMD_SaveTints('u01M',-1,0,0)
  call UMD_SaveTints('u01O',-1,0,0)
  call UMD_SaveTints('H00F',255,255,200)//dk morphed
  call UMD_SaveTints('H00E',255,200,200)
  call UMD_SaveTints('H00G',255,200,200)
  call UMD_SaveTints('HC92',130,100,255)//riki
  call UMD_SaveTints('U008',255,75,255)//lycan
  call UMD_SaveTints('E015',255,100,255)//lycan wolf
  call UMD_SaveTints('NC00',100,125,100)//leoric
  call UMD_SaveTints('UC11',150,150,100)//magnus
  call UMD_SaveTints('Hvsh',250,150,150)//BS
  call UMD_SaveTints('Ubal',255,200,200)//weaver
  call UMD_SaveTints('Nfir',0,0,0)//sf
  call UMD_SaveTints('EC77',75,255,25)//viper
  call UMD_SaveTints('Oshd',150,0,150)//bane
  call UMD_SaveTints('UC18',50,100,255)//lion
  call UMD_SaveTints('UC60',150,150,150)//necrolic
  call UMD_SaveTints('UC91',175,75,200)//slardar
  call UMD_SaveTints('EC45',0,255,150)//void
  call UMD_SaveTints('U00C',100,100,100)//naix
  call UMD_SaveTints('EC57',150,200,255)//veno
endfunction

function SAU takes integer base, integer upg, integer upgid, integer visualid returns nothing
  set AghaBaseSpellID[AghaCounter]=base
  set AghaUpgradeID[AghaCounter]=upg
  set AghaUpgradedSpellID[AghaCounter]=upgid
  set AghaVisualId[AghaCounter]=visualid
  set AghaCounter=AghaCounter+1
endfunction

function StoreAghaUpgrades takes nothing returns nothing
  call SAU('A0O2','A28A','A289',0)//rex
  call SAU('A0DH','A1MZ','A1OB',0)//es
  call SAU('A0ER','A2S7','A2S8',0)//omni
  call SAU('A0MQ','A1BS','A1B6',0)//brewmaster
  call SAU('A0Z8','A1CW','A1CV',0)//clock
  call SAU('A0QR','A1BL','A1B3',0)//huskar
  call SAU('A0M1','A1BR','A1AX',0)//jugger
  call SAU('A29L','A448','A447',0)//Magnus
  call SAU('A0RP','A44A','A449',0)//lanaya
  
  call SAU('A054','A0UE','A00U',0)//luna
  call SAU('A1T5','A236','A235',0)//gyro
  call SAU('A0IN','A1BT','A1AW',0)//vs
  call SAU('A03R','A0U2','A0AV',0)//cm
  call SAU('A0S8','A1QR','A1QP',0)//puck
  call SAU('A0LT','A1CT','A1CS',0)//chen
  call SAU('A29G','A0U0','A29H',0)//zeus
  call SAU('A1W8','A0U8','A1W9',0)//furion
  call SAU('A0L3','A2QB','A2QC',0)//silencer
  call SAU('A01P','A0TO','A09Z',0)//lina
  call SAU('A12P','A1DC','A1D6',0)//wr
  call SAU('A0AK','A1G0','A1FY',0)//techies
  call SAU('A0O5','A1BN','A1B1',0)//thd
  call SAU('A00H','A0TY','A0A1',0)//rhasta
  call SAU('A04P','A1BV','A1AU',0)//sniper
  call SAU('A0LC','A444','A443',0)//ursa
  call SAU('A0E2','A1MS','A1MR',0)//axe
  call SAU('A0MU','A0UI','A0A2',0)//doom
  call SAU('A0NS','A1DE','A1DA',0)//abaddon
  call SAU('A0FL','A1D5','A1CX',0)//pudge
  call SAU('A0G4','A1DG','A1D8',0)//barathum
  call SAU('A06R','A1BM','A1B4',0)//sk
  call SAU('A013','A0UA','A0A6',0)//veno
  call SAU('A080','A1V0','A1UZ',0)//viper
  call SAU('A1AO','A1UW','A1UV',0)//razor
  call SAU('A0J1','A1DD','A1D7',0)//void
  call SAU('A02Q','A1DH','A1D9',0)//bane
  call SAU('A0QK','A21R','A21Q',0)//DS
  call SAU('A095','A0TQ','A09W',0)//lion
  call SAU('A05T','A0U4','A08H',0)//lich
  call SAU('A067','A0UC','A08P',0)//necrolyte
  call SAU('A0CC','A0TU','A02Z',0)//pugna
  call SAU('A0OK','A1VX','A1VW',0)//od
  call SAU('A28R','A0TW','A28S',0)//qop
  call SAU('S008','A1US','S00U',0)//wl
  call SAU('A10Q','A1DF','A1DB',0)//dazzle
  call SAU('A1NE','A2IH','A2IG',0)//visage
  call SAU('A21F','A0U6','A21G',0)//lesh
  call SAU('A0NT','A0UG','A0NX',0)//wd
  call SAU('A1MI','A2QF','A2QE',0)//AA
  call SAU('A2BG','A30I','A30H',0)//sky
  call SAU('A27H','A30K','A30J',0)//rubicks
  call SAU('A1BX','A30M','A30L',0)//enigma
  call SAU('A1U6','A30O','A30N',0)//disruptor
  call SAU('A343','A34K','A34J',0)//sd
  call SAU('A0CY',0,0,0)//tiny
  call SAU('A088',0,0,0)//ogre
  call SAU('A0DY','A1WC','A1WB',0)//ench
  call SAU('A0WP','A43E','A43D',0)//sven
  call SAU('A1RK','A43I','A43H',0)//phoenix
  call SAU('A1A1','A43K','A43J',0)//chieftain
  call SAU('A2E5','A43R','A43S',0)//shredder
  call SAU('A07Z','A44R','A44S',0)//treant
  call SAU('QM03',0,0,0)//zombi
endfunction

function CPD takes integer rid, integer sid, integer lid, integer bid, integer uid, integer hid, integer vid returns nothing
  set PassivesCount=PassivesCount+1
  set PassivesRealID[PassivesCount]=rid
  set PassivesSpellbookID[PassivesCount]=sid
  set PassivesLearningSkill[PassivesCount]=lid
  set PassivesBuffID[PassivesCount]=bid
  set PassivesUpgradeID[PassivesCount]=uid
  set PassivesLearningSkillUpg[PassivesCount]=hid
  set PassivesVisualID[PassivesCount]=vid
  call HideAbility(sid)
  call HideAbility(uid)
endfunction

function StoreAllPassives takes nothing returns nothing
  call CPD('ACac','Q003','P003','BOac','QU03','QP03','A31F')//command aura
  call CPD('P009','Q009','A0DW',0     ,'QU04','QP04',0     )//untouchable
  call CPD('AHab','Q019','P019','B07M','QU05','QP05',0     )//brilliance aura
  call CPD('P022','Q022','A01K',0     ,'QU06','QP06',0     )//cleave
  call CPD('P035','Q035','A0DZ',0     ,'QU07','QP07',0     )//backstab
  call CPD('A00J','Q036','A0MB',0     ,'QU08','QP08','A31G')//permanent invis
  call CPD('P047','Q047','A00K',0     ,'QU09','QP09','A31H')//blade dance
  call CPD(0     ,'Q067','P067',0     ,'QU0A','QP0A',0     )//fury swipes
  call CPD('P083','Q083','A0DB','B03B','QU0B','QP0B','A31I')//Juxtapose
  call CPD('P084','Q084','A0YK',0     ,'QU0C','QP0C',0     )//Phantom Edge
  call CPD('P098','Q098','A041',0     ,'QU0D','QP0D','A31K')//moon glaive
  call CPD('P099','Q099','A062','B01W','QU0E','QP0E',0     )//Lunar blessing
  call CPD('P102','Q102','A03S',0     ,'QU0F','QP0F',0     )//Headshot
  call CPD('P107','Q107','A0O0',0     ,'QU0G','QP0G',0     )//fervor
  call CPD('P119','Q119','A0MX',0     ,'QU0H','QP0H','A31M')//Drunken brawler
  call CPD('P123','Q123','A00V','B00M','QU0I','QP0I','A31N')//Return
  call CPD('P131','Q131','A0CL','B04D','QU0J','QP0J',0     )//Dragon Blood
  call CPD('P133','Q133','A022',0     ,'QU0K','QP0K','A31O')//Mana break
  call CPD('P135','Q135','A0KY',0     ,'QU0L','QP0L','A31P')//Spell Shield
  call CPD('P143','Q143','A06A','B01B','QU0M','QP0M','A31Q')//Degen Aura
  call CPD('P147','Q147','A0BD','B00E','QU0N','QP0N','A31R')//Inner Beast
  call CPD('P155','Q155','A0O3','B00X','QU0O','QP0O',0     )//Goblin's Greed
  call CPD('P211','Q211','A27V','B0EO','QU0P','QP0P',0     )//Null Field
  call CPD('P231','Q231','A03E','B096','QU0Q','QP0Q',0     )//Feral Impulse
  call CPD('P239','Q239','A03P',0     ,'QU0R','QP0R','A31S')//Blur
  call CPD('P240','Q240','A03Q',0     ,'QU0S','QP0S','A31T')//Coup de grace
  call CPD(0     ,0     ,'A086','B02L','QU0T','QP0T',0     )//Hunter in the Night
  call CPD('AUav','Q250','P250','BVA1','QU0U','QP0U','A31U')//Vampiric Aura
  call CPD('AOcr','Q251','A2S0',0     ,'QU0V','QP0W','A31V')//Mortal Strike
  call CPD('P263','Q263','A0JJ',0     ,'QU0W','QP0V','A31W')//Slardar Bash
  call CPD('P275','Q275','A081',0     ,'QU0X','QP0X','A31X')//Time Lock
  call CPD('P279','Q279','A0MM',0     ,'QU0Y','QP0Y',0     )//Backtrack
  call CPD('P283','Q283','A1E6','B03X','QU0Z','QP0Z',0     )//Unstable current
  call CPD('P294','Q294','A04E',0     ,'QU10','QP10',0     )//Kraken Shell
  call CPD('P302','Q302','A01N','B084','QU11','QP11',0     )//Heartstopper aura
  call CPD('P303','Q303','A060',0     ,'QU12','QP12',0     )//Sadist
  call CPD('P307','Q307','A06D',0     ,'QU13','QP13',0     )//Flesh Heap
  call CPD('P310','Q310','A0ES','B03Y','QU14','QP14','A31Y')//Empowering haste
  call CPD('P319','Q319','A0FU',0     ,'QU15','QP15','A31Z')//Present of the dark lord
  call CPD(0     ,0     ,'A0FA',0     ,'QU16','QP16','A320')//Caustic Finale
  call CPD('P327','Q327','A0C6','B03P','QU17','QP17','A321')//Counter Helix
  call CPD(0     ,0     ,'A0MG',0     ,'QU18','QP18',0     )//Frostmourne
  call CPD('P338','Q338','A0FX',0     ,'QU19','QP19','A322')//Desolate
  call CPD('P347','Q347','A0IF','B06X','QU1A','QP1A',0     )//Essense aura
  call CPD('P355','Q355','A0N7',0     ,'QU1B','QP1B',0     )//Geostrike
  call CPD('P363','Q363','AIcd',0     ,'QU1C','QP1C','A323')//Diffusion Aura
  call CPD('P418','Q418','A0MY',0     ,'QU1D','QP1D',0     )//Poison sting
  call CPD('P431','Q431','A03N',0     ,'QU1E','QP1E','A324')//Critical Strike
  call CPD(0     ,0     ,'A1HR',0     ,'QU1F','QP1F',0     )//essence shift
  call CPD(0     ,0     ,'A0DJ',0     ,'QU1G','QP1G',0     )//aftershock
  call CPD(0     ,0     ,'QF85',0     ,'QU1H','QP1H',0     )//aftershock balanced
  call CPD(0     ,0     ,'A1CD',0     ,'QU1I','QP1I',0     )//natural order
  call CPD(0     ,0     ,'A19Q',0     ,'QU1J','QP1J',0     )//craggy ext
  call CPD(0     ,0     ,'A0CY',0     ,'QU1K','QP1K',0     )//Grow!
  call CPD(0     ,0     ,'A0QQ',0     ,'QU1L','QP1L',0     )//Berserker blood
  call CPD(0     ,0     ,'A0M3',0     ,'QU1M','QP1M',0     )//Bristleback
  call CPD(0     ,0     ,'A0FV',0     ,'QU1N','QP1N',0     )//Warpath
  call CPD(0     ,0     ,'A2EY',0     ,'QU1O','QP1O',0     )//Moment of courage
  call CPD(0     ,0     ,'A2E4',0     ,'QU1P','QP1P',0     )//Reactive armor
  call CPD(0     ,0     ,'A03U',0     ,'QU1Q','QP1Q',0     )//Take aim
  call CPD(0     ,0     ,'A0RO',0     ,'QU1S','QP1S',0     )//Psi blades
  call CPD('A45E','A45F','A0N5',0     ,'QU1T','QP1T',0     )//Static field
  call CPD(0     ,0     ,'A18X',0     ,'QU1U','QP1U',0     )//Fiery Soul
  call CPD(0     ,0     ,'A0QW',0     ,'QU1V','QP1V',0     )//Overload
  call CPD(0     ,0     ,'A0SS',0     ,'QU1W','QP1W',0     )//Feast
  call CPD(0     ,0     ,'A0G5',0     ,'QU1X','QP1X',0     )//Greater Bash
  call CPD(0     ,0     ,'A0LE',0     ,'QU1Y','QP1Y',0     )//Bloodbath
  call CPD(0     ,0     ,'A0I8',0     ,'QU1Z','QP1Z',0     )//Strygwyr's thrist
  call CPD(0     ,0     ,'A0NA',0     ,'QU20','QP20',0     )//Dispersion
  call CPD(0     ,0     ,'A1A3',0     ,'QU21','QP21',0     )//Nethertoxin
  call CPD(0     ,0     ,'A0CZ',0     ,'QU22','QP22',0     )//Backtrack
  call CPD(0     ,0     ,'A0VX',0     ,'QU23','QP23',0     )//Gravekeeper's Cloak
  call CPD(0     ,0     ,'A088',0     ,'QU24','QP24',0     )//Multi cast
  call CPD('A33O','A33P','A33Q',0     ,'A33S','A33R',0     )//Last word passive
  call CPD('A09J','A23F','A417',0     ,0     ,0     ,0     )//Split shot
  call CPD('A43Z','A442','A440',0     ,'QU25','QP25',0     )//old marksmanship
  call CPD('A455','A45C','A45B',0     ,'QU26','QP26',0     )//fire show
  call CPD(0     ,0     ,'A460',0     ,'QU27','QP27',0     )//mortal wounds
  call CPD(0     ,0     ,'A34A',0     ,'QU28','QP28',0     )//cheat death
endfunction

function Illusions_PassivesWrapper takes unit Illusion, unit IllusionOriginal returns nothing
  local integer i=1
  local integer lvl
  loop
    set lvl=GetUnitAbilityLevel(IllusionOriginal,PassivesLearningSkill[i])+GetUnitAbilityLevel(IllusionOriginal,PassivesLearningSkillUpg[i])
    if PassivesRealID[i]=='P084' then
      set lvl=GetUnitAbilityLevel(IllusionOriginal,'A0DB')+GetUnitAbilityLevel(IllusionOriginal,'QP0B')//get juxtapose lvl for phantom edge
    endif
    if lvl==0 then
      if PassivesSpellbookID[i]>0 or PassivesRealID[i]>0 then
        call UnitRemoveAbility(Illusion,PassivesRealID[i])
        call UnitRemoveAbility(Illusion,PassivesSpellbookID[i])
        call UnitRemoveAbility(Illusion,PassivesBuffID[i])
      endif
    else
      if PassivesSpellbookID[i]>0 or PassivesRealID[i]>0 then
        call UnitMakeAbilityPermanent(Illusion,true,PassivesRealID[i])
        call UnitMakeAbilityPermanent(Illusion,true,PassivesSpellbookID[i])
        if PassivesVisualID[i]>0 then
          call UnitAddAbility2(Illusion,PassivesVisualID[i])
          call SetUnitAbilityLevel(Illusion,PassivesVisualID[i],lvl)
        endif
        call SetUnitAbilityLevel(Illusion,PassivesRealID[i],lvl)
        if PassivesSpellbookID[i]=='A23F' then//split shot
          call SetUnitAbilityLevel(Illusion,'A1ER',lvl)
          call UnitAddAbility2(Illusion,'A1ER')
          call SetUnitAbilityLevel(Illusion,'A1ER',lvl)
        endif
      endif
    endif
    set i=i+1
    exitwhen i>PassivesCount
  endloop
endfunction

function FixPassiveSkills_LevelIllusions takes nothing returns boolean
  local unit Illusion=GetSummonedUnit()
  local integer PlayerId=GetPlayerId(GetOwningPlayer(Illusion))
  local integer PassiveId
  local unit IllusionOriginal=LoadUnitHandle(HY,GetHandleId(GetSummoningUnit()),'0ILU')
  local integer MorphID1
  local integer MorphID2
  local integer UnitID
  local real hp
  local integer lvl
  if IsUnitIllusion(Illusion)==false or GetUnitTypeId(Illusion)<1 then
    set Illusion=null
    set IllusionOriginal=null
    return false
  endif
  if GetUnitAbilityLevel(Illusion,'B0EN')>0 then
    set PlayerId=TempInteger
  endif
  if IllusionOriginal!=null then
    set PlayerId=GetPlayerId(GetOwningPlayer(IllusionOriginal))
  else
    set IllusionOriginal=udg_Hero[PlayerId]
  endif
  call SaveUnitHandle(HY,GetHandleId(Illusion),'0ILU',IllusionOriginal)
  set UnitID=GetUnitTypeId(IllusionOriginal)
  if GetUnitTypeId(Illusion)==UnitID then
    call Illusions_PassivesWrapper(Illusion,IllusionOriginal)
  else
    set hp=GetUnitState(Illusion,UNIT_STATE_MAX_LIFE)
    call UnitMakeAbilityPermanent(Illusion,true,'A09J') //Split Shot fix
    set MorphID1=GetMorphId(GetUnitTypeId(Illusion))
    set MorphID2=GetMorphId(UnitID)
    call UnitAddAbility(Illusion,MorphID1)
    call UnitRemoveAbility(Illusion,MorphID1)
    call UnitAddAbility(Illusion,MorphID2+1)
    call UnitRemoveAbility(Illusion,MorphID2+1)
    call Illusions_PassivesWrapper(Illusion,IllusionOriginal)
    loop
      exitwhen GetUnitState(Illusion,UNIT_STATE_MAX_LIFE)<=hp
      call UnitAddAbility(Illusion,'Z999')
      call SetUnitAbilityLevel(Illusion,'Z999',2)
      call UnitRemoveAbility(Illusion,'Z999')
    endloop
  endif
  call BonusEffectWrapper(Illusion,IllusionOriginal)
  call SaveUnitHandle(TempHash,'ILLU',0,Illusion)
  call SaveUnitHandle(TempHash,'ILLU',1,IllusionOriginal)
  call ExeFunc("Trax_Marksmanship_Illusion")
  set Illusion=null
  set IllusionOriginal=null
  return false
endfunction

function FixPassiveSkills_ReincarnationFix takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,2)
  local integer ShouldHideSomeMore=LoadInteger(HY,h,100)
  if Hero==null then
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
    set Hero=null
    set t=null
    return false
  endif
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    if FindItemOfType(Hero,Item_Real[indexid_Aegis])!=null then
      call TriggerRegisterTimerEvent(t,5.01,false) //Aegis
      call FixVisionGlitchOnBuyBach(Hero)
    elseif GetUnitState(Hero,UNIT_STATE_MANA)>=160 and GetUnitAbilityLevel(Hero,'A01Y')>0 and ((TimerGetRemaining(PrimUltiTimer[GetPlayerId(GetOwningPlayer(Hero))])==0 and SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(Hero))*PlayerSkillOffset+4]]=='A01Y') or TimerGetRemaining(SecUltiTimer[GetPlayerId(GetOwningPlayer(Hero))])==0) then
      call TriggerRegisterTimerEvent(t,3.01,false) //Leoric Reincarnation
      call FixVisionGlitchOnBuyBach(Hero)
    endif
  else
    call RemoveAbilsForUnit(Hero)
  endif
  set Hero=null
  set t=null
  return false
endfunction

function FixPassiveSkills_FixHero takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local integer PlayerId=GetPlayerId(GetOwningPlayer(Hero))
  local trigger t
  local integer h
  if b_isPickTime or (IsUnitType(Hero,UNIT_TYPE_HERO)==false or GetUnitTypeId(Hero)=='H00M' or GetUnitTypeId(Hero)=='H00Y' or GetUnitTypeId(Hero)=='H07G' or GetUnitTypeId(Hero)=='H0B8') then
    set Hero=null
    return false
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterDeathEvent(t,Hero)
  call TriggerAddCondition(t,Condition(function FixPassiveSkills_ReincarnationFix))
  call SaveUnitHandle(HY,h,2,Hero)
  call SaveInteger(HY,h,100,2)
  set Hero=null
  set t=null
  return false
endfunction

function ExorcismGhost2 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local unit hero=LoadUnitHandle(HY,h,1)
  if IsDead(u)==false then
    if hero==null or IsUnitType(u,UNIT_TYPE_HERO) then
      if GetUnitCurrentOrder(u)==852558 then
        call SaveUnitHandle(HY,h,1,GetOrderTargetUnit())
      endif
    else
      if DistanceBetweenUnits(u,hero)>1500 then
        if GetUnitCurrentOrder(u)==852557 then
          call SetUnitPosition(u,GetUnitX(hero),GetUnitY(hero))
          call IssueImmediateOrderById(u,852557)
        elseif GetUnitCurrentOrder(u)==852558 then 
          call SetUnitPosition(u,GetUnitX(hero),GetUnitY(hero))
          call IssueTargetOrderById(u,852558,hero)
        endif
      endif
    endif
  else
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  endif
  set u=null
  set t=null
endfunction

function ExorcismGhost takes unit u returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.02,true,function ExorcismGhost2)
  call SaveUnitHandle(HY,h,0,u)
  call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(u))])
  set t=null
endfunction

function BonusHPAuraFilter takes nothing returns boolean
  return GetUnitAbilityLevel(GetFilterUnit(),'B0HL')>0 and IsUnitAlly(GetFilterUnit(),tt_player1) and AliveNonBuildOrMarker(GetFilterUnit())
endfunction

function BonusHPAuraTick takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group affected=LoadGroupHandle(HY,h,1)
  local unit u=LoadUnitHandle(HY,h,0)
  local unit u2
  local group g
  local group gg
  local integer bon
  local integer savedbon
  if IsDead(u) or u==null then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
    loop
      set u2=FirstOfGroup(affected)
      exitwhen u2==null
      call GroupRemoveUnit(affected,u2)
      call ManageBonusHP(u2, -1 * LoadInteger(MHT,GetHandleId(u2),'BHPA') )
      call SaveInteger(MHT,GetHandleId(u2),'BHPA',0)
      call UnitRemoveAbility(u2,'B0HL')
    endloop
    call KillGroup(affected)
  else
    set g=GetAvailableGroup()
    set tt_player1=GetOwningPlayer(u)
    call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),925,Condition(function BonusHPAuraFilter))
    set gg=GetAvailableGroup()
    call GroupAddGroup(affected,gg)
    loop
      set u2=FirstOfGroup(gg)
      exitwhen u2==null
      if IsUnitInGroup(u2,g)==false then
        call GroupRemoveUnit(affected,u2)
        call ManageBonusHP(u2, -1 * LoadInteger(MHT,GetHandleId(u2),'BHPA') )
        call SaveInteger(MHT,GetHandleId(u2),'BHPA',0)
        call UnitRemoveAbility(u2,'B0HL')
      endif
      call GroupRemoveUnit(gg,u2)
    endloop
    call KillGroup(gg)
    loop
      set u2=FirstOfGroup(g)
      exitwhen u2==null
      set savedbon=LoadInteger(MHT,GetHandleId(u2),'BHPA')
      set bon=R2I(R2I(GetUnitState(u2,UNIT_STATE_MAX_LIFE) - savedbon) * 0.15)
      if savedbon !=0 then
        if savedbon != bon then
          //call echo(GetUnitName(u2)+" have "+R2S(GetUnitState(u2,UNIT_STATE_MAX_LIFE))+" hp and get "+I2S(bon)+" (old = "+I2S(savedbon))
          call ManageBonusHP(u2, bon-savedbon)
        endif
      else
        //call echo(GetUnitName(u2)+" have "+R2S(GetUnitState(u2,UNIT_STATE_MAX_LIFE))+" hp and get "+I2S(bon)+" (old = "+I2S(savedbon))
        call ManageBonusHP(u2, bon)
      endif
      call SaveInteger(MHT,GetHandleId(u2),'BHPA',bon)
      call GroupRemoveUnit(g,u2)
      call GroupAddUnit(affected,u2)
    endloop
    call KillGroup(g)
  endif
  set t=null
  set affected=null
  set u=null
  set g=null
  set gg=null
endfunction

function BonusHPAura takes unit u returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.5,true,function BonusHPAuraTick)
  call SaveUnitHandle(HY,h,0,u)
  call SaveGroupHandle(HY,h,1,GetAvailableGroup())
  set t=null
endfunction

function Fix_EnteringHeroes takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit rHero=u
  local player p=GetOwningPlayer(u)
  local integer i=1
  local integer lvl=0
  local trigger t
  if GetUnitTypeId(u)=='u00G' then
    call ExorcismGhost(u)
  elseif GetOwningPlayer(u)==Neutrals or GetOwningPlayer(u)==Sentinels[0] or GetOwningPlayer(u)==Scourges[0] then
    if Mode_AH then
      call UnitAddAbility2(u,'A44F')
    endif
    if GetUnitAbilityLevel(u,'A44G')>0 then
      call BonusHPAura(u)
    endif
  endif
  if (IsUnitType(u,UNIT_TYPE_HERO)==false or GetUnitTypeId(u)=='H00M' or GetUnitTypeId(u)=='H00Y' or GetUnitTypeId(u)=='H07G' or GetUnitTypeId(u)=='H0B8') or b_isPickTime then
    if IsUnitIllusion(u)==false then
      set u=null
      set rHero=null
      return
    endif
  endif
  if IsUnitIllusion(u) then
    set rHero=udg_Hero[GetPlayerId(p)]
  else
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HERO_SKILL)
    call TriggerAddCondition(t,Condition(function GeneralLearnC))
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(t,Condition(function Wait0SecPlz))
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
  endif
  loop
    set lvl=GetUnitAbilityLevel(rHero,PassivesLearningSkill[i])+GetUnitAbilityLevel(rHero,PassivesLearningSkillUpg[i])
    if lvl==0 and PassivesSpellbookID[i]>0 then
      call UnitRemoveAbility(u,PassivesSpellbookID[i])
      call UnitRemoveAbility(u,PassivesBuffID[i])
    endif
    set i=i+1
    exitwhen i>PassivesCount
  endloop
  call BonusEffectWrapper(rHero,rHero)
  set u=null
  set rHero=null
  set t=null
endfunction

function FixPassiveSkills takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function FixPassiveSkills_FixHero))
  call TriggerAddCondition(t,Condition(function Fix_EnteringHeroes))
  
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function FixPassiveSkills_LevelIllusions))
  call ExeFunc("StoreAllPassives")
  
  set t=null
endfunction

function BLD takes string Y9D returns boolean
  if Y9D=="-ma"or Y9D=="-ms"or Y9D=="-cs"or Y9D=="-cson"or Y9D=="-disablehelp"or Y9D=="-enablehelp"or Y9D=="-unstuck"or Y9D=="-recreate"then
    return true
  elseif Y9D=="-swaphero"or Y9D=="-showmsg"or Y9D=="-hidemsg"or Y9D=="-showdeny"or Y9D=="-hidedeny"or Y9D=="-weather rain"or Y9D=="-weather snow"or Y9D=="-weather moonlight"or Y9D=="-weather wind"or Y9D=="-weather random"or Y9D=="-weather off"or Y9D=="-denyinfo"or Y9D=="-di"or Y9D=="-deathon"or Y9D=="-don"or Y9D=="-deathoff"or Y9D=="-doff"or Y9D=="-roll"or Y9D=="-hideheronames"or Y9D=="-hhn"or Y9D=="-test"or Y9D=="-mute"or Y9D=="-wtf"or Y9D=="-fleshstr"or Y9D=="-fs"or Y9D=="-switchon"then
    return true
  endif
  return false
endfunction

function B1D takes nothing returns boolean
  return not IsHeroesAvailable
endfunction

function B0D takes string B5D returns nothing
  if FullModesString==""then
    set FullModesString="|c006699CC"+B5D+"|r"
  else
    set FullModesString=FullModesString+"/|c006699CC"+B5D+"|r"
  endif
endfunction

function B2D takes string s returns nothing
  if FullModesString=="" then
    set FullModesString="|c00C83264"+s+"|r"
  else
    set FullModesString=FullModesString+"/|c00C83264"+s+"|r"
  endif
endfunction

function C4D takes string C7D,integer C8D,integer C9D returns string
  return SubString(C7D,0,C8D)+SubString(C7D,C9D,StringLength(C7D))
endfunction

function CDD takes string C7D returns string
  return StringCase(SubString(C7D,1,StringLength(C7D)),false)
endfunction

function CED takes string CFD,integer A5D returns nothing
  local string VHD=CDD(CFD)
  local string array CGD
  local string array CHDs
  local string array GameModeString
  local boolean array CIDs
  local integer lim
  local integer len=StringLength(VHD)
  local integer x=0
  local integer y=0
  local integer z=0
  local trigger t
  local boolean AP=false
  local boolean AR=false
  local boolean LM=false
  local boolean MM=false
  local boolean TR=false
  local boolean DM=false
  local boolean MR=false
  local boolean SP=false
  local boolean AA=false
  local boolean AI=false
  local boolean AS=false
  local boolean ID=false
  local boolean NP=false
  local boolean SC=false
  local boolean EM=false
  local boolean DU=false
  local boolean SH=false
  local boolean VR=false
  local boolean RV=false
  local boolean RD=false
  local boolean OM=false
  local boolean NT=false
  local boolean NB=false
  local boolean NM=false
  local boolean NS=false
  local boolean NR=false
  local boolean XL=false
  local boolean SD=false
  local boolean PM=false
  local boolean OI=false
  local boolean MI=false
  local boolean CM=false
  local boolean FR=false
  local boolean MO=false
  local boolean RO=false
  local boolean CD=false
  local boolean RS=false
  local boolean CP=false
  local boolean ZM=false
  local boolean UB=false
  local boolean UL=false
  local boolean SS=false
  local boolean AB=false
  local boolean S5=false
  local boolean S6=false
  local boolean FN=false
  local boolean D2=false
  local boolean D3=false
  local boolean D4=false
  local boolean D5=false
  local boolean OS=false
  local boolean BO=false
  local boolean MD=false
  local boolean RA=false
  local boolean LS=false
  local boolean LS3=false
  local boolean FF=false
  local boolean FUNHERO=false
  local boolean EBa=false
  local boolean MassAgh=false
  local boolean RC=false
  local boolean AH=false
  local boolean NN=false
  local boolean SO=false
  set ModeForTitle=VHD
  set CHDs[1]="ap"
  set CHDs[2]="ar"
  set CHDs[3]="dm"
  set CHDs[4]="sp"
  set CHDs[5]="aa"
  set CHDs[6]="ai"
  set CHDs[7]="as"
  set CHDs[8]="id"
  set CHDs[9]="np"
  set CHDs[10]="sc"
  set CHDs[11]="em"
  set CHDs[12]="du"
  set CHDs[13]="sh"
  set CHDs[14]="om"
  set CHDs[15]="nm"
  set CHDs[16]="nt"
  set CHDs[17]="nb"
  set CHDs[18]="ns"
  set CHDs[19]="nr"
  set CHDs[20]="sd"
  set CHDs[21]="pm"
  set CHDs[22]="oi"
  set CHDs[23]="mi"
  set CHDs[24]="fr"
  set CHDs[25]="mo"
  set CHDs[26]="ro"
  set CHDs[27]="zm"
  set CHDs[28]="ul"
  set CHDs[29]="ss"
  set CHDs[30]="ab"
  set CHDs[31]="s5"
  set CHDs[32]="s6"
  set CHDs[33]="fn"
  set CHDs[34]="d2"
  set CHDs[35]="d3"
  set CHDs[36]="d4"
  set CHDs[37]="d5"
  set CHDs[38]="os"
  set CHDs[39]="bo"
  set CHDs[40]="md"
  set CHDs[41]="ra"
  set CHDs[42]="3ls"
  set CHDs[43]="ls"
  set CHDs[44]="ff"
  set CHDs[45]="eb"
  set CHDs[46]="fh"
  set CHDs[47]="ma"
  set CHDs[48]="rc"
  set CHDs[49]="rd"
  set CHDs[50]="ah"
  set CHDs[51]="nn"
  set CHDs[52]="so"
  set lim=52
  
  set x=-1
  loop
    exitwhen x==len-1
    set x=x+1
    set y=x
    loop
      exitwhen y==len
      set y=y+1
      set z=1
      loop
        exitwhen z>lim
        if CHDs[z]==SubString(VHD,x,y)then
          set CIDs[z]=true
          set z=lim+1
          set VHD=C4D(VHD,x,y)
          set x=-1
          set len=StringLength(VHD)
          set y=len
        else
          set z=z+1
        endif
      endloop
    endloop
  endloop
  set AP=CIDs[1]
  set AR=CIDs[2]
  set DM=CIDs[3]
  set SP=CIDs[4]
  set AA=CIDs[5]
  set AI=CIDs[6]
  set AS=CIDs[7]
  set ID=CIDs[8]
  set NP=CIDs[9]
  set SC=CIDs[10]
  set EM=CIDs[11]
  set DU=CIDs[12]
  set SH=CIDs[13]
  set OM=CIDs[14]
  set NM=CIDs[15]
  set NT=CIDs[16]
  set NB=CIDs[17]
  set NS=CIDs[18]
  set NR=CIDs[19]
  set SD=CIDs[20]
  set PM=CIDs[21]
  set OI=CIDs[22]
  set MI=CIDs[23]
  set FR=CIDs[24]
  set MO=CIDs[25]
  set RO=CIDs[26]
  set ZM=CIDs[27]
  set UL=CIDs[28]
  set SS=CIDs[29]
  set AB=CIDs[30]
  set S5=CIDs[31]
  set S6=CIDs[32]
  set FN=CIDs[33]
  set D2=CIDs[34]
  set D3=CIDs[35]
  set D4=CIDs[36]
  set D5=CIDs[37]
  set OS=CIDs[38]
  set BO=CIDs[39]
  set MD=CIDs[40]
  set RA=CIDs[41]
  set LS3=CIDs[42]
  set LS=CIDs[43]
  set FF=CIDs[44]
  set EBa=CIDs[45]
  set FUNHERO=CIDs[46]
  set MassAgh=CIDs[47]
  set RC=CIDs[48]
  set RD=CIDs[49]
  set AH=CIDs[50]
  set NN=CIDs[51]
  set SO=CIDs[52]
  if VHD!=""or BLD(CFD)then
    return
  endif
  if LS3 and LS then
    call Error(PlayerModeTyper,GetObjectName('n02U'))
    return
  endif
  if(AR and(AP or SD or MD))then
    call Error(PlayerModeTyper,GetObjectName('n02U'))
    return
  endif
  if(AA and(AI or AS or DM))or(AS and(AI or DM))or(AI and DM)then
    call Error(PlayerModeTyper,GetObjectName('n02U'))
    return
  endif
  if(RO and(MO or DM))or(MO and DM)then
    call Error(PlayerModeTyper,GetObjectName('n02U'))
    return
  endif
  if(DM and(SH or SD or MD))or(SH and DM)then
    call Error(PlayerModeTyper,GetObjectName('n02T'))
    return
  endif
  if SD and(false or AP or false or AR or false or DM or false or AA or AI or AS or SH or false or RO or MO or MD)then
    call Error(PlayerModeTyper,GetObjectName('n02U'))
    return
  endif
  if S5 and S6 then
    call Error(PlayerModeTyper,"Modes <s5> and <s6> do not stack.")
    return
  endif
  if RA and not(S5 or S6)then
    call Error(PlayerModeTyper,"Mode <ra> only works with modes <s5> and <s6>.")
    return
  endif
  if RA and not(AP or SD or MD)then
    call Error(PlayerModeTyper,"Mode <ra> only works with modes <sd>, <ap> and <md>.")
    return
  endif
  if(D2 and(D3 or D4 or D5))or(D3 and(D2 or D4 or D5))or(D4 and(D2 or D3 or D5))or(D5 and(D2 or D3 or D4))then
    call Error(PlayerModeTyper,"Modes <d#> do not stack.")
    return
  endif
  if not(SD or MD or RD)and(D2 or D3 or D4 or D5)then
    call Error(PlayerModeTyper,"Modes <d#> only work with modes <sd>, <rd> and <md>.")
    return
  endif
  if not(AP or SD or MD)and SS then
    call Error(PlayerModeTyper,"Modes <ss> only work with modes <sd>, <ap> and <md>.")
    return
  endif
  if not(AP or SD or MD)and SP then
    call Error(PlayerModeTyper,"Mode -sp only work with modes <sd>, <ap> and <md>.")
    return
  endif
  if AP or AR or SD or MD or RD then
    call DisableTrigger(AR7)
  else
    return
  endif
  call UnTechAll()
  //	if FUNHERO then
  //		set b_isHeroPicked[117]=false
  //		set IsHeroIngame[117]=false
  //	else
  //		call TechHeroForAll(HeroID[117])
  //		set IsHeroIngame[117]=true
  //		set b_isHeroPicked[117]=true
  //	endif
  call Trig_display_leaderboard_Actions()
  call CreateObsBoard()
  set IsHeroesAvailable=true
  set QK=CDD(CFD)
  if AQ7 then
    call Traffic_RegisterData("Mode"+QK,0)
  else
    call Traffic_RegisterData("Mode"+QK,GetPlayerId(PlayerModeTyper))
  endif
  set Mode_Normal=false
  if DM then
    set MainModeInTxt=GetObjectName('n0II')
  elseif AP then
    set MainModeInTxt=GetObjectName('n0ID')
  elseif AR then
    set MainModeInTxt=GetObjectName('n0I7')
  elseif SD then
    set MainModeInTxt=GetObjectName('n0I4')
  elseif MD then
    set MainModeInTxt="Mirrordraft"
  elseif RD then
    set MainModeInTxt="Randomdraft"
  endif
  if MD then
    set Mode_MD=true
    call B2D("Mirror Draft")
  endif
  if RD then
    set Mode_RD=true
    if D2 then
      set Mode_RD_Count=Mode_RD_Count+4
    elseif D3 then
      set Mode_RD_Count=Mode_RD_Count+8
    elseif D4 then
      set Mode_RD_Count=Mode_RD_Count+12
    elseif D5 then
      set Mode_RD_Count=Mode_RD_Count+16
    endif
    call B0D("Random Draft")
  endif
  if DM then
    call B0D(GetObjectName('n0IA'))
  endif
  if AP then
    call B0D(GetObjectName('n0IL'))
  endif
  if AR then
    call B0D(GetObjectName('n0IQ'))
  endif
  if SP then
    call B0D(GetObjectName('n0IO'))
  endif
  if AA then
    call B0D(GetObjectName('n0IU'))
  endif
  if AS then
    call B0D(GetObjectName('n0IP'))
  endif
  if AI then
    call B0D(GetObjectName('n0IS'))
  endif
  if RO then
    call B0D(GetObjectName('n0IT'))
  endif
  if MO then
    call B0D(GetObjectName('n032'))
  endif
  if DU then
    call B0D(GetObjectName('n0IX'))
  endif
  if ID then
    call B0D(GetObjectName('n0IZ'))
  endif
  if NP then
    call B0D(GetObjectName('n0J6'))
  endif
  if SC then
    call B0D(GetObjectName('n0J7'))
  endif
  if EM then
    call B0D(GetObjectName('n0J9'))
  endif
  if SH then
    call B0D(GetObjectName('n0JA'))
  endif
  if OM then
    call B0D(GetObjectName('n0IV'))
  endif
  if NM then
    call B0D(GetObjectName('n0IR'))
  endif
  if NB then
    call B0D(GetObjectName('n0JB'))
  endif
  if NT then
    call B0D(GetObjectName('n0J8'))
  endif
  if NS then
    call B0D(GetObjectName('n0JC'))
  endif
  if NR then
    call B0D(GetObjectName('n0JF'))
  endif
  if SD then
    call B0D(GetObjectName('n0J0'))
    set Mode_SD=true
  endif
  if PM then
    call B0D(GetObjectName('n0IY'))
  endif
  if OI then
    call B0D(GetObjectName('n0J5'))
  endif
  if FR then
    call B0D(GetObjectName('n0JD'))
  endif
  if SO then
    call B0D(GetObjectName('n0J2'))
    set Mode_SO=true
  endif
  if ZM then
    call B0D(GetObjectName('n0KA'))
  endif
  if D2 then
    call B2D("Draft 20")
    set Mode_D2=true
    set i_BonusDraftAmount=10
  endif
  if D3 then
    call B2D("Draft 30")
    set Mode_D3=true
    set i_BonusDraftAmount=20
  endif
  if D4 then
    call B2D("Draft 40")
    set Mode_D4=true
    set i_BonusDraftAmount=30
  endif
  if D5 then
    call B2D("Draft 50")
    set Mode_D5=true
    set i_BonusDraftAmount=40
  endif
  if EBa then
    call B2D("Extended Balance")
    set Mode_EB=true
  endif
  if S5 then
    call B2D("Five Skills")
    set NumberOfExtraAbilities=1
    set Mode_S5=true
    call UnitAddAbility(ScourgeFountain,'ACrk')
    call UnitAddAbility(SentFountain,'ACrk')
    call UnitAddAbility(ScourgeFountain,'A1BY')
    call UnitAddAbility(SentFountain,'A1BY')
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: FIFTH SKILL IS ADDED AT LEVEL: <5>, <8>, <11>, <14>"+"|r")
  endif
  if S6 then
    call B2D("Six Skills")
    set NumberOfExtraAbilities=2
    call Trig_display_leaderboard_Actions()
    set Mode_S6=true
    call UnitAddAbility(ScourgeFountain,'ACrk')
    call UnitAddAbility(SentFountain,'ACrk')
    call UnitAddAbility(ScourgeFountain,'A1BY')
    call UnitAddAbility(SentFountain,'A1BY')
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: FIFTH SKILL IS ADDED AT LEVEL: <5>, <8>, <11>, <14>"+"|r")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c0066FF66"+"ATTENTION: SIXTH SKILL IS ADDED AT LEVEL: <8>, <13>, <18>"+"|r")
    call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30," ")
    if Mode_BO==false and Mode_MA==false then
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c00FF0000"+"WARNING: AGHANIM'S SCEPTER ONLY WORKS WITH YOUR FIRST ULT (4>6)"+"|r")
    else
      call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,30,"|c00FF0000"+"Note: Aghanim's Scepter upgrade both ultimates you have"+"|r")
    endif
  endif
  if FF then
    call B2D("Fast Finish")
    set Mode_FF=true
  endif
  if AH then
    set Mode_AH=true
    call B2D("Anti Hack")
  endif
  if OS then
    call B2D("One Skill")
    set Mode_OS=true
  endif
  if RA then
    call B2D("Random Extra Abilities")
    set Mode_RA=true
  endif
  if BO then
    call B2D("Balance Off")
    set Mode_BO=true
  endif
  
  if NN then
    call B2D("No Neutrals")
    set Mode_NN=true
  endif
  if UL then
    call B2D("Unlimited Level")
    set MaximumLevel=2048
    set Mode_UL=true
  endif
  if SS then
    call B2D("See Skills")
    set Mode_SS=true
  endif
  if AB then
    call B2D("Anti Backdoor")
    set Mode_AB=true
  endif
  if FN then
    call B2D("Fast Neutrals")
    set Mode_FN=true
  endif
  if LS then
    call B2D("Limit Skills")
    set Mode_LS=true
  endif
  if FUNHERO then
    call B0D("Fun heroes")
  endif
  if MassAgh then
    call B2D("Mass Aghanims")
    set Mode_MA=true
  endif
  if LS3 then
    call B2D("Limit Skills (3)")
    set Mode_LS=true
    set Mode_LS3=true
  endif
  if RC then
    call B2D("Rearm combos")
    set Mode_RC=true
  endif
  if LS or LS3 then
    call BanStunsFomComboing()
  endif
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.," ")
  if A5D==1 then
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,udg_Colors[GetPlayerId(PlayerModeTyper)]+(PlayerNames[GetPlayerId((PlayerModeTyper))])+"|r"+" has selected "+FullModesString)
  else
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,"Game mode automatically set to "+FullModesString)
  endif
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.,"For more information about the game modes use -gameinfo.")
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,20.," ")
  call ExecuteFunc("SZ8")
  call RunIfTrue("CZD",SP)
  call RunIfTrue("CCD",DM)
  call RunIfTrue("C6D",SH)
  call RunIfTrue("CLD",AA)
  call RunIfTrue("C1D",AI)
  call RunIfTrue("C0D",AS)
  call RunIfTrue("C5D",RO)
  call RunIfTrue("C2D",MO)
  call RunIfTrue("L4D",DU)
  call RunIfTrue("L7D",AR)
  call RunIfTrue("L9D",AP)
  call RunIfTrue("LMD",ID)
  call RunIfTrue("LND",NP)
  call RunIfTrue("InitSuperCreepsMode",SC)
  call RunIfTrue("LPD",EM)
  call RunIfTrue("LQD",OM)
  call RunIfTrue("LRD",NB)
  call RunIfTrue("LSD",NT)
  call RunIfTrue("LTD",NM)
  call RunIfTrue("LVD",NS)
  call RunIfTrue("LWD",NR)
  call RunIfTrue("LXD",PM)
  call RunIfTrue("LYD",OI)
  call RunIfTrue("LAD",FR)
  call RunIfTrue("L3D",ZM)
  call RunIfTrue("AntihackInit",AH)
  call ExeFunc("FixPassiveSkills")
  call ExeFunc("StoreAghaUpgrades")
  call ExeFunc("B6D")
  set ModePickedBool=true
  call SetTime(0,0,false)
  call ModePicked()
  set t=null
endfunction

function LLD takes nothing returns nothing
  call CED(GetEventPlayerChatString(),1)
endfunction

function L1D takes nothing returns boolean
  set IsRGC=udg_ObserverMode and (GetPlayerName(udg_Observer1)=="|cFFFF0000RGC" or GetPlayerName(udg_Observer2)=="|cFFFF0000RGC")
  if HCLstring=="rgc" then
    set HCLstring="sdzm3lsebfhso"
  elseif HCLstring=="rgc2" then
    set HCLstring="sds5ebzmfh3lsso"
  elseif HCLstring=="rgc3" then
    set HCLstring="sdd2s6osebfhso"
  elseif HCLstring=="rgc4" then
    set HCLstring="md3lsebzmfhso"
  elseif HCLstring=="rgc5" then
    set HCLstring="mdd2s5ebzmulosfh3lsso"
  elseif HCLstring=="rgc6" then
    set HCLstring="mdd2s6ebzmulosfhso"
  elseif HCLstring=="rgc7" then
    set HCLstring="rdd2s6ebzmso"
  elseif HCLstring=="rgc8" then
    set HCLstring="rdd2lsebzmso"
  elseif HCLstring=="md" then
    set HCLstring="mds6d5ulabosfnzmso"
  elseif HCLstring=="sd" then
    set HCLstring="sds6d5ulabosfnzmebso"
  elseif HCLstring=="ap" then
    set HCLstring="aps6ulabosfnzmso"
  elseif HCLstring=="ar" then
    set HCLstring="ardms6omfrulabzmso"
  elseif HCLstring=="ru0" then
    set HCLstring="mdabduffso"
  elseif HCLstring=="ru1" then
    set HCLstring="mdulabfnduebffso"
  elseif HCLstring=="ru2" then
    set HCLstring="mds6ulabfnduebffso"
  elseif HCLstring=="ru3" then
    set HCLstring="mds6ulabfnduebffmaso"
  elseif HCLstring=="ru4" then
    set HCLstring="mdd2s6ulabfnduebffmaso"
  elseif HCLstring=="ru5" then
    set HCLstring="mdd2s6ulabfnduboffso"
  elseif HCLstring=="ru6" then
    set HCLstring="sds6ulabfnduebffmaso"
  elseif HCLstring=="ru7" then
    set HCLstring="sdd2s6ulabfnduebffmaso"
  elseif HCLstring=="ru8" then
    set HCLstring="sdd2s6ulabfnduboffso"
  elseif HCLstring=="ru9" then
    set HCLstring="sdd5s6ulabfnduboffso"
  elseif HCLstring=="ru10" then
    set HCLstring="ardms6ulabfndubofrscffso"
  elseif HCLstring=="ru11" then
    set HCLstring="ardms6ulabfndubofrnpomffso"
  elseif HCLstring=="ru12" then
    set HCLstring="ardms6ulfndubofrscffnpntnmnbso"
  elseif HCLstring=="igl" then
    set HCLstring="sds6d2ulabosfnzmso"
  elseif HCLstring=="igl1" then
    set HCLstring="sds6d3ulabosfnzmso"
  elseif HCLstring=="i1" then
    set HCLstring="mds6omnpd2abnnso"
  elseif HCLstring=="i2" then
    set HCLstring="sds6omnpd2abnnso"
  elseif HCLstring=="i3" then
    set HCLstring="sds6omnpd3abebnnso"
  elseif HCLstring=="ohs1" then
    set HCLstring="sds6fnulboabd3rcahso"
  elseif HCLstring=="ohs2" then
    set HCLstring="ardms6fnulboabrcahso"
  elseif HCLstring=="ohs3" then
    set HCLstring="aps6fnulboabssoslsrcahso"
  elseif HCLstring=="ohs4" then
    set HCLstring="sdd5s6ulabbofnfrrcahso"
  elseif HCLstring=="ohs5" then
    set HCLstring="mds6d2omfnulborcahso"
  elseif HCLstring=="o1" then
    set HCLstring="ardms6boomfnulso"
  elseif HCLstring=="o2" then
    set HCLstring="mds6d3scfnulbonmso"
  endif
  if(HCLstring)!=""and ModePickedBool==false then
    set AQ7=true
    call CED("-"+(HCLstring),2)
  else
    call TriggerRegisterPlayerChatEvent(AR7,PlayerModeTyper,"-",false)
  endif
  return false
endfunction

function L9D takes nothing returns nothing
  local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
  local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
  local integer x=1
  local trigger t
  local integer h
  set Mode_AP=true
  set CreepSpawnTime=120
  loop
    exitwhen x>5
    if IsPlayer(Sentinels[x])then
      call PlacePickDummies(Sentinels[x])
    endif
    if IsPlayer(Scourges[x])then
      call PlacePickDummies(Scourges[x])
    endif
    set x=x+1
  endloop
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  set SpawnSent=null
  set SpawnScourge=null
  set t=null
endfunction

function GIE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer B78=(LoadInteger(HY,h,(55)))
  local player p
  local integer VA8
  local location SpawnSent=GetRectCenter(gg_rct_Hero_Creation_NE)
  local location SpawnScourge=GetRectCenter(gg_rct_Hero_Creation_UD)
  if B78<6 then
    set p=Sentinels[B78]
  elseif B78<11 then
    set p=Scourges[B78-5]
  endif
  if B78>10 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if Mode_DM==false then
      set RepickAllowed=true
    endif
  elseif B78<6 then
    call SaveInteger(HY,h,(55),(B78+1))
    set udg_Hero[GetPlayerId(p)]=null
    set HeroTypeId[GetPlayerId(p)]=0
    if IsPlayer(p)then
      loop
        exitwhen udg_Hero[GetPlayerId(p)]!=null
        set VA8=GetSetElement()
        if IsHeroIngame[VA8]==false then
          if not Mode_DU then
            set b_isHeroPicked[VA8]=true
            set IsHeroIngame[VA8]=true
          endif
          set udg_Hero[GetPlayerId(p)]=CreateUnitAtLoc(p,HeroID[VA8],SpawnSent,bj_UNIT_FACING)
          set HeroTypeId[GetPlayerId(p)]=HeroID[VA8]
        endif
      endloop
    endif
  elseif B78<11 then
    call SaveInteger(HY,h,(55),(B78+1))
    set udg_Hero[GetPlayerId(p)]=null
    set HeroTypeId[GetPlayerId(p)]=0
    if IsPlayer(p)then
      loop
        exitwhen udg_Hero[GetPlayerId(p)]!=null
        set VA8=GetSetElement()
        if IsHeroIngame[VA8]==false then
          if not Mode_DU then
            set b_isHeroPicked[VA8]=true
            set IsHeroIngame[VA8]=true
          endif
          set udg_Hero[GetPlayerId(p)]=CreateUnitAtLoc(p,HeroID[VA8],SpawnScourge,bj_UNIT_FACING)
          set HeroTypeId[GetPlayerId(p)]=HeroID[VA8]
        endif
      endloop
    endif
  endif
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  set SpawnSent=null
  set SpawnScourge=null
  set p=null
  set t=null
  return false
endfunction

function L7D takes nothing returns nothing
  local location SpawnSent=GetRectCenter(gg_rct_Hero_Creation_NE)
  local location SpawnScourge=GetRectCenter(gg_rct_Hero_Creation_UD)
  local location GJE=GetRectCenter(gg_rct_Hero_Creation_NE)
  local location GKE=GetRectCenter(gg_rct_Hero_Creation_UD)
  local integer VT8=1
  local integer VU8=5
  local integer VA8
  local trigger t
  set Mode_AR=true
  set RandomAllowed=false
  if not Mode_DU then
    call TechAll()
  endif
  set MinGoldForRepick=250
  call PanCameraToTimedLocForPlayer(Sentinels[1],GJE,0)
  call PanCameraToTimedLocForPlayer(Sentinels[2],GJE,0)
  call PanCameraToTimedLocForPlayer(Sentinels[3],GJE,0)
  call PanCameraToTimedLocForPlayer(Sentinels[4],GJE,0)
  call PanCameraToTimedLocForPlayer(Sentinels[5],GJE,0)
  call PanCameraToTimedLocForPlayer(Scourges[1],GKE,0)
  call PanCameraToTimedLocForPlayer(Scourges[2],GKE,0)
  call PanCameraToTimedLocForPlayer(Scourges[3],GKE,0)
  call PanCameraToTimedLocForPlayer(Scourges[4],GKE,0)
  call PanCameraToTimedLocForPlayer(Scourges[5],GKE,0)
  if Mode_SH then
    loop
      set VA8=GetSetElement()
      exitwhen IsHeroIngame[VA8]==false
    endloop
    if IsSentinel(PlayerModeTyper)then
      set udg_Hero[GetPlayerId(PlayerModeTyper)]=CreateUnit(PlayerModeTyper,HeroID[VA8],GetLocationX(SpawnSent),GetLocationY(SpawnSent),270)
      set HeroTypeId[GetPlayerId(PlayerModeTyper)]=HeroID[VA8]
    else
      set udg_Hero[GetPlayerId(PlayerModeTyper)]=CreateUnit(PlayerModeTyper,HeroID[VA8],GetLocationX(SpawnScourge),GetLocationY(SpawnScourge),270)
      set HeroTypeId[GetPlayerId(PlayerModeTyper)]=HeroID[VA8]
    endif
    call RemoveLocation(SpawnSent)
    call RemoveLocation(SpawnScourge)
    call RemoveLocation(GJE)
    call RemoveLocation(GKE)
    set SpawnSent=null
    set SpawnScourge=null
    set GJE=null
    set GKE=null
    set t=null
    return
  endif
  set RepickAllowed=false
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function GIE))
  call SaveInteger(HY,(GetHandleId(t)),(55),(1))
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  call RemoveLocation(GJE)
  call RemoveLocation(GKE)
  set SpawnSent=null
  set SpawnScourge=null
  set GJE=null
  set GKE=null
  set t=null
endfunction

function HXE takes nothing returns nothing
  set Mode_NoDeath=true
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n06K')+" "+GetObjectName('n06L'))
  call DisableTrigger(GetTriggeringTrigger())
endfunction

function HYE takes nothing returns nothing
  local integer HZE=S2I(SubString(GetEventPlayerChatString(),6,StringLength(GetEventPlayerChatString())))
  if HZE>666 then
    call Error(PlayerModeTyper,GetObjectName('n03C'))
  elseif HZE<10 then
    call Error(PlayerModeTyper,GetObjectName('n02I'))
  else
    set DL=HZE
    call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n06X')+" "+I2S(DL)+" "+GetObjectName('n06N'))
    call DisableTrigger(GetTriggeringTrigger())
  endif
endfunction

function HAE takes nothing returns nothing
  call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),(170))))
  call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),(171))))
  call DisableTrigger(GetTriggeringTrigger())
endfunction

function HBE takes nothing returns nothing
  local trigger HCE=CreateTrigger()
  local trigger H3E=CreateTrigger()
  local trigger nd=CreateTrigger()
  set DL=66
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.," ")
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,GetObjectName('n06O')+" -nd "+GetObjectName('n067')+" -lives xx "+GetObjectName('n06Q'))
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,GetObjectName('n060')+" "+I2S(DL))
  call TriggerRegisterTimerEvent(HCE,15,false)
  call TriggerAddAction(HCE,function HAE)
  call SaveTriggerHandle(HY,(GetHandleId(HCE)),(170),(nd))
  call SaveTriggerHandle(HY,(GetHandleId(HCE)),(171),(H3E))
  call TriggerRegisterPlayerChatEvent(nd,PlayerModeTyper,"-nd",true)
  call TriggerAddAction(nd,function HXE)
  call TriggerRegisterPlayerChatEvent(H3E,PlayerModeTyper,"-lives",false)
  call TriggerAddAction(H3E,function HYE)
  set HCE=null
  set H3E=null
  set nd=null
endfunction

function H6E takes nothing returns nothing
  local integer HLE=(LoadInteger(HY,(GetHandleId(GetTriggeringTrigger())),(173)))
  local integer VT8
  local integer VU8
  local integer VA8
  local integer B78
  local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
  local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
  if GameEnded then
    return
  endif
  if IsSentinel(Player(HLE))then
    set VT8=FirstSentinelHeroIndexid
    set VU8=LastSentinelHeroIndexid
    set B78=0
  else
    set VT8=FirstScourgeHeroIndexid
    set VU8=LastScourgeHeroIndexid
    set B78=1
  endif
  set VT8=FirstSentinelHeroIndexid
  set VU8=LastScourgeHeroIndexid
  call PlacePickDummies(Player(HLE))
  set tt_int1=HLE
  if not Mode_AR then
    loop
      exitwhen VT8>VU8
      if IsHeroIngame[VT8]==false then
        call SetPlayerTechMaxAllowed(Player(HLE),HeroID[VT8],999)
      endif
      set VT8=VT8+1
    endloop
    if(GetPlayerState(Player(HLE),PLAYER_STATE_RESOURCE_GOLD)<250)then
      call SetPlayerState(Player(HLE),PLAYER_STATE_RESOURCE_GOLD,250)
    endif
  elseif(DM_LivesUsed[B78]<DL)then
    if udg_Hero[HLE]!=null then
      call RemoveUnit(udg_Hero[HLE])
    endif
    set udg_Hero[HLE]=null
    set HeroTypeId[HLE]=0
    if IsPlayer(Player(HLE))then
      loop
        if IsSentinel(Player(HLE))then
          set udg_Hero[HLE]=CreateUnitAtLoc(Player(HLE),QC8(),SpawnSent,bj_UNIT_FACING)
          set HeroTypeId[HLE]=GetUnitTypeId(udg_Hero[HLE])
        else
          set udg_Hero[HLE]=CreateUnitAtLoc(Player(HLE),QC8(),SpawnScourge,bj_UNIT_FACING)
          set HeroTypeId[HLE]=GetUnitTypeId(udg_Hero[HLE])
        endif
        exitwhen udg_Hero[HLE]!=null
      endloop
    endif
  endif
  call TimerStart(PrimUltiTimer[HLE],0,false,null)
  call TimerStart(SecUltiTimer[HLE],0,false,null)
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  if not Mode_AR then
  endif
  set SpawnSent=null
  set SpawnScourge=null
endfunction

function CCD takes nothing returns nothing
  local location YT9
  local real H1E
  local trigger t
  local integer H0E
  local integer x
  set Mode_DM=true
  set x=1
  loop
    exitwhen x>5
    set H0E=GetPlayerId(Sentinels[x])
    set t=CreateTrigger()
    call TriggerRegisterTimerExpireEvent(t,HeroRespawnTimer[H0E])
    call TriggerAddAction(t,function H6E)
    call SaveInteger(HY,(GetHandleId(t)),(173),(H0E))
    set H0E=GetPlayerId(Scourges[x])
    set t=CreateTrigger()
    call TriggerRegisterTimerExpireEvent(t,HeroRespawnTimer[H0E])
    call TriggerAddAction(t,function H6E)
    call SaveInteger(HY,(GetHandleId(t)),(173),(H0E))
    set x=x+1
  endloop
  call UnitRemoveAbility(CirclesOfPower_1,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_2,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_3,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_4,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_5,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_7,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_8,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_9,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_10,'Aawa')
  call UnitRemoveAbility(CirclesOfPower_11,'Aawa')
  call ExeFunc("HBE")
  call RemoveLocation(YT9)
  set YT9=null
  set t=null
endfunction

function L4D takes nothing returns nothing
  set Mode_DU=true
  call TechHeroForAll('H00I')
endfunction

function CZD takes nothing returns nothing
  local integer elfs=CountPlayersInForce(Force_Elfs)
  local integer unds=CountPlayersInForce(Force_Unds)
  local integer total=elfs+unds
  local integer k
  local integer o
  local integer x
  local integer y
  local integer z
  local player array players1
  local player array players2
  local integer w
  local location GJE=GetRectCenter(gg_rct_Hero_Creation_NE)
  local location GKE=GetRectCenter(gg_rct_Hero_Creation_UD)
  local location SpawnSent=GetRectCenter(gg_rct_Allpick_Sent)
  local location SpawnScourge=GetRectCenter(gg_rct_Allpick_Scourge)
  local integer i
  set Mode_SP=true
  call VG9(Sentinels[1])
  call VG9(Sentinels[2])
  call VG9(Sentinels[3])
  call VG9(Sentinels[4])
  call VG9(Sentinels[5])
  call VG9(Scourges[1])
  call VG9(Scourges[2])
  call VG9(Scourges[3])
  call VG9(Scourges[4])
  call VG9(Scourges[5])
  set x=1
  loop
    exitwhen x>5
    if IsPlayer(Sentinels[x])then
      call PlacePickDummies(Sentinels[x])
    endif
    if IsPlayer(Scourges[x])then
      call PlacePickDummies(Scourges[x])
    endif
    set x=x+1
  endloop
  call RemoveLocation(SpawnSent)
  call RemoveLocation(SpawnScourge)
  set players1[1]=null
  set players1[2]=null
  set players1[3]=null
  set players1[4]=null
  set players1[5]=null
  set players1[6]=null
  set players1[7]=null
  set players1[8]=null
  set players1[9]=null
  set players1[10]=null
  set z=1
  set w=1
  set k=1
  loop
    exitwhen k>5
    if(IsPlayer(Sentinels[k]))then
      set players1[w]=Sentinels[k]
      set w=w+1
    else
      set players2[z]=Sentinels[k]
      set z=z+1
    endif
    set k=k+1
  endloop
  set k=1
  loop
    exitwhen k>5
    if(IsPlayer(Scourges[k]))then
      set players1[w]=Scourges[k]
      set w=w+1
    else
      set players2[z]=Scourges[k]
      set z=z+1
    endif
    set k=k+1
  endloop
  set Sentinels[1]=null
  set Sentinels[2]=null
  set Sentinels[3]=null
  set Sentinels[4]=null
  set Sentinels[5]=null
  set Scourges[1]=null
  set Scourges[2]=null
  set Scourges[3]=null
  set Scourges[4]=null
  set Scourges[5]=null
  set k=1
  loop
    exitwhen k>(total/ 2)
    set o=GetRandomInt(1,total)
    if(players1[o]!=null)then
      set Sentinels[k]=players1[o]
      set players1[o]=null
      set k=k+1
    endif
  endloop
  set x=k
  set k=1
  loop
    exitwhen k>total-x+1
    set o=GetRandomInt(1,total)
    if(players1[o]!=null)then
      set Scourges[k]=players1[o]
      set players1[o]=null
      set k=k+1
    endif
  endloop
  set z=k
  set k=x
  set y=1
  loop
    exitwhen k>5
    set Sentinels[k]=players2[y]
    set y=y+1
    set k=k+1
  endloop
  set k=z
  loop
    exitwhen k>5
    set Scourges[k]=players2[y]
    set y=y+1
    set k=k+1
  endloop
  set k=0
  loop
    exitwhen k>5
    set k=k+1
  endloop
  call SetPlayerTeam(Sentinels[0],0)
  call SetPlayerTeam(Sentinels[1],0)
  call SetPlayerTeam(Sentinels[2],0)
  call SetPlayerTeam(Sentinels[3],0)
  call SetPlayerTeam(Sentinels[4],0)
  call SetPlayerTeam(Sentinels[5],0)
  call SetPlayerTeam(Scourges[0],1)
  call SetPlayerTeam(Scourges[1],1)
  call SetPlayerTeam(Scourges[2],1)
  call SetPlayerTeam(Scourges[3],1)
  call SetPlayerTeam(Scourges[4],1)
  call SetPlayerTeam(Scourges[5],1)
  set i=1
  loop
    set PlayersId[i]=GetPlayerId(Sentinels[i])
    set i=i+1
    exitwhen i>5
  endloop
  set i=7
  loop
    set PlayersId[i]=GetPlayerId(Scourges[i-6])
    set i=i+1
    exitwhen i>11
  endloop
  call HK9()
  set x=0
  set y=0
  loop
    exitwhen x>5
    loop
      exitwhen y>5
      call SetPlayerAllianceStateBJ(Sentinels[x],Sentinels[y],3)
      call SetPlayerAllianceStateBJ(Scourges[x],Scourges[y],3)
      call SetPlayerAllianceStateBJ(Sentinels[x],Scourges[y],0)
      call SetPlayerAllianceStateBJ(Scourges[x],Sentinels[y],0)
      set y=y+1
    endloop
    set y=0
    set x=x+1
  endloop
  call ForceClear(Force_Elfs)
  call ForceClear(Force_Unds)
  call ForceAddPlayer(Force_Elfs,Sentinels[0])
  call ForceAddPlayer(Force_Elfs,Sentinels[1])
  call ForceAddPlayer(Force_Elfs,Sentinels[2])
  call ForceAddPlayer(Force_Elfs,Sentinels[3])
  call ForceAddPlayer(Force_Elfs,Sentinels[4])
  call ForceAddPlayer(Force_Elfs,Sentinels[5])
  call ForceAddPlayer(Force_Unds,Scourges[0])
  call ForceAddPlayer(Force_Unds,Scourges[1])
  call ForceAddPlayer(Force_Unds,Scourges[2])
  call ForceAddPlayer(Force_Unds,Scourges[3])
  call ForceAddPlayer(Force_Unds,Scourges[4])
  call ForceAddPlayer(Force_Unds,Scourges[5])
  call ExeFunc("HM9")
  call Trig_display_leaderboard_Actions()
  set elfs=CountPlayersInForce(Force_Elfs)
  set unds=CountPlayersInForce(Force_Unds)
  set k=1
  loop
    exitwhen k>5
    if(IsPlayer(Sentinels[k]))then
      call SetPlayerStateBJ(Sentinels[k],PLAYER_STATE_RESOURCE_GOLD,(4375/ elfs))
      call SetPlayerStateBJ(Sentinels[k],PLAYER_STATE_RESOURCE_LUMBER,0)
    endif
    if(IsPlayer(Scourges[k]))then
      call SetPlayerStateBJ(Scourges[k],PLAYER_STATE_RESOURCE_GOLD,(4375/ unds))
      call SetPlayerStateBJ(Scourges[k],PLAYER_STATE_RESOURCE_LUMBER,0)
    endif
    set k=k+1
  endloop
  if udg_ObserverMode then
    set x=0
    loop
      exitwhen x>5
      call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(0),true)
      call SetPlayerAlliance(Player(0),Sentinels[x],ConvertAllianceType(4),true)
      call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(0),false)
      call SetPlayerAlliance(Player(0),Scourges[x],ConvertAllianceType(4),false)
      set x=x+1
    endloop
  endif
  call StorePlayersColorValues()
  call RemoveLocation(GJE)
  call RemoveLocation(GKE)
  set GJE=null
  set GKE=null
  set SpawnSent=null
  set SpawnScourge=null
endfunction

function CLD takes nothing returns nothing
  local integer i
  local integer k
  set Mode_AA=true
  set i=1
  set k=IntHeroesAmount
  loop
    exitwhen i>k
    call TechHeroForAll(IntHeroesArray[i])
    set b_isHeroPicked[GetHeroIndexFromId(IntHeroesArray[i])]=true
    set i=i+1
  endloop
  set i=1
  set k=StrHeroesAmount
  loop
    exitwhen i>k
    call TechHeroForAll(StrHeroesArray[i])
    set b_isHeroPicked[GetHeroIndexFromId(StrHeroesArray[i])]=true
    set i=i+1
  endloop
endfunction

function IDE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer UZ8=(LoadInteger(HY,h,(172)))
  local player p
  local integer x=1
  loop
    exitwhen x>5
    set p=Sentinels[x]
    if IsPlayer(p)and p!=PlayerModeTyper then
      set udg_Hero[GetPlayerId(p)]=CreateUnit(p,UZ8,GetRectCenterX(gg_rct_Hero_Creation_NE),GetRectCenterY(gg_rct_Hero_Creation_NE),270)
      set HeroTypeId[GetPlayerId(p)]=UZ8
    endif
    set p=Scourges[x]
    if IsPlayer(p)and p!=PlayerModeTyper then
      set udg_Hero[GetPlayerId(p)]=CreateUnit(p,UZ8,GetRectCenterX(gg_rct_Hero_Creation_UD),GetRectCenterY(gg_rct_Hero_Creation_UD),270)
      set HeroTypeId[GetPlayerId(p)]=UZ8
    endif
    set x=x+1
  endloop
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set p=null
  return false
endfunction

function IEE takes nothing returns nothing
  local integer x=1
  local player p
  local unit Hero=GetTriggerUnit()
  local integer UZ8=GetUnitTypeId(Hero)
  local trigger t
  local integer h
  if(GetOwningPlayer(Hero)==PlayerModeTyper and IsUnitType(Hero,UNIT_TYPE_HERO))then
    call DisableTrigger(GetTriggeringTrigger())
    if HasUsedRandom[GetPlayerId(PlayerModeTyper)]==false and Mode_AR==false and Mode_TR==false then
      call SetPlayerState(PlayerModeTyper,PLAYER_STATE_RESOURCE_GOLD,250+GetPlayerState(PlayerModeTyper,PLAYER_STATE_RESOURCE_GOLD))
    endif
    set PlayerHaveRealHero[GetPlayerId(PlayerModeTyper)]=true
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.01,false)
    call TriggerAddCondition(t,Condition(function IDE))
    call SaveInteger(HY,h,(172),(UZ8))
  endif
  set p=null
  set Hero=null
  set t=null
endfunction

function C6D takes nothing returns nothing
  local integer x=1
  local trigger t=CreateTrigger()
  local region r=CreateRegion()
  set Mode_SH=true
  call TechHeroForAll('H00I')
  loop
    exitwhen x>5
    if(Sentinels[x]!=PlayerModeTyper)then
      call VS8(Sentinels[x])
      set HasUsedRandom[GetPlayerId(Sentinels[x])]=true
      set PlayerHaveRealHero[GetPlayerId(Sentinels[x])]=true
    endif
    if(Scourges[x]!=PlayerModeTyper)then
      call VS8(Scourges[x])
      set HasUsedRandom[GetPlayerId(Scourges[x])]=true
      set PlayerHaveRealHero[GetPlayerId(Scourges[x])]=true
    endif
    set x=x+1
  endloop
  call RegionAddRect(r,bj_mapInitialPlayableArea)
  call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
  call TriggerAddAction(t,function IEE)
  set r=null
  set t=null
endfunction

function C0D takes nothing returns nothing
  local integer VT8
  local integer VU8
  set Mode_AS=true
  set VT8=1
  set VU8=IntHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(IntHeroesArray[VT8])
    set b_isHeroPicked[GetHeroIndexFromId(IntHeroesArray[VT8])]=true
    set IsHeroIngame[GetHeroIndexFromId(IntHeroesArray[VT8])]=true
    set VT8=VT8+1
  endloop
  set VT8=1
  set VU8=AgilityHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(AgiHeroesArray[VT8])
    set VT8=VT8+1
  endloop
endfunction

function C1D takes nothing returns nothing
  local integer VT8
  local integer VU8
  set Mode_AI=true
  set VT8=1
  set VU8=AgilityHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(AgiHeroesArray[VT8])
    set b_isHeroPicked[GetHeroIndexFromId(AgiHeroesArray[VT8])]=true
    set IsHeroIngame[GetHeroIndexFromId(AgiHeroesArray[VT8])]=true
    set VT8=VT8+1
  endloop
  set VT8=1
  set VU8=StrHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(StrHeroesArray[VT8])
    set b_isHeroPicked[GetHeroIndexFromId(StrHeroesArray[VT8])]=true
    set IsHeroIngame[GetHeroIndexFromId(StrHeroesArray[VT8])]=true
    set VT8=VT8+1
  endloop
endfunction

function C2D takes nothing returns nothing
  local integer VT8
  local integer VU8
  set Mode_MO=true
  set VT8=1
  set VU8=RangeHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(RangeHeroesArray[VT8])
    set b_isHeroPicked[GetHeroIndexFromId(RangeHeroesArray[VT8])]=true
    set IsHeroIngame[GetHeroIndexFromId(RangeHeroesArray[VT8])]=true
    set VT8=VT8+1
  endloop
endfunction

function C5D takes nothing returns nothing
  local integer VT8
  local integer VU8
  set Mode_RO=true
  set VT8=1
  set VU8=MeleeHeroesAmount
  loop
    exitwhen VT8>VU8
    call TechHeroForAll(MeleeHeroesArray[VT8])
    set b_isHeroPicked[GetHeroIndexFromId(MeleeHeroesArray[VT8])]=true
    set IsHeroIngame[GetHeroIndexFromId(MeleeHeroesArray[VT8])]=true
    set VT8=VT8+1
  endloop
endfunction

function LMD takes nothing returns nothing
  set Mode_ID=true
endfunction

function LPD takes nothing returns nothing
  set Mode_EM=true
  call SetPlayerTechResearched(Sentinels[0],'R004',1)
  call SetPlayerTechResearched(Scourges[0],'R004',1)
  call SetPlayerHandicapXP(Sentinels[1],1.5)
  call SetPlayerHandicapXP(Sentinels[2],1.5)
  call SetPlayerHandicapXP(Sentinels[3],1.5)
  call SetPlayerHandicapXP(Sentinels[4],1.5)
  call SetPlayerHandicapXP(Sentinels[5],1.5)
  call SetPlayerHandicapXP(Scourges[1],1.5)
  call SetPlayerHandicapXP(Scourges[2],1.5)
  call SetPlayerHandicapXP(Scourges[3],1.5)
  call SetPlayerHandicapXP(Scourges[4],1.5)
  call SetPlayerHandicapXP(Scourges[5],1.5)
endfunction

function LND takes nothing returns nothing
  set Mode_NP=true
  call DestroyTrigger(RuneSpawnTrigger)
endfunction

function InitSuperCreepsMode takes nothing returns nothing
  set Mode_SC=true
endfunction

function IFE takes nothing returns nothing
  set D78=false
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10,GetObjectName('n0HA'))
  call DisableTrigger(GetTriggeringTrigger())
endfunction

function IGE takes nothing returns nothing
  call DisableTrigger((LoadTriggerHandle(HY,(GetHandleId(GetTriggeringTrigger())),(174))))
  call DisableTrigger(GetTriggeringTrigger())
endfunction

function IHE takes nothing returns nothing
  local trigger HCE=CreateTrigger()
  local trigger t=CreateTrigger()
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.," ")
  call DisplayTimedTextToForceEx(bj_FORCE_ALL_PLAYERS,10.,"Extra commands: -noneutrals can be entered in the following 15 seconds. ")
  call TriggerRegisterTimerEvent(HCE,15,false)
  call TriggerAddAction(HCE,function IGE)
  call SaveTriggerHandle(HY,(GetHandleId(HCE)),(174),(t))
  call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-noneutrals",true)
  call TriggerAddAction(t,function IFE)
  set HCE=null
  set t=null
endfunction

function LQD takes nothing returns nothing
  set Mode_OM=true
  if Mode_NN==false then
    call ExeFunc("IHE")
  endif
endfunction

function LRD takes nothing returns nothing
  set Mode_NB=true
endfunction

function LTD takes nothing returns nothing
  set Mode_NM=true
endfunction

function LSD takes nothing returns nothing
  set Mode_NT=true
endfunction

function LVD takes nothing returns nothing
  set Mode_NR=true
  set Mode_NS=true
endfunction

function LWD takes nothing returns nothing
  set DF8=true
endfunction

function LXD takes nothing returns nothing
  set Mode_PM=true
endfunction

function IIE takes nothing returns nothing
  local integer i=0
  local integer pid
  loop
    exitwhen i>5
    set pid=GetPlayerId(Sentinels[i])
    call SetPlayerName(Sentinels[i],PlayerNames[pid]+" ("+I2S(Kills[pid])+"/"+I2S(Deaths[pid])+" | "+I2S(PlayerCS[pid])+"-"+I2S(CSDenies[pid])+")")
    set pid=GetPlayerId(Scourges[i])
    call SetPlayerName(Scourges[i],PlayerNames[pid]+" ("+I2S(Kills[pid])+"/"+I2S(Deaths[pid])+" | "+I2S(PlayerCS[pid])+"-"+I2S(CSDenies[pid])+")")
    set i=i+1
  endloop
endfunction

function IJE takes nothing returns boolean
  if Mode_OI==false then
    if GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2 then
      call IIE()
    endif
  endif
  return false
endfunction

function LYD takes nothing returns nothing
  set Mode_OI=true
endfunction

function LAD takes nothing returns nothing
  set Mode_FR=true
endfunction

function INE takes nothing returns boolean
  if GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2 then
    if GetTriggerEvalCount(GetTriggeringTrigger())==1 then
      call CameraSetupSetDestPosition(DM8,0,0,.0)
    else
      call CameraSetupSetDestPosition(DM8,GetCameraTargetPositionX(),GetCameraTargetPositionY(),.0)
    endif
    call CameraSetupApplyForPlayer(true,DM8,GetLocalPlayer(),0)
    call SetTerrainFogEx(0,.0,100000.,.5,.353,.314,.235)
  endif
  return false
endfunction

function L3D takes nothing returns nothing
  local trigger t=CreateTrigger()
  set Mode_ZM=true
  set DM8=CreateCameraSetup()
  call CameraSetupSetField(DM8,CAMERA_FIELD_ZOFFSET,.0,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_ROTATION,90.,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_ANGLE_OF_ATTACK,304.,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_TARGET_DISTANCE,2500.,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_ROLL,.0,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_FIELD_OF_VIEW,70.,.0)
  call CameraSetupSetField(DM8,CAMERA_FIELD_FARZ,16000.,.0)
  call CameraSetupSetDestPosition(DM8,.0,.0,.0)
  call TriggerRegisterTimerEvent(t,180,true)
  call TriggerRegisterTimerEvent(t,.1,false)
  call TriggerAddCondition(t,Condition(function INE))
  set t=null
endfunction

function J9E takes nothing returns nothing
  local integer i=1
  local string id
  local player p
  loop
    exitwhen i>5
    set p=Sentinels[i]
    set id=I2S(GetPlayerId(p))
    call StoreInteger(GCM,id,"id",i)
    set p=Scourges[i]
    set id=I2S(GetPlayerId(p))
    call StoreInteger(GCM,id,"id",i+5)
    if GetLocalPlayer()==PlayerModeTyper then
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Sentinels[i])),"id")
      call SyncStoredInteger(GCM,I2S(GetPlayerId(Scourges[i])),"id")
    endif
    set i=i+1
  endloop
  set p=null
endfunction

function JDE takes nothing returns boolean
  if Mode_Normal then
    call CED("-sdzm3lseb",2)
  endif
  call J9E()
  call CleanTrigger(GetTriggeringTrigger())
  return false
endfunction

function JEE takes nothing returns boolean
  set IsHeroesAvailable=true
  call CleanTrigger(GetTriggeringTrigger())
  return false
endfunction

function STFUDur takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local real timeout=LoadReal(HY,h,0)
  local integer buffid=LoadInteger(HY,h,0)
  local boolean ishero=LoadBoolean(HY,h,0)
  local unit d
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or timeout<TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(u,buffid)==0 or LoadBoolean(HY,h,'SLDR') then
    call UnitRemoveAbility(u,'B463')
    call RemoveSavedHandle(HY,GetHandleId(u),'STFU')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    if GetUnitAbilityLevel(u,buffid)>0 and GetUnitAbilityLevel(u,'B463')==0 then
      set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
      call UnitAddAbility(d,'A463')
      call IssueTargetOrder(d,"soulburn",u)
      set d=null
    endif
  else
    if GetIssuedOrderId()>=852008 and GetIssuedOrderId()<=852013then
      call InterruptUnit(u)
    endif
  endif
  set u=null
  set t=null
endfunction

function STFU takes unit u, integer buffid, real dur returns nothing
  local trigger t
  local integer h
  local integer hu=GetHandleId(u)
  local unit d
  local real timeout
  if HaveSavedHandle(HY,hu,'STFU') then
    set t=LoadTriggerHandle(HY,hu,'STFU')
    set h=GetHandleId(t)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveTriggerHandle(HY,hu,'STFU',t)
    call TriggerRegisterTimerEvent(t,0.02,true)
    call TriggerRegisterDeathEvent(t,u)
    call SaveUnitHandle(HY,h,0,u)
    call TriggerAddCondition(t,Condition(function STFUDur))
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ISSUED_POINT_ORDER)
    set d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
    call UnitAddAbility(d,'A463')
    call IssueTargetOrder(d,"soulburn",u)
    set d=null
  endif
  set timeout=TimerGetElapsed(GlobalTimer)+dur*1.
  if timeout > LoadReal(HY,h,0) then
    call SaveInteger(HY,h,0,buffid)
    call SaveReal(HY,h,0,timeout)
  endif
  set t=null
endfunction

function Kodo_SpiteTimeout takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer k=LoadInteger(HY,h,0)
  local integer stats=LoadInteger(HY,h,1)
  if stats==1 then
    call SetHeroInt(u,GetHeroInt(u,false)+k,true)
  elseif stats==2 then
    call SetHeroAgi(u,GetHeroAgi(u,false)+k,true)
  elseif stats==3 then
    call SetHeroStr(u,GetHeroStr(u,false)+k,true)
  endif
  call DestroyEffect(LoadEffectHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call DestroyTrigger(t)
  set u=null
  set t=null
endfunction

function Kodo_SpiteForGroup takes nothing returns nothing
  local real duration=0
  local unit u=GetEnumUnit()
  local trigger t
  local real dur=12.
  local integer stolen=0
  local integer curstat=0
  local integer lvl=GetUnitAbilityLevel(SpitTempUnit,'A32A')
  local integer stats=0
  if IsUnitType(u,UNIT_TYPE_HERO) then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,dur,false)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
    set stats=3
    set stolen=IMinIF(GetHeroStr(u,false)-1,lvl*2)
    call SetHeroStr(u,GetHeroStr(u,false)-stolen,true)
    call SaveEffectHandle(HY,GetHandleId(t),2,AddSpecialEffectTarget("effects\\DeathFumesBreathDamage.mdx",u,"origin"))
    call TriggerAddCondition(t,Condition(function Kodo_SpiteTimeout))
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
    call SaveInteger(HY,GetHandleId(t),0,stolen)
    call SaveInteger(HY,GetHandleId(t),1,stats)
    set t=null
  endif
  call DamageTarget(SpitTempUnit,u,1,50+25*lvl)
  
  set u=null
endfunction

function Kodo_SpiteFilter takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(SpitTempUnit)) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(GetFilterUnit())==false
endfunction


function Kodo_Spit takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local group gg=GetAvailableGroup()
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  local real angle=AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),angle*bj_RADTODEG)
  call UnitAddAbility(dummy,'A32X')
  call IssuePointOrderById(dummy,852580,x+125*Cos(angle),y+125*Sin(angle))
  set dummy=null
  set SpitTempUnit=caster
  call GroupEnumUnitsInRange(g,x+125*Cos(angle),y+125*Sin(angle),175,Condition(function Kodo_SpiteFilter))
  call GroupAddGroup(g,gg)
  call GroupEnumUnitsInRange(g,x+300*Cos(angle),y+300*Sin(angle),200,Condition(function Kodo_SpiteFilter))
  call GroupAddGroup(g,gg)
  call GroupEnumUnitsInRange(g,x+500*Cos(angle),y+500*Sin(angle),200,Condition(function Kodo_SpiteFilter))
  call GroupAddGroup(g,gg)
  call GroupEnumUnitsInRange(g,x+700*Cos(angle),y+700*Sin(angle),250,Condition(function Kodo_SpiteFilter))
  call GroupAddGroup(g,gg)
  set SpitTempUnit=caster
  call ForGroup(gg,function Kodo_SpiteForGroup)
  call KillGroup(g)
  call KillGroup(gg)
  set caster=null
  set g=null
  set gg=null
endfunction

function kodo_TrampleTArgets takes nothing returns boolean
  return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(SpitTempUnit)) and IsDead(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL)==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitInGroup(GetFilterUnit(),TrampleTempGroup)==false
endfunction

function Kodo_TrampleForGroup takes nothing returns nothing
  call DamageTarget(SpitTempUnit,GetEnumUnit(),1,TempReal)
  call StunTargetLod(GetEnumUnit(),(1.2 + TempInteger*1.0*0.2))
  call GroupAddUnit(TrampleTempGroup,GetEnumUnit())
endfunction

function Kodo_trampleDuration takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local real angle=LoadReal(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  local real x=LoadReal(HY,h,1)
  local real y=LoadReal(HY,h,2)
  local real cx
  local real cy
  local real speed=LoadReal(HY,h,3)
  local group g
  local group affected=LoadGroupHandle(HY,h,2)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SetUnitPathing(u,true)
    call DestroyEffect(LoadEffectHandle(HY,h,4))
    call DestroyEffect(LoadEffectHandle(HY,h,5))
    call KillGroup(affected)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitPosition(u,SafeX50(GetUnitX(u)+speed*Cos(angle)),SafeY50(GetUnitY(u)+speed*Sin(angle)))
    if ModuloInteger(GetTriggerEvalCount(t),10)==0 then
      call KillTrees(GetUnitX(u),GetUnitY(u),150)
    endif
    call SetUnitFacing(u,angle*bj_RADTODEG)
    if DistanceBetweenXY(x,y,GetUnitX(u),GetUnitY(u))<50 or DistanceBetweenXY(x,y,GetUnitX(u),GetUnitY(u))>1200 or GetTriggerEvalCount(t)>1200./speed then
      call DestroyEffect(LoadEffectHandle(HY,h,4))
      call DestroyEffect(LoadEffectHandle(HY,h,5))
      call SetUnitPathing(u,true)
      call KillGroup(affected)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))
      set cx=GetUnitX(u)
      set cy=GetUnitY(u)
      set g=GetAvailableGroup()
      set SpitTempUnit=u
      set TrampleTempGroup=affected
      call GroupEnumUnitsInRange(g,cx,cy,275,Condition(function kodo_TrampleTArgets))
      set TempReal=lvl*50.0
      set TempInteger=lvl
      set SpitTempUnit=u
      call ForGroup(g,function Kodo_TrampleForGroup)
      call GroupAddGroup(g,affected)
      call KillGroup(g)
    endif
  endif
  set g=null
  set affected=null
  set u=null
  set t=null
endfunction

function Kodo_Trample takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local real cx=GetUnitX(u)
  local real cy=GetUnitY(u)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real angle=AngleBetweenXY(cx,cy,x,y)*bj_DEGTORAD
  local trigger t
  local integer h
  local group g=GetAvailableGroup()
  local string s=GetProperAttachPoint_Foot(u)
  local string s2=""
  if s=="foot" then
    set s="foot,right"
    set s2="foot,left"
  endif
  if DistanceBetweenXY(cx,cy,x,y)>1000 then
    set x=cx+1000*Cos(angle)
    set y=cy+1000*Sin(angle)
  endif
  
  call SetUnitFacingTimed(u,angle*bj_RADTODEG,.3)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Kodo_trampleDuration))
  call SaveUnitHandle(HY,h,0,u)
  call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("effects\\SandWaveMissile.mdx",u,s))
  call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("effects\\SandWaveMissile.mdx",u,s2))
  call SaveReal(HY,h,0,angle)
  call SaveReal(HY,h,1,x)
  call SaveReal(HY,h,2,y)
  call SaveReal(HY,h,3,1000.0*0.02)//speed
  call SaveInteger(HY,h,0,lvl)
  call SaveGroupHandle(HY,h,2,g)
  call SetUnitPathing(u,false)
  set t=null
  set u=null
  set g=null
endfunction

function Kodo_DigestSpitHit takes nothing returns nothing
  local unit caster=tt_unit1
  local unit target=tt_unit2
  local integer lvl=GetUnitAbilityLevel(caster,'A32E')
  local real damage=lvl*40+40
  call DamageTarget(caster,target,1,damage)
  call UnitAddAbilityTimedEx(target,'A32F',1,4,'B32F')
  set caster=null
  set target=null
endfunction

function Kodo_DigestSpitEffect takes nothing returns nothing
  local trigger t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'hKOD',"Kodo_DigestSpitHit",1000,true)
  set t=null
endfunction

function Kodo_DigestSpitEffectSup takes nothing returns nothing
  local integer i=LoadInteger(MHT,GetHandleId(GetTriggerUnit()),'A32D')-1
  if IsBlocked(GetSpellTargetUnit())==false then
    call Kodo_DigestSpitEffect()
  endif
  call SaveInteger(MHT,GetHandleId(GetTriggerUnit()),'A32D',i)
  if i<1 then
    call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A32D',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A32D',false)
    //call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A32E',true)
  endif
endfunction

function Kodo_DigestSpitCast takes nothing returns nothing
  local unit u=GetTriggerUnit()
  if LoadBoolean(MHT,GetHandleId(u),'A32D')==false or LoadInteger(MHT,GetHandleId(u),'A32D')<1 then
    call InterruptUnit(u)
    call Error(GetOwningPlayer(u),"No tree consumed")
    call SaveBoolean(MHT,GetHandleId(u),'A32D',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A32D',false)
  endif
  set u=null
endfunction

function Kodo_Digest_RemoveOwl2 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local destructable d=LoadDestructableHandle(HY,GetHandleId(t),0)
  local unit u=CreateUnit(Player(15),'e00E',GetDestructableX(d),GetDestructableY(d),0)
  call UnitAddAbility(u,'A1FD')
  call IssueTargetOrderById(u,852146,d)
  call FlushChildHashtable(HY,GetHandleId(t))
  call PauseTimer(t)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function Kodo_Digest_RemoveOwl takes destructable d returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.3,false,function Kodo_Digest_RemoveOwl2)
  call SaveDestructableHandle(HY,GetHandleId(t),0,d)
  set t=null
endfunction

function Kodo_Digest takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  call UnitAddAbility2(caster,'A32D')
  call SaveBoolean(MHT,GetHandleId(caster),'A32D',true)//spit is available
  call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A32D',true)
  call SaveInteger(MHT,GetHandleId(caster),'A32D',LoadInteger(MHT,GetHandleId(caster),'A32D')+1)
  //call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A32E',false)
  call Kodo_Digest_RemoveOwl(GetSpellTargetDestructable())
  set caster=null
endfunction

function Kodo_DigestLeveling takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A32E')
  call SetUnitAbilityLevel(GetTriggerUnit(),'A32E',GetUnitAbilityLevel(GetTriggerUnit(),'A32Y'))
endfunction

function AddDigestItems takes integer indexid returns nothing
  set DigestItemsCount=DigestItemsCount+1
  set DigestItems[DigestItemsCount]=Item_Real[indexid]
endfunction

function Kodo_DigestAllItems takes nothing returns nothing
  call AddDigestItems(indexid_UltimateOrb)
  call AddDigestItems(indexid_AssaultCuirass)
  call AddDigestItems(indexid_DisabledHeartOfTarrasque)
  call AddDigestItems(indexid_HeartOfTarrasque)
  call AddDigestItems(indexid_BKB10)
  call AddDigestItems(indexid_BKB09)
  call AddDigestItems(indexid_BKB08)
  call AddDigestItems(indexid_BKB07)
  call AddDigestItems(indexid_BKB06)
  call AddDigestItems(indexid_BKB05)
  call AddDigestItems(indexid_ShivasGuard)
  call AddDigestItems(indexid_bloodstone)
  call AddDigestItems(indexid_LinkensSphere)
  call AddDigestItems(indexid_LinkenDummy)
  call AddDigestItems(indexid_VanguardRanged)
  call AddDigestItems(indexid_Vanguard)
  call AddDigestItems(indexid_CrimsonGuard)
  call AddDigestItems(indexid_BladeMail)
  call AddDigestItems(indexid_SoulBooster)
  call AddDigestItems(indexid_HoodOfDefiance)
  call AddDigestItems(indexid_MantaStyleRanged)
  call AddDigestItems(indexid_MantaStyle)
  call AddDigestItems(indexid_GuinsooHex)
  call AddDigestItems(indexid_Orchid)
  call AddDigestItems(indexid_Eul)
  call AddDigestItems(indexid_ForceStaff)
  call AddDigestItems(indexid_Dagon1)
  call AddDigestItems(indexid_Dagon2)
  call AddDigestItems(indexid_Dagon3)
  call AddDigestItems(indexid_Dagon4)
  call AddDigestItems(indexid_Dagon5)
  call AddDigestItems(indexid_Necronomicon1)
  call AddDigestItems(indexid_Necronomicon2)
  call AddDigestItems(indexid_Necronomicon3)
  call AddDigestItems(indexid_RefresherOrb)
  call AddDigestItems(indexid_VeilOfDiscord)
  call AddDigestItems(indexid_RodOfAtos)
  call AddDigestItems(indexid_Mekansm)
  call AddDigestItems(indexid_VladmirsOffering)
  call AddDigestItems(indexid_Pipe)
  call AddDigestItems(indexid_DivineRapier)
  call AddDigestItems(indexid_DivineRapierFree)
  call AddDigestItems(indexid_MKBOn)
  call AddDigestItems(indexid_MKBOff)
  call AddDigestItems(indexid_RadianceOn)
  call AddDigestItems(indexid_RadianceOff)
  call AddDigestItems(indexid_Butterfly)
  call AddDigestItems(indexid_Buriza)
  call AddDigestItems(indexid_CraniumBasher)
  call AddDigestItems(indexid_CraniumBasherRanged)
  call AddDigestItems(indexid_BattleFury)
  call AddDigestItems(indexid_AbyssalBlade)
  call AddDigestItems(indexid_Crystalys)
  call AddDigestItems(indexid_ArmletOn)
  call AddDigestItems(indexid_ArmletOff)
  call AddDigestItems(indexid_LotharsEdge)
  call AddDigestItems(indexid_EtherealBlade)
  call AddDigestItems(indexid_SangeAndYasha)
  call AddDigestItems(indexid_Satanic)
  call AddDigestItems(indexid_Mjollnir)
  call AddDigestItems(indexid_EyeOfSkadiRanged)
  call AddDigestItems(indexid_EyeOfSkadi)
  call AddDigestItems(indexid_Sange)
  call AddDigestItems(indexid_Yasha)
  call AddDigestItems(indexid_Maelstrom)
  call AddDigestItems(indexid_DiffusalBlade_upg_empty)
  call AddDigestItems(indexid_DiffusalBlade_upg)
  call AddDigestItems(indexid_DiffusalBlade_empty)
  call AddDigestItems(indexid_DiffusalBlade)
  call AddDigestItems(indexid_Desolator)
  call AddDigestItems(indexid_HeavensHalberd)
  call AddDigestItems(indexid_bootsOfTravel)
  call AddDigestItems(indexid_HandOfMidas)
  call AddDigestItems(indexid_DisabledKelensDagger)
  call AddDigestItems(indexid_KelensDagger)
  call AddDigestItems(indexid_DemonEdge)
  call AddDigestItems(indexid_Eaglehorn)
  call AddDigestItems(indexid_Hyperstone)
  call AddDigestItems(indexid_MesserschmidtReaver)
  call AddDigestItems(indexid_MysticStaff)
  call AddDigestItems(indexid_SacredRelic)
  call AddDigestItems(indexid_AghanimBasic)
  call AddDigestItems(indexid_aghanimUpgrader)
endfunction

function Kodo_DigestBonusesPeriodic takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer count=0
  local integer lvl=GetUnitAbilityLevel(u,'A32G')
  local integer bonus=15+5*lvl
  local integer curbonus=LoadInteger(MHT,GetHandleId(u),'A32G')
  local integer i=0
  local integer id=0
  local integer k=0
  local integer totalbonus=0
  if lvl==0 then
    if curbonus>0 then
      call LoDStat_Sub(u,curbonus,"damage")
      call LoDStat_Sub(u,R2I(curbonus/2),"attack")
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  else
    loop
      set k=0
      set id=GetItemTypeId(UnitItemInSlot(u,i))
      if id>0 then
        loop
          if DigestItems[k]==id then
            set count=count+1
            set k=DigestItemsCount
          endif
          set k=k+1
          exitwhen k>DigestItemsCount
        endloop
      endif
      set i=i+1
      exitwhen i>5
    endloop
    set totalbonus=count*bonus
    if totalbonus!=curbonus then
      call LoDStat_Sub(u,curbonus,"damage")
      call LoDStat_Sub(u,R2I(curbonus/2),"attack")
      call LoDStat_Add(u,totalbonus,"damage")
      call LoDStat_Add(u,R2I(totalbonus/2),"attack")
      call SaveInteger(MHT,GetHandleId(u),'A32G',totalbonus)
    endif
  endif
  set t=null
  set u=null
endfunction

function Kodo_DigestBonuses takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local timer t=CreateTimer()
  call TimerStart(t,1,true,function Kodo_DigestBonusesPeriodic)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(u,GetSpellAbilityId())+1)
  set t=null
  set u=null
endfunction


function Kodo_DrumsProvideBonusesStr takes unit u, integer str returns nothing
  local integer array b
  local integer a=str
  local integer c=1
  local integer i=0
  local integer z=5
  local real hp
  local integer array bonuses
  set bonuses[0]='A32N'
  set bonuses[1]='A32O'
  set bonuses[2]='A32P'
  set bonuses[3]='A32Q'
  set bonuses[4]='A32R'
  set bonuses[5]='A32S'
  if str<1 then
    set hp=GetWidgetLife(u)
    call UnitRemoveAbility(u,bonuses[0])
    call UnitRemoveAbility(u,bonuses[1])
    call UnitRemoveAbility(u,bonuses[2])
    call UnitRemoveAbility(u,bonuses[3])
    call UnitRemoveAbility(u,bonuses[4])
    call UnitRemoveAbility(u,bonuses[5])
    call SetWidgetLife(u,hp)
    return
  endif
  loop
    set c=a/2
    set b[i]=a-c*2
    set a=c
    set i=i+1
    exitwhen c==0
  endloop
  set i=0
  loop
    exitwhen i>z
    if b[i]==1 then
      call UnitAddAbility2(u,bonuses[i])
    else
      call UnitRemoveAbility(u,bonuses[i])
    endif
    set i=i+1
  endloop
endfunction

function Kodo_DrumsProvideBonuses takes unit u, integer str, integer others returns nothing
  local integer array b
  local integer a=others
  local integer c=1
  local integer i=0
  local integer z
  local real hp
  local integer array bonuses
  set bonuses[0]='A32H'
  set bonuses[1]='A32I'
  set bonuses[2]='A32J'
  set bonuses[3]='A32K'
  set bonuses[4]='A32L'
  set bonuses[5]='A32M'
  if others<1 then
    call UnitRemoveAbility(u,bonuses[0])
    call UnitRemoveAbility(u,bonuses[1])
    call UnitRemoveAbility(u,bonuses[2])
    call UnitRemoveAbility(u,bonuses[3])
    call UnitRemoveAbility(u,bonuses[4])
    call UnitRemoveAbility(u,bonuses[5])
    call Kodo_DrumsProvideBonusesStr(u,0)
    return
  endif
  loop
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
    exitwhen c==0
  endloop
  set z=5
  set i=0
  loop
    exitwhen i>z
    if b[i]==1 then
      call UnitAddAbility2(u,bonuses[i])
    else
      call UnitRemoveAbility(u,bonuses[i])
    endif
    set i=i+1
  endloop
  call Kodo_DrumsProvideBonusesStr(u,str)
endfunction

function Kodo_DrumsDuration takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer hu=0
  local integer lvl=LoadInteger(HY,h,0)
  local unit caster=LoadUnitHandle(HY,h,0)
  local integer i=1
  local unit u=null
  local boolean isSc=LoadBoolean(HY,h,0)
  local player p
  local integer pid=0
  local integer counter=LoadInteger(HY,h,1)+1
  local integer herocount=0
  local integer curbonuses=0
  local integer totalbonuses=0
  local integer limit=LoadInteger(HY,h,-1)
  local unit array targets
  loop
    if isSc then
      set pid=GetPlayerId(Scourges[i])
    else
      set pid=GetPlayerId(Sentinels[i])
    endif
    set u=udg_Hero[pid]
    if u!=null then
      set hu=GetHandleId(u)
      if IsDead(u)==false and (DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925 or LoadBoolean(MHT,hu,'A32G'+1)) then//if hero is alive and in range or was in aoe when casted (key)
        if counter==1 then//on cast
          call SaveBoolean(MHT,hu,'A32G'+1,true)//save flag that unit was there on cast
        endif
        set herocount=herocount+1
        set targets[herocount]=u
      elseif IsDead(u)==false and DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925==false then
        call Kodo_DrumsProvideBonuses(u,0,0)
        call SaveInteger(MHT,GetHandleId(u),'A32G'+1,0)
        call SaveBoolean(MHT,hu,'A32G'+1,false)
      endif
    endif
    set i=i+1
    exitwhen i>5
  endloop
  set totalbonuses=(6+2*lvl)*herocount
  set i=1
  loop
    set u=targets[i]
    set hu=GetHandleId(u)
    if counter<limit and (DistanceBetweenXY(GetUnitX(caster),GetUnitY(caster),GetUnitX(u),GetUnitY(u))<925 or LoadBoolean(MHT,hu,'A32G'+1)) then//if hero is alive and in range or was in aoe when casted (key)
      set curbonuses=LoadInteger(MHT,GetHandleId(u),'A32G'+1)
      if curbonuses!=totalbonuses then
        call Kodo_DrumsProvideBonuses(u,0,0)
        if u!=caster then
          call Kodo_DrumsProvideBonuses(u,R2I(totalbonuses/2),totalbonuses)
        else
          call Kodo_DrumsProvideBonuses(u,totalbonuses,totalbonuses)
        endif
        call SaveInteger(MHT,GetHandleId(u),'A32G'+1,totalbonuses)
      endif
    else
      call Kodo_DrumsProvideBonuses(u,0,0)
      call SaveInteger(MHT,GetHandleId(u),'A32G'+1,0)
      call SaveBoolean(MHT,hu,'A32G'+1,false)
    endif
    set i=i+1
    exitwhen i>herocount
  endloop
  call SaveInteger(HY,h,1,counter)
  if counter==limit then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set caster=null
  set t=null
  set u=null
  set targets[1]=null
  set targets[2]=null
  set targets[3]=null
  set targets[4]=null
  set targets[5]=null
endfunction

function Kodo_DrumWars takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local timer t=CreateTimer()
  call TimerStart(t,0.25,true,function Kodo_DrumsDuration)
  call SaveInteger(HY,GetHandleId(t),-1,R2I(8/0.25)+1)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveInteger(HY,GetHandleId(t),0,lvl)
  call SaveBoolean(HY,GetHandleId(t),0,IsScourge(GetOwningPlayer(u)))
  set t=null
  set u=null
endfunction

function Queen_VitalStrikeActs takes nothing returns nothing
  local unit caster=tt_unit1
  local unit target=tt_unit2
  local real damage=100+60*GetUnitAbilityLevel(caster,'A45W')
  if GetWidgetLife(target) < GetUnitState(target,UNIT_STATE_MAX_LIFE)/2 then
    set damage=damage/2
  endif
  call DestroyEffect(LoadEffectHandle(HY,GetHandleId(GetTriggeringTrigger()),'00fx'))
  call DamageTarget(caster,target,3,damage)
  set caster=null
  set target=null
endfunction

function Queen_VitalStrike takes nothing returns nothing
  local trigger t
  local unit d
  if IsBlocked(GetSpellTargetUnit())==false then
    set t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h077',"Queen_VitalStrikeActs",1500,true)
    set d=LoadUnitHandle(HY,GetHandleId(t),45)
    call SaveEffectHandle(HY,GetHandleId(t),'00fx',AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilMissile.mdl",d,"origin"))
    set t=null
    set d=null
  endif
endfunction

function Queen_ArrowShowerFilter takes nothing returns boolean
  if IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(Queen_TempUnit)) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(GetFilterUnit())==false then
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
      set Queen_TempInt2=Queen_TempInt2+1
    endif
    return true
  endif
  return false
endfunction

function Queen_ArrowShowerForGroup takes nothing returns nothing
  local integer aid='A45Y'
  local integer lvl=1
  call DamageTarget(Queen_TempUnit,GetEnumUnit(),1,Queen_TempInt*40+40)
  if IsDead(GetEnumUnit())==false then
    if Queen_TempInt2<2 then
      set lvl=Queen_TempInt2+1
    else
      set lvl=Queen_TempInt2-1
      set aid=aid+1
    endif
    call UnitAddAbilityTimedExF(GetEnumUnit(),aid,lvl,1+Queen_TempInt,'B45Y')
  endif
endfunction

function Queen_ArrowShowerImpact takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  local group g=GetAvailableGroup()
  local integer i=0
  set Queen_TempInt=lvl
  set Queen_TempUnit=caster
  set Queen_TempInt2=0
  call GroupEnumUnitsInRange(g,LoadReal(HY,h,1),LoadReal(HY,h,2),300+50*lvl,Condition(function Queen_ArrowShowerFilter))
  call ForGroup(g,function Queen_ArrowShowerForGroup)
  call KillGroup(g)
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set caster=null
  set t=null
endfunction

function Queen_ArrowShower takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),'A45X'))
  call SaveUnitHandle(HY,h,0,GetTriggerUnit())
  call SaveReal(HY,h,1,x)
  call SaveReal(HY,h,2,y)
  call TimerStart(t,0.4,false,function Queen_ArrowShowerImpact)
  call SaveEffectHandle(HY,h,10,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y))
  call SaveEffectHandle(HY,h,11,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x+250,y))
  call SaveEffectHandle(HY,h,12,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y+250))
  call SaveEffectHandle(HY,h,13,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x+250,y+250))
  call SaveEffectHandle(HY,h,14,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x-250,y))
  call SaveEffectHandle(HY,h,15,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x,y-250))
  call SaveEffectHandle(HY,h,16,AddSpecialEffect("war3mapImported\\ArrowShower.mdx",x-250,y-250))
  set t=null
endfunction

function Queen_MortalWoundsDOT takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit queen=LoadUnitHandle(HY,h,0)
  local unit victim=LoadUnitHandle(HY,h,1)
  local real dmg=LoadReal(HY,h,0)
  local integer c=LoadInteger(HY,h,0)+1
  if queen==null or victim==null or dmg==0. or c>3 then
    call DestroyEffect(LoadEffectHandle(HY,h,3))
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  else
    set MortalWoundsDamage=true
    call DamageTarget(queen,victim,2,dmg)
    set MortalWoundsDamage=false
    call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HumanBloodRifleman.mdl",victim,"origin"))
    call SaveInteger(HY,h,0,c)
    if c==3 then
      call DestroyEffect(LoadEffectHandle(HY,h,3))
      call PauseTimer(t)
      call DestroyTimer(t)
      call FlushChildHashtable(HY,h)
    endif
  endif
  set t=null
  set queen=null
  set victim=null
endfunction

function MortalWoundsWrapper takes unit attacker, unit target returns nothing
  local timer tt
  local integer ht
  if GetEventDamage()>20 and MortalWoundsDamage==false and PRD_Get(attacker,'A460',30) then
    set tt=CreateTimer()
    set ht=GetHandleId(tt)
    call TimerStart(tt,1,true,function Queen_MortalWoundsDOT)
    call SaveUnitHandle(HY,ht,0,attacker)
    call SaveUnitHandle(HY,ht,1,target)
    call SaveReal(HY,ht,0,GetEventDamage()*(.05*(GetUnitAbilityLevel(attacker,'A460')+GetUnitAbilityLevel(attacker,'QP27'))+.15))
    call SaveEffectHandle(HY,ht,3,AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",target,"origin"))
    set tt=null
  endif
endfunction

function Queen_SnatchFilter takes nothing returns boolean
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(Queen_TempUnit)) and GetUnitAbilityLevel(GetFilterUnit(),'Avul')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 then
    if GetWidgetLife(GetFilterUnit())<Queen_SnatchedHP then
      set Queen_SnatchedHP=GetWidgetLife(GetFilterUnit())
      set Queen_SnatchedUnit=GetFilterUnit()
    endif
    return true
  endif
  return false
endfunction

function QueenSnatchStun takes unit u, boolean isSingle returns nothing
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  local integer aid='A462'
  local integer lvl=1
  if isSingle then
    set lvl=2
  endif
  call UnitAddAbility(d,aid)
  call SetUnitAbilityLevel(d,aid,lvl)
  call IssueTargetOrder(d,"thunderbolt",u)
  call AddEffectTargetTimed("Abilities\\Spells\\Orc\\Ensnare\\ensnare_AirTarget.mdl",u,"origin",0.5)
  set d=null
endfunction

function Queen_SnatchDuration takes nothing returns nothing
  local integer h=GetHandleId(GetExpiredTimer())
  local unit caster=(LoadUnitHandle(HY,h,(290)))
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real Ax=(LoadReal(HY,h,(284)))
  local real Ay=(LoadReal(HY,h,(285)))
  local real Cx=(LoadReal(HY,h,(286)))
  local real Cy=(LoadReal(HY,h,(287)))
  local real Bx=(LoadReal(HY,h,(288)))
  local real By=(LoadReal(HY,h,(289)))
  local real a=(LoadReal(HY,h,(137)))
  local real b=1-a
  local boolean MUE=(LoadBoolean(HY,h,(291)))
  local real MVE=RMaxBJ(DistanceBetweenXY(Ax,Ay,Cx,Cy)/ 1300,.2)
  local boolean bb=LoadBoolean(HY,h,0)
  local group g
  local real x=SafeX50(Ax*a*a+Bx*2*a*b+Cx*b*b)
  local real y=SafeY50(Ay*a*a+By*2*a*b+Cy*b*b)
  local unit u
  local real height
  
  call SetUnitFacing(caster,AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),x,y))
  call SetUnitX(caster,x)
  call SetUnitY(caster,y)
  
  if DistanceBetweenXY(x,y,Cx,Cy)<50 and bb==false then
    call SaveBoolean(HY,h,0,true)
    set g=GetAvailableGroup()
    set Queen_TempUnit=caster
    set Queen_TempInt=GetUnitAbilityLevel(caster,'A461')
    set Queen_SnatchedUnit=null
    set Queen_SnatchedHP=999999
    call GroupEnumUnitsInRange(g,x,y,300,Condition(function Queen_SnatchFilter))
    if Queen_SnatchedUnit!=null then
      call SaveBoolean(HY,h,1,true)
      call SaveUnitHandle(HY,h,1,Queen_SnatchedUnit)
    endif
    loop
      set u=FirstOfGroup(g)
      
      exitwhen u==null
      
      call DamageTarget(caster,u,1,Queen_TempInt*50+50)
      call QueenSnatchStun(u,false)
      call GroupRemoveUnit(g,u)
      
    endloop
    call KillGroup(g)
    set g=null
  endif
  if LoadBoolean(HY,h,1)then
    call SetUnitPosition(LoadUnitHandle(HY,h,1),x,y)
  endif
  if(MUE)then
    call SaveReal(HY,h,(137),((a-.02/ MVE)*1.))
    call SetUnitFlyHeight(caster,GetUnitFlyHeight(caster)+LoadReal(HY,h,291),0)
  else
    call SaveReal(HY,h,(137),((a+.02/ MVE)*1.))
    call SetUnitFlyHeight(caster,GetUnitFlyHeight(caster)-LoadReal(HY,h,291),0)
  endif
  if(a<0 and MUE)then
    call SaveBoolean(HY,h,(291),(false))
    call SaveReal(HY,h,(288),((Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+(LoadReal(HY,h,(292)))))*1.))
    call SaveReal(HY,h,(289),((Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+(LoadReal(HY,h,(292)))))*1.))
  endif
  if(a>1 and MUE==false)then
    if LoadBoolean(HY,h,1)then
      call DamageTarget(caster,LoadUnitHandle(HY,h,1),1,50+50*GetUnitAbilityLevel(caster,'A461'))
      call QueenSnatchStun(LoadUnitHandle(HY,h,1),true)
      call AddEffectTargetTimed("Abilities\\Spells\\Orc\\Ensnare\\ensnare_AirTarget.mdl",LoadUnitHandle(HY,h,1),"origin",1)
      call KillTrees(GetUnitX(LoadUnitHandle(HY,h,1)),GetUnitY(LoadUnitHandle(HY,h,1)),200)
    endif
    call SetUnitFlyHeight(caster,LoadReal(HY,h,290),0)
    call KillTrees(GetUnitX(caster),GetUnitY(caster),200)
    call PauseTimer(GetExpiredTimer())
    call FlushChildHashtable(HY,h)
    call DestroyTimer(GetExpiredTimer())
  endif
  set caster=null
  set Hero=null
endfunction

function Queen_Snatch takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local real Ax=GetUnitX(caster)
  local real Ay=GetUnitY(caster)
  local real Cx=SafeX50(GetSpellTargetX())
  local real Cy=SafeY50(GetSpellTargetY())
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local real a=AngleBetweenXY(Ax,Ay,Cx,Cy)*bj_DEGTORAD
  if DistanceBetweenXY(Ax,Ay,Cx,Cy)<300 then
    set Cx=SafeX50(Ax+300*Cos(a))
    set Cy=SafeY50(Ay+300*Sin(a))
  endif
  call SaveUnitHandle(HY,h,(14),(caster))
  call SaveUnitHandle(HY,h,(290),(caster))
  call SaveReal(HY,h,(284),((Ax)*1.))
  call SaveReal(HY,h,(285),((Ay)*1.))
  call SaveReal(HY,h,(286),((Cx)*1.))
  call SaveReal(HY,h,(287),((Cy)*1.))
  call SaveReal(HY,h,(288),((Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)-45))*1.))
  call SaveReal(HY,h,(289),((Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)-45))*1.))
  call SaveReal(HY,h,(137),1.)
  call SaveReal(HY,h,(292),45.)
  call SaveBoolean(HY,h,(291),true)
  call SaveReal(HY,h,290,GetUnitFlyHeight(caster))
  call SaveReal(HY,h,291,1300/DistanceBetweenXY(Ax,Ay,Cx,Cy))
  if IsBuggyFlying(caster)==false then
    call UnitAddAbility2(caster,'Amrf')
    call UnitRemoveAbility(caster,'Amrf')
  endif
  call TimerStart(t,.020,true,function Queen_SnatchDuration)
  set caster=null
  set t=null
endfunction

function JIE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local integer Level=(LoadInteger(HY,h,5))
  local real JJE
  local unit Caster
  set JJE=.6*(Count-25)*(Count-25)
  if Count<51 and GetTriggerEventId()!=EVENT_UNIT_DEATH then
    if ModuloInteger(Count,5)==0 then
      call DamageTarget(Source,Target,1,3+3*Level)
    endif
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,500-JJE,0)
    endif
  else
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
    call UnitAddAbility2(Caster,'A11L')
    call SetUnitAbilityLevel(Caster,'A11L',Level)
    call IssueTargetOrderById(Caster,852075,Target)
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
    endif
    if GameEnded==false then
      call PauseUnit(Target,false)
    endif
    call SetUnitPathing(Target,true)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  return false
endfunction

function JKE takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=tt_unit1
  local unit Target=GetEnumUnit()
  local integer Level=tt_int1
  call PauseUnit(Target,true)
  call SetUnitPathing(Target,false)
  if IsBuggyFlying(Target)==false then
    call UnitAddAbility2(Target,'Amrf')
    call UnitRemoveAbility(Target,'Amrf')
  endif
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function JIE))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveInteger(HY,h,5,(Level))
  call DamageTarget(Source,Target,1,30+30*Level)
  set t=null
  set Source=null
  set Target=null
endfunction

function JME takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local integer Level=LoadInteger(HY,h,5)
  local group g=GetAvailableGroup()
  local ubersplat Splat=CreateUbersplat(x,y,"THNN",255,255,255,255,false,false)
  call SetUbersplatRenderAlways(Splat,true)
  call TimedReveal(GetOwningPlayer(Hero),4,x,y,400)
  call DestroyEffect(LoadEffectHandle(HY,h,175))
  call DestroyEffect(LoadEffectHandle(HY,h,176))
  call DestroyEffect(LoadEffectHandle(HY,h,177))
  call DestroyEffect(LoadEffectHandle(HY,h,178))
  call DestroyEffect(LoadEffectHandle(HY,h,179))
  call DestroyEffect(LoadEffectHandle(HY,h,180))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",x,y))
  call DestroyEffect(AddSpecialEffect("effects\\TidalErruption.mdx",x,y))
  set tt_unit1=Hero
  set tt_int1=Level
  call GroupEnumUnitsInRange(g,x,y,225+25,Condition(function NonImmuneEnemyFilter))
  call ForGroup(g,function JKE)
  call KillGroup(g)
  set t=null
  set Hero=null
  set g=null
  set Splat=null
  return false
endfunction

function Admiral_Torrent takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Hero,'A136')
  local string s=""
  local real a
  local real r
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Hero)) or IsObserver(GetLocalPlayer())then
    set s="Objects\\Spawnmodels\\Other\\IllidanFootprint\\IllidanWaterSpawnFootPrint.mdl"
  endif
  call SaveInteger(HY,h,5,Level)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveInteger(HY,h,5,Level)
  set r=6*360*bj_DEGTORAD
  set a=0
  call SaveEffectHandle(HY,h,175,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  set a=1
  call SaveEffectHandle(HY,h,176,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  set a=2
  call SaveEffectHandle(HY,h,177,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  set a=3
  call SaveEffectHandle(HY,h,178,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  set a=4
  call SaveEffectHandle(HY,h,179,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  set a=5
  call SaveEffectHandle(HY,h,180,AddSpecialEffect(s,x+40*Cos(a/r),y+40*Sin(a/r)))
  call TriggerRegisterTimerEvent(t,1.6,false)
  call TriggerAddCondition(t,Condition(function JME))
  set Hero=null
  set t=null
endfunction

function Kunka_Tidebringer_Restart_IfDead takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(MHT,h,0)
  local integer level=LoadInteger(MHT,h,1)
  if IsDead(u)==false then
    call LoDStat_Add(u,15*level,"damage")
    call UnitAddAbility2(u,'A147')
    
    call SetUnitAbilityLevel(u,'A146',level)
    call UnitMakeAbilityPermanent(u,true,'A146')
    set level = GetHandleId(u)
    call SaveBoolean(MHT,level,'A13T',true)
    call SaveEffectHandle(MHT,level,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
    call CleanTrigger(t)
    call FlushChildHashtable(MHT,h)
  endif
  set t=null
  set u=null
  return false
endfunction

function Kunka_Tidebringer_Restart takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local trigger tt
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  local integer level = GetUnitAbilityLevel(u,'A522')
  call SaveBoolean(MHT,GetHandleId(u),'A13T',true)
  
  if UA8(u) then
    set tt=CreateTrigger()
    call TriggerRegisterTimerEvent(tt,1,true)
    call TriggerAddCondition(tt,Condition(function Kunka_Tidebringer_Restart_IfDead))
    call SaveUnitHandle(MHT,GetHandleId(tt),0,u)
    call SaveInteger(MHT,GetHandleId(tt),1,level)
    set tt=null
  else
    call LoDStat_Add(u,15*level,"damage")
    call UnitAddAbility2(u,'A147')
    call SetUnitAbilityLevel(u,'A146',level)
    call UnitMakeAbilityPermanent(u,true,'A146')
    set level = GetHandleId(u)
    call SaveBoolean(MHT,level,'A13T',true)
    call SaveEffectHandle(MHT,level,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
  endif
  
  call Timer_End(t)
  set t = null
  set u = null
  
endfunction

function Kunka_Tidebringer_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and  IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and t!=group_temp_unit[1]then
    call DamageTarget(group_temp_unit[0],t,8,group_temp_real[0])
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WaterElementalMissile\\WaterElementalMissile.mdl",t,"chest"))
  endif
  
  set t = null
  return false
endfunction

function Kunka_Tidebringer_Range_End takes unit u, unit d, real damage, integer info returns nothing
  local timer t = CreateTimer()
  local integer level = GetUnitAbilityLevel(u,'A522') //A13T
  local real x1 = GetWidgetX(d)
  local real y1 = GetWidgetY(d)
  local real range = 525 + 100*(level/4)
  set group_temp_unit[0] = u
  set group_temp_unit[1] = d
  if Mode_BO then
    set group_temp_real[0] = damage
  else
    set group_temp_real[0] = damage*0.8//(0.4+0.1*level)
  endif
  set group_temp_player = GetOwningPlayer(u)
  call GroupEnumUnitsInRange(temp_group,x1,y1,range,Condition(function Kunka_Tidebringer_Targets)) //splash aoe
  if LoadBoolean(MHT,GetHandleId(group_temp_player),4)then //check to see if passive cooldowns are enabled for the player
    call Passive_Cooldown(u,'A13T',level)
  endif
  call LoDStat_Sub(u,level*15,"damage")
  call UnitRemoveAbility(u,'A147') //remove cleave (incase the attack transforms into a melee unit)
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,16 - 3*level,false,function Kunka_Tidebringer_Restart)
  set level = StringHash("tidebringer_effect")
  call DestroyEffect(LoadEffectHandle(MHT,info,level))
  call RemoveSavedHandle(MHT,info,level)
  set t = null
endfunction

function Kunka_Tidebringer_Melee_End takes unit u, integer info returns nothing
  local timer t = CreateTimer()
  local integer level = GetUnitAbilityLevel(u,'A522') //A13T
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,16 - 3*level,false,function Kunka_Tidebringer_Restart)
  if LoadBoolean(MHT,GetHandleId(GetOwningPlayer(u)),4)then //check to see if passive cooldowns are enabled for the player
    call Passive_Cooldown(u,'A13T',level)
  endif
  call LoDStat_Sub(u,level*15,"damage")
  call UnitRemoveAbility(u,'A147') //remove cleave
  set level = StringHash("tidebringer_effect")
  call DestroyEffect(LoadEffectHandle(MHT,info,level))
  call RemoveSavedHandle(MHT,info,level)
  set t = null
endfunction

function Kunka_Tidebringer_Effect takes unit u, unit t, real d returns nothing
  local integer info = GetHandleId(u)
  local integer load = StringHash("tidebringer_delay")
  if LoadBoolean(MHT,info,load)then
    call SaveBoolean(MHT,info,load,false)   // should the next damage proc
    call SaveBoolean(MHT,info,'A13T',false) // is tidebringer ready
    set load = StringHash("tidebringer_timer")
    call Timer_End(LoadTimerHandle(MHT,info,load))
    call RemoveSavedHandle(MHT,info,load)
    if IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER)==true then
      call Kunka_Tidebringer_Range_End(u,t,d,info)
    else
      call Kunka_Tidebringer_Melee_End(u,info)
    endif
  endif
endfunction

function Kunka_Tidebringer_Start takes unit u, unit d, integer load, integer level returns nothing
  local timer t = LoadTimerHandle(MHT,load,StringHash("tidebringer_timer"))
  local integer info = GetHandleId(d)
  call SaveBoolean(MHT,load,StringHash("tidebringer_delay"),true)
  if LoadBoolean(MHT,info,1)==false then
    call SaveBoolean(MHT,info,1,true)
    call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_DAMAGED)
  endif
  if t==null then
    set t = CreateTimer()
    call SaveTimerHandle(MHT,load,StringHash("tidebringer_timer"),t)
  endif
  call SaveInteger(MHT,GetHandleId(t),0,load)
  set t = null
endfunction

function Kunka_Tidebringer_Condition takes unit u, unit t returns nothing
  local boolean b
  local integer info = GetHandleId(u)
  if LoadBoolean(MHT,info,'A13T')and IsUnitEnemy(u,GetOwningPlayer(t)) and (IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER) or IsUnitIllusion(t)==false) then
    call Kunka_Tidebringer_Start(u,t,info,GetUnitAbilityLevel(u,'A13T'))
  endif
endfunction

function Kunka_Tidebringer_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer info = GetHandleId(u)
  if LoadBoolean(MHT,info,'A13T')then //not on cooldown
    call LoDStat_Add(u,15,"damage")
  elseif GetUnitAbilityLevel(u,'A522')==1then //first time learning
    call LoDStat_Add(u,15,"damage")
    call SaveBoolean(MHT,info,'A13T',true)
    call SaveEffectHandle(MHT,info,StringHash("tidebringer_effect"),AddSpecialEffectTarget("effects\\WaterHands.mdx",u,GetProperAttachPoint_Weapon(u)))
    if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==true then //adds the cleave ability to melee units
      call UnitAddAbility2(u,'A147')
      call UnitMakeAbilityPermanent(u,true,'A146')
      call SetUnitAbilityLevel(u,'A146',GetUnitAbilityLevel(u,'A13T'))
    endif
  endif
  set u = null
endfunction

function Tree_Invi_Condition_Self takes unit u, unit t returns nothing
  call SaveBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"),false)
endfunction

function Admiral_XMark_Return takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,30)
  local image i=LoadImageHandle(HY,h,185)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local unit Source=LoadUnitHandle(HY,h,2)
  if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A13D')then
    if GetTriggerEventId()!=EVENT_UNIT_DEATH and (IsMagicImmune(Target)==false or IsUnitAlly(Target,GetOwningPlayer(Source))) then
      if IsUnitHidden(Target)then
        call SetUnitX(Target,x)
        call SetUnitY(Target,y)
      else
        call SetUnitPosition(Target,x,y)
      endif
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A13D',false)
    if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A11N' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A11N',true)
    endif
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call ShowImage(i,false)
    call DestroyImage(i)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set i=null
  set Source=null
  return false
endfunction

function Admiral_XMark_Effect takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real size=90
  local image i=CreateImage("Fonts\\X.blp",size,size,0,x-size/2,y-size/2,0,0,0,0,2)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local string fx=""
  local integer Level=GetUnitAbilityLevel(Source,'A11N')
  local real duration=4.0
  if IsPlayerAlly(GetOwningPlayer(Source),GetOwningPlayer(Target)) then
    set duration=duration*2
  endif
  call AddTimedKeyToUnit(Target,4401,5)
  call UnitAddAbility2(Source,'A13D')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A13D',true)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A11N',false)
  call SetImageRenderAlways(i,true)
  if IsUnitAlly(Source,GetOwningPlayer(Target))==false or IsUnitAlly(Target,GetLocalPlayer()) or IsObserver(GetLocalPlayer())then
    set fx="effects\\BlackTide.mdx"
    call ShowImage(i,true)
  else
    call ShowImage(i,false)
  endif
  call SetImageColor(i,255,0,0,255)
  call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'o00G',x,y,0),'BTLF',5)
  call TriggerRegisterTimerEvent(t,duration,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function Admiral_XMark_Return))
  call SaveImageHandle(HY,h,185,i)
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(fx,Target,"overhead"))
  call SaveUnitHandle(HY,h,2,Source)
  set Source=null
  set Target=null
  set i=null
  set t=null
endfunction

function Admiral_XMark_Learn takes nothing returns nothing
  call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A13D',false)
  call UnitAddAbility2(GetTriggerUnit(),'A13D')
endfunction

function Admiral_XMark_Effectsup takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or IsBlocked(GetSpellTargetUnit())==false then
    call Admiral_XMark_Effect()
  endif
endfunction

function Admiral_XMark_OnCastsup takes nothing returns nothing
  if(LoadBoolean(HY,(GetHandleId(GetOwningPlayer(GetSpellTargetUnit()))),(139)))and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
  elseif IsMagicImmune(GetSpellTargetUnit()) and IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot target magic immune enemies")
  endif
endfunction

function JAE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer B78=1
  local player p
  local real d
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer JBE=LoadInteger(HY,h,136)
  local integer DP9=LoadInteger(HY,h,188)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>DP9 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    loop
      exitwhen B78>JBE
      set p=LoadPlayerHandle(HY,h,1300+B78)
      set d=LoadReal(HY,h,1200+B78)
      if p==null then
        set B78=JBE
      else
        call SetWidgetLife(Target,RMaxIF(1,GetWidgetLife(Target)-d/DP9))
      endif
      set B78=B78+1
    endloop
  endif
  set t=null
  set p=null
  set Target=null
  return false
endfunction

function JCE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,17)
  local player p=LoadPlayerHandle(HY,h,54)
  local trigger J3E=LoadTriggerHandle(HY,h,135)
  local integer B78=GetTriggerEvalCount(t)
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call TriggerRegisterTimerEvent(J3E,1,true)
    call TriggerAddCondition(J3E,Condition(function JAE))
    call UnitRemoveAbility(Target,'B09U')
  elseif IsRealDamage then
    set h=GetHandleId(J3E)
    call SetWidgetLife(Target,GetWidgetLife(Target)+.5*GetEventDamage())
    call SavePlayerHandle(HY,h,1300+B78,GetOwningPlayer(GetEventDamageSource()))
    call SaveReal(HY,h,1200+B78,.5*GetEventDamage()*1.)
    call SaveInteger(HY,h,136,B78)
  endif
  set t=null
  set Target=null
  set p=null
  set J3E=null
  return false
endfunction

function J6E takes nothing returns nothing
  local unit Source=DB8
  local unit Target=GetEnumUnit()
  local integer Level=DC8
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer DP9=10
  local trigger J3E=CreateTrigger()
  call AddTimedAbility(Target,'A126',1,DP9)
  call UnitMakeAbilityPermanent(Target,true,'A126')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A126',false)
  call TriggerRegisterTimerEvent(t,DP9+.01,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function JCE))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(Source)))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveTriggerHandle(HY,h,(135),(J3E))
  call SaveUnitHandle(HY,(GetHandleId(J3E)),17,(Target))
  call SaveInteger(HY,(GetHandleId(J3E)),(188),(DP9))
  set Source=null
  set Target=null
  set t=null
  set J3E=null
endfunction

function JLE takes nothing returns boolean
  if(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitInGroup(GetFilterUnit(),DA8)==false then
    call GroupAddUnit(DA8,GetFilterUnit())
    return true
  endif
  return false
endfunction

function J1E takes nothing returns nothing
  local unit Source=DB8
  local unit Target=GetEnumUnit()
  local integer Level=DC8
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A13X')
  call IssueTargetOrderById(Caster,852095,Target)
  call DamageTarget(Source,Target,1,300+100*Level)
  set Source=null
  set Target=null
  set Caster=null
endfunction

function J0E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local unit J5E
  local real a=(LoadReal(HY,h,(13)))
  local real SourceX=GetUnitX(Projectile)
  local real SourceY=GetUnitY(Projectile)
  local real TargetX=(LoadReal(HY,h,(66)))
  local real TargetY=(LoadReal(HY,h,(67)))
  local integer Count=GetTriggerEvalCount(t)
  local real AO8=SafeX50(TargetX+13.33*Count*Cos(a))
  local real AP8=SafeY50(TargetY+13.33*Count*Sin(a))
  local integer Level=(LoadInteger(HY,h,5))
  local group AlreadyHit=(LoadGroupHandle(HY,h,(187)))
  local group g
  if Count<19 then
    call SetUnitVertexColor(Projectile,255,255,255,5+Count*10)
    set J5E=(LoadUnitHandle(HY,h,(186)))
    call SetUnitVertexColor(J5E,255,255,255,5+Count*10)
  elseif Count<125 then
    call SetUnitVertexColor(Projectile,255,255,255,190)
  elseif Count<150 then
  endif
  set g=GetAvailableGroup()
  set DA8=AlreadyHit
  set tt_unit1=Projectile
  set DB8=Projectile
  set DC8=Level
  call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),425,Condition(function JLE))
  call ForGroup(g,function J6E)
  call KillGroup(g)
  call SetUnitX(Projectile,AO8)
  call SetUnitY(Projectile,AP8)
  if Count==140 then
    set J5E=(LoadUnitHandle(HY,h,(186)))
    call KillUnit(J5E)
  elseif Count<140 then
    set J5E=(LoadUnitHandle(HY,h,(186)))
    call SetUnitX(J5E,AO8)
    call SetUnitY(J5E,AP8)
  endif
  if Count==150 then
    set g=GetAvailableGroup()
    set tt_unit1=Projectile
    call GroupEnumUnitsInRange(g,AO8,AP8,450,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function J1E)
    call KillGroup(g)
    call KillUnit(Projectile)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Projectile=null
  set J5E=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function Admiral_GhostShip takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real SourceX=GetUnitX(Hero)
  local real SourceY=GetUnitY(Hero)
  local real x0=GetSpellTargetX()
  local real y0=GetSpellTargetY()
  local real a
  local real x1
  local real y1
  local real x2
  local real y2
  local trigger t
  local integer h
  local integer Level
  local unit Projectile
  local unit J5E
  local string s=""
  local integer K8E='h06U'
  if GetRandomInt(0,5)==0 then
    set K8E='h0DJ'
  endif
  if IsPlayerAlly(GetOwningPlayer(Hero),GetLocalPlayer())or IsObserver(GetLocalPlayer())then
    set s="war3mapImported\\Whirlpool.mdx"
  endif
  if x0==GetUnitX(Hero)and y0==GetUnitY(Hero)then
    set x0=x0+50*Cos(GetUnitFacing(Hero)*bj_DEGTORAD)
    set y0=y0+50*Sin(GetUnitFacing(Hero)*bj_DEGTORAD)
  endif
  set a=Atan2(y0-SourceY,x0-SourceX)
  set x1=SourceX-1000*Cos(a)
  set y1=SourceY-1000*Sin(a)
  set x2=SourceX+1000*Cos(a)
  set y2=SourceY+1000*Sin(a)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set Level=GetUnitAbilityLevel(Hero,'A11K')
  set Projectile=CreateUnit(GetOwningPlayer(Hero),K8E,x1,y1,Atan2(y0-SourceY,x0-SourceX)*bj_RADTODEG)
  set J5E=CreateUnit(GetOwningPlayer(Hero),'h06V',x1,y1,Atan2(y0-SourceY,x0-SourceX)*bj_RADTODEG)
  call SetUnitVertexColor(Projectile,255,255,255,0)
  call SetUnitPathing(Projectile,false)
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveUnitHandle(HY,h,(186),(J5E))
  call SaveReal(HY,h,(66),((x1)*1.))
  call SaveReal(HY,h,(67),((y1)*1.))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call DestroyEffect(AddSpecialEffect(s,SafeX50(x2),SafeY50(y2)))
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function J0E))
  set Hero=null
  set t=null
  set Projectile=null
  set J5E=null
endfunction

function Kunkka_Torrent_Preload takes nothing returns nothing
  call PreloadQueryAdd('A11L')
endfunction


function Alchemist_Unstable_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call DamageTarget(group_temp_unit[0],t,2,group_temp_real[0])
    call StunTargetLod(t,group_temp_real[1])
  endif
  set t = null
  return false
endfunction

function KEE takes unit u, real duration, real x, real y, boolean b, integer level returns nothing
  set duration = duration/5.
  set group_temp_unit[0] = u
  set group_temp_real[0] = (60 + 70*level) * duration
  set group_temp_real[1] = (1 + 0.75*level)*duration
  call GroupEnumUnitsInRange(temp_group,x,y,200,Condition(function Alchemist_Unstable_Targets))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
  if b then
    call DamageTarget(u,u,2,group_temp_real[0])
    call StunTargetLod(u,group_temp_real[1])
  endif
endfunction

function KFE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real V19=LoadReal(HY,h,444)
  local real KGE=LoadReal(HY,h,445)
  local real a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Target),GetUnitY(Target))
  local real x=GetUnitX(Projectile)+18*Cos(a*bj_DEGTORAD)
  local real y=GetUnitY(Projectile)+18*Sin(a*bj_DEGTORAD)
  local integer lvl=LoadInteger(HY,h,0)
  call SetUnitX(Projectile,x)
  call SetUnitY(Projectile,y)
  if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<=18 or TimerGetElapsed(GlobalTimer)-KGE > (5.+.5) then
    call KillUnit(Projectile)
    call KEE(Source,V19,x,y,false,lvl)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  set Projectile=null
  return false
endfunction

function KHE takes unit Source,unit Target,real V19,real KGE, integer lvl returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0BD',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveReal(HY,h,444,V19*1.)
  call SaveReal(HY,h,445,KGE*1.)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function KFE))
  set Projectile=null
  set t=null
endfunction

function KIE takes string s,unit Target,unit Hero returns nothing
  local texttag tt=CreateTextTag()
  call SetTextTagPosUnit(tt,Target,64)
  call SetTextTagColor(tt,255,0,0,255)
  call SetTextTagVelocity(tt,0,.0355)
  call SetTextTagFadepoint(tt,.15)
  call SetTextTagPermanent(tt,false)
  call SetTextTagLifespan(tt,.65)
  if (IsUnitAlly(Hero,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))==false  then
    set s = ""
  endif
  call SetTextTagText(tt,s,.033)
  call SetTextTagVisibility(tt,true)
  set tt=null
endfunction

function KKE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real KGE=LoadReal(HY,h,442)
  local real Time=TimerGetElapsed(GlobalTimer)
  local real Y59=5.-(Time-KGE)
  local real YO8=RMinIF(Time-KGE,5.)
  local integer Count=LoadInteger(HY,h,34)+1
  local integer i
  local string s
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)
    call RestoreTint(Source)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A1NH' then
      if IsBlocked(GetSpellTargetUnit())==false then
        call KHE(Source,GetSpellTargetUnit(),YO8,KGE,lvl)
      endif
      if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)
      call RestoreTint(Source)
      call DestroyEffect(LoadEffectHandle(HY,h,32))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call SaveInteger(HY,h,34,Count)
    if Y59>=0 then
      set i = R2I(Y59)
      set s = I2S(i)
      if Y59 - i >= .5 then
        set s = s + ".5"
      endif
      set i = ModuloInteger(Count,2)*75
      call KIE(s,Source,Source)
      call SetTint(Source,255,100 + i,100 + i,-1)
    else
      call SetTint(Source,255,0,0,-1)
    endif
    if Time-KGE>(5.+.5)then
      call KEE(Source,5.,GetWidgetX(Source),GetWidgetY(Source),true,lvl)
      if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1NI' then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',true)
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',false)
      call RestoreTint(Source)
      call DestroyEffect(LoadEffectHandle(HY,h,32))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function Alchemist_UnstableConcoction takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local string s="war3mapImported\\UnstableConcoctionRangeDisplay3.mdx"
  if GetLocalPlayer()!=GetOwningPlayer(Source)then
    set s=""
  endif
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,442,TimerGetElapsed(GlobalTimer))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1NI'))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(s,Source,"origin"))
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function KKE))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NI',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1NH',true)
  call UnitAddAbility2(Source,'A1NH')
  call TriggerEvaluate(t)
  set Source=null
  set t=null
endfunction

function Alchemist_Greed_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer load = LoadInteger(MHT,info,0)
  call SaveInteger(MHT,load,'A0O3',LoadInteger(MHT,load,'A0O3') - LoadInteger(MHT,info,1))
  call Timer_End(t)
  set t = null
endfunction

function Alchemist_Greed_Start takes unit u, unit d, player p, integer level returns nothing
  local timer t = CreateTimer()
  local texttag text
  local integer h = GetHandleId(t)
  local integer hu = GetHandleId(u)
  local integer gold = 4 + 2*level + LoadInteger(MHT,hu,'A0O3')
  local boolean b=IsUnitType(d,UNIT_TYPE_HERO)
  if gold>4+8*level then
    set gold = 4+8*level
  endif
  if b then
    set text = CreateTextTag()
    call SetTextTagText(text,"+"+I2S(gold),.025)
    call SetTextTagPosUnit(text,d,0.3)
    call SetTextTagColor(text,255,220,0,255)
    call SetTextTagVelocity(text,0,.05)
    call SetTextTagVisibility(text,GetLocalPlayer()==p)
    call SetTextTagFadepoint(text,2)
    call SetTextTagLifespan(text,3)
    call SetTextTagPermanent(text,false)
    set text=null
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,gold + GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD))
  endif
  call SaveInteger(MHT,hu,'A0O3',3 + LoadInteger(MHT,hu,'A0O3'))//last bonus gold amount
  call SaveInteger(MHT,h,0,hu)
  call SaveInteger(MHT,h,1,3)
  call TimerStart(t,30,false,function Alchemist_Greed_End)
  set hu = GetHandleId(p)
  call SaveInteger(MHT,hu,'A0O3',LoadInteger(MHT,hu,'A0O3') + gold)//stats counter
  set t = null
endfunction

function Alchemist_Greed_Condition takes unit u, unit t returns nothing
  local player p = GetOwningPlayer(u)
  local integer level = GetUnitAbilityLevel(u,'P155') //A0O3
  if level > 0 and IsUnitEnemy(t,p) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(t)==false and (GetUnitAbilityLevel(t,'A04R')==0 or IsSiegeUnit(t)) and LoadReal(HeroStats,GetHandleId(p),30)< TimerGetElapsed(GlobalTimer) then
    call Alchemist_Greed_Start(u,t,p,level)
  endif
  set p=null
endfunction

function Alchemist_Acidspray_Targets takes nothing returns nothing
  local integer key
  local integer info
  local unit t = GetFilterUnit()
  
  if IsDead(t)==false and IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n0F5' then
    call GroupAddUnit(temp_group2,t)
    call DamageTarget(group_temp_unit[0],t,2,group_temp_integer[0])
    if IsUnitInGroup(t,group_temp_group)==false then
      set info = GetHandleId(t)
      set key = StringHash("acidspray_count")
      call LoDStat_Add(t,group_temp_integer[1],"armourneg")
      call SaveInteger(MHT,GetHandleId(t),StringHash("acidspray"),LoadInteger(MHT,GetHandleId(t),StringHash("acidspray")+group_temp_integer[1]))
      call Buff_Add(t,LoDBuff_AbilID[14],LoDBuff_BuffID[14],-1)
      call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1)
      set t = null
      return
    endif
    call GroupRemoveUnit(group_temp_group,t)
  endif
  
  set t = null
endfunction

function RemoveAcidSprayDebuff_Helper takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(MHT,h,2)
  if UA8(u)==false then
    call Buff_Remove(u,LoDBuff_BuffID[14])
    call LoDStat_Sub(u,LoadInteger(MHT,h,0),"armourneg")
    call DisableTrigger(t)
    call DestroyTrigger(t)
    call FlushChildHashtable(MHT,h)
  endif
  set u=null
  set t=null
  return false
endfunction

function Alchemist_Acidspray_Duration takes nothing returns nothing
  local unit u = null
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer key = StringHash("acidspray_count")
  local integer count = LoadInteger(MHT,info,0)
  local trigger tt
  local integer h
  set group_temp_integer[1] = LoadInteger(MHT,info,2) //armour reduction
  set group_temp_group = LoadGroupHandle(MHT,info,1)
  if count==17 then
    set count = LoadInteger(MHT,info,2)
    call DestroyEffect(LoadEffectHandle(MHT,info,2))
    loop
      set u = FirstOfGroup(group_temp_group)
      exitwhen u==null
      set info = GetHandleId(u)
      set count = LoadInteger(MHT,info,key)
      if UA8(u)==false then
        if count==1then
          call Buff_Remove(u,LoDBuff_BuffID[14])
        endif
        call SaveInteger(MHT,GetHandleId(u),StringHash("acidspray"),IMinBJ(LoadInteger(MHT,GetHandleId(u),StringHash("acidspray")-group_temp_integer[1]),0))
        call LoDStat_Sub(u,group_temp_integer[1],"armourneg")
      else
        set tt=CreateTrigger()
        call TriggerRegisterTimerEvent(tt,1,true)
        call TriggerAddCondition(tt,Condition(function RemoveAcidSprayDebuff_Helper))
        set h=GetHandleId(tt)
        call SaveInteger(MHT,h,0,group_temp_integer[1])
        call SaveUnitHandle(MHT,h,2,u)
        set tt=null
      endif
      call SaveInteger(MHT,info,key,count - 1)
      call GroupRemoveUnit(group_temp_group,u)
    endloop
    call KillGroup(group_temp_group)
    call Timer_End(t)
    set t = null
    return
  endif
  call SaveInteger(MHT,info,0,count + 1)
  set group_temp_player = LoadPlayerHandle(MHT,info,3)
  set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
  set group_temp_integer[0] = LoadInteger(MHT,info,1) //damage
  call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),650,Condition(function Alchemist_Acidspray_Targets))
  //removes the bonuses from any unit out of range
  loop
    set u = FirstOfGroup(group_temp_group)
    exitwhen u==null
    set info = GetHandleId(u)
    set count = LoadInteger(MHT,info,key)
    if count==1then
      call Buff_Remove(u,LoDBuff_BuffID[14])
    endif
    call SaveInteger(MHT,info,key,count - 1)
    call SaveInteger(MHT,info,StringHash("acidspray"),LoadInteger(MHT,info,StringHash("acidspray")-group_temp_integer[1]))
    call LoDStat_Sub(u,group_temp_integer[1],"armourneg")
    call GroupRemoveUnit(group_temp_group,u)
  endloop
  //updates the current group with the newly affected units
  loop
    set u = FirstOfGroup(temp_group2)
    exitwhen u==null
    call GroupRemoveUnit(temp_group2,u)
    call GroupAddUnit(group_temp_group,u)
  endloop
  set u=null
  set tt=null
  set t = null
endfunction

function Alchemist_Acidspray_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local integer level = GetUnitAbilityLevel(u,'A0IL')
  local integer info = GetHandleId(t)
  local real x = GetSpellTargetX()
  local real y = GetSpellTargetY()
  call SaveUnitHandle(MHT,info,0,u)
  call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
  call SaveEffectHandle(MHT,info,2,AddSpecialEffect("effects\\Radioactivecloud_2c.mdl",x,y))
  call SavePlayerHandle(MHT,info,3,GetOwningPlayer(u))
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,level*6 + 8)
  call SaveInteger(MHT,info,2,level + 3)
  call SaveReal(MHT,info,0,x)
  call SaveReal(MHT,info,1,y)
  call TimerStart(t,1,true,function Alchemist_Acidspray_Duration)
  set t = null
  set u = null
endfunction

function KLE takes nothing returns nothing
  call DamageTarget(D28,GetEnumUnit(),1,D58)
endfunction

function K1E takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0E3')
  local real Damage=(.35+.25*Level)*(GetUnitState(Target,UNIT_STATE_MAX_MANA)-GetUnitState(Target,UNIT_STATE_MANA))
  local group g=GetAvailableGroup()
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",Target,"chest"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SpiritOfVengeanceMissile\\SpiritOfVengeanceMissile.mdl",Target,"chest"))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\Enchantment.mdx",GetUnitX(Target),GetUnitY(Target)))
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),500+25,Condition(function LR8))
  set D58=Damage
  set D28=Hero
  call ForGroup(g,function KLE)
  call PlaySoundOnUnitBJ(NC,100,Target)
  call KillGroup(g)
  set Hero=null
  set Target=null
  set g=null
endfunction

function AM_ManaVoid takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call K1E()
  endif
endfunction

function MHE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Count=GetTriggerEvalCount(t)
  local integer MIE=R2I(((.9-.3)/ .5)/ .03)
  local integer MJE=R2I((175/ MIE))
  local integer MKE=R2I((255/ MIE)*1.75)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  if Count>MIE then
    call SetUnitVertexColor(Caster,255,255,255,0)
    call SetTint(Hero,-1,-1,-1,255)
    //call SetUnitVertexColor(Hero,255,255,255,255)
    call ShowUnit(Caster,false)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitVertexColor(Caster,255,255,255,175-MJE*Count)
    call SetUnitX(Caster,x)
    call SetUnitY(Caster,y)
    //call SetUnitVertexColor(Hero,255,255,255,MKE*Count)
    call SetTint(Hero,-1,-1,-1,MKE*Count)
  endif
  set t=null
  set Caster=null
  set Hero=null
  return false
endfunction

function AM_Blink takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),(293)))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  call SetUnitX(Caster,x)
  call SetUnitY(Caster,y)
  call SetUnitX(Hero,x)
  call SetUnitY(Hero,y)
  //call SetUnitVertexColor(Hero,255,255,255,0)
  call SetTint(Hero,-1,-1,-1,0)
  call SetUnitVertexColor(Caster,255,255,255,175)
  call SetUnitTimeScale(Caster,.5)
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function MHE))
  set Hero=null
  set Caster=null
  set t=null
endfunction

function AM_Blink_OnCast takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster
  local integer h=GetHandleId(Hero)
  local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  call SetUnitPathing(Hero,false)
  call UnitAddAbility2(Hero,'Aeth')
  set Caster=CreateUnit(GetOwningPlayer(Hero),'h06K',GetUnitX(Hero),GetUnitY(Hero),a)
  call BT8(Caster,5)
  call SetUnitPathing(Caster,false)
  call UnitAddAbility2(Caster,'Aeth')
  call UnitAddAbility2(Caster,'Aloc')
  call UnitAddAbility2(Caster,'A04R')
  call SetUnitVertexColor(Caster,255,255,255,0)
  call SetUnitX(Caster,x)
  call SetUnitY(Caster,y)
  call SetUnitX(Hero,x)
  call SetUnitY(Hero,y)
  call SetUnitAnimation(Caster,"Spell Throw")
  call SetUnitPathing(Hero,true)
  call UnitRemoveAbility(Hero,'Aeth')
  call SaveUnitHandle(HY,h,(293),(Caster))
  set Hero=null
  set Caster=null
endfunction

function AM_Blink_Preload takes nothing returns nothing
  call PreloadUnit('h06K')
endfunction

function MQE takes unit u,real x,real y,group HND, integer lvl returns nothing
  local group g=GetAvailableGroup()
  local unit u2
  call KillTrees(x,y,150)
  call GroupEnumUnitsInRange(g,x,y,150,Condition(function ReturnTrue))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    if(IsUnitInGroup(u2,HND)==false and IsUnitEnemy(u2,GetOwningPlayer(u)))then
      if(GetUnitAbilityLevel(u2,'A04R')!=1 and IsDead(u2)==false and IsUnitType(u2,UNIT_TYPE_STRUCTURE)==false)then
        call GroupAddUnit(HND,u2)
        call DamageTarget(u,u2,5,60+lvl*30)
        call AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",u2,"overhead")
      endif
    endif
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  set g=null
  set u2=null
endfunction

function MSE takes nothing returns nothing
  local integer h=GetHandleId(GetExpiredTimer())
  local unit MTE=LoadUnitHandle(HY,h,290)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real Ax=LoadReal(HY,h,284)
  local real Ay=LoadReal(HY,h,285)
  local real Cx=LoadReal(HY,h,286)
  local real Cy=LoadReal(HY,h,287)
  local real Bx=LoadReal(HY,h,288)
  local real By=LoadReal(HY,h,289)
  local real a=LoadReal(HY,h,137)
  local real b=1-a
  local boolean MUE=LoadBoolean(HY,h,291)
  local group HND=LoadGroupHandle(HY,h,133)
  local real MVE=RMaxBJ(DistanceBetweenXY(Ax,Ay,Cx,Cy)/ 1300,.4)
  call SetUnitX(MTE,SafeX50(Ax*a*a+Bx*2*a*b+Cx*b*b))
  call SetUnitY(MTE,SafeY50(Ay*a*a+By*2*a*b+Cy*b*b))
  call MQE(Hero,GetUnitX(MTE),GetUnitY(MTE),HND,LoadInteger(HY,h,0))
  if(MUE)then
    call SaveReal(HY,h,137,((a-.02/ MVE)*1.))
  else
    call SaveReal(HY,h,137,((a+.02/ MVE)*1.))
    call SaveReal(HY,h,284,GetUnitX(Hero))
    call SaveReal(HY,h,285,GetUnitY(Hero))
  endif
  if(a<0 and MUE)then
    call SaveBoolean(HY,h,291,false)
    call SaveReal(HY,h,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+LoadReal(HY,h,292)))*1.)
    call SaveReal(HY,h,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+LoadReal(HY,h,292)))*1.)
  endif
  if(a>1 and MUE==false)then
    call PauseTimer(GetExpiredTimer())
    call KillGroup(HND)
    call FlushChildHashtable(HY,h)
    call RemoveUnit(MTE)
    call DestroyTimer(GetExpiredTimer())
  endif
  set MTE=null
  set Hero=null
  set HND=null
endfunction

function Beastmaster_WildAxes takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real Ax=GetUnitX(u)
  local real Ay=GetUnitY(u)
  local real Cx=GetSpellTargetX()
  local real Cy=GetSpellTargetY()
  local unit a1=CreateUnit(GetOwningPlayer(u),'e01T',Ax,Ay,270.)
  local unit a2=CreateUnit(GetOwningPlayer(u),'e01T',Ax,Ay,270.)
  local integer h1
  local integer h2
  local timer t1=CreateTimer()
  local timer t2=CreateTimer()
  if GetSpellTargetUnit()!=null then
    set Cx=GetUnitX(GetSpellTargetUnit())
    set Cy=GetUnitY(GetSpellTargetUnit())
  endif
  call UnitAddAbility2(a1,'Amrf')
  call UnitRemoveAbility(a1,'Amrf')
  call SetUnitFlyHeight(a1,150,0)
  call UnitAddAbility2(a2,'Amrf')
  call UnitRemoveAbility(a2,'Amrf')
  call SetUnitFlyHeight(a2,150,0)
  set h1=GetHandleId(t1)
  call SaveUnitHandle(HY,h1,14,u)
  call SaveUnitHandle(HY,h1,290,a1)
  call SaveGroupHandle(HY,h1,133,GetAvailableGroup())
  call SaveReal(HY,h1,284,Ax*1.)
  call SaveReal(HY,h1,285,Ay*1.)
  call SaveReal(HY,h1,286,Cx*1.)
  call SaveReal(HY,h1,287,Cy*1.)
  call SaveReal(HY,h1,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)+45))*1.)
  call SaveReal(HY,h1,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)+45))*1.)
  call SaveReal(HY,h1,137,1.)
  call SaveReal(HY,h1,292,-45.)
  call SaveBoolean(HY,h1,291,true)
  set h2=GetHandleId(t2)
  call SaveUnitHandle(HY,h2,14,u)
  call SaveUnitHandle(HY,h2,290,a2)
  call SaveGroupHandle(HY,h2,133,GetAvailableGroup())
  call SaveReal(HY,h2,284,Ax*1.)
  call SaveReal(HY,h2,285,Ay*1.)
  call SaveReal(HY,h2,286,Cx*1.)
  call SaveReal(HY,h2,287,Cy*1.)
  call SaveReal(HY,h2,288,(Ax+300*Cos(Atan2(Cy-Ay,Cx-Ax)-45))*1.)
  call SaveReal(HY,h2,289,(Ay+300*Sin(Atan2(Cy-Ay,Cx-Ax)-45))*1.)
  call SaveReal(HY,h2,137,1.)
  call SaveReal(HY,h2,292,45.)
  call SaveBoolean(HY,h2,291,true)
  call SaveInteger(HY,h2,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call SaveInteger(HY,h1,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call TimerStart(t1,.025,true,function MSE)
  call TimerStart(t2,.025,true,function MSE)
  set u=null
  set a1=null
  set a2=null
  set t1=null
  set t2=null
endfunction


function M3E takes nothing returns nothing
  local real x=GetUnitX(GetEnumUnit())
  local real y=GetUnitY(GetEnumUnit())
  local real a=bj_RADTODEG*Atan2(y-TJ,x-tt_real1)
  local real M6E
  local real MLE
  local real abc
  if Sin((a-RJ)*bj_DEGTORAD)<0 then
    set abc=-90
  else
    set abc=90
  endif
  set M6E=GetUnitX(GetEnumUnit())+15*Cos((RJ+abc)*bj_DEGTORAD)
  set MLE=GetUnitY(GetEnumUnit())+15*Sin((RJ+abc)*bj_DEGTORAD)
  call SetUnitPosition(GetEnumUnit(),M6E,MLE)
  call SetUnitFacingTimed(GetEnumUnit(),RJ-abc,.3)
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
    call SaveBoolean(HeroStats,GetHandleId(GetEnumUnit()),99,true)
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GetEnumUnit(),"origin"))
endfunction

function M1E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real a=LoadReal(HY,h,13)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local group g=LoadGroupHandle(HY,h,22)
  if GetTriggerEvalCount(t)>20 then
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt_real1=x
    set TJ=y
    set RJ=a
    call ForGroup(g,function M3E)
  endif
  set t=null
  set g=null
  return false
endfunction

function M0E takes nothing returns nothing
  call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
endfunction

function M5E takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0O2')
  local unit Caster
  local real a=bj_RADTODEG*Atan2(GetUnitY(Target)-GetUnitY(Hero),GetUnitX(Target)-GetUnitX(Hero))
  local real x
  local real y
  local group g=GetAvailableGroup()
  local group g2=GetAvailableGroup()
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A289')
  endif
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveReal(HY,h,13,a*1.)
  call SaveReal(HY,h,6,GetUnitX(Hero))
  call SaveReal(HY,h,7,GetUnitY(Hero))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function M1E))
  set x=GetUnitX(Hero)+50*Cos(a*bj_DEGTORAD)
  set y=GetUnitY(Hero)+50*Sin(a*bj_DEGTORAD)
  call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
  call GroupAddGroup(g2,g)
  call GroupClear(g2)
  set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)
  call UnitApplyTimedLife(Caster,'BTLF',1)
  call UnitAddAbility2(Caster,'A0NY')
  call SetUnitAbilityLevel(Caster,'A0NY',Level)
  call IssueImmediateOrderById(Caster,852096)
  set x=GetUnitX(Hero)+250*Cos(a*bj_DEGTORAD)
  set y=GetUnitY(Hero)+250*Sin(a*bj_DEGTORAD)
  call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
  call GroupAddGroup(g2,g)
  call GroupClear(g2)
  set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)
  call UnitApplyTimedLife(Caster,'BTLF',1)
  call UnitAddAbility2(Caster,'A0NY')
  call SetUnitAbilityLevel(Caster,'A0NY',Level)
  call IssueImmediateOrderById(Caster,852096)
  set x=GetUnitX(Hero)+450*Cos(a*bj_DEGTORAD)
  set y=GetUnitY(Hero)+450*Sin(a*bj_DEGTORAD)
  call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
  call GroupAddGroup(g2,g)
  call GroupClear(g2)
  set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)
  call UnitApplyTimedLife(Caster,'BTLF',1)
  call UnitAddAbility2(Caster,'A0NY')
  call SetUnitAbilityLevel(Caster,'A0NY',Level)
  call IssueImmediateOrderById(Caster,852096)
  if GetUnitAbilityLevel(Hero,'A0O2')==0 then
    set x=GetUnitX(Hero)+650*Cos(a*bj_DEGTORAD)
    set y=GetUnitY(Hero)+650*Sin(a*bj_DEGTORAD)
    call GroupEnumUnitsInRange(g2,x,y,275,Condition(function LR8))
    call GroupAddGroup(g2,g)
    call GroupClear(g2)
    set Caster=CreateUnit(GetOwningPlayer(Hero),'o00Y',x,y,a)
    call UnitApplyTimedLife(Caster,'BTLF',1)
    call UnitAddAbility2(Caster,'A0NY')
    call SetUnitAbilityLevel(Caster,'A0NY',Level)
    call IssueImmediateOrderById(Caster,852096)
  endif
  call KillGroup(g2)
  call GroupRemoveUnit(g,Target)
  set tt_real1=150+50*Level
  set tt_unit1=Hero
  call ForGroup(g,function M0E)
  //call KillGroup(g)
  set t=null
  set Hero=null
  set Target=null
  set Caster=null
  set g=null
  set g2=null
endfunction

function Beastmaster_PrimalRoar takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call M5E()
  endif
endfunction


function N4E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call UnitRemoveAbility(Source,'A140')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Beastmaster_HawkInvis takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call UnitAddAbility2(Source,'A140')
  call TriggerRegisterTimerEvent(t,6,false)
  call TriggerAddCondition(t,Condition(function N4E))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=null
  set Source=null
endfunction

function NDE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit NEE=(LoadUnitHandle(HY,h,2))
  local real LastX=(LoadReal(HY,h,6))
  local real LastY=(LoadReal(HY,h,7))
  local real NHE=GetUnitX(NEE)
  local real NIE=GetUnitY(NEE)
  call SaveReal(HY,h,6,((NHE)*1.))
  call SaveReal(HY,h,7,((NIE)*1.))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if LastX==NHE and LastY==NIE then
      if GetUnitAbilityLevel(NEE,'A1WG')==0 then
        call UnitAddAbility2(NEE,'A1WG')
      endif
    else
      if GetUnitAbilityLevel(NEE,'A1WG')>0 then
        call UnitRemoveAbility(NEE,'A1WG')
      endif
    endif
  endif
  set t=null
  set NEE=null
  return false
endfunction

function Beastmaster_CallOfTheWild_Learned takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer level = GetUnitAbilityLevel(u,'A0OO')
  if(level==1)then
    call UnitAddAbility2(u,'A300')
    call UnitAddAbility2(u,'A301')
  endif
  call SetUnitAbilityLevel(u,'A300',level)
  call SetUnitAbilityLevel(u,'A301',level)
  set u=null
endfunction

function Beastmaster_CallBeast takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer i=GetUnitAbilityLevel(u,'A301')
  local group g
  local unit boar=null
  local integer id
  if GetUnitTypeId(u)=='e00E' then
    set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  endif
  if i==1 then
    set id='h30A'
  elseif i==2 then
    set id='n01M'
  elseif i==3 then
    set id='n01S'
  else
    set id='h30B'
  endif
  set boar=CreateUnit(GetOwningPlayer(u),id,GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
  call UnitApplyTimedLife(boar,'BTLF',60)
  set boar=null
  set u=null
endfunction

function Beastmaster_CallHawk takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer i=GetUnitAbilityLevel(u,'A300')
  local trigger t
  local integer h
  local unit hawk
  local integer id
  if GetUnitTypeId(u)=='e00E' then
    set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  endif
  if i==1 then
    set id='h308'
  elseif i==2 then
    set id='n01Q'
  elseif i==3 then
    set id='n01R'
  else
    set id='h309'
  endif
  set hawk=CreateUnit(GetOwningPlayer(u),id,GetUnitX(u),GetUnitY(u),GetUnitFacing(u))
  call UnitApplyTimedLife(hawk,'BTLF',60)
  if i>2 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.05,true)
    call TriggerRegisterUnitEvent(t,hawk,EVENT_UNIT_DEATH)
    call SaveReal(HY,h,6,((GetUnitX(hawk))*1.))
    call SaveReal(HY,h,7,((GetUnitY(hawk))*1.))
    call SaveUnitHandle(HY,h,2,(hawk))
    call TriggerAddCondition(t,Condition(function NDE))
    set t=null
  endif
  set u=null
  set hawk=null
endfunction

function NME takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer h=GetHandleId(Source)
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local integer Level=(LoadInteger(HY,h,5))
  local texttag tt=CreateTextTag()
  local integer W98
  local integer i=1
  local unit u
  local player p2
  if Level==1 then
    set W98=150
  elseif Level==2 then
    set W98=200
  else
    set W98=250
  endif
  call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD)+W98)
  call SetTextTagText(tt,"+"+I2S(W98),.025)
  call SetTextTagPosUnit(tt,udg_Hero[GetPlayerId(p)],100)
  call SetTextTagColor(tt,255,220,0,255)
  call SetTextTagVelocity(tt,0,.03)
  call SetTextTagVisibility(tt,GetLocalPlayer()==p)
  call SetTextTagFadepoint(tt,2)
  call SetTextTagLifespan(tt,3)
  call SetTextTagPermanent(tt,false)
  set ReliableGold[GetPlayerId(p)]=ReliableGold[GetPlayerId(p)]+W98
  //set E48=E48+W98
  set TrackBonusBounty[GetPlayerId(p)]=TrackBonusBounty[GetPlayerId(p)]+W98
  if Level==1 then
    set W98=50
  elseif Level==2 then
    set W98=100
  else
    set W98=150
  endif
  loop
    exitwhen i>5
    if IsSentinel(p)then
      set p2=Sentinels[i]
    else
      set p2=Scourges[i]
    endif
    if p2!=p then
      set u=udg_Hero[GetPlayerId(p2)]
      if DistanceBetweenUnits(u,Source)<950 then
        set tt=CreateTextTag()
        call SetPlayerState(p2,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p2,PLAYER_STATE_RESOURCE_GOLD)+W98)
        call SetTextTagText(tt,"+"+I2S(W98),.025)
        call SetTextTagPosUnit(tt,u,100)
        call SetTextTagColor(tt,255,220,0,255)
        call SetTextTagVelocity(tt,0,.03)
        call SetTextTagVisibility(tt,GetLocalPlayer()==p2)
        call SetTextTagFadepoint(tt,2)
        call SetTextTagLifespan(tt,3)
        call SetTextTagPermanent(tt,false)
        set ReliableGold[GetPlayerId(p2)]=ReliableGold[GetPlayerId(p2)]+W98
        //set E48=E48+W98
        set TrackBonusBounty[GetPlayerId(p2)]=TrackBonusBounty[GetPlayerId(p2)]+W98
      endif
    endif
    set i=i+1
  endloop
  set Source=null
  set p=null
  set p2=null
  set u=null
  set tt=null
endfunction

function BH_TrackKill takes unit victim returns nothing
  if LoadReal(HY,GetHandleId(victim),314) > TimerGetElapsed(GlobalTimer) then
    call NME()
  endif
endfunction

function NOE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Caster=LoadUnitHandle(HY,h,19)
  call SetUnitX(Caster,GetUnitX(Target))
  call SetUnitY(Caster,GetUnitY(Target))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEvalCount(t)>10 and GetUnitAbilityLevel(Target,'B00L')==0) or GetTriggerEvalCount(t)>LoadInteger(HY,h,0) then
    call UnitRemoveAbility(Target,'A312')
    call SaveReal(HY,GetHandleId(Target),314,0)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set Caster=null
  return false
endfunction

function Bounty_Track takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e01V',GetUnitX(Target),GetUnitY(Target),0)
  local string FX="war3mapImported\\TrackBuff.mdx"
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Target))and IsObserver(GetLocalPlayer())==false then
    set FX=""
  endif
  call UnitAddAbility2(Caster,'A115')
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,GetSpellTargetUnit(),EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function NOE))
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(FX,Target,"overhead"))
  if GetSpellAbilityId()=='A0B4' then
    call SaveReal(HY,GetHandleId(GetSpellTargetUnit()),314,(TimerGetElapsed(GlobalTimer)+30)*1.)
    call SaveInteger(HY,h,0,30*10)
  else
    call SaveReal(HY,GetHandleId(GetSpellTargetUnit()),314,(TimerGetElapsed(GlobalTimer)+20)*1.)
    call SaveInteger(HY,h,0,20*10)
  endif
  call SavePlayerHandle(HY,GetHandleId(GetSpellTargetUnit()),54,GetOwningPlayer(GetTriggerUnit()))
  call SaveInteger(HY,GetHandleId(GetSpellTargetUnit()),5,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  call UnitAddAbility2(Target,'A312')
  call UnitMakeAbilityPermanent(Target,true,'A311')
  call SetPlayerAbilityAvailable(GetOwningPlayer(Target),'A312',false)
  call ShareVision(Target,Source,'A312')
  call DetectMagicDispell(Target,'A312','B00L')
  set t=null
  set Target=null
  set Source=null
  set Caster=null
endfunction

function NRE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,17)
  call UnitRemoveAbility(Target,'A1IW')
  call UnitRemoveAbility(Target,'B0CA')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Target=null
  return false
endfunction

function NSE takes unit Source,unit Target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,3,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function NRE))
  call SaveUnitHandle(HY,h,17,(Target))
  call UnitAddAbility2(Target,'A1IW')
  call UnitMakeAbilityPermanent(Target,true,'A1IW')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A1IW',false)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HumanBloodKnight.mdl",Target,"chest"))
  if LoadBoolean(MHT,GetHandleId(GetOwningPlayer(Source)),4)then
    //call Passive_Cooldown(Source,'A1IQ',GetUnitAbilityLevel(Source,'A1IQ'))
  endif
  set t=null
endfunction

function NTE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,30)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and(GetEventDamage()>40 or IsUnitType(Target,UNIT_TYPE_STRUCTURE) or GetUnitTypeId(Target)=='umtw' or GetUnitTypeId(Target)=='ebal')and(LoadBoolean(HY,(GetHandleId(Source)),('A1IQ'+183))) then
      call NSE(Source,Target)
      call SaveBoolean(HY,GetHandleId(Source),'A1IQ'+183,false)
      call SaveReal(HY,GetHandleId(Source),'A1IQ'+184,TimerGetElapsed(GlobalTimer)*1.)
      call UnitRemoveAbility(Source,'A1IS')
      call UnitRemoveAbility(Source,'A1J4')
      call UnitRemoveAbility(Source,'A1J3')
      call UnitRemoveAbility(Source,'A1J5')
      call UnitRemoveAbility(Source,'A1IU')
      call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(HY,h,35)))
      call CleanTrigger(LoadTriggerHandle(HY,h,35))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function JinadaASFixSup takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call UnitRemoveAbility(u,'A1J4')
  call UnitRemoveAbility(u,'A1J3')
  call UnitRemoveAbility(u,'A1J5')
  call UnitRemoveAbility(u,'A1IU')
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set u=null
endfunction

function JinadaASFix takes unit u returns nothing
  local timer t=CreateTimer()
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call TimerStart(t,0.2,false,function JinadaASFixSup)
  set t=null
endfunction

function NUE takes nothing returns boolean
  local trigger t
  local integer h
  local unit Target
  local unit Source
  local integer Level
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),'A1IQ'+183,false)
    call SaveReal(HY,GetHandleId(GetTriggerUnit()),'A1IQ'+184,TimerGetElapsed(GlobalTimer)*1.)
    call UnitRemoveAbility(GetTriggerUnit(),'A1IS')
    call UnitRemoveAbility(GetTriggerUnit(),'A1J4')
    call UnitRemoveAbility(GetTriggerUnit(),'A1J3')
    call UnitRemoveAbility(GetTriggerUnit(),'A1J5')
    call UnitRemoveAbility(GetTriggerUnit(),'A1IU')
    call FlushChildHashtable(HY,GetHandleId(GetTriggeringTrigger()))
    call CleanTrigger(GetTriggeringTrigger())
  elseif GetAttacker()==(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),182))then
    if IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      set Target=GetTriggerUnit()
      set Source=GetAttacker()
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
      call TriggerRegisterTimerEvent(t,2.5,false)
      call TriggerAddCondition(t,Condition(function NTE))
      call SaveUnitHandle(HY,h,30,(Target))
      call SaveUnitHandle(HY,h,2,Source)
      if IsRangedUnitHasOverAS(Source) then
        call JinadaASFix(Source)
      endif
      call SaveTriggerHandle(HY,h,35,GetTriggeringTrigger())
      set Level=GetUnitAbilityLevel(Source,'A524')
      if Level==0 then
        call UnitRemoveAbility(Source,'A1J4')
        call UnitRemoveAbility(Source,'A1J3')
        call UnitRemoveAbility(Source,'A1J5')
        call UnitRemoveAbility(Source,'A1IU')
      elseif Level==1 then
        call UnitRemoveAbility(Source,'A1J3')
        call UnitRemoveAbility(Source,'A1J5')
        call UnitRemoveAbility(Source,'A1IU')
      elseif Level==2 then
        call UnitRemoveAbility(Source,'A1J4')
        call UnitRemoveAbility(Source,'A1J5')
        call UnitRemoveAbility(Source,'A1IU')
      elseif Level==3 then
        call UnitRemoveAbility(Source,'A1J4')
        call UnitRemoveAbility(Source,'A1J3')
        call UnitRemoveAbility(Source,'A1IU')
      elseif Level==4 then
        call UnitRemoveAbility(Source,'A1J4')
        call UnitRemoveAbility(Source,'A1J3')
        call UnitRemoveAbility(Source,'A1J5')
      endif
      set Target=null
      set Source=null
      set t=null
    endif
  endif
  return false
endfunction

function NVE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real YP8=TimerGetElapsed(GlobalTimer)
  local integer Level=GetUnitAbilityLevel(Hero,'A524')
  local real JSE=LoadReal(HY,GetHandleId(Hero),'A1IQ'+184)
  local boolean NWE=LoadBoolean(HY,GetHandleId(Hero),'A1IQ'+183)
  if GetUnitAbilityLevel(Hero,'A1IQ')>0 and GetUnitAbilityLevel(Hero,'A1IQ')!=Level then
    call SetUnitAbilityLevel(Hero,'A1IQ',Level)
  endif
  if YP8-JSE>14-Level*2 and NWE==false and isPlayerPickedAbility(GetOwningPlayer(Hero),31*4+2) and IsDead(Hero)==false then
    call SaveBoolean(HY,GetHandleId(Hero),'A1IQ'+183,true)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function NUE))
    call SaveUnitHandle(HY,h,182,Hero)
    call UnitAddAbility2(Hero,'A1IS')
    if GetUnitAbilityLevel(Hero,'B068')==0 then
      if Level==1 then
        call UnitAddAbility2(Hero,'A1J4')
        call UnitMakeAbilityPermanent(Hero,true,'A1J2')
        if Mode_EB and (GetUnitAbilityLevel(Hero,'A0CY')>0 or GetUnitAbilityLevel(Hero,'QP1K')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then
          call SetUnitAbilityLevel(Hero,'A1J2',2)
        endif
      elseif Level==2 then
        call UnitAddAbility2(Hero,'A1J3')
        call UnitMakeAbilityPermanent(Hero,true,'A1IT')
        if Mode_EB and (GetUnitAbilityLevel(Hero,'A0CY')>0 or GetUnitAbilityLevel(Hero,'QP1K')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then
          call SetUnitAbilityLevel(Hero,'A1IT',2)
        endif
      elseif Level==3 then
        call UnitAddAbility2(Hero,'A1J5')
        call UnitMakeAbilityPermanent(Hero,true,'A1J1')
        if Mode_EB and (GetUnitAbilityLevel(Hero,'A0CY')>0 or GetUnitAbilityLevel(Hero,'QP1K')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER))) then
          call SetUnitAbilityLevel(Hero,'A1J1',2)
        endif
      elseif Level==4 then
        call UnitAddAbility2(Hero,'A1IU')
        call UnitMakeAbilityPermanent(Hero,true,'A1J0')
        if Mode_EB and (GetUnitAbilityLevel(Hero,'A0CY')>0 or GetUnitAbilityLevel(Hero,'QP1K')>0 or (GetUnitAbilityLevel(Hero,'Y315')>0 and IsUnitType(Hero,UNIT_TYPE_MELEE_ATTACKER)))  then
          call SetUnitAbilityLevel(Hero,'A1J0',2)
        endif
      endif
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J4',false)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J3',false)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1J5',false)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A1IU',false)
  elseif NWE==false and GetUnitAbilityLevel(Hero,'B068')==0 then
    call UnitRemoveAbility(Hero,'A1IS')
    call UnitRemoveAbility(Hero,'A1J4')
    call UnitRemoveAbility(Hero,'A1J3')
    call UnitRemoveAbility(Hero,'A1J5')
    call UnitRemoveAbility(Hero,'A1IU')
  endif
  set t=null
  set Hero=null
  return false
endfunction

function Bounty_Jinada_Learn takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Hero,'A1IQ')
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function NVE))
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveInteger(HY,h,181,0)
  set Hero=null
  set t=null
endfunction

function Bounty_Jinada_LearnTrigger takes nothing returns nothing
  if IsUnitIllusion(GetTriggerUnit())==false then
    call Bounty_Jinada_Learn()
  endif
endfunction

function NZE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=GetUnitAbilityLevel(Source,'A07A')
  if Level<1 then
    set Level=GetUnitAbilityLevel(Source,'QB09')
  endif
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      if((LoadInteger(HY,(GetHandleId((Source))),((2487))))==1)==false then
        call AddTimedKeyToUnit(Source,2487,.5)
        if IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(Target,GetOwningPlayer(Source))then
          call DamageTarget(Source,Target,2,30*Level)
          call TextTagOnUnit(I2S(R2I(30*Level)),1,Source,.027,216,0,0,216)
        endif
      endif
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function NAE takes nothing returns nothing
  local trigger t=CreateTrigger()
  local unit Target=GetTriggerUnit()
  local unit Source=GetAttacker()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,2,false)
  call TriggerAddCondition(t,Condition(function NZE))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,2,(Source))
  set Target=null
  set Source=null
  set t=null
endfunction

function NBE takes nothing returns boolean
  local integer Level
  local unit Hero
  if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST or GetTriggerEventId()==EVENT_UNIT_DEATH then
    set Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(14)))
    //set Level=GetUnitAbilityLevel(Hero,'A1IQ')
    set Level=GetUnitAbilityLevel(GetAttacker(),'A524')
    if(LoadBoolean(HY,(GetHandleId(Hero)),('A1IQ'+183)))then
      set Level=GetUnitAbilityLevel(Hero,'A1IQ')
      if Level==0 then
        call UnitRemoveAbility(Hero,'A1J4')
        call UnitRemoveAbility(Hero,'A1J3')
        call UnitRemoveAbility(Hero,'A1J5')
        call UnitRemoveAbility(Hero,'A1IU')
      elseif Level==1 then
        call UnitRemoveAbility(Hero,'A1J3')
        call UnitRemoveAbility(Hero,'A1J5')
        call UnitRemoveAbility(Hero,'A1IU')
      elseif Level==2 then
        call UnitRemoveAbility(Hero,'A1J4')
        call UnitRemoveAbility(Hero,'A1J5')
        call UnitRemoveAbility(Hero,'A1IU')
      elseif Level==3 then
        call UnitRemoveAbility(Hero,'A1J4')
        call UnitRemoveAbility(Hero,'A1J3')
        call UnitRemoveAbility(Hero,'A1IU')
      elseif Level==4 then
        call UnitRemoveAbility(Hero,'A1J4')
        call UnitRemoveAbility(Hero,'A1J3')
        call UnitRemoveAbility(Hero,'A1J5')
      endif
    else
      call UnitRemoveAbility(Hero,'A1J4')
      call UnitRemoveAbility(Hero,'A1J3')
      call UnitRemoveAbility(Hero,'A1J5')
      call UnitRemoveAbility(Hero,'A1IU')
    endif
    call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
    call CleanTrigger(GetTriggeringTrigger())
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(14)))then
      if((LoadInteger(HY,(GetHandleId((GetAttacker()))),((2488))))==1)==false then
        call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
        call CleanTrigger(GetTriggeringTrigger())
        call NAE()
      endif
      if(LoadBoolean(HY,(GetHandleId(GetAttacker())),('A1IQ'+183)))then
        //set Level=GetUnitAbilityLevel(GetAttacker(),'A1IQ')
        set Level=GetUnitAbilityLevel(GetAttacker(),'A524')
        if Level==0 then
          call UnitRemoveAbility(GetAttacker(),'A1J4')
          call UnitRemoveAbility(GetAttacker(),'A1J3')
          call UnitRemoveAbility(GetAttacker(),'A1J5')
          call UnitRemoveAbility(GetAttacker(),'A1IU')
        elseif Level==1 then
          call UnitRemoveAbility(GetAttacker(),'A1J3')
          call UnitRemoveAbility(GetAttacker(),'A1J5')
          call UnitRemoveAbility(GetAttacker(),'A1IU')
        elseif Level==2 then
          call UnitRemoveAbility(GetAttacker(),'A1J4')
          call UnitRemoveAbility(GetAttacker(),'A1J5')
          call UnitRemoveAbility(GetAttacker(),'A1IU')
        elseif Level==3 then
          call UnitRemoveAbility(GetAttacker(),'A1J4')
          call UnitRemoveAbility(GetAttacker(),'A1J3')
          call UnitRemoveAbility(GetAttacker(),'A1IU')
        elseif Level==4 then
          call UnitRemoveAbility(GetAttacker(),'A1J4')
          call UnitRemoveAbility(GetAttacker(),'A1J3')
          call UnitRemoveAbility(GetAttacker(),'A1J5')
        endif
      else
        call UnitRemoveAbility(GetAttacker(),'A1J4')
        call UnitRemoveAbility(GetAttacker(),'A1J3')
        call UnitRemoveAbility(GetAttacker(),'A1J5')
        call UnitRemoveAbility(GetAttacker(),'A1IU')
      endif
    endif
  else
    set Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(14)))
    if(LoadBoolean(HY,(GetHandleId(Hero)),('A1IQ'+183)))==false then
      call UnitRemoveAbility(Hero,'A1J4')
      call UnitRemoveAbility(Hero,'A1J3')
      call UnitRemoveAbility(Hero,'A1J5')
      call UnitRemoveAbility(Hero,'A1IU')
    endif
    call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
    call CleanTrigger(GetTriggeringTrigger())
  endif
  set Hero=null
  return false
endfunction

function Bounty_Windwalk takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
  call AddTimedKeyToUnit(Source,2488,1.25-.25*Level-.01)
  call TriggerRegisterTimerEvent(t,10+5*Level,false)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_CAST)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function NBE))
  call SaveUnitHandle(HY,h,(14),(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call UnitAddAbility2(Source,'A1J4')
  call UnitAddAbility2(Source,'A1J3')
  call UnitAddAbility2(Source,'A1J5')
  call UnitAddAbility2(Source,'A1IU')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J4',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J3',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1J5',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1IU',false)
  set t=null
  set Target=null
  set Source=null
endfunction

function Bounty_ShurikenToss_Hit takes nothing returns nothing
  local unit caster=tt_unit1
  local unit target=tt_unit2
  local unit d
  local group g
  local group tg
  local unit u
  local integer jumpsleft
  local real dmg=0.
  local integer lvl
  local boolean bounce=false
  if LoadUnitHandle(MHT,GetHandleId(tt_unit1),'A004'+1)!=null then
    set caster=LoadUnitHandle(MHT,GetHandleId(tt_unit1),'A004'+1)
    set bounce=true
    call RemoveSavedHandle(MHT,GetHandleId(tt_unit1),'A004'+1)
  endif
  set g=LoadGroupHandle(MHT,GetHandleId(caster),'A004')
  set jumpsleft=LoadInteger(MHT,GetHandleId(caster),'A004')
  set lvl=GetUnitAbilityLevel(caster,'A004')
  set d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
  call UnitAddAbility(d,'A33J')
  call IssueTargetOrder(d,"thunderbolt",target)
  call GroupAddUnit(g,target)
  if bounce then
    set dmg=25+50*lvl
  else
    if lvl==1 then
      set dmg=125.
    elseif lvl==2 then
      set dmg=175.
    elseif lvl==3 then
      set dmg=250.
    else
      set dmg=325.
    endif
  endif
  call DamageTarget(caster,target,1,dmg)
  
  if jumpsleft>0 then
    set tg=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(tg,GetUnitX(target),GetUnitY(target),425,Condition(function NonImmuneVisibleEnemyFilter))
    call GroupRemoveGroup(g,tg)//remove already hit units
    set u=FirstOfGroup(tg)
    if u!=null then
      call AddProjectile(target,u,'h02K',"Bounty_ShurikenToss_Hit",1000,true)
      call SaveUnitHandle(MHT,GetHandleId(target),'A004'+1,caster)
      call SaveInteger(MHT,GetHandleId(caster),'A004',jumpsleft-1)
    else
      call KillGroup(g)
      call RemoveSavedInteger(MHT,GetHandleId(caster),'A004')
      call RemoveSavedHandle(MHT,GetHandleId(caster),'A004')
      
    endif
    call KillGroup(tg)
    set tg=null
  else
    call KillGroup(g)
    call RemoveSavedInteger(MHT,GetHandleId(caster),'A004')
    call RemoveSavedHandle(MHT,GetHandleId(caster),'A004')
    
  endif
  
  set caster=null
  set target=null
  set d=null
  set u=null
  set g=null
  set tg=null
endfunction

function Bounty_ShurikenToss takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h02K',"Bounty_ShurikenToss_Hit",1000,true)
    call SaveInteger(MHT,GetHandleId(GetTriggerUnit()),'A004',GetUnitAbilityLevel(GetTriggerUnit(),'A004')-1)
    call SaveGroupHandle(MHT,GetHandleId(GetTriggerUnit()),'A004',GetAvailableGroup())
  endif
endfunction


function Bristleback_Warpath_Remove takes unit u returns nothing
  local integer loopA = 0
  
  
  call UnitRemoveAbility(u,'E000')
  call UnitRemoveAbility(u,'E001')
  call UnitRemoveAbility(u,'E002')
  call UnitRemoveAbility(u,'E003')
  call UnitRemoveAbility(u,'E004')
endfunction

function Bristleback_Warpath_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer load = LoadInteger(MHT,info,0)
  local integer count = LoadInteger(MHT,load,'A0FV')-1
  local unit u = LoadUnitHandle(MHT,info,0)
  local integer oldspeed=LoadInteger(MHT,GetHandleId(u),'WARP')
  local integer speed
  local integer level=LoadInteger(MHT,GetHandleId(u),'WARL')
  local integer i=R2I(0.5*level*level+0.5*level+4)
  //call Bristleback_Warpath_Remove(u)
  if oldspeed>0 then
    call SubBonusMSPercent(u,oldspeed)
  endif
  set speed=i+(count)*level
  if(count>0)then
    call AddBonusMSPercent(u,speed)
    call SaveInteger(MHT,GetHandleId(u),'WARP',speed)
  else
    call SaveInteger(MHT,GetHandleId(u),'WARP',0)
    call UnitRemoveAbility(u,'A30P')
  endif
  
  call SaveInteger(MHT,load,'A0FV',count)
  call LoDStat_Sub(u,LoadInteger(MHT,info,1),"damage")
  
  call Timer_End(t)
  
  set t = null
  set u = null
endfunction

function Bristleback_Warpath_Start takes unit u, integer level returns nothing
  local timer t = null
  local integer save
  local integer speed
  local integer damage
  local integer info = GetHandleId(u)
  local integer count = LoadInteger(MHT,info,'A0FV')+1
  local integer i
  local integer oldspeed
  set damage = 15 + 5*level
  if count==5+level then
    return
  endif
  set t = CreateTimer()
  set save = GetHandleId(t)
  set speed=count*(level+2)
  if LoadInteger(MHT,info,'WARP')>0 then
    call SubBonusMSPercent(u,LoadInteger(MHT,info,'WARP'))
  endif
  call LoDStat_Add(u,damage,"damage")
  call SaveInteger(MHT,info,'A0FV',count)
  call SaveInteger(MHT,info,'WARP',speed)
  call SaveInteger(MHT,info,'WARL',level)
  call AddBonusMSPercent(u,speed)
  call SaveUnitHandle(MHT,save,0,u)
  call SaveInteger(MHT,save,0,info)
  call SaveInteger(MHT,save,1,damage)
  call TimerStart(t,14.,false,function Bristleback_Warpath_End)
  call UnitAddAbility2(u,'A30P')
  call UnitMakeAbilityPermanent(u,true,'A0EF')
  set t = null
endfunction

function Bristleback_Warpath_Condition takes unit u, integer spell returns nothing
  local integer level = GetUnitAbilityLevel(u,'A0FV')+GetUnitAbilityLevel(u,'QP1N')
  if level>0 and (spell=='A0FW' or spell=='A0GP' or Valid_Spell(spell)) then
    call Bristleback_Warpath_Start(u,level)
  endif
endfunction

function BB_Spray_Filter takes nothing returns boolean
  return AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function QuillSprayOff takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u
  local integer i=1
  local integer hu
  local integer offset=LoadInteger(HY,h,0)
  local real dmg
  loop
    exitwhen HaveSavedHandle(HY,h,i)==false
    set u=LoadUnitHandle(HY,h,i)
    set hu=GetHandleId(u)
    if hu <= 0 then
      set hu=LoadInteger(HY,h,i)
      call FlushChildHashtable(MHT,hu)
    else
      set dmg=RMaxIF(LoadReal(MHT,hu,offset)-LoadReal(HY,h,i),0)
      if dmg==0 then
        call RemoveSavedReal(MHT,hu,offset)
      else
        call SaveReal(MHT,hu,offset,dmg)
      endif
    endif
    set i=i+1
  endloop
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function myBB_Spray takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local integer lvl=GetUnitAbilityLevel(u,'A0GP')
  local unit dummy
  local unit u2
  local integer hu
  local real dmg
  local real stackeddmg
  local integer offset='A0GP'+GetPlayerId(GetOwningPlayer(u))
  local integer i=1
  if IsUnitType(u,UNIT_TYPE_HERO)==false and GetUnitUserData(u)!=1 then
    set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  endif
  set dummy=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  set dmg=lvl*20
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),650,Condition(function BB_Spray_Filter))
  call SaveInteger(HY,h,0,offset)
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    set hu=GetHandleId(u2)
    set stackeddmg=LoadReal(MHT,hu,offset)
    call SaveUnitHandle(HY,h,i,u2)
    call DamageTarget(dummy,u2,2,RMinIF(dmg+stackeddmg,400))
    call SaveReal(MHT,hu,offset,stackeddmg+(28+2*lvl))
    call SaveInteger(HY,h,i,hu)
    call SaveReal(HY,h,i,(28+2*lvl))
    set i=i+1
    call GroupRemoveUnit(g,u2)
  endloop
  call TimerStart(t,14,false,function QuillSprayOff)
  call KillGroup(g)
  set u=null
  set g=null
  set t=null
endfunction

function OQE takes nothing returns nothing
  call KillUnit(GetEnumUnit())
endfunction

function ORE takes nothing returns boolean
  return(GetUnitTypeId(GetFilterUnit())=='e02E')
endfunction

function OSE takes nothing returns boolean
  return(GetUnitUserData(GetEnumUnit())==4)
endfunction

function OTE takes nothing returns nothing
  local location YT9=GetUnitLoc(GetTriggerUnit())
  call SetUnitPositionLoc(GetEnumUnit(),YT9)
  if(OSE())then
    call IssueTargetOrderById(GetEnumUnit(),852662,GetSpellTargetUnit())
  else
    call IncUnitAbilityLevel(GetEnumUnit(),'A0FZ')
    call IssueTargetOrderById(GetEnumUnit(),852662,GetSpellTargetUnit())
    call SetUnitUserData(GetEnumUnit(),(GetUnitUserData(GetEnumUnit())+1))
  endif
  call RemoveLocation(YT9)
  set YT9=null
endfunction

function OUE takes nothing returns nothing
  local location YT9=GetUnitLoc(GetTriggerUnit())
  local location OVE=GetUnitLoc(GetSpellTargetUnit())
  local group OWE=GetAvailableGroup()
  if(GetUnitAbilityLevel(GetSpellTargetUnit(),'B02U')>0)then
    call GroupEnumUnitsOfPlayer(OWE,GetOwningPlayer(GetSpellTargetUnit()),Condition(function ORE))
    call ForGroup(OWE,function OTE)
  else
    call GroupEnumUnitsOfPlayer(OWE,GetOwningPlayer(GetSpellTargetUnit()),Condition(function ORE))
    call ForGroup(OWE,function OQE)
    call DisableTrigger(UG)
    call CreateNUnitsAtLocFacingLocBJ(1,'e02E',GetOwningPlayer(GetSpellTargetUnit()),YT9,OVE)
    call EnableTrigger(UG)
    call UnitAddAbility(bj_lastCreatedUnit,'A0FZ')
    call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0FZ',((GetUnitAbilityLevel(GetTriggerUnit(),'A0FW')*4)-3))
    call IssueTargetOrderById(bj_lastCreatedUnit,852662,GetSpellTargetUnit())
    call SetUnitUserData(bj_lastCreatedUnit,1)
  endif
  call KillGroup(OWE)
  call RemoveLocation(YT9)
  call RemoveLocation(OVE)
  set OWE=null
  set YT9=null
  set OVE=null
endfunction

function BB_Goo takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call OUE()
  endif
endfunction




function OZE takes unit Hero returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  call SetUnitUserData(Caster,1)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_EFFECT)
  call UnitAddAbility2(Caster,'A0GP')
  if GetUnitAbilityLevel(Hero,'A0GP')>0 then
    call SetUnitAbilityLevel(Caster,'A0GP',GetUnitAbilityLevel(Hero,'A0GP'))
  else
    call SetUnitAbilityLevel(Caster,'A0GP',4)
  endif
  //call SetUnitAbilityLevel(Caster,'A0GP',GetUnitAbilityLevel(Hero,'A0M3'))
  call IssueImmediateOrderById(Caster,852526)
  set Caster=null
endfunction

function OAE takes unit Hero,real damage returns nothing
  local integer h=GetHandleId(Hero)
  local real E89 = LoadReal(HY,h,278) + damage
  if E89 > 250 then
    call SaveReal(HY,h,278,0)
    call OZE(Hero)
  else
    call SaveReal(HY,h,278,E89)
  endif
endfunction

function BB_Bristleback_Act takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local unit Attacker=GetEventDamageSource()
  local real O3E=GetAngleBetweenUnits(Attacker,Hero)
  local real HFace=GetUnitFacing(Hero)
  local real OLE
  local real Damage=GetEventDamage()
  local real hp
  local real finalAngle
  local real life = GetWidgetLife(Hero)
  if(Damage>5)and life>0.405 and IsRealDamage and GetUnitAbilityLevel(Hero,'BNdo')==0 then
    if((HFace-O3E)<(-180.))then
      set OLE=(HFace-O3E+360)
    else
      if((HFace-O3E)>180.)then
        set OLE=(HFace-O3E-360)
      else
        set OLE=(HFace-O3E)
      endif
    endif
    set finalAngle=RAbsBJ(OLE)
    
    if finalAngle<=70 then
      set hp=((GetUnitAbilityLevel(Hero,'A0M3')+GetUnitAbilityLevel(Hero,'QP1M'))*.08+.08)*Damage
      call OAE(Hero,Damage-hp)
      call HealUnitFor(Hero,hp)
    elseif finalAngle<=110 then
      set hp=((GetUnitAbilityLevel(Hero,'A0M3')+GetUnitAbilityLevel(Hero,'QP1M'))*.04+.04)*Damage
      call HealUnitFor(Hero,hp)
    endif
  endif
  set Hero=null
  set Attacker=null
  return false
endfunction

function Bristleback_Bristleback_Learn takes nothing returns nothing
  local trigger t = CreateTrigger()
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function BB_Bristleback_Act))
  set t = null
endfunction

function BB_BB_Learn takes nothing returns nothing
  if IsUnitIllusion(GetTriggerUnit())==false then
    call Bristleback_Bristleback_Learn()
  endif
endfunction

function Centaur_Return takes unit attacker, unit target returns nothing
  local integer Level=GetUnitAbilityLevel(target,'P123')
  local real Damage
  if Level>0 then
    set Damage=(14+2*Level)+(.18+.08*Level)*GetHeroHighestStatValue(target)
    call DamageTarget(target,attacker,2,Damage)
  endif
endfunction

function Stampede_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  local group g = LoadGroupHandle(HY,group_temp_integer[0],1)
  
  if IsUnitInGroup(t,g)==false and IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n00L' then
    call GroupAddUnit(g,t)
    call Buff_Add(t,LoDBuff_AbilID[17],LoDBuff_BuffID[17],1.0+0.5*GetUnitAbilityLevel(u,'A2O4'))
    call DamageTarget(u,t,1,group_temp_integer[1])
  endif
  
  set g = null //dat gut :3
  set u = null
  set t = null
  return false
endfunction

function Stampede_Duration takes nothing returns boolean
  local trigger trig = GetTriggeringTrigger()
  local integer info = GetHandleId(trig)
  local integer count = LoadInteger(HY,info,0)
  local unit u = LoadUnitHandle(HY,info,0)
  local group g = LoadGroupHandle(HY,info,1)
  
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or count==76 then
    call SetUnitPathing(u,true)
    call UnitRemoveAbility(u,'A2O4')
    call UnitRemoveAbility(u,'B0GB')
    
    call DestroyEffect(LoadEffectHandle(HY,info,3))
    call DestroyEffect(LoadEffectHandle(HY,info,2))
    call KillGroup(g)
    
    call FlushChildHashtable(HY,info)
    call CleanTrigger(trig)
    
    set trig = null
    set u = null
    set g = null
    return false
  endif
  
  //set tt_unit1=u // I don't know if this is needed :S :Z /( .__.)/ \(.-.)/ \(.__. )\
  //its not, but da comment is too awesome to remove :D
  
  set group_temp_unit[0] = u
  set group_temp_integer[0] = info
  set group_temp_integer[1] = LoadInteger(HY,info,1)*GetHeroMainStatValue(u)
  call SaveInteger(HY,info,0,count+1)
  call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),175,Condition(function Stampede_Targets))
  
  set trig = null
  set u = null
  set g = null
  return false
endfunction

function Stampede_Start takes unit u, integer lvl returns nothing
  local trigger trig = CreateTrigger()
  local integer info = GetHandleId(trig)
  call SetUnitPathing(u,false)
  call UnitAddAbility2(u,'A2O4')
  call SetUnitAbilityLevel(u,'A2O4',lvl)
  call TriggerRegisterTimerEvent(trig,0.05,true)
  call TriggerRegisterDeathEvent(trig,u)
  call TriggerAddCondition(trig,Condition(function Stampede_Duration))
  call SaveUnitHandle(HY,info,0,u)
  call SaveGroupHandle(HY,info,1,GetAvailableGroup())
  call SaveEffectHandle(HY,info,2,AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",u,GetProperAttachPoint_Foot(u)))
  call SaveEffectHandle(HY,info,3,AddSpecialEffectTarget("war3mapImported\\SandBreathDamageSmall.mdx",u,GetProperAttachPoint_Foot(u)))
  call SaveInteger(HY,info,0,0)
  call SaveInteger(HY,info,1,3)
  set trig = null
endfunction

function Stampede_Allies takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  if (IsUnitType(t,UNIT_TYPE_HERO))!=null and IsUnitAlly(u,GetOwningPlayer(t)) and IsDead(t)==false and (IsRearmPicked(u)==false or LoadInteger(HY,GetHandleId(t),'STMP')!=1) then
    if t!=u then
      call AddTimedKeyToUnit(t,'STMP',45)
    endif
    call Stampede_Start(t,GetUnitAbilityLevel(u,'A2O6'))
  endif
  set t = null
  set u = null
  return false
endfunction

function Stampede_Cast takes nothing returns nothing
  local sound s = CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
  call StartSound(s)
  call KillSoundWhenDone(s)
  set group_temp_unit[0] = GetTriggerUnit()
  set group_temp_integer[0] = GetUnitAbilityLevel(group_temp_unit[0],'A2O6')
  call GroupEnumUnitsInRange(temp_group,0,0,99999,Condition(function Stampede_Allies))
  set s = null
endfunction

function Stampede_Init takes nothing returns nothing
  local sound s = CreateSound("abilities\\Spells\\Other\\Stampede\\StampedeCaster1.wav",false,false,false,10,10,"DefaultEAXON")
  call StartSound(s)
  call KillSoundWhenDone(s)
  set s = null
  
endfunction

function Centaur_Hoof_ForGroup takes nothing returns nothing
  call TriggerRegisterUnitEvent(Centaur_HoofStompTrigger,GetEnumUnit(),EVENT_UNIT_DAMAGED)
  call SaveInteger(HY,GetHandleId(Centaur_HoofStompTrigger),0,LoadInteger(HY,GetHandleId(Centaur_HoofStompTrigger),0)+1)
endfunction

function Centaur_Hoof_Group takes unit u returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),500,Condition(function ReturnTrue))
  call ForGroup(g,function Centaur_Hoof_ForGroup)
  call KillGroup(g)
  set g=null
endfunction

function Centaur_HoofStompHit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer c
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(),LoadReal(HY,h,0))
      set c=LoadInteger(HY,h,0)
      if c==1 then
        call FlushChildHashtable(HY,h)
        call DestroyTrigger(t)
        set Centaur_HoofStompTrigger=null
      else
        call SaveInteger(HY,h,0,c-1)
      endif
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
    set Centaur_HoofStompTrigger=null
  endif
  set t=null
endfunction

function Centaur_HoofStomp takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  call UnitAddAbility(d,'A42H')
  if true then
    set Centaur_HoofStompTrigger=CreateTrigger()
    set h=GetHandleId(Centaur_HoofStompTrigger)
    call Centaur_Hoof_Group(d)
    call TriggerRegisterTimerEvent(Centaur_HoofStompTrigger,0.02,false)
    call TriggerAddCondition(Centaur_HoofStompTrigger,Condition(function Centaur_HoofStompHit))
    call SaveUnitHandle(HY,h,0,d)
    call SaveReal(HY, h, 0, 1.75 + 0.25 * lvl)
    set t=null
    call IssueImmediateOrder(d,"stomp")
  endif
  set caster=null
  set d=null
endfunction

function Double_Edge_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = DoubleEdgeCaster
  
  if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then
    call DamageTarget(u,t,1,DoubleEdgeDamage)
  endif
  
  set u = null
  set t = null
  return false
endfunction

function Double_Edge_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit t = GetSpellTargetUnit()
  local real x = GetWidgetX(t)
  local real y = GetWidgetY(t)
  local group g=GetAvailableGroup()
  set DoubleEdgeCaster = u
  //set group_temp_integer[0] = 100 + GetUnitAbilityLevel(u,'A00L')*75
  set DoubleEdgeDamage=100 + GetUnitAbilityLevel(u,'A00L')*75
  call GroupEnumUnitsInRange(g,x,y,215,Condition(function Double_Edge_Targets))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\DoubleEdgeTarget.mdx",x,y))
  if GetWidgetLife(u)<DoubleEdgeDamage*.75 then
    set DoubleEdgeDamage = R2I(GetWidgetLife(u)/.75) - 10
  endif
  call DamageTarget(u,u,1,DoubleEdgeDamage)
  call KillGroup(g)
  set g=null
  set u = null
  set t = null
endfunction

function Double_Edge_Condtionsup takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\DoubleEdgeCaster.mdx",GetTriggerUnit(),"hand, right"))
endfunction

function Chen_Teleport_End takes nothing returns nothing
  local trigger t = GetTriggeringTrigger()
  local integer h = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,h,0)
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if IsPurge(GetSpellAbilityId()) and GetSpellTargetUnit()==u then
      call DestroyEffect(LoadEffectHandle(MHT,h,1))
      call FlushChildHashtable(MHT,h)
      call CleanTrigger(t)
    endif
  else
    call SetUnitX(u,LoadReal(MHT,h,0))
    call SetUnitY(u,LoadReal(MHT,h,1))
    call DestroyEffect(LoadEffectHandle(MHT,h,1))
    call FlushChildHashtable(MHT,h)
    call CleanTrigger(t)
  endif
  set t = null
  set u = null
endfunction

function Chen_Teleport_Start takes unit u, real x, real y, integer lvl returns nothing
  local trigger t = CreateTrigger()
  local integer h = GetHandleId(t)
  local integer delay=7-lvl
  call SaveUnitHandle(MHT,h,0,u)
  call SaveEffectHandle(MHT,h,1,AddSpecialEffectTarget("effects\\Test_of_Faith_FX.mdx",u,"overhead"))
  call SaveReal(MHT,h,0,x)
  call SaveReal(MHT,h,1,y)
  call TriggerRegisterTimerEvent(t,delay,false)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function Chen_Teleport_End))
  set t = null
endfunction

function PRE takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'Aeth')==1 and ((GetUnitAbilityLevel(GetFilterUnit(),'A0KO')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KQ')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KR')==1)or(GetUnitAbilityLevel(GetFilterUnit(),'A0KP')==1))
endfunction

function ChenSelfCastTest takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(tt_unit1) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitIllusion(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false
endfunction

function CreepTPToChenFinal takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit chen=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  else
    call SetUnitPosition(target,GetUnitX(chen)+GetRandomReal(50,100)*Cos(GetRandomReal(0,359)*bj_DEGTORAD),GetUnitY(chen)+GetRandomReal(50,100)*Sin(GetRandomReal(0,359)*bj_DEGTORAD))
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set chen=null
  set target=null
  set t=null
  return false
endfunction

function CreepTPToChen takes unit chen, unit target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer delay=7-GetUnitAbilityLevel(chen,'A0LV')
  call TriggerRegisterTimerEvent(t,delay,false)
  call TriggerRegisterUnitEvent(t,chen,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function CreepTPToChenFinal))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\Test_of_Faith_FX.mdx",target,"overhead"))
  call SaveUnitHandle(HY,h,0,chen)
  call SaveUnitHandle(HY,h,1,target)
  set t=null
endfunction

function Chen_Teleport_Condition takes nothing returns nothing
  local unit u = GetSpellTargetUnit()
  local unit chen=GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local integer lvl= GetUnitAbilityLevel(chen,'A2MC')
  local real x
  local real y
  local group g
  local unit u2
  if IsSentinel(p)then
    set x = GetRectCenterX(gg_rct_Hero_Creation_NE)
    set y = GetRectCenterY(gg_rct_Hero_Creation_NE)
  else
    set x = GetRectCenterX(gg_rct_Hero_Creation_UD)
    set y = GetRectCenterY(gg_rct_Hero_Creation_UD)
  endif
  if IsUnitType(u,UNIT_TYPE_HERO)and p!=GetOwningPlayer(chen)then
    if LoadBoolean(HY,GetHandleId(u),80) then
      call Error(GetOwningPlayer(chen),GetObjectName('n036'))
    elseif LoadBoolean(HY,GetHandleId(p),139)==false then
      call Chen_Teleport_Start(u,x,y,lvl)
    endif
  elseif u==chen then
    set g=GetAvailableGroup()
    set tt_unit1=chen
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function ChenSelfCastTest))
    loop
      set u2=FirstOfGroup(g)
      exitwhen u2==null
      call CreepTPToChen(chen,u2)
      call GroupRemoveUnit(g,u2)
    endloop
    call KillGroup(g)
  else
    call SetUnitX(u,x)
    call SetUnitY(u,y)
  endif
  set p=null
  set u = null
  set chen=null
endfunction

function Chen_Test_Start takes unit t returns nothing
  local unit u = GetTriggerUnit()
  local integer level = GetUnitAbilityLevel(u,'A0LV')
  local integer damage =0
  if level==4 then
    set damage=GetRandomInt(275,400)
  elseif level==3 then
    set damage=GetRandomInt(225,300)
  elseif level==2 then
    set damage=GetRandomInt(125,200)
  elseif level==1 then
    set damage=GetRandomInt(75,150)
  endif
  call DamageTarget(u,t,3,damage)
  call TextTagOnUnit(I2S(damage),1,t,0.023,255,255,0,216)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",t,"chest"))
  
  set u = null
endfunction

function Chen_Test_Condition takes nothing returns nothing
  local unit t = GetSpellTargetUnit()
  
  if IsBlocked(t)==false then
    call Chen_Test_Start(t)
  endif
  
  set t = null
endfunction

function Chen_Test_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  if GetUnitAbilityLevel(u,'A2MC')==0 then
    call UnitAddAbility2(u,'A2MC')
  endif
  call SetUnitAbilityLevel(u,'A2MC',GetUnitAbilityLevel(u,'A0LV'))
  set u = null
endfunction

function PME takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer lvl=(LoadInteger(HY,(h),(5)))
  local real dmg
  local integer hu
  set hu=LoadInteger(HY,h,0)
  call SaveReal(HY,hu,'AMPL',RMaxIF(LoadReal(HY,hu,'AMPL')-0.1-0.04*lvl,0))
  call FlushChildHashtable(HY,(h))
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function Chen_Penitence takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit target=GetSpellTargetUnit()
  local unit chen=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(chen,'A0KM')
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",chen,"chest"))
  call SaveInteger(HY,(h),(5),(lvl))
  call TriggerRegisterTimerEvent(t,7,false)
  call SaveInteger(HY,h,0,GetHandleId(target))
  call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+0.1+0.04*lvl)
  call TriggerAddCondition(t,Condition(function PME))
  set t=null
  set target=null
  set chen=null
endfunction

function Chen_AncientFilter takes nothing returns boolean
  return PRE() and IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)
endfunction

function Chen_CreepSteal takes unit target returns nothing
  local unit chen=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(chen,'A28T')
  local integer limit=lvl
  local integer i
  local integer anc
  local group g=GetAvailableGroup()
  local integer anclimit
  if IsUnitType(target,UNIT_TYPE_ANCIENT) then
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function Chen_AncientFilter))
    set anc=CountUnitsInGroup(g)
    set anclimit=IMinIF(R2I((GetUnitLevel(chen)-1)/5),3)
    if anc >= anclimit then
      call KillUnit(FirstOfGroup(g))
    endif
  endif
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(chen),Condition(function PRE))
  set i=CountUnitsInGroup(g)
  if i==limit then
    call KillUnit(GroupPickRandomUnit(g))
  endif
  call KillGroup(g)
  set g=null
  if GetPlayerId(GetOwningPlayer(chen))<7 then
    call UnitShareVision(target,Scourges[0],false)
    call UnitShareVision(target,Scourges[1],false)
    call UnitShareVision(target,Scourges[2],false)
    call UnitShareVision(target,Scourges[3],false)
    call UnitShareVision(target,Scourges[4],false)
    call UnitShareVision(target,Scourges[5],false)
  else
    call UnitShareVision(target,Sentinels[0],false)
    call UnitShareVision(target,Sentinels[1],false)
    call UnitShareVision(target,Sentinels[2],false)
    call UnitShareVision(target,Sentinels[3],false)
    call UnitShareVision(target,Sentinels[4],false)
    call UnitShareVision(target,Sentinels[5],false)
  endif
  call UnitRefillMana(target)
  if(lvl==1)then
    call UnitAddAbility2(target,'A0KO')
  elseif(lvl==2)then
    call UnitAddAbility2(target,'A0KQ')
  elseif(lvl==3)then
    call UnitAddAbility2(target,'A0KR')
  elseif(lvl==4)then
    call UnitAddAbility2(target,'A0KP')
  endif
  call UnitAddAbility2(target,'Aeth')
  call UnitAddAbility2(target,'A12G')
  set chen=null
endfunction

function PWE takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster
  if IsUnitEnemy(Target,GetOwningPlayer(Source))then
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
    call UnitAddAbility(Caster,'A069')
    call SetUnitAbilityLevel(Caster,'A069',GetUnitAbilityLevel(Source,'A28T'))
    call IssueTargetOrderById(Caster,852581,Target)
    call Chen_CreepSteal(Target)
  endif
  set Source=null
  set Target=null
  set Caster=null
endfunction

function Chen_HolyPersuation takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call PWE()
  endif
endfunction

function Chen_HolyPersuation_OnCast takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  if IsUnitEnemy(target,GetOwningPlayer(caster)) then
    if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) or IsUnitSpiritBear(target) then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),GetObjectName('n0K9'))
    elseif IsUnitType(target,UNIT_TYPE_ANCIENT) and IsUnitHaveAghanim(caster)==false then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),"Can persuate ancient creeps only when Aghanim scepter acquired!")
    endif
  endif
  set caster=null
  set target=null
endfunction

function PAE takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and GetWidgetLife(GetFilterUnit())>1)!=null
endfunction

function Chen_HandOfGod takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A0LT')
  local group g=GetAvailableGroup()
  local unit u2
  if lvl==0 then
    set lvl=GetUnitAbilityLevel(u,'A1CS')
  endif
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function PAE))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    if(IsUnitAlly(u2,GetOwningPlayer(u)))then
      call SetWidgetLife(u2,GetWidgetLife(u2)+100+100*lvl)
      call DestroyEffect(AddSpecialEffectTargetUnitBJ("chest",u2,"Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl"))
    endif
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  set g=GetAvailableGroup()
  set bj_groupEnumOwningPlayer=GetOwningPlayer(u)
  call GroupEnumUnitsInRect(g,GetWorldBounds(),filterGetUnitsInRectOfPlayer)
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    if(IsUnitType(u2,UNIT_TYPE_HERO)==false and GetUnitTypeId(u2)!='n00C')then
      call SetUnitLifePercentBJ(u2,100)
      call DestroyEffect(AddSpecialEffectTargetUnitBJ("chest",u2,"Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl"))
    endif
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  set g=null
  set u=null
  set u2=null
endfunction

function PCE takes nothing returns nothing
  if IsCourier(GetEnumUnit())==false then
    call DamageTarget(E98,GetEnumUnit(),1,E88)
  endif
endfunction

function P3E takes unit Source,real x,real y, integer Level returns nothing
  local real x1
  local real y1
  local group g=GetAvailableGroup()
  local real Damage=40+40*Level
  set tt_unit1=Source
  set E98=Source
  set E88=Damage
  call GroupEnumUnitsInRange(g,x,y,600,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function PCE)
  call KillGroup(g)
  set x1=x
  set y1=y
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
  set x1=x+200
  set y1=y+200
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
  set x1=x+200
  set y1=y-200
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
  set x1=x-200
  set y1=y+200
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
  set x1=x-200
  set y1=y-200
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x1,y1))
  call TimedReveal(GetOwningPlayer(Source),10,x,y,600)
  set g=null
endfunction

function P6E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  local real a=LoadReal(HY,h,13)
  local real SourceX=LoadReal(HY,h,189)
  local real SourceY=LoadReal(HY,h,190)
  local real AO8=SafeX50(SourceX+30*Cos(a))
  local real AP8=SafeY50(SourceY+30*Sin(a))
  local real PLE
  local real P1E
  local integer lvl=LoadInteger(HY,h,0)
  call SetUnitX(Projectile,AO8)
  call SetUnitY(Projectile,AP8)
  call SaveReal(HY,h,189,AO8*1.)
  call SaveReal(HY,h,190,AP8*1.)
  if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=35 then
    call KillUnit(Projectile)
    set Hero=LoadUnitHandle(HY,h,14)
    call P3E(Hero,AO8,AP8,lvl)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set Projectile=null
  return false
endfunction

function Clockwerk_RocketFlare takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real SourceX=SafeX50(GetUnitX(Hero))
  local real SourceY=SafeY50(GetUnitY(Hero))
  local real TargetX=SafeX50(GetSpellTargetX())
  local real TargetY=SafeY50(GetSpellTargetY())
  local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Hero),'h03Y',SourceX,SourceY,a*bj_RADTODEG)
  call SetUnitFacing(Projectile,a*bj_RADTODEG)
  call SetUnitPathing(Projectile,false)
  call UnitAddAbility2(Projectile,'Aloc')
  call ShowUnit(Projectile,false)
  call UnitRemoveAbility(Projectile,'Aloc')
  call ShowUnit(Projectile,true)
  call SaveReal(HY,h,191,SourceX*1.)
  call SaveReal(HY,h,192,SourceY*1.)
  call SaveReal(HY,h,189,SourceX*1.)
  call SaveReal(HY,h,190,SourceY*1.)
  call SaveReal(HY,h,47,TargetX*1.)
  call SaveReal(HY,h,48,TargetY*1.)
  call SaveReal(HY,h,13,a*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,45,Projectile)
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function P6E))
  set Hero=null
  set t=null
  set Projectile=null
endfunction

function P2E takes real s,real d1,real d2,real d3 returns boolean
  return s<=d1 and s<=d2 and s<=d3
endfunction

function Q4E takes unit u,real x,real y,real d returns real
  local real x2=GetUnitX(u)
  local real y2=GetUnitY(u)
  local real Q7E=DistanceBetweenXY(x-d,y,x2,y2)
  local real Q8E=DistanceBetweenXY(x+d,y,x2,y2)
  local real Q9E=DistanceBetweenXY(x,y+d,x2,y2)
  local real QDE=DistanceBetweenXY(x,y-d,x2,y2)
  if P2E(Q7E,Q8E,QDE,Q9E)then
    return 180.
  elseif P2E(Q8E,Q7E,QDE,Q9E)then
    return .0
  elseif P2E(QDE,Q8E,Q7E,Q9E)then
    return 270.
  endif
  return 90.
endfunction

function QEE takes real s,real d1,real d2,real d3,real d4,real d5,real d6,real d7 returns boolean
  return s<=d1 and s<=d2 and s<=d3 and s<=d4 and s<=d5 and s<=d6 and s<=d7
endfunction

function QFE takes unit u,integer h returns unit
  local real x1=GetUnitX(u)
  local real y1=GetUnitY(u)
  local unit QGE=(LoadUnitHandle(HY,h,(1100+1)))
  local unit QHE=(LoadUnitHandle(HY,h,(1100+2)))
  local unit QIE=(LoadUnitHandle(HY,h,(1100+3)))
  local unit QJE=(LoadUnitHandle(HY,h,(1100+4)))
  local unit QKE=(LoadUnitHandle(HY,h,(1100+5)))
  local unit QME=(LoadUnitHandle(HY,h,(1100+6)))
  local unit QNE=(LoadUnitHandle(HY,h,(1100+7)))
  local unit QOE=(LoadUnitHandle(HY,h,(1100+8)))
  local real d1=DistanceBetweenXY(x1,y1,GetUnitX(QGE),GetUnitY(QGE))
  local real d2=DistanceBetweenXY(x1,y1,GetUnitX(QHE),GetUnitY(QHE))
  local real d3=DistanceBetweenXY(x1,y1,GetUnitX(QIE),GetUnitY(QIE))
  local real d4=DistanceBetweenXY(x1,y1,GetUnitX(QJE),GetUnitY(QJE))
  local real d5=DistanceBetweenXY(x1,y1,GetUnitX(QKE),GetUnitY(QKE))
  local real d6=DistanceBetweenXY(x1,y1,GetUnitX(QME),GetUnitY(QME))
  local real d7=DistanceBetweenXY(x1,y1,GetUnitX(QNE),GetUnitY(QNE))
  local real d8=DistanceBetweenXY(x1,y1,GetUnitX(QOE),GetUnitY(QOE))
  
  if QEE(d1,d2,d3,d4,d5,d6,d7,d8)then
    set QHE=null
    set QIE=null
    set QJE=null
    set QKE=null
    set QME=null
    set QNE=null
    set QOE=null
    return QGE
  elseif QEE(d2,d1,d3,d4,d5,d6,d7,d8)then
    set QGE=null
    set QIE=null
    set QJE=null
    set QKE=null
    set QME=null
    set QNE=null
    set QOE=null
    return QHE
  elseif QEE(d3,d2,d1,d4,d5,d6,d7,d8)then
    set QGE=null
    set QHE=null
    set QJE=null
    set QKE=null
    set QME=null
    set QNE=null
    set QOE=null
    return QIE
  elseif QEE(d4,d2,d3,d1,d5,d6,d7,d8)then
    set QGE=null
    set QHE=null
    set QIE=null
    set QKE=null
    set QME=null
    set QNE=null
    set QOE=null
    return QJE
  elseif QEE(d5,d2,d3,d4,d1,d6,d7,d8)then
    set QGE=null
    set QHE=null
    set QIE=null
    set QJE=null
    set QME=null
    set QNE=null
    set QOE=null
    return QKE
  elseif QEE(d6,d2,d3,d4,d5,d1,d7,d8)then
    set QGE=null
    set QHE=null
    set QIE=null
    set QJE=null
    set QKE=null
    set QNE=null
    set QOE=null
    return QME
  elseif QEE(d7,d2,d3,d4,d5,d6,d1,d8)then
    set QGE=null
    set QHE=null
    set QIE=null
    set QJE=null
    set QKE=null
    set QME=null
    set QOE=null
    return QNE
  elseif QEE(d8,d2,d3,d4,d5,d6,d7,d1)then
    set QGE=null
    set QHE=null
    set QIE=null
    set QJE=null
    set QKE=null
    set QME=null
    set QNE=null
    return QOE
  endif
  return null
endfunction

function QPE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real a=(LoadReal(HY,h,(13)))
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real QQE=7.5
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  local integer QRE=40+40*Level
  if GetTriggerEvalCount(t)>34 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveInteger(HY,(GetHandleId((Target))),((4260)),2)
    call DamageTarget(Source,Target,1,QRE)
    call SetUnitState(Target,UNIT_STATE_MANA,RMaxIF(GetUnitState(Target,UNIT_STATE_MANA)-QRE,0))
  else
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",x,y))
    call KillTrees(x,y,150)
    if((LoadInteger(HY,(GetHandleId((Target))),((4261))))==1)==false then
      call SetUnitPosition(Target,x+QQE*Cos(a*bj_DEGTORAD),y+QQE*Sin(a*bj_DEGTORAD))
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function QSE takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Target=GetEnumUnit()
  local real x=tt_real1
  local real y=TJ
  local real d=RJ
  local real a=Q4E(Target,x,y,d)
  local real x2 = GetWidgetX(Target)
  local real y2 = GetWidgetY(Target)
  local real d2 = d - SquareRoot((x-x2)*(x-x2)+(y-y2)*(y-y2)) + 100
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",Target,"chest"))
  call SaveInteger(HY,(GetHandleId((Target))),((4260)),(1))
  if d2 > 0 then
    call SetUnitX(Target,x2 + d2*Cos(a*bj_DEGTORAD))
    call SetUnitY(Target,y2 + d2*Sin(a*bj_DEGTORAD))
  endif
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveInteger(HY,h,5,(tt_int1))
  call SaveUnitHandle(HY,h,2,(tt_unit1))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function QPE))
  set t=null
  set Target=null
endfunction

function QTE takes unit u,integer h returns boolean
  local unit QUE=QFE(u,h)
  local boolean result=true
  if IsDead(QUE)or(LoadInteger(HY,(GetHandleId(QUE)),(156)))==1 then
    set result=false
  endif
  call SaveInteger(HY,(GetHandleId(QUE)),(156),(1))
  call SetUnitVertexColor(QUE,25,25,25,175)
  set QUE=null
  return result
endfunction

function QVE takes nothing returns nothing
  if GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)>0 and IsUnitInGroup(GetEnumUnit(),DK)==false and((LoadInteger(HY,GetHandleId(GetEnumUnit()),4260))==1)==false and QTE(GetEnumUnit(),ED8) then
    call SaveInteger(HY,GetHandleId(GetEnumUnit()),4260,1)
    call GroupAddUnit(EK,GetEnumUnit())
  endif
endfunction

function QWE takes trigger t,unit Hero,real x,real y,real d,integer Level returns nothing
  local integer h=GetHandleId(t)
  local real QXE=200
  local rect r1=Rect(x-d,y-d,x+d,y+d)
  local rect r2=Rect(x-d-QXE,y-d-QXE,x+d+QXE,y+d+QXE)
  local group g1=GetAvailableGroup()
  local group g2=GetAvailableGroup()
  local group g3=GetAvailableGroup()
  set tt_unit1=Hero
  call GroupEnumUnitsInRect(g1,r1,Condition(function NonImmuneEnemyFilter))
  call GroupEnumUnitsInRect(g2,r2,Condition(function NonImmuneEnemyFilter))
  set DK=g1
  set EK=g3
  set tt_real1=x
  set TJ=y
  set RJ=d
  set ED8=h
  call ForGroup(g2,function QVE)
  set tt_int1=Level
  call ForGroup(g3,function QSE)
  call KillGroup(g1)
  call KillGroup(g2)
  call KillGroup(g3)
  call RemoveRect(r1)
  call RemoveRect(r2)
  set g1=null
  set g2=null
  set g3=null
  set r1=null
  set r2=null
endfunction

function QYE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local boolean QZE=(LoadBoolean(HY,h,(155)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if QZE then
    call TimedReveal(p,.2,x,y,500)
  endif
  set t=null
  set p=null
  return false
endfunction

function QAE takes unit QBE returns nothing
  local real x=GetUnitX(QBE)
  local real y=GetUnitY(QBE)
  local player p=GetOwningPlayer(QBE)
  local unit Caster=CreateUnit(p,'u00W',x,y,0)
  call KillUnit(Caster)
  set p=null
  set Caster=null
endfunction

function QCE takes integer h,real x,real y,boolean QZE,player p returns nothing
  local unit QGE=(LoadUnitHandle(HY,h,(1100+1)))
  local unit QHE=(LoadUnitHandle(HY,h,(1100+2)))
  local unit QIE=(LoadUnitHandle(HY,h,(1100+3)))
  local unit QJE=(LoadUnitHandle(HY,h,(1100+4)))
  local unit QKE=(LoadUnitHandle(HY,h,(1100+5)))
  local unit QME=(LoadUnitHandle(HY,h,(1100+6)))
  local unit QNE=(LoadUnitHandle(HY,h,(1100+7)))
  local unit QOE=(LoadUnitHandle(HY,h,(1100+8)))
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.1,false)
  call TriggerAddCondition(t,Condition(function QYE))
  call SaveReal(HY,(GetHandleId(t)),6,((x)*1.))
  call SaveReal(HY,(GetHandleId(t)),7,((y)*1.))
  call SavePlayerHandle(HY,(GetHandleId(t)),(54),(p))
  call SaveBoolean(HY,(GetHandleId(t)),(155),(QZE))
  call QAE(QGE)
  call RemoveUnit(QGE)
  call QAE(QHE)
  call RemoveUnit(QHE)
  call QAE(QIE)
  call RemoveUnit(QIE)
  call QAE(QJE)
  call RemoveUnit(QJE)
  call QAE(QKE)
  call RemoveUnit(QKE)
  call QAE(QME)
  call RemoveUnit(QME)
  call QAE(QNE)
  call RemoveUnit(QNE)
  call QAE(QOE)
  call RemoveUnit(QOE)
  set t=null
  set QGE=null
  set QHE=null
  set QIE=null
  set QJE=null
  set QKE=null
  set QME=null
  set QNE=null
  set QOE=null
endfunction

function Q3E takes unit QBE,integer h,integer ZG8,player p returns nothing
  if IsUnitVisible(QBE,p)then
    call SaveBoolean(HY,h,(155),(true))
  endif
  call SaveUnitHandle(HY,h,(1100+ZG8),(QBE))
endfunction

function Q6E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real DP9=(LoadReal(HY,h,(57)))
  local integer Count=GetTriggerEvalCount(t)
  if Count>R2I(DP9*10)then
    call QCE(h,(LoadReal(HY,h,6)),(LoadReal(HY,h,7)),(LoadBoolean(HY,h,(155))),(LoadPlayerHandle(HY,h,(154))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call QWE(t,(LoadUnitHandle(HY,h,(14))),(LoadReal(HY,h,6)),(LoadReal(HY,h,7)),(LoadReal(HY,h,(138))),(LoadInteger(HY,h,5)))
  endif
  set t=null
  return false
endfunction

function QLE takes nothing returns nothing
  call SetUnitX(GetEnumUnit(),GetUnitX(tt_unit1))
  call SetUnitY(GetEnumUnit(),GetUnitY(tt_unit1))
endfunction

function Clockwerk_PowerCogs_Action takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=GetUnitAbilityLevel(Hero,'A0Z5')
  local integer ID='u00S'
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real x2
  local real y2
  local real d=125
  local unit QBE
  local real DP9=4+Level
  local real BufferDuration=5
  local group g
  local rect Q0E
  local player AXD
  local real life=3
  if Level<4 then
    set life=2
  endif
  if IsSentinel(GetOwningPlayer(Hero))then
    set AXD=Scourges[0]
  else
    set AXD=Sentinels[0]
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveBoolean(HY,h,(155),(false))
  set g=GetAvailableGroup()
  set d=d+110
  set Q0E=Rect(x1-d,y1-d,x1+d,y1+d)
  set d=d-110
  set tt_unit1=Hero
  call GroupEnumUnitsInRect(g,Q0E,Condition(function DE9))
  set x2=x1+d
  set y2=y1
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetWidgetLife(QBE,life)
  call SetUnitPosition(QBE,x2,y2)
  call Q3E(QBE,h,1,AXD)
  set x2=x1+d
  set y2=y1+d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,2,AXD)
  set x2=x1
  set y2=y1+d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,3,AXD)
  set x2=x1-d
  set y2=y1+d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,4,AXD)
  set x2=x1-d
  set y2=y1
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,5,AXD)
  set x2=x1-d
  set y2=y1-d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,6,AXD)
  set x2=x1
  set y2=y1-d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,7,AXD)
  set x2=x1+d
  set y2=y1-d
  set QBE=CreateUnit(GetOwningPlayer(Hero),ID,x2,y2,0)
  call SetUnitPosition(QBE,x2,y2)
  call SetWidgetLife(QBE,life)
  call Q3E(QBE,h,8,AXD)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function Q6E))
  call SaveReal(HY,h,(57),((DP9)*1.))
  call SaveReal(HY,h,6,((x1)*1.))
  call SaveReal(HY,h,7,((y1)*1.))
  call SaveReal(HY,h,(138),((d)*1.))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,5,(Level))
  call SavePlayerHandle(HY,h,(154),(AXD))
  
  call ForGroup(g,function QLE)
  call KillGroup(g)
  set t=null
  set g=null
  set Hero=null
  set QBE=null
  set Q0E=null
  set AXD=null
  return false
endfunction

function Clockwerk_PowerCogs_Start takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.1,false)
  call TriggerAddCondition(t,Condition(function Clockwerk_PowerCogs_Action))
  call SaveUnitHandle(HY,h,(14),(Hero))
  set t=null
  set Hero=null
endfunction

function R4E takes unit Source,unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local integer Level=GetUnitAbilityLevel(Source,'A0Z8')
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A1CV')
  endif
  call UnitAddAbility2(Caster,'A0Z9')
  call SetUnitAbilityLevel(Caster,'A0Z9',Level)
  call IssueTargetOrderById(Caster,852095,Target)
  set Caster=null
endfunction

function R7E takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call R4E(tt_unit1,GetEnumUnit())
  endif
endfunction

function R8E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer R9E=LoadInteger(HY,h,18)
  local integer Count=GetTriggerEvalCount(t)
  local unit RDE
  local group REE=LoadGroupHandle(HY,h,16)
  local group g
  local real RFE=200
  if Target==null then
    set RDE=LoadUnitHandle(HY,h,700+R9E+1-Count)
    call RemoveUnit(RDE)
  else
    set RDE=LoadUnitHandle(HY,h,700+Count)
    if IsUnitType(Hero,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
    endif
    call SetUnitX(Hero,GetUnitX(RDE))
    call SetUnitY(Hero,GetUnitY(RDE))
    call RemoveUnit(RDE)
    if Count==R9E then
      set RFE=225
    endif
    set g=GetAvailableGroup()
    set tt_unit1=Hero
    set DK=REE
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),RFE,Condition(function LW8))
    call ForGroup(g,function R7E)
    call KillGroup(g)
  endif
  if Count==(R9E)then
    if Target!=null then
      call PauseUnit(Target,false)
    endif
    call KillTrees(GetUnitX(Hero),GetUnitY(Hero),100)
    call KillGroup(REE)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set Target=null
  set RDE=null
  set REE=null
  set g=null
  return false
endfunction

function RGE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real a=LoadReal(HY,h,13)
  local integer RHE=LoadInteger(HY,h,12)
  local integer Count=GetTriggerEvalCount(t)
  local real x=GetUnitX(Hero)+Count*50*Cos(a*bj_DEGTORAD)
  local real y=GetUnitY(Hero)+Count*50*Sin(a*bj_DEGTORAD)
  local boolean RIE=LoadBoolean(HY,h,15)
  local unit RJE
  local integer lvl=LoadInteger(HY,h,0)
  local trigger RKE=LoadTriggerHandle(HY,h,11)
  local integer RME=GetHandleId(RKE)
  local group g=GetAvailableGroup()
  local unit Target=null
  local integer ID='u00V'
  local real RFE=125
  if Count==1 then
    set RFE=100
  endif
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function LO8))
  call GroupRemoveUnit(g,Hero)
  set Target=GroupPickRandomUnit(g)
  call KillGroup(g)
  if Target!=null or Count==RHE or Count==(RHE-1)or Count==(RHE-2)then
    set ID='u00U'
  endif
  set RJE=CreateUnit(GetOwningPlayer(Hero),ID,x,y,a)
  call SaveUnitHandle(HY,RME,700+Count,RJE)
  if Target!=null then
    if GetOwningPlayer(Target)==Neutrals or LoadInteger(HY,GetHandleId(Target),4259)==1 then
      set Target=null
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if Target!=null and IsUnitAlly(Target,GetOwningPlayer(Hero))==false then
      call PauseUnit(Target,true)
    endif
    call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
    call TriggerAddCondition(RKE,Condition(function R8E))
    call SaveInteger(HY,RME,18,Count)
    call SaveInteger(HY,RME,0,lvl)
    call SaveUnitHandle(HY,RME,17,Target)
    call SaveUnitHandle(HY,RME,14,Hero)
    call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
  elseif Count>RHE then
    set Target=null
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
    call TriggerAddCondition(RKE,Condition(function R8E))
    call SaveInteger(HY,RME,18,Count)
    call SaveInteger(HY,RME,0,lvl)
    call SaveUnitHandle(HY,RME,17,Target)
    call SaveUnitHandle(HY,RME,14,Hero)
    call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
  endif
  set t=null
  set Hero=null
  set RJE=null
  set RKE=null
  set g=null
  set Target=null
  return false
endfunction

function Clockwerk_Hookshot takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
  local integer Level=GetUnitAbilityLevel(Hero,'A0Z8')
  local integer ROE
  local integer RHE
  local boolean RIE=false
  local trigger RPE=CreateTrigger()
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A1CV')
    set RIE=true
  endif
  set ROE=1500+500*Level
  set RHE=ROE/ 50
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveInteger(HY,h,5,Level)
  call SaveReal(HY,h,13,a*1.)
  call SaveInteger(HY,h,12,RHE)
  call SaveTriggerHandle(HY,h,11,RPE)
  call SaveBoolean(HY,h,15,RIE)
  call TriggerRegisterTimerEvent(t,.5/ RHE,true)
  call TriggerAddCondition(t,Condition(function RGE))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  set t=null
  set Hero=null
  set RPE=null
endfunction

function RRE takes unit Source, integer Level returns nothing
  local group g=GetAvailableGroup()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit Target
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,300,Condition(function NonImmuneVisibleEnemyFilter))
  set Target=GroupPickRandomUnit(g)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",Source,"origin"))
  if Target!=null then
    call UnitAddAbility2(Caster,'A0Z7')
    call SetUnitAbilityLevel(Caster,'A0Z7',Level)
    call IssueTargetOrderById(Caster,852095,Target)
  endif
  set g=null
  set Target=null
  set Caster=null
endfunction

function RSE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  if Count>14 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call RRE(Hero,LoadInteger(HY,h,0))
  endif
  set t=null
  set Hero=null
  return false
endfunction

function Clockwerk_BatteryAssault takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.7,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function RSE))
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call TriggerEvaluate(t)
  set t=null
  set Hero=null
endfunction

function RVE takes nothing returns nothing
  call DamageTarget(EE8,GetEnumUnit(),1,EF8)
endfunction

function RWE takes unit Source,real x,real y,integer Level, boolean isUpgraded returns nothing
  local group g=GetAvailableGroup()
  if isUpgraded then
    if Level==1 then
      set EF8=140
    elseif Level==2 then
      set EF8=200
    elseif Level==3 then
      set EF8=260
    endif
  else
    if Level==1 then
      set EF8=80
    elseif Level==2 then
      set EF8=140
    elseif Level==3 then
      set EF8=200
    endif
  endif
  set EE8=Source
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,275,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function RVE)
  call KillGroup(g)
  set g=null
endfunction

function RXE takes nothing returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
  call UnitAddAbility2(Caster,'A10T')
  if GetUnitAbilityLevel(tt_unit1,'A03R')>0 then
    call SetUnitAbilityLevel(Caster,'A10T',2)
  endif
  call IssueTargetOrderById(Caster,852075,GetEnumUnit())
  set Caster=null
endfunction

function RYE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer RZE=ModuloInteger(GetTriggerEvalCount(t),4)+1
  local real a
  local real d
  local real x
  local real y
  local group g//=GetAvailableGroup()
  set tt_unit1=Hero
  //call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),710,Condition(function DefaultEnemyFilter))
  //call ForGroup(g,function RXE)
  //call KillGroup(g)
  if RZE==1 then
    set a=GetRandomReal(0,90)
  elseif RZE==2 then
    set a=GetRandomReal(90,180)
  elseif RZE==3 then
    set a=GetRandomReal(180,270)
  else
    set a=GetRandomReal(270,360)
  endif
  set d=GetRandomReal(140,710)
  if GetUnitAbilityLevel(Hero,'A03R')+GetUnitAbilityLevel(Hero,'A0AV')==0 or (GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and(GetSpellAbilityId()=='A03R' or GetSpellAbilityId()=='A0AV'))then
    if GetSpellAbilityId()=='A0AV' and LoadBoolean(HY,h,0)==false then
      call UnitRemoveAbility(Hero,'A0ST')
      call DestroyEffect(LoadEffectHandle(HY,h,0))
    endif
    call UnitRemoveAbility(Hero,'A347')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call StopSound(AC,false,true)
  else
    if LoadBoolean(HY,h,0)==false and (R2I(2/0.07)<GetTriggerEvalCount(t))then
      call UnitRemoveAbility(Hero,'A0ST')
      call UnitRemoveAbility(Hero,'A347')
      call DestroyEffect(LoadEffectHandle(HY,h,0))
      call SaveBoolean(HY,h,0,true)
    endif
    set x=GetUnitX(Hero)+d*Cos(a*bj_DEGTORAD)
    set y=GetUnitY(Hero)+d*Sin(a*bj_DEGTORAD)
    call DestroyEffect(AddSpecialEffect("effects\\SnowyBlizzardTarget.mdx",x,y))
    call RWE(Hero,x,y,Level,LoadBoolean(HY,h,2))
  endif
  set t=null
  set Hero=null
  set g=null
  return false
endfunction

function CM_FreezingField takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level
  call PlaySoundAtPos(AC,GetUnitX(Hero),GetUnitY(Hero))
  call UnitAddAbility(Hero,'A347')
  if GetSpellAbilityId()=='A03R' then
    set Level=GetUnitAbilityLevel(Hero,'A03R')
    call SaveBoolean(HY,h,2,false)
  else
    call SetUnitAbilityLevel(Hero,'A347',2)
    call SaveBoolean(HY,h,2,true)
    set Level=GetUnitAbilityLevel(Hero,'A0AV')+1
    call UnitAddAbility2(Hero,'A0ST')//mag immune cont
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Avatar\\AvatarCaster.mdl",Hero,"origin"))
    call SaveEffectHandle(HY,h,0,AddSpecialEffectTarget("Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl",Hero,"origin"))
    call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0ST',false)
  endif
  call TriggerRegisterTimerEvent(t,.07,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function RYE))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,5,(Level))
  set t=null
  set Hero=null
endfunction

function Maiden_Brilliance_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  call UnitRemoveAbility(u,'QBA1')
  call UnitRemoveAbility(u,'QBA2')
  call UnitRemoveAbility(u,'QBA3')
  call UnitRemoveAbility(u,'QBA4')
  call UnitAddAbility(u,GetUnitAbilityLevel(u,'AHab')+'QBA0')
  set u = null
endfunction

function CM_Nova takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00C',x,y,0)
  local integer Level=GetUnitAbilityLevel(Source,'A1E9')
  call UnitShareVision(Caster,GetOwningPlayer(Source),true)
  call UnitAddAbility2(Caster,'A01D')
  call SetUnitAbilityLevel(Caster,'A01D',Level)
  call IssueTargetOrderById(Caster,852226,Caster)
  call UnitAddAbility2(Caster,'Aloc')
  call UnitApplyTimedLife(Caster,'BTLF',2)
  set Source=null
  set Caster=null
endfunction

function CM_FrostBite_Periodic takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  if GetUnitAbilityLevel(target,'B017')>0 then
    call DamageTarget(caster,target,2,50)
  else
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set caster=null
  set target=null
  set t=null
endfunction

function CM_FrostBite takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local timer t=CreateTimer()
  call TimerStart(t,0.5,true,function CM_FrostBite_Periodic)
  call SaveUnitHandle(HY,GetHandleId(t),0,caster)
  call SaveUnitHandle(HY,GetHandleId(t),1,GetSpellTargetUnit())
  call DamageTarget(caster,GetSpellTargetUnit(),2,50)
  set t=null
  set caster=null
endfunction

function OgreLord_AnteUp takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local real dmg=GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)*(GetUnitAbilityLevel(caster,'A44U')*0.05+0.15)
  call DamageTarget(caster,target,1,dmg)
  call TextTagOnUnit("+"+I2S(R2I(dmg)),1,target,.03,255,200,0,255)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",target,"origin"))
  set caster=null
  set target=null
endfunction

function OgreLord_AnteUpWrap takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call OgreLord_AnteUp()
  endif
endfunction

function OgreLord_CashIn takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()//LoadUnitHandle(HY,GetHandleId(GetTriggerUnit()),(796))
  local integer diff=GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)-GetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)
  local real dmg
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)
  local integer lvl=GetUnitAbilityLevel(caster,'A44V')
  local integer lim=400+400*lvl
  call UnitAddAbility(d,'A44W')
  call IssueTargetOrder(d,"thunderbolt",target)
  set d=null
  if diff<-lim then
    set diff=-lim
  elseif diff > lim then
    set diff=lim
  endif
  if diff<0 then
    set dmg=diff*(lvl*0.1+0.6)*-1
    call DamageTarget(caster,target,1,dmg)
    call TextTagOnUnit("+"+I2S(R2I(dmg)),1,target,.03,255,100,0,255)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
    call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",target,"origin"))
  else
    call SetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetOwningPlayer(target),PLAYER_STATE_RESOURCE_GOLD)+diff)
    call SetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)+diff)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\ResourceItems\\ResourceEffectTarget.mdl",target,"origin"))
    call TextTagOnUnit("+"+I2S(diff),1,target,.03,255,200,0,255)
    call TextTagOnUnit("+"+I2S(diff),1,caster,.03,255,200,0,255)
  endif
  
  set caster=null
  set target=null
endfunction

function OgreLord_CashInWrap takes nothing returns nothing
  call OgreLord_CashIn()
endfunction

function OgreLord_CashInChanneling takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call SaveUnitHandle(HY,GetHandleId(GetTriggerUnit()),(796),GetSpellTargetUnit())
  endif
endfunction

function BloodRitePaintG takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local real x=LoadReal(HY,h,10)
  local real y=LoadReal(HY,h,11)
  local integer c=LoadInteger(HY,h,0)+1
  local string s="Objects\\Spawnmodels\\NightElf\\NightElfBlood\\NightElfBloodArcher.mdl"
  if c==1 then
    call DestroyEffect(AddSpecialEffect(s,x,y))
    call DestroyEffect(AddSpecialEffect(s,x+50*Cos(15*bj_DEGTORAD),y+50*Sin(15*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+100*Cos(7*bj_DEGTORAD),y+100*Sin(7*bj_DEGTORAD)))
  elseif c==2 then
    call DestroyEffect(AddSpecialEffect(s,x+150*Cos(0*bj_DEGTORAD),y+150*Sin(0*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+200*Cos(340*bj_DEGTORAD),y+200*Sin(340*bj_DEGTORAD)))
  elseif c==3 then
    call DestroyEffect(AddSpecialEffect(s,x+250*Cos(325*bj_DEGTORAD),y+250*Sin(325*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+300*Cos(300*bj_DEGTORAD),y+300*Sin(300*bj_DEGTORAD)))
  elseif c==4 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(275*bj_DEGTORAD),y+350*Sin(270*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(250*bj_DEGTORAD),y+400*Sin(250*bj_DEGTORAD)))
  elseif c==5 then
    call DestroyEffect(AddSpecialEffect(s,x+450*Cos(225*bj_DEGTORAD),y+450*Sin(225*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+500*Cos(200*bj_DEGTORAD),y+500*Sin(200*bj_DEGTORAD)))
  elseif c==6 then
    call DestroyEffect(AddSpecialEffect(s,x+550*Cos(175*bj_DEGTORAD),y+550*Sin(175*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+570*Cos(150*bj_DEGTORAD),y+570*Sin(150*bj_DEGTORAD)))
  elseif c==7 then
    call DestroyEffect(AddSpecialEffect(s,x+570*Cos(125*bj_DEGTORAD),y+570*Sin(125*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+570*Cos(100*bj_DEGTORAD),y+570*Sin(100*bj_DEGTORAD)))
  elseif c==8 then
    call DestroyEffect(AddSpecialEffect(s,x+550*Cos(100*bj_DEGTORAD),y+550*Sin(100*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+550*Cos(90*bj_DEGTORAD),y+550*Sin(90*bj_DEGTORAD)))
  elseif c==9 then
    call DestroyEffect(AddSpecialEffect(s,x+500*Cos(70*bj_DEGTORAD),y+500*Sin(70*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+450*Cos(45*bj_DEGTORAD),y+450*Sin(45*bj_DEGTORAD)))
  elseif c==10 then
    call DestroyEffect(AddSpecialEffect(s,x+450*Cos(20*bj_DEGTORAD),y+450*Sin(20*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+450*Cos(0*bj_DEGTORAD),y+450*Sin(0*bj_DEGTORAD)))
  elseif c==11 then
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(345*bj_DEGTORAD),y+400*Sin(345*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(330*bj_DEGTORAD),y+350*Sin(330*bj_DEGTORAD)))
  elseif c==12 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(315*bj_DEGTORAD),y+350*Sin(315*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(300*bj_DEGTORAD),y+350*Sin(300*bj_DEGTORAD)))
  elseif c==13 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(275*bj_DEGTORAD),y+350*Sin(275*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+300*Cos(250*bj_DEGTORAD),y+300*Sin(250*bj_DEGTORAD)))
  elseif c==14 then
    call DestroyEffect(AddSpecialEffect(s,x+300*Cos(225*bj_DEGTORAD),y+300*Sin(225*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(200*bj_DEGTORAD),y+350*Sin(200*bj_DEGTORAD)))
  elseif c==15 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(180*bj_DEGTORAD),y+350*Sin(180*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(160*bj_DEGTORAD),y+400*Sin(160*bj_DEGTORAD)))
  elseif c==16 then
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(130*bj_DEGTORAD),y+400*Sin(130*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(110*bj_DEGTORAD),y+400*Sin(110*bj_DEGTORAD)))
  elseif c==17 then
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(90*bj_DEGTORAD),y+400*Sin(90*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(70*bj_DEGTORAD),y+400*Sin(70*bj_DEGTORAD)))
  elseif c==18 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(45*bj_DEGTORAD),y+350*Sin(45*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(30*bj_DEGTORAD),y+350*Sin(30*bj_DEGTORAD)))
  elseif c==19 then
    call DestroyEffect(AddSpecialEffect(s,x+250*Cos(0*bj_DEGTORAD),y+250*Sin(0*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+250*Cos(345*bj_DEGTORAD),y+250*Sin(345*bj_DEGTORAD)))
  elseif c==20 then
    call DestroyEffect(AddSpecialEffect(s,x+150*Cos(330*bj_DEGTORAD),y+150*Sin(330*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+100*Cos(300*bj_DEGTORAD),y+100*Sin(300*bj_DEGTORAD)))
  elseif c==21 then
    call DestroyEffect(AddSpecialEffect(s,x+50*Cos(275*bj_DEGTORAD),y+50*Sin(275*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+0*Cos(250*bj_DEGTORAD),y+0*Sin(250*bj_DEGTORAD)))
  elseif c==22 then
    call DestroyEffect(AddSpecialEffect(s,x-100*Cos(225*bj_DEGTORAD),y-100*Sin(225*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x-150*Cos(200*bj_DEGTORAD),y-150*Sin(200*bj_DEGTORAD)))
  elseif c==23 then
    call DestroyEffect(AddSpecialEffect(s,x-200*Cos(175*bj_DEGTORAD),y-200*Sin(175*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x-250*Cos(150*bj_DEGTORAD),y-250*Sin(150*bj_DEGTORAD)))
  elseif c==24 then
    call DestroyEffect(AddSpecialEffect(s,x-250*Cos(180*bj_DEGTORAD),y-250*Sin(180*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x-300*Cos(180*bj_DEGTORAD),y-300*Sin(180*bj_DEGTORAD)))
  elseif c==25 then
    call DestroyEffect(AddSpecialEffect(s,x-350*Cos(270*bj_DEGTORAD),y-350*Sin(270*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x-400*Cos(270*bj_DEGTORAD),y-400*Sin(270*bj_DEGTORAD)))
  elseif c==26 then
    call DestroyEffect(AddSpecialEffect(s,x+350*Cos(90*bj_DEGTORAD),y+350*Sin(90*bj_DEGTORAD)))
    call DestroyEffect(AddSpecialEffect(s,x+400*Cos(90*bj_DEGTORAD),y+400*Sin(90*bj_DEGTORAD)))
  endif
  if c>26 then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  else
    call SaveInteger(HY,h,0,c)
  endif
  set t=null
endfunction

function BloodRitePaint takes real x, real y returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,10,x)
  call SaveReal(HY,h,11,y)
  call TimerStart(t,0.1,true,function BloodRitePaintG)
  set t=null
endfunction

function BloodRiteBlast takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local effect fx=LoadEffectHandle(HY,h,1)
  local real dmg=LoadReal(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  local group g=GetAvailableGroup()
  local real x=LoadReal(HY,h,10)
  local real y=LoadReal(HY,h,11)
  local unit u2
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)
  call PlaySoundAtPos(gg_snd_PossessionMissileLaunch1,x,y)
  call UnitAddAbility(d,'A450')
  call SetUnitAbilityLevel(d,'A450',lvl)
  call IssuePointOrder(d,"silence",x,y)
  set d=null
  set tt_unit1=u
  call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilter))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    call DamageTarget(u,u2,3,dmg)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BloodRiteTarget.mdx",u2,"chest"))
    call GroupRemoveUnit(g,u2)
  endloop
  call DestroyEffect(fx)
  call KillGroup(g)
  set g=null
  set fx=null
  set t=null
  set u=null
endfunction

function BloodRite takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A44Z')
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local effect fx=AddSpecialEffect("war3mapImported\\Bloodrite.mdx",x,y)
  
  call TimedReveal(GetOwningPlayer(u),2.5,x,y,300)
  call PlaySoundAtPos(gg_snd_DarkSummoningLaunch1,x,y)
  call TimerStart(t,2.6,false,function BloodRiteBlast)
  call SaveUnitHandle(HY,h,0,u)
  call SaveReal(HY,h,0,lvl*40+80)
  call SaveInteger(HY,h,0,lvl)
  call SaveEffectHandle(HY,h,1,fx)
  call SaveReal(HY,h,10,x)
  call SaveReal(HY,h,11,y)
  call BloodRitePaint(x,y)
  set t=null
  set fx=null
  set u=null
endfunction

function BloodrageDuration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local unit adjhero
  local real limit
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
    if GetKillingUnit()==u then
      if GetUnitAbilityLevel(u,'A44Y')>0 then
        if IsDead(u)==false and IsUnitIllusion(GetTriggerUnit())==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(GetTriggerUnit())!='n00L' and GetUnitAbilityLevel(u,'BNdo')==0 then
          call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",u,"overhead"))
          call SetWidgetLife(u,GetWidgetLife(u)+GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_LIFE)*0.25)
        endif
      endif
    elseif GetTriggerUnit()==u then
      if GetUnitAbilityLevel(u,'A44Y')>0 then
        set adjhero=GetKillingUnit()
        if GetUnitAbilityLevel(adjhero,'Aloc')>0 or GetUnitAbilityLevel(adjhero,'A04R')>0 then
          set adjhero=udg_Hero[GetPlayerId(GetOwningPlayer(adjhero))]
        endif
        if IsDead(adjhero)==false and IsUnitIllusion(u)==false and GetUnitTypeId(u)!='n00L' and GetUnitAbilityLevel(adjhero,'BNdo')==0 and IsUnitType(adjhero,UNIT_TYPE_STRUCTURE)==false then
          call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",adjhero,"overhead"))
          call SetWidgetLife(adjhero,GetWidgetLife(adjhero)+GetUnitState(u,UNIT_STATE_MAX_LIFE)*0.25)
        endif
        set adjhero=null
      endif
      call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL')-LoadReal(HY,h,10))
      call UnitRemoveAbility(u,'A44Y')
      call UnitRemoveAbility(u,'B44Y')
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(MHT,GetHandleId(u),'A2X9')
      call RemoveSavedReal(HY,GetHandleId(u),'A2X9')
      call CleanTrigger(t)
    endif
  else
    set limit=LoadReal(HY,h,1)
    if limit < TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(u,'A44Y')==0 then
      call UnitRemoveAbility(u,'A44Y')
      call UnitRemoveAbility(u,'B44Y')
      call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL')-LoadReal(HY,h,10))
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(MHT,GetHandleId(u),'A2X9')
      call RemoveSavedReal(HY,GetHandleId(u),'A2X9')
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set u=null
  return false
endfunction

function BloodrageNewAct takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  local real dur=8+lvl
  local real amplify=0.2+0.05*lvl
  local trigger t//=CreateTrigger()
  local integer h//=GetHandleId(t)
  local real oldampl
  if HaveSavedHandle(MHT,GetHandleId(target),'A2X9') then
    set t=LoadTriggerHandle(MHT,GetHandleId(target),'A2X9')
    set h=GetHandleId(t)
    set oldampl=LoadReal(HY,h,10)
    if oldampl!=amplify then
      call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+amplify-oldampl)
      call SaveReal(HY,h,10,amplify)
      call SaveReal(HY,GetHandleId(target),'A2X9',amplify)
    endif
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.1,true)
    call SaveUnitHandle(HY,h,0,target)
    call SaveTriggerHandle(MHT,GetHandleId(target),'A2X9',t)
    call TriggerRegisterTimerEvent(t,0.1,true)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function BloodrageDuration))
    call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+amplify)
    call SaveReal(HY,GetHandleId(target),'A2X9',amplify)
    call SaveReal(HY,h,10,amplify)
  endif
  call UnitAddAbility2(target,'A44Y')
  call SetUnitAbilityLevel(target,'A44Y',lvl)
  call SaveReal(HY,h,1,dur+TimerGetElapsed(GlobalTimer))
  
  set t=null
  set caster=null
  set target=null
endfunction

function BloodrageNewStart takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
    call BloodrageNewAct()
  endif
endfunction

function FirewallEnd takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer i=0
  loop
    call KillUnit(LoadUnitHandle(HY,h,i))
    set i=i+1
  endloop
  call FlushChildHashtable(HY,h)
  call DestroyTrigger(t)
  set t=null
  return false
endfunction

function FirewallAct takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local unit dummy
  local integer i=0
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real step=12
  loop
    set dummy=CreateUnit(GetOwningPlayer(u),'ho03',x+450*Cos(step*i),y+450*Sin(step*i),0)
    call UnitApplyTimedLife(dummy,'BTLF',5)
    call SetUnitX(dummy,x+450*Cos(15*i))
    call SetUnitY(dummy,y+450*Sin(15*i))
    call SetUnitAbilityLevel(dummy,'A453',lvl)
    set i=i+1
    exitwhen i*step>360
  endloop
  set u=null
  set dummy=null
endfunction

function FirewallOnCast takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire2.mdl",GetTriggerUnit(),"left hand"))
  call DestroyEffect(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire2.mdl",GetTriggerUnit(),"weapon"))
endfunction

function FireStompActEffect takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A454')
  local unit u2
  local group g=GetAvailableGroup()
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
  call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
  set tt_unit1=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),350+25,Condition(function DefaultEnemyFilter))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    call DamageTarget(u,u2,1,100*lvl)
    call StunTargetLod(u2,lvl*1.0)
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  set u=null
endfunction

function FireStompRemoveVisual takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call DestroyEffect(LoadEffectHandle(HY,h,0))
  call DestroyEffect(LoadEffectHandle(HY,h,1))
  call DestroyEffect(LoadEffectHandle(HY,h,2))
  call DestroyEffect(LoadEffectHandle(HY,h,3))
  call DestroyEffect(LoadEffectHandle(HY,h,4))
  call DestroyEffect(LoadEffectHandle(HY,h,5))
  call FlushChildHashtable(HY,h)
  call DestroyTrigger(t)
  set t=null
  return false
endfunction

function FireStompAct takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterTimerEvent(t,1.2,false)
  call TriggerAddCondition(t,Condition(function FireStompRemoveVisual))
  call SaveEffectHandle(HY,h,0,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"hand right"))
  call SaveEffectHandle(HY,h,1,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"hand right"))
  call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"weapon left"))
  call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"weapon left"))
  call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"right foot"))
  call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlameStrike\\FlameStrikeEmbers.mdl",u,"left foot"))
  set t=null
  set u=null
endfunction

function InfernoDmgFix takes nothing returns nothing
  call LoDStat_Sub(GetEnumUnit(),LoadInteger(HY,GetHandleId(GetEnumUnit()),'MDMG'),"damageneg")
endfunction

function InfernoTick takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer dmg
  local integer lvl=LoadInteger(HY,h,0)
  local real burndmg
  local group g=LoadGroupHandle(HY,h,100)
  local unit u2
  local group gg
  if GetTriggerEventId()==EVENT_UNIT_ATTACKED then
    set dmg=LoadInteger(HY,GetHandleId(GetAttacker()),'MDMG')+5+5*lvl
    call LoDStat_Add(GetAttacker(),5+5*lvl,"damageneg")
    call SaveInteger(HY,GetHandleId(GetAttacker()),'MDMG',dmg)
    call GroupAddUnit(g,GetAttacker())
  elseif TimerGetElapsed(GlobalTimer) > LoadReal(HY,h,0) or GetTriggerEventId()==EVENT_UNIT_DEATH then//end
    call ForGroup(g,function InfernoDmgFix)
    call KillGroup(g)
    call DestroyEffect(LoadEffectHandle(HY,h,1))
    call DestroyEffect(LoadEffectHandle(HY,h,2))
    call DestroyEffect(LoadEffectHandle(HY,h,3))
    call DestroyEffect(LoadEffectHandle(HY,h,4))
    call DestroyEffect(LoadEffectHandle(HY,h,5))
    call DestroyEffect(LoadEffectHandle(HY,h,6))
    call DestroyEffect(LoadEffectHandle(HY,h,7))
    call DestroyEffect(LoadEffectHandle(HY,h,8))
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  else
    set gg=GetAvailableGroup()
    set tt_unit1=u
    call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),350+25,Condition(function DefaultEnemyFilter))
    set burndmg=(lvl*25+50) / 5
    loop
      set u2=FirstOfGroup(gg)
      exitwhen u2==null
      call DamageTarget(u,u2,1,burndmg)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedDamage.mdl",u2,"chest"))
      call GroupRemoveUnit(gg,u2)
    endloop
    call KillGroup(gg)
  endif
  set g=null
  set u=null
  set t=null
  return false
endfunction

function InfernoAct takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local group g=GetAvailableGroup()
  local string ss="Objects\\Spawnmodels\\Other\\FlameThrower\\FlameThrowerSpawnObj.mdl"
  local string s="Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl"
  call TriggerRegisterTimerEvent(t,0.2,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ATTACKED)
  call SaveUnitHandle(HY,h,0,u)
  call SaveGroupHandle(HY,h,100,g)
  call SaveInteger(HY,h,0,lvl)
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+12)
  call SaveEffectHandle(HY,h,1,AddSpecialEffectTarget("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",u,"origin"))
  
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"weapon"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"hand left"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"hand right"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"foot left"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"foot right"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"head"))
  call DestroyEffect(AddSpecialEffectTarget(ss,u,"chest"))
  
  call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget(s,u,"weapon"))
  call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget(s,u,"hand left"))
  call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget(s,u,"hand right"))
  call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget(s,u,"foot left"))
  call SaveEffectHandle(HY,h,6,AddSpecialEffectTarget(s,u,"foot right"))
  call SaveEffectHandle(HY,h,7,AddSpecialEffectTarget(s,u,"head"))
  call SaveEffectHandle(HY,h,8,AddSpecialEffectTarget(s,u,"chest"))
  call TriggerAddCondition(t,Condition(function InfernoTick))
  set t=null
  set u=null
endfunction

function FireLord_FireshowRanged takes nothing returns nothing
  //wrapper lvl 3
  local group g
  local unit u
  local real a
  if PRD_Get(UDSG_Attacker,'A455',GetUnitAbilityLevel(UDSG_Attacker,'A455')*5+10) then
    set a=GetAngleBetweenUnits(UDSG_Attacker,UDSG_Target)
    set g=GetAvailableGroup()
    set tt_unit1=UDSG_Attacker
    call GroupEnumUnitsInRange(g,GetUnitX(UDSG_Target)+250*Cos(a*bj_DEGTORAD),GetUnitY(UDSG_Target)+250*Sin(a*bj_DEGTORAD),275,Condition(function DefaultEnemyFilter))
    call GroupAddUnit(g,UDSG_Target)
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\BreathOfFire\\BreathOfFireDamage.mdl",u,"origin"))
      call DamageTarget(UDSG_Attacker,u,1,20+20*GetUnitAbilityLevel(UDSG_Attacker,'A455'))
      
      call GroupRemoveUnit(g,u)
    endloop
    call KillGroup(g)
  endif
endfunction

function FireLord_FireshowRangedWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A455')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
    call FireLord_FireshowRanged()
  endif
endfunction

function R6E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call SetUnitAnimationByIndex(Source,8)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function RLE takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SetUnitAnimationByIndex(Source,7)
  call TriggerRegisterTimerEvent(t,2.5,false)
  call TriggerAddCondition(t,Condition(function R6E))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=null
  set Source=null
endfunction

function XinModel_Death takes unit u returns nothing
  if GetUnitTypeId(u)=='N0M0' then
    call RLE()
  endif
endfunction

function R0E takes nothing returns nothing
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
  call DamageTarget(EG8,GetEnumUnit(),1,EH8)
endfunction

function R5E takes nothing returns boolean
  local trigger t2=GetTriggeringTrigger()
  local integer Cache2=GetHandleId(t2)
  local trigger t1=(LoadTriggerHandle(HY,(Cache2),(9)))
  local integer R2E=GetHandleId(t1)
  local unit S4E=(LoadUnitHandle(HY,(Cache2),(8)))
  local group g
  local integer Level=(LoadInteger(HY,(Cache2),5))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call ShowUnit(S4E,false)
    call KillUnit(S4E)
    call FlushChildHashtable(HY,(R2E))
    call CleanTrigger(t1)
    call FlushChildHashtable(HY,(Cache2))
    call CleanTrigger(t2)
  elseif IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(S4E)) and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0 then
    set g=GetAvailableGroup()
    set tt_unit1=S4E
    set EG8=S4E
    set EH8=100+40*Level
    call GroupEnumUnitsInRange(g,GetUnitX(S4E),GetUnitY(S4E),285,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function R0E)
    call KillGroup(g)
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetUnitX(S4E),GetUnitY(S4E)))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetUnitX(S4E),GetUnitY(S4E)))
    call ShowUnit(S4E,false)
    call KillUnit(S4E)
    call FlushChildHashtable(HY,(R2E))
    call CleanTrigger(t1)
    call FlushChildHashtable(HY,(Cache2))
    call CleanTrigger(t2)
  endif
  set t1=null
  set t2=null
  set S4E=null
  set g=null
  return false
endfunction

function S7E takes nothing returns boolean
  local trigger t1=GetTriggeringTrigger()
  local integer R2E=GetHandleId(t1)
  local trigger t2
  local integer Cache2
  local unit S4E
  local integer Level
  local real x=(LoadReal(HY,(R2E),6))
  local real y=(LoadReal(HY,(R2E),7))
  local real H1E
  local integer Count=GetTriggerEvalCount(t1)
  if Count==1 then
    call DestroyEffect((LoadEffectHandle(HY,(R2E),(3))))
  elseif Count==2 then
    call DestroyEffect((LoadEffectHandle(HY,(R2E),(4))))
    set t2=CreateTrigger()
    set Cache2=GetHandleId(t2)
    set Level=(LoadInteger(HY,(R2E),5))
    set H1E=(LoadReal(HY,(R2E),(1)))
    set S4E=CreateUnit(GetOwningPlayer((LoadUnitHandle(HY,(R2E),2))),'h07F',x,y,H1E)
    call SetUnitVertexColor(S4E,255,255,255,100)
    call UnitApplyTimedLife(S4E,'BTLF',12)
    call SaveUnitHandle(HY,(R2E),(8),(S4E))
    call SaveUnitHandle(HY,(Cache2),(8),(S4E))
    call SaveTriggerHandle(HY,(Cache2),(9),(t1))
    call SaveInteger(HY,(Cache2),5,(Level))
    call TriggerRegisterUnitInRange(t2,S4E,235,Condition(function ReturnTrue))
    call TriggerRegisterUnitEvent(t2,S4E,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t2,Condition(function R5E))
    call DestroyEffect(AddSpecialEffectTarget("effects\\ManaFlareBoltImpact_NoSound.mdx",S4E,"origin"))
  elseif Count>2 then
    set S4E=(LoadUnitHandle(HY,(R2E),(8)))
    call DestroyEffect(AddSpecialEffectTarget("effects\\ManaFlareBoltImpact_NoSound.mdx",S4E,"origin"))
  endif
  set t1=null
  set t2=null
  set S4E=null
  return false
endfunction

function Storm_StaticRemnant takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t1=CreateTrigger()
  local integer R2E=GetHandleId(t1)
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  call TriggerRegisterTimerEvent(t1,.5,true)
  call TriggerAddCondition(t1,Condition(function S7E))
  call SaveReal(HY,(R2E),6,((x)*1.))
  call SaveReal(HY,(R2E),7,((y)*1.))
  call SaveInteger(HY,(R2E),5,(GetUnitAbilityLevel(Source,'A14P')))
  call SaveUnitHandle(HY,(R2E),2,(Source))
  call SaveReal(HY,(R2E),(1),((GetUnitFacing(Source))*1.))
  call SaveEffectHandle(HY,(R2E),(3),(AddSpecialEffect("Abilities\\Spells\\Orc\\LightningShield\\LightningShieldTarget.mdl",x,y)))
  call SaveEffectHandle(HY,(R2E),(4),(AddSpecialEffect("effects\\Static_Remnant_FX.mdx",x,y)))
  set Source=null
  set t1=null
endfunction

function StormSpirit_Overload_RemoveSlow takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call UnitRemoveAbility(u,'A335')
  call UnitRemoveAbility(u,'B08B')
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function SDE takes nothing returns nothing
  //local unit Caster=CreateUnit(GetOwningPlayer(GetEnumUnit()),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.6,false,function StormSpirit_Overload_RemoveSlow)
  call SaveUnitHandle(HY,h,0,GetEnumUnit())
  call UnitAddAbility2(GetEnumUnit(),'A335')
  //call UnitAddAbility2(Caster,'A0S5')
  //call IssueTargetOrderById(Caster,852075,GetEnumUnit())
  call DamageTarget(EI8,GetEnumUnit(),1,EJ8)
  //set Caster=null
  set t=null
endfunction

function SEE takes unit Source,unit Target returns nothing
  local integer h=GetHandleId(Source)
  local group g=GetAvailableGroup()
  call DestroyEffect((LoadEffectHandle(HY,h,(200))))
  call DestroyEffect((LoadEffectHandle(HY,h,(201))))
  call SaveInteger(HY,(GetHandleId((Source))),((4264)),2)
  set tt_unit1=Source
  set EI8=Source
  set EJ8=IMaxIF(GetUnitAbilityLevel(Source,'A0QW'),GetUnitAbilityLevel(Source,'QP1V'))*20+10
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),300,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function SDE)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
  set g=null
endfunction

function SFE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,(30))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local trigger SGE=(LoadTriggerHandle(HY,h,(202)))
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and((LoadInteger(HY,(GetHandleId((Source))),((4264))))==1) then
      call DisableTrigger(t)
      call SEE(Source,Target)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call FlushChildHashtable(HY,(GetHandleId(SGE)))
      call CleanTrigger(SGE)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set Source=null
  set SGE=null
  return false
endfunction

function SHE takes nothing returns nothing
  local trigger t=CreateTrigger()
  local unit Target=GetTriggerUnit()
  local unit Source=GetAttacker()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,2.5,false)
  call TriggerAddCondition(t,Condition(function SFE))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveTriggerHandle(HY,h,(202),(GetTriggeringTrigger()))
  set t=null
  set Target=null
  set Source=null
endfunction

function SIE takes nothing returns boolean
  if GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false then
    call SHE()
  endif
  return false
endfunction

function SJE takes nothing returns nothing
  local trigger t=CreateTrigger()
  local unit Source=GetTriggerUnit()
  local integer h=GetHandleId(Source)
  local string fx=""
  if IsUnitAlly(Source,GetLocalPlayer())or IsObserver(GetLocalPlayer())then
    set fx="Abilities\\Weapons\\FarseerMissile\\FarseerMissile.mdl"
  endif
  call SaveEffectHandle(HY,h,(200),(AddSpecialEffectTarget(fx,Source,"right hand")))
  call SaveEffectHandle(HY,h,(201),(AddSpecialEffectTarget(fx,Source,"left hand")))
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function SIE))
  call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
  set t=null
  set Source=null
endfunction

function SKE takes nothing returns boolean
  local integer spell = GetSpellAbilityId()
  
  if (spell=='A14O' or spell=='A0SB' or Valid_Spell(spell))and((LoadInteger(HY,(GetHandleId((GetTriggerUnit()))),((4264))))==1)==false then
    call SaveInteger(HY,(GetHandleId((GetTriggerUnit()))),((4264)),(1))
    call SJE()
  endif
  return false
endfunction

function StormSpirit_Overload_Learn takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function SKE))
  set Source=null
  set t=null
endfunction

function SOE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real a=(LoadReal(HY,h,(13)))
  local real x=GetUnitX(Target)-5*Cos(a)
  local real y=GetUnitY(Target)-5*Sin(a)
  local integer Level=(LoadInteger(HY,h,5))
  local real x0=(LoadReal(HY,h,6))
  local real y0=(LoadReal(HY,h,7))
  if((x0-x)*(x0-x))+((y0-y)*(y0-y))<100 then
    set x=x0
    set y=y0
  endif
  call SetUnitX(Target,x)
  call SetUnitY(Target,y)
  if GetTriggerEvalCount(t)==(10+10*Level)or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function SPE takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'u00X',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  local integer Level=GetUnitAbilityLevel(Source,'A14R')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function SOE))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(13),((Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source)))*1.))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,6,((GetUnitX(Source))*1.))
  call SaveReal(HY,h,7,((GetUnitY(Source))*1.))
  call UnitAddAbility2(Caster,'A14Q')
  call SetUnitAbilityLevel(Caster,'A14Q',Level)
  call IssueTargetOrderById(Caster,852480,Target)
  call UnitApplyTimedLife(Caster,'BTLF',1+.5*Level)
  //set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  //call UnitAddAbility2(Caster,'A14S')
  //call IssueTargetOrderById(Caster,852075,Source)
  set Source=null
  set Target=null
  set Caster=null
  set t=null
endfunction

function Storm_ElectricVortex takes nothing returns nothing
  if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and IsBlocked(GetSpellTargetUnit())==false then
    call SPE()
  endif
endfunction

function SRE takes nothing returns nothing
  if(LoadBoolean(HY,(EK8),(GetHandleId(GetEnumUnit()))))==false then
    call SaveBoolean(HY,(EK8),(GetHandleId(GetEnumUnit())),(true))
    call DamageTarget(EN8,GetEnumUnit(),1,EO8*(EM8*4+4)/ 100)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",GetEnumUnit(),"origin"))
  endif
endfunction

function SSE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=(LoadInteger(HY,h,5))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit STE=(LoadUnitHandle(HY,h,(195)))
  local integer Y59=(LoadInteger(HY,h,(194)))
  local real TargetX=(LoadReal(HY,h,6))
  local real TargetY=(LoadReal(HY,h,7))
  local real NHE=GetUnitX(Source)
  local real NIE=GetUnitY(Source)
  local real a=Atan2(TargetY-NIE,TargetX-NHE)
  local real AO8=NHE+(25+25*Level)*Cos(a)
  local real AP8=NIE+(25+25*Level)*Sin(a)
  local lightning ZQ8=(LoadLightningHandle(HY,h,(196)))
  local real lx=(LoadReal(HY,h,(197)))
  local real ly=(LoadReal(HY,h,(198)))
  local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
  local real SUE=(25+25*Level)*(12+.007*GetUnitState(Source,UNIT_STATE_MAX_MANA))/ 100
  local group g=GetAvailableGroup()
  local real SVE=(LoadReal(HY,h,(199)))
  set SVE=SVE+25+25*Level
  call SaveReal(HY,h,(199),((SVE)*1.))
  if GetTriggerEvalCount(t)>25 then
    set lx=lx+(25+25*Level)*Cos(a)
    set ly=ly+(25+25*Level)*Sin(a)
    call SaveReal(HY,h,(197),((lx)*1.))
    call SaveReal(HY,h,(198),((ly)*1.))
  endif
  call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(IVD-SUE,0))
  call MoveLightning(ZQ8,true,lx,ly,AO8,AP8)
  if IsUnitType(Source,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
  endif
  call SetUnitX(Source,AO8)
  call SetUnitY(Source,AP8)
  call SetUnitPosition(Caster,AO8,AP8)
  call SetUnitPosition(STE,AO8,AP8)
  set tt_unit1=Source
  set EN8=Source
  set EK8=h
  set EM8=Level
  set EO8=SVE
  call GroupEnumUnitsInRange(g,AO8,AP8,75+75*Level,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function SRE)
  call KillGroup(g)
  set Y59=Y59-1
  call SaveInteger(HY,h,(194),(Y59))
  call SetTint(Source,-1,-1,-1,0)
  if Y59==0 or GetUnitState(Source,UNIT_STATE_MANA)<1 then
    call DestroyLightning(ZQ8)
    call KillTrees(AO8,AP8,75)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call RemoveUnit(Caster)
    call RemoveUnit(STE)
    call SetTint(Source,-1,-1,-1,255)
    call SetUnitPathing(Source,true)
    call SetUnitInvulnerable(Source,false)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call KillTrees(AO8,AP8,75)
  endif
  set t=null
  set Caster=null
  set Source=null
  set ZQ8=null
  set g=null
  set STE=null
  return false
endfunction

function Storm_BallLightning takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local unit Caster
  local unit STE
  local real x
  local real y
  local trigger t
  local integer h
  local lightning ZQ8
  local integer Level=GetUnitAbilityLevel(Source,'A14O')
  local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
  local real SUE=15+.07*GetUnitState(Source,UNIT_STATE_MAX_MANA)
  call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(IVD-SUE,0))
  if GetUnitState(Source,UNIT_STATE_MANA)>10 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    set Caster=CreateUnit(GetOwningPlayer(Source),'o010',SourceX,SourceY,0)
    set STE=CreateUnit(GetOwningPlayer(Source),'H07G',SourceX,SourceY,0)
    set ZQ8=AddLightning("FORK",true,SourceX,SourceY,SourceX,SourceY)
    if GetSpellTargetUnit()==null then
      set x=GetSpellTargetX()
      set y=GetSpellTargetY()
    else
      set x=GetUnitX(GetSpellTargetUnit())
      set y=GetUnitY(GetSpellTargetUnit())
    endif
    //call SetUnitVertexColor(Source,255,255,255,0)
    call SetTint(Source,-1,-1,-1,0)
    call SetUnitVertexColor(STE,255,255,255,0)
    call SetUnitPathing(Source,false)
    call SetUnitPathing(Caster,false)
    call SetUnitInvulnerable(Source,true)
    call SaveUnitHandle(HY,h,(19),(Caster))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,(195),(STE))
    call SaveLightningHandle(HY,h,(196),(ZQ8))
    call SaveInteger(HY,h,5,(Level))
    call SaveReal(HY,h,6,((x)*1.))
    call SaveReal(HY,h,7,((y)*1.))
    call SaveReal(HY,h,(197),((SourceX)*1.))
    call SaveReal(HY,h,(198),((SourceY)*1.))
    call SaveReal(HY,h,(199),((0)*1.))
    call SaveInteger(HY,h,(194),(IMaxIF(R2I(SquareRoot((x-SourceX)*(x-SourceX)+(y-SourceY)*(y-SourceY))/(25+25*Level)),1)))
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",STE,"origin")))
    call TriggerRegisterTimerEvent(t,.04,true)
    call TriggerAddCondition(t,Condition(function SSE))
    call ShowUnit(Source,false)
    call ShowUnit(Source,true)
    call SelectUnitAddForPlayer(Source,GetOwningPlayer(Source))
  endif
  set Source=null
  set Caster=null
  set STE=null
  set t=null
  set ZQ8=null
endfunction

function Storm_BallLightning_OnCast takes nothing returns nothing
  if GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)<(15+.07*GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_MANA))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0G8'))
  endif
endfunction


function StormOld_LightningGrapple_ForGroup2 takes nothing returns nothing
  call SetUnitPathing(GetEnumUnit(),true)
  if IsUnitEnemy(GetEnumUnit(),GetOwningPlayer(LightningGrappleUnit)) then
    call DamageTarget(LightningGrappleUnit,GetEnumUnit(),1,LightningGrappleDmg)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",GetEnumUnit(),"origin"))
  endif
endfunction

function StormOld_LightningGrapple_ForGroup takes nothing returns nothing
  call SetUnitPosition(GetEnumUnit(),GetUnitX(GetEnumUnit())+40*Cos(LightningGrappleAngle),GetUnitY(GetEnumUnit())+40*Sin(LightningGrappleAngle))
  call KillTrees(GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),200)
  call SetUnitPathing(GetEnumUnit(),false)
endfunction

function StormOld_LightningGrapple_Periodic takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local real a=LoadReal(HY,h,0)
  local integer c=LoadInteger(HY,h,0)-1
  local unit caster=LoadUnitHandle(HY,h,0)
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local group g
  if c<1 or DistanceBetweenXY(x,y,LoadReal(HY,h,1),LoadReal(HY,h,2))<50 then//its time to land
    set LightningGrappleUnit=caster
    set LightningGrappleDmg=LoadInteger(HY,h,5)*50+50
    set g=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(g,x,y,275,Condition(function DefaultEnemyFilter))
    call GroupAddGroup(g,LoadGroupHandle(HY,h,10))
    call ForGroup(LoadGroupHandle(HY,h,10),function StormOld_LightningGrapple_ForGroup2)
    call KillGroup(g)
    call KillTrees(x,y,200)
    call DestroyLightning(LoadLightningHandle(HY,h,11))
    call KillGroup(LoadGroupHandle(HY,h,10))
    call CleanTimer(t)
  else
    set LightningGrappleAngle=a
    call ForGroup(LoadGroupHandle(HY,h,10),function StormOld_LightningGrapple_ForGroup)
    call MoveLightning(LoadLightningHandle(HY,h,11),true,x,y,LoadReal(HY,h,1),LoadReal(HY,h,2))
    call SaveInteger(HY,h,0,c)
  endif
  
  set caster=null
  set t=null
endfunction

function StormOld_LightningGrapple_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsDead(GetFilterUnit())==false
endfunction

function StormOld_LightningGrapple takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local real dx=GetSpellTargetX()
  local real dy=GetSpellTargetY()
  local real angle=AngleBetweenXY(x,y,dx,dy)*bj_DEGTORAD
  local group g=GetAvailableGroup()
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local lightning l
  local real limit=800+200*GetUnitAbilityLevel(caster,GetSpellAbilityId())
  if DistanceBetweenXY(x,y,dx,dy)>limit then
    set dx=x+limit*Cos(angle)
    set dy=y+limit*Sin(angle)
  endif
  set l=AddLightning("CLPB",true,x,y,dx,dy)
  call SetLightningColor(l,.75,.75,1,.75)
  call GroupEnumUnitsInRange(g,x,y,350,Condition(function StormOld_LightningGrapple_Filter))
  call TimerStart(t,0.03,true,function StormOld_LightningGrapple_Periodic)
  call SaveInteger(HY,h,0,R2I(DistanceBetweenXY(x,y,dx,dy)/40)+1)
  call SaveReal(HY,h,0,angle)
  call SaveInteger(HY,h,5,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
  call SaveGroupHandle(HY,h,10,g)
  call SaveLightningHandle(HY,h,11,l)
  call SaveUnitHandle(HY,h,0,caster)
  call SaveReal(HY,h,1,dx)
  call SaveReal(HY,h,2,dy)
  set l=null
  set t=null
  set caster=null
  set g=null
endfunction

function CheatDeath_InvulAfter takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  local unit source=LoadUnitHandle(HY,GetHandleId(t),1)
  local real dmg=LoadReal(HY,GetHandleId(t),0)
  call SetUnitInvulnerable(u,false)
  call DamageTarget(source,u,2,dmg)
  call CleanTimer(t)
  set t=null
  set u=null
  set source=null
endfunction

function CheatDeath_invul takes unit u, real dmgleft, unit source returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function CheatDeath_InvulAfter)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveUnitHandle(HY,GetHandleId(t),1,source)
  call SaveReal(HY,GetHandleId(t),0,dmgleft)
  call SetUnitInvulnerable(u,true)
  set t=null
endfunction

function CheatDeath_ResetAct takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitAddAbility2(u,'A34D')
  call SaveInteger(HY,GetHandleId(u),'DEAT',2)
  call CleanTimer(t)
  set t=null
  set u=null
endfunction

function CheatDeath_Reset takes unit u, real cd returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,cd,false,function CheatDeath_ResetAct)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call UnitRemoveAbility(u,'A34D')
  call UnitRemoveAbility(u,'B0H7')
  call SaveInteger(HY,GetHandleId(u),'DEAT',1)
  call IssueImmediateOrder(u,"magicdefense")
  set t=null
endfunction

function CheatDeath_Tick takes nothing returns nothing
  local unit u
  local real dmg
  local real curhp
  local real heal
  local integer lvl
  local trigger t=GetTriggeringTrigger()
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    set u=GetTriggerUnit()
    set dmg=GetEventDamage()
    set curhp=GetWidgetLife(u)
    if LoadInteger(HY,GetHandleId(u),'DEAT')!=1 then
      if dmg>=curhp/2 and IsDead(u)==false and GetUnitAbilityLevel(u,'B0H7')==1 then
        call TextTagOnUnit(GetUnitName(u)+" just Cheated Death!!",5,u,.03,255,0,0,255)
        set lvl=GetUnitAbilityLevel(u,'A34A')
        if dmg>=GetUnitState(u,UNIT_STATE_MAX_LIFE) then
          call CheatDeath_invul(u,dmg*(0.45-0.05*lvl),GetEventDamageSource())
        else
          call HealUnitFor(u,dmg*(0.55+0.05*lvl))
        endif
        call DamageTarget(u,GetEventDamageSource(),3,dmg*(0.55+0.05*lvl))
        call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(u),'h028',GetUnitX(u),GetUnitY(u),AngleBetweenXY(GetUnitX(u),GetUnitY(u),GetUnitX(GetEventDamageSource()),GetUnitY(GetEventDamageSource()))),'BTLF',0.4)
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\DispelMagic\\DispelMagicTarget.mdl",u,"overhead"))
        if LoadBoolean(HY,GetHandleId(t),0)==false then
          call CheatDeath_Reset(u,14-lvl)
        else
          call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'A34D')
          call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'B0H7')
          call FlushChildHashtable(HY,GetHandleId(t))
          call CleanTrigger(t)
        endif
      elseif dmg>1000 then
        call HealUnitFor(u,dmg-1000)
      endif
    endif
  else
    call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'A34D')
    call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'B0H7')
    call FlushChildHashtable(HY,GetHandleId(t))
    call CleanTrigger(t)
    
  endif
  set u=null
  set t=null
endfunction

function CheatDeath_Learn takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function CheatDeath_Tick))
  call UnitAddAbility2(u,'A34D')
  call SaveBoolean(HY,GetHandleId(t),0,false)
  set t=null
  set u=null
endfunction

function CheatDeath_Use takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  call CheatDeath_Reset(u,14-lvl)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,14-lvl,false)
  call TriggerAddCondition(t,Condition(function CheatDeath_Tick))
  call UnitAddAbility2(target,'A34D')
  call SaveUnitHandle(HY,GetHandleId(t),0,target)
  call SaveBoolean(HY,GetHandleId(t),0,true)
  set t=null
  set target=null
  set u=null
endfunction

function CheatDeath_Cast takes nothing returns nothing
  if IsUnitIllusion(GetSpellTargetUnit()) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Can't be used on illusions")
  endif
endfunction

function DK_DragonForm_TailFix takes unit Source returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'A2AI')
  if isMorphedUnit(Source)==true and GetUnitAbilityLevel(Source,'QF0O')>0 then
    if Mode_EB==false then
      call SetUnitAbilityLevel(Source,'A0AR',Level)
    else
      call SetUnitAbilityLevel(Source,'QB0G',Level)
    endif
  else
    if Mode_EB==false then
      call SetUnitAbilityLevel(Source,'A0AR',Level)
    else
      call SetUnitAbilityLevel(Source,'QB0G',Level)
    endif
  endif
endfunction

function DragonKnight_DragonTail_Leveling takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A2AI')
  if Level==1 then
    if Mode_EB==false then
      call UnitAddAbility2(Source,'A0AR')
    else
      call UnitAddAbility2(Source,'QB0G')
    endif
  endif
  call DK_DragonForm_TailFix(Source)
  set Source=null
endfunction

function DK_DragonTailHit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(), (LoadReal(HY,h,0)*0.25)+2.25)
      call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,25*LoadReal(HY,h,0))
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function DK_DragonTail_Stun takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(d,'A42F')
  if IssueTargetOrder(d,"thunderbolt",target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3.5,false)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function DK_DragonTailHit))
    call SaveUnitHandle(HY,h,0,d)
    call SaveUnitHandle(HY,h,1,caster)
    call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
    set t=null
  endif
  set d=null
  set caster=null
  set target=null
endfunction

function DK_DragonTail takes nothing returns nothing
  local unit u=GetTriggerUnit()
  if GetUnitTypeId(u)=='H00G' or GetUnitTypeId(u)=='H00F' or GetUnitTypeId(u)=='H00E' then
    call SetUnitAnimation(u,"stand")
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Defend\\DefendCaster.mdl",u,"head"))
  elseif GetUnitTypeId(u)=='Hlgr' then
    call SetUnitAnimation(u,"stand defend")
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Defend\\DefendCaster.mdl",u,"origin"))
  endif
  set u=null
  if IsBlocked(GetSpellTargetUnit())==false then
    call DK_DragonTail_Stun()
  endif
endfunction

function DK_Tail_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0AR')
  call PreloadQueryAdd('QB0G')
endfunction

function DK_DragonBlood_Act takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A0CL')+GetUnitAbilityLevel(u,'QP0J')
  call SetPlayerTechResearched(GetOwningPlayer(u),'R006',lvl)
  set u=null
endfunction

function DK_DragonForm_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call DK_DragonForm_TailFix(Source)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set Source=null
  return false
endfunction

function DK_DragonForm_OnDeath takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call DK_DragonForm_TailFix(Source)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set Source=null
  return false
endfunction

function DK_DragonForm_ChangeTail takes nothing returns nothing
  if GetUnitAbilityLevel(tt_unit1,'A0AR')>0 or GetUnitAbilityLevel(tt_unit1,'QB0G')>0 then
    call DK_DragonForm_TailFix(tt_unit1)
  endif
endfunction

function DK_DragonForm_Act takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function DK_DragonForm_Duration))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function DK_DragonForm_OnDeath))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set t=null
endfunction

function ElderDragon_CorrosiveBreath takes unit attacker, unit target returns nothing
  local unit d=CreateUnit(GetOwningPlayer(attacker),'u01H',GetUnitX(target),GetUnitY(target),0)
  call UnitAddAbility(d,'A0O4')
  call UnitAddAbility(d,'Aloc')
  call UnitAddAbility(d,'A1DZ')
  call ShowUnit(d,false)
  call IssueTargetOrder(d,"attack",target)
  call UnitApplyTimedLife(d,'BTLF',0.9)
  set d=null
endfunction

function Kaolin_GG_RestorePathing takes nothing returns nothing
  local unit u=GetEnumUnit()
  if GetUnitTypeId(u)!='o01X' then
    call SetUnitPathing(u,true)
  endif
  call SaveInteger(HY,(GetHandleId((u))),((4336)),2)
  set u=null
endfunction

function Kaolin_GG_STFU takes unit target returns nothing
  local unit d=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
  call UnitAddAbility(d,'A2TG')
  call SetUnitAbilityLevel(d,'A2TG',KaolinGGTempLvl)
  call IssueTargetOrder(d,"soulburn",target)
  set d=null
endfunction

function Kaolin_GG_StunEnemy takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),KaolinGGTempGroup)==false then
    call GroupAddUnit(KaolinGGTempGroup,GetEnumUnit())
    call Kaolin_GG_STFU(GetEnumUnit())
    if KaolinGGBuffedByStone==1 then
      call DamageTarget(KaolinGGTempUnit,GetEnumUnit(),1,50+50*KaolinGGTempLvl)
    endif
  endif
endfunction

function Kaolin_GeomagneticGrip_AddEffect takes nothing returns nothing
  local unit u=GetEnumUnit()
  local real angle=(LoadReal(HY,(GetHandleId(u)),(801)))
  local real speed=(LoadReal(HY,(GetHandleId(u)),(802)))
  local real newX=KaolinGeoGripTempX+speed*Cos(angle)
  local real newY=KaolinGeoGripTempY+speed*Sin(angle)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",newX,newY))
  if GetUnitTypeId(u)=='o01X' or GetUnitTypeId(u)=='o020' then
    set KaolinGGBuffedByStone=1
    call SetUnitPosition(u,newX,newY)
    call SetUnitX(u,newX)
    call SetUnitY(u,newY)
  else
    call SetUnitX(u,newX)
    call SetUnitY(u,newY)
    call KillTrees(newX,newY,100)
  endif
  set u=null
endfunction

function Kaolin_GG_RemoveSomeTarget takes nothing returns nothing
  local unit u=GetEnumUnit()
  if IsDead(u)==true or((LoadInteger(HY,(GetHandleId((u))),((4306))))==1)==true or GetUnitAbilityLevel(u,'B08V')>0 or((LoadInteger(HY,(GetHandleId((u))),((4335))))==1)==true then
    call GroupRemoveUnit(KaolinGGTempGroup,u)
    call SaveInteger(HY,(GetHandleId((u))),((4336)),2)
    if GetUnitTypeId(u)!='o01X' then
      call SetUnitPathing(u,true)
    endif
  endif
  set u=null
endfunction

function Kaolin_GeomagneticGrip_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local group g=(LoadGroupHandle(HY,h,(803)))
  local real casterX=(LoadReal(HY,h,6))
  local real casterY=(LoadReal(HY,h,7))
  local real targetX=(LoadReal(HY,h,(23)))
  local real targetY=(LoadReal(HY,h,(24)))
  local real angle=bj_DEGTORAD*AngleBetweenXY(targetX,targetY,casterX,casterY)
  local real newTX
  local real newTY
  local boolean b=false
  local group gg=(LoadGroupHandle(HY,h,(187)))
  local group lol3rdgroup
  set KaolinGGBuffedByStone=0
  set KaolinGGTempGroup=g
  call ForGroup(g,function Kaolin_GG_RemoveSomeTarget)
  if GetTriggerEvalCount(t)>200 or FirstOfGroup(g)==null then
    set b=true
  else
    set newTX=targetX+1000*0.03*Cos(angle)
    set newTY=targetY+1000*0.03*Sin(angle)
    if DistanceBetweenXY(newTX,newTY,casterX,casterY)<30 then
      set newTX=casterX
      set newTY=casterY
      set b=true
    endif
    set newTX=SafeX50(newTX)
    set newTY=SafeY50(newTY)
    set KaolinGGTempGroup=g
    set KaolinGeoGripTempX=newTX
    set KaolinGeoGripTempY=newTY
    call ForGroup(g,function Kaolin_GeomagneticGrip_AddEffect)
    call SaveReal(HY,h,(23),((newTX)*1.0))
    call SaveReal(HY,h,(24),((newTY)*1.0))
    set lol3rdgroup=GetAvailableGroup()
    set tt_unit1=caster
    set KaolinGGTempGroup=gg
    set KaolinGGTempUnit=caster
    set KaolinGGTempLvl=GetUnitAbilityLevel(caster,'A2QI')
    call GroupEnumUnitsInRange(lol3rdgroup,newTX,newTY,205,Condition(function DefaultEnemyFilter))
    call ForGroup(lol3rdgroup,function Kaolin_GG_StunEnemy)
    call KillGroup(lol3rdgroup)
    set lol3rdgroup=null
  endif
  if b then
    call ForGroup(g,function Kaolin_GG_RestorePathing)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillGroup(gg)
    call KillGroup(g)
  endif
  set caster=null
  set t=null
  set gg=null
  set g=null
  return false
endfunction

function IsStone takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='o01X' and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(tt_unit1)
endfunction

function Kaolin_GeomagneticGrip_ForGroup takes nothing returns nothing
  local unit u=GetEnumUnit()
  call SetUnitPathing(u,false)
  call SaveInteger(HY,(GetHandleId((u))),((4336)),(1))
  call SaveReal(HY,(GetHandleId(u)),(801),((bj_DEGTORAD*AngleBetweenXY(KaolinGeoGripTempX,KaolinGeoGripTempY,GetUnitX(u),GetUnitY(u)))*1.0))
  call SaveReal(HY,(GetHandleId(u)),(802),((DistanceBetweenXY(KaolinGeoGripTempX,KaolinGeoGripTempY,GetUnitX(u),GetUnitY(u)))*1.0))
  set u=null
endfunction

function Kaolin_GeomagneticGrip_Effect takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local trigger t
  local integer h
  local real targetX=GetUnitX(GetSpellTargetUnit())
  local real targetY=GetUnitY(GetSpellTargetUnit())
  local real casterX=GetUnitX(caster)
  local real casterY=GetUnitY(caster)
  local real angle=AngleBetweenXY(casterX,casterY,targetX,targetY)
  local unit target=GetSpellTargetUnit()
  local group g
  if target==null then
    set g=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function IsStone))
    if FirstOfGroup(g)==null then
      call KillGroup(g)
      set caster=null
      set g=null
      return
    endif
    set target=FirstOfGroup(g)
    call KillGroup(g)
  endif
  set g=GetAvailableGroup()
  call GroupAddUnit(g,target)
  set targetX=GetUnitX(target)
  set targetY=GetUnitY(target)
  set angle=AngleBetweenXY(casterX,casterY,targetX,targetY)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set KaolinGeoGripTempX=targetX
  set KaolinGeoGripTempY=targetY
  call ForGroup(g,function Kaolin_GeomagneticGrip_ForGroup)
  set casterX=casterX+100*Cos(angle*bj_DEGTORAD)
  set casterY=casterY+100*Sin(angle*bj_DEGTORAD)
  call TriggerRegisterTimerEvent(t,0.03,true)
  call TriggerAddCondition(t,Condition(function Kaolin_GeomagneticGrip_Duration))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveReal(HY,h,6,((casterX)*1.0))
  call SaveReal(HY,h,7,((casterY)*1.0))
  call SaveReal(HY,h,(23),((targetX)*1.0))
  call SaveReal(HY,h,(24),((targetY)*1.0))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call SaveGroupHandle(HY,h,(803),(g))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\MagneticGripTarget.mdx",target,"chest")))
  set caster=null
  set t=null
  set g=null
  set target=null
endfunction

function Kaolin_GeomagneticGrip_Cast takes nothing returns nothing
  local unit target=GetSpellTargetUnit()
  local group g
  if target==null then
    set g=GetAvailableGroup()
    set tt_unit1=GetTriggerUnit()
    call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function IsStone))
    if FirstOfGroup(g)==null then
      call InterruptUnit(GetTriggerUnit())
      if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
        call Error(GetOwningPlayer(GetTriggerUnit()),"No nearby Rock found")
      endif
    endif
    call KillGroup(g)
  endif
  set g=null
  set target=null
endfunction

function Kaolin_RollingBoulder_SlowFilter takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and IsUnitEnemy(KaolinTempRollingCaster,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((809))))==1)
endfunction

function Kaolin_RollingBoulder_SlowApply takes nothing returns nothing
  call UnitAddAbilityTimedEx((GetEnumUnit()),'A2QN',1,2,'B0GK')
endfunction

function Kaolin_RollingBoulder_Slow takes unit target returns nothing
  local group g=GetAvailableGroup()
  if((LoadInteger(HY,(GetHandleId((target))),((809))))==1)==true then
    call GroupEnumUnitsInRange(g,0,0,99999,Condition(function Kaolin_RollingBoulder_SlowFilter))
  endif
  call GroupAddUnit(g,target)
  call ForGroup(g,function Kaolin_RollingBoulder_SlowApply)
  call KillGroup(g)
  set g=null
endfunction

function Kaolin_RollingBoulder_Damage takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),KaolinTempRollingGroup)==false then
    call GroupAddUnit(KaolinTempRollingGroup,GetEnumUnit())
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
      set KaolinRollingBoulderTempBool=true
      set KaolinClosestTarget=GetEnumUnit()
      if((LoadInteger(HY,(GetHandleId((GetEnumUnit()))),((809))))==1)then
        set KaolinRollingTempUnit=GetEnumUnit()
      endif
      if KaolinTempRollingBuffed==1 then
        call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage*1.5)
        call Kaolin_RollingBoulder_Slow(GetEnumUnit())
      else
        call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage)
      endif
    else
      if KaolinTempRollingBuffed==1 then
        call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage*1.5)
      else
        call DamageTarget(KaolinTempRollingCaster,GetEnumUnit(),1,KaolinTempRollingDamage)
      endif
    endif
  endif
endfunction

function Kaolin_RollingBoulder_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local group g=(LoadGroupHandle(HY,h,(187)))
  local group gg
  local unit dummy=(LoadUnitHandle(HY,h,(19)))//vision only
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local real curX=GetUnitX(caster)
  local real curY=GetUnitY(caster)
  local real distTraveled=DistanceBetweenXY(x,y,curX,curY)
  local real newX
  local real newY
  local real savedAngle=(LoadReal(HY,h,(137)))
  local real speed=800
  local integer RollingWithStone=(LoadInteger(HY,h,(34)))
  local real totalTraveled=(LoadReal(HY,h,(138)))
  local boolean b=false
  local unit target=(LoadUnitHandle(HY,h,(810)))
  set KaolinRollingBoulderTempBool=false
  call SetUnitTimeScale(caster,3)
  call SetUnitFacing(caster,savedAngle)
  call SetUnitAnimationByIndex(caster,0)
  if GetTriggerEvalCount(t)>30 then
    if RollingWithStone==0 then
      set gg=GetAvailableGroup()
      set tt_unit1=caster
      call GroupEnumUnitsInRange(gg,curX,curY,175,Condition(function IsStone))
      if FirstOfGroup(gg)!=null then
        call KillUnit(FirstOfGroup(gg))
        set RollingWithStone=1
        call SaveInteger(HY,h,(34),(RollingWithStone))
      endif
      call KillGroup(gg)
    endif
    if RollingWithStone==1 then
      set speed=speed*2
    endif
    if target!=null then
      set savedAngle=GetAngleBetweenUnits(caster,target)
      call SaveReal(HY,h,(137),((savedAngle)*1.0))
    endif
    set newX=x+0.02*speed*Cos(savedAngle*bj_DEGTORAD)
    set newY=y+0.02*speed*Sin(savedAngle*bj_DEGTORAD)
    if IsUnitType(caster,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
    endif
    call SetUnitX(caster,SafeX50(newX))
    call SetUnitY(caster,SafeY50(newY))
    call SaveReal(HY,h,6,((GetUnitX(caster))*1.0))
    call SaveReal(HY,h,7,((GetUnitY(caster))*1.0))
    call SetUnitX(dummy,GetUnitX(caster))
    call SetUnitY(dummy,GetUnitY(caster))
    call KillTrees(GetUnitX(caster),GetUnitY(caster),100)
    set distTraveled=DistanceBetweenXY(x,y,GetUnitX(caster),GetUnitY(caster))
    set totalTraveled=totalTraveled+distTraveled
    call SaveReal(HY,h,(138),((totalTraveled)*1.0))
    set gg=GetAvailableGroup()
    set tt_unit1=caster
    set KaolinTempRollingCaster=caster
    set KaolinTempRollingGroup=g
    set KaolinTempRollingLvl=GetUnitAbilityLevel(caster,'A2TJ')
    set KaolinClosestTarget=null
    set KaolinTempRollingDamage=60+30*KaolinTempRollingLvl
    set KaolinTempRollingBuffed=RollingWithStone
    set KaolinRollingTempUnit=null
    call GroupEnumUnitsInRange(gg,GetUnitX(caster),GetUnitY(caster),175,Condition(function DefaultEnemyFilter))
    call ForGroup(gg,function Kaolin_RollingBoulder_Damage)
    call KillGroup(gg)
    if KaolinRollingTempUnit!=null then
      set gg=GetAvailableGroup()
      set KaolinClosestTarget=null
      set KaolinDistanceTemp=9999
      call GroupEnumUnitsInRange(gg,GetUnitX(KaolinRollingTempUnit),GetUnitY(KaolinRollingTempUnit),625,Condition(function Kaolin_RollingBoulder_SlowFilter))
      call KillGroup(gg)
      if KaolinClosestTarget==null then
        set b=true
        set KaolinClosestTarget=KaolinRollingTempUnit
      else
        set target=KaolinClosestTarget
        call SaveUnitHandle(HY,h,(810),(target))
      endif
    endif
  else
    if IsUnitType(caster,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
    endif
    call SetUnitX(caster,x)
    call SetUnitY(caster,y)
  endif
  if IsUnitDisabled(caster)or GetTriggerEventId()==EVENT_WIDGET_DEATH or b or(target==null and(GetTriggerEvalCount(t)>130 or KaolinRollingBoulderTempBool or(RollingWithStone==0 and totalTraveled>800)or(RollingWithStone==1 and totalTraveled>1600)))then
    call KillUnit(dummy)
    call KillGroup(g)
    call DestroyEffect(LoadEffectHandle(HY,h,5))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitTimeScale(caster,1)
    if KaolinRollingBoulderTempBool==true then
      set newX=GetUnitX(KaolinClosestTarget)+50*Cos(savedAngle*bj_DEGTORAD)
      set newY=GetUnitY(KaolinClosestTarget)+50*Sin(savedAngle*bj_DEGTORAD)
      if IsUnitType(caster,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(caster),99,true)
      endif
      call SetUnitX(caster,SafeX50(newX))
      call SetUnitY(caster,SafeY50(newY))
      call IssueTargetOrder(caster,"attack",KaolinClosestTarget)
    endif
  endif
  set caster=null
  set t=null
  set gg=null
  set g=null
  set dummy=null
  set target=null
  return false
endfunction

function Kaolin_RollingBoulder_Start takes unit caster,unit target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d=CreateUnit(GetOwningPlayer(caster),'o01P',GetUnitX(caster),GetUnitY(caster),0)
  local real angle=AngleBetweenXY(GetUnitX(caster),GetUnitY(caster),GetSpellTargetX(),GetSpellTargetY())
  call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("war3mapImported\\RollingBoulder.mdx",caster,"origin"))
  call SetUnitTimeScale(caster,3)
  call TriggerRegisterDeathEvent(t,caster)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerAddCondition(t,Condition(function Kaolin_RollingBoulder_Duration))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call SaveUnitHandle(HY,h,(19),(d))
  call SaveReal(HY,h,6,((GetUnitX(caster))*1.0))
  call SaveReal(HY,h,7,((GetUnitY(caster))*1.0))
  call SaveReal(HY,h,(137),((angle)*1.0))
  call SaveInteger(HY,h,(34),(0))
  call SaveReal(HY,h,(138),((0)*1.0))
  call SaveUnitHandle(HY,h,(810),(null))
  if target!=null and GetUnitTypeId(target)=='o01X' then
    call KillUnit(target)
  endif
  set t=null
  set d=null
endfunction

function Kaolin_RollingBoulder_Check takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local real cooldown=(LoadReal(HY,h,(442)))
  local integer stonesLeft=(LoadInteger(HY,(GetHandleId(caster)),(800)))
  if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
    if(GetSpellAbilityId()=='A2TH')and stonesLeft<=0 then
      call Error(GetOwningPlayer(caster),"No stones left")
      call InterruptUnit(caster)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A2TH' or GetSpellAbilityId()=='A2TJ' then
      if GetSpellAbilityId()=='A2TJ' then
        call Kaolin_RollingBoulder_Start(caster,null)
      endif
    endif
  elseif stonesLeft<6 then
    set cooldown=cooldown-0.2
    call SaveReal(HY,h,(442),((cooldown)*1.0))
    if cooldown<=0.then
      //call UnitRemoveAbility(caster,Kaolin_StoneChargesIndicator[stonesLeft])
      set stonesLeft=stonesLeft+1
      //call UnitAddAbility2(caster,Kaolin_StoneChargesIndicator[stonesLeft])
      call SaveInteger(HY,(GetHandleId(caster)),(800),(stonesLeft))
      call SaveReal(HY,h,(442),((25)*1.0))
    endif
  endif
  set caster=null
  set t=null
  return false
endfunction

function Kaolin_RollingBoulder_Init takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.2,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_CAST)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_EFFECT)
  
  call TriggerAddCondition(t,Condition(function Kaolin_RollingBoulder_Check))
  call SaveUnitHandle(HY,h,2,(u))
  call SaveReal(HY,h,442,30.0)//stone recharging time
  call SaveInteger(HY,(GetHandleId(u)),(800),6)
  //call UnitAddAbility2(u,Kaolin_StoneChargesIndicator[6])
  set t=null
endfunction

function Kaolin_Stones_DeathAct takes unit deadStone returns nothing
  local unit kaolin=udg_Hero[GetPlayerId(GetOwningPlayer(deadStone))]
  local integer h=GetHandleId(kaolin)
  local integer lvl=GetUnitAbilityLevel(kaolin,'A2TH')
  local integer alreadyPlaced=(LoadInteger(HY,h,(279)))
  local integer i=1
  local integer k=1
  local unit tempStone
  loop
    exitwhen i>alreadyPlaced
    set tempStone=(LoadUnitHandle(HY,h,(1400+i)))
    if IsDead(tempStone)==false then
      call SaveUnitHandle(HY,h,(1400+k),(tempStone))
      set k=k+1
    endif
    set i=i+1
  endloop
  set alreadyPlaced=alreadyPlaced-1
  call SaveInteger(HY,h,(279),(alreadyPlaced))
  set tempStone=null
  set kaolin=null
endfunction

function Kaolin_Stones_Death takes nothing returns boolean
  if GetUnitTypeId(GetTriggerUnit())=='o01X' then
    call Kaolin_Stones_DeathAct(GetTriggerUnit())
  endif
  return false
endfunction

function Kaolin_Stones_SummonStart takes nothing returns nothing
  local unit newStone
  local unit caster=GetTriggerUnit()
  local integer h=GetHandleId(caster)
  local integer lvl=GetUnitAbilityLevel(caster,'A2TH')
  local integer alreadyPlaced=(LoadInteger(HY,h,(279)))
  local unit firstStone=(LoadUnitHandle(HY,h,(1401)))
  local real x
  local real y
  local integer stonesLeft=(LoadInteger(HY,(GetHandleId(caster)),(800)))
  if stonesLeft>0 then
    //call UnitRemoveAbility(caster,Kaolin_StoneChargesIndicator[stonesLeft])
    set stonesLeft=IMaxBJ(0,stonesLeft-1)
    if stonesLeft<2 then
      call DisplayTimedTextToPlayer(GetOwningPlayer(caster),0,0,10,I2S(stonesLeft)+" stones left")
    endif
    
    //call UnitAddAbility2(caster,Kaolin_StoneChargesIndicator[stonesLeft])
    call SaveInteger(HY,(GetHandleId(caster)),(800),(stonesLeft))
    if GetSpellTargetUnit()==null then
      set x=GetSpellTargetX()
      set y=GetSpellTargetY()
    else
      set x=GetUnitX(GetSpellTargetUnit())
      set y=GetUnitY(GetSpellTargetUnit())
    endif
    set newStone=CreateUnit(GetOwningPlayer(caster),'o01X',x,y,0)
    call SaveInteger(HY,GetHandleId(newStone),4335,0)
    call SaveInteger(HY,GetHandleId(newStone),4340,0)
    call UnitApplyTimedLife(newStone,'BTLF',120)
    call SetUnitPathing(newStone,false)
    set alreadyPlaced=alreadyPlaced+1
    call SaveUnitHandle(HY,h,(1400+alreadyPlaced),(newStone))
    call SaveInteger(HY,h,(279),(alreadyPlaced))
    if(alreadyPlaced>6)then
      call KillUnit(firstStone)
    endif
  else
    call Error(GetOwningPlayer(caster),"No stones available")
  endif
  set newStone=null
  set caster=null
  set firstStone=null
endfunction

function Kaolin_Stones_Summon takes nothing returns boolean
  if GetSpellAbilityId()=='A2TH' then
    call Kaolin_Stones_SummonStart()
  endif
  return false
endfunction

function Kaolin_Stones_Reg takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Kaolin_Stones_Death))
  set t=null
endfunction

function Kaolin_BoulderSmash_Filter takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and IsUnitEnemy(KaolinTempCaster,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((809))))==1)
endfunction

function Kaolin_BoulderSmash_Helper takes nothing returns nothing
  call StunTargetLod(GetEnumUnit(),0.25+0.5*KaolinsPushLevelStorage)
endfunction

function Kaolin_BoulderSmash_StunApp takes unit u returns nothing
  local group g=GetAvailableGroup()
  if((LoadInteger(HY,(GetHandleId((u))),((809))))==1)==true then
    call GroupEnumUnitsInRange(g,0,0,99999,Condition(function Kaolin_BoulderSmash_Filter))
  endif
  call GroupAddUnit(g,u)
  call ForGroup(g,function Kaolin_BoulderSmash_Helper)
  call KillGroup(g)
  set g=null
endfunction

function Kaolin_BoulderSmash_PassThrough takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),Kaolin_PushSmashedGroup)==false then
    call GroupAddUnit(Kaolin_PushSmashedGroup,GetEnumUnit())
    call DamageTarget(KaolinTempCaster,GetEnumUnit(),1,KaolinPushDamage)
    if KaolinTempInteger==1 then
      call Kaolin_BoulderSmash_StunApp(GetEnumUnit())
    endif
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true and(LoadInteger(HY,GetHandleId(GetEnumUnit()),809)==1)then
      set KaolinSmashTempUnit=GetEnumUnit()
    endif
  endif
endfunction

function Kaolin_BoulderSmash_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local real dx=(LoadReal(HY,h,6))
  local real dy=(LoadReal(HY,h,7))
  local real rads
  local real targetX=(LoadReal(HY,h,(23)))
  local real targetY=(LoadReal(HY,h,(24)))
  local real newX
  local real newY
  local boolean b=false
  local group g=(LoadGroupHandle(HY,h,(187)))
  local group gg
  local unit pushed=(LoadUnitHandle(HY,h,(810)))
  if pushed!=null then
    set dx=GetUnitX(pushed)
    set dy=GetUnitY(pushed)
  endif
  set rads=bj_DEGTORAD*AngleBetweenXY(GetUnitX(target),GetUnitY(target),dx,dy)
  set newX=targetX+(1200)*0.03*Cos(rads)
  set newY=targetY+(1200)*0.03*Sin(rads)
  if DistanceBetweenXY(newX,newY,dx,dy)<(5+(1200)*0.03)then
    set newX=dx
    set newY=dy
    set b=true
  endif
  set newX=SafeX50(newX)
  set newY=SafeY50(newY)
  set Kaolin_PushSmashedGroup=g
  set KaolinTempCaster=caster
  set KaolinsPushLevelStorage=GetUnitAbilityLevel(caster,'A2QM')
  set KaolinPushDamage=125
  set KaolinSmashTempUnit=null
  if((LoadInteger(HY,(GetHandleId(target)),4306))==1)==true or GetTriggerEventId()==EVENT_UNIT_DEATH or GetUnitAbilityLevel(target,'B08V')>0 or((LoadInteger(HY,(GetHandleId(target)),4336))==1)==true or(pushed==null and GetTriggerEvalCount(t)>200)then
    set b=true
  else
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",newX,newY))
    if GetUnitTypeId(target)=='o01X' or GetUnitTypeId(target)=='o020' then
      set KaolinTempInteger=1
      call SetUnitPosition(target,newX,newY)
      call SetUnitX(target,SafeX50(newX))
      call SetUnitY(target,SafeY50(newY))
    else
      set KaolinTempInteger=0
      call SetUnitX(target,SafeX50(newX))
      call SetUnitY(target,SafeY50(newY))
    endif
    call KillTrees(newX,newY,150)
    call SaveReal(HY,h,(23),((newX)*1.0))
    call SaveReal(HY,h,(24),((newY)*1.0))
    set gg=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(gg,newX,newY,225,Condition(function DefaultEnemyFilter))
    call GroupRemoveUnit(gg,target)
    call ForGroup(gg,function Kaolin_BoulderSmash_PassThrough)
    call KillGroup(gg)
    if KaolinSmashTempUnit!=null and KaolinTempInteger==1 then
      set gg=GetAvailableGroup()
      set KaolinPushedUnit=null
      set KaolinDistanceTemp=9999
      call GroupEnumUnitsInRange(gg,GetUnitX(KaolinSmashTempUnit),GetUnitY(KaolinSmashTempUnit),625,Condition(function Kaolin_BoulderSmash_Filter))
      call KillGroup(gg)
      if KaolinPushedUnit!=null then
        set pushed=KaolinPushedUnit
        call SaveUnitHandle(HY,h,(810),(pushed))
        set b=false
      endif
    endif
    set gg=null
  endif
  if b then
    if GetUnitTypeId(target)!='o01X' then
      call SetUnitPathing(target,true)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillGroup(g)
    call SaveInteger(HY,(GetHandleId((target))),((4335)),2)
    if GetTriggerEventId()!=EVENT_UNIT_DEATH then
      if IsPlayerAlly(GetOwningPlayer(caster),GetOwningPlayer(target))==false then
        call DamageTarget(KaolinTempCaster,target,1,KaolinPushDamage)
      endif
    endif
  endif
  set target=null
  set t=null
  set g=null
  set caster=null
  set pushed=null
  return false
endfunction

function Kaolin_BoulderSmash_Start takes nothing returns nothing
  local unit target=GetSpellTargetUnit()
  local unit caster=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real angle
  local real dx
  local real dy
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local integer i=-1
  local boolean b=false
  local real pushDistance=400+100*GetUnitAbilityLevel(caster,GetSpellAbilityId())
  local group g
  
  if target==null then
    set g=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(g,x,y,225,Condition(function IsStone))
    set target=GetClosestOfGroup(g,x,y)
    call KillGroup(g)
    set g=null
    set angle=AngleBetweenXY(GetUnitX(target),GetUnitY(target),GetSpellTargetX(),GetSpellTargetY())
  else
    set angle=GetAngleBetweenUnits(caster,target)
  endif
  if target==null then
    return
  endif
  
  if GetUnitTypeId(target)=='o01X' then
    set pushDistance=2000
  endif
  loop
    exitwhen b or i==R2I(pushDistance/25)
    set i=i+1
    set dx=SafeX50(GetUnitX(target)+(pushDistance-i*25)*Cos(angle*bj_DEGTORAD))
    set dy=SafeY50(GetUnitY(target)+(pushDistance-i*25)*Sin(angle*bj_DEGTORAD))
    if(IsPointInRegion(RestrictedRegion,((dx)*1.0),((dy)*1.0)))==false then
      set b=true
    endif
  endloop
  call SetUnitPathing(target,false)
  call TriggerRegisterTimerEvent(t,0.03,true)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Kaolin_BoulderSmash_Duration))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveReal(HY,h,6,((dx)*1.0))
  call SaveReal(HY,h,7,((dy)*1.0))
  call SaveReal(HY,h,(23),((GetUnitX(target))*1.0))
  call SaveReal(HY,h,(24),((GetUnitY(target))*1.0))
  call SaveInteger(HY,h,(34),(0))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call SaveUnitHandle(HY,h,(810),(null))
  call SaveInteger(HY,(GetHandleId((target))),((4335)),(1))
  set target=null
  set caster=null
  set t=null
endfunction

function KaolinGetCloserPeriodic takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,1)
  local integer hu=GetHandleId(u)
  local unit target=LoadUnitHandle(HY,h,0)
  local integer oid=GetUnitCurrentOrder(u)
  if oid!=LoadInteger(HY,h,0) then
    if oid!=851973 then
      call CleanTrigger(t)
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(HY,hu,'A2UU')
      //			call echo("destroyed cause wrong order "+I2S(oid)+" "+OrderId2String(oid))
    else
      call IssuePointOrderById(u,851986,GetUnitX(target),GetUnitY(target))
    endif
  else
    if DistanceBetweenUnits(u,target) <= 200 then
      call CleanTrigger(t)
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(HY,hu,'A2UU')
      //			call echo("destroyed cause reached")
      call IssueTargetOrder(u,"cripple",target)
    endif
  endif
  set target=null
  set u=null
  set t=null
  return false
endfunction

function KaolinGetCloser takes unit u, unit target returns nothing
  local trigger t
  local integer h
  local integer hu=GetHandleId(u)
  if HaveSavedHandle(HY,hu,'A2UU') then
    set t=LoadTriggerHandle(HY,hu,'A2UU')
    set h=GetHandleId(t)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.02,true)
    call TriggerAddCondition(t,Condition(function KaolinGetCloserPeriodic))
    call SaveTriggerHandle(HY,hu,'A2UU',t)
    call SaveUnitHandle(HY,h,1,u)
  endif
  call IssueTargetOrder(u,"move",target)
  call SaveUnitHandle(HY,h,0,target)
  call SaveInteger(HY,h,0,851986)
  set t=null
endfunction

function Kaolin_BoulderSmash_OnGround takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local group g=GetAvailableGroup()
  set tt_unit1=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),205,Condition(function IsStone))
  if FirstOfGroup(g)==null then
    call InterruptUnit(u)
    if IsUnitType(u,UNIT_TYPE_HERO) then
      call Error(GetOwningPlayer(u),"Invalid Target")
    endif
  endif
  call KillGroup(g)
  set u=null
  set target=null
endfunction

function Kaolin_BoulderSmash_OnTarget takes nothing returns nothing
  if DistanceBetweenUnits(GetTriggerUnit(),GetSpellTargetUnit()) > 200 then
    call KaolinGetCloser(GetTriggerUnit(),GetSpellTargetUnit())
  endif
endfunction

function Kaolin_BoulderSmash_InitSup takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
    call Kaolin_BoulderSmash_Start()
  endif
endfunction

function Kaolin_BoulderSmash_OnCast_Wrap takes nothing returns nothing
  if GetSpellTargetUnit()==null then
    call Kaolin_BoulderSmash_OnGround()
  elseif (DistanceBetweenUnits(GetTriggerUnit(),GetSpellTargetUnit())>170 and GetUnitTypeId(GetSpellTargetUnit())!='n00L') then
    call Kaolin_BoulderSmash_OnTarget()
  elseif GetUnitTypeId(GetSpellTargetUnit())=='n00L' then
    call InterruptUnit(GetTriggerUnit())
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
      call Error(GetOwningPlayer(GetTriggerUnit()),"Invalid Target")
    endif
  endif
endfunction

function Kaolin_Magnetize_ForNewGroup takes nothing returns nothing
  set KaolinMagnetizeTempVictim=GetEnumUnit()
  call ExeFunc("Kaolin_Magnetize_PreStart")
endfunction

function Kaolin_Magnetize_Filter takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetUnitTypeId(GetFilterUnit())=='o01X' and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((4335))))==1)==false and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((4340))))==1)==false
endfunction

function Kaolin_Magnetize_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit victim=LoadUnitHandle(HY,h,17)
  local real x=GetUnitX(victim)
  local real y=GetUnitY(victim)
  local group g=GetAvailableGroup()
  local integer counter=GetTriggerEvalCount(t)
  local integer lvl=GetUnitAbilityLevel(caster,'A2TI')
  local real TimeLeft=(LoadReal(HY,(GetHandleId(victim)),(807)))
  if ModuloInteger(counter,5)==0 then
    call DamageTarget(caster,victim,1,(25+25*lvl)/2)
  endif
  set KaolinMagnetizeTempCaster=caster
  set tt_unit1=caster
  call GroupEnumUnitsInRange(g,x,y,325,Condition(function Kaolin_Magnetize_Filter))
  call ForGroup(g,function Kaolin_Magnetize_ForNewGroup)
  call KillGroup(g)
  if(TimerGetElapsed(GlobalTimer))>TimeLeft or IsDead(victim)then
    call SaveInteger(HY,GetHandleId(victim),809,2)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set caster=null
  set victim=null
  set g=null
  return false
endfunction

function Kaolin_Magnetize_DurationReset takes unit u,unit victim returns nothing
  local trigger t
  local integer h
  local real CurTime=LoadReal(HY,GetHandleId(victim),807)
  call SaveReal(HY,(GetHandleId(victim)),807,(((TimerGetElapsed(GlobalTimer))+6)*1.0))
  if CurTime<(TimerGetElapsed(GlobalTimer))then
    call SaveInteger(HY,(GetHandleId((victim))),809,(1))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(u))
    call SaveUnitHandle(HY,h,17,(victim))
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\MagnetizeTargetOverhead.mdx",victim,"origin")))
    call TriggerRegisterTimerEvent(t,0.1,true)
    call TriggerAddCondition(t,Condition(function Kaolin_Magnetize_Duration))
  endif
  set t=null
endfunction

function Kaolin_Magnetize_ForGroup takes nothing returns nothing
  call Kaolin_Magnetize_DurationReset(KaolinMagnetizeTempCaster,GetEnumUnit())
endfunction

function Kaolin_Magnetize_Start takes unit u,unit target returns nothing
  local group g=GetAvailableGroup()
  local real x=GetUnitX(target)
  local real y=GetUnitY(target)
  local real aoe=300
  if GetUnitTypeId(target)=='o01X' then
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherMissile\\DemolisherMissile.mdx",GetUnitX(target),GetUnitY(target)))
    call UnitApplyTimedLife(target,'BTLF',5)
    call SaveInteger(HY,(GetHandleId((target))),((4340)),(1))
    call SetUnitVertexColor(target,0,0,0,100)
    set aoe=600
  else
    call DestroyEffect(AddSpecialEffect("war3mapImported\\MagnetizeCastAoE.mdx",GetUnitX(target),GetUnitY(target)))
  endif
  set tt_unit1=u
  set KaolinMagnetizeTempCaster=u
  set KaolinMagnetizeTempVictim=target
  call GroupEnumUnitsInRange(g,x,y,aoe+25,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function Kaolin_Magnetize_ForGroup)
  call KillGroup(g)
  set u=null
  set g=null
endfunction

function Kaolin_Magnetize_PreStart takes nothing returns nothing
  call Kaolin_Magnetize_Start(KaolinMagnetizeTempCaster,KaolinMagnetizeTempVictim)
endfunction

function Kaolin_Magnetize_Init takes nothing returns nothing
  call Kaolin_Magnetize_Start(GetTriggerUnit(),GetTriggerUnit())
endfunction

function IsStoneDM takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='o01X' then
    call RemoveUnit(GetFilterUnit())
  endif
  return false
endfunction

function StoneOwnerDeath takes unit u returns nothing
  local group g
  local player p
  if Mode_DM and GetUnitAbilityLevel(u,'A2TH')>0 then
    set g=GetAvailableGroup()
    call GroupEnumUnitsOfPlayer(g,p,Condition(function IsStoneDM))
    call KillGroup(g)
    set g=null
  endif
endfunction

function Kaolin_Death_End takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call SetUnitAnimationByIndex(LoadUnitHandle(HY,h,2),8)
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
endfunction

function KaolinModel_Death takes unit u returns nothing
  local timer t
  if GetUnitTypeId(u)=='N0MU' then
    set t=CreateTimer()
    call SetUnitAnimationByIndex(u,7)
    call TimerStart(t,2.5,false,function Kaolin_Death_End)
    call SaveUnitHandle(HY,GetHandleId(t),2,u)
    set t=null
  endif
endfunction

function Oracle_FortunesEnd_Damage takes nothing returns nothing
  call Z48("war3mapImported\\FortunesEndTarget.mdx",GetEnumUnit(),"origin",3)
  call IssueTargetOrder(Oracle_TempDummy,"purge",GetEnumUnit())
  call UnitRemoveAbility(GetEnumUnit(),'A2T4')
  call DamageTarget(Oracle_TempCaster,GetEnumUnit(),1,75*Oracle_TempLvl)
endfunction

function Oracle_FortunesEnd_EndCast takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=(LoadUnitHandle(HY,(GetHandleId(caster)),(796)))
  local real time=RMinIF((TimerGetElapsed(GlobalTimer))-(LoadReal(HY,(GetHandleId(caster)),358)),3)
  local integer lvl=GetUnitAbilityLevel(caster,'A2QT')
  local integer dummyLevel=R2I(2.0*time)
  local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),GetUnitFacing(caster))
  local unit visionDummy
  local group g
  if target!=null then
    set visionDummy=CreateUnit(GetOwningPlayer(caster),'o00Z',GetUnitX(target),GetUnitY(target),0)
    call UnitApplyTimedLife(visionDummy,'BTLF',0.5)
    call UnitAddAbility(dummy,'A2T2')
    call SetUnitAbilityLevel(dummy,'A2T2',dummyLevel)
    set tt_unit1=caster
    set Oracle_TempCaster=caster
    set Oracle_TempDummy=dummy
    set Oracle_TempLvl=lvl
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),240,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function Oracle_FortunesEnd_Damage)
    call KillGroup(g)
  endif
  set caster=null
  set target=null
  set dummy=null
  set visionDummy=null
  set g=null
endfunction

function Oracle_FortunesEnd_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,(14)))
  local unit target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call SaveReal(HY,(GetHandleId(caster)),(356),((GetUnitX(target))*1.0))
    call SaveReal(HY,(GetHandleId(caster)),(357),((GetUnitY(target))*1.0))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set caster=null
  set target=null
  return false
endfunction

function Oracle_FortunesEnd_OnCast takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  call SaveReal(HY,(GetHandleId(caster)),(358),(((TimerGetElapsed(GlobalTimer)))*1.0))
  call SaveUnitHandle(HY,(GetHandleId(caster)),(796),(GetSpellTargetUnit()))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\CleanseTargetArea.mdx",GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit())))
  call SaveUnitHandle(HY,h,(14),(caster))
  call SaveUnitHandle(HY,h,17,(GetSpellTargetUnit()))
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerRegisterDeathEvent(t,GetSpellTargetUnit())
  call TriggerAddCondition(t,Condition(function Oracle_FortunesEnd_Duration))
  set t=null
  set caster=null
endfunction

function Oracle_FortunesEnd_Sup takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),(360),(true))
  endif
endfunction

function Oracle_FortunesEnd_PreEnd takes nothing returns nothing
  if LoadBoolean(HY,GetHandleId(GetTriggerUnit()),360) then
    call Oracle_FortunesEnd_EndCast()
  endif
endfunction

function Oracle_FortunesEnd_OnCastSup takes nothing returns nothing
  call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),(360),(false))
  call Oracle_FortunesEnd_OnCast()
endfunction

function Oracle_FatesEdict_Amplify takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit target=(LoadUnitHandle(HY,h,17))
  if IsDead(target) or GetUnitAbilityLevel(target,'A2T4')==0 or TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
    call SaveReal(HY,GetHandleId(target),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(target),'AMPL')-0.5,0))
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(target,'A2T4')
  endif
  set t=null
  set target=null
  return false
endfunction

function Oracle_FatesEdict_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer lvl=GetUnitAbilityLevel(caster,'A2T5')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call Attack_Disable(target,2+lvl,0,0)
  call UnitAddAbility2(target,'A2T4')
  call SaveReal(HY,GetHandleId(target),'AMPL',LoadReal(HY,GetHandleId(target),'AMPL')+0.5)
  call SetPlayerAbilityAvailable(GetOwningPlayer(target),'A2T4',false)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2+lvl)
  //call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterDeathEvent(t,target)
  call TriggerAddCondition(t,Condition(function Oracle_FatesEdict_Amplify))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("war3mapImported\\FatesEdict.mdx",target,"origin")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("Abilities\\Spells\\Other\\TalkToMe\\TalkToMe.mdl",target,"overhead")))
  set caster=null
  set target=null
  set t=null
endfunction

function Oracle_FatesEdict_Sup takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false then
    call Oracle_FatesEdict_Start()
  endif
endfunction

function Oracle_PurifingFlames_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local integer lvl=LoadInteger(HY,h,5)
  local integer counter=(LoadInteger(HY,h,(34)))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or counter>9 then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A2T2' and GetSpellTargetUnit()==target then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    set counter=counter+1
    call SaveInteger(HY,h,(34),(counter))
    call SetWidgetLife(target,GetWidgetLife(target)+11*lvl)
  endif
  set t=null
  set caster=null
  set target=null
  return false
endfunction

function Oracle_PurifingFlames_Start takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer lvl=GetUnitAbilityLevel(caster,'A2SG')+GetUnitAbilityLevel(caster,'QB0O')
  local real dmg=lvl*90
  local real resist=0.75
  call TriggerRegisterDeathEvent(t,target)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function Oracle_PurifingFlames_Duration))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveInteger(HY,h,5,(lvl))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\DarkMending.mdx",target,"origin")))
  if IsUnitType(target,UNIT_TYPE_HERO)==false then
    set resist=1.0
  endif
  if GetWidgetLife(target)<=dmg*resist and IsUnitAlly(target,GetOwningPlayer(caster))==true then
    set dmg=GetWidgetLife(target)/0.75-10
  endif
  call DamageTarget(caster,target,1,dmg)
  set t=null
  set caster=null
  set target=null
endfunction

function Oracle_PurifingFlames_InitSup takes nothing returns nothing
  if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))==false or IsBlocked(GetSpellTargetUnit())==false then
    call Oracle_PurifingFlames_Start()
  endif
endfunction

function Oracle_FalsePromise_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local integer instances=(LoadInteger(HY,h,(34)))
  local integer counter=(LoadInteger(HY,h,(25)))
  local integer lvl=(LoadInteger(HY,h,5))
  local integer i=0
  local real storedHP=(LoadReal(HY,h,(697)))
  local real storedMP=(LoadReal(HY,h,(811)))
  local real curLife=GetWidgetLife(target)
  local real curMana=GetUnitState(target,UNIT_STATE_MAX_LIFE)
  local real TotalHeal=(LoadReal(HY,h,(808)))
  local real HPHeal
  local real dmg
  local boolean isBalanced=LoadBoolean(HY,h,5)
  local integer limit=lvl+6
  if isBalanced then
    set limit=limit-2
  endif
  if counter>(limit)*50 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call DisableTrigger(t)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call UnitRemoveAbility(target,'A2T0')
    call UnitRemoveAbility(target,'A2SZ')
    if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
      set TotalHeal=TotalHeal*2
      loop
        exitwhen i>instances
        set i=i+1
        set curLife=GetWidgetLife(target)
        set HPHeal=RMinBJ(curMana-curLife,TotalHeal)
        call SetWidgetLife(target,curLife+HPHeal)
        set TotalHeal=TotalHeal-HPHeal
        set dmg=(LoadReal(HY,h,(20000+i)))
        if(LoadUnitHandle(HY,h,(22000+i)))==caster or((LoadInteger(HY,(GetHandleId((target))),((2485))))==1)then
          if GetWidgetLife(target)<=dmg+2 then
            set dmg=GetWidgetLife(target)-2
          endif
        endif
        call DamageTarget((LoadUnitHandle(HY,h,(22000+i))),target,6,dmg)
      endloop
      set curLife=GetWidgetLife(target)
      set HPHeal=RMinBJ(curMana-curLife,TotalHeal)
      call SetWidgetLife(target,curLife+HPHeal)
      set TotalHeal=TotalHeal-HPHeal
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and IsDamageReal(GetEventDamage())then
    set instances=instances+1
    call SaveInteger(HY,h,(34),(instances))
    call SaveUnitHandle(HY,h,(22000+instances),(GetEventDamageSource()))
    call SaveReal(HY,h,(20000+instances),((GetEventDamage())*1.0))
    call HealUnitFor(target,GetEventDamage())
  elseif GetTriggerEventId()!=EVENT_UNIT_DAMAGED and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
    set counter=counter+1
    call SaveInteger(HY,h,(25),(counter))
    if curMana!=storedMP then
      set storedMP=curMana
      set storedHP=curLife
      call SaveReal(HY,h,(697),((storedHP)*1.0))
      call SaveReal(HY,h,(811),((storedMP)*1.0))
    endif
    if curLife>storedHP then
      if((LoadInteger(HY,(GetHandleId((target))),((4298))))==1)==false then
        set TotalHeal=TotalHeal+curLife-storedHP
        call SaveReal(HY,h,(808),((TotalHeal)*1.0))
      else
        call SetWidgetLife(target,curLife)
      endif
    endif
    call SetWidgetLife(target,storedHP)
  endif
  set t=null
  set target=null
  set caster=null
  return false
endfunction

function Oracle_FalsePromise_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer lvl=GetUnitAbilityLevel(caster,'A2TF')+GetUnitAbilityLevel(caster,'QB11')
  local boolean isBalanced=GetUnitAbilityLevel(caster,'QB11')>0
  call UnitRemoveAbility(target,'B09Y')//phase
  call UnitAddAbility2(target,'A2T0')
  call UnitAddAbility2(target,'A2SZ')
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterDeathEvent(t,target)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerAddCondition(t,Condition(function Oracle_FalsePromise_Duration))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveInteger(HY,h,(34),(0))
  call SaveInteger(HY,h,(25),(0))
  call SaveInteger(HY,h,5,(lvl))
  call SaveBoolean(HY,h,5,isBalanced)
  call SaveReal(HY,h,(808),((0)*1.0))
  call SaveReal(HY,h,(697),((GetWidgetLife(target))*1.0))
  call SaveReal(HY,h,(811),((GetUnitState(target,UNIT_STATE_MAX_LIFE))*1.0))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\FalsePromise.mdx",target,"chest")))
  call RemoveDispellableBuffs(target)
  call SetNapalmFactory(target,0,0)
  set caster=null
  set target=null
  set t=null
endfunction


function ES_AS_ForGroup takes nothing returns nothing
  call TriggerRegisterUnitEvent(ES_Aftershock,GetEnumUnit(),EVENT_UNIT_DAMAGED)
  call SaveInteger(HY,GetHandleId(ES_Aftershock),0,LoadInteger(HY,GetHandleId(ES_Aftershock),0)+1)
endfunction

function ES_AS_Group takes unit u returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),500,Condition(function ReturnTrue))
  call ForGroup(g,function ES_AS_ForGroup)
  call KillGroup(g)
  set g=null
endfunction

function ES_Aftershock_Hit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer c
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(),LoadReal(HY,h,0))
      call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,LoadReal(HY,h,1))
      set c=LoadInteger(HY,h,0)
      if c==1 then
        call FlushChildHashtable(HY,h)
        call DestroyTrigger(t)
        set ES_Aftershock=null
      else
        call SaveInteger(HY,h,0,c-1)
      endif
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
    set ES_Aftershock=null
  endif
  set t=null
endfunction

function Earthshaker_Aftershock_Effect takes unit u, integer lvl returns nothing
  local trigger t
  local integer h
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  local real dur
  local real dmg
  call UnitAddAbility(d,'A42H')
  set ES_Aftershock=CreateTrigger()
  set h=GetHandleId(ES_Aftershock)
  call ES_AS_Group(d)
  call TriggerRegisterTimerEvent(ES_Aftershock,0.02,false)
  call TriggerAddCondition(ES_Aftershock,Condition(function ES_Aftershock_Hit))
  call SaveUnitHandle(HY,h,0,d)
  set dur=0.3+0.3*lvl
  set dmg=25+25*lvl
  if Mode_BO==false then
    call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)*0.95)
  endif
  call SaveReal(HY, h, 0, dur)
  call SaveReal(HY, h, 1, dmg)
  call SaveUnitHandle(HY,h,1,u)
  set t=null
  call IssueImmediateOrder(d,"stomp")
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(d),GetUnitY(d)))
  set d=null
endfunction

function Earthshaker_Aftershock_Condition takes unit u, integer spell returns nothing
  local integer level = GetUnitAbilityLevel(u,'A0DJ')+GetUnitAbilityLevel(u,'QF85')+GetUnitAbilityLevel(u,'QP1G')+GetUnitAbilityLevel(u,'QP1H')
  if level>0 then
    if BalanceOffSpellChecker(spell) then
      call Earthshaker_Aftershock_Effect(u,level)
    endif
  endif
endfunction

function T8E takes nothing returns nothing
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,tt_real1)
  call StunTargetLod(GetEnumUnit(),tt_int1*0.25+0.75)
endfunction

function ES_Fissure takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local location l=GetSpellTargetLoc()
  local integer i=1
  local real SourceX=GetUnitX(Hero)
  local real SourceY=GetUnitY(Hero)
  local real TargetX
  local real TargetY
  local real x
  local real y
  local real a
  local group g=GetAvailableGroup()
  local group g2=GetAvailableGroup()
  if Target==null then
    set TargetX=GetLocationX(l)
    set TargetY=GetLocationY(l)
  else
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
  endif
  set a=bj_DEGTORAD*AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)
  call RemoveLocation(l)
  loop
    exitwhen i>22
    set x=SafeX50(SourceX+i*60*Cos(a))
    set y=SafeY50(SourceY+i*60*Sin(a))
    call GroupEnumUnitsInRange(g2,x,y,250,Condition(function LR8))
    call GroupAddGroup(g2,g)
    call GroupClear(g2)
    call B88(CreateDestructable('B000',x,y,GetRandomReal(0,360),.5,GetRandomInt(0,2)),8)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",x,y))
    set i=i+1
  endloop
  set tt_int1=GetUnitAbilityLevel(Hero,'A0SK')
  set tt_real1=tt_int1*50+75
  call ForGroup(g,function T8E)
  call KillGroup(g)
  call KillGroup(g2)
  set g=null
  set g2=null
  set Target=null
  set Hero=null
  set l=null
endfunction

function AfterShock_Orbs_RemoveBuff takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call UnitRemoveAbility(Source,'Broa')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function AfterShock_Orbs_Condition takes nothing returns boolean
  local trigger t
  local integer h
  if GetUnitAbilityLevel(GetTriggerUnit(),'Broa')>0 then
    if isPoisonArrowSkill(GetSpellAbilityId()) then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterTimerEvent(t,0.1,false)
      call TriggerAddCondition(t,Condition(function AfterShock_Orbs_RemoveBuff))
      call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
    endif
  endif
  set t=null
  return false
endfunction

function AfterShock_Orbs takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function AfterShock_Orbs_Condition))
  set t=null
endfunction

function EnchantTotemRangedFixAct takes nothing returns nothing
  local timer t=GetExpiredTimer()
  call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'Broa')
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTimer(t)
  set t=null
endfunction

function EnchantTotemRangedFix takes nothing returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.15,false,function EnchantTotemRangedFixAct)
  call SaveUnitHandle(HY,GetHandleId(t),0,UDSG_Attacker)
  set t=null
endfunction

function ES_EchoSlam_ForGroup takes nothing returns nothing
  local real x=GetUnitX(GetEnumUnit())
  local real y=GetUnitY(GetEnumUnit())
  local integer id=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  call SetUnitX(EP8[id],x)
  call SetUnitY(EP8[id],y)
  call IssueImmediateOrderById(EP8[id],852526)
endfunction

function ES_EchoSlam_AghanimPart takes nothing returns nothing
  local real x=GetUnitX(GetEnumUnit())
  local real y=GetUnitY(GetEnumUnit())
  local integer id=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) or IsUnitIllusion(GetEnumUnit())==true then
    call SetUnitX(EP8[id],x)
    call SetUnitY(EP8[id],y)
    call IssueImmediateOrderById(EP8[id],852526)
  endif
endfunction

function ES_EchoSlam_Filter takes nothing returns boolean
  return(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and IsDead(GetFilterUnit())==false)!=null
endfunction

function EchoSlam_ShareVisionOff takes nothing returns nothing
  call UnitShareVision(GetEnumUnit(),GetOwningPlayer(EchoSlam_Caster),false)
endfunction

function EchoSlam_ShareVision takes nothing returns nothing
  call UnitShareVision(GetEnumUnit(),GetOwningPlayer(EchoSlam_Caster),true)
endfunction

function EchoSlam_ShareVisionTimer takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group g=LoadGroupHandle(HY,h,0)
  set EchoSlam_Caster=LoadUnitHandle(HY,h,1)
  call ForGroup(g,function EchoSlam_ShareVisionOff)
  call KillGroup(g)
  call CleanTimer(t)
  set g=null
  set t=null
endfunction

function EchoSlam_InitSharingVision takes group g, unit u returns nothing
  local group gg=GetAvailableGroup()
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function EchoSlam_ShareVisionTimer)
  call GroupAddGroup(g,gg)
  call SaveGroupHandle(HY,GetHandleId(t),0,gg)
  call SaveUnitHandle(HY,GetHandleId(t),1,u)
  set gg=null
  set t=null
endfunction

function ES_EchoSlam_Act takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g=GetAvailableGroup()
  local integer id=GetPlayerId(GetOwningPlayer(Source))
  local integer Level=GetUnitAbilityLevel(Source,'A0DH')
  call Earthshaker_Aftershock_Effect(Source,4)
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A1OB')
  endif
  set EP8[id]=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  set EQ8[id]=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call SetUnitScale(EP8[id],.25,.25,.25)
  call UnitAddAbility2(EP8[id],'A0DM')
  call UnitAddAbility2(EQ8[id],'A1H0')
  call SetUnitAbilityLevel(EP8[id],'A0DM',Level)
  call SetUnitAbilityLevel(EQ8[id],'A1H0',Level)
  set EchoSlam_Caster=Source
  
  call GroupEnumUnitsInRange(g,x,y,1200,Condition(function ES_EchoSlam_Filter))
  call ForGroup(g,function EchoSlam_ShareVision)
  call EchoSlam_InitSharingVision(g,Source)
  
  call GroupEnumUnitsInRange(g,x,y,600,Condition(function ES_EchoSlam_Filter))
  call ForGroup(g,function ES_EchoSlam_ForGroup)
  if GetUnitAbilityLevel(Source,'A1OB')>0 then
    call ForGroup(g,function ES_EchoSlam_AghanimPart)
  endif
  
  call KillGroup(g)
  set Source=null
  set g=null
endfunction

function ES_EchoSlam_Reg takes nothing returns nothing
  call PreloadQueryAdd('A0DM')
  call PreloadQueryAdd('A0SJ')
endfunction

function TRE takes nothing returns nothing
  local unit Source
  local unit Target
  local unit Caster
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    set Source=GetSpellTargetUnit()
    set Target=GetTriggerUnit()
  else
    set Source=GetTriggerUnit()
    set Target=GetAttacker()
  endif
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0B0')
  call SetUnitAbilityLevel(Caster,'A0B0',GetUnitAbilityLevel(Source,'P009')) //A0DW
  call IssueTargetOrderById(Caster,852662,Target)
  set Source=null
  set Caster=null
  set Target=null
endfunction

function TQE takes nothing returns boolean
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    return GetUnitAbilityLevel(GetSpellTargetUnit(),'P009')>0 //A0DW
  else
    return GetUnitAbilityLevel(GetTriggerUnit(),'P009')>0 //A0DW
  endif
endfunction

function KU9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function TQE))
  call TriggerAddAction(t,function TRE)
  set t=null
endfunction

function TSE takes nothing returns boolean
  return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and GetWidgetLife(GetFilterUnit())!=GetUnitState(GetFilterUnit(),UNIT_STATE_MAX_LIFE))!=null
endfunction

function TTE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer KAE=(LoadInteger(HY,h,(28)))
  local group g
  local unit MRE
  if KAE>10 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SaveInteger(HY,h,(28),(KAE+1))
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),300,Condition(function TSE))
    set MRE=GroupPickRandomUnit(g)
    call KillGroup(g)
    call SetWidgetLife(MRE,GetWidgetLife(MRE)+10)
  endif
  set t=null
  set Source=null
  set g=null
  set MRE=null
  return false
endfunction

function TUE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call AddUnitAnimationProperties(Source,"alternate",false)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Enchantress_NaturesAttendants takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer i=1
  local trigger t
  local integer h
  loop
    exitwhen i>(1+2*GetUnitAbilityLevel(Source,'A01B'))
    set t=CreateTrigger()
    call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
    call SaveInteger(HY,(GetHandleId(t)),(28),(0))
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function TTE))
    set i=i+1
  endloop
  if GetUnitTypeId(Source)=='E02X' then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function TUE))
    call SaveUnitHandle(HY,h,2,(Source))
    set t=null
  endif
  set t=null
  set Source=null
endfunction

function Ench_Impetus_Hit takes unit attacker, unit target returns nothing
  local real dist=RMinIF(DistanceBetweenXY(GetUnitX(target),GetUnitY(target),GetUnitX(attacker),GetUnitY(attacker)),2500)
  local integer lvl=GetUnitAbilityLevel(attacker,'A0DY')+GetUnitAbilityLevel(attacker,'A1WB')
  local real d=(.1+.05*lvl)*dist
  call UnitRemoveAbility(target,'B03U')
  call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,3,216,216,216)
  call DamageTarget(attacker,target,3,d)
endfunction

function TLE takes unit u returns boolean
  return IsUnitType(u,UNIT_TYPE_HERO)==false and IsUnitType(u,UNIT_TYPE_ANCIENT)==false and GetUnitTypeId(u)!='n01E' and GetUnitTypeId(u)!='n019'
endfunction

function T1E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  call UnitRemoveAbility(Target,'Bslo')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Target=null
  return false
endfunction

function T0E takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer p=GetPlayerId(GetOwningPlayer(Target))
  if p>-1 and p<7 then
    call UnitShareVision(Target,Scourges[0],false)
    call UnitShareVision(Target,Scourges[1],false)
    call UnitShareVision(Target,Scourges[2],false)
    call UnitShareVision(Target,Scourges[3],false)
    call UnitShareVision(Target,Scourges[4],false)
    call UnitShareVision(Target,Scourges[5],false)
  else
    call UnitShareVision(Target,Sentinels[0],false)
    call UnitShareVision(Target,Sentinels[1],false)
    call UnitShareVision(Target,Sentinels[2],false)
    call UnitShareVision(Target,Sentinels[3],false)
    call UnitShareVision(Target,Sentinels[4],false)
    call UnitShareVision(Target,Sentinels[5],false)
  endif
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function T1E))
  call SaveUnitHandle(HY,h,17,(Target))
  call SetUnitOwner(Target,GetOwningPlayer(Source),true)
  call UnitApplyTimedLife(Target,'BTLF',80)
  call UnitAddAbility2(Target,'Aeth')
  call UnitAddAbility2(Target,'A12G')
  
  call UnitRefillMana(Target)
  set Target=null
  set Source=null
  set t=null
endfunction

function Enchantress_Enchant takes nothing returns nothing
  if TLE(GetSpellTargetUnit())then
    call T0E()
  endif
endfunction

function Enigma_MidnightPulse_OnCast takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit u=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(u,'A415')
  if IssuePointOrderById(u,852221,GetSpellTargetX(),GetSpellTargetY())==false then
    call SetUnitX(u,GetUnitX(caster))
    call SetUnitY(u,GetUnitY(caster))
    call UnitResetCooldown(u)
    if IssuePointOrderById(u,852221,GetSpellTargetX(),GetSpellTargetY())==false then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),"Cannot cast Midnight Pulse here")
    endif
  endif
  call KillUnit(u)
  set caster=null
  set u=null
endfunction

function Enigma_MidnightPulse takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Source=GetTriggerUnit()
  local real x0=GetUnitX(Source)
  local real y0=GetUnitY(Source)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x0,y0,0)
  call UnitApplyTimedLife(Caster,'BTLF',8)
  call UnitAddAbility(Caster,'A0B2')
  call SetUnitAbilityLevel(Caster,'A0B2',GetUnitAbilityLevel(Source,'A0B1'))
  if IssuePointOrderById(Caster,852221,x,y)==false then
    
  endif
  set Source=null
  set Caster=null
endfunction

function Enigma_Malefice_Damage takes unit Source,unit Target,integer Level returns nothing
  local real Damage =10+15*Level
  local real stundur=0.25*Level
  call StunTargetLod(Target,stundur)
  call DamageTarget(Source,Target,1,Damage)
endfunction

function Enigma_Malefice_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  call Enigma_Malefice_Damage(Source,Target,Level)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Enigma_Malefice_Act takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(Source,'A0I7')
  call Enigma_Malefice_Damage(Source,Target,Level)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call TriggerRegisterTimerEvent(t,2,false)
  call TriggerAddCondition(t,Condition(function Enigma_Malefice_Duration))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call TriggerRegisterTimerEvent(t,4,false)
  call TriggerAddCondition(t,Condition(function Enigma_Malefice_Duration))
  set t=null
  set Source=null
  set Target=null
endfunction

function Enigma_Malefice_InitSup takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Enigma_Malefice_Act()
  endif
endfunction

function Enigma_DemonicConversion takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local integer Level=GetUnitAbilityLevel(Source,'A180')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call SetWidgetLife(Target,1)
  call DamageTarget(Source,Target,2,20)
  call DamageTarget(Source,Target,1,20)
  call DamageTarget(Source,Target,3,20)
  call UnitAddAbility2(Caster,'A17Z')
  call SetUnitAbilityLevel(Caster,'A17Z',Level)
  call IssueImmediateOrderById(Caster,852667)
  set Source=null
  set Target=null
  set Caster=null
endfunction

function Enigma_DemonicConversion_OnCast takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer UHE=GetUnitLevel(Target)
  if GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0] and LoadInteger(UnitStats,GetUnitTypeId(Target),EXP)>88 then
    call InterruptUnit(Hero)
    call Error(GetOwningPlayer(Hero),GetObjectName('n0CX'))
  endif
  set Hero=null
  set Target=null
endfunction

function UKE takes real x returns real
  local real X38=GetRectMinX(bj_mapInitialPlayableArea)+150
  if(x<X38)then
    return X38
  endif
  set X38=GetRectMaxX(bj_mapInitialPlayableArea)-150
  if(x>X38)then
    return X38
  endif
  return x
endfunction

function UME takes real y returns real
  local real X38=GetRectMinY(bj_mapInitialPlayableArea)+150
  if(y<X38)then
    return X38
  endif
  set X38=GetRectMaxY(bj_mapInitialPlayableArea)-150
  if(y>X38)then
    return X38
  endif
  return y
endfunction

function UNE takes nothing returns boolean//AKG
  return(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false or AKG(GetUnitTypeId(GetFilterUnit()))or IsUnitSpiritBear(GetFilterUnit())or GetUnitTypeId(GetFilterUnit())=='n00U' or GetUnitTypeId(GetFilterUnit())=='n00Y' or GetUnitTypeId(GetFilterUnit())=='n00Z' or GetUnitTypeId(GetFilterUnit())=='n0KU' or GetUnitTypeId(GetFilterUnit())=='n0KV' or GetUnitTypeId(GetFilterUnit())=='n0KW' or IsUnitFamiliar(GetUnitTypeId(GetFilterUnit())))and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(318))))))!=null
endfunction

function UOE takes nothing returns nothing
  local location uloc=GetUnitLoc(GetEnumUnit())
  local location bhloc=GetUnitLoc(LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),318))
  local location destloc=S38(bhloc,DistanceBetweenPoints(bhloc,uloc)-2,AngleBetweenPoints(bhloc,uloc))
  local integer dadl=GetUnitAbilityLevel(BlackholeCaster,'A0B1')
  local real dmg=0
  if dadl==0 then
    set dadl=4
  endif
  if GetUnitAbilityLevel(BlackholeCaster,'A30L')>0 and AghBlackHoleDamage then
    set AghBlackHoleDamage=false
    set dmg=GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)/100*(dadl+3)
    call DamageTarget(BlackholeCaster,GetEnumUnit(),7,dmg)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl",GetEnumUnit(),"origin"))
  endif
  call SetUnitFacing(GetEnumUnit(),AngleBetweenPoints(bhloc,uloc))
  call SetUnitPositionLoc(GetEnumUnit(),destloc)
  call RemoveLocation(uloc)
  call RemoveLocation(bhloc)
  call RemoveLocation(destloc)
  set uloc=null
  set bhloc=null
  set destloc=null
endfunction

function USE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local group g
  local integer h=GetHandleId(t)
  local unit bh=LoadUnitHandle(HY,h,318)
  local unit Caster
  local real x
  local real y
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and (GetSpellAbilityId()=='A1BX' or GetSpellAbilityId()=='A30L') then
    call KillUnit(bh)
    set Caster=LoadUnitHandle(HY,h,19)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,250),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,251),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,252),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,253),'BTLF',1)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Caster)
  elseif GetTriggerEvalCount(t)>90 then
    set Caster=LoadUnitHandle(HY,h,19)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,250),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,251),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,252),'BTLF',1)
    call UnitApplyTimedLife(LoadUnitHandle(HY,h,253),'BTLF',1)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(bh)
    call KillUnit(Caster)
    call InterruptUnit(LoadUnitHandle(HY,h,2))
  else
    set x=GetUnitX(bh)
    set y=GetUnitY(bh)
    set BlackholeCaster=LoadUnitHandle(HY,h,2)
    set AghBlackHoleDamage=GetTriggerEvalCount(t)==20 or GetTriggerEvalCount(t)==40 or GetTriggerEvalCount(t)==60 or GetTriggerEvalCount(t)==80
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,425,Condition(function UNE))
    call ForGroup(g,function UOE)
    call KillGroup(g)
  endif
  set Caster=null
  set bh=null
  set t=null
  set g=null
  return false
endfunction

function Enigma_BlackHole takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  local unit bh=CreateUnit(GetOwningPlayer(Source),'u004',x,y,0)
  call SetUnitAbilityLevel(bh,'A0C0',GetUnitAbilityLevel(Source,'A1BX')+GetUnitAbilityLevel(Source,'A30L'))
  if IsScourge(GetOwningPlayer(Source))then
    call UnitAddAbility2(Caster,'A0X4')
  else
    call UnitAddAbility2(Caster,'A0X3')
  endif
  call IssuePointOrderById(Caster,852473,x,y)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveUnitHandle(HY,h,250,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))
  call SaveUnitHandle(HY,h,251,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))
  call SaveUnitHandle(HY,h,252,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))
  call SaveUnitHandle(HY,h,253,CreateUnit(GetOwningPlayer(Source),'h06R',x,y,0))
  call SaveUnitHandle(HY,h,318,bh)
  call SaveUnitHandle(HY,h,2,Source)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function USE))
  set Source=null
  set bh=null
  set t=null
  set Caster=null
endfunction

function Enigma_BlackHole_OnCast takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  if(x!=UKE(x)and y!=UME(y))or RectContainsCoords(IA,x,y)or RectContainsCoords(OA,x,y)or RectContainsCoords(BA,x,y)or RectContainsCoords(CA,x,y)or RectContainsCoords(DA,x,y)or RectContainsCoords(EA,x,y)then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot cast Blackhole here")
  endif
endfunction

function KV9 takes nothing returns nothing
  call PreloadQueryAdd('A0C0')
endfunction

function UXE takes nothing returns nothing
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,tt_real1)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\StaffOfPurification\\PurificationTarget.mdx",GetEnumUnit(),"chest"))
endfunction

function Puck_WaningRift takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit Hero=GetTriggerUnit()
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local integer Level=GetUnitAbilityLevel(Hero,'A0SC')
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x,y,0)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\StaffOfPurification\\PurificationCaster.mdx",x,y))
  call UnitAddAbility2(Caster,'A0SD')
  call SetUnitAbilityLevel(Caster,'A0SD',Level)
  call IssuePointOrderById(Caster,852592,x,y)
  set tt_real1=Level*70
  call GroupEnumUnitsInRange(g,x,y,425,Condition(function LS8))
  call ForGroup(g,function UXE)
  call KillGroup(g)
  set Caster=null
  set g=null
  set Hero=null
endfunction

function Puck_DreamCoilUpg_UnleashStun takes unit u, integer lvl returns nothing
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  call UnitAddAbility(d,'A42T')
  call SetUnitAbilityLevel(d,'A42T',lvl)
  call IssueTargetOrder(d,"thunderbolt",u)
  set d=null
endfunction

function Puck_DreamCoil_SnappingBackDur takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local integer Level
  local unit Target
  local real x1
  local real y1
  local real d
  local real a
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set Target=(LoadUnitHandle(HY,h,17))
    set d=(LoadReal(HY,h,(138)))
    set x=(LoadReal(HY,h,6))
    set y=(LoadReal(HY,h,7))
    set a=(LoadReal(HY,h,(137)))
    set x1=GetUnitX(Target)+d/ 15*Cos(a)
    set y1=GetUnitY(Target)+d/ 15*Sin(a)
    call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
    call SetUnitPosition(Target,x1,y1)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x1,y1))
    if GetTriggerEvalCount(t)>15 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
    set Target=null
  endif
  set t=null
  set Target=null
  return false
endfunction

function Puck_DreamCoil_SnappingBackInit takes unit Target, unit center returns nothing
  local trigger t
  local integer h
  if IsUnitInvulnerable(Target) then
    return
  endif
  set t = CreateTrigger()
  set h = GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function Puck_DreamCoil_SnappingBackDur))
  call SaveReal(HY,h,6,GetUnitX(center))
  call SaveReal(HY,h,7,GetUnitY(center))
  call SaveReal(HY,h,(138),DistanceBetweenXY(GetUnitX(center),GetUnitY(center),GetUnitX(Target),GetUnitY(Target)))
  call SaveReal(HY,h,(137),Atan2(GetUnitY(center)-GetUnitY(Target),GetUnitX(center)-GetUnitX(Target)))
  call SaveUnitHandle(HY,h,17,(Target))
  set t=null
endfunction

function UAE takes unit Source,unit Target,integer Level,integer A5D returns nothing
  if A5D==1 then
    call DamageTarget(Source,Target,1,Level*50+50)
    call StunTargetLod(Target,.75+.75*Level)
  else
    call DamageTarget(Source,Target,1,Level*50+150)
    call Puck_DreamCoilUpg_UnleashStun(Target,Level)
  endif
endfunction

function UBE takes unit Source,unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0SF')
  call IssueTargetOrderById(Caster,852095,Target)
  set Caster=null
endfunction

function UCE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=(LoadInteger(HY,h,5))
  local integer A5D=(LoadInteger(HY,h,(152)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local lightning ZQ8=(LoadLightningHandle(HY,h,(196)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if GetTriggerUnit()==Source then
      call Puck_DreamCoil_SnappingBackInit(Target,Source)
    endif
    call DestroyLightning(ZQ8)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call MoveLightning(ZQ8,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
    if DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))>600 then
      call DestroyLightning(ZQ8)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UAE(Source,Target,Level,A5D)
      call Puck_DreamCoil_SnappingBackInit(Target,Source)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set ZQ8=null
  return false
endfunction

function U3E takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local lightning ZQ8=AddLightning("HWPB",true,GetUnitX(EV8),GetUnitY(EV8),GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))
  call SetLightningColor(ZQ8,0,.7,1,1)
  call SaveLightningHandle(HY,h,(196),(ZQ8))
  call SaveUnitHandle(HY,h,2,(EV8))
  call SaveUnitHandle(HY,h,(30),((GetEnumUnit())))
  call SaveInteger(HY,h,5,(ER8))
  call SaveInteger(HY,h,(152),(ES8))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerRegisterUnitEvent(t,GetEnumUnit(),EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,EV8,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function UCE))
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,ET8)
  call UBE(GetTriggerUnit(),GetEnumUnit())
  set t=null
  set ZQ8=null
endfunction

function Puck_DreamCoil_Filter takes nothing returns boolean
  return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and (IsUnitIllusion(GetFilterUnit()) or IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO))
endfunction

function Puck_DreamCoil takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00U',x,y,0)
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(Hero,'A0S8')
  local real DP9=6
  local integer A5D=1
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A1QP')
    set DP9=8
    set A5D=2
  endif
  call SetUnitAnimation(Caster,"channel")
  call BW8(Caster,DP9)
  set EV8=Caster
  set ET8=Level*50+50
  set ER8=Level
  set ES8=A5D
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,x,y,400,Condition(function Puck_DreamCoil_Filter))
  call ForGroup(g,function U3E)
  call KillGroup(g)
  set g=null
  set Caster=null
  set Hero=null
endfunction

function U1E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level
  local integer KAE
  local integer d
  if(GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER and GetIssuedOrderId()!=852514)or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SetUnitInvulnerable(Hero,false)
    call UnitRemoveAbility(Hero,'A04R')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set Level=(LoadInteger(HY,h,5))
    set d=3*Level
    if Level==4 then
      set d=d+1
    endif
    set KAE=(LoadInteger(HY,h,(28)))+1
    call SaveInteger(HY,h,(28),(KAE))
    if KAE>d or DistanceBetweenXY(GetUnitX(Hero),GetUnitY(Hero),(LoadReal(HY,h,6)),(LoadReal(HY,h,7)))>125 then
      call SetUnitInvulnerable(Hero,false)
      call UnitRemoveAbility(Hero,'A04R')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Hero=null
  return false
endfunction

function Puck_Phaseshift_Delay takes nothing returns nothing
  local timer t = GetExpiredTimer()
  
  call UnitAddAbility(LoadUnitHandle(MHT,GetHandleId(t),0),'A04R')
  
  call Timer_End(t)
  set t = null
endfunction

function U0E takes nothing returns nothing
  local timer time = CreateTimer()
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  
  //delay the adding of the marker ability so other spells can detect phase shift
  call SaveUnitHandle(MHT,GetHandleId(time),0,Hero)
  call TimerStart(time,0,false,function Puck_Phaseshift_Delay)
  
  call SetUnitInvulnerable(Hero,true)
  
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A0SB')))
  call SaveInteger(HY,h,(28),(0))
  call SaveReal(HY,h,6,((GetUnitX(Hero))*1.))
  call SaveReal(HY,h,7,((GetUnitY(Hero))*1.))
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function U1E))
  call AddTimedKeyToUnit(Hero,4266,5.9)
  set t=null
  set Hero=null
  set time=null
endfunction

function LE2 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  call IssueImmediateOrderById(Hero,852516)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function LF2 takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,(14),(Hero))
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function LE2))
  set t=null
  set Hero=null
endfunction

function U5E takes nothing returns boolean
  if GetIssuedOrderId()==852514 and IsUnitIllusion(GetTriggerUnit())==false and((LoadInteger(HY,GetHandleId(GetTriggerUnit()),4266))!=1)then
    call U0E()
  elseif GetIssuedOrderId()==852515 then
    call LF2()
  endif
  return false
endfunction

function Puck_PhaseShift_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function U5E))
  set t=null
endfunction

function U2E takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
  endif
endfunction

function V4E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(22)))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Level=(LoadInteger(HY,h,5))
  local real a=(LoadReal(HY,h,(13)))
  local unit Source=(LoadUnitHandle(HY,h,(14)))
  local group V7E
  local real x
  local real y
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if GetUnitTypeId(Source)=='e00E' then
      set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
    endif
    set tt_unit1=CreateUnit(GetOwningPlayer(Caster),'h06O',GetUnitX(Source),GetUnitY(Source),0)
    call SetUnitScale(tt_unit1,2.5,2.5,2.5)
    call KillUnit(tt_unit1)
    call SetUnitPosition(Source,GetUnitX(Caster),GetUnitY(Caster))
    call ShowUnit(Source,false)
    call ShowUnit(Source,true)
    call SelectUnitAddForPlayer(Source,GetOwningPlayer(Source))
    set EW8[GetPlayerId(GetOwningPlayer(Caster))]=null
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)>120 then
    set EW8[GetPlayerId(GetOwningPlayer(Caster))]=null
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitScale(Caster,2.5,2.5,2.5)
    call KillUnit(Caster)
  else
    set x=GetUnitX(Caster)
    set y=GetUnitY(Caster)
    set V7E=GetAvailableGroup()
    set DK=g
    set tt_unit1=Caster
    set tt_real1=Level*70
    call GroupEnumUnitsInRange(V7E,x,y,250,Condition(function LA8))
    call ForGroup(V7E,function U2E)
    call KillGroup(V7E)
    call SetUnitX(Caster,SafeX50(x+15*Cos(a*bj_DEGTORAD)))
    call SetUnitY(Caster,SafeY50(y+15*Sin(a*bj_DEGTORAD)))
  endif
  set t=null
  set g=null
  set V7E=null
  set Caster=null
  set Source=null
  return false
endfunction

function Puck_IllusoryOrb takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  local unit Hero=GetTriggerUnit()
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real x2=GetSpellTargetX()
  local real y2=GetSpellTargetY()
  local real a=AngleBetweenXY(x1,y1,x2,y2)
  local integer Level=GetUnitAbilityLevel(Hero,'A0S9')
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h06O',x1,y1,a)
  call PlaySoundAtPos(KC,x1,y1)
  call UnitAddAbility2(GetTriggerUnit(),'A0SA')
  set EW8[GetPlayerId(GetOwningPlayer(Hero))]=Caster
  call SetUnitScale(Caster,3.5,3.5,3.5)
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(Level))
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function V4E))
  set t=null
  set Caster=null
  set g=null
  set Hero=null
endfunction

function Puck_EtherealJaunt takes nothing returns nothing
  local integer i=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  if EW8[i]==null then
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n037'))
  else
    call SetUnitScale(EW8[i],2.5,2.5,2.5)
    call KillUnit(EW8[i])
  endif
endfunction

function VFE takes nothing returns nothing
  call SetUnitX(GetEnumUnit(),EX8)
  call SetUnitY(GetEnumUnit(),EY8)
endfunction

function Prophet_Sprout takes nothing returns nothing
  local destructable array dx
  local integer VT8
  local integer VU8
  local fogmodifier VHE
  local unit Caster=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local location PKE
  local real x
  local real y
  local group g=GetAvailableGroup()
  if Target==null then
    set PKE=GetSpellTargetLoc()
  else
    set PKE=GetUnitLoc(Target)
  endif
  set x=GetLocationX(PKE)
  set y=GetLocationY(PKE)
  set EX8=x
  set EY8=y
  if IsUnitAlly(Caster,GetOwningPlayer(Target)) or IsBlocked(GetSpellTargetUnit())==false then
    set tt_unit1=Caster
    call GroupEnumUnitsInRange(g,x,y,150,Condition(function DefaultEnemyFilter))
    call A28(CreateFogModifierRadiusLocBJ(true,GetOwningPlayer(Caster),FOG_OF_WAR_VISIBLE,PKE,1000.),2.25+.75*GetUnitAbilityLevel(Caster,'A21E'))
    set VT8=1
    set VU8=8
    loop
      exitwhen VT8>VU8
      call B88(CreateDestructableLoc('B005',S38(PKE,150.,(I2R(VT8)*45.)),GetRandomReal(0,360),1,0),2.25+.75*GetUnitAbilityLevel(Caster,'A21E'))
      set VT8=VT8+1
    endloop
  endif
  call RemoveLocation(PKE)
  call ForGroup(g,function VFE)
  call KillGroup(g)
  set VHE=null
  set Caster=null
  set Target=null
  set PKE=null
  set g=null
endfunction

function Prophet_NaturesWrath_OnCast takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,(GetHandleId(GetOwningPlayer(GetSpellTargetUnit()))),(139)))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
  endif
endfunction

function VME takes unit Source,real x,real y returns nothing
  local unit u=CreateUnit(GetOwningPlayer(Source),'efon',x,y,0)
  call UnitApplyTimedLife(u,'BEfn',60)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",u,"origin"))
  //call SetUnitVertexColor(u,175,255,175,175)
  call SetUnitFlyHeight(u,0,0)
  set u=null
endfunction

function TreeHasBecomeAlive_RemoveFlag takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local destructable d=LoadDestructableHandle(HY,GetHandleId(t),0)
  call RemoveSavedBoolean(MHT,GetHandleId(d),'0FON')
  call PauseTimer(t)
  call DestroyTimer(t)
  set d=null
  set t=null
endfunction

function ThisTreeHasBecomeAlive takes destructable d returns nothing
  local timer t=CreateTimer()
  call SaveBoolean(MHT,GetHandleId(d),'0FON',true)
  call SaveDestructableHandle(HY,GetHandleId(t),0,d)
  call TimerStart(t,5,false,function TreeHasBecomeAlive_RemoveFlag)
  set t=null
endfunction

function VOE takes nothing returns nothing
  if(IsValidTree(GetEnumDestructable())or GetDestructableTypeId(GetEnumDestructable())=='B005')and EZ8<=EA8 and (GetDestructableLife(GetEnumDestructable())>0 or (ForceOfNatureMC and LoadBoolean(MHT,GetHandleId(GetEnumDestructable()),'0FON'))) then
    set EZ8=EZ8+1
    call VME(GetTriggerUnit(),ForceOfNatureX,ForceOfNatureY)
    if not ForceOfNatureMC then
      call ThisTreeHasBecomeAlive(GetEnumDestructable())
      call KillDestructable(GetEnumDestructable())
    endif
  elseif EZ8>EA8 then
    call KillDestructable(GetEnumDestructable())
  endif
endfunction

function Furion_ForceOfNature takes nothing returns nothing
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A333')
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real d=75+75*Level+25
  local rect r=Rect(x-d,y-d,x+d,y+d)
  set ForceOfNatureX=x
  set ForceOfNatureY=y
  set ForceOfNatureMC=GetUnitTypeId(GetTriggerUnit())=='e00E'
  set EZ8=0
  set EA8=Level
  call EnumDestructablesInRect(r,Condition(function ReturnTrue),function VOE)
  call RemoveRect(r)
  set ForceOfNatureMC=false
  set r=null
endfunction

function VKE takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(GetTriggerUnit()))then
    call PingMinimapEx(x,y,3,255,255,255,false)
  endif
  call DestroyEffect(AddSpecialEffect("war3mapImported\\FurionTeleportTarget.mdx",x,y))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\FurionTeleportTarget.mdx",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
endfunction

function VQE takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local real d=DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),E38,E68)
  if d<EC8 and IsUnitVisible(Target,GetOwningPlayer(EL8)) then
    set EB8=GetEnumUnit()
    set EC8=d
  endif
  set Target=null
endfunction

function Prophet_WrathOfNature takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1W8')
  local integer A38='A07X'
  local group g
  local unit Caster
  if Level==0 then
    set Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1W9')
    set A38='A0AL'
  endif
  if Target==null then
    set EB8=null
    set EL8=Source
    set EC8=999999
    set E38=GetSpellTargetX()
    set E68=GetSpellTargetY()
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,0,0,9999,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function VQE)
    call KillGroup(g)
    set Target=EB8
    set g=null
  endif
  if Target!=null then
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
    call UnitAddAbility2(Caster,A38)
    call SetUnitAbilityLevel(Caster,A38,Level)
    call IssueTargetOrderById(Caster,852119,Target)
    set Caster=null
  endif
  set Source=null
  set Target=null
endfunction

function VTE takes unit Source,unit Target, integer lvl, boolean isagh returns nothing
  local real selfcost
  local real targetcost=.35
  call UnitAddAbilityTimedEx(Target,'A334',lvl,3+lvl,'B083')
  if isagh then
    set targetcost=.65
  endif
  set selfcost=.35
  call DamageTarget(Source,Source,1,GetWidgetLife(Source)*selfcost)
  call DamageTarget(Source,Target,1,GetWidgetLife(Target)*targetcost)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Source,"chest"))
  call DestroyEffect(AddSpecialEffectTarget("effects\\LifeBreak.mdx",Target,"chest"))
endfunction

function VWE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local real LastX=LoadReal(HY,h,23)
  local real LastY=LoadReal(HY,h,24)
  local real x
  local real y
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
  local integer lvl=LoadInteger(HY,h,0)
  local boolean isagh=LoadInteger(HY,h,1)=='A1B3'
  call SetUnitAnimationByIndex(Source,LoadInteger(MHT,GetUnitTypeId(Source),'A1P8'))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or DistanceBetweenXY(LastX,LastY,TargetX,TargetY)>1400 or IsUnitDisabled(Source)then
    call SetUnitPathing(Source,true)
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call UnitRemoveAbility(Source,'A0ST')
    call SetUnitTimeScale(Source,1.)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)<125 then
    call SetUnitPathing(Source,true)
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call UnitRemoveAbility(Source,'A0ST')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitTimeScale(Source,1.)
    if Target!=null and IsDead(Target)==false then
      call IssueTargetOrderById(Source,851983,Target)
      call VTE(Source,Target,lvl,isagh)
    endif
  else
    call SetUnitPathing(Source,false)
    set LastX=TargetX
    set LastY=TargetY
    call SaveReal(HY,h,23,LastX*1.)
    call SaveReal(HY,h,24,LastY*1.)
    set x=SourceX+15*Cos(a)
    set y=SourceY+15*Sin(a)
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitPosition(Source,x,y)
    call SetUnitFacing(Source,a*bj_RADTODEG)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function VXE takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.015,true)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function VWE))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveInteger(HY,h,1,GetSpellAbilityId())
  call SaveUnitHandle(HY,h,17,Target)
  call SaveReal(HY,h,23,GetUnitX(Target)*1.)
  call SaveReal(HY,h,24,GetUnitY(Target)*1.)
  call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("war3mapImported\\LifeBreakCharge.mdx",Source,"hand right alternate"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("war3mapImported\\LifeBreakCharge.mdx",Source,"hand left alternate"))
  call SetUnitPathing(Source,false)
  call UnitAddAbility2(Source,'A0ST')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A0ST',false)
  call SetUnitAnimationByIndex(Source,LoadInteger(MHT,GetUnitTypeId(Source),'A1P8'))
  call SetUnitTimeScale(Source,3.)
  set Source=null
  set Target=null
  set t=null
endfunction

function Huskar_LifeBreak takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call VXE()
  endif
endfunction

function VZE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=(LoadInteger(HY,h,5))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer VAE=GetHeroMainStatValue(Target)
  local real YP8=GetWidgetLife(Target)
  local real MIE=GetUnitState(Target,UNIT_STATE_MAX_LIFE)
  local real VBE
  if YP8/ MIE>.4 then
    set VBE=(Level*1.0)/ 4*.2*VAE+2*Level
  else
    set VBE=(Level*1.0/4 +0.25)*.6*VAE+2*Level
  endif
  set VBE=VBE/ 8.
  if GetTriggerEvalCount(t)>16*8. or GetUnitAbilityLevel(Target,'A0QO')==0 then
    call DestroyEffect((LoadEffectHandle(HY,h,(31))))
    call UnitRemoveAbility(Target,'A0QO')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetWidgetLife(Target,YP8+VBE)
  endif
  set Target=null
  set t=null
  return false
endfunction

function Huskar_InnerVitality takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0QP')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1/ 8.,true)
  call TriggerAddCondition(t,Condition(function VZE))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveEffectHandle(HY,h,(31),(AddSpecialEffectTarget("InnerVitality.mdx",Target,"chest")))
  call UnitAddAbility2(Target,'A0QO')
  call SetUnitAbilityLevel(Target,'A0QO',Level)
  set Target=null
  set Source=null
  set t=null
endfunction

function V6E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,30)
  local unit Source=LoadUnitHandle(HY,h,2)
  if GetTriggerEvalCount(t)>8 or IsDead(Target)then
    call DestroyEffect(LoadEffectHandle(HY,h,31))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DamageTarget(Source,Target,1,5*GetUnitAbilityLevel(Source,'A0QN'))
  endif
  set t=null
  set Target=null
  set Source=null
  return false
endfunction

function Huskar_BurningSpears_Damage takes unit attacker,unit Target returns nothing
  local integer h=GetHandleId(attacker)
  local integer Cache2
  local trigger t
  if LoadBoolean(MHT,GetHandleId(attacker),'A0QN'+1) then
    call UnitRemoveAbility(attacker,'A40H')
    call SaveBoolean(MHT,GetHandleId(attacker),'A0QN'+1,false)
  endif
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function V6E))
  set Cache2=GetHandleId(t)
  call SaveUnitHandle(HY,Cache2,2,attacker)
  call SaveUnitHandle(HY,Cache2,30,Target)
  call SetWidgetLife(attacker,RMaxIF(GetWidgetLife(attacker)-15,1))
  call SaveEffectHandle(HY,Cache2,31,AddSpecialEffectTarget("Abilities\\Spells\\Other\\BreathOfFire\\BreathOfFireDamage.mdl",Target,"chest"))
  set t=null
endfunction

function Huskar_BurningSpears_Wrapper takes unit attacker, unit target returns nothing
  if GetUnitAbilityLevel(attacker,'A0QN')>0 and not IsUnitSilenced(attacker) and IsUnitType(target,UNIT_TYPE_MECHANICAL)==false then
    if LoadBoolean(MHT,GetHandleId(attacker),'A0QN') then//if autocast
      call Huskar_BurningSpears_Damage(attacker,target)
    endif
    if LoadBoolean(MHT,GetHandleId(attacker),'A0QN'+1) then
      if LoadUnitHandle(MHT,GetHandleId(attacker),'A0QN'+1)==target then
        call Huskar_BurningSpears_Damage(attacker,target)
      else
        call SaveBoolean(MHT,GetHandleId(attacker),'A0QN'+1,false)
        call UnitRemoveAbility(attacker,'A40H')
      endif
    endif
  endif
endfunction

function Huskar_BurningSpears_OnAttack takes unit attacker, unit target returns nothing
  if LoadBoolean(MHT,GetHandleId(attacker),'A0QN'+1) then
    if LoadUnitHandle(MHT,GetHandleId(attacker),'A0QN'+1)!=target then
      call SaveBoolean(MHT,GetHandleId(attacker),'A0QN'+1,false)
      call UnitRemoveAbility(attacker,'A40H')
    endif
  endif
endfunction

function Huskar_BerserkerBlood_Resist takes unit Hero,integer amount returns nothing
  local integer i=0
  loop
    exitwhen i>24
    if i!=amount/4 and GetUnitAbilityLevel(Hero,BerserkerBloodResistCont[i])>0 then
      call UnitRemoveAbility(Hero,BerserkerBloodResistCont[i])
    endif
    set i=i+1
  endloop
  if GetUnitAbilityLevel(Hero,BerserkerBloodResistCont[amount/4])==0 then
    call UnitAddAbility2(Hero,BerserkerBloodResistCont[amount/4])
    call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),BerserkerBloodResistCont[amount/4],false)
  endif
endfunction

function Huskar_BerserkerBlood_Act takes nothing returns boolean
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real curHP=GetWidgetLife(Hero)
  local integer curPercent
  local integer i
  local integer Level=GetUnitAbilityLevel(Hero,'A0QQ')+GetUnitAbilityLevel(Hero,'QP1L')
  local boolean effectHere=LoadBoolean(HY,h,319)
  local integer bas
  local integer res
  if IsUnitType(Hero,UNIT_TYPE_HERO) and Level>0 and IsDead(Hero)==false then
    set curPercent=R2I(100*curHP/GetUnitState(Hero,UNIT_STATE_MAX_LIFE))
    set i=IMaxIF(IMinIF(R2I(100-curPercent)/7,14),1)
    set res=(3+Level)*i
    set bas=(12+2*Level)*i
    if GetUnitAbilityLevel(Hero,'BNdo')>0 then
      set res=0
      set bas=0
    endif
    if res!=LoadInteger(HY,h,1) then
      call Huskar_BerserkerBlood_Resist(Hero,res)
      call SaveInteger(HY,h,1,res)
    endif
    if bas!=LoadInteger(HY,h,0) then
      if bas-LoadInteger(HY,h,0) > 0 then
        call LoDStat_Add(Hero,bas-LoadInteger(HY,h,0),"attack")
      else
        call LoDStat_Sub(Hero,LoadInteger(HY,h,0)-bas,"attack")
      endif
      call SaveInteger(HY,h,0,bas)
    endif
    if curPercent<40 then
      if effectHere==false then
        call SaveBoolean(HY,h,319,true)
        call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\TrollBerserk\\HeadhunterWEAPONSLeft.mdl",Hero,"left weapon"))
        call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("effects\\HeadhunterWEAPONSRight_NoSound.mdx",Hero,"right weapon"))
      endif
    else
      if effectHere then
        call SaveBoolean(HY,h,319,false)
        call DestroyEffect(LoadEffectHandle(HY,h,175))
        call DestroyEffect(LoadEffectHandle(HY,h,176))
      endif
    endif
  endif
  set Hero=null
  return false
endfunction

function Huskar_BerserkerBlood_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function Huskar_BerserkerBlood_Act))
  call SaveUnitHandle(HY,GetHandleId(t),14,GetTriggerUnit())
  call SaveBoolean(HY,GetHandleId(t),319,false)
  call SaveInteger(HY,GetHandleId(t),0,0)
  set t=null
  set BerserkerBloodResistCont[1]='A2PM'
  set BerserkerBloodResistCont[2]='A2PN'
  set BerserkerBloodResistCont[3]='A2PO'
  set BerserkerBloodResistCont[4]='A2PP'
  set BerserkerBloodResistCont[5]='A2PQ'
  set BerserkerBloodResistCont[6]='A2PJ'
  set BerserkerBloodResistCont[7]='A2PR'
  set BerserkerBloodResistCont[8]='A2PI'
  set BerserkerBloodResistCont[9]='A2PL'
  set BerserkerBloodResistCont[10]='A2PT'
  set BerserkerBloodResistCont[11]='A2Q1'
  set BerserkerBloodResistCont[12]='A2PU'
  set BerserkerBloodResistCont[13]='A2PH'
  set BerserkerBloodResistCont[14]='A2PV'
  set BerserkerBloodResistCont[15]='A2PW'
  set BerserkerBloodResistCont[16]='A2PX'
  set BerserkerBloodResistCont[17]='A2PY'
  set BerserkerBloodResistCont[18]='A2PZ'
  set BerserkerBloodResistCont[19]='A2Q0'
  set BerserkerBloodResistCont[20]='A2PK'
  set BerserkerBloodResistCont[21]='A2PS'
  set BerserkerBloodResistCont[22]='A2TA'
  set BerserkerBloodResistCont[23]='A2TB'
  set BerserkerBloodResistCont[24]='A2TC'
endfunction

function WKE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,5)
  local real a=LoadReal(HY,h,137)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local integer id=GetPlayerId(GetOwningPlayer(Source))
  local integer Count=GetTriggerEvalCount(t)
  local real AO8=x+150*Count*Cos(a)
  local real AP8=y+150*Count*Sin(a)
  local integer WME=6
  if LoadBoolean(HY,h,0) then
    set WME=12
  endif
  call IssuePointOrderById(E18[id],852488,AO8,AP8)
  if Count==(WME)then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitAnimation(Source,"stand")
  endif
  set t=null
  set Source=null
  return false
endfunction

function THD_Macropyre takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local integer Level=GetUnitAbilityLevel(Source,'A0O5')
  local integer WOE='A0OE'
  call SaveBoolean(HY,h,0,false)
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A1B1')
    set WOE='A1B2'
    call SaveBoolean(HY,h,0,true)
  endif
  call SetUnitAnimation(Source,"spell")
  set E18[GetPlayerId(GetOwningPlayer(Source))]=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call UnitAddAbility2(E18[GetPlayerId(GetOwningPlayer(Source))],WOE)
  call SetUnitAbilityLevel(E18[GetPlayerId(GetOwningPlayer(Source))],WOE,Level)
  call SaveInteger(HY,h,5,Level)
  call SaveReal(HY,h,6,GetUnitX(Source))
  call SaveReal(HY,h,7,GetUnitY(Source))
  call SaveReal(HY,h,137,a*1.)
  call SaveUnitHandle(HY,h,2,Source)
  if WOE=='A0OE' then
    call TriggerRegisterTimerEvent(t,.1,true)
  else
    call TriggerRegisterTimerEvent(t,.05,true)
  endif
  call TriggerAddCondition(t,Condition(function WKE))
  set t=null
  set Source=null
endfunction

function THD_LiquidFire takes nothing returns nothing
  
endfunction

function Jakiro_Icepath_End takes timer t, integer info returns nothing
  local integer i = 0
  loop
    call DestroyUbersplat(LoadUbersplatHandle(MHT,info,i + 14))
    call DestroyEffect(LoadEffectHandle(MHT,info,i + 3))
    set i = i + 1
    exitwhen i == 11
  endloop
  call RemoveUnit(LoadUnitHandle(MHT,info,1))
  call KillGroup(LoadGroupHandle(MHT,info,2))
  call Timer_End(t)
  set t = null
endfunction

function Jakiro_Icepath_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  local group g = null
  local player p = GetOwningPlayer(t)
  if IsDead(t)==false and IsUnitEnemy(u,p) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    set g = LoadGroupHandle(MHT,group_temp_integer[0],2)
    if IsUnitInGroup(t,g)==false then
      call GroupAddUnit(g,t)
      call DamageTarget(u,t,1,group_temp_integer[1])
      call StunTargetLod(t,(group_temp_integer[2]*1.0)*0.4+0.6)
      call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(t),GetUnitY(t)))
    endif
    set g = null
  endif
  //dem guts :3
  set u = null
  set t = null
  return false
endfunction

function Jakiro_Icepath_Duration takes nothing returns nothing
  local ubersplat u = null
  local timer t = GetExpiredTimer()
  local integer loopA
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0) + 1
  local integer max = LoadInteger(MHT,info,1)
  local real angle
  local real ax
  local real ay
  local real x
  local real y
  if count==max then
    call Jakiro_Icepath_End(t,info)
    set t = null
    return
  endif
  call SaveInteger(MHT,info,0,count)
  if count<10 then
    set angle = LoadReal(MHT,info,0)
    set x = LoadReal(MHT,info,1) + 100*count*Cos(angle)
    set y = LoadReal(MHT,info,2) + 100*count*Sin(angle)
    call SaveEffectHandle(MHT,info,2 + count,AddSpecialEffect("effects\\IcePath.mdx",x,y))
    set u = CreateUbersplat(x,y,"IPTH",255,255,255,255,false,false) //doesnt seem to display the effect \:3/
    call SetUbersplatRenderAlways(u,true)
    call SaveUbersplatHandle(MHT,info,13 + count,u)
    set t = null
    set u = null
    return
  endif
  set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
  set group_temp_unit[1] = LoadUnitHandle(MHT,info,1)
  set group_temp_integer[2] = LoadInteger(MHT,info,3)
  set group_temp_integer[1] = LoadInteger(MHT,info,2)
  set group_temp_integer[0] = info
  set angle = LoadReal(MHT,info,0)
  set x = LoadReal(MHT,info,1)
  set y = LoadReal(MHT,info,2)
  set ax = Cos(angle)
  set ay = Sin(angle)
  set loopA = 0
  loop
    call GroupEnumUnitsInRange(temp_group,x,y,175,Condition(function Jakiro_Icepath_Targets))
    set x = x + 100*ax
    set y = y + 100*ay
    set loopA = loopA + 1
    exitwhen loopA == 10
  endloop
  set t = null
endfunction

function Jakiro_Icepath_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A0O6')
  local real x = GetWidgetX(u)
  local real y = GetWidgetY(u)
  call SaveUnitHandle(MHT,info,0,u)
  set u = CreateUnit(Player(15),'e00E',0,0,0)
  call SaveUnitHandle(MHT,info,1,u)
  call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,level*8 + 12)
  call SaveInteger(MHT,info,2,50)
  call SaveInteger(MHT,info,3,level)
  call SaveReal(MHT,info,0,Atan2(GetSpellTargetY()-y,GetSpellTargetX()-x))
  call SaveReal(MHT,info,1,x)
  call SaveReal(MHT,info,2,y)
  call TimerStart(t,0.05,true,function Jakiro_Icepath_Duration)
  set t = null
  set u = null
endfunction

function THD_DualBreath_MOREMATH takes real r1,real r2,real r3,real r4,real r5,real r6,real x,real y returns boolean
  local real r7=(y-r2)*(r3-r1)-(x-r1)*(r4-r2)
  local real r8=(y-r6)*(r1-r5)-(x-r5)*(r2-r6)
  local real r9=(y-r4)*(r5-r3)-(x-r3)*(r6-r4)
  return(r7*r8>0)and(r9*r8>0)
endfunction

function THD_DualBreath_Filter takes nothing returns boolean
  local real r1=THD_TempReal1
  local real r2=THD_TempReal2
  local real r3=THD_TempReal3
  local real r4=THD_TempReal4
  local real r5=THD_TempReal5
  local real r6=THD_TempReal6
  return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and THD_DualBreath_MOREMATH(r1,r2,r3,r4,r5,r6,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
endfunction

function THD_DualBreath_MATH takes real angle,real x,real y returns nothing
  local real dist=600
  local real startWidth=200
  local real finalWidth=250
  local real asin=Asin((finalWidth-startWidth)/dist)
  local real r1=startWidth/Sin(asin)
  local real r2=(dist+finalWidth+r1)*Tan(asin)
  local real r3=x+r1*Cos((angle-180)*bj_DEGTORAD)
  local real r4=y+r1*Sin((angle-180)*bj_DEGTORAD)
  local real r5=(x+(dist+finalWidth)*Cos(angle*bj_DEGTORAD))+r2*Cos((angle-90)*bj_DEGTORAD)
  local real r6=(y+(dist+finalWidth)*Sin(angle*bj_DEGTORAD))+r2*Sin((angle-90)*bj_DEGTORAD)
  local real r7=(x+(dist+finalWidth)*Cos(angle*bj_DEGTORAD))+r2*Cos((angle+90)*bj_DEGTORAD)
  local real r8=(y+(dist+finalWidth)*Sin(angle*bj_DEGTORAD))+r2*Sin((angle+90)*bj_DEGTORAD)
  set THD_TempReal1=r3
  set THD_TempReal2=r4
  set THD_TempReal3=r5
  set THD_TempReal4=r6
  set THD_TempReal5=r7
  set THD_TempReal6=r8
endfunction

function THD_DualBreath_ForGroup takes nothing returns nothing
  local unit u=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
  call UnitAddAbility2(u,'A0OA')
  call IssueTargetOrder(u,"frostnova",GetEnumUnit())
  set u=null
endfunction

function THD_DualBreath_BurnBaby takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=LoadPlayerHandle(MHT,h,54)
  local unit caster=LoadUnitHandle(MHT,h,14)
  local real sourceX=LoadReal(MHT,h,6)
  local real sourceY=LoadReal(MHT,h,7)
  local real targetX=LoadReal(MHT,h,47)
  local real targetY=LoadReal(MHT,h,48)
  local integer lvl=LoadInteger(MHT,h,5)
  local unit dummy
  if GetTriggerEvalCount(t)>1 then
    call SetUnitAnimation(caster,"stand")
    call FlushChildHashtable(MHT,h)
    call CleanTrigger(t)
  else
    call SetUnitAnimation(caster,"spell")
    set dummy=CreateUnit(p,'e00E',sourceX,sourceY,0)
    call UnitAddAbility2(dummy,'A0OC')
    call SetUnitAbilityLevel(dummy,'A0OC',lvl)
    call IssuePointOrder(dummy,"breathoffrost",targetX,targetY)
  endif
  set t=null
  set p=null
  set caster=null
  set dummy=null
  return false
endfunction

function THD_DualBreath_FireFrei takes unit u,player p,integer lvl,location l,real x,real y returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SavePlayerHandle(MHT,h,54,p)
  call SaveReal(MHT,h,6,x*1.0)
  call SaveReal(MHT,h,7,y*1.0)
  call SaveReal(MHT,h,47,GetLocationX(l)*1.0)
  call SaveReal(MHT,h,48,GetLocationY(l)*1.0)
  call SaveInteger(MHT,h,5,lvl)
  call SaveUnitHandle(MHT,h,14,u)
  call TriggerRegisterTimerEvent(t,0.3,true)
  call TriggerAddCondition(t,Condition(function THD_DualBreath_BurnBaby))
  set t=null
endfunction

function THD_DualBreath takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(caster,'A0O7')
  local real x=GetUnitX(caster)
  local real y=GetUnitY(caster)
  local location l
  local unit dummy
  local group g=GetAvailableGroup()
  if GetSpellTargetUnit()==null then
    set l=GetSpellTargetLoc()
  else
    set l=GetUnitLoc(GetSpellTargetUnit())
  endif
  call THD_DualBreath_MATH(bj_RADTODEG*Atan2(GetLocationY(l)-y,GetLocationX(l)-x),x,y)
  call GroupEnumUnitsInRange(g,x,y,2000,Condition(function THD_DualBreath_Filter))
  call ForGroup(g,function THD_DualBreath_ForGroup)
  call KillGroup(g)
  set dummy=CreateUnit(GetOwningPlayer(caster),'e00E',x,y,0)
  call UnitAddAbility2(dummy,'A0OB')
  call SetUnitAbilityLevel(dummy,'A0OB',lvl)
  call IssuePointOrder(dummy,"breathoffire",GetLocationX(l),GetLocationY(l))
  call THD_DualBreath_FireFrei(caster,GetOwningPlayer(caster),lvl,l,x+50*Cos(Atan2(GetLocationY(l)-y,GetLocationX(l)-x)),y+50*Sin(Atan2(GetLocationY(l)-y,GetLocationX(l)-x)))
  call RemoveLocation(l)
  set caster=null
  set l=null
  set g=null
  set dummy=null
endfunction

function THD_DualBreath_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0OB')
  call PreloadQueryAdd('A0OC')
  call PreloadQueryAdd('A0OA')
  call PreloadQueryAdd('A0OE')
endfunction

function XXE takes unit Hero,unit Target returns nothing
  local real a=GetRandomReal(0,360)
  local real x=GetUnitX(Target)+50*Cos(a*bj_DEGTORAD)
  local real y=GetUnitY(Target)+50*Sin(a*bj_DEGTORAD)
  local real XYE=GetRandomReal(200,225)
  call SetUnitX(Hero,x)
  call SetUnitY(Hero,y)
  call SetUnitFacing(Hero,bj_RADTODEG*Atan2(GetUnitY(Target)-GetUnitY(Hero),GetUnitX(Target)-GetUnitX(Hero)))
  call SetUnitAnimation(Hero,"Attack")
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",Hero,"chest"))
  if IsPlayerBelongToTeams(GetOwningPlayer(Target))==false and IsUnitType(Target,UNIT_TYPE_ANCIENT)==false then
    set XYE = 99999
  endif
  call DamageTarget(Hero,Target,2,XYE)
  //call IssueTargetOrderById(Hero,851983,Target)
endfunction

function XZE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit Target=(LoadUnitHandle(HY,h,17))
  call XXE(Hero,Target)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  set Target=null
  return false
endfunction

function XAE takes unit Hero returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),450,Condition(function Juggernaut_Omnislash_Filter))
  set tt_unit1=GroupPickRandomUnit(g)
  if tt_unit1!=null then
    call XXE(Hero,tt_unit1)
  endif
  call KillGroup(g)
  set g=null
endfunction

function XBE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit VisionDummy=(LoadUnitHandle(HY,h,(19)))
  local integer XCE=(LoadInteger(HY,h,(216)))
  local integer X3E=(LoadInteger(HY,h,(325)))
  local integer KAE=(LoadInteger(HY,h,(28)))
  local unit X6E
  if KAE>XCE then
    if LoadInteger(HY,h,0)>0 then
      call LoDStat_Sub(Hero,LoadInteger(HY,h,0),"attack")
    endif
    call KillUnit(VisionDummy)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A05G',true)
    call SetUnitPathing(Hero,true)
    call SetUnitInvulnerable(Hero,false)
    call SaveInteger(HY,(GetHandleId((Hero))),((4253)),2)
    //call SetUnitVertexColor(Hero,255,255,255,255)
    call SetTint(Hero,-1,-1,-1,255)
  else
    call SaveInteger(HY,h,(28),(KAE+1))
    call XAE(Hero)
    if tt_unit1==null then
      if LoadInteger(HY,h,0)>0 then
        call LoDStat_Sub(Hero,LoadInteger(HY,h,0),"attack")
      endif
      call KillUnit(VisionDummy)
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A05G',true)
      call SetUnitPathing(Hero,true)
      call SetUnitInvulnerable(Hero,false)
      call SaveInteger(HY,(GetHandleId((Hero))),((4253)),2)
      //call SetUnitVertexColor(Hero,255,255,255,255)
      call SetTint(Hero,-1,-1,-1,255)
    endif
  endif
  set t=null
  set Hero=null
  set X6E=null
  set VisionDummy=null
  return false
endfunction

function Juggernaut_Omnislash takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0M1')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer X3E=GetUnitAbilityLevel(Hero,'A05G')
  local player p=GetOwningPlayer(Hero)
  local integer XCE=3
  local unit VisionDummy=CreateUnit(GetOwningPlayer(Hero),'o00D',GetUnitX(Hero),GetUnitY(Hero),0)
  local integer maxstat=IMaxIF(GetHeroStr(Hero,true),IMaxIF(GetHeroAgi(Hero,true),GetHeroInt(Hero,true)))
  local integer asbonus=maxstat-GetHeroAgi(Hero,true)
  
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A1AX')
    if Level==1 then
      set XCE=6
    elseif Level==2 then
      set XCE=9
    elseif Level==3 then
      set XCE=12
    endif
  elseif Level==2 then
    set XCE=6
  elseif Level==3 then
    set XCE=9
  endif
  call SetPlayerAbilityAvailable2(p,'A05G',false)
  //call SetUnitVertexColor(Hero,255,255,255,125)
  call SetTint(Hero,-1,-1,-1,125)
  call SetUnitPathing(Hero,false)
  call SetUnitInvulnerable(Hero,true)
  call SaveInteger(HY,(GetHandleId((Hero))),((4253)),(1))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,17,(Target))
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function XZE))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,(19),(VisionDummy))
  call SaveInteger(HY,h,(216),(XCE))
  call SaveInteger(HY,h,(325),(X3E))
  call SaveInteger(HY,h,(28),2)
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",Hero,GetProperAttachPoint_Weapon(Hero))))
  call TriggerRegisterTimerEvent(t,.4,true)
  call TriggerAddCondition(t,Condition(function XBE))
  if asbonus>0 then
    call LoDStat_Add(Hero,asbonus,"attack")
    call SaveInteger(HY,h,0,asbonus)
  endif
  set Hero=null
  set Target=null
  set t=null
  set p=null
  set VisionDummy=null
endfunction

function X0E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call SetUnitAnimationByIndex(Source,4)
  set t=null
  set Source=null
  return false
endfunction

function Juggernaut_Omnislash_OnCast takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function X0E))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=null
  set Source=null
endfunction

function Y4E takes nothing returns nothing
  call DamageTarget(E28,GetEnumUnit(),1,(60.+20.*F48)*.25)
endfunction

function Y7E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Count=GetTriggerEvalCount(t)
  local group g
  if Count==20 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect(LoadEffectHandle(HY,h,(32)))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt_unit1=Source
    set E28=Source
    set F48=LoadInteger(HY,h,0)
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),275,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function Y4E)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Juggernaut_Bladefury takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Y7E))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),'A05G'))
  call SaveUnitHandle(HY,h,2,(GetTriggerUnit()))
  if (GetUnitTypeId(GetTriggerUnit())!='Nbbc' and GetUnitTypeId(GetTriggerUnit())!='Opgh')then
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\SpinFX2.mdx",GetTriggerUnit(),"origin")))
  endif
  call TriggerEvaluate(t)
  call AddTimedKeyToUnit(GetTriggerUnit(),4252,5)
  set t=null
endfunction

function YDE takes nothing returns boolean
  return GetUnitTypeId(GetSummonedUnit())=='o00C' or GetUnitTypeId(GetSummonedUnit())=='o01G' or GetUnitTypeId(GetSummonedUnit())=='o01H' or GetUnitTypeId(GetSummonedUnit())=='o01I'
endfunction

function YEE takes nothing returns nothing
  call SetUnitAbilityLevel(GetSummonedUnit(),'A058',GetUnitAbilityLevel(GetSummoningUnit(),'A047'))
endfunction

function K39 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function YDE))
  call TriggerAddAction(t,function YEE)
  set t=null
endfunction

function YFE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real x1
  local real y1
  local real x2
  local real y2
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetEventDamage()>2 and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource())))then
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()!=EVENT_UNIT_DAMAGED and GetTriggerEventId()!=EVENT_UNIT_DEATH then
    set x1=GetUnitX(Source)
    set y1=GetUnitY(Source)
    set x2=GetUnitX(Target)
    set y2=GetUnitY(Target)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",x1,y1))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",x2,y2))
    call AddTimedKeyToUnit(Target,4410,1)
    call SetUnitPosition(Target,GetUnitX(Source),GetUnitY(Source))
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function YGE takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local real d=DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),F98,FD8)
  if d<F88 and LoadBoolean(HY,GetHandleId(GetOwningPlayer(Target)),139)==false then
    set F78=Target
    set F88=d
  endif
  set Target=null
endfunction

function Kotl_Recall takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local trigger t
  local integer h
  local real DP9
  local group g
  local integer lvl=GetUnitAbilityLevel(Source,'A10U')
  if Target==null then
    set F78=null
    set F88=999999
    set F98=GetSpellTargetX()
    set FD8=GetSpellTargetY()
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,0,0,9999,Condition(function D79))
    call GroupRemoveUnit(g,Source)
    call ForGroup(g,function YGE)
    call KillGroup(g)
    set Target=F78
    set g=null
  endif
  if Target!=null then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(t,6-lvl,false)
    call TriggerAddCondition(t,Condition(function YFE))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Source,"origin")))
    call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTo.mdl",Target,"origin")))
  endif
  set Target=null
  set Source=null
  set t=null
endfunction

function Kotl_Recall_OnCast takes nothing returns nothing
  if GetSpellTargetUnit()!=null and LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetSpellTargetUnit()),"This player has disabled help from allies.")
  endif
endfunction

function YKE takes integer Level returns integer
  if Level==1 then
    return 'A10Z'
  elseif Level==2 then
    return 'A111'
  elseif Level==3 then
    return 'A10Y'
  elseif Level==4 then
    return 'A110'
  endif
  return 0
endfunction

function YME takes integer Level returns integer
  if Level==1 then
    return 'B09M'
  elseif Level==2 then
    return 'B09N'
  elseif Level==3 then
    return 'B09O'
  elseif Level==4 then
    return 'B09L'
  endif
  return 0
endfunction

function YNE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local real LastX=(LoadReal(HY,h,(23)))
  local real LastY=(LoadReal(HY,h,(24)))
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real d=SquareRoot((LastX-x)*(LastX-x)+(LastY-y)*(LastY-y))
  local real YOE=(.0005)*d*GetUnitState(Target,UNIT_STATE_MAX_MANA)
  local integer EZE=GetTriggerEvalCount(t)
  if IsMagicImmune(Target) then
    set YOE=0
  endif
  if d>300 then
    set YOE=0
  endif
  if YOE>1 and ModuloInteger(GetTriggerEvalCount(t),3)==0 then
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",Target,"chest"))
  endif
  if YOE>0 then
    call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-YOE)
  endif
  call SaveReal(HY,h,(23),((x)*1.))
  call SaveReal(HY,h,(24),((y)*1.))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or EZE==(Level+4)*10 or GetUnitAbilityLevel(Target,YKE(Level))==0 then
    call UnitRemoveAbility(Target,YKE(Level))
    call UnitRemoveAbility(Target,YME(Level))
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetUnitState(Target,UNIT_STATE_MANA)<1 then
    call StunTargetLod(Target,1+.5*Level)
    call UnitRemoveAbility(Target,YKE(Level))
    call UnitRemoveAbility(Target,YME(Level))
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function YPE takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A10X')
  call UnitAddAbility2(Target,YKE(Level))
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,23,((GetUnitX(Target))*1.))
  call SaveReal(HY,h,24,((GetUnitY(Target))*1.))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("effects\\BasicWaterFlash.mdx",Target,"chest")))
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function YNE))
  set Source=null
  set Target=null
  set t=null
endfunction

function Kotl_ManaLeak takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call YPE()
  endif
endfunction

function Kotl_SpiritForm_MoveDummy takes nothing returns nothing
  local integer h=GetHandleId(GetExpiredTimer())
  local unit u=LoadUnitHandle(HY,h,0)
  local unit d=LoadUnitHandle(HY,h,1)
  if GetUnitTypeId(u)=='H06X' and IsDead(u)==false and GetWidgetLife(u)>0 and IsUnitHidden(u)==false then
    if IsUnitHidden(d) then
      call ShowUnit(d,true)
    endif
    call SetUnitPosition(d,GetUnitX(u),GetUnitY(u))
  else
    if IsUnitHidden(d)==false then
      call ShowUnit(d,false)
    endif
  endif
  
  set u=null
  set d=null
endfunction

function Kotl_SpiritForm_Init takes unit u returns nothing
  local unit d=CreateUnit(GetOwningPlayer(u),'hSPR',GetUnitX(u),GetUnitY(u),0)
  local timer t=CreateTimer()
  //call SaveUnitHandle(MHT,GetHandleId(u),'SPRT',d)
  call TimerStart(t,0.25,true,function Kotl_SpiritForm_MoveDummy)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveUnitHandle(HY,GetHandleId(t),1,d)
  call SaveBoolean(MHT,GetHandleId(u),'SPRT',true)
  set t=null
  set d=null
endfunction

function Kotl_SpiritForm takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'QM01')
  local player p=GetOwningPlayer(u)
  local boolean morphOn=GetUnitTypeId(u)!='H06X'
  call SetPlayerAbilityAvailable(p,'A11X',morphOn)
  call SetPlayerAbilityAvailable(p,'A10U',morphOn)
  call SetUnitAbilityLevel(u,'A11X',lvl)
  call SetUnitAbilityLevel(u,'A10U',lvl)
  if morphOn then
    if LoadBoolean(MHT,GetHandleId(u),'SPRT')!=true then//no dummy
      call Kotl_SpiritForm_Init(u)
    endif
  endif
  set u=null
endfunction

function Keeper_Illuminate_End takes nothing returns nothing
  call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A085',false)
endfunction

function Keeper_Illuminate_Check takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer id =  GetUnitTypeId(u)
  if id<'H06W' or id>'H06Y' then
    call SaveBoolean(MHT,GetHandleId(u),'A085',false)
  endif
  set u = null
endfunction

function Keeper_Illuminate_Targets takes nothing returns boolean
  local unit u = GetFilterUnit()
  local integer id = GetUnitTypeId(u)
  if IsDead(u)==false and IsUnitInGroup(u,ILLUMINATEGROUP)==false and (GetUnitAbilityLevel(u,'A04R')==0 or IsSiegeUnit(u)) and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
    call GroupAddUnit(ILLUMINATEGROUP,u)
    if IsUnitEnemy(u,group_temp_player) then
      call DamageTarget(group_temp_unit[0],u,1,group_temp_integer[0])
    else
      call SetWidgetLife(u,GetWidgetLife(u)+group_temp_integer[0]*0.75)
    endif
  endif
  set u = null
  return false
endfunction

function Keeper_Illuminate_Effect takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local real x
  local real y
  local real s = LoadReal(MHT,info,StringHash("scale"))
  local unit cho = LoadUnitHandle(MHT,info,1)
  if count==1then
    call KillGroup(LoadGroupHandle(MHT,info,2))
    call Timer_End(t)
    call KillUnit(u)
    set t = null
    set u = null
    return
  endif
  call SaveInteger(MHT,info,0,count - 1)
  set x = GetWidgetX(u) + LoadReal(MHT,info,3)
  set y = GetWidgetY(u) + LoadReal(MHT,info,4)
  call SetUnitX(u,x)
  call SetUnitY(u,y)
  if s<0.4 then
    set s=s+0.025
  elseif s<1.5 and s>0.4 then
    set s=s+0.09
  else
    set s=1.5
  endif
  call SetUnitScale(u,s,s,s)
  call SaveReal(MHT,info,StringHash("scale"),s)
  call TimedReveal(GetOwningPlayer(cho),2.5,x,y,375)
  set group_temp_player = LoadPlayerHandle(MHT,info,2)
  set group_temp_unit[0] = cho
  set group_temp_integer[0] = LoadInteger(MHT,info,1)
  set ILLUMINATEGROUP = LoadGroupHandle(MHT,info,3)
  call GroupEnumUnitsInRange(temp_group,x,y,375,Condition(function Keeper_Illuminate_Targets))
  set cho=null
  set t = null
  set u = null
endfunction

function Keeper_Illuminate_Charge takes nothing returns nothing
  local real s
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0) - 1
  local unit u = LoadUnitHandle(MHT,info,0)
  local unit cho
  
  if count==0 or LoadBoolean(MHT,GetHandleId(LoadUnitHandle(MHT,info,1)),'A085')==false then
    call KillUnit(u)
    
    set cho=CreateUnit(Player(15),'h070',LoadReal(MHT,info,0),LoadReal(MHT,info,1),LoadReal(MHT,info,2))
    call SetUnitScale(cho,0.1,0.1,0.1)
    call SaveReal(MHT,info,StringHash("scale"),0.15)
    call SaveInteger(MHT,info,0,61)
    call SaveInteger(MHT,info,1,(LoadInteger(MHT,info,1) - count)*10)
    call SaveUnitHandle(MHT,info,0,cho)
    call SaveGroupHandle(MHT,info,3,GetAvailableGroup())
    
    call TimerStart(t,0.025,true,function Keeper_Illuminate_Effect)
    
    call SaveBoolean(MHT,GetHandleId(LoadUnitHandle(MHT,info,1)),'A085',false)
    call SetPlayerAbilityAvailable2(LoadPlayerHandle(MHT,info,2),'A121',false)
    call SetPlayerAbilityAvailable2(LoadPlayerHandle(MHT,info,2),'A085',true)
    
    call RemoveUnit(LoadUnitHandle(MHT,info,4))
    set cho=null
    set t = null
    set u = null
    return
  endif
  
  set s = 1 + (LoadInteger(MHT,info,1) - count) * 0.1
  call SetUnitScale(u,s,s,s)
  
  call SaveInteger(MHT,info,0,count)
  
  set t = null
  set u = null
endfunction

function Keeper_Illuminate_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local real x = GetWidgetX(u)
  local real y = GetWidgetY(u)
  local real a = Atan2(GetSpellTargetY()-y,GetSpellTargetX()-x)
  local real x1 = x + 150*Cos(a)
  local real y1 = y + 150*Sin(a)
  local integer info = GetHandleId(t)
  local integer i = GetUnitAbilityLevel(u,'A085')*10 + 10
  
  call SetPlayerAbilityAvailable2(p,'A085',false)
  call SetPlayerAbilityAvailable2(p,'A121',true)
  call UnitAddAbility2(u,'A121')
  
  call SaveUnitHandle(MHT,info,0,CreateUnit(Player(15),'u00J',x1,y1,a*bj_RADTODEG))
  
  
  call SavePlayerHandle(MHT,info,2,p)
  call SaveInteger(MHT,info,0,i)
  call SaveInteger(MHT,info,1,i)
  
  call SaveReal(MHT,info,0,x1)
  call SaveReal(MHT,info,1,y1)
  call SaveReal(MHT,info,2,a*bj_RADTODEG)
  call SaveReal(MHT,info,3,26.25*Cos(a))
  call SaveReal(MHT,info,4,26.25*Sin(a))
  
  
  if GetUnitTypeId(u)=='e00E' then //multicast
    call SaveUnitHandle(MHT,info,1,udg_Hero[GetPlayerId(p)])
    
    call SaveBoolean(MHT,GetHandleId(udg_Hero[GetPlayerId(p)]),'A085',true)
  else
    call SaveUnitHandle(MHT,info,1,u)
    call SaveBoolean(MHT,GetHandleId(u),'A085',true)
    
    if GetUnitTypeId(u)>='H06W' and GetUnitTypeId(u)<='H06Y' then
      set u = CreateUnit(p,'h06Z',x,y,a*bj_RADTODEG)
      call SetUnitX(u,x)
      call SetUnitY(u,y)
      call SetUnitAnimation(u,"spell")
      call QueueUnitAnimation(u,"spell")
      call SetUnitVertexColor(u,255,255,255,75)
      call SaveUnitHandle(MHT,info,4,u)
    endif
  endif
  call TimerStart(t,0.1,true,function Keeper_Illuminate_Charge)
  set t = null
  set u = null
endfunction

function YLE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real RLD=(LoadReal(HY,h,(242)))
  call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+RLD)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIim\\AIimTarget.mdl",Target,"origin"))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set Target=null
  set t=null
  return false
endfunction

function Kotl_ChakraMagic takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(242),((75*GetUnitAbilityLevel(Hero,'A112'))*1.))
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function YLE))
  set t=null
  set Hero=null
  set Target=null
endfunction

function Y5E takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real a=Atan2(y-FG8,x-FF8)
  set x=SafeX50(x+40*Cos(a))
  set y=SafeY50(y+40*Sin(a))
  call KillTrees(x,y,150)
  call SetUnitX(Target,x)
  call SetUnitY(Target,y)
  set Target=null
endfunction

function Y2E takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local unit Caster=CreateUnit(tt_player1,'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A10W')
  call SetUnitAbilityLevel(Caster,'A10W',FE8)
  call IssueTargetOrderById(Caster,852585,Target)
  set Target=null
  set Caster=null
endfunction

function Z4E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local real SourceX=(LoadReal(HY,h,(189)))
  local real SourceY=(LoadReal(HY,h,(190)))
  local integer CG8=(LoadInteger(HY,h,(59)))
  local group g=(LoadGroupHandle(HY,h,(22)))
  local integer Count=GetTriggerEvalCount(t)
  set FF8=SourceX
  set FG8=SourceY
  call ForGroup(g,function Y5E)
  if Count==10 then
    set FE8=CG8
    set tt_player1=p
    call ForGroup(g,function Y2E)
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set p=null
  set g=null
  return false
endfunction

function Z7E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local real SourceX=(LoadReal(HY,h,(189)))
  local real SourceY=(LoadReal(HY,h,(190)))
  local integer CG8=(LoadInteger(HY,h,(59)))
  local group g=(LoadGroupHandle(HY,h,(22)))
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.04,true)
  call TriggerAddCondition(t,Condition(function Z4E))
  call SavePlayerHandle(HY,h,(54),(p))
  call SaveReal(HY,h,(189),((SourceX)*1.))
  call SaveReal(HY,h,(190),((SourceY)*1.))
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveInteger(HY,h,(59),(CG8))
  set t=null
  set p=null
  set g=null
  return false
endfunction

function Kotl_BlindingLight takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call KillUnit(CreateUnit(GetOwningPlayer(Source),'h06P',x,y,0))
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,700,Condition(function NonImmuneEnemyFilter))
  call TriggerRegisterTimerEvent(t,.4,false)
  call TriggerAddCondition(t,Condition(function Z7E))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(GetTriggerUnit())))
  call SaveReal(HY,h,(189),((x)*1.))
  call SaveReal(HY,h,(190),((y)*1.))
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveInteger(HY,h,(59),GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=null
  set g=null
  set Source=null
endfunction

function FierySoul_Tick takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local integer stacks
  if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
    set u=LoadUnitHandle(HY,h,0)
    call RemoveSavedHandle(HY,GetHandleId(u),'A18X')
    call LoDStat_Sub(u,LoadInteger(HY,h,1),"attack")
    call SubBonusMSPercent(u,LoadInteger(HY,h,2))
    set stacks=LoadInteger(HY,h,0)
    call DestroyEffect(LoadEffectHandle(HY,h,10+1))
    call DestroyEffect(LoadEffectHandle(HY,h,20+1))
    if stacks>=2 then
      call DestroyEffect(LoadEffectHandle(HY,h,10+2))
      call DestroyEffect(LoadEffectHandle(HY,h,20+2))
    endif
    if stacks>=3 then
      call DestroyEffect(LoadEffectHandle(HY,h,10+3))
      call DestroyEffect(LoadEffectHandle(HY,h,20+3))
    endif
    call UnitRemoveAbility(u,'C021')
    call UnitRemoveAbility(u,'D021')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set u=null
  endif
  set t=null
endfunction

function FierySoul_Start takes unit u returns nothing
  local trigger t=LoadTriggerHandle(HY,GetHandleId(u),'A18X')
  local integer h
  local integer stacks
  local integer as
  local integer ms
  if t==null then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.5,true)
    call TriggerAddCondition(t,Condition(function FierySoul_Tick))
    call SaveUnitHandle(HY,h,0,u)
    call UnitAddAbility2(u,'C021')
    call SaveTriggerHandle(HY,GetHandleId(u),'A18X',t)
  else
    set h=GetHandleId(t)
  endif
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+9)
  set stacks=LoadInteger(HY,h,0)
  if stacks<3 then
    call SaveInteger(HY,h,0,stacks+1)
    set as = 20 + 10*(GetUnitAbilityLevel(u,'A18X')+GetUnitAbilityLevel(u,'QP1U'))
    set ms = 4+1*(GetUnitAbilityLevel(u,'A18X')+GetUnitAbilityLevel(u,'QP1U'))
    call LoDStat_Add(u,as,"attack")
    call AddBonusMSPercent(u,ms)
    call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+as)
    call SaveInteger(HY,h,2,LoadInteger(HY,h,2)+ms)
    call SaveEffectHandle(HY,h,10 + stacks+1,AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,"head"))
    call SaveEffectHandle(HY,h,20 + stacks+1,AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,"chest"))
  endif
  
  set t=null
endfunction

function ZIE takes nothing returns boolean
  if (Valid_Spell(GetSpellAbilityId()) and GetSpellAbilityId()!='AItb') or (Mode_BO and BalanceOffSpellChecker(GetSpellAbilityId()))then
    call FierySoul_Start(GetTriggerUnit())
  endif
  return false
endfunction

function Lina_FierySoul_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function ZIE))
  set t=null
endfunction

function Lina_LagunaBlade_OnCast takes nothing returns nothing
  if IsMagicImmune(GetSpellTargetUnit())then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LR'))
  endif
endfunction

function LoDLightStrikeArray_Cast takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call UnitAddAbility(Caster,'A027')
  call SetUnitAbilityLevel(Caster,'A027',GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  if IssuePointOrder(Caster,"dreadlordinferno",x,y)==false then
    call IssuePointOrder(Caster,"inferno",x,y)
  endif
  set Source=null
  set Caster=null
endfunction

function Lina_LagunaBladeUpgAct takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local damagetype dt=DAMAGE_TYPE_MAGIC
  local real dmg=0
  local integer lvl=LoadInteger(HY,h,0)
  if IsMagicImmune(target) then
    set dt=DAMAGE_TYPE_UNIVERSAL
  endif
  if lvl==1 then
    set dmg=450
  elseif lvl==2 then
    set dmg=675
  elseif lvl==3 then
    set dmg=950
  endif
  call DamageTarget2(caster,target,ATTACK_TYPE_HERO,dt,dmg)
  call CleanTimer(t)
  set dt=null
  set caster=null
  set target=null
  set t=null
endfunction

function Lina_LagunaBladeUpg takes nothing returns nothing
  local timer t
  if IsBlocked(GetSpellTargetUnit())==false then
    set t=CreateTimer()
    call TimerStart(t,0.25,false,function Lina_LagunaBladeUpgAct)
    call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
    call SaveUnitHandle(HY,GetHandleId(t),1,GetSpellTargetUnit())
    call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
    set t=null
  endif
endfunction

function Luna_Aura_Targets takes nothing returns nothing
  local integer key
  local integer info
  local unit u = GetFilterUnit()
  
  if IsUnitType(u,UNIT_TYPE_HERO)and IsUnitAlly(u,group_temp_player)and IsDead(u)==false then
    call GroupAddUnit(temp_group2,u)   //adds the unit to group of currently affected units
    
    if IsUnitInGroup(u,group_temp_group)==false then  //hasn't been affected by the aura
      set info = GetHandleId(u)
      set key = StringHash("lunar_count")
      
      call Buff_Add(u,LoDBuff_AbilID[32],LoDBuff_BuffID[32],-1) //adds the buff
      call LoDStat_Add(u,group_temp_integer[1],"damage")  //adds new damage
      
      call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1) //keeps track of the number of times the unit has been affected for correct buff removal
      
      set u = null
      return
    endif
    
    call GroupRemoveUnit(group_temp_group,u) //removes the unit from the group of previously affected units
    
    if LoadBoolean(MHT,99999,99998)then     //checks to see if the amount of bonus damage has changed
      call LoDStat_Add(u,group_temp_integer[1],"damage") //updates damage amount
      call LoDStat_Sub(u,group_temp_integer[0],"damage") //removes old damage
    endif
  endif
  
  set u = null
endfunction

function Luna_Aura_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer key = StringHash("lunar_count")
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  set group_temp_group = LoadGroupHandle(MHT,info,1)
  set group_temp_integer[0] = LoadInteger(MHT,info,0)
  if IsDead(u)then
    set u = FirstOfGroup(group_temp_group)
    if u!=null then //checks to see if any units are still being affected by the aura and removes the bonuses if they are
      loop
        set info = GetHandleId(u)
        call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) - 1)
        if LoadInteger(MHT,info,key)==0then
          call Buff_Remove(u,LoDBuff_BuffID[32])
        endif
        call LoDStat_Sub(u,group_temp_integer[0],"damage")
        call GroupRemoveUnit(group_temp_group,u)
        set u = FirstOfGroup(group_temp_group)
        exitwhen u==null
      endloop
    endif
    set u=null
    set t = null
    return
  endif
  set group_temp_integer[1] = IMaxIF(GetUnitAbilityLevel(u,'A062'),GetUnitAbilityLevel(u,'QP0E'))*8 + 6
  set group_temp_player = GetOwningPlayer(u)
  if group_temp_integer[0]!=group_temp_integer[1] then
    call SaveBoolean(MHT,99999,99998,true)
    call SaveInteger(MHT,info,0,group_temp_integer[1]) //updates the current amount of damage being added
  else
    call SaveBoolean(MHT,99999,99998,false)
  endif
  call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),925,Condition(function Luna_Aura_Targets))
  //removes the bonuses from any unit out of range
  loop
    set u = FirstOfGroup(group_temp_group)
    exitwhen u==null
    set info = GetHandleId(u)
    call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) - 1)
    if LoadInteger(MHT,info,key)==0then
      call Buff_Remove(u,LoDBuff_BuffID[32])
    endif
    call LoDStat_Sub(u,group_temp_integer[0],"damage")
    call GroupRemoveUnit(group_temp_group,u)
  endloop
  //updates the current group with the newly affected units
  loop
    set u = FirstOfGroup(temp_group2)
    exitwhen u==null
    call GroupRemoveUnit(temp_group2,u)
    call GroupAddUnit(group_temp_group,u)
  endloop
  set t = null
endfunction

function Luna_Aura_Learn takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local integer info = GetHandleId(t)
  call SaveBoolean(MHT,99999,99998,true) //has the amount of bonus damage changed, set to true initially (duh)
  set group_temp_group = CreateGroup()
  set group_temp_player = GetOwningPlayer(u)
  set group_temp_integer[0] = 0    //previous bonus damage, set to 0 since its the first time
  set group_temp_integer[1] = IMaxIF(GetUnitAbilityLevel(u,'A062'),GetUnitAbilityLevel(u,'QP0E'))*8 + 6
  call SaveUnitHandle(MHT,info,0,u)
  call SaveGroupHandle(MHT,info,1,group_temp_group)  //previously affected units
  call SaveInteger(MHT,info,0,group_temp_integer[1]) //the current amount of damage being added
  call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),925,Condition(function Luna_Aura_Targets))
  //adds all the affected unit to the currrent group
  loop
    set u = FirstOfGroup(temp_group2)
    exitwhen u==null
    call GroupRemoveUnit(temp_group2,u)
    call GroupAddUnit(group_temp_group,u)
  endloop
  call SetPlayerTechResearched(group_temp_player,'R00I',1)
  call TimerStart(t,0.25,true,function Luna_Aura_Duration)
  set u=null
  set t = null
endfunction

function MoonGlaiveFilter takes nothing returns boolean
  local unit Picked=GetFilterUnit()
  local real Distance=DistanceBetweenUnits(Picked,LoDMoonGlaive_Origin)
  if Picked!=LoDMoonGlaive_Origin and IsUnitEnemy(Picked,GetOwningPlayer(LoDMoonGlaive_Source)) and IsDead(Picked)==false and C58(Picked)==false and Distance < LoDMoonGlaive_MaxDistance and (GetUnitAbilityLevel(Picked,'A04R')==0 or IsSiegeUnit(Picked)) and GetUnitAbilityLevel(Picked,'Avul')==0 and IsUnitVisibleLoD(Picked,GetOwningPlayer(LoDMoonGlaive_Source)) and IsUnitInRangeXY(Picked,GetUnitX(LoDMoonGlaive_Origin),GetUnitY(LoDMoonGlaive_Origin),500)  then
    set LoDMoonGlaive_MaxDistance=Distance
    set LoDMoonGlaive_Target=Picked
  endif
  set Picked=null
  return false
endfunction

function MoonGlaiveHit takes nothing returns nothing
  local group g
  local integer hu
  local trigger t
  local integer ht
  local unit d=LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),45)
  local integer count=LoadInteger(HY,GetHandleId(d),0)-1
  local unit attacker=LoadUnitHandle(HY,GetHandleId(d),0)
  local unit target=tt_unit2
  local real dmg=LoadReal(HY,GetHandleId(d),0)
  call FlushChildHashtable(HY,GetHandleId(d))
  call DamageTarget(attacker,target,2,dmg)
  if count>0 then
    set LoDMoonGlaive_Origin=target
    set LoDMoonGlaive_Source=attacker
    set LoDMoonGlaive_MaxDistance=9999
    set LoDMoonGlaive_Target=null
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),700,Condition(function MoonGlaiveFilter))
    call KillGroup(g)
    set g=null
    if LoDMoonGlaive_Target!=null then
      set t=AddProjectile(target,LoDMoonGlaive_Target,'h999',"MoonGlaiveHit",880,true)
      set ht=GetHandleId(t)
      set hu=GetHandleId(LoadUnitHandle(HY,ht,45))
      call SaveInteger(HY,hu,0,count)//store lvl in dummy
      call SaveReal(HY,hu,0,dmg*0.65)
      call SaveUnitHandle(HY,hu,0,attacker)
      set t=null
    endif
  endif
  set g=null
  set attacker=null
  set target=null
  set d=null
endfunction

function MoonGlaive takes unit attacker, unit target returns nothing
  local group g=GetAvailableGroup()
  local integer lvl=GetUnitAbilityLevel(attacker,'P098')
  local integer hu
  local trigger t
  local integer ht
  local integer count
  //call echo(I2S(lvl))
  set LoDMoonGlaive_Origin=target
  set LoDMoonGlaive_Source=attacker
  set LoDMoonGlaive_MaxDistance=9999
  set LoDMoonGlaive_Target=null
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),700,Condition(function MoonGlaiveFilter))
  call KillGroup(g)
  set g=null
  call UnitRemoveAbility(target,'B999')
  if LoDMoonGlaive_Target!=null then
    set count=lvl
    if lvl==4 then
      set count=5
    endif
    set t=AddProjectile(target,LoDMoonGlaive_Target,'h999',"MoonGlaiveHit",880,true)
    set ht=GetHandleId(t)
    set hu=GetHandleId(LoadUnitHandle(HY,ht,45))
    call SaveInteger(HY,hu,0,count)//store lvl in dummy
    if IsUnitIllusion(attacker)then
      set GetUnitPhysicalResistance_Result=1
    else
      call GetUnitPhysicalResistance(target)
    endif
    call SaveReal(HY,hu,0,GetEventDamage()/GetUnitPhysicalResistance_Result*0.65)
    call SaveUnitHandle(HY,hu,0,attacker)
    set t=null
  endif
endfunction

function DarknessStop takes nothing returns nothing
  call SaveBoolean(MHT,'DARK',0,false)
  call SuspendTimeOfDay(false) 
  call SetFloatGameState(GAME_STATE_TIME_OF_DAY,LoadReal(MHT,'DARK',1))
endfunction

function ImitateDarkness takes real dur returns nothing
  local real curTime=TimerGetElapsed(GlobalTimer)
  local real darknessEnd=LoadReal(MHT,'DARK',0)
  local real curtime
  local real mindur=dur*1. / 60.
  local real finaltime
  if curTime+dur>darknessEnd then
    call TimerStart(DarknessTimer,dur,false,function DarknessStop)
    //call SaveReal(MHT,'DARK',0,curTime+dur)
    call SuspendTimeOfDay(true)
    if LoadBoolean(MHT,'DARK',0)==false then//if false there are no other darkness so time is real, not 00:00. when true it always 00:00
      set curtime=GetFloatGameState(GAME_STATE_TIME_OF_DAY)
      set finaltime=curtime+mindur
      if finaltime > 24 then
        set finaltime=finaltime-24.
      endif
      call SaveReal(MHT,'DARK',1,finaltime)
    endif
    call SetFloatGameState(GAME_STATE_TIME_OF_DAY,0)
    call SaveBoolean(MHT,'DARK',0,true)
  endif
  
endfunction

function ZOE takes nothing returns boolean
  if(GetUnitTypeId((GetFilterUnit()))=='u009')or(IsMagicImmune(GetFilterUnit())==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
    if(LoadInteger(HY,(FH8),(GetHandleId(GetFilterUnit()))))<tt_int1 then
      return true
    endif
  endif
  return false
endfunction

function ZPE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer ZQE=(LoadInteger(HY,h,(217)))
  local integer XCE=(LoadInteger(HY,h,(216)))
  local integer ZRE=(LoadInteger(HY,h,(218)))
  local group g=GetAvailableGroup()
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local unit Target
  local real r1=GetRandomInt(200,350)
  local real r2=GetRandomInt(200,350)
  if GetRandomInt(1,2)==1 then
    set r1=-1*r1
    set r2=-1*r2
  endif
  set tt_unit1=Hero
  set tt_int1=ZRE
  set FH8=GetHandleId(t)
  call GroupEnumUnitsInRange(g,x,y,700,Condition(function ZOE))
  set Target=GroupPickRandomUnit(g)
  call KillGroup(g)
  if IsDead(Hero)==false and Target!=null and(GetUnitTypeId((Target))=='u009')==false then
    call SaveInteger(HY,(FH8),(GetHandleId(Target)),((LoadInteger(HY,(FH8),(GetHandleId(Target))))+1))
    call Z48("effects\\Eclipse.mdx",Target,"origin",3)
    call DamageTarget(Hero,Target,1,ZQE*75)
  elseif IsDead(Hero)==false then
    set x=x+GetRandomInt(-350,350)
    set y=y+GetRandomInt(-350,350)
    call ZD8("effects\\Eclipse.mdx",x,y,1.5)
  endif
  if(GetTriggerEvalCount(t)+1)==XCE or IsDead(Hero) then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set g=null
  set Target=null
  return false
endfunction

function Luna_Eclipse takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer XCE
  local integer ZQE=4
  local integer ZRE
  if GetSpellAbilityId()=='A054' then
    set XCE=2+3*GetUnitAbilityLevel(Hero,'A054')
    set ZRE=3+GetUnitAbilityLevel(Hero,'A054')
  else
    set XCE=2+4*GetUnitAbilityLevel(Hero,'A00U')
    set ZRE=XCE
  endif
  call SaveInteger(HY,h,(217),(ZQE))
  call SaveInteger(HY,h,(216),(XCE))
  call SaveInteger(HY,h,(218),(ZRE))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call TriggerRegisterTimerEvent(t,.6,true)
  call TriggerAddCondition(t,Condition(function ZPE))
  call TriggerEvaluate(t)
  call ImitateDarkness(10.0)
  set t=null
  set Hero=null
endfunction

function ZUE takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",GetEnumUnit(),"origin"))
endfunction

function ZVE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local unit Target=LoadUnitHandle(HY,h,30)
  call DamageTarget(Hero,Target,1,LoadInteger(HY,h,0)*56.25)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  set Target=null
  return false
endfunction

function ZWE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local group g=GetAvailableGroup()
  local unit Target=LoadUnitHandle(HY,h,30)
  local integer lvl=LoadInteger(HY,h,0)
  if IsDead(Target) then
    set FJ8=Hero
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),200,Condition(function LT8))
    set Target=GroupPickRandomUnit(g)
    call KillGroup(g)
    set g=null
  endif
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",Target,"origin"))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,30,Target)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,.5,false)
  call TriggerAddCondition(t,Condition(function ZVE))
  set t=null
  set Hero=null
  set Target=null
  return false
endfunction

function ZXE takes nothing returns nothing
  call DamageTarget(FJ8,GetEnumUnit(),1,FI8)
endfunction

function ZYE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local group g=LoadGroupHandle(HY,h,22)
  set FI8=LoadInteger(HY,h,0)*75
  set FJ8=Hero
  call ForGroup(g,function ZXE)
  call KillGroup(g)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  set g=null
  return false
endfunction

function ZZE takes nothing returns nothing
  if DistanceBetweenUnits(GetTriggerUnit(),GetEnumUnit())<=650 then
    call GroupAddUnit(DK,GetEnumUnit())
  endif
endfunction

function Potm_Starfall takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local unit Target
  set tt_unit1=caster
  set FJ8=caster
  set DK=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),900,Condition(function LT8))
  call ForGroup(g,function ZZE)
  call KillGroup(g)
  set g=DK
  call ForGroup(g,function ZUE)
  call SaveGroupHandle(HY,h,22,g)
  call SaveUnitHandle(HY,h,14,caster)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
  call TriggerRegisterTimerEvent(t,.5,false)
  call TriggerAddCondition(t,Condition(function ZYE))
  set FJ8=caster
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),200,Condition(function LT8))
  set Target=GroupPickRandomUnit(g)
  call KillGroup(g)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,14,caster)
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl",caster,"origin"))
  call TriggerRegisterTimerEvent(t,1,false)
  call TriggerAddCondition(t,Condition(function ZWE))
  set t=null
  set g=null
  set caster=null
  set Target=null
endfunction

function Z3E takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())))!=null
endfunction

function Z6E takes nothing returns nothing
  call UnitAddAbility2(GetEnumUnit(),'A0KT')
  call SetUnitAbilityLevel(GetEnumUnit(),'A0KT',TmpInt377)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Invisibility\\InvisibilityTarget.mdl",GetEnumUnit(),"chest"))
endfunction

function RemoveInvinsIfFailed takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A0KT')
  if(GetUnitAbilityLevel(u,'A0KT')==0) then
    call FlushChildHashtable(HY,GetHandleId(t))
    call DestroyTimer(t)
  endif
  set t=null
  set u=null
endfunction

function ZLE takes nothing returns nothing
  local timer t
  local integer h
  call UnitRemoveAbility(GetEnumUnit(),'A0KT')
  if GetUnitAbilityLevel(GetEnumUnit(),'A0KT')>0 then
    set t=CreateTimer()
    call TimerStart(t,0.5,true,function RemoveInvinsIfFailed)
    call SaveUnitHandle(HY,GetHandleId(t),0,GetEnumUnit())
    set t=null
  endif
endfunction

function Z1E takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group g=LoadGroupHandle(HY,h,220)
  call ForGroup(g,function ZLE)
  call KillGroup(g)
  call CleanTimer(t)
  set t=null
  set g=null
endfunction

function Potm_MoonlightShadows takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Hero,'A0KU')
  local real DP9=15
  set TmpInt377=Level
  call GroupEnumUnitsInRange(g,0,0,12000,Condition(function Z3E))
  call ForGroup(g,function Z6E)
  call SaveGroupHandle(HY,h,220,g)
  call TimerStart(t,DP9,false,function Z1E)
  set Hero=null
  set g=null
  set t=null
endfunction

function Z2E takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(TmpUnit376)))!=null
endfunction

function A4E takes nothing returns nothing
  local unit Hero=GetEnumUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01R',0,0,0)
  call UnitAddAbility2(Caster,'A0LO')
  call SetUnitAbilityLevel(Caster,'A0LO',Potm_Leap_lvl)
  call UnitApplyTimedLife(Caster,'BTLF',10)
  set Hero=null
  set Caster=null
endfunction

function A7E takes unit Hero, integer lvl returns nothing
  local group g=GetAvailableGroup()
  set TmpUnit376=Hero
  set Potm_Leap_lvl=lvl
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),800,Condition(function Z2E))
  call ForGroup(g,function A4E)
  call KillGroup(g)
  set g=null
endfunction

function A8E takes unit Hero returns nothing
  local integer h=GetHandleId(Hero)
  local string A9E=LoadStr(HY,h,206)
  local string ADE=OrderId2String(LoadInteger(HY,h,211))
  local real TargetX
  local real TargetY
  local unit Target
  local trigger t=LoadTriggerHandle(HY,h,204)
  local boolean AEE=not(LoadBoolean(HY,h,207))
  local boolean AFE=LoadBoolean(HY,h,208)
  call DisableTrigger(t)
  call IssueImmediateOrderById(Hero,851972)
  if A9E=="Target"and(AEE or AFE)then
    set Target=LoadUnitHandle(HY,h,215)
    call IssueTargetOrder(Hero,ADE,Target)
  elseif A9E=="Point"and(AEE or AFE)then
    set TargetX=LoadReal(HY,h,209)
    set TargetY=LoadReal(HY,h,210)
    call IssuePointOrder(Hero,ADE,TargetX,TargetY)
  elseif(AEE or AFE)then
    call IssueImmediateOrder(Hero,"OrderString")
  endif
  call SaveBoolean(HY,h,208,false)
  call EnableTrigger(t)
  set Target=null
  set t=null
endfunction

function AGE takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real AHE=LoadReal(HY,h,212)
  local real AIE=LoadReal(HY,h,213)
  local real a=LoadReal(HY,h,13)
  local real AO8=GetUnitX(Hero)+30*Cos(a*bj_DEGTORAD)
  local real AP8=GetUnitY(Hero)+30*Sin(a*bj_DEGTORAD)
  local real AJE=200
  local real AKE=(1-AHE/ AIE)*AJE*2
  if AKE>AJE then
    set AKE=AJE*2-AKE
  endif
  if IsBuggyFlying(Hero)==false then
    call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero)+RMaxIF(AKE,0),0)
  endif
  if IsUnitType(Hero,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
  endif
  call SetUnitX(Hero,SafeX50(AO8))
  call SetUnitY(Hero,SafeY50(AP8))
  call SetUnitFacing(Hero,a)
  call SaveReal(HY,h,212,(AHE-20)*1.)
  if AKE<1 and AHE-AIE!=0 then
    call SaveBoolean(HY,GetHandleId(Hero),214,false)
    call SetUnitFacing(Hero,a)
    call SetUnitAnimation(Hero,"stand")
    call SetUnitPathing(Hero,true)
    call A8E(Hero)
    if IsBuggyFlying(Hero)==false then
      call SetUnitFlyHeight(Hero,GetUnitDefaultFlyHeight(Hero),0)
    endif
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call DestroyTimer(t)
  endif
  set t=null
  set Hero=null
endfunction

function Potm_Leap takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,('A0LN'))
  local real YR8=350+50*Level
  local real a=GetUnitFacing(Hero)
  local real SourceX=GetUnitX(Hero)
  local real SourceY=GetUnitY(Hero)
  local real TargetX=SafeX50(SourceX+YR8*Cos(a*bj_DEGTORAD))
  local real TargetY=SafeY50(SourceY+YR8*Sin(a*bj_DEGTORAD))
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local trigger ANE=LoadTriggerHandle(HY,GetHandleId(Hero),204)
  set YR8=SquareRoot((SourceX-TargetX)*(SourceX-TargetX)+(SourceY-TargetY)*(SourceY-TargetY))
  call ShowUnit(Hero,false)
  call ShowUnit(Hero,true)
  if GetLocalPlayer()==GetOwningPlayer(Hero) then
    call ClearSelection()
    call SelectUnit(Hero,true)
  endif
  if YR8>100 then
    call UnitAddAbility2(Hero,'Amrf')
    call UnitRemoveAbility(Hero,'Amrf')
    call SetUnitPathing(Hero,false)
    call DisableTrigger(ANE)
    call IssueImmediateOrderById(Hero,851972)
    call EnableTrigger(ANE)
    call SaveReal(HY,h,212,YR8*1.)
    call SaveReal(HY,h,213,YR8*1.)
    call SaveReal(HY,h,13,a*1.)
    call SaveUnitHandle(HY,h,14,Hero)
    call TimerStart(t,.025,true,function AGE)
    call SaveBoolean(HY,GetHandleId(Hero),214,true)
    call SaveBoolean(HY,GetHandleId(Hero),208,false)
    call A7E(Hero,Level)
  endif
  set Hero=null
  set t=null
  set ANE=null
endfunction

function AVE takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0)!=null
endfunction

function Potm_GetStunDur takes integer stunlvl returns real
  if stunlvl<=1 then
    return 0.01
  elseif stunlvl==2 then
    return 0.6
  elseif stunlvl==3 then
    return 1.1
  elseif stunlvl==4 then
    return 1.7
  elseif stunlvl==5 then
    return 2.2
  elseif stunlvl==6 then
    return 2.8
  elseif stunlvl==7 then
    return 3.3
  elseif stunlvl==8 then
    return 3.9
  elseif stunlvl==9 then
    return 4.4
  else
    return 5.0
  endif
  return 0
endfunction

function DisplayArrowStunTime takes unit u,unit target, integer stun returns nothing
  local texttag tt=CreateTextTag()
  local string s=""
  if GetHandleId(tt)<1 then
    call DestroyTextTag(tt)
  else
    set s=R2SW(Potm_GetStunDur(stun),1,1)
    call SetTextTagText(tt,s,.03)
    call SetTextTagPosUnit(tt,target,0)
    call SetTextTagColorBJ(tt,150,75,255,15)
    call SetTextTagVelocity(tt,0,.035)
    call SetTextTagFadepoint(tt,3)
    call SetTextTagLifespan(tt,RMinIF(1.0,stun/2))
    call SetTextTagPermanent(tt,false)
    call SetTextTagVisibility(tt,IsUnitAlly(u,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
  endif
  set tt=null
endfunction

function AXE takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,14)
  local unit arrow=LoadUnitHandle(HY,h,45)
  local real endX=LoadReal(HY,h,47)
  local real endY=LoadReal(HY,h,48)
  local real angle=LoadReal(HY,h,13)
  local real arrowX=GetUnitX(arrow)
  local real arrowY=GetUnitY(arrow)
  local real nx=SafeX50(GetUnitX(arrow)+30*Cos(angle))
  local real ny=SafeY50(GetUnitY(arrow)+30*Sin(angle))
  local group g=GetAvailableGroup()
  local unit dummy
  local unit Target
  local integer stunlvl=0
  local integer stunid=0
  local integer stlvl=0
  local player p=GetOwningPlayer(caster)
  call SetUnitX(arrow,nx)
  call SetUnitY(arrow,ny)
  set TmpUnit376=caster
  call GroupEnumUnitsInRange(g,nx,ny,140,Condition(function AVE))
  set Target=FirstOfGroup(g)
  call KillGroup(g)
  if Target!=null then
    if IsUnitType(Target,UNIT_TYPE_HERO) then
      call SaveInteger(HeroStats,GetHandleId(p),'ARRH',LoadInteger(HeroStats,GetHandleId(p),'ARRH')+1)
      call Traffic_RegisterData("AA_Hits"+I2S(GetPlayerId(GetOwningPlayer(caster))),LoadInteger(HeroStats,GetHandleId(p),'ARRH'))
    endif
    set dummy=CreateUnit(GetOwningPlayer(Target),'e00E',arrowX,arrowY,0)
    set stunlvl=IMinIF(R2I(DistanceBetweenXY(LoadReal(HY,h,191),LoadReal(HY,h,192),arrowX,arrowY)/150),10)
    if stunlvl<=1 then//0.01
      set stunid='A40Y'
      set stlvl=1
    elseif stunlvl<4 then
      set stunid='A407'
      set stlvl=stunlvl-1
    elseif stunlvl<7 then
      set stunid='A408'
      set stlvl=stunlvl-3
    else
      set stunid='A409'
      set stlvl=stunlvl-6
    endif
    call StunTargetLod(Target,Potm_GetStunDur(stunlvl))
    call DamageTarget(caster,Target,1,90*LoadInteger(HY,h,0)-40+stunlvl*14)
    call DisplayArrowStunTime(caster,Target,stunlvl)
    call KillUnit(arrow)
    call CleanTimer(t)
  elseif(nx-endX)*(nx-endX)+(ny-endY)*(ny-endY)<1600 then
    call KillUnit(arrow)
    call CleanTimer(t)
  endif
  set t=null
  set caster=null
  set arrow=null
  set g=null
  set dummy=null
  set Target=null
endfunction

function PotM_EluneArrow_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local real SourceX=SafeX50(GetUnitX(caster))
  local real SourceY=SafeY50(GetUnitY(caster))
  local real endX=GetSpellTargetX()
  local real endY=GetSpellTargetY()
  local real angle=Atan2(endY-SourceY,endX-SourceX)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local player p=GetOwningPlayer(caster)
  local unit arrow=CreateUnit(p,'h005',SourceX,SourceY,angle*bj_RADTODEG)
  call SaveInteger(HeroStats,GetHandleId(p),'ARRS',LoadInteger(HeroStats,GetHandleId(p),'ARRS')+1)
  call Traffic_RegisterData("AA_Total"+I2S(GetPlayerId(p)),LoadInteger(HeroStats,GetHandleId(p),'ARRS'))
  call SetUnitFacing(arrow,angle*bj_RADTODEG)
  set endX=SafeX50(SourceX+3000*Cos(angle))
  set endY=SafeY50(SourceY+3000*Sin(angle))
  call SaveReal(HY,h,191,SourceX*1.)
  call SaveReal(HY,h,192,SourceY*1.)
  call SaveReal(HY,h,47,endX*1.)
  call SaveReal(HY,h,48,endY*1.)
  call SaveReal(HY,h,13,angle*1.)
  call SaveUnitHandle(HY,h,14,caster)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,'A0L8'))
  call SaveUnitHandle(HY,h,45,arrow)
  call TimerStart(t,.035,true,function AXE)
  set caster=null
  set t=null
  set arrow=null
endfunction

function ACE takes nothing returns boolean
  local unit A3E=GetFilterUnit()
  if IsUnitInGroup(A3E,TempGroup2)then
    set A3E=null
    return false
  endif
  if IsUnitEnemy(A3E,GetOwningPlayer(TmpUnit376))and GetUnitAbilityLevel(A3E,'A04R')!=1 and GetWidgetLife(A3E)>0 and IsUnitType(A3E,UNIT_TYPE_STRUCTURE)==false then
    set A3E=null
    return true
  endif
  set A3E=null
  return false
endfunction

function A6E takes nothing returns nothing
  call DamageTarget(TmpUnit376,GetEnumUnit(),1,TmpReal378)
endfunction

function ALE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit u=(LoadUnitHandle(HY,h,(221)))
  local real a=(LoadReal(HY,h,(13)))
  local integer Y59=(LoadInteger(HY,h,(194)))
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local real NHE=GetUnitX(u)
  local real NIE=GetUnitY(u)
  local real LastX=(LoadReal(HY,h,(23)))
  local real LastY=(LoadReal(HY,h,(24)))
  local real AO8=LastX+1000*.05*Cos(a)
  local real AP8=LastY+1000*.05*Sin(a)
  local group g=GetAvailableGroup()
  call SaveReal(HY,h,(23),((AO8)*1.))
  call SaveReal(HY,h,(24),((AP8)*1.))
  set TmpUnit376=u
  set TmpReal378=LoadInteger(HY,h,0)*75+25
  set TempGroup2=HND
  call GroupEnumUnitsInRange(g,NHE,NIE,225,Condition(function ACE))
  call ForGroup(g,function A6E)
  call GroupAddGroup(g,HND)
  call KillGroup(g)
  set Y59=Y59-1
  call SaveInteger(HY,h,(194),(Y59))
  if IsUnitType(u,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(u),99,true)
  endif
  call SetUnitX(u,SafeX50(AO8))
  call SetUnitY(u,SafeY50(AP8))
  call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",NHE,NIE))
  if Y59==0 then
    call SetTint(u,-1,-1,-1,255)
    call SaveBoolean(HY,(GetHandleId(u)),(225),(false))
    call SetUnitInvulnerable(u,false)
    call SetUnitPathing(u,true)
    call KillGroup(HND)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set u=null
  set Caster=null
  set HND=null
  set g=null
  set t=null
  return false
endfunction

function Morphling_Waveform takes nothing returns nothing
  local unit XX8=GetTriggerUnit()
  local player p = GetOwningPlayer(XX8)
  local real SourceX=GetUnitX(XX8)
  local real SourceY=GetUnitY(XX8)
  local real TargetX=GetSpellTargetX()
  local real TargetY=GetSpellTargetY()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group HND=GetAvailableGroup()
  local unit Caster=CreateUnit(p,'e00E',0,0,0)
  local integer PlayerId=GetPlayerId(p)
  call UnitAddAbility(Caster,'A2N4')
  if GetSpellTargetUnit()!=null then
    set TargetX=GetUnitX(GetSpellTargetUnit())
    set TargetY=GetUnitY(GetSpellTargetUnit())
  endif
  call SetTint(XX8,-1,-1,-1,0)
  call SaveBoolean(HY,(GetHandleId(XX8)),(225),(true))
  call SetUnitInvulnerable(XX8,true)
  call SetUnitPathing(XX8,false)
  call SetUnitPathing(Caster,false)
  call SaveUnitHandle(HY,h,(221),(XX8))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveReal(HY,h,(23),((SourceX)*1.))
  call SaveReal(HY,h,(24),((SourceY)*1.))
  call SaveGroupHandle(HY,h,(133),(HND))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(XX8,GetSpellAbilityId()))
  call SaveInteger(HY,h,1,GetSpellAbilityId())
  call SaveReal(HY,h,(13),((Atan2(TargetY-SourceY,TargetX-SourceX))*1.))
  call SaveInteger(HY,h,(194),(IMaxIF(R2I(SquareRoot((TargetX-SourceX)*(TargetX-SourceX)+(TargetY-SourceY)*(TargetY-SourceY))/ 50),1)))
  call TriggerRegisterTimerEvent(t,.04,true)
  call TriggerAddCondition(t,Condition(function ALE))
  call ShowUnit(XX8,false)
  call ShowUnit(XX8,true)
  call SelectUnitAddForPlayer(XX8,GetOwningPlayer(XX8))
  set Caster = null
  set XX8 = null
  set HND = null
  set t=null
endfunction

function A0E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Count=(LoadInteger(HY,h,(34)))-1
  local texttag tt
  call SaveInteger(HY,h,(34),(Count))
  if GetTriggerEvalCount(t)==1 then
    call RemoveSavedHandle(HY,h,'0ILU')
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt=CreateTextTag()
    call SetTextTagText(tt,I2S(Count),.03)
    call SetTextTagPosUnit(tt,Source,0)
    call SetTextTagColorBJ(tt,0,29,255,15)
    call SetTextTagVelocity(tt,0,.035)
    call SetTextTagFadepoint(tt,3)
    call SetTextTagLifespan(tt,.9)
    call SetTextTagPermanent(tt,false)
    call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
    set tt=CreateTextTag()
    call SetTextTagText(tt,I2S(Count),.03)
    call SetTextTagPosUnit(tt,Target,0)
    call SetTextTagColorBJ(tt,0,29,255,15)
    call SetTextTagVelocity(tt,0,.035)
    call SetTextTagFadepoint(tt,3)
    call SetTextTagLifespan(tt,.9)
    call SetTextTagPermanent(tt,false)
    call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
  endif
  set t=null
  set tt=null
  set Source=null
  set Target=null
  return false
endfunction

function A5E takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local unit Hero=(LoadUnitHandle(HY,(GetHandleId(t)),(14)))
  local unit A2E=(LoadUnitHandle(HY,(GetHandleId(Hero)),(229)))
  call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(A2E),GetUnitY(A2E)))
  call RemoveUnit(A2E)
  call UnitRemoveAbility(Hero,('A0GC'))
  if(LoadInteger(HY,(GetHandleId(Hero)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Hero)),(704)))==('A0G8')then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),('A0G8'),true)
  endif
  call FlushChildHashtable(HY,(GetHandleId(t)))
  call CleanTrigger((t))
  set Hero=null
  set A2E=null
  set t=null
endfunction

function DelayedReplicateReplaceB takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit hero=LoadUnitHandle(HY,h,0)
  local unit copy=LoadUnitHandle(HY,h,1)
  local real x=GetUnitX(copy)
  local real y=GetUnitY(copy)
  if IsDead(hero)==false and IsDead(copy)==false then
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",x,y))
    call SetUnitPosition(copy,GetUnitX(hero),GetUnitY(hero))
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",GetUnitX(hero),GetUnitY(hero)))
    call SetUnitPosition(hero,x,y)
    call PanCameraToTimedForPlayer(GetOwningPlayer(hero),x,y,0)
  endif
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set hero=null
  set copy=null
  set t=null
endfunction

function DelayedReplicateReplace takes unit hero, unit copy returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0,false,function DelayedReplicateReplaceB)
  call SaveUnitHandle(HY,h,0,hero)
  call SaveUnitHandle(HY,h,1,copy)
  set t=null
endfunction

function Morphling_ReplicateReplace takes nothing returns nothing
  call DelayedReplicateReplace(GetTriggerUnit(),LoadUnitHandle(HY,GetHandleId(GetTriggerUnit()),229))
endfunction

function B8E takes nothing returns boolean
  return GetUnitAbilityLevel(GetSummonedUnit(),('B030'))>0 and GetWidgetLife(GetSummonedUnit())>0
endfunction

function B9E takes nothing returns nothing
  local unit Hero=GetSummoningUnit()
  local integer h=GetHandleId(Hero)
  local unit Target=LoadUnitHandle(HY,h,228)
  local unit A2E=GetSummonedUnit()
  local trigger t
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A0G8',false)
  call UnitAddAbility2(Hero,'A0GC')
  call SetUnitColor(A2E,GetPlayerColor(GetOwningPlayer(Target)))
  call SaveUnitHandle(HY,h,229,A2E)
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,A2E,EVENT_UNIT_DEATH)
  call TriggerAddAction(t,function A5E)
  call SaveUnitHandle(HY,GetHandleId(t),14,Hero)
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,A2E,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function A0E))
  call SaveUnitHandle(HY,GetHandleId(t),2,Hero)
  call SaveUnitHandle(HY,GetHandleId(t),17,A2E)
  call SaveInteger(HY,GetHandleId(t),34,GetUnitAbilityLevel(Hero,'A0G8')*15+15-1)
  set Hero=null
  set Target=null
  set A2E=null
  set t=null
endfunction

function Morphling_Replicate takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  call SaveUnitHandle(HY,(GetHandleId(Hero)),(228),(Target))
  if IsUnitIllusion(Target) then
    call SaveUnitHandle(HY,GetHandleId(Hero),'0ILU',LoadUnitHandle(HY,GetHandleId(Target),'0ILU')) //Replicate source info (illu)
  else
    call SaveUnitHandle(HY,GetHandleId(Hero),'0ILU',Target) //Replicate source info (real)
  endif
  set Hero=null
  set Target=null
endfunction

function MH9 takes nothing returns nothing
  local trigger t
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function B8E))
  call TriggerAddAction(t,function B9E)
  set t=null
endfunction

function BGE takes unit Hero,integer BHE,real rate returns nothing
  local integer BJE=GetHeroAgi(Hero,false)
  local integer BKE=GetHeroStr(Hero,false)
  local real IVD=GetUnitState(Hero,UNIT_STATE_MANA)
  if BHE==0 then
    if IVD>=rate and BJE-LoadInteger(HeroStats,GetHandleId(Hero),31)>2 and IsDead(Hero)==false and BJE>MORPH_MIN_STATS then
      call SetUnitState(Hero,UNIT_STATE_MANA,IVD-rate)
      call SetHeroAgi(Hero,BJE-2,true)
      call SetHeroStr(Hero,BKE+2,true)
    endif
  elseif BHE==1 then
    if IVD>=rate and BKE-LoadInteger(HeroStats,GetHandleId(Hero),30)-LoadInteger(HeroStats,GetHandleId(Hero),'ARML')>4 and IsDead(Hero)==false and BKE>MORPH_MIN_STATS then
      call SetUnitState(Hero,UNIT_STATE_MANA,IVD-rate)
      call SetHeroAgi(Hero,BJE+2,true)
      call SetHeroStr(Hero,BKE-2,true)
    endif
  endif
endfunction

function BME takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=GetUnitAbilityLevel(Hero,'A0KX')
  call BGE(Hero,1,30./ Level)
  set t=null
  set Hero=null
  return false
endfunction

function BNE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=GetUnitAbilityLevel(Hero,'A0KX')
  call BGE(Hero,0,30./ Level)
  set t=null
  set Hero=null
  return false
endfunction

function BOE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  local trigger morphto=(LoadTriggerHandle(HY,h,(226)))
  local integer lvl=GetUnitAbilityLevel(u,'A0KX')
  local integer lastorder=(LoadInteger(HY,h,(227)))
  local real rate=1./lvl
  if rate==.25 then
    set rate=.2
  endif
  if GetIssuedOrderId()==852549 then
    if morphto!=null then
      call FlushChildHashtable(HY,(GetHandleId(morphto)))
      call CleanTrigger(morphto)
    endif
    set morphto=CreateTrigger()
    call TriggerRegisterTimerEvent(morphto,rate,true)
    call TriggerAddCondition(morphto,Condition(function BME))
    call SaveUnitHandle(HY,(GetHandleId(morphto)),(14),(u))
    call SaveTriggerHandle(HY,h,(226),(morphto))
    call SaveInteger(HY,h,(227),(GetIssuedOrderId()))
    call UnitAddAbility(u,'A22L')
    call UnitRemoveAbility(u,'A22T')
  elseif GetIssuedOrderId()==852546 then
    if morphto!=null then
      call FlushChildHashtable(HY,(GetHandleId(morphto)))
      call CleanTrigger(morphto)
    endif
    set morphto=CreateTrigger()
    call TriggerRegisterTimerEvent(morphto,rate,true)
    call TriggerAddCondition(morphto,Condition(function BNE))
    call SaveUnitHandle(HY,(GetHandleId(morphto)),(14),(u))
    call SaveTriggerHandle(HY,h,(226),(morphto))
    call SaveInteger(HY,h,(227),(GetIssuedOrderId()))
    call UnitAddAbility(u,'A22T')
    call UnitRemoveAbility(u,'A22L')
  elseif GetIssuedOrderId()==852550 then
    if morphto!=null then
      call FlushChildHashtable(HY,(GetHandleId(morphto)))
      call CleanTrigger(morphto)
    endif
    call SaveTriggerHandle(HY,h,(226),(null))
    call SaveInteger(HY,h,(227),(GetIssuedOrderId()))
    call UnitRemoveAbility(u,'A22L')
    call UnitRemoveAbility(u,'A22T')
  elseif GetIssuedOrderId()==852547 then
    if morphto!=null then
      call FlushChildHashtable(HY,(GetHandleId(morphto)))
      call CleanTrigger(morphto)
    endif
    call SaveTriggerHandle(HY,h,(226),(null))
    call SaveInteger(HY,h,(227),(GetIssuedOrderId()))
    call UnitRemoveAbility(u,'A22L')
    call UnitRemoveAbility(u,'A22T')
  elseif GetIssuedOrderId()==852548 then
    //		if lastorder!=852549 then
    //			call Func2190(u,1,30*rate)
    //		endif
    //call InterruptUnit(u)
    if IssueImmediateOrderById(u,852549)==false then
      call IssueImmediateOrderById(u,852550)
    endif
  elseif GetIssuedOrderId()==852545 then
    //		if lastorder!=852546 then
    //			call Func2190(u,0,30*rate)
    //		endif
    //call InterruptUnit(u)
    if IssueImmediateOrderById(u,852546)==false then
      call IssueImmediateOrderById(u,852547)
    endif
  endif
  set t=null
  set u=null
  set morphto=null
  return false
endfunction

function Morphling_Morph_Learn takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(Hero,'A0KX')
  if Level==1 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call UnitAddAbility2(Hero,'A0KW')
    call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
    call TriggerAddCondition(t,Condition(function BOE))
    call SaveTriggerHandle(HY,h,(226),(null))
    set t=null
  else
    call SetUnitAbilityLevel(Hero,'A0KW',Level)
  endif
  set Hero=null
  set t=null
endfunction

function BTE takes nothing returns nothing
  local unit XX8=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(326)))
  local real r
  local real g
  local real b
  local integer BUE
  local integer BVE
  local real BWE
  local real BXE
  if GetUnitTypeId(XX8)!='O00P' then
    call DisableTrigger(GetTriggeringTrigger())
  elseif IsDead(XX8)==false and(LoadBoolean(HY,(GetHandleId(XX8)),(225)))==false then
    set BUE=GetHeroAgi(XX8,true)
    set BVE=GetHeroStr(XX8,true)
    set BWE=RMaxBJ(75+2*(BUE-BVE),35)
    set r=BWE
    set g=BWE
    set b=BWE
    call SetUnitVertexColorBJ(XX8,r,g,b,GetRandomReal(.0,10.))
  endif
  set XX8=null
endfunction

function BYE takes nothing returns boolean
  return b_isPickTime==false and GetUnitTypeId(GetTriggerUnit())=='O00P' and IsUnitIllusion(GetTriggerUnit())==false
endfunction

function BZE takes nothing returns nothing
  local trigger t
  if((LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),(327)))==false)then
    set t=CreateTrigger()
    call SaveUnitHandle(HY,(GetHandleId(t)),(326),(GetTriggerUnit()))
    call SaveTriggerHandle(HY,(GetHandleId(GetTriggerUnit())),(328),(t))
    call TriggerAddAction(t,function BTE)
    call TriggerRegisterTimerEvent(t,1.,true)
    call SaveBoolean(HY,(GetHandleId(GetTriggerUnit())),(327),(true))
    set t=null
  endif
endfunction

function MD9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function BYE))
  call TriggerAddAction(t,function BZE)
  set t=null
endfunction

function AdaptiveStrike_Stun takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(), LoadReal(HY,h,0))
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function BBE takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(u,'A0G6')
  local integer mainstat
  local integer statvalue
  local real dmg
  local unit d
  local integer stunlvl
  local real angle
  local trigger t
  local integer h
  if GetUnitAbilityLevel(u,'A04R')>0 then
    set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  endif
  set mainstat=GetUnitPrimaryAttribute(u)
  if mainstat==1 then
    set statvalue=GetHeroInt(u,true)
  elseif mainstat==2 then
    set statvalue=GetHeroAgi(u,true)
  elseif mainstat==3 then
    set statvalue=GetHeroStr(u,true)
  endif
  set dmg=statvalue*(1+0.25*Level)+40+20*Level
  set d=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility(d,'A33K')
  call SetUnitAbilityLevel(d,'A33K',Level)
  if IssueTargetOrder(d,"thunderbolt",Target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3.5,false)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function AdaptiveStrike_Stun))
    call SaveUnitHandle(HY,h,0,d)
    call SaveReal(HY,h,0,0.8+0.2*Level)
    set t=null
  endif
  set d=null
  call TextTagOnUnit("|c001ce6b9+"+I2S(R2I(dmg))+"|r",1,Target,.023,255,255,255,216)
  call DamageTarget(u,Target,1,dmg)
  set u=null
  set Target=null
  set u=null
endfunction

function Morphling_AdaptiveStrike takes nothing returns nothing
  if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and IsBlocked(GetSpellTargetUnit())==false then
    call BBE()
  endif
endfunction

function B5E takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),FQ8)==false then
    call GroupAddUnit(FR8,GetEnumUnit())
    call UnitRemoveAbility(GetEnumUnit(),'B02J')
    call UnitRemoveAbility(GetEnumUnit(),'BUsp')
    call UnitRemoveAbility(GetEnumUnit(),'Bust')
  endif
endfunction

function B2E takes nothing returns nothing
  call UnitRemoveAbility(GetEnumUnit(),'B02J')
  call UnitRemoveAbility(GetEnumUnit(),'BUsp')
  call UnitRemoveAbility(GetEnumUnit(),'Bust')
endfunction

function C4E takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),FP8)==false then
    call SetUnitOwner(FO8,GetOwningPlayer(GetEnumUnit()),false)
    if IssueTargetOrderById(FO8,852227,GetEnumUnit()) then 
      call GroupAddUnit(FP8,GetEnumUnit())
    endif
  endif
endfunction

function C7E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local group g
  local group AlreadyHit=(LoadGroupHandle(HY,h,(187)))
  if GetTriggerEvalCount(t)==10 then
    call UnitAddAbility2(Source,'A24E')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A07U',false)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A24E',true)
  endif
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetTriggerEvalCount(t)>140 or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A24E')then
    if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))=='A07U' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A07U',true)
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A24E',false)
    call ForGroup(AlreadyHit,function B2E)
    call KillGroup(AlreadyHit)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Source
    set FO8=Caster
    set FP8=AlreadyHit
    call GroupEnumUnitsInRange(g,x,y,1250+25,Condition(function LP8))
    call ForGroup(g,function C4E)
    set FQ8=g
    set FR8=GetAvailableGroup()
    call ForGroup(AlreadyHit,function B5E)
    call GroupRemoveGroup(FR8,AlreadyHit)
    call KillGroup(g)
    call KillGroup(FR8)
  endif
  set t=null
  set g=null
  set Source=null
  set AlreadyHit=null
  set Caster=null
  return false
endfunction

function Naga_SongOfSiren takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call UnitAddAbility(Caster,'A07T')
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function C7E))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\SongOfTheSiren_2.mdx",Source,"origin")))
  set t=null
  set Source=null
  set Caster=null
endfunction

function CDE takes unit Source, unit Target returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'A2KU')
  local integer id='A244'
  call DamageTarget(Source,Target,1,100+30*Level)
  if Level==2 then
    set id='A245'
  elseif Level==3 then
    set id='A246'
  elseif Level==4 then
    set id='A247'
  endif
  if IsUnitBADWithSpellbooks(Target)==false then
    call AddTimedAbility(Target,id,1,8)
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),id,false)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\CrushingWave\\CrushingWaveDamage.mdl",Target,"chest"))
endfunction

function QJ2 takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),RipTideAlreadyHit)==false then
    call GroupAddUnit(RipTideAlreadyHit,GetEnumUnit())
    call CDE(RipTideSource,GetEnumUnit())
  endif
endfunction

function CEE takes nothing returns nothing
  local unit Source=GetEnumUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g=GetAvailableGroup()
  call DestroyEffect(AddSpecialEffect("war3mapImported\\RipTide09.mdx",x,y))
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,350+25,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function QJ2)
  call KillGroup(g)
  set g=null
  set Source=null
endfunction

function QL2 takes nothing returns boolean
  return IsUnitIllusion(GetFilterUnit())and IsDead(GetFilterUnit())==false
endfunction

function Naga_RipTide takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g=GetAvailableGroup()
  set RipTideAlreadyHit=GetAvailableGroup()
  set RipTideSource=Source
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function QL2))
  call GroupAddUnit(g,Source)
  call ForGroup(g,function CEE)
  call KillGroup(g)
  call KillGroup(RipTideAlreadyHit)
  set Source=null
  set g=null
endfunction

function Netherblast_Filter takes nothing returns boolean
  return IsUnitEnemy(Netherblast_Source,GetOwningPlayer(GetFilterUnit())) and IsDead(GetFilterUnit())==false and (GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsSiegeUnit(GetFilterUnit()))
endfunction

function Netherblast_Damage takes nothing returns nothing
  local unit u = GetEnumUnit()
  local real Damage = 25 + 75*Netherblast_Level
  if IsUnitType(u,UNIT_TYPE_STRUCTURE) then
    call DamageTarget(Netherblast_Source,u,1,Damage*.5)
  else
    call DamageTarget(Netherblast_Source,u,1,Damage)
  endif
  set u = null
endfunction

function Netherblast_Effect takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer h = GetHandleId(t)
  local unit Source = LoadUnitHandle(HY,h,2)
  local real x = LoadReal(HY,h,6)
  local real y = LoadReal(HY,h,7)
  local group g = GetAvailableGroup()
  set Netherblast_Source = Source
  set Netherblast_Level = LoadInteger(HY,h,0)
  call GroupEnumUnitsInRange(g,x,y,425,Condition(function Netherblast_Filter))
  call ForGroup(g,function Netherblast_Damage)
  call KillGroup(g)
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set g = null
  set Source = null
  set t=null
endfunction

function Netherblast_Start takes nothing returns nothing
  local unit Source = GetTriggerUnit()
  local real x = GetSpellTargetX()
  local real y = GetSpellTargetY()
  local unit Caster 
  local timer t
  local integer h
  //if GetUnitTypeId(Source)!='e00E' then
  set t=CreateTimer()
  set h=GetHandleId(t)
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call UnitAddAbility(Caster,'AHbz') //dummy ability to provide the visual
  call IssuePointOrder(Caster,"blizzard",x,y)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,x)
  call SaveReal(HY,h,7,y)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  if GetUnitTypeId(Source)!='e00E' then
    call TimerStart(t,0.9,false,function Netherblast_Effect)
  else
    call TimerStart(t,0.,false,function Netherblast_Effect)
  endif
  //endif
  set Caster = null
  set Source = null
  set t = null
endfunction

function CHE takes unit Source,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  call UnitAddAbility(Caster,'A0BA')
  call SetUnitAbilityLevel(Caster,'A0BA',Level)
  call IssueTargetOrderById(Caster,852106,Target)
  set Caster=null
endfunction

function CIE takes nothing returns boolean
  if IsUnitIllusion(GetFilterUnit()) and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
    call CHE(GetFilterUnit(),FT8,GetUnitAbilityLevel(GetTriggerUnit(),'A24D'))
  endif
  return false
endfunction

function CJE takes nothing returns boolean
  if IsUnitIllusion(GetFilterUnit()) and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
    call SetUnitFacing(GetFilterUnit(),tt_real1)
    call SetUnitAnimation(GetFilterUnit(),"spell")
  endif
  return false
endfunction

function Naga_Ensnare_OnCast takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  set tt_real1=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetUnitX(FT8),GetUnitY(FT8))
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function CJE))
  call KillGroup(g)
  set Hero=null
  set g=null
endfunction

function CME takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=FT8
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function CIE))
  call KillGroup(g)
  set Hero=null
  set Target=null
  set g=null
endfunction

function Naga_Ensnare takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    set FT8=GetSpellTargetUnit()
    call CHE(GetTriggerUnit(),FT8,GetUnitAbilityLevel(GetTriggerUnit(),'A24D'))
    call CME()
  endif
endfunction

function UnrefinedFireblast takes nothing returns nothing
  call SetUnitState(GetTriggerUnit(),UNIT_STATE_MANA,GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA)*0.4)
endfunction

function AghaFireblast_OnDmg takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,1) then
      call StunTargetLod(GetTriggerUnit(), 1.5)
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function AghaFireblast_Cast takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local trigger t
  local integer h
  call UnitAddAbility2(Caster,'A2KR')
  if IssueTargetOrder(Caster,"thunderbolt",Target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3,false)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call SaveUnitHandle(HY,h,1,Caster)
    call TriggerAddCondition(t,Condition(function AghaFireblast_OnDmg))
    set t=null
  endif
  set Source=null
  set Target=null
  set Caster=null
endfunction

function AghaFireblast_Add takes nothing returns nothing
  local unit Source=tt_unit1
  call UnitAddAbility2(Source,'A2KQ')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2KQ',true)
  set Source=null
endfunction

function AghaFireblast_Remove takes nothing returns nothing
  local unit Source=tt_unit1
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2KQ',false)
  set Source=null
endfunction

function Ogre_FireblastHit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(), 1.5)
      call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,15+65*LoadReal(HY,h,0))
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function Ogre_Fireblast takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(d,'A42E')
  if IssueTargetOrder(d,"thunderbolt",target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,5,false)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function Ogre_FireblastHit))
    call SaveUnitHandle(HY,h,0,d)
    call SaveUnitHandle(HY,h,1,caster)
    call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId())*1.0)
    set t=null
  endif
  set d=null
  set caster=null
  set target=null
endfunction

function Ogre_Fireblast_Wrap takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Ogre_Fireblast()
  endif
endfunction

function COE takes integer PlayerId,integer aid returns boolean
  //multicast addition restrictions...
  local integer index
  if aid!=0 then
    if isItemSpellOrNoCd(aid)or isPoisonArrowSkill(aid) or IsInvokersOrbs(aid) or isAintItemAbility(aid)==false then
      return false
    endif
  endif
  if aid=='A33U' then//lightning grapple
    return false
  endif
  if aid=='A456' or aid=='A44X' then//fire lord
    return false
  endif
  if aid=='A1MG' or aid=='A19O' then//Cold Feet, Fire Lasso
    return false
  elseif aid=='A0DL' or aid=='A0WP' or aid=='A43D' then//Enchant totem, God strength & old god strength
    return false
  elseif aid=='A0MQ' or aid=='A1B6' then  //primal split & upg
    return false
  elseif aid=='A1TA' or aid=='A1T8' or aid=='A28Q' or aid=='A1TB' then//all wisp's spells
    return false
  elseif aid=='QB0K' or aid=='ANcr' or aid=='A0Z4' or aid=='A0Z5' or aid=='A1NI' then//Chemical rage & balanced; clockwerk's ministun & cogs, unstable concoction
    return false
  elseif aid=='QM00' or aid=='A1YY' then//dk's dragon form, sun ray
    return false
  elseif aid=='A1RK' or aid=='A43H' or aid=='A1S7' or aid=='A1YQ' then//supernova, snowball, walrus punch
    return false
  elseif aid=='A2JR' or aid=='A2JL' or aid=='A2JO' or aid=='A2JQ' or aid=='A2JP' or aid=='A2E5' or aid=='A43S' or aid=='A43Q' or aid=='A43S' or aid=='A43Q' or aid=='QB08' or aid=='AEbl' then//Fire remnants, Chakram, am's blink & balanced
    return false
  elseif aid=='A04P' or aid=='A1AU' or aid=='A05G' or aid=='A0M1' or aid=='A1AX' then//Assassinate, jugger's spin, omnislash&upg
    return false
  elseif aid=='A0A5' or aid=='A1EG' or aid=='A0AG' then//Spirit bear, Rabid, True Form
    return false
  elseif aid=='A0KX' or aid=='A0G8' or aid=='A0KW' or aid=='A063' then//Morph agi/str, Replicate, Naga's illusions
    return false
  elseif aid=='A07U' or aid=='QB0B' or aid=='A0D7' or aid=='A0LN' then//Song of the siren, Doppelwalk & balanced, leap
    return false
  elseif aid=='A0KU' or aid=='A0BE' or aid=='A1EJ' then//Moonlight shadows, Berserker rage, Troll's ulti
    return false
  elseif aid=='A229' or aid=='QB03' or aid=='A1EA' then//flak cannon, Refraction & balanced
    return false
  elseif aid=='A0RV' or aid=='QB0P' or aid=='A1N4' or aid=='A0LC' or aid=='A443' then//Meld, Overpower + balanced, Enrage
    return false
  elseif aid=='A0IN' or aid=='A1AW' or aid=='QB09' or aid=='A07A' or aid=='QB0L' or aid=='A2H0' then//Nether swap + agh, bounty's windwalk + balanced, sleight of fist + balanced
    return false
  elseif aid=='A2HS' or aid=='A01B' then//Flame guard, Natures attendants
    return false
  elseif aid=='A0SB' or aid=='A28T' then//Phase shift, Holy Persuasion
    return false
  elseif aid=='QM01' or aid=='A01O' then//Ghost form, furion's tp, Force of nature
    return false
  elseif aid=='A14O' or aid=='A085' then//Ball lightning, Illuminate
    return false
  elseif aid=='A14I' or aid=='A12P' or aid=='A1D6' or aid=='A1SW' then//Windrun, Focus fire + upg, Glimpse
    return false
  elseif aid=='A06B' or aid=='A065' or aid=='A00P' then//Suicide, Rearm, Mana drain
    return false
  elseif aid=='A27F' or aid=='A27H' or aid=='A30J' or aid=='A0I6' then//Telekinesis, Spell steal + upg, Berserker call
    return false
  elseif aid=='A0RW' or aid=='A03O' or aid=='A10R' then//Reality Rift, Phantasm, Devour
    return false
  elseif aid=='A1OP' or aid=='A0SS' or aid=='QP1W' or aid=='A194' or aid=='A0SW' then//Scotcher Earth, Rage, Open Wounds, infest
    return false
  elseif aid=='A0NS' or aid=='A1DA' or aid=='QM02' then//Borrowed time, Lycan's ulti
    return false
  elseif aid=='A0R0' or aid=='A06K' or aid=='A0FL' or aid=='A1CX' then//Dark rift, Rot, Dismember & upg
    return false
  elseif aid=='DRKN' or aid=='A05C' or aid=='QM03' then//Darkness, Sprint, Flesh Golem
    return false
  elseif aid=='A1RD' or aid=='A1P8' or aid=='A0H0' then//Skewer, Charge of darkness, Sandstorm
    return false
  elseif aid=='A030' or aid=='QB0A' or aid=='A025' or aid=='A04Q' then//Full Clinkz
    return false
  elseif aid=='Z234' or aid=='A0WQ' then//Spin web, Brood's Hunger
    return false
  elseif aid=='A09U' or aid=='A2KO' or aid=='QB01' or aid=='A0CA' or aid=='A0CT' then//Spiked Carapase, Vendetta, Schukuchi & balanced, time lapse
    return false
  elseif aid=='A0PL' then//Blink strike PA, Conjure image
    return false
  elseif aid=='A1RI' or aid=='A07Q' or aid=='A0H9' then//Metamorphosis, Sunder, Haunt
    return false
  elseif aid=='A1HR' or aid=='QP1F' or aid=='A1IN' or aid=='A0LK' then//Slark's passive??, Shadow dance, Timewalk
    return false
  elseif aid=='A1C0' or aid=='A418' or aid=='A0MP' or aid=='A04Y' then//Splitshot, Spell shield, Nightmare
    return false
  elseif aid=='A04N' or aid=='A02N' or aid=='A180' then//exorcism, Mana drain, Demonic conversion
    return false
  elseif aid=='A0CC' or aid=='A02Z' or aid=='A0OJ' then//Life steal, Astral Imprisonment
    return false
  elseif aid=='QB07' or aid=='A0ME' or aid=='A1S8' or aid=='Z605' then//Akasha blink & balanced, Disruption, Ghost walk
    return false
  elseif isFormlessAbility(aid) then//Formless
    return false
  endif
  
  set index=SK8(PlayerId,aid)
  
  //call BJDebugMsg("Spell id: "+I2S(index))
  
  if index!=0 then
    if CheckStacking(index,-1,"metamorphosis",null)then
      return false
    elseif CheckStacking(index,-1,"arrows",null)then
      return false
    endif
  endif
  return true
endfunction

function MC_Check takes unit u, integer key, real chanceBO, real chanceBOoff returns boolean
  return (Mode_BO and PRD_Get(u,key,chanceBO)) or (Mode_BO==false and PRD_Get(u,key,chanceBOoff))
endfunction

function CheckWhatIsMulticast takes nothing returns nothing
  local player p=GetTriggerPlayer()
  local integer pid=GetPlayerId(p)
  local integer i=1
  local integer aid
  loop
    set aid=SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+i]]
    if aid>0 and IsPassiveAbility[PlayerSkillNumber[pid*PlayerSkillOffset+i]]==false then
      if COE(pid,aid) and MulticastSpellRestriction(aid) then
        call DisplayTimedTextToPlayer(p,0,0,15,"	|c00ff0303"+GetObjectName(aid)+"|r "+Id2String(aid)+" can be multicasted")
      endif
    endif
    set i=i+1
    exitwhen i > 4+NumberOfExtraAbilities
  endloop
endfunction

function CPE takes unit u returns integer
  local real r
  local integer Level=(GetUnitAbilityLevel(u,'A088')+GetUnitAbilityLevel(u,'QP24'))
  local boolean agh=false
  local integer multiplier=0
  local integer id=GetPlayerId(GetOwningPlayer(u))
  local integer chance
  local integer ph=GetHandleId(GetOwningPlayer(u))
  set r=GetRandomReal(0,100)
  if not(COE(id,GetSpellAbilityId()))then
    return 0
  endif
  call SaveInteger(HeroStats,ph,'MC_T',LoadInteger(HeroStats,ph,'MC_T')+1)
  //set MC_Total[id]=MC_Total[id]+1
  if Level==1 then
    if MC_Check(u,'A088',25,18) then
      set multiplier=2
    endif
  elseif Level==2 then
    if MC_Check(u,'A088'+1,20,13) then
      set multiplier=3
    elseif MC_Check(u,'A088',40,29.5) then
      set multiplier=2
    endif
  elseif Level==3 then
    if MC_Check(u,'A088'+2,12.5,5.5) then
      set multiplier=4
    elseif MC_Check(u,'A088'+1,25,14.5) then
      set multiplier=3
    elseif MC_Check(u,'A088',50,39.5) then
      set multiplier=2
    endif
  endif
  if multiplier==2 then
    call SaveInteger(HeroStats,ph,'MC_2',LoadInteger(HeroStats,ph,'MC_2')+1)
  elseif multiplier==3 then
    call SaveInteger(HeroStats,ph,'MC_3',LoadInteger(HeroStats,ph,'MC_3')+1)
  elseif multiplier==4 then
    call SaveInteger(HeroStats,ph,'MC_4',LoadInteger(HeroStats,ph,'MC_4')+1)
  endif
  return multiplier
endfunction

function MulticastChannelingsStopper takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call IssueImmediateOrder(u,"stop")
  call DisableTrigger(t)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h) 
  set u=null
  set t=null
  return false
endfunction

function Ignite_PossibleTarget takes nothing returns boolean
  return(IsUnitEnemy(TEMPUNIT,GetOwningPlayer(GetFilterUnit()))and AliveNonBuildOrMarker(GetFilterUnit()) and IsMagicImmune(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'B03J')==0 and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(TEMPUNIT)))!=null
endfunction

function CRE takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer Cache=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,(Cache),2))
  local player p = GetOwningPlayer(Source)
  local integer CSE=(LoadInteger(HY,(Cache),(300)))
  local integer Level=(LoadInteger(HY,(Cache),5))
  local integer CTE=(LoadInteger(HY,(Cache),(299)))
  local integer CUE=(LoadInteger(HY,(Cache),'0ORD'))
  local integer CVE=(LoadInteger(HY,(Cache),'ORDT'))
  local unit Caster
  local unit CWE
  local real ux
  local real uy
  local real tx
  local real ty
  local real d
  local real a
  local boolean b
  local boolean disabled
  local trigger tt
  local integer h
  local real delay
  local group g
  
  if GetTriggerEvalCount(t)>CSE then
    call FlushChildHashtable(HY,(Cache))
    call CleanTrigger(t)
  else
    set Caster = CreateUnit(p,'e00E',GetWidgetX(Source),GetWidgetY(Source),0)
    call SetUnitX(Caster,GetWidgetX(Source))
    call SetUnitY(Caster,GetWidgetY(Source))
    call SaveUnitHandle(MHT,GetHandleId(Caster),0,LoadUnitHandle(HY,Cache,2))
    call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_EFFECT)
    call RemoveSavedHandle(MHT,GetHandleId(Caster),0)
    if HaveSavedInteger(MHT,CTE,0)then
      set CTE = LoadInteger(MHT,CTE,0)
    endif
    call UnitAddAbility2(Caster,CTE)
    call SetUnitAbilityLevel(Caster,CTE,Level)
    set disabled = LoadBoolean(MHT,GetHandleId(p),CTE)
    if disabled then
      call SetPlayerAbilityAvailable(p,CTE,true)
    endif
    
    if CVE==1 then
      set CWE=LoadUnitHandle(HY,(Cache),17)
      if CTE!='A011' then
        
        set ux=GetUnitX(CWE)
        set uy=GetUnitY(CWE)
        set tx=GetUnitX(Source)
        set ty=GetUnitY(Source)
        set d=LoadReal(HY,(Cache),'000D')
        set a=Atan2(ty-uy,tx-ux)
        
        call UnitShareVision(CWE,p,true)
        
        loop
          exitwhen IssueTargetOrderById(Caster,CUE,CWE) or d<0
          call SetUnitX(Caster,ux+(d*Cos(a)))
          call SetUnitY(Caster,uy+(d*Sin(a)))
          set d=d-10
        endloop
        if CTE=='A2QT' then
          set delay=RMinIF((TimerGetElapsed(GlobalTimer))-(LoadReal(HY,(GetHandleId(Source)),(358)))-(0.3*GetTriggerEvalCount(t)),3)
          set tt=CreateTrigger()
          call TriggerRegisterTimerEvent(tt,delay,false)
          call TriggerAddCondition(tt,Condition(function MulticastChannelingsStopper))
          call SaveUnitHandle(HY,GetHandleId(tt),0,Caster)
          set tt=null
        endif
        call UnitShareVision(CWE,p,false)
      else// if Ignite
        set g=GetAvailableGroup()
        set TEMPUNIT=Source
        call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1400,Condition(function Ignite_PossibleTarget))
        call GroupRemoveUnit(g,CWE)
        if FirstOfGroup(g)!=null then
          set CWE=GroupPickRandomUnit(g)
        endif
        call IssueTargetOrderById(Caster,CUE,CWE)
        call KillGroup(g)
        set g=null
      endif
    elseif CVE==2 then
      set CWE=LoadUnitHandle(HY,(Cache),17)
      set ux=LoadReal(HY,(Cache),'0LOX')
      set uy=LoadReal(HY,(Cache),'0LOY')
      set tx=GetUnitX(Source)
      set ty=GetUnitY(Source)
      set d=LoadReal(HY,(Cache),'000D')
      set a=Atan2(ty-uy,tx-ux)
      loop
        set b=IssuePointOrderById(Caster,CUE,ux,uy)
        exitwhen b or d<0
        call SetUnitX(Caster,ux+(d*Cos(a)))
        call SetUnitY(Caster,uy+(d*Sin(a)))
        set d = d-10
      endloop
      if CTE=='A12K' then
        set delay=RMinIF((TimerGetElapsed(GlobalTimer))-(LoadReal(HY,(GetHandleId(Source)),(358)))-(0.3*GetTriggerEvalCount(t)),1.05)
        set tt=CreateTrigger()
        call TriggerRegisterTimerEvent(tt,delay,false)
        call TriggerAddCondition(tt,Condition(function MulticastChannelingsStopper))
        call SaveUnitHandle(HY,GetHandleId(tt),0,Caster)
        set tt=null
      endif
    elseif CVE==3 then
      call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_FINISH)
      call IssueImmediateOrderById(Caster,CUE)
    endif
    
    if disabled then
      call SetPlayerAbilityAvailable(p,CTE,false)
    endif
  endif
  set t=null
  set Source=null
  set Caster=null
  set CWE=null
  set p=null
  return false
endfunction

function CXE takes integer r returns nothing
  local unit Source=GetTriggerUnit()
  local integer CTE=GetSpellAbilityId()
  local integer Level=GetUnitAbilityLevel(Source,CTE)
  local trigger t=CreateTrigger()
  local integer Cache=GetHandleId(t)
  local integer CVE=LoadInteger(HY,GetHandleId(Source),'ORDT')
  local integer i
  local timer tt
  local integer h
  if r==2 then
    call TextTagOnUnit(GetObjectName('n0K7'),5,GetTriggerUnit(),.03,255,0,0,255)
  elseif r==3 then
    call TextTagOnUnit(GetObjectName('n0JT'),5,GetTriggerUnit(),.03,255,0,0,255)
  elseif r==4 then
    call TextTagOnUnit(GetObjectName('n0K8'),5,GetTriggerUnit(),.03,255,0,0,255)
  elseif r==5 then
    call TextTagOnUnit(GetObjectName('n0JO'),5,GetTriggerUnit(),.03,255,0,0,255)
  endif
  set r=r-1
  call SaveUnitHandle(HY,(Cache),2,(Source))
  call SaveInteger(HY,(Cache),(300),(r))
  call SaveInteger(HY,(Cache),5,(Level))
  call SaveInteger(HY,(Cache),(299),(CTE))
  if CVE==1 then
    call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
    call SaveReal(HY,(Cache),'000D',LoadReal(HY,GetHandleId(Source),'000D'))
    call SaveUnitHandle(HY,(Cache),17,(GetSpellTargetUnit()))
  elseif CVE==2 then
    call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
    call SaveReal(HY,(Cache),'000D',LoadReal(HY,GetHandleId(Source),'000D'))
    call SaveReal(HY,(Cache),'0LOX',GetSpellTargetX())
    call SaveReal(HY,(Cache),'0LOY',GetSpellTargetY())
  elseif CVE==3 then
    call SaveInteger(HY,(Cache),'0ORD',LoadInteger(HY,GetHandleId(Source),'0ORD'))
    //call SaveReal(HY,(Cache),'0FAC',GetUnitFacing(Source))
  endif
  //if CTE!='A0MT' then
  call SaveInteger(HY,(Cache),'ORDT',CVE)
  call TriggerRegisterTimerEvent(t,0.3,true)
  call TriggerAddCondition(t,Condition(function CRE))
  //endif
  set t=null
  set Source=null
endfunction

function CYE takes nothing returns boolean//multicast
  local integer r
  local unit u
  local real ux
  local real uy
  local real tx
  local real ty
  if (GetUnitAbilityLevel(GetTriggerUnit(),'A088')+GetUnitAbilityLevel(GetTriggerUnit(),'QP24'))>0 then
    set u=GetTriggerUnit()
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
      call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
      call SaveInteger(HY,GetHandleId(u),'ORDT',1)
      return false
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER then
      call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
      call SaveInteger(HY,GetHandleId(u),'ORDT',2)
      return false
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_ORDER then
      call SaveInteger(HY,GetHandleId(u),'0ORD',GetIssuedOrderId())
      call SaveInteger(HY,GetHandleId(u),'ORDT',3)
      return false
    endif
    if MulticastSpellRestriction(GetSpellAbilityId()) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0then
      if GetSpellTargetUnit()!=null and LoadInteger(HY,GetHandleId(u),'ORDT')==1 then
        if IsBlocked(GetSpellTargetUnit())==false and IsPlayerEnemy(GetOwningPlayer(GetSpellTargetUnit()),GetOwningPlayer(u)) then
          set r=CPE(u)
          if r>1 then
            set ux=GetUnitX(u)
            set uy=GetUnitY(u)
            set tx=GetUnitX(GetSpellTargetUnit())
            set ty=GetUnitY(GetSpellTargetUnit())
            call SaveReal(HY,GetHandleId(u),'000D',SquareRoot(((tx-ux)*(tx-ux))+((ty-uy)*(ty-uy))))
            call CXE(r)
          endif
        endif
      elseif GetSpellTargetLoc()!=null and LoadInteger(HY,GetHandleId(u),'ORDT')==2 then
        set r=CPE(u)
        if r>1 then
          set ux=GetUnitX(u)
          set uy=GetUnitY(u)
          set tx=GetSpellTargetX()
          set ty=GetSpellTargetY()
          call SaveReal(HY,GetHandleId(u),'000D',SquareRoot(((tx-ux)*(tx-ux))+((ty-uy)*(ty-uy))))
          call CXE(r)
        endif
      elseif LoadInteger(HY,GetHandleId(u),'ORDT')==3 then
        set r=CPE(u)
        if r>1 then
          call CXE(r)
        endif
      endif
    endif
  endif
  if IsBlocked(GetSpellTargetUnit())==false and GetSpellAbilityId()=='A2KQ' then
    call AghaFireblast_Cast()
  endif
  set u=null
  return false
endfunction

function CZE takes nothing returns boolean
  local integer id=GetPlayerId(GetTriggerPlayer())
  local string s1
  local string s2
  local string s3
  local string s4
  local string s5
  local string s6
  if MC_Total[id]>0 then
    set s1=GetObjectName('n0JH')+" "+I2S(MC_Total[id])
    set s2=GetObjectName('n0JM')+" "+I2S(MC_2xCount[id]+MC_3xCount[id]+MC_4xCount[id]+MC_5xCount[id])+" ("+I2S((MC_2xCount[id]+MC_3xCount[id]+MC_4xCount[id]+MC_5xCount[id])*100/ MC_Total[id])+"%)"
    set s3=GetObjectName('n0JL')+" "+I2S(MC_2xCount[id])+" ("+I2S(100*MC_2xCount[id]/ MC_Total[id])+"%)"
    set s4=GetObjectName('n0JK')+" "+I2S(MC_3xCount[id])+" ("+I2S(100*MC_3xCount[id]/ MC_Total[id])+"%)"
    set s5=GetObjectName('n0JJ')+" "+I2S(MC_4xCount[id])+" ("+I2S(100*MC_4xCount[id]/ MC_Total[id])+"%)"
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,s1)
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,s2)
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,s3)
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,s4)
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,s5)
  endif
  return false
endfunction

function MM9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function CYE))
  set t=null
endfunction

function CAE takes nothing returns boolean
  local unit A3E=GetFilterUnit()
  local unit XX8=GetTriggerUnit()
  if IsUnitAlly(A3E,GetOwningPlayer(XX8))and GetWidgetLife(A3E)>0 and GetUnitAbilityLevel(A3E,'Bblo')==0 then
    if(GetOwningPlayer(A3E)==Sentinels[0]or GetOwningPlayer(A3E)==Scourges[0])then
      if(GetUnitTypeId(A3E)=='ugho' or GetUnitTypeId(A3E)=='u001' or GetUnitTypeId(A3E)=='unec' or GetUnitTypeId(A3E)=='u002')then
        set A3E=null
        set XX8=null
        return true
      endif
      if(GetUnitTypeId(A3E)=='esen' or GetUnitTypeId(A3E)=='e00V' or GetUnitTypeId(A3E)=='edry' or GetUnitTypeId(A3E)=='e00W')then
        set A3E=null
        set XX8=null
        return true
      endif
      set A3E=null
      set XX8=null
      return false
    elseif IsUnitType(A3E,UNIT_TYPE_HERO) then
      set A3E=null
      set XX8=null
      return true
    elseif GetOwningPlayer(A3E)==GetOwningPlayer(XX8)then
      set A3E=null
      set XX8=null
      return true
    endif
  endif
  set A3E=null
  set XX8=null
  return false
endfunction



function CBE takes integer r returns nothing
  local unit XX8=GetTriggerUnit()
  local integer Level=r
  local group g = GetAvailableGroup()
  local group gg=GetAvailableGroup()
  local unit Caster
  local unit MRE
  local integer V58=GetSpellAbilityId()
  local integer VT8=1
  local boolean b = false
  if r==2 then
    call TextTagOnUnit(GetObjectName('n0K7'),5,XX8,.03,255,0,0,255)
  elseif r==3 then
    call TextTagOnUnit(GetObjectName('n0JT'),5,XX8,.03,255,0,0,255)
  elseif r==4 then
    call TextTagOnUnit(GetObjectName('n0K8'),5,XX8,.03,255,0,0,255)
  elseif r==5 then
    call TextTagOnUnit(GetObjectName('n0JO'),5,XX8,.03,255,0,0,255)
  endif
  set r=r-1
  call GroupEnumUnitsInRange(gg,GetUnitX(XX8),GetUnitY(XX8),600,Condition(function CAE))
  if XX8!=GetSpellTargetUnit()then
    call GroupAddUnit(gg,XX8)
  endif
  
  if HaveSavedInteger(MHT,V58,0)then
    set V58 = LoadInteger(MHT,V58,0)
  endif
  
  call GroupAddGroup(gg,g)
  
  loop
    exitwhen b
    loop
      exitwhen VT8>Level or b
      
      if V58=='A08N' or V58=='A2QM' then
        set MRE=GetSpellTargetUnit()
      else
        set MRE=GroupPickRandomUnit(gg)
      endif
      if V58=='AEfn' then
        set V58='A333'
      endif
      set b = MRE==null
      
      if b==false then
        set Caster=CreateUnit(GetOwningPlayer(XX8),'e00C',GetUnitX(XX8),GetUnitY(XX8),270)
        
        call TriggerRegisterUnitEvent(GAME_TRIGGER,Caster,EVENT_UNIT_SPELL_EFFECT)
        
        call UnitAddAbility2(Caster,V58)
        call SetUnitAbilityLevel(Caster,V58,GetUnitAbilityLevel(XX8,V58))
        call UnitApplyTimedLife(Caster,'BTLF',1.)
        call IssueTargetOrderById(Caster,LoadInteger(HY,GetHandleId(XX8),'0ORD'),MRE)
        call SetUnitPathing(Caster,false)
        call SetUnitInvulnerable(Caster,true)
        call UnitAddAbility2(Caster,'Aloc')
        
        call GroupRemoveUnit(gg,MRE)
        set VT8=VT8+1
      endif
    endloop
    
    if b and Level > VT8 then
      set b = false
      call GroupAddGroup(g,gg)
    endif
  endloop
  
  call KillGroup(gg)
  call KillGroup(g)
  
  set Caster = null
  set gg = null
  set MRE = null
  set XX8 = null
  set g = null
endfunction

function CCE takes nothing returns boolean
  local integer r
  if (GetUnitAbilityLevel(GetTriggerUnit(),'A088')+GetUnitAbilityLevel(GetTriggerUnit(),'QP24'))>0 then
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
      call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,GetIssuedOrderId())
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER then
      call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,0)
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_ORDER then
      call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1,0)
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and(LoadInteger(HY,GetHandleId(GetTriggerUnit()),'0ORD'+1)!=0)then
      if MulticastSpellRestriction(GetSpellAbilityId())and(GetSpellTargetUnit()!=null)and(GetSpellAbilityId()!=null) and GetUnitAbilityLevel(GetTriggerUnit(),'A04R')==0then
        if IsPlayerAlly(GetOwningPlayer(GetSpellTargetUnit()),GetOwningPlayer(GetTriggerUnit()))then
          set r=CPE(GetTriggerUnit())
          //set r = 4
          if r>1 then
            call CBE(r)
          endif
        endif
      endif
    endif
  endif
  return false
endfunction


function MN9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function CCE))
  set t=null
endfunction

function Ogre_Bloodlust_Learn takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A083')
  call SetUnitAbilityLevel(GetTriggerUnit(),'A083',GetUnitAbilityLevel(GetTriggerUnit(),'A40B'))
endfunction

function C6E takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')!=1 and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())))!=null
endfunction

function CLE takes nothing returns nothing
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),3,TmpReal378)
endfunction

function Omni_Purification takes nothing returns nothing
  local group g=GetAvailableGroup()
  local real x=GetUnitX(GetSpellTargetUnit())
  local real y=GetUnitY(GetSpellTargetUnit())
  set TmpReal378=90*GetUnitAbilityLevel(GetTriggerUnit(),('A08N'))
  if GetWidgetLife(GetSpellTargetUnit())>1 then
    call SetWidgetLife(GetSpellTargetUnit(),GetWidgetLife(GetSpellTargetUnit())+TmpReal378)
  endif
  call GroupEnumUnitsInRange(g,x,y,260+25,Condition(function C6E))
  call ForGroup(g,function CLE)
  call KillGroup(g)
  set g=null
endfunction

function Omni_GAPastFilter takes nothing returns boolean
  return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'B00G')>0 and DistanceBetweenUnits(GetFilterUnit(),tt_unit1)>2000
endfunction

function Omni_GAPast takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit caster=LoadUnitHandle(HY,GetHandleId(t),0)
  local group g
  local unit u
  set g=GetAvailableGroup()
  set tt_unit1=caster
  call GroupEnumUnitsInRange(g,0,0,12000,Condition(function Omni_GAPastFilter))
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    call UnitRemoveAbility(u,'B00G')
    call GroupRemoveUnit(g,u)
  endloop
  
  call KillGroup(g)
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTimer(t)
  set u=null
  set caster=null
endfunction

function Omni_GuardianAngelUpg takes nothing returns nothing
  //	local unit u=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
  //	if IsRearmPicked(GetTriggerUnit()) then
  //		call UnitAddAbility(u,'A45T')
  //		call SetUnitAbilityLevel(u,'A45T',GetUnitAbilityLevel(GetTriggerUnit(),'A2S8'))
  //	else
  //		call UnitAddAbility(u,'A45S')
  //		call SetUnitAbilityLevel(u,'A45S',GetUnitAbilityLevel(GetTriggerUnit(),'A2S8'))
  //	endif
  //	if IssueImmediateOrderById(u,852599) then
  //		call echo("casted")
  //	endif
  //	set u=null
  local timer t
  if IsRearmPicked(GetTriggerUnit()) then
    set t=CreateTimer()
    call TimerStart(t,0,false,function Omni_GAPast)
    call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
    set t=null
  endif
  
endfunction

function C0E takes nothing returns boolean
  local unit W39=GetSummonedUnit()
  local unit Caster
  local unit Target
  if IsUnitIllusion(W39) then
    set Caster=GetSummoningUnit()
    set Target=(LoadUnitHandle(HY,(GetHandleId(Caster)),(303)))
    if Target==null or GetUnitX(Target)==.0 or GetUnitY(Target)==.0 then
      set W39=null
      set Caster=null
      set Target=null
      return false
    endif
    call SetUnitX(W39,GetUnitX(Target))
    call SetUnitY(W39,GetUnitY(Target))
    call IssueTargetOrderById(W39,851983,Target)
  endif
  set W39=null
  set Caster=null
  set Target=null
  return false
endfunction

function C5E takes player p,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitX(Target),0)
  local integer AF8
  call SaveUnitHandle(HY,(GetHandleId(Caster)),(303),(Target))
  if Level==1 then
    set AF8='A10H'
  elseif Level==2 then
    set AF8='A10G'
  elseif Level==3 then
    set AF8='A10I'
  else
    set AF8='A10F'
  endif
  call UnitAddAbility2(Caster,AF8)
  call IssueTargetOrderById(Caster,852274,udg_Hero[GetPlayerId(p)])
  set Caster=null
endfunction

function C2E takes player p,unit Target,integer Level,boolean L4E,boolean L7E returns nothing
  local real Damage=50+50*Level
  local unit Caster
  local integer AF8
  if L7E then
    set Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)
    call UnitAddAbility2(Caster,'A10C')
    call SetUnitAbilityLevel(Caster,'A10C',Level)
    call IssueTargetOrderById(Caster,852189,Target)
    call DamageTarget(Caster,Target,1,Damage)
    if L4E then
      call C5E(p,Target,Level)
    endif
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\IllidanMissile\\IllidanMissile.mdl",Target,"origin"))
  set Caster=null
endfunction

function L8E takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p
  local unit Target
  local integer Level
  local boolean DV9
  local unit Projectile
  local real x
  local real y
  local real TargetX
  local real TargetY
  local real AM8
  local real AN8
  local real AO8
  local real AP8
  local boolean disjointed
  local real lastX
  local real lastY
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if IsDisjointSpell(GetSpellAbilityId()) then
      call SaveBoolean(HY,h,0,true)
      call SaveReal(HY,h,0,GetUnitX(GetTriggerUnit()))
      call SaveReal(HY,h,1,GetUnitY(GetTriggerUnit()))
    endif
  else
    set p=LoadPlayerHandle(HY,h,54)
    set Target=LoadUnitHandle(HY,h,30)
    set Level=LoadInteger(HY,h,5)
    set DV9=LoadBoolean(HY,h,302)
    set Projectile=LoadUnitHandle(HY,h,45)
    set x=GetUnitX(Projectile)
    set y=GetUnitY(Projectile)
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
    set AM8=1000*.035
    set disjointed=LoadBoolean(HY,h,0)
    if disjointed then
      set TargetX=LoadReal(HY,h,0)
      set TargetY=LoadReal(HY,h,1)
    endif
    set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
    set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
    set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
    
    call SetUnitX(Projectile,AO8)
    call SetUnitY(Projectile,AP8)
    call SetUnitFacing(Projectile,AN8)
    if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
      if disjointed==false then
        call C2E(p,Target,Level,true,DV9)
      endif
      call KillUnit(Projectile)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Target=null
  set Projectile=null
  return false
endfunction

function L9E takes unit Source,integer Level,unit Target,boolean DV9 returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h06L',GetUnitX(Source),GetUnitY(Source),AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target)))
  call SavePlayerHandle(HY,h,54,GetOwningPlayer(Source))
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveBoolean(HY,h,302,DV9)
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveInteger(HY,h,5,Level)
  call TriggerRegisterTimerEvent(t,.035,true)
  call SaveBoolean(HY,h,0,false)//has been disjointed
  call SaveReal(HY,h,0,0)//X
  call SaveReal(HY,h,1,0)//Y
  call TriggerAddCondition(t,Condition(function L8E))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
  set t=null
  set Projectile=null
endfunction

function LDE takes nothing returns boolean
  if IsUnitIllusion(GetFilterUnit()) and isPlayerPickedAbility(GetOwningPlayer(GetFilterUnit()),83)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
    call L9E(GetFilterUnit(),3,GetSpellTargetUnit(),false)
  endif
  return false
endfunction

function PL_SpiritLance takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A10D')
  local unit Target=GetSpellTargetUnit()
  local group g=GetAvailableGroup()
  
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function LDE))
  call L9E(Hero,Level,Target,IsBlocked(GetSpellTargetUnit())==false)
  call KillGroup(g)
  
  set Hero=null
  set Target=null
  set g=null
endfunction

function LGE takes nothing returns boolean
  if IsUnitIllusion(GetFilterUnit()) and isPlayerPickedAbility(GetOwningPlayer(GetFilterUnit()),83)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
    call SetUnitFacing(GetFilterUnit(),tt_real1)
    call SetUnitAnimation(GetFilterUnit(),"spell")
  endif
  return false
endfunction

function PL_SpiritLance_OnCast takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  set tt_real1=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),700,Condition(function LGE))
  call KillGroup(g)
  set Hero=null
  set g=null
endfunction

function MR9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call PreloadQueryAdd('A10C')
  call PreloadQueryAdd('A10H')
  call PreloadQueryAdd('A10G')
  call PreloadQueryAdd('A10I')
  call PreloadQueryAdd('A10F')
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function C0E))
  set t=null
endfunction

function LJE takes nothing returns boolean
  if (GetUnitAbilityLevel(GetFilterUnit(),'B03B')>0 or GetUnitAbilityLevel(GetFilterUnit(),'P084')>0) and IsDead(GetFilterUnit())==false then
    set tt_int1=tt_int1+1
  endif
  return false
endfunction

function PL_Illusions_OnAttack takes unit u returns nothing
  local group g=GetAvailableGroup()
  local integer jux=GetUnitAbilityLevel(u,'P083') //A0DB //juxtapose
  local integer ult=jux//P084
  local unit Caster
  local integer maxillus=2*jux
  local integer juxchance=12+2*(ult-1)
  set tt_int1=0
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function LJE))
  call KillGroup(g)
  if tt_int1<maxillus and GetUnitAbilityLevel(u,'BNdo')==0 then
    if (IsUnitIllusion(u)==false and PRD_Get(u,'P083',juxchance)) or (IsUnitIllusion(u) and GetRandomInt(1,100)<=(-1+2*ult))then
      set Caster=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
      call UnitAddAbility(Caster,'A0DD')
      call IssueTargetOrderById(Caster,852274,u)
      set Caster=null
    endif
  endif
  set g=null
endfunction

function PL_Illusions_OnAttackWrap takes unit u, unit target returns nothing
  if (GetUnitAbilityLevel(u,'P083')>0 or GetUnitAbilityLevel(u,'B03B')>0 or GetUnitAbilityLevel(u,'B03A')>0) and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(target,GetOwningPlayer(u)) then
    call PL_Illusions_OnAttack(u)
  endif
endfunction

function PL_Doppelwalk takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  call UnitAddAbility2(Caster,'A0DC')
  call IssueTargetOrderById(Caster,852274,u)
  set u=null
  set Caster=null
endfunction

function LUE takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())==HeroID[21]and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())and IsUnitIllusion(GetFilterUnit())==false then
    set tt_unit1=GetFilterUnit()
  endif
  return false
endfunction

function LVE takes nothing returns nothing
  local unit W39=GetTriggerUnit()
  local unit Source
  local group g=GetAvailableGroup()
  local real x
  local real y
  set tt_unit1=null
  call GroupEnumUnitsInRange(g,GetUnitX(W39),GetUnitY(W39),1000,Condition(function LUE))
  call KillGroup(g)
  set Source=tt_unit1
  if Source!=null then
    set x=GetUnitX(Source)
    set y=GetUnitY(Source)
    call SetUnitPosition(W39,x,y)
  endif
  set x=GetUnitX(W39)+600*Cos(GetUnitFacing(W39)*bj_DEGTORAD)
  set y=GetUnitY(W39)+600*Sin(GetUnitFacing(W39)*bj_DEGTORAD)
  call IssuePointOrderById(W39,851986,x,y)
  set W39=null
  set Source=null
  set g=null
endfunction

function LWE takes nothing returns boolean
  if GetUnitAbilityLevel(GetTriggerUnit(),'B03A')>0 then
    call LVE()
  endif
  return false
endfunction

function MP9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  local region r=CreateRegion()
  call RegionAddRect(r,bj_mapInitialPlayableArea)
  call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function LWE))
  set t=null
  set r=null
endfunction

function OvergrowthEnemyFilter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>0
endfunction

function Func2270 takes nothing returns nothing
  local unit loc_unit01=GetTriggerUnit()
  local unit loc_unit02=CreateUnit(GetOwningPlayer(loc_unit01),'e022',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),270)
  call UnitAddAbility2(loc_unit02,'A06T')
  call SetUnitAbilityLevel(loc_unit02,'A06T',GetUnitAbilityLevel(loc_unit01,'A07Z')+GetUnitAbilityLevel(loc_unit01,'A44S'))
  call UnitRemoveAbility(GetEnumUnit(),'B0ER')
  call IssueTargetOrder(loc_unit02,"entanglingroots",GetEnumUnit())
endfunction

function OvergrowthAghanimTicks takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u
  local integer h=GetHandleId(t)
  local integer i=1
  local integer ticks=LoadInteger(HY,h,0)
  local integer targets=LoadInteger(HY,h,-1)
  local unit caster=LoadUnitHandle(HY,h,0)
  loop
    if HaveSavedHandle(HY,h,i)then
      set u=LoadUnitHandle(HY,h,i)
      if IsDead(u)==false and GetUnitAbilityLevel(u,'B0ER')>0 then
        call DamageTarget(caster,u,1,175)
      else
        call RemoveSavedBoolean(HY,LoadInteger(HY,h,i),'B0ER')
        call RemoveSavedHandle(HY,h,i)
      endif
    endif
    set i=i+1
    exitwhen i>targets
  endloop
  if ticks > 10 then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  elseif ticks==0 then
    call TimerStart(t,1,true,function OvergrowthAghanimTicks)
  endif
  set t=null
endfunction

function OvergrowthAghanim takes unit caster, group g returns nothing
  local timer t=CreateTimer()
  local unit u
  local integer h=GetHandleId(t)
  local integer hu
  local integer i=1
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    set hu=GetHandleId(u)
    if GetUnitAbilityLevel(u,'B0ER')==0 and LoadBoolean(HY,hu,'B0ER')==false then
      call SaveUnitHandle(HY,h,i,u)
      call SaveInteger(HY,h,i,hu)
      call SaveBoolean(HY,hu,'B0ER',true)
      set i=i+1
    endif
    call GroupRemoveUnit(g,u)
  endloop
  call TimerStart(t,0,false,function OvergrowthAghanimTicks)
  call SaveUnitHandle(HY,h,0,caster)
  call SaveInteger(HY,h,-1,i)
  set t=null
  set u=null
endfunction

function Tree_Overgrowth_Start takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local boolean agh=GetSpellAbilityId()!='A07Z'
  local integer hu=GetHandleId(GetOwningPlayer(u))
  local group gg
  local group g3
  local integer i
  local integer k
  local destructable d
  local boolean RearmExists=Mode_RC and IsRearmPicked(u)
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),700,Condition(function OvergrowthEnemyFilter))
  if agh then
    set gg=GetAvailableGroup()
    set g3=GetAvailableGroup()
    set i=0
    set k=LoadInteger(HY,hu,'EinF')
    loop
      set i=i+1
      exitwhen i>k
      set d=LoadDestructableHandle(HY,hu,'EinF'+i)
      if RearmExists==false or DistanceBetweenXY(GetUnitX(u),GetUnitY(u),GetDestructableX(d),GetDestructableY(d)) < 3000 then
        call GroupEnumUnitsInRange(gg,GetDestructableX(d),GetDestructableY(d),800,Condition(function OvergrowthEnemyFilter))
        call GroupAddGroup(gg,g)
        call GroupAddGroup(gg,g3)
      endif
    endloop
    call OvergrowthAghanim(u,g3)
    call KillGroup(g3)
    call KillGroup(gg)
  endif
  call ForGroup(g,function Func2270)
  call KillGroup(g)
endfunction

function EyeInTheForestDeath takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer hu=LoadInteger(HY,h,0)
  local integer count=LoadInteger(HY,hu,'EinF')
  local integer offset=LoadInteger(HY,h,1)
  local integer i=offset-1
  local unit dummy=LoadUnitHandle(HY,h,2)
  if GetTriggerEventId()!=EVENT_GAME_TIMER_EXPIRED then
    call DestroyUbersplat(LoadUbersplatHandle(HY,h,3))
    call DestroyTrigger(t)
    call FlushChildHashtable(HY,h)
    call KillUnit(dummy)
    loop
      set i=i+1
      exitwhen HaveSavedHandle(HY,hu,'EinF'+i+1)==false
      call SaveDestructableHandle(HY,hu,'EinF'+i,LoadDestructableHandle(HY,hu,'EinF'+i+1))
    endloop
    call SaveInteger(HY,hu,'EinF',count-1)
  else
    call SetUbersplatRenderAlways(LoadUbersplatHandle(HY,h,3),IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(dummy)) or IsObserver(GetLocalPlayer()) or (IsUnitVisible(dummy,GetLocalPlayer())))
  endif
  set t=null
  return false
endfunction

function CircleEyes takes unit source, real x, real y returns nothing
  local unit u
  local real angle
  local integer k=12
  local integer i=1
  loop
    set u=CreateUnit(GetOwningPlayer(source),'h0BO',x+800*Cos(bj_DEGTORAD*30*i),y+800*Sin(bj_DEGTORAD*30*i),30*i)
    
    
    set i=i+1
    exitwhen i>k
  endloop
  set u=null
endfunction

function EyeInTheForest takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer hu=GetHandleId(GetOwningPlayer(u))
  local destructable d=GetSpellTargetDestructable()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer c=LoadInteger(HY,hu,'EinF')
  local unit dummy=CreateUnit(GetOwningPlayer(u),'ewsp',GetDestructableX(d),GetDestructableY(d),0)
  local ubersplat ub=CreateUbersplat(GetUnitX(dummy),GetUnitY(dummy),"EINF",255,255,255,40,false,false)
  local unit Caster=CreateUnit(GetOwningPlayer(dummy),'e00E',GetUnitX(dummy),GetUnitY(dummy),0)
  call UnitAddAbility2(Caster,'A44T')
  call IssueTargetOrderById(Caster,852069,dummy)
  set Caster=null
  //call CircleEyes(u,GetUnitX(dummy),GetUnitY(dummy))
  call SetUnitPathing(dummy,false)
  call SetUnitX(dummy,GetDestructableX(d))
  call SetUnitY(dummy,GetDestructableY(d))
  call UnitRemoveType(dummy,UNIT_TYPE_PEON)
  call PauseUnit(dummy,true)
  call TriggerRegisterDeathEvent(t,d)
  call TriggerRegisterTimerEvent(t,0.5,true)
  call TriggerAddCondition(t,Condition(function EyeInTheForestDeath))
  call SaveDestructableHandle(HY,GetHandleId(GetOwningPlayer(u)),'EinF'+c+1,d)
  call SaveInteger(HY,hu,'EinF',c+1)
  call SaveInteger(HY,h,0,hu)
  call SaveInteger(HY,h,1,c+1)
  call SaveUnitHandle(HY,h,2,dummy)
  call SaveUbersplatHandle(HY,h,3,ub)
  set ub=null
  set dummy=null
  set t=null
  set d=null
  set u=null
endfunction

function EyesInTheForest_Remove takes nothing returns nothing
  call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A01V',false)
endfunction

function EyesInTheForest_Add takes nothing returns nothing
  call UnitAddAbility2(tt_unit1,'A01V')
  call SetPlayerAbilityAvailable(GetOwningPlayer(tt_unit1),'A01V',true)
endfunction

function Find_Trees_Targets takes nothing returns boolean
  local destructable d = GetFilterDestructable()
  local real x
  local real y
  
  if(IsValidTree(d)or GetDestructableTypeId(d)=='B005')and GetWidgetLife(d)>0 then
    set x = GetWidgetX(d) - group_temp_real[201]
    set y = GetWidgetY(d) - group_temp_real[202]
    
    if group_temp_real[200] > SquareRoot(x*x + y*y)then
      call SaveBoolean(MHT,99999,99995,true)
    endif
  endif
  set d=null
  return false
endfunction

function Find_Trees takes real x, real y, real range returns boolean
  local rect r = null
  
  set group_temp_real[200] = range
  set group_temp_real[201] = x
  set group_temp_real[202] = y
  set range = range + 150
  
  set r = Rect(x-range,y-range,x+range,y+range)
  
  call SaveBoolean(MHT,99999,99995,false)
  call EnumDestructablesInRect(r,Condition(function Find_Trees_Targets),null)
  
  call RemoveRect(r)
  set r = null
  
  return LoadBoolean(MHT,99999,99995)
endfunction

function Tree_Invis_Cancel takes unit u returns nothing
  if GetUnitAbilityLevel(u,'B021')>0 then
    call SaveBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"),false)
    call UnitRemoveAbility(u,'B021') //removes buffs, so that the timer will detect the lack of invis and end the spell
    call UnitRemoveAbility(u,'B0E9')
    call UnitRemoveAbility(u,'A1GA')
    call UnitRemoveAbility(u,'A23N')
  endif
endfunction

function Tree_Invis_Duration takes nothing returns nothing
  local unit d = null
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local boolean b1 = GetUnitAbilityLevel(u,'B021')==0
  local boolean b2 = Find_Trees(GetWidgetX(u),GetWidgetY(u),375)
  
  if LoadBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility")) and LoadBoolean(MHT,info,0) and b1 and b2 and count>1 then
    set d = CreateUnit(GetOwningPlayer(u),'e00E',GetWidgetX(u),GetWidgetY(u),0)
    call UnitAddAbility(d,'A01Z')
    call SetUnitAbilityLevel(d,'A01Z',LoadInteger(MHT,info,2))
    
    call IssueTargetOrder(d,"invisibility",u)
    call SaveInteger(MHT,info,0,count - 1)
    
    set d = null
    set u = null
    set t = null
    return
  endif
  
  if count==0 or IsDead(u) or b1 then
    call SaveBoolean(MHT,info,0,false)
    call UnitRemoveAbility(u,'B0E9')//speed buff
    call UnitRemoveAbility(u,'B021')//invis buff
    call UnitRemoveAbility(u,'A1GA')//perma invis
    call UnitRemoveAbility(u,'A23N')//speed aura
    
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  
  call SaveInteger(MHT,info,0,count - 1)
  
  if b2 then
    call SaveInteger(MHT,info,1,0)
  else
    set count = LoadInteger(MHT,info,1)
    
    if count==9 then
      call UnitRemoveAbility(u,'B0E9')
      call UnitRemoveAbility(u,'B021')
      call UnitRemoveAbility(u,'A23N')
      call UnitRemoveAbility(u,'A1GA')
      
      call Timer_End(t)
    else
      call SaveInteger(MHT,info,1,count + 1)
    endif
  endif
  
  set t = null
  set u = null
endfunction

function Tree_Invis_Self takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  
  if IsDead(u)==false and GetUnitAbilityLevel(u,'B021')>0 then
    call UnitAddAbility2(u,'A1GA')
    call TimerStart(t,0.1,true,function Tree_Invis_Duration)
    call SaveInteger(MHT,info,0,LoadInteger(MHT,info,0) - 20)
    call SaveBoolean(MHT,info,0,true)
    call SaveBoolean(MHT,GetHandleId(u),StringHash("TreeInvisibility"),true)
    
    set t = null
    set u = null
    return
  endif
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Tree_Invis_Remove takes nothing returns nothing
  local timer t = GetExpiredTimer()
  
  call UnitRemoveAbility(LoadUnitHandle(MHT,GetHandleId(t),0),'B021')
  
  call Timer_End(t)
  set t = null
endfunction

function Tree_Invis_Start takes nothing returns nothing
  local unit u = null
  local unit d = GetSpellTargetUnit()
  local timer t = CreateTimer()
  local integer info
  local integer level
  
  if Find_Trees(GetWidgetX(d),GetWidgetY(d),375)==false then //prevents the spell from starting if the target is not near any trees
    call TimerStart(t,0,false,function Tree_Invis_Remove)
    
    call SaveUnitHandle(MHT,GetHandleId(t),0,d)
    call UnitRemoveAbility(d,'B021')
    
    set d = null
    return
  endif
  
  set u = GetTriggerUnit()
  set info = GetHandleId(t)
  set level = GetUnitAbilityLevel(u,'A01Z')
  
  call SaveUnitHandle(MHT,info,0,d)
  call SaveInteger(MHT,info,0,level*150)
  call SaveInteger(MHT,info,1,0)
  call SaveInteger(MHT,info,2,level)
  call SaveBoolean(MHT,info,0,false)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Invisibility\\InvisibilityTarget.mdl",d,"chest"))
  
  call UnitAddAbility2(d,'A23N')
  
  if u==d then
    call TimerStart(t,2,false,function Tree_Invis_Self)
    
    set d = null
    set u = null
    set t = null
    return
  endif
  
  call TimerStart(t,0.1,true,function Tree_Invis_Duration)
  
  set d = null
  set u = null
  set t = null
endfunction

function Tree_Armour_Closest takes unit u returns nothing
  local real x = GetWidgetX(u) - group_temp_real[0]
  local real y = GetWidgetY(u) - group_temp_real[1]
  local real d = SquareRoot(x*x + y*y)
  
  if group_temp_real[2] > d then
    set group_temp_real[2] = d
    set group_temp_unit[1] = u
  endif
endfunction

function Tree_Armour_Structures takes integer id returns boolean
  return id=='u00M' or id=='u00N' or id=='u00D' or id=='u00T' or id=='usep' or id=='utod' or id=='unpl' or id=='e00R' or id=='e011' or id=='e00S' or id=='e019' or id=='eaom' or id=='eaoe' or id=='etol'
endfunction

function Tree_Armour_Find_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t)) and (IsUnitType(t,UNIT_TYPE_HERO) or (IsUnitType(t,UNIT_TYPE_STRUCTURE)and Tree_Armour_Structures(GetUnitTypeId(t)))) and IsDead(t)==false then
    call Tree_Armour_Closest(t)
  endif
  set t = null
  return false
endfunction

function Tree_Armour_Find takes unit u returns unit
  set group_temp_unit[0] = u
  set group_temp_unit[1] = null
  set group_temp_real[0] = GetSpellTargetX()
  set group_temp_real[1] = GetSpellTargetY()
  set group_temp_real[2] = 99999
  
  call GroupEnumUnitsInRange(temp_group,0,0,99999,Condition(function Tree_Armour_Find_Targets))
  
  return group_temp_unit[1]
endfunction

function Tree_Armour_End takes nothing returns boolean
  local unit u = null
  local trigger trig = GetTriggeringTrigger()
  local integer info = GetHandleId(trig)
  local integer count = LoadInteger(MHT,info,0)
  local integer limit=LoadInteger(MHT,info,15)
  if count==limit-1 or GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    set u = LoadUnitHandle(MHT,info,0)
    
    call Buff_Remove(u,LoDBuff_BuffID[26])
    
    call LoDStat_Sub(u,LoadInteger(MHT,info,1),"regen")
    call DestroyEffect(LoadEffectHandle(MHT,info,1))
    
    set count = LoadInteger(MHT,GetHandleId(u),'A509')
    
    if count==1then
      call UnitRemoveAbility(u,'A509')
    endif
    
    call SaveInteger(MHT,GetHandleId(u),'A509',count - 1)
    
    call FlushChildHashtable(MHT,info)
    call CleanTrigger(trig)
    set trig = null
    set u = null
  endif
  
  if GetEventDamage()>5 then
    if IsUnitType(GetEventDamageSource(),UNIT_TYPE_HERO)==false then
      call Damage_Block(GetTriggerUnit(),GetEventDamage(),true)
    endif
    call SaveInteger(MHT,info,0,count+1)
  endif
  
  set trig = null
  return false
endfunction

function Tree_Armour_Start takes nothing returns nothing
  local trigger t = CreateTrigger()
  local unit u = GetTriggerUnit()
  local unit u2 = GetSpellTargetUnit()
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A2ML')
  local integer amount = 1 + 3*level
  local integer limit=3+level
  if GetUnitTypeId(u)=='e00C'then //multicast
    set u = udg_Hero[GetPlayerId(GetOwningPlayer(u))]
    set level = GetUnitAbilityLevel(u,'A2ML')
    set amount = 1 + 3*level
    set limit=3+level
  endif
  
  if u2==null then
    set u2 = Tree_Armour_Find(u)
  endif
  
  call Buff_Add(u2,LoDBuff_AbilID[26],LoDBuff_BuffID[26],15)
  call LoDStat_Add(u2,amount,"regen")
  call UnitAddAbility2(u2,'A509')
  call UnitMakeAbilityPermanent(u2,true,'A508')
  call SetUnitAbilityLevel(u2,'A508',level)
  
  call SaveUnitHandle(MHT,info,0,u2)
  call SaveEffectHandle(MHT,info,1,AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\EntanglingRoots\\EntanglingRootsTarget.mdl",u2,"chest"))
  
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,amount)
  call SaveInteger(MHT,info,15,limit)
  
  call TriggerAddCondition(t,Condition(function Tree_Armour_End))
  call TriggerRegisterUnitEvent(t,u2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,15,false)
  
  set info = GetHandleId(u2)
  
  call SaveInteger(MHT,info,'A509',LoadInteger(MHT,info,'A509') + 1)
  
  set u2 = null
  set u = null
  set t = null
endfunction



function DIF takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real DJF=LoadReal(HY,h,21)
  call SetWidgetLife(Target,GetWidgetLife(Target)+DJF)
  set Source=null
  set Target=null
endfunction

function DKF takes nothing returns nothing
  local trigger t=AddProjectile(F68,GetEnumUnit(),'h0D8',"DIF",400,false)
  call SaveReal(HY,GetHandleId(t),21,FL8*1.)
  set t=null
endfunction

function DMF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local group g
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Target,'A272')
    call UnitRemoveAbility(Target,'B0EL')
  else
    if GetTriggerEvalCount(t)>6 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UnitRemoveAbility(Target,'A272')
      call UnitRemoveAbility(Target,'B0EL')
    endif
    call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",Target,"origin"))
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),525,Condition(function L08))
    set F68=Target
    set FL8=12+12*Level
    call ForGroup(g,function DKF)
    call KillGroup(g)
    call DamageTarget(Source,Target,1,FL8)
  endif
  set t=null
  set Source=null
  set Target=null
  set g=null
  return false
endfunction

function DNF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Target,'A272')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A272',false)
  call TriggerRegisterTimerEvent(t,0.75,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function DMF))
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,442,TimerGetElapsed(GlobalTimer)*1.)
  call SaveInteger(HY,h,5,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=null
  set Source=null
  set Target=null
endfunction

function Treant_LeechSeed takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call DNF()
  endif
endfunction




function Silencer_Last_Word_Effect takes nothing returns nothing
  local timer t = GetExpiredTimer()
  
  call DestroyEffect(LoadEffectHandle(MHT,GetHandleId(t),0))
  
  call Timer_End(t)
  set t = null
endfunction

function Silencer_Last_Word_End takes unit u, integer level, boolean disable returns nothing
  local timer t = null
  local unit d = CreateUnit(GetOwningPlayer(u),'e00E',0,0,0)
  local integer info = GetHandleId(u)
  local integer count = LoadInteger(MHT,info,'A2NT')-1
  local unit cho= LoadUnitHandle(MHT,GetHandleId(u),StringHash("lastworded"))
  
  if disable then //disables attacks
    set t = CreateTimer()
    
    call UnitAddAbility(d,'Z051')
    call SetUnitAbilityLevel(d,'Z051',level)
    
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LastWordDamageSpell.mdx",u,"overhead"))
    
    call SaveEffectHandle(MHT,GetHandleId(t),0,AddSpecialEffectTarget("Abilities\\Spells\\Other\\Silence\\SilenceTarget.mdl",u,"overhead"))
    call TimerStart(t,3,false,function Silencer_Last_Word_Effect)
    
    set t = null
  else
    call UnitAddAbility(d,'A0LS')
    call SetUnitAbilityLevel(d,'A0LS',level)
  endif
  
  call IssueTargetOrderById(d,852585,u)
  call SaveInteger(MHT,info,'A2NT',count)
  
  if count==0 then
    call Buff_Remove(u,LoDBuff_BuffID[7])
  endif
  
  call DamageTarget(cho,u,1,(100 + (50*level)))
  set d = null
  set cho=null
endfunction

function Silencer_Last_Word_Cast takes unit u returns nothing
  if GetUnitAbilityLevel(u,LoDBuff_BuffID[7])>0 then
    call Silencer_Last_Word_End(u,GetUnitAbilityLevel(u,LoDBuff_AbilID[7]),false)
  endif
endfunction

function MyLastWord_End takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local unit dummy=LoadUnitHandle(HY,h,2)
  local unit disabler
  local eventid tid=GetTriggerEventId()
  local integer lvl=LoadInteger(HY,h,3)
  local integer temp
  if tid==EVENT_UNIT_SPELL_EFFECT then
    set temp=GetSpellAbilityId()
    if isAintItemAbility(temp) and isDummyAbility(temp)==false and isPoisonArrowSkill(temp)==false and isItemSpellOrNoCd(temp)==false and IsItemAbilityById(temp)==false then
      call DamageTarget(caster,target,1,lvl*50+100)
      call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LastWordDamageSpell.mdx",target,"overhead"))
      set disabler=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
      call UnitAddAbility(disabler,'A0LS')
      call SetUnitAbilityLevel(disabler,'A0LS',lvl)
      call IssueTargetOrder(disabler,"drunkenhaze",target)
      call DestroyEffect(LoadEffectHandle(HY,h,4))
      call RemoveUnit(dummy)
      call CleanTrigger(t)
      call FlushChildHashtable(HY,h)
    endif
  elseif tid==EVENT_UNIT_DEATH then
    call DestroyEffect(LoadEffectHandle(HY,h,4))
    call RemoveUnit(dummy)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  elseif LoadReal(HY,h,5)+5<=TimerGetElapsed(GlobalTimer) then
    call DamageTarget(caster,target,1,lvl*50+100)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\LastWordDamageSpell.mdx",target,"overhead"))
    set disabler=CreateUnit(GetOwningPlayer(target),'e00E',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(disabler,'Z051')
    call SetUnitAbilityLevel(disabler,'Z051',lvl)
    call IssueTargetOrder(disabler,"drunkenhaze",target)
    call DestroyEffect(LoadEffectHandle(HY,h,4))
    call RemoveUnit(dummy)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  else
    call SetUnitX(dummy,GetUnitX(target))
    call SetUnitY(dummy,GetUnitY(target))
  endif
  set t=null
  set dummy=null
  set target=null
  set caster=null
  set disabler=null
  set tid=null
endfunction

function Silencer_LastWord takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  local unit dummy=CreateUnit(GetOwningPlayer(caster),'o019',GetUnitX(target),GetUnitY(target),0)
  local real time=TimerGetElapsed(GlobalTimer)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterTimerEvent(t,0.1,true)//50 triggers
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function MyLastWord_End))
  call SaveUnitHandle(HY,h,0,caster)
  call SaveUnitHandle(HY,h,1,target)
  call SaveUnitHandle(HY,h,2,dummy)
  call SaveInteger(HY,h,3,lvl)
  
  call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("war3mapImported\\LastWordDebuff_6.mdx",target,"overhead"))
  call SaveReal(HY,h,5,time)
  set t=null
  set caster=null
  set target=null
  set dummy=null
endfunction

function Silencer_Glaive_Hit takes unit attacker, unit target returns nothing
  local real d=(.15+.15*I2R(GetUnitAbilityLevel(attacker,'A0LZ')))*GetHeroMainStatValue(attacker)
  call UnitRemoveAbility(target,'B05X')
  call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,3,216,216,216)
  call DamageTarget(attacker,target,3,d)
endfunction

function DUF takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit2
  local real Damage=(LoadReal(HY,h,(20)))
  call SetHeroInt(Source,GetHeroInt(Source,false)+2,true)
  call TextTagOnUnit("+2 "+GetObjectName('n0JP'),3,Source,.023,0,255,0,230)
  set Source=null
endfunction

function Silencer_IntSteal_Distrib takes nothing returns nothing
  local unit Source=GetEnumUnit()
  local unit victim=GetTriggerUnit()
  set StolenInt[GetPlayerId(GetOwningPlayer(Source))]=StolenInt[GetPlayerId(GetOwningPlayer(Source))]+2
  call TextTagOnUnit("-2 "+GetObjectName('n0JP'),3,victim,.023,255,0,0,230)
  call SetHeroInt(victim,GetHeroInt(victim,false)-2,true)
  call AddProjectile(victim,Source,'h0CP',"DUF",800,false)
  set Source=null
  set victim=null
endfunction

function Silencer_IntSteal_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and GetUnitAbilityLevel(GetFilterUnit(),'A0LZ')>0 and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
endfunction

function Silencer_IntSteal takes unit killer, unit victim returns nothing
  local group g
  set g=GetAvailableGroup()
  set tt_unit1=victim
  call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),925,Condition(function Silencer_IntSteal_Filter))
  if IsUnitType(killer,UNIT_TYPE_HERO)==false then
    set killer=udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
  endif
  if GetUnitAbilityLevel(killer,'A0LZ')>0 and IsDead(killer)==false and IsUnitEnemy(killer,GetOwningPlayer(victim)) then
    call GroupAddUnit(g,killer)
  endif
  if FirstOfGroup(g)!=null then
    call ForGroup(g,function Silencer_IntSteal_Distrib)
  endif
  call KillGroup(g)
  set g=null
endfunction

function Silencer_Glaives_Stats_Display takes nothing returns boolean
  local player p = GetTriggerPlayer()
  local integer YO8=StolenInt[GetPlayerId(p)]
  if YO8>0 then
    call DisplayTimedTextToPlayer(p,0,I3,10.,GetObjectName('n0HM')+" "+I2S(YO8))
  endif
  set p=null
  return false
endfunction

function CurseOfTheSilence_SpellFilter takes integer id returns boolean
  return id!='A12W' and id!='A0FO' and id!='A1MO' and id!='A1ZI' and id!='A28Y' and isDummyAbility(id)==false and isAintItemAbility(id) and id!='A06K' and IsItemAbilityById(id)==false
endfunction

function D0F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,5)
  local integer Count=LoadInteger(HY,h,34)
  if GetTriggerEventId()!=EVENT_UNIT_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and Count<6then
    set Count=Count+1
    call SaveInteger(HY,h,34,Count)
    call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-8*Level)
    call DamageTarget(Source,Target,1,5+15*Level)
  endif
  if Count>=6 or GetUnitAbilityLevel(Target,'A1PS')==0 or GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and CurseOfTheSilence_SpellFilter(GetSpellAbilityId()))then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call UnitRemoveAbility(Target,'A1PS')
    call UnitRemoveAbility(Target,'B0CQ')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function D5F takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local integer Level=Silencer_CurseOfSilence_Level//GetUnitAbilityLevel(Source,'A14L')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Target,'A1PS')
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function D0F))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareTarget.mdl",Target,"overhead")))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(34),(0))
  set Source=null
  set Target=null
  set t=null
endfunction

function Silencer_CurseOfSilence takes nothing returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=GetTriggerUnit()
  call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),375,Condition(function D99))
  set Silencer_CurseOfSilence_Level=GetUnitAbilityLevel(tt_unit1,'A14L')
  call ForGroup(g,function D5F)
  call ZD8("war3mapImported\\CotS.mdx",GetSpellTargetX(),GetSpellTargetY(),5)
  call KillGroup(g)
  set g=null
endfunction

function Silencer_GlobalSilence_Volume takes nothing returns boolean
  call CleanTrigger(GetTriggeringTrigger())
  call VolumeGroupReset()
  return false
endfunction

function Silencer_GlobalSilence_Filter takes nothing returns boolean
  return IsMagicImmune(GetFilterUnit())==false and(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))==true and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))
endfunction

function Silencer_GlobalSilence_AghBonus takes nothing returns nothing
  local group g
  local integer l=4
  if l>0 then
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,0,0,9999,Condition(function Silencer_GlobalSilence_Filter))
    set Silencer_CurseOfSilence_Level=4
    call ForGroup(g,function D5F)
    call KillGroup(g)
  endif
  set g=null
endfunction

function Silencer_GlobalSilence_Start takes nothing returns nothing
  local location YT9=GetUnitLoc(GetTriggerUnit())
  local trigger t=CreateTrigger()
  local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),'A0L3')
  if lvl==0 then
    set lvl=1+GetUnitAbilityLevel(GetTriggerUnit(),'A2QC')
    call Silencer_GlobalSilence_AghBonus()
  endif
  call TriggerRegisterTimerEvent(t,lvl+3,false)
  call TriggerAddCondition(t,Condition(function Silencer_GlobalSilence_Volume))
  call CreateNUnitsAtLoc(1,'e00E',GetOwningPlayer(GetTriggerUnit()),YT9,bj_UNIT_FACING)
  call ShowUnitHide(bj_lastCreatedUnit)
  call UnitApplyTimedLifeBJ(5.,'BTLF',bj_lastCreatedUnit)
  call UnitAddAbility(bj_lastCreatedUnit,'A0L2')
  call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0L2',GetUnitAbilityLevel(GetTriggerUnit(),'A0L3'))
  call IssuePointOrderByIdLoc(bj_lastCreatedUnit,852592,YT9)
  call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_UNITSOUNDS,.0)
  call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_COMBAT,.0)
  call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_SPELLS,.0)
  call VolumeGroupSetVolume(SOUND_VOLUMEGROUP_MUSIC,.0)
  call RemoveLocation(YT9)
  set t=null
  set YT9=null
endfunction

function Sniper_TakeAim_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  call SetUnitAcquireRange(u,GetUnitAcquireRange(u) + 100)
  call SetPlayerTechResearched(GetOwningPlayer(u),'R005',GetUnitAbilityLevel(u,'A03U')+GetUnitAbilityLevel(u,'QP1Q'))
  set u = null
endfunction

function SniperHeadshotWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'P102')!=0 and PRD_Get(UDSG_Attacker,'P102',40) then
    call UnitAddAbilityTimedExF(UDSG_Target,'A469',1,0.5,'B469')
  endif
endfunction

function E9F takes nothing returns nothing
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE)==false then
    call DamageTarget(F58,GetEnumUnit(),1,G48)
    call IssueTargetOrderById(F28,852075,GetEnumUnit())
  else
    call DamageTarget(F58,GetEnumUnit(),1,G48/ 3)
    call IssueTargetOrderById(F28,852075,GetEnumUnit())
  endif
endfunction

function EDF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local integer Level=LoadInteger(HY,h,5)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local group g=GetAvailableGroup()
  local real d
  local real a
  local real x2
  local real y2
  local unit u
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,475,Condition(function LB8))
  //call ForGroup(g,function E9F)
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    if IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
      call DamageTarget(Source,u,1,Level*12)
      call IssueTargetOrderById(Caster,852075,u)
    endif
    call GroupRemoveUnit(g,u)
  endloop
  call KillGroup(g)
  call DestroyEffect(LoadEffectHandle(HY,h,309))
  call DestroyEffect(LoadEffectHandle(HY,h,175))
  call DestroyEffect(LoadEffectHandle(HY,h,176))
  call DestroyEffect(LoadEffectHandle(HY,h,177))
  call DestroyEffect(LoadEffectHandle(HY,h,178))
  call DestroyEffect(LoadEffectHandle(HY,h,179))
  call DestroyEffect(LoadEffectHandle(HY,h,180))
  call DestroyEffect(LoadEffectHandle(HY,h,330))
  call DestroyEffect(LoadEffectHandle(HY,h,331))
  if GetTriggerEvalCount(t)==11 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set d=0
    set a=0
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,309,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=150
    set a=45
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,175,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=275
    set a=90
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=150
    set a=135
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,177,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=275
    set a=180
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,178,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=150
    set a=225
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,179,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=275
    set a=270
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,180,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=150
    set a=305
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,330,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
    set d=275
    set a=360
    set x2=x+d*Cos(a*bj_DEGTORAD)
    set y2=y+d*Sin(a*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,331,AddSpecialEffect("Abilities\\Weapons\\FlyingMachine\\FlyingMachineImpact.mdl",x2,y2))
  endif
  set t=null
  set Source=null
  set Caster=null
  set g=null
  return false
endfunction

function EEF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,0)
  local real x1=LoadReal(HY,h,6)
  local real y1=LoadReal(HY,h,7)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x1,y1,0)
  local real x2
  local real y2
  local real d
  local real a
  local integer i
  call UnitAddAbility2(Caster,'A19F')
  call SetUnitAbilityLevel(Caster,'A19F',Level)
  if GetTriggerEvalCount(t)==1 then
    set i=1
    loop
      exitwhen i>10
      set d=GetRandomReal(0,450)
      set a=GetRandomReal(0,360)
      set x2=x1+d*Cos(a*bj_DEGTORAD)
      set y2=y1+d*Sin(a*bj_DEGTORAD)
      set Caster=CreateUnit(GetOwningPlayer(Source),'e00J',GetUnitX(Source),GetUnitY(Source),90)
      call IssuePointOrderById(Caster,851984,x2,y2)
      call UnitApplyTimedLife(Caster,'BTLF',.5)
      set i=i+1
    endloop
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,19,Caster)
    call SaveReal(HY,h,6,x1*1.)
    call SaveReal(HY,h,7,y1*1.)
    call SaveInteger(HY,h,5,Level)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function EDF))
    call TriggerEvaluate(t)
  endif
  set Source=null
  set Caster=null
  set t=null
  return false
endfunction

function Sniper_Shrapnel takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call SaveInteger(HY,GetHandleId(Source),'A064',LoadInteger(HY,GetHandleId(Source),'A064')-1)
  call TimedReveal(GetOwningPlayer(Source),9.4,x,y,400)
  call TriggerRegisterTimerEvent(t,.4,true)
  call TriggerAddCondition(t,Condition(function EEF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A064'))
  set t=null
  set Source=null
endfunction

function ShrapnelRecharge takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,(h),(0)))
  local real time=(LoadReal(HY,(h),(0)))
  local integer charges=LoadInteger(HY,GetHandleId(u),'A064')
  //	call echo(I2S(charges))
  if charges < 3 then
    set time=time-0.2
    if time<=0.then
      call SaveInteger(HY,GetHandleId(u),'A064',charges+1)
      call SaveReal(HY,h,0,40.0)
    else
      call SaveReal(HY,h,0,time*1.0)
    endif
  endif
  if charges==0 or GetUnitAbilityLevel(u,'A064')==0 then
    call UnitRemoveAbility(u,'A46B')
    call UnitRemoveAbility(u,'B46B')
  elseif GetUnitAbilityLevel(u,'A064')>0 then
    call UnitAddAbility2(u,'A46B')
  endif
  set u=null
  set t=null
  return false
endfunction

function ShrapnelInitRecharging takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.2,true)
  call TriggerAddCondition(t,Condition(function ShrapnelRecharge))
  call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
  call SaveReal(HY,GetHandleId(t),0,40.)
  call SaveInteger(HY,GetHandleId(GetTriggerUnit()),'A064',3)
  call SaveTriggerHandle(HY,GetHandleId(GetTriggerUnit()),'A064',t)
  set t=null
endfunction

function ShrapnelInitRechargingForRubick takes unit rubick returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.2,true)
  call TriggerAddCondition(t,Condition(function ShrapnelRecharge))
  call SaveUnitHandle(HY,GetHandleId(t),0,rubick)
  call SaveReal(HY,GetHandleId(t),0,40.)
  call SaveInteger(HY,GetHandleId(rubick),'A064',3)
  call SaveTriggerHandle(HY,GetHandleId(rubick),'A064',t)
  call SaveBoolean(HY,GetHandleId(rubick),'A064',true)
  set t=null
endfunction

function Sniper_Shrapnel_OnCast takes nothing returns nothing
  if LoadInteger(HY,GetHandleId(GetTriggerUnit()),'A064')==0 then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"No charges left")
  endif
endfunction

function MB9 takes nothing returns nothing
  call PreloadQueryAdd('A19F')
endfunction

function SniperAghHit takes nothing returns nothing
  local unit source=tt_unit1
  local unit target=tt_unit2
  local integer h=GetHandleId(GetTriggeringTrigger())
  local integer lvl=LoadInteger(HY,h,10)
  local real dmg
  local group g=GetAvailableGroup()
  local unit u
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),350,Condition(function DefaultEnemyFilter))
  set dmg=205+150*lvl
  call GroupRemoveUnit(g,target)
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Mortar\\MortarMissile.mdl",GetUnitX(target),GetUnitY(target)))
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    call DamageTarget(source,u,1,dmg)
    call GroupRemoveUnit(g,u)
  endloop
  call DestroyEffect(LoadEffectHandle(HY,GetHandleId(LoadUnitHandle(HY,h,45)),10))
  call KillGroup(g)
  set source=null
  set target=null
endfunction

function Sniper_Agh takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=AddProjectile(caster,target,EMPTYDUMMY,"SniperAghHit",2500,false)
  local integer h=GetHandleId(t)
  local unit d=LoadUnitHandle(HY,h,45)
  local effect fx=AddSpecialEffectTarget("Abilities\\Weapons\\CannonTowerMissile\\CannonTowerMissile.mdl",d,"origin")
  call SaveInteger(HY,h,10,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
  call SaveEffectHandle(HY,GetHandleId(d),-1,fx)
  set fx=null
  set d=null
  set t=null
  set caster=null
  set target=null
endfunction

function EHF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local effect FX=(LoadEffectHandle(HY,h,(32)))
  local player p=GetOwningPlayer(Hero)
  call DestroyEffect(FX)
  call RemoveUnit(Caster)
  call UnitRemoveAbility(Target,'B06H')
  call UnitRemoveAbility(Target,'A313')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  set Caster=null
  set Target=null
  set FX=null
  set p=null
  return false
endfunction

function Sniper_Assassinate takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local player p=GetOwningPlayer(Hero)
  local unit Caster
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local string s="effects\\Snipe Target.mdx"
  if IsPlayerAlly(GetLocalPlayer(),p) or IsObserver(GetLocalPlayer()) then
    set s=""
  endif
  call UnitAddAbility2(Target,'A313')
  call ShareVision(Target,Hero,'A313')
  set Caster=CreateUnit(GetOwningPlayer(Target),'e01R',0,0,0)
  call UnitAddAbility2(Caster,'A0NI')
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget(s,Target,"overhead")))
  call TriggerRegisterTimerEvent(t,4,false)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function EHF))
  set t=null
  set Hero=null
  set Target=null
  set Caster=null
  set p=null
endfunction

function Riki_SmokeScreen takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e003',x,y,0)
  local integer Level=GetUnitAbilityLevel(Hero,'A0RG')
  local real EMF=(83+17*Level)*.01
  call SetUnitVertexColor(Caster,255,255,255,150)
  call UnitApplyTimedLife(Caster,'BTLF',6)
  call SetUnitScale(Caster,EMF,EMF,EMF)
  if IsScourge(GetOwningPlayer(Hero))then
    call UnitAddAbility2(Caster,'A019')
    call SetUnitAbilityLevel(Caster,'A019',Level)
  else
    call UnitAddAbility2(Caster,'A0E7')
    call SetUnitAbilityLevel(Caster,'A0E7',Level)
  endif
  call IssuePointOrderById(Caster,852473,x,y)
  set Hero=null
  set Caster=null
endfunction

function Backstab_Fixed takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local integer dmg=LoadInteger(MHT,GetHandleId(caster),'BACK')
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
    call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==caster and IsFakeDamage==false and GetEventDamage()>0 then
      call SaveInteger(MHT,GetHandleId(caster),'BACK',0)
      call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",target,"chest"))
      call DamageTarget(caster,target,2,dmg)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
    call RemoveSavedHandle(MHT,GetHandleId(caster),'BACK')
  endif
  set t=null
  set caster=null
  set target=null
endfunction

function Rikki_BackStab_Condition takes unit u, unit t returns nothing
  local integer level = (GetUnitAbilityLevel(u,'A0DZ')+GetUnitAbilityLevel(u,'QP07'))
  local real d
  local unit dummy
  local real multiplier
  local integer prevdmg
  local integer curdmg
  local trigger tt
  local integer h
  local integer i
  local integer ms
  if level==0 then
    return
  endif
  set d=RAbsBJ(GetUnitFacing(u)-GetUnitFacing(t))
  if d>180 then
    set d=360-d
  endif
  if LoadInteger(MHT,GetHandleId(u),'BACK')>0 then
    call SaveInteger(MHT,GetHandleId(u),'BACK',0)
  endif
  if LoadTriggerHandle(MHT,GetHandleId(u),'BACK')!=null then
    call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(MHT,GetHandleId(u),'BACK')))
    call DestroyTrigger(LoadTriggerHandle(MHT,GetHandleId(u),'BACK'))
  endif
  if IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(u)==false and d<=105 then
    set multiplier=0.25*level
    if(Mode_EB and GetUnitAbilityLevel(u,'ANic')>0) then
      set multiplier=0.4+0.1*level
    endif
    set ms=GetUnitPrimaryAttribute(u)
    if ms==1 then
      set i=GetHeroInt(u,true)
    elseif ms==2 then
      set i=GetHeroAgi(u,true)
    elseif ms==3 then
      set i=GetHeroStr(u,true)
    endif
    set curdmg=R2I(i*(multiplier))
    call SaveInteger(MHT,GetHandleId(u),'BACK',curdmg)
    set tt=CreateTrigger()
    set h=GetHandleId(tt)
    call SaveUnitHandle(HY,h,0,u)
    call SaveUnitHandle(HY,h,1,t)
    call TriggerRegisterTimerEvent(tt,5,false)
    call TriggerRegisterUnitEvent(tt,u,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(tt,t,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(tt,Condition(function Backstab_Fixed))
    call SaveTriggerHandle(MHT,GetHandleId(u),'BACK',tt)
    set tt=null
  endif
  set dummy=null
endfunction

function Riki_BlinkStrike takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real Damage=30*GetUnitAbilityLevel(Source,'A0K9')
  local trigger t
  local integer h
  local real x=GetUnitX(Target)-75*Cos(GetUnitFacing(Target)*bj_DEGTORAD)
  local real y=GetUnitY(Target)-75*Sin(GetUnitFacing(Target)*bj_DEGTORAD)
  call SetUnitX(Source,x)
  call SetUnitY(Source,y)
  call SetUnitFacing(Source,GetUnitFacing(Target))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\BlinkStrike.mdx",x,y))
  if IsUnitEnemy(Target,GetOwningPlayer(Source))then
    call DamageTarget(Source,Target,1,Damage)
    call SaveBoolean(HY,(GetHandleId(Source)),(332),(true))
    call IssueTargetOrderById(Source,851983,Target)
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function Rikimaru_BlinkStrike_OnCast takes nothing returns nothing
  call DestroyEffect(AddSpecialEffect("war3mapImported\\BlinkStrike.mdx",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
endfunction

function Riki_PermanentInvis_Periodic takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local integer i
  if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST  then
    if GetSpellAbilityId()=='A0K9' then
      call SaveReal(HeroStats,GetHandleId(GetTriggerUnit()),23,TimerGetElapsed(GlobalTimer)+4-GetUnitAbilityLevel(GetTriggerUnit(),'A00J'))
      call SaveBoolean(HeroStats,GetHandleId(GetTriggerUnit()),23,false)
      if GetUnitAbilityLevel(GetTriggerUnit(),'A30F')>0 then
        call UnitRemoveAbility(GetTriggerUnit(),'A30F')
        set i=GetUnitAbilityLevel(GetTriggerUnit(),'A00J')
        call UnitRemoveAbility(GetTriggerUnit(),'A00J')
        call UnitAddAbility2(GetTriggerUnit(),'A00J')
        call SetUnitAbilityLevel(GetTriggerUnit(),'A00J',i)
      endif
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==LoadUnitHandle(MHT,h,0) then
      call SaveReal(HeroStats,GetHandleId(GetAttacker()),23,TimerGetElapsed(GlobalTimer)+4-GetUnitAbilityLevel(GetAttacker(),'A00J'))
      call SaveBoolean(HeroStats,GetHandleId(GetAttacker()),23,false)
      if GetUnitAbilityLevel(GetAttacker(),'A30F')>0 then
        call UnitRemoveAbility(GetAttacker(),'A30F')
        set i=GetUnitAbilityLevel(GetAttacker(),'A00J')
        call UnitRemoveAbility(GetAttacker(),'A00J')
        call UnitAddAbility2(GetAttacker(),'A00J')
        call SetUnitAbilityLevel(GetAttacker(),'A00J',i)
      endif
    endif
  else
    set u=LoadUnitHandle(MHT,h,0)
    if GetUnitTypeId(u)==0 then//unit doesnt exist
      call FlushChildHashtable(HeroStats,GetHandleId(u))
      call FlushChildHashtable(MHT,h)
      call CleanTrigger(t)
    else
      if (LoadBoolean(HeroStats,GetHandleId(u),23) or LoadReal(HeroStats,GetHandleId(u),23)<TimerGetElapsed(GlobalTimer)) and GetUnitAbilityLevel(u,'A30F')==0 then
        call UnitAddAbility2(u,'A30F')
      endif
    endif
  endif
  set t=null
  set u=null
endfunction

function Riki_PermanentInvis_Learnd takes nothing returns nothing
  local unit u
  local trigger t
  local integer h
  if not Mode_BO then
    return
  endif
  set u=GetTriggerUnit()
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.2,true)
  call SaveUnitHandle(MHT,h,0,u)
  call SaveBoolean(HeroStats,GetHandleId(u),23,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_CAST)
  call TriggerAddCondition(t,Condition(function Riki_PermanentInvis_Periodic))
  set u=null
  set t=null
endfunction

function mySven_Warcry_Targets takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitAlly(LoadUnitHandle(TempHash,'A2IS','cast'),GetOwningPlayer(GetFilterUnit())) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(GetFilterUnit())==false
endfunction

function mySven_Warcry_Dur takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer c=LoadInteger(HY,h,0)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or c<=0 or GetUnitAbilityLevel(u,'C025')==0 then
    call LoDStat_Sub(u,LoadInteger(HY,h,1),"armour")
    call UnitRemoveAbility(u,'C025')
    call UnitRemoveAbility(u,'D025')
    call FlushChildHashtable(HY,h)
    call RemoveSavedHandle(HY,GetHandleId(u),'A2IS')
    call CleanTrigger(t)
  else
    call SaveInteger(HY,h,0,c-1)
  endif
  set t=null
  set u=null
endfunction

function mySven_Warcry_ForGroup takes nothing returns nothing
  local unit u=GetEnumUnit()
  local trigger t
  local integer h
  local integer hu=GetHandleId(u)
  local integer lvl=LoadInteger(TempHash,'A2IS','levl')
  if HaveSavedHandle(HY,hu,'A2IS') then
    set t=LoadTriggerHandle(HY,hu,'A2IS')
    set h=GetHandleId(t)
    call SaveInteger(HY,h,0,70)
    call LoDStat_Add(u,4*lvl,"armour")
    call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+4*lvl)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.1,true)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
    call SaveUnitHandle(HY,h,0,u)
    call SaveInteger(HY,h,0,70)
    call SaveTriggerHandle(HY,hu,'A2IS',t)
    call TriggerAddCondition(t,Condition(function mySven_Warcry_Dur))
    call LoDStat_Add(u,4*lvl,"armour")
    call SaveInteger(HY,h,1,4*lvl)
    call UnitAddAbility2(u,'C025')
  endif
  set u=null
  set t=null
endfunction

function mySven_Warcry takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local group g = GetAvailableGroup()
  call SaveUnitHandle(TempHash,'A2IS','cast',u)
  call SaveInteger(TempHash,'A2IS','levl',GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",u,"overhead"))
  call GroupEnumUnitsInRange(g,GetWidgetX(u),GetWidgetY(u),925,Condition(function mySven_Warcry_Targets))
  call ForGroup(g,function mySven_Warcry_ForGroup)
  call FlushChildHashtable(TempHash,'A2IS')
  call KillGroup(g)
  set g=null
  set u=null
endfunction

function myGodStrengthDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call UnitRemoveAbility(u,'A0WO')
  call UnitRemoveAbility(u,'A43G')
  call UnitRemoveAbility(u,'B009')
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function myGodStrength takes nothing returns nothing//A0WP
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(Hero,GetSpellAbilityId())
  call TimerStart(t,25,false,function myGodStrengthDur)
  call SaveUnitHandle(HY,h,0,Hero)
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\BattleCryCaster.mdx",Hero,"overhead"))
  call UnitAddAbility2(Hero,'A0WO')
  call UnitMakeAbilityPermanent(Hero,true,'A0WM')
  call SetUnitAbilityLevel(Hero,'A0WM',lvl)
  call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0WO',false)
  if GetSpellAbilityId()=='A43D' then
    call UnitAddAbility2(Hero,'A43G')
    call UnitMakeAbilityPermanent(Hero,true,'A43F')
    call SetUnitAbilityLevel(Hero,'A43F',lvl)
    call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A43G',false)
  endif
  set Hero=null
  set t=null
endfunction

function ECF takes nothing returns nothing
  call DamageTarget(G88,GetEnumUnit(),1,25+group_temp_integer[4]*75)
  call StunTargetLod(GetEnumUnit(),2.00)
endfunction

function E3F takes player p,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local integer AF8
  local group g=GetAvailableGroup()
  call UnitAddAbility2(Caster,'A0RZ')
  call SetUnitAbilityLevel(Caster,'A0RZ',Level)
  set tt_unit1=udg_Hero[GetPlayerId(p)]
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),280,Condition(function DefaultEnemyFilter))
  call GroupAddUnit(g,Target)
  set G88=Caster
  set group_temp_unit[0] = Target
  set group_temp_player = p
  set group_temp_integer[4]=Level
  call ForGroup(g,function ECF)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl",Target,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl",Target,"origin"))
  set Caster=null
  set g=null
endfunction

function E6F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p
  local unit Target
  local integer Level
  local unit Projectile
  local real x
  local real y
  local real TargetX
  local real TargetY
  local boolean blinked
  local real lastX
  local real lastY
  local real AM8
  local real AN8
  local real AO8
  local real AP8
  local boolean DCD
  
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if IsDisjointSpell(GetSpellAbilityId()) then
      call SaveBoolean(HY,h,0,true)
      call SaveReal(HY,h,0,GetUnitX(GetTriggerUnit()))
      call SaveReal(HY,h,1,GetUnitY(GetTriggerUnit()))
    endif
  else
    set p=(LoadPlayerHandle(HY,h,(54)))
    set Target=LoadUnitHandle(HY,h,(30))
    set Level=(LoadInteger(HY,h,5))
    set Projectile=(LoadUnitHandle(HY,h,(45)))
    set x=GetUnitX(Projectile)
    set y=GetUnitY(Projectile)
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
    set blinked=LoadBoolean(HY,h,0)
    set lastX=LoadReal(HY,h,0)
    set lastY=LoadReal(HY,h,1)
    set AM8=1000*.035
    if blinked then
      set TargetX=lastX
      set TargetY=lastY
    endif
    set AN8=AngleBetweenXY(x,y,TargetX,TargetY)
    set AO8=x+AM8*Cos(AN8*bj_DEGTORAD)
    set AP8=y+AM8*Sin(AN8*bj_DEGTORAD)
    set DCD=(LoadBoolean(HY,h,(249)))
    
    
    call SetUnitX(Projectile,AO8)
    call SetUnitY(Projectile,AP8)
    call SetUnitFacing(Projectile,AN8)
    if DistanceBetweenXY(TargetX,TargetY,AO8,AP8)<=AM8 then
      if blinked==false then
        if DCD then
          call E3F(p,Target,Level)
        endif
      endif
      call KillUnit(Projectile)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Target=null
  set Projectile=null
  set p=null
  return false
endfunction

function Sven_StormBolt takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A190')
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h07Q',GetUnitX(Source),GetUnitY(Source),AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target)))
  local boolean DCD=IsBlocked(GetSpellTargetUnit())==false
  call SaveBoolean(HY,h,(249),(DCD))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(Source)))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveInteger(HY,h,5,(Level))
  call SaveBoolean(HY,h,0,false)//is blinked?
  call SaveReal(HY,h,0,0)//last time visible X
  call SaveReal(HY,h,1,0)//last time visible Y
  call TriggerRegisterTimerEvent(t,.035,true)
  call TriggerAddCondition(t,Condition(function E6F))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
  set t=null
  set Source=null
  set Target=null
  set Projectile=null
endfunction

function Sven_StormBolt_OnCast takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function E0F takes nothing returns boolean
  return(GetUnitTypeId(GetFilterUnit())=='n01G')or(GetUnitTypeId(GetFilterUnit())=='n01C')or(GetUnitTypeId(GetFilterUnit())=='n018')or(GetUnitTypeId(GetFilterUnit())=='n004')
endfunction

function LoneDruid_Rabid takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit u
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function E0F))
  set u=FirstOfGroup(g)
  call KillGroup(g)
  call UnitAddAbility2(Caster,'A0AE')
  call SetUnitAbilityLevel(Caster,'A0AE',Level)
  call IssueTargetOrderById(Caster,852101,Source)
  if u!=null and IsDead(u)==false then
    call IssueTargetOrderById(Caster,852101,u)
  endif
  set g=null
  set Source=null
  set u=null
  set Caster=null
endfunction

function F4F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,2)
  local real time
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))then
      call SaveReal(HY,h,714,TimerGetElapsed(GlobalTimer)*1.)
    endif
  endif
  set time=LoadReal(HY,h,714)
  if time+3 < TimerGetElapsed(GlobalTimer)then
    if(LoadInteger(HY,h,34))==2 then
      call SaveInteger(HY,h,34,1)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0A7',true)
    endif
  else
    if(LoadInteger(HY,h,34))==1 then
      call SaveInteger(HY,h,34,2)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0A7',false)
    endif
  endif
  set t=null
  set u=null
  return false
endfunction

function SB_Return_Tracking takes unit bear returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerRegisterUnitEvent(t,bear,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,bear,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function F4F))
  call SaveUnitHandle(HY,h,2,bear)
  call SaveReal(HY,h,714,0.)
  call SaveInteger(HY,h,34,1)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(bear),'A0A7',true)
  set t=null
endfunction

function SpiritBearEnsnareDmg takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,0)
  local unit bear=LoadUnitHandle(HY,h,1)
  local integer c=LoadInteger(HY,h,0)+1
  call SaveInteger(HY,h,0,c)
  if GetHandleId(bear)!=0 and (GetUnitAbilityLevel(target,'B0C1')>0 or c==1) then
    call DamageTarget(bear,target,2,30)
  endif
  if IsDead(target) or (GetUnitAbilityLevel(target,'B0C1')==0 and c>1) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  elseif c==1 then
    call TimerStart(t,0.5,true,function SpiritBearEnsnareDmg)
  endif
  set target=null
  set bear=null
  set t=null
endfunction

function SpiritBear_Ensnare takes unit owner, unit target returns nothing
  local unit d=CreateUnit(GetOwningPlayer(owner),'e00E',GetUnitX(target),GetUnitY(target),0)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0,false,function SpiritBearEnsnareDmg)
  call SaveUnitHandle(HY,h,0,target)
  call SaveUnitHandle(HY,h,1,owner)
  call UnitAddAbility(d,'A1GZ')
  call IssueTargetOrder(d,"ensnare",target)
  set d=null
  set t=null
endfunction

function SpiritBearAttack takes unit attacker, unit target returns nothing
  if GetUnitAbilityLevel(attacker,'A33C')>0 and TimerGetElapsed(GlobalTimer)>LoadReal(MHT,GetHandleId(attacker),'A33C') and PRD_Get(attacker,'A33C',20) then
    call SaveReal(MHT,GetHandleId(attacker),'A33C',TimerGetElapsed(GlobalTimer)+5)
    call SpiritBear_Ensnare(attacker,target)
  endif
endfunction

function SB_FindPrevBear takes nothing returns boolean
  return IsSpiritBear(GetFilterUnit()) and GetUnitTypeId(GetFilterUnit())!='n01G' and IsDead(GetFilterUnit())==false
endfunction

function SB_GiveItems takes nothing returns nothing
  local integer h=GetHandleId(GetOwningPlayer(GetTriggerUnit()))
  local unit u=LoadUnitHandle(HY,h,334)
  local unit new=LoadUnitHandle(HY,h,333)
  if u!=null and Mode_DM==false then
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,0))
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,1))
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,2))
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,3))
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,4))
    call UnitAddItem(new,UnitRemoveItemFromSlot(u,5))
  endif
  set u=null
  set new=null
endfunction

function SpiritBear_AddCry takes unit u, integer lvl, player p, boolean b returns nothing
  if lvl==0 then
    return
  endif
  call UnitAddAbility2(u,'A34C')
  call SetUnitAbilityLevel(u,'A34C',lvl)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34C',true)
  if b then
    call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
  endif
endfunction

function LoneDruid_SpiritBear_Leveling takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local group g
  local integer Level=GetUnitAbilityLevel(u,'A0A5')
  local integer i
  local unit bear
  call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),'R000',Level)
  if Level>1 then
    set g=GetAvailableGroup()
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function SB_FindPrevBear))
    set i=CountUnitsInGroup(g)
    if(i==1)then
      set bear=FirstOfGroup(g)
      call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
      if(Level==2)then
        call ManageBonusHP(bear,400)
        call UnitAddAbility2(bear,'A0A7')
        call SB_Return_Tracking(bear)
      elseif(Level==3)then
        call ManageBonusHP(bear,500)
        call UnitAddAbility2(bear,'A33C')
      elseif(Level==4)then
        call ManageBonusHP(bear,400)
        call UnitAddAbility2(bear,'A03A')
        call UnitAddAbility2(bear,'A0AH')
      endif
      call SpiritBear_AddCry(bear,Level-1,p,true)
    endif
    call KillGroup(g)
  endif
  set g=null
  set u=null
  set bear=null
endfunction

function FOF takes nothing returns boolean
  return IsSpiritBear(GetFilterUnit()) and IsDead(GetFilterUnit())==false
endfunction

function SpiritBearGPS takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit bear=LoadUnitHandle(HY,h,0)
  local unit hero=LoadUnitHandle(HY,h,1)
  if IsDead(bear) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  else
    if DistanceBetweenUnits(bear,hero)>1425 then
      call UnitAddAbility2(bear,'A44D')
      call UnitAddAbility2(bear,'A44E')
    elseif GetUnitAbilityLevel(bear,'A44D')>0 then
      call UnitRemoveAbility(bear,'A44D')
      call UnitRemoveAbility(bear,'A44E')
    endif
  endif
  set hero=null
  set bear=null
  set t=null
endfunction

function SpiritBearTracking takes unit bear returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.2,true,function SpiritBearGPS)
  call SaveUnitHandle(HY,h,0,bear)
  call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(bear))])
  set t=null
endfunction

function LoneDruid_SpiritBear takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetOwningPlayer(u)
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(u,'A0A5')
  local integer h=GetHandleId(p)
  local unit bear
  local integer id=0
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(u),Condition(function FOF))
  if FirstOfGroup(g)==null then
    if(Level==1)then
      set id='n004'
    elseif(Level==2)then
      set id='n018'
    elseif(Level==3)then
      set id='n01C'
    else
      set id='n01G'
    endif
    set bear=CreateUnit(GetOwningPlayer(u),id,x,y,GetUnitFacing(u))
    call SpiritBear_AddCry(bear,Level-1,p,true)
    call SaveUnitHandle(HY,h,333,bear)
    call SB_GiveItems()
    call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
    call SB_Return_Tracking(bear)
    call SetUnitAbilityLevel(bear,'A09Y',Level)
    call SpiritBearTracking(bear)
  else
    set bear=FirstOfGroup(g)
    call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",bear,"chest")
    call SetWidgetLife(bear,GetUnitState(bear,UNIT_STATE_MAX_LIFE))
    call SetUnitPosition(bear,GetUnitX(u),GetUnitY(u))
  endif
  set bear=null
  call KillGroup(g)
  set u=null
  set g=null
endfunction

function LoneDruid_TrueForm takes nothing returns nothing
  call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),'R001',(GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())+1))
  if GetUnitTypeId(GetTriggerUnit())!='N015' and GetUnitTypeId(GetTriggerUnit())!='N014' and GetUnitTypeId(GetTriggerUnit())!='N013' then
    call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A344',true)
  else
    call SetPlayerAbilityAvailable(GetOwningPlayer(GetTriggerUnit()),'A344',false)
  endif
  call SetUnitAbilityLevel(GetTriggerUnit(),'A344',GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
endfunction

function TrueForm_BattleRoar takes nothing returns nothing
  local unit d=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
  call UnitAddAbility(d,'A1ED')
  call SetUnitAbilityLevel(d,'A1ED',GetUnitAbilityLevel(GetTriggerUnit(),'A344')+GetUnitAbilityLevel(GetTriggerUnit(),'A34C'))
  call IssueImmediateOrder(d,"battleroar")
  set d=null
endfunction

function LoneDruid_Return takes nothing returns nothing
  local unit bear
  local unit u
  if GetSpellAbilityId()=='A0A7' then
    set bear=GetTriggerUnit()
    set u=udg_Hero[GetPlayerId(GetOwningPlayer(bear))]
    call SetUnitX(bear,GetUnitX(u)+GetRandomReal(25,50)*Cos(GetRandomReal(0,360)))
    call SetUnitY(bear,GetUnitY(u)+GetRandomReal(25,50)*Sin(GetRandomReal(0,360)))
    set bear=null
    set u=null
  endif
endfunction

function SpiritBear_Return_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function LoneDruid_Return))
  set t=null
endfunction

function FUF takes nothing returns nothing
  local integer pid=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  if GetTriggerUnit()==udg_Hero[pid] and isPlayerPickedAbility(Player(pid),37) then
    call KillUnit(LoadUnitHandle(HY,GetHandleId(GetOwningPlayer(GetTriggerUnit())),333))
  endif
endfunction

function Lone_HeroDeath_KillBear takes unit victim returns nothing
  local integer pid=GetPlayerId(GetOwningPlayer(victim))
  if victim==udg_Hero[pid] and isPlayerPickedAbility(Player(pid),37) then
    call KillUnit(LoadUnitHandle(HY,GetHandleId(GetOwningPlayer(victim)),333))
  endif
endfunction

function FZF takes nothing returns nothing
  local location l
  if IsSentinel(GetOwningPlayer(GetTriggerUnit()))then
    set l=GetRectCenter(gg_rct_Hero_Creation_NE)
  else
    set l=GetRectCenter(gg_rct_Hero_Creation_UD)
  endif
  if IsRapierOrGem(GetEnumItem())==false then
    call SetItemPositionLoc(GetEnumItem(),l)
  endif
  call RemoveLocation(l)
  set l=null
endfunction

function FAF takes nothing returns nothing
  local integer h=GetHandleId(GetOwningPlayer(GetTriggerUnit()))
  local unit stash=LoadUnitHandle(HY,h,334)
  local unit bear=LoadUnitHandle(HY,h,333)
  local integer x
  local integer y
  if stash==null then
    if IsSentinel(GetOwningPlayer(bear))then
      set x=-6390
      set y=-5615
    else
      set x=5875
      set y=5000
    endif
    set stash=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e01F',x,y,0)
    call SaveUnitHandle(HY,h,334,stash)
  endif
  if IsRapierOrGem(GetEnumItem())==false then
    call UnitAddItem(stash,GetEnumItem())
  endif
  call ShowUnit(stash,true)
  set stash=null
  set bear=null
endfunction

function FBF takes nothing returns nothing
  local integer indexId=GetIndex(GetEnumItem())
  if GetWidgetLife(GetEnumItem())>0 and indexId!=indexid_Aegis then
    if Mode_DM then
      call FZF()
    else
      call FAF()
    endif
  endif
endfunction

function FCF takes unit attacker, unit victim returns nothing
  local location l=GetUnitLoc(victim)
  local rect r=RectFromCenterSizeBJ(l,400.,400.)
  local unit u=udg_Hero[GetPlayerId(GetOwningPlayer(victim))]
  local integer lvl=GetUnitAbilityLevel(u,'A0A5')
  call SetHeroXP(u,GetHeroXP(u) - (GetHeroXP(u)/(125-(25*lvl))),false)
  call DamageTarget(attacker,u,5,100.*I2R(lvl))
  call EnumItemsInRect(r,Condition(function ReturnTrue),function FBF)
  call RemoveLocation(l)
  call RemoveRect(r)
  set l=null
  set r=null
  set u=null
endfunction

function SpiritBear_Death takes unit attacker, unit victim returns nothing
  if IsSpiritBear(victim) and IsUnitIllusion(victim)==false then
    call FCF(attacker,victim)
  endif
endfunction

function SpiritBear_Death_Init takes nothing returns nothing
endfunction

function StunFor05 takes unit u returns nothing
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u), GetUnitY(u),0)
  call UnitAddAbility(d,'A325')
  call IssueTargetOrder(d,"thunderbolt",u)
  set d=null
endfunction

function F6F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer count=LoadInteger(HY,h,100)
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetEventDamageSource())) and GU8==false then
      if GV8==false then
        call UnitRemoveAbility(GetTriggerUnit(),'B0BM')
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      endif
    endif
    if GV8 then
      set GV8=false
    endif
    if GU8 then
      set GU8=false
    endif
  else
    set count=count+1
    call SaveInteger(HY,h,100,count)
    if count>lvl*2 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(GetTriggeringTrigger())
    else
      call StunFor05(LoadUnitHandle(HY,h,0))
    endif
  endif
  set t=null
  return false
endfunction

function Tauren_Stomp_Stun_Targets takes nothing returns boolean
  local trigger trig = null
  local unit u = GetFilterUnit()
  if IsUnitEnemy(u,group_temp_player) and GetUnitAbilityLevel(u,'A04R')==0 and GetUnitAbilityLevel(u,'B0BM')>0then
    set trig = CreateTrigger()
    
    call TriggerRegisterUnitEvent(trig,u,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trig,u,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(trig,0.5,true)
    call TriggerRegisterTimerEvent(trig,0,false)
    call TriggerAddCondition(trig,Condition(function F6F))
    call SaveInteger(HY,GetHandleId(trig),0,TempInteger)
    call SaveUnitHandle(HY,GetHandleId(trig),0,u)
    
    
    set trig = null
  endif
  set u = null
  return false
endfunction

function Tauren_Stomp_Stun takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  set group_temp_player = LoadPlayerHandle(MHT,info,0)
  set TempInteger=LoadInteger(MHT,info,0)
  call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),1000,Condition(function Tauren_Stomp_Stun_Targets))
  
  call Timer_End(t)
  set t = null
endfunction

function Tauren_Stomp_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t))then
    call DamageTarget(group_temp_unit[0],t,group_temp_integer[0],70+10*GetUnitAbilityLevel(group_temp_unit[1],'A1A9'))
    call UnitShareVision(t,group_temp_player,true)
    call IssueTargetOrder(group_temp_unit[1],"thunderbolt",t)
    call UnitShareVision(t,group_temp_player,false)
  endif
  set t = null
  return false
endfunction

function Tauren_Stomp_Spirit_Start takes nothing returns boolean
  local integer info
  local unit d = null
  local unit t = GetFilterUnit()
  local real x
  local real y
  
  if GetUnitTypeId(t)=='h07U'then
    set info = GetHandleId(t)
    
    if LoadBoolean(MHT,'A1AA',info)then
      set x = GetWidgetX(t)
      set y = GetWidgetY(t)
      set d = CreateUnit(GetOwningPlayer(t),'h07Z',x,y,0)
      
      call SetUnitTimeScale(d,2.5)
      call UnitApplyTimedLife(d,'BTLF',2)
      
      call GroupEnumUnitsInRange(temp_group2,x,y,500,Condition(function Tauren_Stomp_Targets))
      
      call SaveBoolean(MHT,'A1AA',info,false)
      call SaveBoolean(MHT,info,'A1AA',false)
      call SetUnitAnimationByIndex(t,3)
      
      set d = null
    endif
  endif
  set t = null
  return false
endfunction

function Tauren_Stomp_Effect takes nothing returns nothing
  local timer t= CreateTimer()
  local unit u = GetTriggerUnit()
  local real x = GetWidgetX(u)
  local real y = GetWidgetY(u)
  local unit d = CreateUnit(GetOwningPlayer(u),'h07Z',x,y,0)
  local integer info = GetHandleId(t)
  
  if GetUnitTypeId(u)=='e00E' then//or GetUnitTypeId(u)=='h07U'then //multicast
    set u = udg_Hero[GetPlayerId(group_temp_player)]
  endif
  
  call SetUnitTimeScale(d,2.5)
  call UnitApplyTimedLife(d,'BTLF',2)
  set group_temp_player = GetOwningPlayer(u)
  set group_temp_unit[0] = u
  set group_temp_unit[1] = CreateUnit(group_temp_player,'e00E',x,y,0)
  set group_temp_integer[0] = 1
  call UnitAddAbility(group_temp_unit[1],'A1A9')
  call GroupEnumUnitsInRange(temp_group,x,y,500,Condition(function Tauren_Stomp_Targets))
  set group_temp_integer[0] = 2
  call GroupEnumUnitsOfPlayer(temp_group,GetOwningPlayer(u),Condition(function Tauren_Stomp_Spirit_Start))
  call SavePlayerHandle(MHT,info,0,group_temp_player)
  call SaveReal(MHT,info,0,x)
  call SaveInteger(MHT,info,0,GetUnitAbilityLevel(u,'A1AA'))
  call SaveReal(MHT,info,1,y)
  call SaveUnitHandle(MHT,info,2,u)
  
  call TimerStart(t,0.65,false,function Tauren_Stomp_Stun)
  
  set d = null
  set u = null
  set t = null
endfunction

function G4F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit W39=(LoadUnitHandle(HY,h,(335)))
  local boolean G7F=(LoadBoolean(HY,h,(336)))
  
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    call SaveInteger(HY,(GetHandleId((Source))),((4269)),2)
    call SaveBoolean(HY,(GetHandleId(W39)),(337),(true))
    
    call SaveBoolean(MHT,GetHandleId(W39),'A1AA',false)
    call IssueImmediateOrder(W39,"stop")
    
    if GetUnitAbilityLevel(W39,'Aloc')==0then
      call SetUnitAnimation(W39,"stand")
    else
      call SetUnitAnimationByIndex(W39,3)
    endif
    
    if G7F then
      call ShowUnit(W39,false)
      call KillUnit(W39)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if G7F then
      call SetUnitFacing(W39,GetUnitFacing(Source))
    endif
  endif
  set t=null
  set W39=null
  set Source=null
  return false
endfunction

function Tauren_Stomp_Spirit_Effect takes unit u, unit s, boolean b returns nothing
  local trigger t = CreateTrigger()
  local integer info = GetHandleId(t)
  
  call UnitRemoveAbility(u,'A2LK')
  call SetUnitAnimation(u,"spell slam")
  call QueueUnitAnimation(u,"spell slam")
  
  call SaveUnitHandle(HY,info,(335),u)
  call SaveUnitHandle(HY,info,2,s)
  
  if b then
    call SaveBoolean(HY,info,336,true)
    call TriggerRegisterTimerEvent(t,.1,true)
  endif
  
  call TriggerRegisterUnitEvent(t,s,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function G4F))
  
  set info = GetHandleId(u)
  call SaveBoolean(MHT,'A1AA',info,true) //prevents the spirit from stomping more than once
  call SaveBoolean(MHT,info,'A1AA',true) //stops movement while returning
  
  set t = null
endfunction

function Tauren_Stomp_Spirit takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if GetUnitTypeId(t)=='h07U'then
    if IssueImmediateOrderById(t,851972)then
      call Tauren_Stomp_Spirit_Effect(t,group_temp_unit[0],false)
    endif
    call SaveBoolean(MHT,99999,99997,false)
  endif
  set t = null
  return false
endfunction

function Tauren_Stomp_Check takes nothing returns nothing
  local unit Source = GetTriggerUnit()
  local unit W39 = null
  
  if GetUnitTypeId(Source)=='e00E'then //multicast
    set group_temp_unit[0] = udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  elseif  GetUnitTypeId(Source)=='h07U' then //spirit cast
    set group_temp_unit[0] = LoadUnitHandle(MHT,GetHandleId(Source),'A1A8')
    if IssueImmediateOrderById(group_temp_unit[0],852092)==false then
      call UnitAddAbility(Source,'A2LK')
      call SetUnitAnimation(Source,"stand")
      call IssueImmediateOrder(Source,"stop")
      call SaveBoolean(MHT,GetHandleId(Source),'A1AA',false)
      call SaveBoolean(MHT,'A1AA',GetHandleId(Source),false)
      
      set Source = null
      return
    endif
  else
    set group_temp_unit[0] = Source
  endif
  
  call SaveBoolean(MHT,99999,99997,true)
  call GroupEnumUnitsOfPlayer(temp_group,GetOwningPlayer(Source),Condition(function Tauren_Stomp_Spirit))
  
  if LoadBoolean(MHT,99999,99997)then
    set W39=CreateUnit(GetOwningPlayer(Source),'h07U',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
    call UnitAddAbility2(W39,'Aloc')
    call UnitAddAbility2(W39,'Aetl')
    call SetUnitPosition(W39,GetUnitX(Source),GetUnitY(Source))
    call SetUnitScale(W39,1.4,1.4,1.4)
    call IssueImmediateOrderById(W39,851972)
    call Tauren_Stomp_Spirit_Effect(W39,group_temp_unit[0],true)
    set W39=null
  endif
  
  set Source=null
endfunction






function GDF takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1CA')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1CA')
    call UnitRemoveAbility(GetEnumUnit(),'B0BP')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1C9')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1C9')
    call UnitRemoveAbility(GetEnumUnit(),'B0BP')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1CB')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1CB')
    call UnitRemoveAbility(GetEnumUnit(),'B0BP')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1CC')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1CC')
    call UnitRemoveAbility(GetEnumUnit(),'B0BP')
  endif
  call GD9(GetEnumUnit(),0)
endfunction

function GEF takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if GF8==1 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A1CA')==0 then
      call UnitAddAbility2(GetEnumUnit(),'A1CA')
    endif
  elseif GF8==2 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A1C9')==0 then
      call UnitAddAbility2(GetEnumUnit(),'A1C9')
    endif
  elseif GF8==3 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A1CB')==0 then
      call UnitAddAbility2(GetEnumUnit(),'A1CB')
    endif
  elseif GF8==4 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A1CC')==0 then
      call UnitAddAbility2(GetEnumUnit(),'A1CC')
    endif
  endif
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
    call GD9(GetEnumUnit(),R2I((I2R(GetHeroAgi(GetEnumUnit(),true))/ 7)*I2R((GF8*20+20)/100)))
  endif
endfunction

function GFF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local group GGF=LoadGroupHandle(HY,h,340)
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g=GetAvailableGroup()
  local group g2
  local unit u = LoadUnitHandle(MHT,GetHandleId(Source),'A1A8')
  if Source==null then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillGroup(GGF)
    call KillGroup(g)
    set g=null
    return false
  endif
  set tt_unit1=Source
  set GF8=GetUnitAbilityLevel(Source,'A1CD')+GetUnitAbilityLevel(Source,'QP1I')
  call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilter))
  if u!=null then
    set g2=GetAvailableGroup()
    call GroupEnumUnitsInRange(g2,GetWidgetX(u),GetWidgetY(u),300,Condition(function DefaultEnemyFilter))
    call GroupAddGroup(g2,g)
    call KillGroup(g2)
    set g2=null
  endif
  call GroupRemoveGroup(g,GGF)
  call ForGroup(GGF,function GDF)
  if IsDead(Source)==false then
    call ForGroup(g,function GEF)
  endif
  call SaveGroupHandle(HY,h,340,g)
  call KillGroup(GGF)
  set t=null
  set Source=null
  set GGF=null
  set u = null
  set g=null
  return false
endfunction

function Chieftain_NaturalOrder_Learning takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call UnitAddAbility2(Source,'A1CQ')
  call TriggerRegisterTimerEvent(t,.3,true)
  call TriggerAddCondition(t,Condition(function GFF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveGroupHandle(HY,h,340,GetAvailableGroup())
  call SaveTriggerHandle(HY,GetHandleId(Source),338,t)
  call SaveBoolean(HY,GetHandleId(Source),339,true)
  set t=null
  set Source=null
endfunction

function GJF takes nothing returns nothing
  local real x1=GI8
  local real y1=GJ8
  local real x2=GK8
  local real y2=GM8
  local real x3=GetUnitX(GetEnumUnit())
  local real y3=GetUnitY(GetEnumUnit())
  local real u=((x3-x1)*(x2-x1)+(y3-y1)*(y2-y1))/((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
  local real x4=x1+u*(x2-x1)
  local real y4=y1+u*(y2-y1)
  local real XYE=GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*.35/ 2
  if TC_es_lvl>0 then
    call AddTimedAbility(GetEnumUnit(),'A43L',1,TC_es_lvl+3)
  endif
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
    call SetUnitPosition(GetEnumUnit(),x4,y4)
  else
    call SetUnitX(GetEnumUnit(),x4)
    call SetUnitY(GetEnumUnit(),y4)
  endif
  call IssueTargetOrderById(GG8,852095,GetEnumUnit())
  call DamageTarget(GH8,GetEnumUnit(),1,XYE)
  call DamageTarget(GH8,GetEnumUnit(),2,XYE)
endfunction

function GKF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x0=LoadReal(HY,h,282)
  local real y0=LoadReal(HY,h,283)
  local real a0=LoadReal(HY,h,341)
  local integer i=0
  local real x
  local real y
  local group g=GetAvailableGroup()
  local group AlreadyHit=GetAvailableGroup()
  local integer Level=LoadInteger(HY,h,0)
  local boolean agh=LoadBoolean(HY,h,2)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set tt_unit1=Source
  set GH8=Source
  set GG8=CreateUnit(GetOwningPlayer(Source),'e00E',x0,y0,0)
  call UnitAddAbility2(GG8,'A43M')
  call SetUnitAbilityLevel(GG8,'A43M',Level)
  
  if agh then
    set TC_es_lvl=Level
  else
    set TC_es_lvl=0
  endif
  loop
    exitwhen i>11
    set x=x0+i*200*Cos(a0)
    set y=y0+i*200*Sin(a0)
    call ZD8("Abilities\\Spells\\Orc\\EarthQuake\\EarthQuakeTarget.mdl",x,y,1.6)
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x,y-250))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x,y))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x+250,y))
    call KillTrees(x,y,300)
    call GroupEnumUnitsInRange(g,x,y,325,Condition(function DefaultEnemyFilter))
    call GroupAddGroup(g,AlreadyHit)
    call GroupClear(g)
    set i=i+1
  endloop
  set GI8=x0
  set GJ8=y0
  set GK8=x
  set GM8=y
  call ForGroup(AlreadyHit,function GJF)
  call KillGroup(AlreadyHit)
  call KillGroup(g)
  set t=null
  set Source=null
  set g=null
  set AlreadyHit=null
  return false
endfunction

function GMF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real a=LoadReal(HY,h,137)
  local real x0=LoadReal(HY,h,282)
  local real y0=LoadReal(HY,h,283)
  local real a0
  local real GNF
  local real GOF
  local real GPF
  local real GQF
  local real GRF
  local real GSF
  local real GTF
  local real GUF
  local real GVF
  local real GWF
  local real GXF
  local real GYF
  local real x
  local real y
  local integer lvl
  local ubersplat Splat
  local integer Count=GetTriggerEvalCount(t)
  local boolean agh=LoadBoolean(HY,h,2)
  set x=x0+200*Count*Cos(a)
  set y=y0+200*Count*Sin(a)
  set Splat=CreateUbersplat(x,y,"THNE",255,255,255,255,false,false)
  call SetUbersplatRenderAlways(Splat,true)
  set GNF=x+250*Cos(bj_DEGTORAD*(a*bj_RADTODEG-45))
  set GOF=y+250*Sin(bj_DEGTORAD*(a*bj_RADTODEG-45))
  set GPF=x+250*Cos(bj_DEGTORAD*(a*bj_RADTODEG+45))
  set GQF=y+250*Sin(bj_DEGTORAD*(a*bj_RADTODEG+45))
  set GRF=x-125*Cos(bj_DEGTORAD*(a*bj_RADTODEG-45))
  set GSF=y-125*Sin(bj_DEGTORAD*(a*bj_RADTODEG-45))
  set GTF=x-125*Cos(bj_DEGTORAD*(a*bj_RADTODEG+45))
  set GUF=y-125*Sin(bj_DEGTORAD*(a*bj_RADTODEG+45))
  set GVF=x
  set GWF=y
  set GXF=x
  set GYF=y
  call TimedReveal(GetOwningPlayer(Source),4,x,y,500)
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GNF,GOF))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GPF,GQF))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GRF,GSF))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GTF,GUF))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GVF,GWF))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GXF,GYF))
  if GetTriggerEvalCount(t)>11 then
    set x0=LoadReal(HY,h,282)
    set y0=LoadReal(HY,h,283)
    set a0=LoadReal(HY,h,341)
    set lvl=LoadInteger(HY,h,0)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.5,false)
    call TriggerAddCondition(t,Condition(function GKF))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveBoolean(HY,h,2,agh)
    call SaveInteger(HY,h,0,lvl)
    call SaveReal(HY,h,282,x0*1.)
    call SaveReal(HY,h,283,y0*1.)
    call SaveReal(HY,h,341,a0*1.)
  endif
  set t=null
  set Source=null
  set Splat=null
  return false
endfunction

function Chieftain_SplitEarth takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local boolean b=GetSpellAbilityId()=='A43J'
  if b then
    call TriggerRegisterTimerEvent(t,.08,true)
  else
    call TriggerRegisterTimerEvent(t,.22,true)
  endif
  call TriggerAddCondition(t,Condition(function GMF))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveBoolean(HY,h,2,b)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,GetUnitX(Source)*1.)
  call SaveReal(HY,h,7,GetUnitY(Source)*1.)
  call SaveReal(HY,h,137,a*1.)
  call SaveReal(HY,h,282,GetUnitX(Source)*1.)
  call SaveReal(HY,h,283,GetUnitY(Source)*1.)
  call SaveReal(HY,h,341,a*1.)
  set t=null
  set Source=null
endfunction

function Tauren_Spirit_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  
  call LoDStat_Sub(u,LoadInteger(MHT,info,3),"damage")
  call SubBonusMSPercent(u,R2I(LoadReal(MHT,info,0)))
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Tauren_Spirit_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local group g = LoadGroupHandle(MHT,group_temp_integer[0],2)
  
  if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitInGroup(t,g)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    if IsUnitType(t,UNIT_TYPE_HERO)then
      call SaveInteger(MHT,group_temp_integer[0],4,LoadInteger(MHT,group_temp_integer[0],4) + 1)
    else
      call SaveInteger(MHT,group_temp_integer[0],3,LoadInteger(MHT,group_temp_integer[0],3) + 1)
    endif
    
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",t,"chest"))
    call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[1])
    call GroupAddUnit(g,t)
  endif
  set g = null
  set t = null
  return false
endfunction

function Tauren_Spirit_Return takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer i3
  local integer i2
  local integer i1
  local unit u = LoadUnitHandle(MHT,info,0)
  local unit d = LoadUnitHandle(MHT,info,1)
  local real x2 = GetWidgetX(u)
  local real y2 = GetWidgetY(u)
  local real x1 = GetWidgetX(d)
  local real y1 = GetWidgetY(d)
  local real angle = Atan2(y2-y1,x2-x1)
  if LoadBoolean(MHT,GetHandleId(d),'A1AA') then
    set d = null
    set u = null
    set t = null
    return
  endif
  
  set x1 = x1 + 15*Cos(angle)
  set y1 = y1 + 15*Sin(angle)
  
  call SetUnitX(d,x1)
  call SetUnitY(d,y1)
  call SetUnitFacing(d,angle*bj_RADTODEG)
  
  set group_temp_unit[0] = u
  set group_temp_integer[0] = info
  set group_temp_integer[1] = LoadInteger(MHT,info,2)
  
  call GroupEnumUnitsInRange(temp_group,x1,y1,300,Condition(function Tauren_Spirit_Targets))
  
  if 100 > SquareRoot((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2)) then
    set i3 = LoadInteger(MHT,info,1)
    set i2 = LoadInteger(MHT,info,3)
    set i1 = LoadInteger(MHT,info,4)
    
    if i1 + i2 > 0 then
      set x1 = (i2 + i1*5)//100.
      set i3 = i2*3*i3 + i1*10*i3
      
      call Buff_Add(u,LoDBuff_AbilID[15],LoDBuff_BuffID[15],9)
      
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"chest"))
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"origin"))
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"hand,left"))
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"hand,right"))
      
      call SaveInteger(MHT,info,3,i3)
      call SaveReal(MHT,info,0,x1)
      
      call AddBonusMSPercent(u,R2I(x1))
      call LoDStat_Add(u,i3,"damage")
      
      call TimerStart(t,9,false,function Tauren_Spirit_End)
    else
      call Timer_End(t)
    endif
    
    set info = GetHandleId(u)
    set i1 = LoadInteger(MHT,info,'A1A8')
    
    call SaveInteger(MHT,info,'A1A8',i1 - 1)
    
    if i1==1then
      call UnitRemoveAbility(u,'A21J')
      call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1A8',true)
    endif
    
    call FlushChildHashtable(MHT,GetHandleId(d))
    call RemoveUnit(d)
  endif
  
  set d = null
  set u = null
  set t = null
endfunction

function Tauren_Spirit_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local unit d = LoadUnitHandle(MHT,info,1)
  local real x = GetWidgetX(d)
  local real y = GetWidgetY(d)
  
  set group_temp_unit[0] = u
  set group_temp_integer[0] = info
  set group_temp_integer[1] = LoadInteger(MHT,info,2)
  
  call GroupEnumUnitsInRange(temp_group,x,y,300,Condition(function Tauren_Spirit_Targets))
  
  if count==80 or LoadBoolean(MHT,GetHandleId(u),'A1A8') or LoadBoolean(MHT,GetHandleId(d),'A1A8')then
    call UnitAddAbility(d,'Aloc')
    call SetUnitAnimationByIndex(d,1)
    call IssueImmediateOrder(d,"stop")
    call SaveBoolean(MHT,info,0,true)
    
    call TimerStart(t,0.025,true,function Tauren_Spirit_Return)
    
    set d = null
    set u = null
    set t = null
    return
  endif
  
  call SetUnitMoveSpeed(d,GetUnitMoveSpeedLOD(u))
  call SaveInteger(MHT,info,0,count+1)
  
  set d = null
  set u = null
  set t = null
endfunction

function Tauren_Spirit_Reset takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  
  call UnitRemoveAbility(u,'A21J')
  call UnitAddAbility2(u,'A21J')
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Tauren_Spirit_Stop takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call SaveBoolean(MHT,GetHandleId(u),'A1A8',true)
  
  call TimerStart(t,0,false,function Tauren_Spirit_Reset)
  
  set t = null
  set u = null
endfunction

function Tauren_Spirit_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local unit d = CreateUnit(p,'h07U',GetSpellTargetX(),GetSpellTargetY(),GetUnitFacing(u)-180)
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A1A8')
  local integer id
  call SaveBoolean(MHT,info,0,false)
  call SaveUnitHandle(MHT,info,0,u)
  call SaveUnitHandle(MHT,info,1,d)
  call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,level)
  call SaveInteger(MHT,info,2,20 + 40*level)
  call SaveInteger(MHT,info,3,0)
  call SaveInteger(MHT,info,4,0)
  set info = GetHandleId(u)
  call SaveBoolean(MHT,info,'A1A8',false)
  call SaveInteger(MHT,info,'A1A8',LoadInteger(MHT,info,'A1A8') + 1)
  call SaveUnitHandle(MHT,info,'A1A8',d)
  call SetPlayerAbilityAvailable2(p,'A1A8',false)
  call UnitAddAbility(u,'A21J')
  call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_CAST)
  call UnitAddAbility(d,'A21J')
  call UnitAddAbility(d,'Aetl')
  if GetUnitAbilityLevel(u,'A1AA')>0then
    call UnitAddAbility(d,'A2LK')
  endif
  if GetUnitAbilityLevel(u,'A1CD')>0 or GetUnitAbilityLevel(u,'QP1I')>0 then
    call UnitAddAbility2(d,'A1CQ')
  endif
  call SaveUnitHandle(MHT,GetHandleId(d),'A1A8',u)
  call TimerStart(t,0.1,true,function Tauren_Spirit_Duration)
  set d = null
  set u = null
  set t = null
  set p=null
endfunction


function HXF takes nothing returns nothing
  local unit Target=GetOrderTargetUnit()
  local real x
  local real y
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
    set x=GetUnitX(GetOrderTargetUnit())
    set y=GetUnitY(GetOrderTargetUnit())
  else
    set x=GetOrderPointX()
    set y=GetOrderPointY()
  endif
  if DistanceBetweenXY(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),x,y)<700 then
    call PlaySoundAtPos(FE,x,y)
  endif
  set Target=null
endfunction

function HYF takes nothing returns boolean
  if GetIssuedOrderId()==852040 then
    call HXF()
  endif
  return false
endfunction

function Techies_SuicideSquad_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(GetTriggerUnit()),EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(GetTriggerUnit()),EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function HYF))
  set t=null
endfunction

function HCF takes nothing returns nothing
  call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,0,10,"Type -show to toggle the Focused Detonate sub-spell for Remote Mines")
  if(GetUnitAbilityLevel(GetTriggerUnit(),'A0AK')==1 or GetUnitAbilityLevel(GetTriggerUnit(),'A1FY')==1)then
    call UnitAddAbility2(GetTriggerUnit(),'A1WF')
  endif
endfunction

function RemoteMineFilter takes nothing returns boolean
  return IsUnitEnemy(GetFilterUnit(),LoadPlayerHandle(TempHash,'A0AM',1)) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0
endfunction

function RemoteMineDamage takes nothing returns nothing
  call DamageTarget(LoadUnitHandle(TempHash,'A0AM',0),GetEnumUnit(),1,LoadReal(TempHash,'A0AM',0))
endfunction

function RemoteMineBlast takes unit u, boolean selfdetonation returns nothing
  local real dmg=0.
  local integer uid=GetUnitTypeId(u)
  local group g
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  if uid=='o018' then
    set dmg=300.
  elseif uid=='o002'then
    set dmg=450.
  elseif uid=='o00B'then
    set dmg=600.
  elseif uid=='o01B' then
    set dmg=750.
  endif
  set g=GetAvailableGroup()
  call SaveUnitHandle(TempHash,'A0AM',0,u)
  call SavePlayerHandle(TempHash,'A0AM',1,GetOwningPlayer(u))
  call GroupEnumUnitsInRange(g,x,y,450,Condition(function RemoteMineFilter))
  call ZD8("Abilities\\Spells\\Human\\FlameStrike\\FlameStrike1.mdl",x,y,5)
  call TimedReveal(GetOwningPlayer(u),3,x,y,500)
  call SaveReal(TempHash,'A0AM',0,dmg)
  set IsRemoteMinesBlast=selfdetonation==false
  call ForGroup(g,function RemoteMineDamage)
  set IsRemoteMinesBlast=false
  call FlushChildHashtable(TempHash,'A0AM')
  call RemoveUnit(u)
  call KillGroup(g)
  set g=null
endfunction

function IsRemoteMine takes unit u returns boolean
  local integer id=GetUnitTypeId(u)
  return id=='o018' or id=='o002' or id=='o00B' or id=='o01B'
endfunction

function RemoteMineDeath takes unit mine returns nothing
  if IsRemoteMine(mine) then
    call RemoteMineBlast(mine,true)
  endif
endfunction

function RemoteMineActivation takes nothing returns nothing
  call RemoteMineBlast(GetTriggerUnit(),false)
endfunction

function RemoteMineFocusedFilter takes nothing returns boolean
  return GetOwningPlayer(GetFilterUnit())==LoadPlayerHandle(TempHash,'A0AN',0) and IsDead(GetFilterUnit())==false and IsRemoteMine(GetFilterUnit())
endfunction

function RemoteMineFocusedForGroup takes nothing returns nothing
  call IssueImmediateOrderById(GetEnumUnit(),852556)
endfunction

function RemoteMineFocused takes nothing returns nothing
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call SavePlayerHandle(TempHash,'A0AN',0,GetOwningPlayer(GetTriggerUnit()))
  call GroupEnumUnitsInRange(g,x,y,716,Condition(function RemoteMineFocusedFilter))
  call ForGroup(g,function RemoteMineFocusedForGroup)
  call FlushChildHashtable(TempHash,'A0AN')
  call KillGroup(g)
  set g=null
endfunction

function RemoteMineIncoming takes nothing returns nothing
  if IsRemoteMine(GetSummonedUnit()) then
    call TriggerRegisterUnitEvent(GAME_TRIGGER,GetSummonedUnit(),EVENT_UNIT_SPELL_CAST)
  endif
endfunction

function NF9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function RemoteMineIncoming))
  call CS8("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack1.wav")
  set t=null
endfunction

function IEF takes nothing returns boolean
  if GetWidgetLife(GetFilterUnit())>.5 and(GetUnitTypeId(GetFilterUnit())=='n00O' or GetUnitTypeId(GetFilterUnit())=='n00P' or GetUnitTypeId(GetFilterUnit())=='n00Q' or GetUnitTypeId(GetFilterUnit())=='n00N')then
    set GZ8=GZ8+1
  endif
  return false
endfunction

function IFF takes nothing returns boolean
  local group g=GetAvailableGroup()
  set GZ8=0
  call GroupEnumUnitsOfPlayer(g,GetTriggerPlayer(),Condition(function IEF))
  if GZ8>0 then
    call DisplayTimedTextToPlayer(GetTriggerPlayer(),0,I3,10.,GetObjectName('n0FC')+": "+I2S(GZ8))
  endif
  call KillGroup(g)
  set g=null
  return false
endfunction

function IGF takes nothing returns boolean
  return GetUnitTypeId(GetTriggerUnit())=='n00O' or GetUnitTypeId(GetTriggerUnit())=='n00P' or GetUnitTypeId(GetTriggerUnit())=='n00Q' or GetUnitTypeId(GetTriggerUnit())=='n00N'
endfunction

function IHF takes nothing returns boolean
  if GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(GetTriggerUnit())then
    if((GetUnitTypeId(GetFilterUnit())=='n00O'))then
      return true
    endif
    if((GetUnitTypeId(GetFilterUnit())=='n00P'))then
      return true
    endif
    if((GetUnitTypeId(GetFilterUnit())=='n00Q'))then
      return true
    endif
    if((GetUnitTypeId(GetFilterUnit())=='n00N'))then
      return true
    endif
  endif
  return false
endfunction

function IIF takes nothing returns boolean
  return(GetUnitTypeId(GetFilterUnit())=='H00E' or GetUnitTypeId(GetFilterUnit())=='H00G' or GetUnitTypeId(GetFilterUnit())=='H00F' or GetUnitTypeId(GetFilterUnit())=='E00P' or GetUnitTypeId(GetFilterUnit())=='N00B' or GetUnitTypeId(GetFilterUnit())=='UC60' or GetUnitTypeId(GetFilterUnit())=='EC77' or GetUnitTypeId(GetFilterUnit())=='U00P' or GetUnitTypeId(GetFilterUnit())=='E02N' or GetUnitTypeId(GetFilterUnit())=='E02O' or GetUnitTypeId(GetFilterUnit())=='O016' or GetUnitTypeId(GetFilterUnit())=='O017' or GetUnitTypeId(GetFilterUnit())=='E02F' or GetUnitTypeId(GetFilterUnit())=='H0DO' or GetUnitTypeId(GetFilterUnit())=='N0M7' or GetUnitTypeId(GetFilterUnit())=='N0MB' or GetUnitTypeId(GetFilterUnit())=='N0MC' or GetUnitTypeId(GetFilterUnit())=='N0MO' or GetUnitTypeId(GetFilterUnit())=='N0MA' or GetUnitTypeId(GetFilterUnit())=='H500' or GetUnitTypeId(GetFilterUnit())=='H507')and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1))
endfunction

function IJF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit IKF=(LoadUnitHandle(HY,h,(347)))
  local group g
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect(AddSpecialEffect("war3mapImported\\NewGroundEX.mdx",GetUnitX(IKF),GetUnitY(IKF)))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=IKF
    call GroupEnumUnitsInRange(g,GetUnitX(IKF),GetUnitY(IKF),200,Condition(function IIF))
    if FirstOfGroup(g)!=null then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call SetUnitExploded(IKF,true)
      call KillUnit(IKF)
    endif
    call KillGroup(g)
  endif
  set t=null
  set IKF=null
  set g=null
  return false
endfunction

function IMF takes nothing returns nothing
  local integer h=GetHandleId(GetOwningPlayer(GetTriggerUnit()))
  local group g=GetAvailableGroup()
  local integer INF=(LoadInteger(HY,h,(346)))
  local integer IOF=0
  local unit IPF
  local integer IQF
  local unit MRE
  local integer IRF
  local integer VT8
  local integer VU8
  local trigger t=CreateTrigger()
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function IHF))
  call TriggerRegisterTimerEvent(t,.4,true)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function IJF))
  call SaveUnitHandle(HY,(GetHandleId(t)),(347),(GetTriggerUnit()))
  set INF=(INF+1)
  call StartTimerBJ((LoadTimerHandle(HY,h,(1500+INF))),false,15000.)
  call SaveUnitHandle(HY,h,(1600+INF),(GetTriggerUnit()))
  set IOF=CountUnitsInGroup(g)
  if(IOF>20)then
    set IQF=99999
    set VT8=1
    set VU8=INF
    loop
      exitwhen VT8>VU8
      set MRE=(LoadUnitHandle(HY,h,(1600+VT8)))
      set IRF=R2I(TimerGetRemaining((LoadTimerHandle(HY,h,(1500+VT8)))))
      if(GetWidgetLife(MRE)>0 and IRF<IQF)then
        set IPF=MRE
        set IQF=IRF
      endif
      set VT8=VT8+1
    endloop
    call ExplodeUnitBJ(IPF)
  endif
  call SaveInteger(HY,h,(346),(INF))
  call KillGroup(g)
  set g=null
  set IPF=null
  set MRE=null
  set t=null
endfunction

function NG9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterPlayersChat(t,"-stats",true)
  call TriggerRegisterPlayersChat(t,"-st",true)
  call TriggerAddCondition(t,Condition(function IFF))
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function IGF))
  call TriggerAddAction(t,function IMF)
  set t=null
endfunction


function Rearm_Effect takes nothing returns nothing
  local unit u = GetTriggerUnit()
  call RefreshWithBalance(u,true)
  call Passive_Cooldown(u,'A065',GetUnitAbilityLevel(u,'A065'))
  call RemoveAbilsForUnit(u)
  set u = null
endfunction

function Tinker_Rearm_DummySpell_Mana takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+50+100*GetUnitAbilityLevel(u,'A528'))
  set u=null
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTimer(t)
  set t=null
endfunction

function Tinker_Rearm_DummySpell takes nothing returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function Tinker_Rearm_DummySpell_Mana)
  call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
  set t=null
endfunction

function Tinker_MarchOfMachines_OnCast takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit u=CreateUnit(GetOwningPlayer(caster),'n03C',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(u,'A416')
  if IssuePointOrderById(u,852593,GetSpellTargetX(),GetSpellTargetY())==false then
    call InterruptUnit(caster)
    call Error(GetOwningPlayer(caster),"Cannot cast March of Machines here")
  endif
  call KillUnit(u)
  set caster=null
  set u=null
endfunction

function Tinker_MarchOfMachines takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local integer i=0
  local real a=0
  local real r=0
  local integer Level=GetUnitAbilityLevel(Hero,'A0BQ')
  call UnitAddAbility(Caster,'A05F')
  call SetUnitAbilityLevel(Caster,'A05F',Level)
  if IssuePointOrderById(Caster,852593,x,y) then
  endif
  set Hero=null
  set Caster=null
endfunction

function Tinker_Laser takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call DamageTarget(GetTriggerUnit(),GetSpellTargetUnit(),3,(GetUnitAbilityLevel(GetTriggerUnit(),'A049')+GetUnitAbilityLevel(GetTriggerUnit(),'A33G')) *80)
  endif
endfunction

function Tinker_Rockets_Filter takes nothing returns boolean
  if((IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true or IsUnitIllusion(GetFilterUnit())==true) and IsMagicImmune(GetFilterUnit())==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null then
    return true
  endif
  return false
endfunction

function Tinker_Rockets_Hit takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit source=tt_unit1
  local unit target=tt_unit2
  local integer lvl=LoadInteger(HY,h,0)
  call DamageTarget(source,target,1,50+75*lvl)
  set source=null
  set target=null
endfunction

function Tinker_Rockets_GetClosest takes unit u, group g returns nothing
  local integer i=0
  local real dist=99999
  local real curdist=0
  local unit bu=null
  local unit d=null
  local group gg=GetAvailableGroup()
  call GroupAddGroup(g,gg)
  loop
    set d=FirstOfGroup(gg)
    exitwhen d==null
    set curdist=DistanceBetweenUnits(u,d)
    if curdist<dist then
      set dist=curdist
      set bu=d
    endif
  endloop
  call KillGroup(gg)
  set tt_unit1=bu
  set gg=null
  set d=null
  set bu=null
  set g=null
endfunction

function Tinker_Rockets takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetTriggerUnit()
  local trigger t
  local group g=GetAvailableGroup()
  local real x=GetUnitX(caster)
  local real y=GetUnitX(caster)
  local integer i=4
  local integer k=0
  local group gg=GetAvailableGroup()
  if GetSpellAbilityId()=='A05E' then
    set i=2
  endif
  set tt_unit1=caster
  
  call GroupEnumUnitsInRange(g,x,y,2500+25,Condition(function Tinker_Rockets_Filter))
  if CountUnitsInGroup(g)>0 then
    loop
      call Tinker_Rockets_GetClosest(caster,g)
      set target=tt_unit1
      if target!=null then
        set t=AddProjectile(caster,target,'hTKR',"Tinker_Rockets_Hit",1000,true)
        call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
        set k=k+1
      endif
      exitwhen k>=i or target==null
    endloop
  endif
  set t=null
  
  
  call KillGroup(g)
  call KillGroup(gg)
  set gg=null
  
  set g=null
  set caster=null
  set target=null
  set t=null
endfunction

function I3F takes nothing returns nothing
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE) then
    call DamageTarget(GA8,GetEnumUnit(),1,GB8/ 3)
  else
    call DamageTarget(GA8,GetEnumUnit(),1,GB8)
  endif
endfunction

function I6F takes unit Source,real x,real y,real r,real d returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,r,Condition(function LB8))
  set GA8=Source
  set GB8=d
  call ForGroup(g,function I3F)
  call KillGroup(g)
  set g=null
endfunction

function ILF takes nothing returns boolean
  return (AliveNonBuildOrMarker(GetFilterUnit()) and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and IsNonAncient(GetFilterUnit()) and (IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) or IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==false or (LoadBoolean(HY,GetPlayerId(GetOwningPlayer(GetFilterUnit())),139)==false))) !=null
endfunction

function I1F takes unit Hero, real d returns unit
  local unit Source=null
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),d,Condition(function ILF))
  if GetUnitAbilityLevel(Hero,'A04R')>0 then
    call GroupRemoveUnit(g,udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])
  else
    call GroupRemoveUnit(g,Hero)
  endif
  set Source=GroupPickRandomUnit(g)
  call KillGroup(g)
  set tt_unit1=Source
  set Source=null
  set g=null
  return tt_unit1
endfunction

function I0F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,30)
  local real x0=LoadReal(HY,h,282)
  local real y0=LoadReal(HY,h,283)
  local real x1=GetUnitX(Source)
  local real y1=GetUnitY(Source)
  local real x2=GetUnitX(Target)
  local real y2=GetUnitY(Target)
  local real a
  local real I5F
  local real QQE
  local real JJE
  local real AO8
  local real AP8
  local location l
  local integer lvl=GetUnitAbilityLevel(Hero,'A0CY')+GetUnitAbilityLevel(Hero,'QP1K')
  local integer tlvl=LoadInteger(HY,h,0)
  if DistanceBetweenXY(x0,y0,x2,y2)>1000 then
    set x2=x0
    set y2=y0
  endif
  set a=AngleBetweenXY(x1,y1,x2,y2)
  set I5F=DistanceBetweenXY(x1,y1,x2,y2)
  set QQE=I5F/ IMaxBJ((58-Count),1)
  set JJE=(Count-29)*(Count-29)
  set AO8=x1+QQE*Cos(a*bj_DEGTORAD)
  set AP8=y1+QQE*Sin(a*bj_DEGTORAD)
  if Count<58 then
    if IsBuggyFlying(Source)==false then
      call SetUnitFlyHeight(Source,775-JJE,0)
    endif
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitPosition(Source,AO8,AP8)
  else
    if IsBuggyFlying(Source)==false then
      call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source),0)
    endif
    call PauseUnit(Source,false)
    call SetUnitPathing(Source,true)
    call SetUnitPosition(Source,x2,y2)
    call SaveInteger(HY,GetHandleId(Source),4268,2)
    set l=Location(x2,y2)
    call TerrainDeformationRippleBJ(.2,true,l,1.,300.,96.,1,64.)
    call RemoveLocation(l)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(Source),GetUnitY(Source)))
    if IsUnitEnemy(Source,GetOwningPlayer(Hero))then
      if IsUnitHaveAghanim(Hero) then
        call DamageTarget(Hero,Source,1,(.2+.15*(lvl+1))*75*tlvl)
      else
        call DamageTarget(Hero,Source,1,(.2+.15*lvl)*75*tlvl)
      endif
    endif
    call KillTrees(x2,y2,300)
    call I6F(Hero,x2,y2,300,75*tlvl)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set Source=null
  set Target=null
  set l=null
  return false
endfunction

function Tiny_Toss takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Source=GC8
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer lvl=GetUnitAbilityLevel(Hero,'A0BZ')
  if GetUnitTypeId(Hero)=='e00C' or GetUnitTypeId(Hero)=='e00E'then //multicast
    set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
    if GetOwningPlayer(Target)==GetOwningPlayer(Hero)then
      set Target=I1F(Hero,500+200*lvl+25)
    endif
    if Source==null or Target==null then
      return
    endif
  else
    call IssueTargetOrder(Hero,"attack",Source)
  endif
  call SetUnitAnimationByIndex(Hero,4)
  call PauseUnit(Source,true)
  call SetUnitPathing(Source,false)
  if IsBuggyFlying(Source)==false then
    call UnitAddAbility2(Source,'Amrf')
    call UnitRemoveAbility(Source,'Amrf')
  endif
  call SaveInteger(HY,GetHandleId(Source),4268,1)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,lvl)
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",Source,"origin"))
  call SaveReal(HY,h,282,GetUnitX(Target)*1.)
  call SaveReal(HY,h,283,GetUnitY(Target)*1.)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function I0F))
  set Hero=null
  set Source=null
  set Target=null
  set t=null
endfunction

function Tiny_Toss_OnCast takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit tossing=I1F(caster,275)
  local unit target=GetSpellTargetUnit()
  set GC8=tossing
  if GetUnitTypeId(caster)!='e00C' and GetUnitTypeId(caster)!='e00E' then //normal cast
    if tossing==null then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),GetObjectName('n0DA'))
    elseif GetOwningPlayer(target)==GetOwningPlayer(caster) then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),GetObjectName('n0CY'))
    elseif GetSpellTargetItem()!=null and IsFakeRune(GetItemTypeId(GetSpellTargetItem()))==false then
      call InterruptUnit(caster)
      call Error(GetOwningPlayer(caster),"Must target Rune")
    endif
  else //multicast
  endif
  set caster=null
  set tossing=null
  set target=null
endfunction

function YPD takes nothing returns nothing
  local unit Source=IM
  local unit Target=AM
  local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Source)),(297)))
  call SaveUnitHandle(HY,(GetHandleId(Target)),(297),(Caster))
  call SetUnitOwner(Caster,GetOwningPlayer(Target),true)
  set Source=null
  set Target=null
  set Caster=null
endfunction

function YE9 takes nothing returns nothing
  local unit Hero=VK
  local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),(297)))
  if Caster!=null and GetUnitTypeId(Caster)=='e01V' then
    call RemoveUnit(Caster)
  endif
  set Hero=null
  set Caster=null
endfunction

function JHF takes nothing returns nothing
  local unit JIF=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(298)))
  local integer Level=GetUnitAbilityLevel(JIF,'A0CY')
  local real BaseScale=U18(JIF)
  if Level==0 and GetUnitAbilityLevel(JIF,'QP1K')>0 then
    set Level=GetUnitAbilityLevel(JIF,'QP1K')
  endif
  if GetWidgetLife(JIF)>1 then
    call SetUnitScale(JIF,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
  endif
  set JIF=null
endfunction

function GrowIllusion_Delayed takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Original=LoadUnitHandle(HY,h,19)
  local integer Level
  local real BaseScale
  set BaseScale=U18(Source)
  set Level=GetUnitAbilityLevel(Original,'A0CY')+GetUnitAbilityLevel(Original,'QP1K')
  call SetUnitScale(Source,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set Source=null
  set Original=null
  return false
endfunction

function JJF takes nothing returns boolean
  local trigger t
  local integer h
  local unit Source=GetTriggerUnit()
  local unit Original=LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),298)
  if IsUnitIllusion(Source) and GetOwningPlayer(Source)==GetOwningPlayer(Original) and GetUnitTypeId(Source)==GetUnitTypeId(Original) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function GrowIllusion_Delayed))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,19,Original)
    set t=null
  endif
  set Source=null
  set Original=null
  return false
endfunction


function Tiny_Grow_Learning takes nothing returns nothing
  local trigger t
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0CY')+GetUnitAbilityLevel(Hero,'QP1K')
  local unit dummy
  local region r
  local real BaseScale=U18(Hero)
  local integer pid=GetPlayerId(GetOwningPlayer(Hero))
  if Level==1 then
    set dummy=CreateUnit(GetOwningPlayer(Hero),'e01V',0,0,0)
    call UnitAddAbility2(dummy,'A10B')
    call SaveUnitHandle(HY,(GetHandleId(Hero)),(297),(dummy))
  else
    set dummy=(LoadUnitHandle(HY,(GetHandleId(Hero)),(297)))
  endif
  if Level==2 then
    call UnitRemoveAbility(dummy,'A10B')
    call UnitRemoveAbility(Hero,'B04E')
    call UnitAddAbility2(dummy,'A10A')
  elseif Level==3 then
    call UnitRemoveAbility(dummy,'A10B')
    call UnitRemoveAbility(dummy,'A10A')
    call UnitRemoveAbility(Hero,'B04E')
    call UnitAddAbility2(dummy,'A0ZS')
  endif
  
  if Mode_EB==false then
    call SetPlayerTechResearched(GetOwningPlayer(Hero),'R00E',Level)
  else
    if IsRangedUnit(Hero,GetPlayerId(GetOwningPlayer(Hero))*PlayerSkillOffset) then
      call SetPlayerTechResearched(GetOwningPlayer(Hero),'R00L',Level)
    else
      call SetPlayerTechResearched(GetOwningPlayer(Hero),'R00M',Level)
    endif
  endif
  
  if Level==1 then
    set t=CreateTrigger()
    call TriggerAddAction(t,function JHF)
    call TriggerRegisterTimerEvent(t,2.,true)
    call SaveUnitHandle(HY,(GetHandleId(t)),(298),(Hero))
    set t=CreateTrigger()
    set r=CreateRegion()
    call RegionAddRect(r,GetWorldBounds())
    call TriggerRegisterEnterRegion(t,r,Condition(function ReturnTrue))
    call TriggerAddCondition(t,Condition(function JJF))
    call SaveUnitHandle(HY,(GetHandleId(t)),(298),(Hero))
    set t=null
    set r=null
    set t=CreateTrigger()
    call SaveUnitHandle(HY,(GetHandleId(t)),2,(Hero))
    call TriggerRegisterTimerEvent(t,.5,true)
    set t=null
  endif
  call SetUnitScale(Hero,BaseScale+.25*Level,BaseScale+.25*Level,BaseScale+.25*Level)
  set Hero=null
  set dummy=null
endfunction

function JMF takes nothing returns boolean
  local unit Source=GetTriggerUnit()
  local unit Target=GetAttacker()
  local integer Level=(GetUnitAbilityLevel(Source,'A19Q')+GetUnitAbilityLevel(Source,'QP1J'))
  local unit Caster
  if AliveNonBuildOrMarker(Target) and DistanceBetweenUnits(Source,Target)<500 and PRD_Get(Source,'A19Q',15) then
    call DamageTarget(Source,Target,1,25+25*Level)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\RockBoltMissile\\RockBoltMissile.mdl",Target,"origin"))
    call StunTargetLod(Target,1.1+0.1*Level)
  endif
  set Source=null
  set Target=null
  return false
endfunction

function Tiny_CraggeExterior_Leveling takes nothing returns nothing
  call LoDStat_Add(GetTriggerUnit(),1,"armour")
endfunction


function Tiny_CraggyExterior_Learning takes nothing returns nothing
  local trigger t
  local unit Source=GetTriggerUnit()
  if IsUnitIllusion(Source)==false and GetUnitAbilityLevel(Source,'A19Q')+GetUnitAbilityLevel(Source,'QP1J')==1 then
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ATTACKED)
    call TriggerAddCondition(t,Condition(function JMF))
    call LoDStat_Add(GetTriggerUnit(),1,"armour")
  endif
  call LoDStat_Add(GetTriggerUnit(),1,"armour")
  set t=null
  set Source=null
endfunction

function JPF takes nothing returns boolean
  if((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((4268))))==1)and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(G38)) then
    call DamageTarget(G38,GetFilterUnit(),1,G68)
  endif
  return false
endfunction

function JQF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x,y,0)
  local integer Level=GetUnitAbilityLevel(Hero,'A0LL')
  local group g=GetAvailableGroup()
  call UnitAddAbility2(Caster,'A10J')
  call SetUnitAbilityLevel(Caster,'A10J',Level)
  set G38=Hero
  if Level==1 then
    set G68=25
  elseif Level==2 then
    set G68=45
  elseif Level==3 then
    set G68=65
  elseif Level==4 then
    set G68=75
  endif
  call GroupEnumUnitsInRange(g,x,y,275+24,Condition(function JPF))
  call KillGroup(g)
  if GetTriggerEvalCount(t)>6 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set Caster=null
  set g=null
  return false
endfunction

function Tiny_Avalanche takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  local integer Level=GetUnitAbilityLevel(Hero,'A0LL')
  call UnitAddAbility2(Caster,'A10M')
  call SetUnitAbilityLevel(Caster,'A10M',Level)
  call IssuePointOrderById(Caster,852652,x,y)
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function JQF))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call TriggerEvaluate(t)
  set Hero=null
  set t=null
  set Caster=null
endfunction

function JTF takes nothing returns nothing
  local unit u = GetEnumUnit()
  call UnitAddAbilityTimedEx(u,'A0XE',G18,7,'B00B')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A0XE',false)
  set u = null
endfunction

function Troll_BattleTrance takes nothing returns nothing
  local group g=GetAvailableGroup()
  set G18=GetUnitAbilityLevel(GetTriggerUnit(),'A1EJ')
  call GroupEnumUnitsInRange(g,0,0,12000,Condition(function D49))
  call ForGroup(g,function JTF)
  call KillGroup(g)
  set g=null
endfunction

function IsMeleeTrollWarlord takes unit u returns boolean
  return GetUnitTypeId(u)=='QTW3' or GetUnitTypeId(u)=='N017' or GetUnitTypeId(u)=='N02B' or GetUnitTypeId(u)=='QTW2'
endfunction

function JXF takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  call SetUnitAbilityLevel(Source,'A09E',GetUnitAbilityLevel(Source,'A0BE'))
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
  set Source=null
endfunction

function TrollRageMorph takes nothing returns nothing
  local timer t
  if IsMeleeTrollWarlord(GetTriggerUnit())==false then
    set t=CreateTimer()
    call SaveUnitHandle(HY,GetHandleId(t),2,GetTriggerUnit())
    call TimerStart(t,0,false,function JXF)
    set t=null
  endif
endfunction

function JCF takes unit u, unit Target returns nothing
  local integer h=GetHandleId(u)
  local unit prevTarget=LoadUnitHandle(HY,h,237)
  local integer c=IMaxIF(LoadInteger(HY,h,236),0)
  local integer lvl=GetUnitAbilityLevel(u,'P107')
  local integer asbonus
  local integer prevasbonus=LoadInteger(MHT,GetHandleId(u),'P107')
  if prevTarget!=Target then
    set c=0
  else
    if c==4 then
      call UnitAddAbilityTimedExF(Target,'A468',lvl,4,0)
    else
      set c=c+1
    endif
  endif
  set asbonus=(10+6*lvl)*c
  if(prevasbonus!=asbonus) then
    if prevasbonus<asbonus then
      call LoDStat_Add(u,asbonus-prevasbonus,"attack")
    else
      call LoDStat_Sub(u,prevasbonus-asbonus,"attack")
    endif
    call SaveInteger(MHT,GetHandleId(u),'P107',asbonus)
  endif
  call SaveInteger(HY,h,236,c)
  if prevTarget!=Target then
    call SaveUnitHandle(HY,h,237,Target)
  endif
  call AddTimedKeyToUnit(u,4271,.4)
  set prevTarget=null
endfunction

function Troll_Fervor takes unit attacker, unit target returns nothing
  if GetUnitAbilityLevel(attacker,'P107')>0 and LoadInteger(HY,GetHandleId(attacker),4271)!=1 then
    call JCF(attacker,target)
  endif
endfunction

function JLF takes unit Source,unit Target,unit Caster,integer Level returns nothing
  call SetUnitOwner(Caster,GetOwningPlayer(Target),false)
  call SetUnitAbilityLevel(Caster,'A21O',Level)
  call IssueTargetOrderById(Caster,852190,Target)
  call DamageTarget(Source,Target,1,50+50*Level)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"overhead"))
endfunction

function J1F takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),H48)==false then
    call GroupAddUnit(H48,GetEnumUnit())
    call JLF(G08,GetEnumUnit(),G58,H78)
  endif
endfunction

function J0F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit J5F=(LoadUnitHandle(HY,h,(675)))
  local unit J2F=(LoadUnitHandle(HY,h,(676)))
  local real a=(LoadReal(HY,h,(13)))
  local real d=(LoadReal(HY,h,(433)))
  local integer Level=(LoadInteger(HY,h,5))
  local group AlreadyHit=(LoadGroupHandle(HY,h,(187)))
  local group g=GetAvailableGroup()
  if GetTriggerEvalCount(t)<=50 then
    set a=a+20
    set d=d+7
    call SaveReal(HY,h,(13),((a)*1.))
    call SaveReal(HY,h,(433),((d)*1.))
  elseif GetTriggerEvalCount(t)<=100 then
    set a=a+20
    set d=d-7
    call SaveReal(HY,h,(13),((a)*1.))
    call SaveReal(HY,h,(433),((d)*1.))
  endif
  call SetUnitX(J5F,SafeX50(x+d*Cos(a*bj_DEGTORAD)))
  call SetUnitY(J5F,SafeY50(y+d*Sin(a*bj_DEGTORAD)))
  set a=a+180
  call SetUnitX(J2F,SafeX50(x+d*Cos(a*bj_DEGTORAD)))
  call SetUnitY(J2F,SafeY50(y+d*Sin(a*bj_DEGTORAD)))
  set tt_unit1=Source
  set G08=Source
  set G58=Caster
  set H48=AlreadyHit
  set H78=Level
  call GroupEnumUnitsInRange(g,GetUnitX(J5F),GetUnitY(J5F),125,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function J1F)
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,GetUnitX(J2F),GetUnitY(J2F),125,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function J1F)
  call KillGroup(g)
  if GetTriggerEvalCount(t)>100 then
    call KillUnit(J5F)
    call KillUnit(J2F)
    call KillUnit(Caster)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set J5F=null
  set J2F=null
  set Caster=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function Troll_AxesMelee takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit J5F=CreateUnit(GetOwningPlayer(Source),'e02Y',x,y,0)
  local unit J2F=CreateUnit(GetOwningPlayer(Source),'e02Y',x,y,0)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  call UnitAddAbility(Caster,'A21O')
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,(675),(J5F))
  call SaveUnitHandle(HY,h,(676),(J2F))
  call SaveReal(HY,h,(13),((0)*1.))
  call SaveReal(HY,h,(433),((0)*1.))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Source,'A21N')))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function J0F))
  set Source=null
  set J5F=null
  set J2F=null
  set t=null
  set Caster=null
endfunction

function K7F takes unit Source,unit Target,unit Caster,integer Level returns nothing
  call SetUnitOwner(Caster,GetOwningPlayer(Target),false)
  call SetUnitAbilityLevel(Caster,'A21P',Level)
  call IssueTargetOrderById(Caster,852075,Target)
  call DamageTarget(Source,Target,1,75)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"overhead"))
endfunction

function K8F takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),H48)==false then
    call GroupAddUnit(H48,GetEnumUnit())
    call K7F(G08,GetEnumUnit(),G58,H78)
  endif
endfunction

function K9F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local unit axe1=LoadUnitHandle(HY,h,393)
  local unit axe2=LoadUnitHandle(HY,h,394)
  local unit axe3=LoadUnitHandle(HY,h,395)
  local unit axe4=LoadUnitHandle(HY,h,396)
  local unit axe5=LoadUnitHandle(HY,h,397)
  local real a=LoadReal(HY,h,13)-12.5
  local real d=LoadReal(HY,h,433)
  local integer Level=LoadInteger(HY,h,5)
  local unit u
  local group g
  local group AlreadyHit=LoadGroupHandle(HY,h,187)
  local unit dummy=LoadUnitHandle(HY,h,19)
  local integer i=0
  set d=d+900/ 20.
  call SaveReal(HY,h,433,d*1.)
  set G08=caster
  set G58=dummy
  set H48=AlreadyHit
  set H78=Level
  set g=GetAvailableGroup()
  loop
    exitwhen HaveSavedHandle(HY,h,393+i)==false
    set u=LoadUnitHandle(HY,h,393+i)
    if u!=null and IsDead(u)==false then
      call SetUnitX(u,SafeX50(LoadReal(HY,h,6)+d*Cos(a*bj_DEGTORAD)))
      call SetUnitY(u,SafeY50(LoadReal(HY,h,7)+d*Sin(a*bj_DEGTORAD)))
      set x=GetUnitX(u)
      set y=GetUnitY(u)
      set G28=u
      set tt_unit1=caster
      call GroupEnumUnitsInRange(g,x,y,125,Condition(function DefaultEnemyFilter))
      call ForGroup(g,function K8F)
      call GroupClear(g)
    endif
    set a=a+6.25
    set i=i+1
  endloop
  call KillGroup(g)
  if GetTriggerEvalCount(t)>20 then
    call KillUnit(axe1)
    call KillUnit(axe2)
    call KillUnit(axe3)
    call KillUnit(axe4)
    call KillUnit(axe5)
    call KillUnit(dummy)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set caster=null
  set axe1=null
  set axe2=null
  set axe3=null
  set axe4=null
  set axe5=null
  set dummy=null
  set u=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function Troll_AxesRanged takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local real x0=GetUnitX(caster)
  local real y0=GetUnitY(caster)
  local real x1=GetSpellTargetX()
  local real y1=GetSpellTargetY()
  local real a=AngleBetweenXY(x0,y0,x1,y1)
  local unit axe1=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a-12.5)
  local unit axe2=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a-6.25)
  local unit axe3=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a)
  local unit axe4=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a+6.25)
  local unit axe5=CreateUnit(GetOwningPlayer(caster),'e02Z',x0,y0,a+12.5)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',x0,y0,0)
  call UnitAddAbility(d,'A21P')
  call SaveUnitHandle(HY,h,2,caster)
  call SaveUnitHandle(HY,h,19,d)
  call SaveUnitHandle(HY,h,393,axe1)
  call SaveUnitHandle(HY,h,394,axe2)
  call SaveUnitHandle(HY,h,395,axe3)
  call SaveUnitHandle(HY,h,396,axe4)
  call SaveUnitHandle(HY,h,397,axe5)
  call SaveReal(HY,h,6,x0*1.)
  call SaveReal(HY,h,7,y0*1.)
  call SaveReal(HY,h,433,0*1.)
  call SaveReal(HY,h,13,a*1.)
  call SaveGroupHandle(HY,h,187,GetAvailableGroup())
  call SaveInteger(HY,h,5,GetUnitAbilityLevel(caster,'A21M'))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function K9F))
  set caster=null
  set axe1=null
  set axe2=null
  set axe3=null
  set axe4=null
  set axe5=null
  set t=null
  set d=null
endfunction

function KIF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=GetUnitAbilityLevel(Source,'A21L')
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A21M')
  endif
  call SetUnitAbilityLevel(Source,'A21N',Level)
  call SetUnitAbilityLevel(Source,'A21M',Level)
  set t=null
  set Source=null
  return false
endfunction

function Warlord_WhirlingAxes_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call UnitAddAbility2(Source,'A21N')
  call UnitAddAbility2(Source,'A21M')
  call SaveInteger(HY,(GetHandleId((Source))),((4416)),2)
  call SaveInteger(HY,(GetHandleId((Source))),((4417)),2)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function KIF))
  call SaveUnitHandle(HY,h,2,(Source))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(Source)))
  set t=null
  set Source=null
endfunction

function KMF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=(LoadInteger(HY,h,(34)))
  local integer RHE=2+Level
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Source,'A1N3')
    call UnitRemoveAbility(Source,'A1N6')
    call UnitRemoveAbility(Source,'A1N7')
    call UnitRemoveAbility(Source,'B0CH')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==Source then
      set Count=Count+1
      call SaveInteger(HY,h,(34),(Count))
      if Count>=RHE then
        call UnitRemoveAbility(Source,'A1N3')
        call UnitRemoveAbility(Source,'A1N6')
        call UnitRemoveAbility(Source,'A1N7')
        call UnitRemoveAbility(Source,'B0CH')
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      endif
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if GetTriggerUnit()==Source and (GetSpellAbilityId()=='A1N4' or GetSpellAbilityId()=='QB0P') and(TimerGetElapsed(GlobalTimer))>(LoadReal(HY,h,442))then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    elseif IsPurge(GetSpellAbilityId()) and Source==GetSpellTargetUnit()then
      call UnitRemoveAbility(Source,'A1N3')
      call UnitRemoveAbility(Source,'A1N6')
      call UnitRemoveAbility(Source,'A1N7')
      call UnitRemoveAbility(Source,'B0CH')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call UnitRemoveAbility(Source,'A1N3')
    call UnitRemoveAbility(Source,'A1N6')
    call UnitRemoveAbility(Source,'A1N7')
    call UnitRemoveAbility(Source,'B0CH')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Ursa_Overpower takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
  call UnitAddAbility2(Source,'A1N3')
  call UnitAddAbility2(Source,'A1N6')
  call UnitAddAbility2(Source,'A1N7')
  if GetUnitAbilityLevel(Source,'A0CY')>0 or GetUnitAbilityLevel(Source,'QP1K')>0 then
    call SetUnitAbilityLevel(Source,'A1N3',2)
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1N6',false)
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function KMF))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(34),(0))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(442),(((TimerGetElapsed(GlobalTimer))+1)*1.))
  set t=null
  set Source=null
endfunction

function NQ9 takes nothing returns nothing
  
endfunction

function FurySwipesLifesteal takes unit ursa, real dmg returns nothing
  local real heal=0
  if GetUnitAbilityLevel(ursa,'A1CN')>0 then//Satanic
    set heal=dmg*2.0
  elseif GetUnitAbilityLevel(ursa,'A2A5')>0 then
    set heal=dmg*1.0
  elseif GetUnitAbilityLevel(ursa,'A0XC')>0 then
    set heal=dmg*0.4
  elseif GetUnitAbilityLevel(ursa,'A04T')>0 then
    set heal=dmg*0.25
  elseif GetUnitAbilityLevel(ursa,'A0II')>0 then
    set heal=dmg*0.17
  elseif GetUnitAbilityLevel(ursa,'AIva')>0 or GetUnitAbilityLevel(ursa,'A09P')>0 then
    set heal=dmg*0.15
  elseif GetUnitAbilityLevel(ursa,'A02U')>0 then
    set heal=dmg*0.1
  endif
  if GetUnitAbilityLevel(ursa,'B075')>0 then
    set heal=heal+dmg*0.16
  endif
  if GetUnitAbilityLevel(ursa,'BVA1')>0 then
    set heal=heal+dmg*0.15
  endif
  if GetUnitAbilityLevel(ursa,'BVA2')>0 then
    set heal=heal+dmg*0.2
  endif
  if GetUnitAbilityLevel(ursa,'BVA3')>0 then
    set heal=heal+dmg*0.25
  endif
  if GetUnitAbilityLevel(ursa,'BVA4')>0 then
    set heal=heal+dmg*0.3
  endif
  call SetWidgetLife(ursa,GetWidgetLife(ursa)+heal)
endfunction

function FurySwipesTriggered_Tick takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit victim
  local unit ursa
  local integer lvl
  local real dmg
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    set ursa=LoadUnitHandle(HY,h,0)
    set victim=LoadUnitHandle(HY,h,1)
    call DestroyEffect(LoadEffectHandle(HY,h,10))
    call UnitRemoveAbility(victim,'A349')
    call UnitRemoveAbility(victim,'B02N')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call RemoveSavedHandle(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
    call RemoveSavedBoolean(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
  else
    set ursa=LoadUnitHandle(HY,h,0)
    set victim=LoadUnitHandle(HY,h,1)
    if LoadBoolean(HY,h,2)then//FORCE DAMAGE
      call DamageTarget(ursa,victim,2,LoadReal(HY,h,100))
      call FurySwipesLifesteal(ursa,LoadReal(HY,h,100))
      call SaveBoolean(HY,h,2,false)
    elseif TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) then
      call UnitRemoveAbility(victim,'A349')
      call UnitRemoveAbility(victim,'B02N')
      call DestroyEffect(LoadEffectHandle(HY,h,10))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call RemoveSavedHandle(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
      call RemoveSavedBoolean(HY,GetHandleId(victim),'FRSW'+GetPlayerId(GetOwningPlayer(ursa)))
    endif
  endif
  set t=null
  set ursa=null
  set victim=null
endfunction

function FurySwipesTriggered_Apply takes unit ursa, unit target returns nothing
  local trigger t
  local integer h
  local integer ht=GetHandleId(target)
  local integer pid=GetPlayerId(GetOwningPlayer(ursa))
  local integer lvl=GetUnitAbilityLevel(ursa,'P067')+GetUnitAbilityLevel(ursa,'QP0A')
  if LoadBoolean(HY,ht,'FRSW'+pid)==false then//no swipes applied yet
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function FurySwipesTriggered_Tick))
    call SaveBoolean(HY,ht,'FRSW'+pid,true)//trigger is there
    call SaveTriggerHandle(HY,ht,'FRSW'+pid,t)
    call SaveBoolean(HY,h,2,true)//bool for FORCE_DAMAGE
    call TriggerRegisterTimerEvent(t,0,false)
    call SaveUnitHandle(HY,h,1,target)//victim
    call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\BattleRoar\\RoarTarget.mdl",target,"overhead"))
    call UnitAddAbility2(target,'A349')
  else//there are swipes already
    set t=LoadTriggerHandle(HY,ht,'FRSW'+pid)
    set h=GetHandleId(t)
    call SaveBoolean(HY,h,2,true)
    call TriggerRegisterTimerEvent(t,0,false)//bool for FORCE_DAMAGE
  endif
  call SaveInteger(HY,h,0,lvl)//store level
  call SaveUnitHandle(HY,h,0,ursa)//store passive's owner
  if Mode_BO==false and IsUnitType(ursa,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(ursa,UNIT_TYPE_MELEE_ATTACKER)==false then
    call SaveReal(HY,h,100,LoadReal(HY,h,100)+8+2*lvl)
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+6)//save timestamp where buff should be removed
  else
    call SaveReal(HY,h,100,LoadReal(HY,h,100)+5+5*lvl)
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+12)//save timestamp where buff should be removed
  endif
  set t=null
endfunction

function KPF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer dmg
  local integer odmg
  if GetTriggerEventId()==EVENT_UNIT_DEATH or (GetUnitAbilityLevel(Source,'B02H')==0 and GetTriggerEvalCount(t)>4) or(GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellTargetUnit()==Source and IsPurge(GetSpellAbilityId()))then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'B02H')
    call SaveInteger(HY,GetHandleId(Source),'a068',0)
    call BonusDamageSystem(Source)
  else
    if LoadBoolean(HY,h,0) then
      set dmg=R2I(GetUnitState(Source,UNIT_STATE_MAX_LIFE)*(.04+.01*LoadInteger(HY,h,0)))
    else
      set dmg=R2I(GetWidgetLife(Source)*(.04+.01*LoadInteger(HY,h,0)))
    endif
    set odmg=LoadInteger(HY,h,238)
    if dmg!=odmg then
      call SaveInteger(HY,h,238,dmg)
      call SaveInteger(HY,GetHandleId(Source),'a068',dmg)
      call BonusDamageSystem(Source)
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function Ursa_Enrage takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function KPF))
  call SaveUnitHandle(HY,h,2,GetTriggerUnit())
  call SaveInteger(HY,h,238,0)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A443')
  set t=null
endfunction

function KUF takes unit Caster,real x,real y,integer Level returns nothing
  call SetUnitPosition(Caster,x,y)
  call IssueImmediateOrderById(Caster,852588)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\HowlOfTerror\\HowlCaster.mdl",x,y))
  set Caster=null
endfunction

function KVF takes nothing returns boolean
  if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and IsUnitInGroup(GetFilterUnit(),H88)==false then
    call GroupAddUnit(H88,GetFilterUnit())
    if GetWidgetLife(GetFilterUnit())>HD8 then
      call SetWidgetLife(GetFilterUnit(),GetWidgetLife(GetFilterUnit())-HD8)
    else
      call DamageTarget(H98,GetFilterUnit(),1,HD8*1.33)
    endif
  endif
  return false
endfunction

function KWF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local real a=(LoadReal(HY,h,(13)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local integer Level=(LoadInteger(HY,h,5))
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local group g
  if GetTriggerEvalCount(t)>10 then
    call KillGroup(HND)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set H88=HND
    set H98=Source
    set HD8=60+20*Level
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,325,Condition(function KVF))
    call KillGroup(g)
    set g=null
    call KUF(Caster,x,y,Level)
    if ModuloInteger(GetTriggerEvalCount(t),2)==0 then
      call KillUnit(CreateUnit(GetOwningPlayer(Source),'e02A',x,y,0))
    endif
    set x=SafeX50(x+200*Cos(a*bj_DEGTORAD))
    set y=SafeY50(y+200*Sin(a*bj_DEGTORAD))
    call SaveReal(HY,h,6,((x)*1.))
    call SaveReal(HY,h,7,((y)*1.))
  endif
  set t=null
  set Source=null
  set Caster=null
  set HND=null
  return false
endfunction

function VS_WaveOfTerror takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x1=GetUnitX(Source)
  local real y1=GetUnitY(Source)
  local real x2=GetSpellTargetX()
  local real y2=GetSpellTargetY()
  local real a=AngleBetweenXY(x1,y1,x2,y2)
  local integer Level=GetUnitAbilityLevel(Source,'A17O')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x1,y1,0)
  call UnitAddAbility2(Caster,'A0AP')
  call SetUnitAbilityLevel(Caster,'A0AP',Level)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,6,((x1)*1.))
  call SaveReal(HY,h,7,((y1)*1.))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveGroupHandle(HY,h,(133),(GetAvailableGroup()))
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function KWF))
  set t=null
  set Source=null
  set Caster=null
endfunction

function VS_VengeanceAuraRemove takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_HERO_REVIVE_FINISH or GetUnitTypeId(LoadUnitHandle(HY,h,1))!=LoadInteger(HY,h,0) then
    call UnitRemoveAbility(u,'A405')
    call UnitRemoveAbility(u,'B0HB')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set u=null
  set t=null
endfunction

function VS_VengeanceAuraApply takes integer lvl, unit killer, unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(killer,'A405')
  call SetPlayerAbilityAvailable(GetOwningPlayer(killer),'A405',false)
  call UnitMakeAbilityPermanent(killer,true,'A403')
  call SetUnitAbilityLevel(killer,'A403',lvl)
  call TriggerRegisterUnitEvent(t,killer,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_HERO_REVIVE_FINISH)
  call TriggerRegisterTimerEvent(t,1,false)
  call SaveInteger(HY,GetHandleId(t),0,GetUnitTypeId(u))
  call TriggerAddCondition(t,Condition(function VS_VengeanceAuraRemove))
  call SaveUnitHandle(HY,GetHandleId(t),0,killer)
  call SaveUnitHandle(HY,GetHandleId(t),1,u)
  set t=null
endfunction

function VS_Swap_Helper takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if IsDead(u)==false then
    call SetUnitPathing(u,true)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set u=null
  set t=null
endfunction

function KZF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real x1=(LoadReal(HY,h,(64)))
  local real x2=(LoadReal(HY,h,(66)))
  local real y1=(LoadReal(HY,h,(65)))
  local real y2=(LoadReal(HY,h,(67)))
  local trigger tt
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",Source,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathPact\\DeathPactTarget.mdl",Target,"origin"))
  call SetUnitPosition(Source,x2,y2)
  call AddTimedKeyToUnit(Target,4407,1)
  if (IsTerrainPathableFixed(x1,y1)==false or IsPointInRegion(RestrictedRegion,x1,y1)) and IsUnitType(Target,UNIT_TYPE_HERO) then
    set tt=CreateTrigger()
    call SaveUnitHandle(HY,GetHandleId(tt),0,Target)
    call TriggerRegisterTimerEvent(tt,5,false)
    call SetUnitPathing(Target,false)
    call TriggerAddCondition(tt,Condition(function VS_Swap_Helper))
    set tt=null
  endif
  call SetUnitPosition(Target,x1,y1)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function VS_NetherSwap takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x1=GetUnitX(Source)
  local real y1=GetUnitY(Source)
  local real x2=GetUnitX(Target)
  local real y2=GetUnitY(Target)
  local trigger t
  local integer h
  if IsUnitAlly(Source,GetOwningPlayer(Target)) or IsBlocked(GetSpellTargetUnit())==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveReal(HY,h,(64),((x1)*1.))
    call SaveReal(HY,h,(66),((x2)*1.))
    call SaveReal(HY,h,(65),((y1)*1.))
    call SaveReal(HY,h,(67),((y2)*1.))
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function KZF))
    call ZO8("SPLK",x1,y1,x2,y2,.5,0,1,1,.3)
    call KillTrees(x1,y1,300)
    call KillTrees(x2,y2,300)
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function VS_NetherSwap_OnCast takes nothing returns nothing
  if(IsTerrainPathable(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),PATHING_TYPE_WALKABILITY))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03B'))
  endif
endfunction

function VS_MagicMissile_OnCast takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareMissile.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function VS_MagicMissileHit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(), 1.35 + LoadReal(HY,h,0)*0.1)
      call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,25+75*LoadReal(HY,h,0))
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function VS_MagicMissile takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(d,'A42D')
  if IssueTargetOrder(d,"thunderbolt",target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,5,false)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function VS_MagicMissileHit))
    call SaveUnitHandle(HY,h,0,d)
    call SaveUnitHandle(HY,h,1,caster)
    call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId())*1.0)
    set t=null
  endif
  set d=null
  set caster=null
  set target=null
endfunction

function VS_MagicMissile_Wrap takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call VS_MagicMissile()
  endif
endfunction


function Templar_Trap_Charge takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  if count==4 or IsDead(LoadUnitHandle(MHT,info,0))then
    call Timer_End(t)
    set t = null
    return
  endif
  set count = count + 1
  call SaveInteger(MHT,info,0,count)
  call SaveInteger(MHT,LoadInteger(MHT,info,1),1,count)
  set t = null
endfunction

function Templar_Trap_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call Buff_Add(t,group_temp_integer[0],'B08M',5)
    call DamageTarget(tt_unit1,t,3,75)
  endif
  set t = null
  return false
endfunction

function Templar_Trap_Find takes nothing returns boolean
  local unit t = GetFilterUnit()
  local real d
  local real x
  local real y
  if GetUnitTypeId(t)=='e020' and GetWidgetLife(t)>0.405 then
    set x = GetWidgetX(t) - group_temp_real[1]
    set y = GetWidgetY(t) - group_temp_real[2]
    set d = SquareRoot(x*x + y*y)
    if group_temp_real[0] > d then
      set group_temp_unit[0] = t
      set group_temp_real[0] = d
    endif
  endif
  set t = null
  return false
endfunction

function Templar_Trap_End_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local integer i
  if GetUnitTypeId(t)=='e020' and GetWidgetLife(t)>0.405 then
    set i = LoadInteger(MHT,GetHandleId(t),2)
    if group_temp_integer[0]==0 or group_temp_integer[1] > i then
      set group_temp_integer[1] = i
      set group_temp_unit[0] = t
    endif
    set group_temp_integer[0] = group_temp_integer[0] + 1
  endif
  set t = null
  return false
endfunction

function Templar_Trap_End takes player p, integer limit returns nothing
  set group_temp_integer[0] = 0
  call GroupEnumUnitsOfPlayer(temp_group,p,Condition(function Templar_Trap_End_Targets))
  if group_temp_integer[0] > limit then
    call RemoveUnit(group_temp_unit[0])
  endif
endfunction

function Templar_Trap_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local integer hu = GetHandleId(u)
  local integer count = LoadInteger(MHT,hu,'A0RP')
  local real x
  local real y
  if GetUnitTypeId(u)=='e020'then
    set group_temp_unit[0] = u
    set group_temp_integer[0] = LoadInteger(MHT,hu,1) + 'A510'
    set u  = LoadUnitHandle(MHT,hu,0)
    set hu = GetHandleId(u)
    set count = LoadInteger(MHT,hu,'A0RP')
  else
    set group_temp_unit[0] = null
    set group_temp_real[0] = 99999
    set group_temp_real[1] = GetWidgetX(u)
    set group_temp_real[2] = GetWidgetY(u)
    call GroupEnumUnitsOfPlayer(temp_group,p,Condition(function Templar_Trap_Find))
    if group_temp_unit[0]==null then
      set u = null
      return
    endif
    set group_temp_integer[0] = LoadInteger(MHT,GetHandleId(group_temp_unit[0]),1) + 'A510'
  endif
  set x = GetWidgetX(group_temp_unit[0])
  set y = GetWidgetY(group_temp_unit[0])
  set tt_unit1=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  call GroupEnumUnitsInRange(temp_group,x,y,400,Condition(function Templar_Trap_Targets))
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",x,y))
  call RemoveUnit(LoadUnitHandle(MHT,GetHandleId(group_temp_unit[0]),1))
  call RemoveUnit(group_temp_unit[0])
  set p=null
  set u = null
endfunction

function Templar_Trap_Start_Wrap takes unit u returns nothing
  if GetUnitTypeId(u)=='e020'then
    call Templar_Trap_Start()
  endif
endfunction

function Templar_Trap_Place takes nothing returns nothing
  local timer t
  local unit u = GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local unit d = CreateUnit(p,'e020',GetSpellTargetX(),GetSpellTargetY(),0)
  local integer hu = GetHandleId(u)
  local integer h = LoadInteger(MHT,hu,'A0RP')
  local integer limit = 2 + 3*(GetUnitAbilityLevel(u,'A0RP')+GetUnitAbilityLevel(u,'A449'))
  local boolean b=GetUnitAbilityLevel(u,'A449')>0
  local unit du
  call SaveInteger(MHT,hu,'A0RP',h + 1)
  set hu = GetHandleId(d)
  call SaveUnitHandle(MHT,hu,0,u)
  call SaveInteger(MHT,hu,0,0)
  call SaveInteger(MHT,hu,1,0)
  call SaveInteger(MHT,hu,2,h)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SPELL_EFFECT)
  call Templar_Trap_End(p,limit)
  if p==GetLocalPlayer() and AutoselectionStatus[GetPlayerId(p)]then
    call SelectUnit(d,true)
  endif
  if b then
    call SaveInteger(MHT,hu,1,4)
    set du=CreateUnit(p,'e01V',GetSpellTargetX(),GetSpellTargetY(),0)
    call UnitAddAbility(du,'A44B')
    call SaveUnitHandle(MHT,hu,1,du)
    set du=null
  else
    set t=CreateTimer()
    set h = GetHandleId(t)
    call SaveInteger(MHT,h,0,0)
    call SaveInteger(MHT,h,1,hu)
    call SaveUnitHandle(MHT,h,0,d)
    call TimerStart(t,1,true,function Templar_Trap_Charge)
  endif
  set d = null
  set p = null
  set u = null
  set t = null
endfunction

function Templar_Trap_Learn takes nothing returns nothing
  call UnitAddAbility(GetTriggerUnit(),'A0RT')
endfunction


function check_line takes real xc, real xt, real x, real yc, real yt, real y returns boolean
  if (y - yc)*(xt - xc) - (x - xc)*(yt - yc) > 0 then
    return true //to the left
  endif
  
  return false //to the right
endfunction

function check_box takes unit u, real x1a, real x1b, real x2a, real x2b, real y1a, real y1b, real y2a, real y2b returns boolean
  local real a1 = GetWidgetX(u)
  local real a2 = GetWidgetY(u)
  //checks to see if the unit is in a box \:D/
  //imba box face >:3
  return check_line(x1a,x1b,a1,y1a,y1b,a2)==false and check_line(x2a,x2b,a1,y2a,y2b,a2) and check_line(x1a,x2a,a1,y1a,y2a,a2) and check_line(x1b,x2b,a1,y1b,y2b,a2)==false
endfunction

function Psi_Blades_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsDead(t)==false and IsUnitEnemy(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) and t!=GetTriggerUnit() then
    if check_box(t,group_temp_real[0],group_temp_real[1],group_temp_real[2],group_temp_real[3],group_temp_real[4],group_temp_real[5],group_temp_real[6],group_temp_real[7]) then
      call DamageTarget(group_temp_unit[0],t,3,group_temp_real[8])
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",t,"chest"))
    endif
  endif
  set t = null
  return false
endfunction

function Psi_Blades_Display_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local integer loopA
  local integer a = 0
  
  if GetLocalPlayer()==LoadPlayerHandle(MHT,info,4) then
    set a = 1
  endif
  
  if count==10 then
    call DestroyLightning(LoadLightningHandle(MHT,info,3))
    call DestroyLightning(LoadLightningHandle(MHT,info,2))
    call DestroyLightning(LoadLightningHandle(MHT,info,1))
    call DestroyLightning(LoadLightningHandle(MHT,info,0))
    
    call Timer_End(t)
    set t = null
    return
  endif
  
  set loopA = 0
  call SaveInteger(MHT,info,0,count + 1)
  
  set count = 65 + 15*count
  
  loop
    exitwhen loopA==4
    call SetLightningColor(LoadLightningHandle(MHT,info,loopA),count,count,count,a)
    set loopA = loopA + 1
  endloop
  
  set t = null
endfunction

function Psi_Blades_Display takes player p returns nothing
  local lightning l = null
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  local integer a = 0
  
  if GetLocalPlayer()==p then
    set a = 1
  endif
  
  call SaveInteger(MHT,info,0,0)
  
  set l = AddLightning("DRAB",false,group_temp_real[0],group_temp_real[4],group_temp_real[1],group_temp_real[5])
  call SetLightningColor(l,50,50,50,a)
  call SaveLightningHandle(MHT,info,0,l)
  
  set l = AddLightning("DRAB",false,group_temp_real[0],group_temp_real[4],group_temp_real[2],group_temp_real[6])
  call SetLightningColor(l,50,50,50,a)
  call SaveLightningHandle(MHT,info,1,l)
  
  set l = AddLightning("DRAB",false,group_temp_real[2],group_temp_real[6],group_temp_real[3],group_temp_real[7])
  call SetLightningColor(l,50,50,50,a)
  call SaveLightningHandle(MHT,info,2,l)
  
  set l = AddLightning("DRAB",false,group_temp_real[3],group_temp_real[7],group_temp_real[1],group_temp_real[5])
  call SetLightningColor(l,50,50,50,a)
  call SaveLightningHandle(MHT,info,3,l)
  
  call SavePlayerHandle(MHT,info,4,p)
  
  call TimerStart(t,.05,true,function Psi_Blades_Display_End)
  set l = null
  set t = null
endfunction

function Psi_Blades_Effect takes unit u, real range, real angle, real damage, real x, real y returns nothing
  
  //fucking math
  
  local player p = GetOwningPlayer(u)
  local real a1 = angle + bj_PI/2
  local real a2 = angle - bj_PI/2
  local real x1a = x + 55*Cos(a1)
  local real y1a = y + 55*Sin(a1)
  local real x2a = x + 55*Cos(a2)
  local real y2a = y + 55*Sin(a2)
  local real x1b
  local real y1b
  local real x2b
  local real y2b
  
  set a1 = range*Cos(angle)
  set a2 = range*Sin(angle)
  
  set x1b = x1a + a1
  set y1b = y1a + a2
  set x2b = x2a + a1
  set y2b = y2a + a2
  
  set group_temp_unit[0] = u
  set group_temp_real[0] = x1a
  set group_temp_real[1] = x1b
  set group_temp_real[2] = x2a
  set group_temp_real[3] = x2b
  set group_temp_real[4] = y1a
  set group_temp_real[5] = y1b
  set group_temp_real[6] = y2a
  set group_temp_real[7] = y2b
  set group_temp_real[8] = damage
  
  if LoadBoolean(MHT,GetHandleId(p),'A0RO')then
    call Psi_Blades_Display(p)
  endif
  
  call GroupEnumUnitsInRange(temp_group,x,y,range,Condition(function Psi_Blades_Targets))
  set p=null
endfunction

function Psi_Blades_Detect takes nothing returns boolean
  local unit u = null
  local unit t = null
  local trigger trig = GetTriggeringTrigger()
  local integer info = GetHandleId(trig)
  local real damage
  local real x
  local real y
  
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    set t = GetTriggerUnit()
    set u = GetEventDamageSource()
    set damage = GetEventDamage()
    
    if LoadUnitHandle(MHT,info,0)==u and damage>1 and IsFakeDamage==false and IsRealDamage and IsDead(t)==false then
      
      set x = GetWidgetX(t)
      set y = GetWidgetY(t)
      
      call DisableTrigger(trig)
      call Psi_Blades_Effect(u,575 + (GetUnitAbilityLevel(u,'A0RO')+GetUnitAbilityLevel(u,'QP1S'))*40,Atan2(y-LoadReal(MHT,info,1),x-LoadReal(MHT,info,0)),damage,x,y)
      
      call FlushChildHashtable(MHT,info)
      call CleanTrigger(trig)
      
    endif
    
    set t = null
    set u = null
  endif
  
  call FlushChildHashtable(MHT,info)
  call CleanTrigger(trig)
  set trig = null
  return false
endfunction

function Psi_Blades_Cooldown takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  call SaveBoolean(MHT,LoadInteger(MHT,info,0),'A0RO',true)
  
  call Timer_End(t)
  set t = null
endfunction

function Psi_Blades_Start takes unit u, unit t, integer level returns nothing
  local timer time = CreateTimer()
  local trigger trig = CreateTrigger()
  local integer info = GetHandleId(trig)
  
  call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(trig,2.5,false)
  
  call TriggerAddCondition(trig,Condition(function Psi_Blades_Detect))
  
  call SaveUnitHandle(MHT,info,0,u)
  call SaveReal(MHT,info,0,GetWidgetX(u))
  call SaveReal(MHT,info,1,GetWidgetY(u))
  
  set info = GetHandleId(u)
  call SaveBoolean(MHT,info,'A0RO',false)
  call SaveInteger(MHT,GetHandleId(time),0,info)
  
  call TimerStart(time,0.4,false,function Psi_Blades_Cooldown)
  
  set time=null
  set trig = null
endfunction

function Psi_Blades_Condition takes unit u, unit t returns nothing
  local integer level = GetUnitAbilityLevel(u,'A0RO')+GetUnitAbilityLevel(u,'QP1S')
  if level>0 and LoadBoolean(MHT,GetHandleId(u),'A0RO') and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitIllusion(t)==false then
    call Psi_Blades_Start(u,t,level)
  endif
endfunction

function Psi_Blades_Display_Toggle takes nothing returns nothing
  local player p = GetTriggerPlayer()
  local integer info = GetHandleId(p)
  local boolean b = LoadBoolean(MHT,info,'A0RO')
  call SaveBoolean(MHT,info,'A0RO',b==false)
  if b then
    call DisplayTextToPlayer(p,0,0,"Turning Psi Blades Display |c00FF0000OFF|r")
  else
    call DisplayTextToPlayer(p,0,0,"Turning Psi Blades Display |c0000FF00ON|r")
  endif
endfunction

function Psi_Blades_Init takes unit u returns nothing
  local player p = GetOwningPlayer(u)
  call TriggerRegisterPlayerChatEvent(CHAT_TRIGGER,p,"-display",true)
  call DisplayTextToPlayer(p,0,0,"Type -display to display the Area of Effect for Psi Blades")
endfunction

function TemplarAssassin_PsiBlades_Leveling takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer level = (GetUnitAbilityLevel(u,'A0RO')+GetUnitAbilityLevel(u,'QP1S'))
  call SetUnitAcquireRange(u,GetUnitAcquireRange(u) + 60)
  call SetPlayerTechResearched(GetOwningPlayer(u),'Repb',level)
  if level==1 then
    call Psi_Blades_Init(u)
    call SaveBoolean(MHT,GetHandleId(u),'A0RO',true)
  endif
  set u = null
endfunction



function N7F takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local integer h=GetHandleId(Hero)
  local integer Y59=(LoadInteger(HY,h,(352)))
  if Y59>0 and GetTriggerEventId()!=EVENT_UNIT_DEATH then
    if GetEventDamage()>5 and IsRealDamage then
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",Hero,"right hand"))
      call HealUnitFor(Hero,GetEventDamage())
      call SaveInteger(HY,h,(352),(Y59-1))
    endif
  else
    call UnitRemoveAbility(Hero,'A0RN')
    call UnitRemoveAbility(Hero,'B08J')
    call SaveInteger(HY,h,(352),(0))
  endif
  set Hero=null
  return false
endfunction

function N8F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local unit Hero=(LoadUnitHandle(HY,(GetHandleId(t)),(14)))
  local integer h=GetHandleId(Hero)
  local integer Y59=(LoadInteger(HY,h,(351)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetAttacker()==Hero and IsUnitAlly(GetAttacker(),GetOwningPlayer(GetTriggerUnit()))==false)then
    if GetTriggerEventId()!=EVENT_UNIT_DEATH and Y59>0 and GetEventDamage()>0 then
      call SaveInteger(HY,h,(351),(Y59-1))
    else
      call UnitRemoveAbility(Hero,'A0RF')
      call UnitRemoveAbility(Hero,'A0RM')
      call UnitRemoveAbility(Hero,'B08I')
      call SaveInteger(HY,h,(351),(0))
    endif
  endif
  set t=null
  set Hero=null
  return false
endfunction

function N9F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local unit Hero=(LoadUnitHandle(HY,(GetHandleId(t)),(14)))
  local integer h=GetHandleId(Hero)
  call SaveInteger(HY,h,(352),(0))
  call SaveInteger(HY,h,(351),(0))
  call UnitRemoveAbility(Hero,'A0RF')
  call UnitRemoveAbility(Hero,'A0RM')
  call UnitRemoveAbility(Hero,'A0RN')
  call FlushChildHashtable(HY,(GetHandleId(t)))
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function TA_Refraction takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer h=GetHandleId(Hero)
  local trigger t=CreateTrigger()
  local integer c=GetUnitAbilityLevel(Hero,GetSpellAbilityId())+2
  call TriggerRegisterTimerEvent(t,17,false)
  call TriggerAddCondition(t,Condition(function N9F))
  call SaveUnitHandle(HY,(GetHandleId(t)),(14),(Hero))
  call PlaySoundAtPos(CE,GetUnitX(Hero),GetUnitY(Hero))
  call UnitAddAbility2(Hero,'A0RN')
  call SaveInteger(HY,h,(352),c)
  call UnitAddAbility2(Hero,'A0RF')
  call SetUnitAbilityLevel(Hero,'A0RF',GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call UnitAddAbility2(Hero,'A0RM')
  call SaveInteger(HY,h,(351),c)
  set Hero=null
  set t=null
endfunction

function TemplarAssassin_Refraction_Learn takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function N7F))
  call SaveInteger(HY,(GetHandleId(Hero)),(352),(0))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function N8F))
  call SaveUnitHandle(HY,(GetHandleId(t)),(14),(Hero))
  call SaveInteger(HY,(GetHandleId(Hero)),(351),(0))
  set t=null
  set Hero=null
endfunction

function NHF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),14),'A0RC')
  call FlushChildHashtable(HY,GetHandleId(t))
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function NIF takes unit Source,unit Target, integer lvl returns nothing
  local trigger t=CreateTrigger()
  call SaveUnitHandle(HY,GetHandleId(t),14,Target)
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerAddCondition(t,Condition(function NHF))
  call UnitAddAbility2(Target,'A0RC')
  call SetUnitAbilityLevel(Target,'A0RC',lvl)
  call DamageTarget(Source,Target,2,50*lvl)
  call TextTagOnUnit(I2S(50*lvl),1,Target,.03,255,0,0,255)
  call UnitRemoveAbility(Source,'B08K')
  set t=null
endfunction

function NJF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,30)
  local unit Source=LoadUnitHandle(HY,h,2)
  local trigger NKF=LoadTriggerHandle(HY,h,353)
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and IsFakeDamage==false and IsRealDamage then
      call DisableTrigger(t)
      call FlushChildHashtable(HY,GetHandleId(NKF))
      call CleanTrigger(NKF)
      call NIF(Source,Target,lvl)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_ATTACKED then
    if GetAttacker()==Source then
      if LoadBoolean(HY,h,0)==false then
        call SaveBoolean(HY,h,0,true)
      endif
    endif
  else
    if LoadInteger(HY,h,1)==0 then
      if LoadBoolean(HY,h,0)==false then
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      else
        call SaveInteger(HY,h,1,1)
      endif
    else
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Target=null
  set Source=null
  set NKF=null
  return false
endfunction

function NMF takes unit Source,unit Target,trigger NKF, integer lvl returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ATTACKED)
  call TriggerRegisterTimerEvent(t,4.,false)
  call TriggerRegisterTimerEvent(t,0.8,false)
  call TriggerAddCondition(t,Condition(function NJF))
  call SaveUnitHandle(HY,h,30,(Target))
  call SaveInteger(HY,h,0,lvl)
  call SaveInteger(HY,h,1,0)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveTriggerHandle(HY,h,353,NKF)
  set t=null
endfunction

function NNF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_CAST or(GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetAttacker()==Hero and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Hero))==false)then
    if GetTriggerEventId()!=EVENT_UNIT_DEATH and GetTriggerEventId()!=EVENT_UNIT_SPELL_CAST and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
      call NMF(Hero,GetTriggerUnit(),t,lvl)
      call UnitRemoveAbility(Hero,'B08K')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
    if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
    if (GetIssuedOrderId()==851983 or GetIssuedOrderId()==851971) and IsUnitEnemy(GetOrderTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and IsUnitType(GetOrderTargetUnit(),UNIT_TYPE_STRUCTURE)==false then
      call NMF(GetTriggerUnit(),GetOrderTargetUnit(),t,lvl)
      call UnitRemoveAbility(Hero,'B08K')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
    if (x!=GetUnitX(Hero)or y!=GetUnitY(Hero)) then
      call UnitRemoveAbility(Hero,'B08K')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Hero=null
  return false
endfunction

function TA_Meld takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call DestroyEffect(AddSpecialEffectTarget("effects\\PurpleAura.mdx",Hero,"origin"))
  call PlaySoundAtPos(SoundMeld,GetUnitX(Hero),GetUnitY(Hero))
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_CAST)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerAddCondition(t,Condition(function NNF))
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,'A0RV'))
  call SaveReal(HY,h,6,GetUnitX(Hero))
  call SaveReal(HY,h,7,GetUnitY(Hero))
  call IssueImmediateOrderById(Hero,851993)
  set t=null
  set Hero=null
endfunction

function NQF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  local integer NRF=(LoadInteger(HY,h,(247)))
  call DestroyEffect(AddSpecialEffect("effects\\Tornado.mdx",GetUnitX(Source),GetUnitY(Source)))
  if GetTriggerEvalCount(t)>10*(2+.75*Level)or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Source,NRF)
    call UnitRemoveAbility(Source,'B09W')
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function WR_Windrun takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A14I')
  local integer NRF
  if Level==1 then
    set NRF='A135'
  elseif Level==2 then
    set NRF='A12O'
  elseif Level==3 then
    set NRF='A134'
  elseif Level==4 then
    set NRF='A139'
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),NRF,false)
  call AddTimedAbility(Source,NRF,1,2+Level)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function NQF))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(247),(NRF))
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,left")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,right")))
  call ShowUnit(Source,false)
  call ShowUnit(Source,true)
  call SelectUnitForPlayerSingle(Source,GetOwningPlayer(Source))
  set Source=null
  set t=null
endfunction

function NUF takes nothing returns nothing
  local destructable Target=GetEnumDestructable()
  local real a=Atan2(GetDestructableY(Target)-GetUnitY(tt_unit1),GetDestructableX(Target)-GetUnitX(tt_unit1))
  local real KXD=RAbsBJ((tt_real1-a)*bj_RADTODEG)
  if(IsValidTree(Target)or GetDestructableTypeId(Target)=='B005')and GetDestructableLife(Target)>1 and KXD<HG8 and KXD<(HH8-5)then
    set HG8=KXD
    set HE8=Target
  endif
  set Target=null
endfunction

function NVF takes unit Projectile,unit Source,real J2E returns destructable
  local real x=GetUnitX(Projectile)
  local real y=GetUnitY(Projectile)
  local rect r=Rect(x-HJ8,y-HJ8,x+HJ8,y+HJ8)
  set HG8=9999
  set tt_unit1=Projectile
  set HE8=null
  call EnumDestructablesInRect(r,Condition(function ReturnTrue),function NUF)
  call RemoveRect(r)
  set r=null
  return HE8
endfunction

function NWF takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local real a=Atan2(GetUnitY(Target)-GetUnitY(tt_unit1),GetUnitX(Target)-GetUnitX(tt_unit1))
  local real KXD=RAbsBJ((tt_real1-a)*bj_RADTODEG)
  if KXD<HG8 and KXD<HH8 and Target!=tt_unit2 then
    set HG8=KXD
    set HF8=Target
  endif
  set Target=null
endfunction

function NXF takes unit Projectile,unit Source,real J2E returns unit
  local group g=GetAvailableGroup()
  set HF8=null
  set HG8=9999
  set tt_unit1=Projectile
  set tt_real1=Atan2(GetUnitY(Source)-HM8,GetUnitX(Source)-HK8)
  set tt_unit2=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),600,Condition(function NonImmuneEnemyFilter))
  call ForGroup(g,function NWF)
  call KillGroup(g)
  set g=null
  return HF8
endfunction

function NYF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if(LoadLightningHandle(HY,h,(196)))!=null then
    call DestroyLightning((LoadLightningHandle(HY,h,(196))))
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function NZF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real NAF=(LoadReal(HY,h,(248)))
  local real a=Atan2(GetUnitY(Target)-GetUnitY(Projectile),GetUnitX(Target)-GetUnitX(Projectile))
  local integer Level=(LoadInteger(HY,h,5))
  local real x=GetUnitX(Projectile)+50*Cos(a)
  local real y=GetUnitY(Projectile)+50*Sin(a)
  local unit NBF
  local destructable d
  local lightning ZQ8
  local unit Caster
  local boolean DCD=(LoadBoolean(HY,h,(249)))
  local real realdur
  local real realdur2
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Projectile)
  else
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    call SetUnitFacing(Projectile,a*bj_RADTODEG)
    if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<45 then
      set HK8=(LoadReal(HY,h,6))
      set HM8=(LoadReal(HY,h,7))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      if GetUnitTypeId(Target)!='n00L' and DCD then
        set NBF=NXF(Projectile,Target,NAF)
        set d=NVF(Projectile,Target,NAF)
        if NBF!=null then
          set t=CreateTrigger()
          set h=GetHandleId(t)
          set Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
          set realdur=StunTargetLod(Target,0.75*(Level+1))
          set Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(NBF),GetUnitY(NBF),0)
          set realdur2=StunTargetLod(NBF,0.75*(Level+1))
          call TriggerRegisterTimerEvent(t,RMaxIF(realdur,realdur2),false)
          call TriggerAddCondition(t,Condition(function NYF))
          set ZQ8=AddLightning("MFPB",true,GetUnitX(Target),GetUnitY(Target),GetUnitX(NBF),GetUnitY(NBF))
          call SetLightningColor(ZQ8,.5,.5,1,1)
          call SaveLightningHandle(HY,h,(196),(ZQ8))
        elseif d!=null then
          set t=CreateTrigger()
          set h=GetHandleId(t)
          set Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
          set realdur=StunTargetLod(Target,0.75*(Level+1))
          call TriggerRegisterTimerEvent(t,realdur,false)
          call TriggerAddCondition(t,Condition(function NYF))
          set ZQ8=AddLightning("MFPB",true,GetUnitX(Target),GetUnitY(Target),GetDestructableX(d),GetDestructableY(d))
          call SetLightningColor(ZQ8,.5,.5,1,1)
          call SaveLightningHandle(HY,h,(196),(ZQ8))
          call SetDestructableAnimation(d,"stand hit")
        else
          call StunTargetLod(Target,0.75)
        endif
      endif
      call KillUnit(Projectile)
    endif
  endif
  set t=null
  set Projectile=null
  set Target=null
  set ZQ8=null
  set NBF=null
  set d=null
  set Caster=null
  return false
endfunction

function WR_Shacleshot takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h077',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  local integer Level=GetUnitAbilityLevel(Source,'A12J')
  local boolean DCD=IsBlocked(GetSpellTargetUnit())==false
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(248),((a)*1.))
  call SaveBoolean(HY,h,(249),(DCD))
  call SaveReal(HY,h,6,((GetUnitX(Source))*1.))
  call SaveReal(HY,h,7,((GetUnitY(Source))*1.))
  call TriggerRegisterTimerEvent(t,.033,true)
  call TriggerAddCondition(t,Condition(function NZF))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  set Source=null
  set Target=null
  set Projectile=null
  set t=null
endfunction

function N6F takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),HN8)==false and GetUnitAbilityLevel(GetEnumUnit(),'Bcyc')==0 then
    call DamageTarget((HO8),(GetEnumUnit()),1,(((HP8)*1.))*Pow(.9,(HR8))*Pow(.99,(HQ8)))
    call GroupAddUnit(HN8,GetEnumUnit())
    set HR8=HR8+1
  endif
endfunction

function NLF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real a=(LoadReal(HY,h,(13)))
  local real Damage=(LoadReal(HY,h,(20)))
  local integer N1F=(LoadInteger(HY,h,(354)))
  local integer N0F=(LoadInteger(HY,h,(355)))
  local group AlreadyHit=(LoadGroupHandle(HY,h,(187)))
  local real x=SafeX50(GetUnitX(Projectile)+(60*Pow(.9,N0F)*Pow(.99,N1F))*Cos(a))
  local real y=SafeY50(GetUnitY(Projectile)+(60*Pow(.9,N0F)*Pow(.99,N1F))*Sin(a))
  local group g=GetAvailableGroup()
  local real d
  if GetTriggerEvalCount(t)>2 then
    set d=150
  else
    set d=75
  endif
  call DestroyEffect(AddSpecialEffect("effects\\Tornado.mdx",x,y))
  set N1F=N1F+KillTrees(x,y,75)
  call SaveInteger(HY,h,(354),(N1F))
  set HN8=AlreadyHit
  set HO8=Projectile
  set HP8=Damage
  set HQ8=N1F
  set HR8=N0F
  set tt_unit1=Projectile
  call GroupEnumUnitsInRange(g,x,y,d,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function N6F)
  call KillGroup(g)
  call SaveInteger(HY,h,(355),(HR8))
  call SetUnitX(Projectile,x)
  call SetUnitY(Projectile,y)
  if GetTriggerEvalCount(t)>43 then
    call KillUnit(Projectile)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Projectile=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function N5F takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x2=(LoadReal(HY,(GetHandleId(Source)),(356)))
  local real y2=(LoadReal(HY,(GetHandleId(Source)),(357)))
  local real N2F=RMinIF(TimerGetElapsed(GlobalTimer)-LoadReal(HY,GetHandleId(Source),358),1.)
  local real a=Atan2(y2-GetUnitY(Source),x2-GetUnitX(Source))
  local trigger t
  local integer h
  local unit Projectile
  local integer Level=GetUnitAbilityLevel(Source,'A12K')
  local real Damage=(40+80*Level)*(N2F)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set Projectile=CreateUnit(GetOwningPlayer(Source),'h078',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  set x2=GetUnitX(Source)+2475*Cos(a)
  set y2=GetUnitY(Source)+2475*Sin(a)
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveReal(HY,h,(47),((x2)*1.))
  call SaveReal(HY,h,(48),((y2)*1.))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveReal(HY,h,(20),((Damage)*1.))
  call SaveInteger(HY,h,(354),(0))
  call SaveInteger(HY,h,(355),(0))
  call SaveGroupHandle(HY,h,(187),(GetAvailableGroup()))
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function NLF))
  set Source=null
  set t=null
  set Projectile=null
endfunction

function O4F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  call SetUnitTimeScale(Hero,1)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function O7F takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local location l=GetSpellTargetLoc()
  local real x=GetLocationX(l)
  local real y=GetLocationY(l)
  call RemoveLocation(l)
  call SaveReal(HY,(GetHandleId(Hero)),(356),((x)*1.))
  call SaveReal(HY,(GetHandleId(Hero)),(357),((y)*1.))
  call SaveReal(HY,(GetHandleId(Hero)),(358),TimerGetElapsed(GlobalTimer)-0.3)
  call SetUnitTimeScale(Hero,.75)
  call SaveUnitHandle(HY,h,(14),(Hero))
  call TriggerRegisterTimerEvent(t,.75,false)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function O4F))
  set t=null
  set Hero=null
  set l=null
endfunction

function WR_Powershot_OnCast takes nothing returns nothing
  call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),360,false)
  call O7F()
endfunction

function O8F takes nothing returns boolean
  if GetSpellAbilityId()=='A12K' then
    if(LoadBoolean(HY,(GetHandleId(GetTriggerUnit())),(360))) then
      call N5F()
    endif
  endif
  return false
endfunction

function WR_Powershot takes nothing returns nothing
  call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),360,true)
endfunction

function WR_Powershot_Endcast takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function O8F))
  set t=null
endfunction

function O9F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local real QQE=(LoadReal(HY,h,(193)))
  local boolean RIE=(LoadBoolean(HY,h,(15)))
  if GetTriggerEvalCount(t)==1 then
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  endif
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==Source and GetTriggerUnit()==Target then
      call DestroyEffect(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,left"))
      call DestroyEffect(AddSpecialEffectTarget("effects\\Tornado.mdx",Source,"hand,right"))
      if GetUnitAbilityLevel(Source,'A12R')==0 then
        call UnitAddAbility2(Source,'A12R')
        call UnitMakeAbilityPermanent(Source,true,'A12S')
        call UnitMakeAbilityPermanent(Source,true,'A12Q')
      endif
    elseif GetAttacker()==Source and GetTriggerUnit()!=Target then
      call UnitRemoveAbility(Source,'A12R')
      call UnitRemoveAbility(Source,'B09X')
      call UnitRemoveAbility(Source,'A1FK')
      call UnitRemoveAbility(Source,'A1FL')
      call UnitRemoveAbility(Source,'A1FJ')
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and RIE==false and IsRealDamage then
      call SetWidgetLife(Target,GetWidgetLife(Target)+(QQE)*GetEventDamage())
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A12P' or GetSpellAbilityId()=='A1D6' then
      if GetUnitAbilityLevel(Source,'A12R')>0 then
        call UnitRemoveAbility(Source,'A12R')
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call UnitRemoveAbility(Source,'A12R')
    call UnitRemoveAbility(Source,'B09X')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'A1FK')
    call UnitRemoveAbility(Source,'A1FL')
    call UnitRemoveAbility(Source,'A1FJ')
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function ODF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A12P')
  local real QQE=.6-Level*.1
  local boolean RIE=false
  call UnitRemoveAbility(Source,'A12R')
  call UnitRemoveAbility(Source,'B09X')
  if Level==0 then
    call UnitRemoveAbility(Source,'A1FK')
    call UnitRemoveAbility(Source,'A1FL')
    call UnitRemoveAbility(Source,'A1FJ')
    set RIE=true
    set Level=GetUnitAbilityLevel(Source,'A1D6')
    set QQE=.6-Level*.15
    if Level==1 then
      call UnitAddAbility2(Source,'A1FK')
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1FK',false)
    elseif Level==2 then
      call UnitAddAbility2(Source,'A1FL')
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1FL',false)
    endif
  endif
  call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A12R',false)
  call UnitAddAbility2(Source,'A12R')
  call UnitMakeAbilityPermanent(Source,true,'A12S')
  call UnitMakeAbilityPermanent(Source,true,'A12Q')
  call IssueTargetOrderById(Source,851983,Target)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveBoolean(HY,h,(15),(RIE))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveReal(HY,h,(193),((QQE)*1.))
  call SaveInteger(HY,h,(361),(0))
  call TriggerRegisterTimerEvent(t,20,false)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function O9F))
  set Source=null
  set Target=null
  set t=null
endfunction

function WR_FocusFire takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call ODF()
  endif
endfunction

function FocusFire_CloseToAttack takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(MHT,h,0)
  local unit target=LoadUnitHandle(MHT,h,1)
  if GetTriggerEventId()==EVENT_UNIT_ATTACKED and GetTriggerUnit()==target and GetAttacker()==caster then
    call DisableTrigger(t)
    call DisableTrigger(LoadTriggerHandle(MHT,h,2))
    call IssueTargetOrder(caster,"incineratearrowon",target)
    call EnableTrigger(t)
    call EnableTrigger(LoadTriggerHandle(MHT,h,2))
  endif
  if (GetIssuedOrderId()!=851983 and GetIssuedOrderId()!=851973) then
    call DestroyTrigger(t)
    call FlushChildHashtable(MHT,h)
  endif
  set t=null
  set caster=null
  set target=null
endfunction

function FocusFire_OnCast takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  call IssueTargetOrderById(caster,851983,target)//attack
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerAddCondition(t,Condition(function FocusFire_CloseToAttack))
  call SaveUnitHandle(MHT,h,0,caster)
  call SaveUnitHandle(MHT,h,1,target)
  call SaveTriggerHandle(MHT,h,2,GetTriggeringTrigger())
  set t=null
  set caster=null
  set target=null
endfunction

function OFF takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and GetUnitTypeId(GetFilterUnit())!='H00J' and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(HS8)))!=null
endfunction

function OGF takes nothing returns nothing
  local real x=GetUnitX(GetEnumUnit())
  local real y=GetUnitY(GetEnumUnit())
  local unit d=CreateUnit(GetOwningPlayer(HS8),'e000',x,y,0)
  local integer id='A06L'
  call UnitAddAbility(d,'Aloc')
  call UnitApplyTimedLife(d,'BTLF',3)
  if GetSpellAbilityId()!='A29G' then
    set id='A07C'
  endif
  call UnitAddAbility(d,id)
  call SetUnitAbilityLevel(d,id,Zeus_TempInt)
  if GetUnitAbilityLevel(GetEnumUnit(),'A1HX')==0 then
    call IssueTargetOrderById(d,852119,GetEnumUnit())
  endif
  set d=null
endfunction

function Zeus_WrathOfGod takes nothing returns nothing
  local group g=GetAvailableGroup()
  set HS8=GetTriggerUnit()
  set Zeus_TempInt=GetUnitAbilityLevel(HS8,'A29G')+GetUnitAbilityLevel(HS8,'A29H')
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function OFF))
  call ForGroup(g,function OGF)
  call KillGroup(g)
  set g=null
endfunction


function Zeus_Static_Field_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and IsMagicImmune(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(t)!='n00L' then
    call DamageTarget(u,t,1,GetWidgetLife(t)*(0.03 + 0.02*group_temp_integer[0])+0.01*GetUnitState(t,UNIT_STATE_MAX_LIFE))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ForkedLightning\\ForkedLightningTarget.mdl",t,"overhead"))
  endif
  set u = null
  set t = null
  return false
endfunction

function StaticFieldEnemyCast takes unit u returns nothing
  local group g=GetAvailableGroup()
  local unit u2
  local unit source=null
  local integer lvl
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),1300,Condition(function D89))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    if GetUnitAbilityLevel(u2,'A0N5')>0 or GetUnitAbilityLevel(u2,'QP1T')>0 then
      set source=u2
      exitwhen true
    endif
    call GroupRemoveUnit(g,u2)
  endloop
  if source!=null then
    set group_temp_integer[0]=GetUnitAbilityLevel(source,'A0N5')+GetUnitAbilityLevel(source,'QP1T')
    set group_temp_unit[0] = source
    call GroupEnumUnitsInRange(temp_group,GetWidgetX(source),GetWidgetY(source),1225,Condition(function Zeus_Static_Field_Targets))
    //		call DamageTarget(source,u,1,GetWidgetLife(u)*(0.03 + 0.02*lvl))
    //		call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ForkedLightning\\ForkedLightningTarget.mdl",u,"overhead"))
  endif
  set source=null
  set u2=null
  call KillGroup(g)
endfunction

function Zeus_Static_Field_Condition takes unit u, integer spell returns nothing
  set group_temp_integer[0] = GetUnitAbilityLevel(u,'A0N5')+GetUnitAbilityLevel(u,'QP1T')
  if ((isPoisonArrowSkill(spell)==false and isItemSpellOrNoCd(spell)==false and isDummyAbility(spell)==false and isAintItemAbility(spell) and IsItemAbilityById(spell)==false and GetUnitAbilityLevel(u,'A04R')==0 and isFormlessAbility(spell)==false)or(Mode_BO and BalanceOffSpellChecker(spell))) then
    if group_temp_integer[0]>0 then
      set group_temp_unit[0] = u
      call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),1225,Condition(function Zeus_Static_Field_Targets))
    elseif GetUnitAbilityLevel(u,'B45E')==1 then
      call StaticFieldEnemyCast(u)
    endif
  endif
endfunction

function ORF takes unit Hero, unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e000',GetUnitX(Target),GetUnitY(Target),0)
  local real dmg=0
  local integer lvl
  local unit u
  call UnitAddAbility2(Caster,'A05S')
  call SetUnitAbilityLevel(Caster,'A05S',GetUnitAbilityLevel(Hero,'A0JC'))
  if not IssueTargetOrderById(Caster,852119,Target) then
    set lvl=GetUnitAbilityLevel(Hero,'A0JC')
    if lvl==1 then
      set dmg=100
    elseif lvl==2 then
      set dmg=175
    elseif lvl==3 then
      set dmg=275
    elseif lvl==4 then
      set dmg=350
    endif
    call DamageTarget(Caster,Target,1,dmg)
    set u=CreateUnit(GetOwningPlayer(Target),'e000',GetUnitX(Target),GetUnitY(Target),0)
    call UnitRemoveAbility(u,'ANtr')
    call UnitAddAbility(u,'Aloc')
    call UnitAddAbility(u,'A46C')
    call IssueTargetOrderById(u,852119,Target)
    call UnitApplyTimedLife(u,'BTLF',1.5)
    set u=null
  endif
  call UnitApplyTimedLife(Caster,'BTLF',4.5)
  call SetUnitPathing(Caster,false)
  call UnitAddAbility(Caster,'Aloc')
  call StunTargetLod(Target,.01)
  set Hero=null
  set Target=null
  set Caster=null
endfunction

function Zeus_LightningBolt_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0
endfunction

function Zeus_LightningBolt_FindClosest takes nothing returns nothing
  local unit bu=GetEnumUnit()
  local real r=DistanceBetweenXY(GetUnitX(bu),GetUnitY(bu),Zeus_Lightning_ClosX,Zeus_Lightning_ClosY)
  if r<Zeus_Lightning_ClosDist then
    set Zeus_Lightning_ClosDist=r
    set Zeus_Lightning_Closest=bu
  endif
  set bu=null
endfunction

function Zeus_LightningBolt takes nothing returns nothing
  local group g
  local unit u
  if GetSpellTargetUnit()!=null and IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) then
    if IsBlocked(GetSpellTargetUnit())==false then
      call ORF(GetTriggerUnit(),GetSpellTargetUnit())
    endif
  else
    set Zeus_Lightning_ClosX=GetSpellTargetX()
    set Zeus_Lightning_ClosY=GetSpellTargetY()
    set g=GetAvailableGroup()
    set tt_unit1=GetTriggerUnit()
    call GroupEnumUnitsInRange(g,Zeus_Lightning_ClosX,Zeus_Lightning_ClosY,325+25,Condition(function Zeus_LightningBolt_Filter))
    set Zeus_Lightning_ClosDist=99999
    set Zeus_Lightning_Closest=null
    
    call ForGroup(g,function Zeus_LightningBolt_FindClosest)
    if Zeus_Lightning_Closest!=null then
      if IsBlocked(Zeus_Lightning_Closest)==false then
        call ORF(GetTriggerUnit(),Zeus_Lightning_Closest)
      endif
    else
      set u=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'hFFD',Zeus_Lightning_ClosX,Zeus_Lightning_ClosY,0)
      call UnitApplyTimedLife(u,'BTLF',0.02)
      call UnitRemoveAbility(u,'Aloc')
      call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",Zeus_Lightning_ClosX,Zeus_Lightning_ClosY))
      call ORF(GetTriggerUnit(),u)
      set u=null
      
    endif
    call KillGroup(g)
    set g=null
  endif
endfunction

function OSF takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local integer count=LoadInteger(HY,h,0)+1
  call SaveInteger(HY,h,0,count)
  call SetUnitX(Caster,GetUnitX(Source))
  call SetUnitY(Caster,GetUnitY(Source))
  if count>80 then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set t=null
  set Source=null
  set Caster=null
  
endfunction

function OTF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e02C',GetUnitX(Source),GetUnitY(Source),0)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Caster,'A1FM')
  call SetUnitAbilityLevel(Caster,'A1FM',GetUnitAbilityLevel(Source,'A020'))
  call IssueTargetOrderById(Caster,852119,Target)
  call UnitApplyTimedLife(Caster,'BTLF',10)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,19,Caster)
  call TimerStart(t,0.05,true,function OSF)
  set Source=null
  set Target=null
  set Caster=null
  set t=null
endfunction

function Zeus_ChainLightning takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call OTF()
  endif
endfunction

function OWF takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real Damage=(LoadReal(HY,h,(20)))
  call DamageTarget(Hero,Hero,3,Damage)
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
  set Hero=null
endfunction

function OXF takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real Damage=25+25*GetUnitAbilityLevel(Hero,('A0I3'))
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl",Target,"origin"))
  if IsUnitAlly(Target,GetOwningPlayer(Hero))and GetWidgetLife(Target)>1. then
    call SetWidgetLife(Target,GetWidgetLife(Target)+2*Damage)
  else
    call DamageTarget(Hero,Target,1,2*Damage)
  endif
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,(20),((Damage+25)*1.))
  call TimerStart(t,0,false,function OWF)
  set Hero=null
  set Target=null
  set t=null
endfunction

function Abaddon_DeathCoil takes nothing returns nothing
  if (IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or IsBlocked(GetSpellTargetUnit())==false) then
    call OXF()
  endif
endfunction

function OYF takes nothing returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(HU8),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
  call UnitAddAbility2(Caster,'A0MJ')
  call SetUnitAbilityLevel(Caster,'A0MJ',HV8)
  call IssueTargetOrderById(Caster,852587,GetEnumUnit())
  set Caster=null
endfunction

function OZF takes unit Source,unit Target,integer Level returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set HV8=Level
  set HU8=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),700,Condition(function LT8))
  call ForGroup(g,function OYF)
  call KillGroup(g)
  set g=null
endfunction

function OAF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real OBF=(LoadReal(HY,h,(362)))
  local unit Source
  local unit Target=LoadUnitHandle(HY,h,(30))
  local integer Level
  
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if IsRealDamage then
      if LoadBoolean(MHT,GetHandleId(GetTriggerUnit()),'A0NS')==false then
        //call BJDebugMsg(R2S(GetEventDamage())+GetObjectName(GetUnitTypeId(GetEventDamageSource())))
        if OBF<GetEventDamage()then
          set Source=(LoadUnitHandle(HY,h,2))
          set Level=(LoadInteger(HY,h,5))
          call DestroyEffect((LoadEffectHandle(HY,h,(32))))
          call SaveBoolean(HY,(GetHandleId(Target)),(363),(false))
          call FlushChildHashtable(HY,h)
          call CleanTrigger(t)
          call HealUnitFor(GetTriggerUnit(),OBF)
          call OZF(Source,GetTriggerUnit(),Level)
          call Buff_Remove(Target,LoDBuff_BuffID[0])
        elseif GetEventDamage()>0 then
          call HealUnitFor(GetTriggerUnit(),GetEventDamage())
          call SaveReal(HY,h,(362),((OBF-GetEventDamage())*1.))
        endif
      endif
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if IsPurge(GetSpellAbilityId()) and GetSpellTargetUnit()==Target then
      set Source=(LoadUnitHandle(HY,h,2))
      set Level=(LoadInteger(HY,h,5))
      call SaveBoolean(HY,(GetHandleId(Target)),(363),(false))
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    set Source=(LoadUnitHandle(HY,h,2))
    set Level=(LoadInteger(HY,h,5))
    call SaveBoolean(HY,(GetHandleId(Target)),(363),(false))
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetUnitTypeId(GetTriggerUnit())!='e00C'then
      call OZF(Source,Target,Level)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Abaddon_AphoticShield takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Target=GetSpellTargetUnit()
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0MF')
  local integer Cache2=GetHandleId(Target)
  local real OBF
  if(LoadBoolean(HY,(Cache2),(363))) then
    call TriggerEvaluate((LoadTriggerHandle(HY,(Cache2),(364))))
  endif
  if GetUnitAbilityLevel(Target,'BNdo')==0 then
    call UnitRemoveBuffs(Target,false,true)
  endif
  call RemoveDispellableBuffs(Target)
  call SetNapalmFactory(Target,0,0)
  if Level==1 then
    set OBF=110
  elseif Level==2 then
    set OBF=140
  elseif Level==3 then
    set OBF=170
  else
    set OBF=200
  endif
  call Buff_Add(Target,LoDBuff_AbilID[0],LoDBuff_BuffID[0],15.)
  call SaveReal(HY,h,(362),((OBF)*1.))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\Defensive Barrier big.mdx",Target,"chest")))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerAddCondition(t,Condition(function OAF))
  call SaveTriggerHandle(HY,(Cache2),(364),(t))
  call SaveBoolean(HY,(Cache2),(363),(true))
  set t=null
  set Target=null
  set Source=null
endfunction


function Func2552 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=(LoadUnitHandle(HY,h,(14)))
  local trigger tt=LoadTriggerHandle(HY,h,0)
  call DisableTrigger(tt)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or IssueImmediateOrder(u,"windwalk")then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  call EnableTrigger(tt)
  set tt=null
  set t=null
  set u=null
  return false
endfunction

function Func2553 takes unit u, trigger tt returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.5,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Func2552))
  call SaveUnitHandle(HY,h,(14),(u))
  call SaveTriggerHandle(HY,h,0,tt)
  set t=null
endfunction



function Abbadon_Time_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  if LoadBoolean(MHT,info,0)then
    call SaveBoolean(MHT,'A0NS',LoadInteger(MHT,info,0),true) //allow the spell to be activated
    call Timer_End(t)
  else
    call TimerStart(t,LoadInteger(MHT,info,1),false,function Abbadon_Time_End)
    call SaveBoolean(MHT,LoadInteger(MHT,info,0),'A0NS',false) //disable damage block
    call DestroyEffect(LoadEffectHandle(MHT,info,0))
    call SaveBoolean(MHT,info,0,true)
  endif
  
  set t = null
endfunction

function Abaddon_time_AghDmgEvt takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local unit aba=LoadUnitHandle(HY,GetHandleId(t),0)
  local boolean b=LoadBoolean(MHT,GetHandleId(aba),'A0NS')
  local real dmg
  if b then//active
    if DistanceBetweenUnits(aba,GetTriggerUnit())<900 then
      set dmg=GetEventDamage()
      if IsDamageReal(dmg) then
        call HealUnitFor(aba,dmg*0.35)
      endif
    endif
  else
    call FlushChildHashtable(HY,GetHandleId(t))
    call DestroyTrigger(t)
  endif
  set t=null
  set aba=null
endfunction

function Abbadon_Time_Agh takes unit u returns nothing
  local trigger t=CreateTrigger()
  local player p=GetOwningPlayer(u)
  local integer i=1
  local integer k=5
  if IsScourge(p) then
    set i=7
    set k=11
  endif
  loop
    if udg_Hero[i]!=null and udg_Hero[i]!=u then
      call TriggerRegisterUnitEvent(t,udg_Hero[i],EVENT_UNIT_DAMAGED)
    endif
    set i=i+1
    exitwhen i>k
  endloop
  call TriggerAddCondition(t,Condition(function Abaddon_time_AghDmgEvt))
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function Abbadon_Time_Effect takes unit u, integer load returns nothing
  local timer t = CreateTimer()
  local player p = GetOwningPlayer(u)
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A0NS')
  local boolean b = IsUnitSelected(u,p)
  local real dur
  call UnitRemoveBuffs(u,false,true)
  call RemoveDispellableBuffs(u)
  call DisableTrigger(GetTriggeringTrigger())
  if IssueImmediateOrder(u,"windwalk")==false then
    call Func2553(u,GetTriggeringTrigger())
  endif
  call EnableTrigger(GetTriggeringTrigger())
  if p==GetLocalPlayer() and b then
    call SelectUnit(u,true)
  endif
  call DisableTrigger(GAME_TRIGGER)
  if level==0 then
    set level = GetUnitAbilityLevel(u,'A1DA')
    call Abbadon_Time_Agh(u)
    call SaveInteger(MHT,info,1,70 - level*10 - level - 4)//
    set dur=3+level
    set level = level + 4
    
  else
    call SaveInteger(MHT,info,1,70 - level*10 - level - 2)//
    set level = level + 2
    set dur=level*0.5+2.5
  endif
  call EnableTrigger(GAME_TRIGGER)
  call SetNapalmFactory(u,0,0)
  
  call SaveBoolean(MHT,load,'A0NS',true)  //active
  call SaveBoolean(MHT,'A0NS',load,false) //is avaliable
  call Buff_Add(u,LoDBuff_AbilID[22],LoDBuff_BuffID[22],level)
  call SaveInteger(MHT,info,0,load)
  call SaveBoolean(MHT,info,0,false)
  call SaveEffectHandle(MHT,info,0,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\Unsummon\\UnsummonTarget.mdl",u,"origin"))
  call TimerStart(t,dur,false,function Abbadon_Time_End)
  set t = null
  set p=null
endfunction

function Abbadon_Time_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  if LoadBoolean(MHT,'A0NS',GetHandleId(u)) then
    call Abbadon_Time_Effect(u,GetHandleId(u))
  else
    call Error(GetOwningPlayer(GetTriggerUnit()),"Spell is not ready yet.")
  endif
  
  set u = null
endfunction

function Abbadon_Time_Condition takes unit u, real d returns nothing
  local integer info = GetHandleId(u)
  if LoadBoolean(MHT,info,'A0NS')then
    if IsRealDamage then
      call Damage_Block(u,2*d,false)
    endif
  elseif LoadBoolean(MHT,'A0NS',info) and 400>GetWidgetLife(u) and GetUnitAbilityLevel(u,'BNdo')==0 then
    call Abbadon_Time_Effect(u,info)
  endif
endfunction

function Abbadon_Time_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer info = GetHandleId(u)
  if (GetUnitAbilityLevel(u,'A0NS')==1 or GetUnitAbilityLevel(u,'A1DA')==1) and IsUnitIllusion(u)==false then
    call SaveBoolean(MHT,info,1,true)
    call SaveBoolean(MHT,'A0NS',info,true)
    call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_DAMAGED)
  endif
  
  set u = null
endfunction

function P9F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=(LoadInteger(HY,h,(34)))
  local real Damage
  local integer DP9=10
  local unit W19
  if Level==1 then
    set Damage=16
  elseif Level==2 then
    set Damage=24
  elseif Level==3 then
    set Damage=32
  elseif Level==4 then
    set Damage=40
  endif
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetTriggerEvalCount(t)>1 and GetSpellAbilityId()=='A0S1' and IsBlocked(GetSpellTargetUnit())==false and Target==GetSpellTargetUnit()then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
    if IsPurge(GetSpellAbilityId()) and GetSpellTargetUnit()==Target then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
    set W19=GetKillingUnit()
    if WC8(W19)then
      set W19=(udg_Hero[GetPlayerId(GetOwningPlayer((W19)))])
    endif
    if GetTriggerUnit()==Target or W19==Target then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UnitRemoveAbility(Target,'A1W2')
      call UnitRemoveAbility(Target,'B0DO')
    endif
  else
    set Count=Count+1
    call SaveInteger(HY,h,(34),(Count))
    if GetUnitAbilityLevel(Target,'A1W2')==0 or Count==DP9 then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UnitRemoveAbility(Target,'A1W2')
      call UnitRemoveAbility(Target,'B0DO')
    endif
    call DamageTarget(Source,Target,1,Damage)
  endif
  set t=null
  set Source=null
  set Target=null
  set W19=null
  return false
endfunction

function PDF takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0S1')
  local real Damage
  local real DP9
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\ReviveDemon\\ReviveDemon.mdl",Target,"overhead"))
  call UnitAddAbility2(Target,'A1W2')
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function P9F))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(34),(0))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Other\\SoulBurn\\SoulBurnbuff.mdl",Target,"overhead")))
  set Source=null
  set Target=null
  set t=null
endfunction

function PEF takes nothing returns nothing
  if GetUnitAbilityLevel(GetEnumUnit(),'B0DO')>0 then
    set tt_int1=tt_int1+1
  endif
endfunction

function PFF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set tt_int1=0
  call GroupEnumUnitsInRange(g,0,0,9999,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function PEF)
  call KillGroup(g)
  if tt_int1==0 then
    if GetUnitAbilityLevel(Source,'B0EZ')>0 then
      call UnitRemoveAbility(Source,'A2AO')
      call UnitRemoveAbility(Source,'B0EZ')
    endif
  elseif GetUnitAbilityLevel(Source,'A2AO')!=tt_int1 then
    call UnitRemoveAbility(Source,'B0EZ')
    call UnitAddAbility2(Source,'A2AO')
    call SetUnitAbilityLevel(Source,'A2AO',tt_int1)
  endif
  set t=null
  set Source=null
  set g=null
  return false
endfunction

function PHF takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function PFF))
  call SaveUnitHandle(HY,h,2,(Source))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AR',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AS',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AU',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AT',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AQ',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2AP',false)
  set t=null
  set Source=null
endfunction

function Axe_BattleHunger takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call PDF()
  endif
endfunction

function PJF takes nothing returns boolean
  return((IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'B008')==0 and GetUnitAbilityLevel(GetFilterUnit(),'Bcyc')==0)!=null
endfunction

function PKF takes integer h,integer PMF returns nothing
  local integer i=1
  loop
    exitwhen i>PMF
    call DestroyEffect((LoadEffectHandle(HY,h,(2700+i))))
    set i=i+1
  endloop
endfunction

function PNF takes nothing returns nothing
  call UnitWakeUp(GetEnumUnit())
  call IssueTargetOrderById(GetEnumUnit(),851983,HY8)
endfunction

function POF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(220)))
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer PMF=(LoadInteger(HY,h,(365)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=(LoadInteger(HY,h,(34)))
  if GetTriggerEventId()!=EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER and GetTriggerEventId()!=EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER and GetTriggerEventId()!=EVENT_PLAYER_UNIT_ISSUED_ORDER then
    set Count=Count+1
    call SaveInteger(HY,h,(34),(Count))
    if Count==(8+2*Level)then
      call LoDStat_Sub(Hero,40,"armour")
      call UnitRemoveAbility(Hero,'A0I5')
      call KillGroup(g)
      call PKF(h,PMF)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      call DisableTrigger(t)
      set HY8=Hero
      call ForGroup(g,function PNF)
      call EnableTrigger(t)
    endif
  else
    if IsUnitInGroup(GetTriggerUnit(),g) and UnitIsSleeping(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),'B008')==0 and GetIssuedOrderId()!=851973 and HW8==false then
      call DisableTrigger(t)
      call IssueTargetOrderById(GetTriggerUnit(),851983,Hero)
      call EnableTrigger(t)
    endif
  endif
  set t=null
  set g=null
  set Hero=null
  return false
endfunction

function PPF takes nothing returns nothing
  local unit u = GetEnumUnit()
  
  set tt_int1=tt_int1+1
  
  call Buff_Add(u,LoDBuff_AbilID[3],LoDBuff_BuffID[3],GetUnitAbilityLevel(GetTriggerUnit(),'A0I6')*0.5+1)
  call SaveEffectHandle(HY,(WK),(2700+tt_int1),(AddSpecialEffectTarget("Abilities\\Weapons\\LavaSpawnMissile\\LavaSpawnBirthMissile.mdl",u,"chest")))
  
  set u = null
endfunction

function Axe_BerserkerCall takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0I6')
  local group g=GetAvailableGroup()
  
  set tt_unit1=Hero
  set HY8=Hero
  set tt_int1=0
  set WK=h
  call LoDStat_Add(Hero,40,"armour")
  call Buff_Add(Hero,LoDBuff_AbilID[4],LoDBuff_BuffID[4],Level*0.5+1)
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),325,Condition(function PJF))
  call ForGroup(g,function PPF)
  call ForGroup(g,function PNF)
  call SaveInteger(HY,h,(365),(tt_int1))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveGroupHandle(HY,h,(220),(g))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(34),(0))
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function POF))
  set t=null
  set g=null
  set Hero=null
endfunction

function CounterHelixFilter takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and((GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 or IsSiegeUnit(GetFilterUnit())) and (IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false) and IsDead(GetFilterUnit())==false))!=null
endfunction

function PSF takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),2,GetUnitAbilityLevel(GetTriggerUnit(),'P327')*35+65) //A0C6
endfunction

function PTF takes unit Hero returns nothing
  local group g=GetAvailableGroup()
  local unit u
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),300,Condition(function CounterHelixFilter))
  loop
    set u=FirstOfGroup(g)
    exitwhen u==null
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",u,"origin"))
    call DamageTarget(Hero,u,2,GetUnitAbilityLevel(Hero,'P327')*35+65)
    call GroupRemoveUnit(g,u)
  endloop
  //	call ForGroup(g,function PSF)
  if (GetUnitTypeId(Hero)!='Nbbc' and GetUnitTypeId(Hero)!='Opgh')then
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\SpinFX3.mdx",Hero,"origin"))
  else
    call SetUnitAnimation(Hero,"spin")
  endif
  call BF8(Hero,.6)
  call AddTimedKeyToUnit(Hero,4267,.5-.05*GetUnitAbilityLevel(Hero,'P327')) //A0C6
  call KillGroup(g)
endfunction

function AxeAttacked takes unit attacker, unit target returns nothing
  if GetUnitAbilityLevel(target,'B03P')>0 and IsUnitType(attacker,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(attacker,UNIT_TYPE_MECHANICAL)==false and GetUnitAbilityLevel(attacker,'A04R')==0 or IsSiegeUnit(attacker)) and IsUnitEnemy(attacker,GetOwningPlayer(target)) and LoadInteger(HY,GetHandleId(target),4267)!=1 and GetUnitAbilityLevel(target,'A1HX')==0 and PRD_Get(target,'B03P',20) then
    call PTF(target)
  endif
endfunction

function PVF takes nothing returns nothing
  call SetPlayerAbilityAvailable2(GetOwningPlayer(GetEnumUnit()),'A2IC',false)
  if TempBoolean then
    call UnitAddAbilityTimedExF(GetEnumUnit(),'A2IC',1,10,'B0FV')
  else
    call UnitAddAbilityTimedExF(GetEnumUnit(),'A2IC',1,6,'B0FV')
  endif
endfunction

function Axe_CullingBlade takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real OBF=GetWidgetLife(Target)
  local integer Level=GetUnitAbilityLevel(Hero,'A0E2')
  local unit Caster
  local boolean PYF=false
  local group g
  local real limit
  local integer spellid=GetSpellAbilityId()
  set limit=150+100*Level
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A1MR')
    if Level==1 then
      set limit=300
    elseif Level==2 then
      set limit=450
    else
      set limit=625
    endif
    set PYF=true
  endif
  if(OBF<=limit and GetUnitAbilityLevel(Target,'A21I')==0 and LoadBoolean(MHT,GetHandleId(Target),'A0NS')==false)then
    if PYF then
    endif
    set TempBoolean=PYF
    call PlaySoundOnUnitBJ(CC,100,Target)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile.mdl",Target,"overhead"))
    set Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',0,0,0)
    call UnitRemoveBuffs(Target,true,true)
    call UnitRemoveAbility(Target,'Aetl')
    call DamageTarget(Caster,Target,4,100000000)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\AxeUltiMSFX_01.mdx",Hero,"origin"))
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),925,Condition(function L58))
    call ForGroup(g,function PVF)
    call KillGroup(g)
    set g=null
    if IsUnitType(Target,UNIT_TYPE_HERO) then
      call UnitRemoveAbility(Hero,spellid)
      call UnitAddAbility2(Hero,spellid)
      call SetUnitAbilityLevel(Hero,spellid,Level)
      
      if SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(Hero))*PlayerSkillOffset+4]]=='A0E2' then //4th skill
        call TimerStart(PrimUltiTimer[GetPlayerId(GetOwningPlayer(Hero))],0.1,false,null)
      elseif SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(Hero))*PlayerSkillOffset+4]]=='A0E2' then //6th skill
        call TimerStart(SecUltiTimer[GetPlayerId(GetOwningPlayer(Hero))],0.1,false,null)
      endif
    endif
  endif
  set Hero=null
  set Target=null
  set Caster=null
endfunction

function Bane_BrainSap takes nothing returns nothing
  local unit u=GetTriggerUnit()
  if IsBlocked(GetSpellTargetUnit())==false then
    call DamageTarget(u,GetSpellTargetUnit(),3,20+70*GetUnitAbilityLevel(u,'A0GK'))
    if GetWidgetLife(u)>1 then
      call SetWidgetLife(u,GetWidgetLife(u)+20+70*GetUnitAbilityLevel(u,'A0GK'))
    endif
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",GetSpellTargetUnit(),"origin"))
  endif
  set u=null
endfunction

function PBF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,(30))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local integer Level=(LoadInteger(HY,h,5))
  local unit Caster
  if GetUnitAbilityLevel(Target,'B02F')==0 then
    if GetUnitAbilityLevel(Target,'A2O9')==1then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A04Y',true)
      call UnitRemoveAbility(Target,'A2O9')
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED and GetTriggerUnit()==Target then
    call UnitRemoveAbility(Target,'B02F')
    if GetUnitAbilityLevel(Target,'A2O9')==1then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A04Y',true)
      call UnitRemoveAbility(Target,'A2O9')
    endif
    set Caster=CreateUnit(p,'e00E',GetUnitX(Target),GetUnitY(Target),0)
    call UnitAddAbility2(Caster,'A04Y')
    call SetUnitAbilityLevel(Caster,'A04Y',Level)
    call IssueTargetOrderById(Caster,852227,GetAttacker())
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
    if GetWidgetLife(Target)>21 then
      call SetWidgetLife(Target,GetWidgetLife(Target)-20)
    else
      if GetUnitAbilityLevel(Target,'A2O9')==1 then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A04Y',true)
        call UnitRemoveAbility(Target,'A2O9')
      endif
      call UnitRemoveAbility(Target,'B02F')
      call DamageTarget(Source,Target,1,50)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set p=null
  set Caster=null
  set Target=null
  set Source=null
  return false
endfunction

function PCF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  set h=GetHandleId(t)
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveUnitHandle(HY,h,2,(Source))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(Source)))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Source,'A04Y')))
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function PBF))
  
  if Target==Source then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A04Y',false)
    call UnitAddAbility2(Target,'A2O9')
  endif
  
  set W67=true
  call DamageTarget(Source,Target,2,0)
  set W67=false
  set Source=null
  set Target=null
  set t=null
endfunction

function Bane_Nightmare takes nothing returns nothing
  if IsCourier(GetSpellTargetUnit())==false then
    call PCF()
  endif
endfunction

function Bane_Nightmare_OnCast takes nothing returns boolean
  if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    if GetOwningPlayer(GetTriggerUnit())!=GetOwningPlayer(GetSpellTargetUnit())and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139))then
      call InterruptUnit(GetTriggerUnit())
      call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
    endif
  endif
  return false
endfunction

function Nightmare_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  call UnitRemoveAbility(u,'B02F')
  call UnitRemoveAbility(u,'A2O9')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A04Y',true)
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Nightmare_End_Check takes nothing returns boolean
  local timer t = null
  local unit u = GetTriggerUnit()
  if GetIssuedOrderId()==String2OrderIdBJ("manashieldon")and GetUnitAbilityLevel(u,'A2O9')>0 then
    set t = CreateTimer()
    call TimerStart(t,0,false,function Nightmare_End)
    call SaveUnitHandle(MHT,GetHandleId(t),0,u)
    set t = null
  endif
  set u = null
  return false
endfunction

function N59 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function Nightmare_End_Check))
  set t=null
endfunction

function Bane_FiendGripUpg_Nightmare takes unit attacker, unit target returns nothing
  local unit u
  if LoadBoolean(MHT,GetHandleId(target),'Grip')==true then
    if IsUnitEnemy(attacker,GetOwningPlayer(target)) then
      set u=CreateUnit(GetOwningPlayer(attacker),'e00E',GetUnitX(target),GetUnitY(target),0)
      call UnitAddAbility2(u,'A04Y')
      call SetUnitAbilityLevel(u,'A04Y',2)
      call IssueTargetOrderById(u,852227,attacker)
      set u=null
    endif
  endif
endfunction

function PLF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real RLD
  local integer Count=6
  local fogmodifier fm=(LoadFogModifierHandle(HY,h,(42)))
  if GetUnitAbilityLevel(Source,'A1D9')>0 then
    set Count=7
  endif
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveBoolean(MHT,GetHandleId(Source),'Grip',false)
  elseif GetTriggerEvalCount(t)>Count then
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call InterruptUnit(Source)
    call SaveBoolean(MHT,GetHandleId(Source),'Grip',false)
  else
    if GetUnitAbilityLevel(Source,'A1D9')>0 then
      set RLD=RMinBJ(.1*GetUnitState(Target,UNIT_STATE_MAX_MANA),GetUnitState(Target,UNIT_STATE_MANA))
    else
      set RLD=RMinBJ(.05*GetUnitState(Target,UNIT_STATE_MAX_MANA),GetUnitState(Target,UNIT_STATE_MANA))
    endif
    if RLD>0 then
      call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+RLD)
      call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-RLD)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set fm=null
  return false
endfunction

function Bane_Grip takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local fogmodifier ff=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,GetUnitX(Target),GetUnitY(Target),350,true,true)
  call FogModifierStart(ff)
  call UnitRemoveAbility(Target,'B02F')
  call UnitRemoveAbility(Target,'BUsp')
  call UnitRemoveAbility(Target,'Bust')
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function PLF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveFogModifierHandle(HY,h,42,ff)
  call SaveBoolean(MHT,GetHandleId(Source),'Grip',GetUnitAbilityLevel(Source,'A1D9')>0)
  set Source=null
  set Target=null
  set t=null
  set ff=null
endfunction



function Bane_Enfeeble_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  
  call LoDStat_Sub(u,LoadInteger(MHT,info,0),"damageneg")
  call RemoveSavedHandle(MHT,GetHandleId(u),'A04V')
  
  call Timer_End(t)
  set t = null
  set u = null
endfunction

function Bane_Enfeeble_Start takes unit u returns nothing
  local unit d = GetTriggerUnit()
  local timer t = LoadTimerHandle(MHT,GetHandleId(u),'A04V')
  local integer info = GetHandleId(t)
  local integer amount = 30*GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(d))],'A04V')
  
  if t==null or GetUnitAbilityLevel(u,LoDBuff_BuffID[18])==0 or GetUnitTypeId(d)=='e00E' then
    set t = CreateTimer()
    set info = GetHandleId(t)
    
    call SaveTimerHandle(MHT,GetHandleId(u),'A04V',t)
    call SaveUnitHandle(MHT,info,0,u)
  else
    call LoDStat_Sub(u,LoadInteger(MHT,info,0),"damageneg")
  endif
  
  call SaveInteger(MHT,info,0,amount)
  call TimerStart(t,20,false,function Bane_Enfeeble_End)
  
  call LoDStat_Add(u,amount,"damageneg")
  call Buff_Add(u,LoDBuff_AbilID[18],LoDBuff_BuffID[18],20)
  
  set d = null
  set t = null
endfunction

function Bane_Enfeeble_Condition takes nothing returns nothing
  local unit t = GetSpellTargetUnit()
  
  if IsBlocked(t)==false then
    call Bane_Enfeeble_Start(t)
  endif
  
  set t = null
endfunction

function Q7F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Count=(LoadInteger(HY,(GetHandleId(Target)),(281)))
  local boolean Q8F=(LoadBoolean(HY,h,(280)))
  local real dmg
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
    call SaveInteger(HY,(GetHandleId(Target)),(281),(0))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetNapalmFactory(Target,0,0)
  elseif Count==0 then
    call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
    call SaveInteger(HY,(GetHandleId(Target)),(281),(0))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and Q8F==false then
    if Count>0 and GetUnitAbilityLevel(GetEventDamageSource(),'A1EL')>0 and(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))==GetEventDamageSource() and IsRealDamage then
      call SaveBoolean(HY,h,(280),(true))
      set dmg=(5+5*GetUnitAbilityLevel(Source,'A1EL'))*Count
      if I48 then
        set dmg=dmg*0.5
      endif
      if IsUnitType(Target,UNIT_TYPE_HERO)==false then
        set dmg=dmg*0.5
      endif
      if GetEventDamage()>25 or I48 then
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\LordofFlameMissile\\LordofFlameMissile.mdl",Target,"chest"))
        call DamageTarget(Source,Target,1,dmg)
      endif
      call SaveBoolean(HY,h,(280),(false))
    endif
  else
    call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target)*.3)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Q9F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real DRD=(LoadReal(HY,(GetHandleId(Target)),(675)))
  local integer StickyCount=(LoadInteger(HY,(GetHandleId(Target)),(281)))
  if(TimerGetElapsed(GlobalTimer))-DRD>=8 then
    call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target))
    call SaveInteger(HY,(GetHandleId(Target)),(281),(0))
    call SetNapalmFactory(Target,0,0)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function QDF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(Source,'A1EL')
  local integer Count=IMinBJ((LoadInteger(HY,(GetHandleId(Target)),(281)))+1,10)
  if IsMagicImmune(Target)then
    set Source=null
    set Target=null
    return
  endif
  call SetNapalmFactory(Target,Level,Count)
  call SaveInteger(HY,(GetHandleId(Target)),(281),(Count))
  call SaveReal(HY,(GetHandleId(Target)),(675),(((TimerGetElapsed(GlobalTimer)))*1.))
  call SetUnitTurnSpeed(Target,GetUnitDefaultTurnSpeed(Target)*.3)
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    call ZW8(GetOwningPlayer(Source),I2S(Count)+"!",2,Target,.026,50,0,255,216)
  endif
  if Count==1 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveBoolean(HY,h,(280),(false))
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function Q7F))
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,8,false)
  call TriggerAddCondition(t,Condition(function Q9F))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  set t=null
  set Source=null
  set Target=null
endfunction

function Batrider_StickyNapalm takes nothing returns nothing
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Source=GetTriggerUnit()
  local string s="Objects\\Spawnmodels\\Undead\\UndeadBlood\\UndeadBloodGargoyle.mdl"
  call GroupEnumUnitsInRange(g,x,y,400,Condition(function LR8))
  call ForGroup(g,function QDF)
  call TimedReveal(GetOwningPlayer(Source),2,x,y,500)
  call DestroyEffect(AddSpecialEffect(s,x,y))
  call DestroyEffect(AddSpecialEffect(s,x,y+130))
  call DestroyEffect(AddSpecialEffect(s,x,y-130))
  call DestroyEffect(AddSpecialEffect(s,x+130,y))
  call DestroyEffect(AddSpecialEffect(s,x+130,y+130))
  call DestroyEffect(AddSpecialEffect(s,x+130,y-130))
  call DestroyEffect(AddSpecialEffect(s,x-130,y))
  call DestroyEffect(AddSpecialEffect(s,x-130,y+130))
  call DestroyEffect(AddSpecialEffect(s,x-130,y-130))
  call KillGroup(g)
  set g=null
  set Source=null
endfunction

function Bat_Napalm_Preload takes nothing returns nothing
  local integer i
  set HZ8[1]='A1XC'
  set HZ8[2]='A1XB'
  set HZ8[3]='A1X4'
  set HZ8[4]='A1X5'
  set HZ8[5]='A1X6'
  set HZ8[6]='A1X7'
  set HZ8[7]='A1XA'
  set HZ8[8]='A1X8'
  set HZ8[9]='A1X9'
  set HZ8[10]='A1XD'
  set HA8[1]='A1XM'
  set HA8[2]='A1XE'
  set HA8[3]='A1XF'
  set HA8[4]='A1XG'
  set HA8[5]='A1XH'
  set HA8[6]='A1XI'
  set HA8[7]='A1XJ'
  set HA8[8]='A1XK'
  set HA8[9]='A1XN'
  set HA8[10]='A1XL'
  set HB8[1]='A1XO'
  set HB8[2]='A1XV'
  set HB8[3]='A1XW'
  set HB8[4]='A1XQ'
  set HB8[5]='A1XR'
  set HB8[6]='A1XS'
  set HB8[7]='A1XX'
  set HB8[8]='A1XT'
  set HB8[9]='A1XU'
  set HB8[10]='A1XP'
  set HC8[1]='A1XY'
  set HC8[2]='A1XZ'
  set HC8[3]='A1Y5'
  set HC8[4]='A1Y6'
  set HC8[5]='A1Y7'
  set HC8[6]='A1Y1'
  set HC8[7]='A1Y2'
  set HC8[8]='A1Y3'
  set HC8[9]='A1Y4'
  set HC8[10]='A1Y0'
  set i=1
  loop
    exitwhen i>10
    call PreloadQueryAdd(HZ8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call PreloadQueryAdd(HA8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call PreloadQueryAdd(HB8[i])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>10
    call PreloadQueryAdd(HC8[i])
    set i=i+1
  endloop
endfunction

function QGF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real a=(LoadReal(HY,h,(137)))
  local real d=(LoadReal(HY,h,(138)))
  local real x1=(LoadReal(HY,h,6))
  local real y1=(LoadReal(HY,h,7))
  local real x2
  local real y2
  local real x
  local real y
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>10 then
    call KillTrees(GetUnitX(Target),GetUnitY(Target),200)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set x2=x1+d*Cos(a)
    set y2=y1+d*Sin(a)
    if(IsPointInRegion(RestrictedRegion,((x2)*1.),((y2)*1.)))==false then
      call SaveReal(HY,h,6,((x2)*1.))
      call SaveReal(HY,h,7,((y2)*1.))
      set x=x2
      set y=y2
    else
      set x=x1
      set y=y1
    endif
    if IsUnitType(Target,UNIT_TYPE_HERO)==true then
      call SetUnitPosition(Target,x,y)
    else
      call SetUnitX(Target,x)
      call SetUnitY(Target,y)
    endif
  endif
  set t=null
  set Target=null
  return false
endfunction

function QHF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function QGF))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(137),((Atan2(GetUnitY(Target)-H08,GetUnitX(Target)-H18))*1.))
  call SaveReal(HY,h,(138),((RMaxIF((400-DistanceBetweenXY(H18,H08,GetUnitX(Target),GetUnitY(Target))),10)/ 10)*1.))
  call SaveReal(HY,h,6,((GetUnitX(Target))*1.))
  call SaveReal(HY,h,7,((GetUnitY(Target))*1.))
  set Source=null
  set Target=null
  set t=null
  call DamageTarget(H38,GetEnumUnit(),1,HL8*75)
endfunction

function QIF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real a=(LoadReal(HY,h,(137)))
  local group g=GetAvailableGroup()
  local unit Target
  local real x=GetUnitX(Caster)
  local real y=GetUnitY(Caster)
  local real WM3=(LoadReal(HY,h,6))
  local real WN3=(LoadReal(HY,h,7))
  set x=SafeX50(x+36*Cos(a))
  set y=SafeY50(y+36*Sin(a))
  call SetUnitX(Caster,x)
  call SetUnitY(Caster,y)
  set tt_unit1=Caster
  call GroupEnumUnitsInRange(g,x,y,125,Condition(function DefaultEnemyFilter))
  set Target=FirstOfGroup(g)
  call KillGroup(g)
  if DistanceBetweenXY(x,y,WM3,WN3)<40 or GetTriggerEvalCount(t)>100 then
    set Target=null
    set x=WM3
    set y=WN3
    set H38=Source
    set HL8=(LoadInteger(HY,h,5))
    if Target==null then
      set H18=x
      set H08=y
    else
      set H18=GetUnitX(Target)
      set H08=GetUnitY(Target)
    endif
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,400,Condition(function NonImmuneEnemyFilter))
    if Target!=null then
      call GroupRemoveUnit(g,Target)
      call StunTargetLod(Target,.3)
      call DamageTarget(H38,Target,1,HL8*75)
    endif
    call ForGroup(g,function QHF)
    call KillUnit(Caster)
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set Caster=null
  set Source=null
  set g=null
  return false
endfunction

function Batrider_FlameBreak takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A19V')
  local unit Caster
  set Caster=CreateUnit(GetOwningPlayer(Source),'h0ED',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveReal(HY,h,6,((x)*1.0))
  call SaveReal(HY,h,7,((y)*1.0))
  call TriggerRegisterTimerEvent(t,.04,true)
  call TriggerAddCondition(t,Condition(function QIF))
  set Source=null
  set Caster=null
  set t=null
endfunction

function QMF takes nothing returns nothing
  local unit Source=H58
  local unit H3D=GetEnumUnit()
  local unit Target
  local group g
  if GetUnitCurrentOrder(H3D)==0 then
    set g=GetAvailableGroup()
    set tt_unit1=H3D
    call GroupEnumUnitsInRange(g,GetUnitX(H3D),GetUnitY(H3D),825,Condition(function DefaultEnemyFilter))
    set Target=FirstOfGroup(g)
    if Target!=null then
      call GroupRemoveUnit(g,Target)
    endif
    if FirstOfGroup(g)==null and Target==Source then
      call IssueTargetOrderById(H3D,851983,Target)
    endif
    call KillGroup(g)
    set Target=null
    set g=null
  endif
  set Source=null
  set H3D=null
endfunction

function QNF takes unit Source returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set H58=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1000,Condition(function DN9))
  call ForGroup(g,function QMF)
  call KillGroup(g)
  set g=null
endfunction

function QOF takes nothing returns nothing
  call DamageTarget(H58,GetEnumUnit(),1,I78)
endfunction

function QPF takes unit Source,integer h,integer Count, integer lvl returns nothing
  local group g1=GetAvailableGroup()
  local group g2=GetAvailableGroup()
  local integer i=0
  set tt_unit1=Source
  loop
    exitwhen i>Count
    call GroupEnumUnitsInRange(g2,LoadReal(HY,h,2300+i),LoadReal(HY,h,2500+i),225,Condition(function DefaultEnemyFilter))
    call GroupAddGroup(g2,g1)
    call GroupClear(g2)
    set i=i+1
  endloop
  call KillGroup(g2)
  if FirstOfGroup(g1)!=null then
    set H58=Source
    set I78=lvl*10
    call ForGroup(g1,function QOF)
  endif
  call KillGroup(g1)
  set g1=null
  set g2=null
endfunction

function QQF takes nothing returns boolean
  local unit Source=null
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=LoadInteger(HY,h,34)
  local integer i
  local real x
  local real y
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEvalCount(t)>360 then
    set i=0
    loop
      exitwhen i>Count
      call DestroyEffect(LoadEffectHandle(HY,h,2700 + i))
      set i=i+1
    endloop
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set t = null
    return false
  endif
  set Source = LoadUnitHandle(HY,h,2)
  set x = GetWidgetX(Source)
  set y = GetWidgetY(Source)
  if udg_ObserverMode then
    call QNF(Source)
  endif
  if DistanceBetweenXY(x,y,LoadReal(HY,h,23),LoadReal(HY,h,24)) >125 then
    set Count=Count+1
    call SaveInteger(HY,h,34,Count)
    call SaveReal(HY,h,23,x*1.)
    call SaveReal(HY,h,24,y*1.)
    call SaveEffectHandle(HY,h,2700+Count,AddSpecialEffect("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",x,y))
    call SaveReal(HY,h,2300+Count,x*1.)
    call SaveReal(HY,h,2500+Count,y*1.)
  endif
  
  if ModuloInteger(GetTriggerEvalCount(t),10)==0 then
    set I48=true
    call QPF(Source,h,Count,lvl)
    set I48=false
  endif
  
  if IsDead(Source)==false then
    call KillTrees(x,y,100)
  endif
  
  set Source = null
  set t = null
  return false
endfunction

function QRF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetWidgetX(Source)
  local real y=GetWidgetY(Source)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function QQF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveEffectHandle(HY,h,2700,AddSpecialEffect("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",x,y))
  call SaveReal(HY,h,23,x*1.)
  call SaveReal(HY,h,24,y*1.)
  call SaveReal(HY,h,2300,x*1.)
  call SaveReal(HY,h,2500,y*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set Source=null
  set t=null
endfunction

function QTF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,false)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function QUF takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  call SetTerrainPathable(x,y,PATHING_TYPE_WALKABILITY,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function QTF))
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  set Source=null
  set t=null
endfunction

function Batrider_Firefly takes nothing returns nothing
  if GetUnitTypeId(GetTriggerUnit())!='O017' then
    call QRF()
    if(GetRandomInt(1,10)==1)then
      call PlaySoundOnUnitBJ(ResQFun,100,GetTriggerUnit())
    endif
  elseif IsTerrainPathable(GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),PATHING_TYPE_WALKABILITY)then
    call QUF()
  endif
endfunction

function QWF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local real d=DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
  local real a
  local real DP9=LoadReal(HY,h,57)
  local real x0=LoadReal(HY,h,282)
  local real y0=LoadReal(HY,h,283)
  local real x1
  local real y1
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>R2I(20*DP9)then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Caster)
    call SetUnitPathing(Target,true)
    call KillTrees(GetUnitX(Target),GetUnitY(Target),175)
    call UnitRemoveAbility(Source,'Abun')
  else
    call SetUnitX(Caster,GetUnitX(Source))
    call SetUnitY(Caster,GetUnitY(Source))
    if DistanceBetweenXY(x0,y0,GetUnitX(Source),GetUnitY(Source))>400 then
      call DestroyEffect(LoadEffectHandle(HY,h,32))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call KillUnit(Caster)
      call SetUnitPathing(Target,true)
      call KillTrees(GetUnitX(Target),GetUnitY(Target),175)
      call UnitRemoveAbility(Source,'Abun')
    else
      call SaveReal(HY,h,282,GetUnitX(Source)*1.)
      call SaveReal(HY,h,283,GetUnitY(Source)*1.)
      if d>300 then
        set a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
        set x1=GetUnitX(Source)+300*Cos(a)
        set y1=GetUnitY(Source)+300*Sin(a)
        if(IsPointInRegion(RestrictedRegion,x1*1.,y1*1.))==false then
          call SetUnitX(Target,x1)
          call SetUnitY(Target,y1)
        endif
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  return false
endfunction

function QXF takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'u00Y',GetUnitX(Source),GetUnitY(Source),0)
  local integer Level=GetUnitAbilityLevel(Source,'A19O')
  call UnitAddAbility2(Source,'Abun')
  call UnitAddAbility2(Caster,'A19N')
  call SetUnitAbilityLevel(Caster,'A19N',GetUnitAbilityLevel(Source,'A19O'))
  call IssueTargetOrderById(Caster,852480,Target)
  call SetUnitPathing(Caster,false)
  call SetUnitPathing(Target,false)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function QWF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveReal(HY,h,57,(2.5+Level*.5)*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Human\\AerialShackles\\AerialShacklesTarget.mdl",Target,"chest"))
  call SaveReal(HY,h,282,GetUnitX(Source)*1.)
  call SaveReal(HY,h,283,GetUnitY(Source)*1.)
  set t=null
  set Source=null
  set Target=null
  set Caster=null
endfunction

function Batrider_FlamingLasso takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false and GetUnitTypeId(GetSpellTargetUnit())!='n00L' then
    call QXF()
  endif
endfunction

function QZF takes unit Source,unit Target,real QQE returns nothing
  call SetWidgetLife(Source,GetWidgetLife(Source)+GetUnitState(Target,UNIT_STATE_MAX_LIFE)*QQE)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HeroBloodElfBlood.mdl",Source,"overhead"))
endfunction

function QAF takes nothing returns boolean
  if IsDead(GetFilterUnit())==false and IMaxIF(GetUnitAbilityLevel(GetFilterUnit(),'A0LE'),GetUnitAbilityLevel(GetFilterUnit(),'QP1Y'))>0 and IsUnitEnemy(I88,GetOwningPlayer(GetFilterUnit()))then
    call QZF(GetFilterUnit(),I88,IMaxIF(GetUnitAbilityLevel(GetFilterUnit(),'A0LE'),GetUnitAbilityLevel(GetFilterUnit(),'QP1Y'))*.1*.5)
  endif
  return false
endfunction

function QBF takes unit Source,unit Target,integer Level returns nothing
  local group g=GetAvailableGroup()
  set I88=Target
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350,Condition(function QAF))
  call KillGroup(g)
  set I88=null
  set g=null
endfunction

function BS_BloodBath_Clear takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  local boolean ishero=LoadBoolean(HY,h,0)
  local integer bonus1=lvl*10
  local integer bonus2=lvl*5
  if ishero then
    set bonus1=bonus1*2
    set bonus2=bonus2*2
  endif
  call LoDStat_Sub(u,bonus1,"attack")
  call LoDStat_Sub(u,bonus2,"damage")
  call UnitRemoveAbility(u,'A33M')
  call UnitRemoveAbility(u,'B0GY')
  call SaveBoolean(MHT,GetHandleId(u),'A0LE',false)
  call RemoveSavedHandle(MHT,GetHandleId(u),'A0LE')
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set u=null
  set t=null
endfunction

function BS_BloodBath_Start takes unit u, integer lvl, boolean ishero returns nothing
  local integer oldlvl
  local timer t
  local real r
  local integer h=GetHandleId(u)
  local boolean b=LoadBoolean(MHT,h,'A0LE')//timer exists?
  local integer oldbonus1
  local integer oldbonus2
  local real duration=5
  local integer heromult=1
  if ishero then
    set duration=20
    set heromult=2
  endif
  if b then
    set t=LoadTimerHandle(MHT,h,'A0LE')
    set oldlvl=LoadInteger(HY,GetHandleId(t),0)
    
    set oldbonus1=oldlvl*10
    set oldbonus2=oldlvl*5
    if LoadBoolean(HY,GetHandleId(t),0) then
      set oldbonus1=oldbonus1*2
      set oldbonus2=oldbonus2*2
    endif
    if TimerGetRemaining(t)<duration or oldbonus1<lvl*10*heromult then
      call TimerStart(t,duration,false,function BS_BloodBath_Clear)
      if oldbonus1<lvl*10*heromult then
        call LoDStat_Add(u,lvl*10*heromult-oldbonus1,"attack")
        call LoDStat_Add(u,lvl*5*heromult-oldbonus2,"damage")
        call SaveInteger(HY,GetHandleId(t),0,lvl)
        call SaveBoolean(HY,GetHandleId(t),0,ishero)
      endif
    endif
  else
    call SaveBoolean(MHT,h,'A0LE',true)
    set t=CreateTimer()
    call TimerStart(t,duration,false,function BS_BloodBath_Clear)
    call SaveBoolean(HY,GetHandleId(t),0,ishero)
    call SaveInteger(HY,GetHandleId(t),0,lvl)
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
    call SaveTimerHandle(MHT,h,'A0LE',t)
    call LoDStat_Add(u,lvl*10*heromult,"attack")
    call LoDStat_Add(u,lvl*5*heromult,"damage")
    call UnitAddAbility2(u,'A33M')
  endif
  set t=null
endfunction

function BS_BloodBath takes unit Source, unit Target returns nothing
  local integer lvl
  if GetUnitTypeId(Source)=='e00E' or IsUnitType(Source,UNIT_TYPE_HERO)==false then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  set lvl=GetUnitAbilityLevel(Source,'A0LE')+GetUnitAbilityLevel(Source,'QP1Y')
  if IsUnitIllusion(Target)==false and IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(Target)!='n00L' and GetUnitAbilityLevel(Source,'BNdo')==0 then
    if IsUnitType(Target,UNIT_TYPE_HERO)==false then
      if lvl>0 then
        call BS_BloodBath_Start(Source,lvl,false)
        call QZF(Source,Target,lvl*.05+.05)
      endif
    else
      if lvl>0 then
        call BS_BloodBath_Start(Source,lvl,true)
        call QZF(Source,Target,lvl*.1)
        
      else
        call QBF(Source,Target,lvl)
      endif
    endif
  endif
endfunction

function Q3F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local real LastX=(LoadReal(HY,h,(23)))
  local real LastY=(LoadReal(HY,h,(24)))
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real d=SquareRoot((LastX-x)*(LastX-x)+(LastY-y)*(LastY-y))
  local real dmg=.2*Level*d
  local integer tic=(LoadInteger(HY,h,(25)))
  if d>1300 then
    set dmg=0
  endif
  if dmg>5 then
    call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"origin"))
  endif
  if dmg>0 and IsDead(Target)==false then
    call DamageTarget(Source,Target,9,dmg)
  endif
  call SaveReal(HY,h,(23),((x)*1.))
  call SaveReal(HY,h,(24),((y)*1.))
  call SaveInteger(HY,h,(25),(tic+1))
  if IsDead(Target)then
    call UnitRemoveAbility(Target,'A0IH')
    call UnitRemoveAbility(Target,'B08L')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif tic>4*(6+Level)then
    call UnitRemoveAbility(Target,'A0IH')
    call UnitRemoveAbility(Target,'B08L')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Q6F takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A0LH')
  call UnitAddAbility2(Target,'A0IH')
  call SetUnitAbilityLevel(Target,'A0IH',Level)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"chest"))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(23),((GetUnitX(Target))*1.))
  call SaveReal(HY,h,(24),((GetUnitY(Target))*1.))
  call SaveInteger(HY,h,(25),(0))
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function Q3F))
  call DamageTarget(Source,Target,6,50+100*Level)
  set Source=null
  set Target=null
  set t=null
endfunction

function BS_Rupture takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false and IsCourier(GetSpellTargetUnit())==false then
    call Q6F()
  endif
endfunction

function Thirst_IsUnitLowHP takes unit u returns boolean
  local real life
  local real limit=.3
  if IsDead(u) then
    return false
  endif
  if IsDead(IF8)==false then
    set life = GetWidgetLife(u)/GetUnitState(u,UNIT_STATE_MAX_LIFE)
    return 0.25 > life or (life<limit and GenericCondition_IsDotAInvis(u)==false)
  endif
  return false
endfunction

function Thirst_StickDummiesTo takes unit u returns nothing
  local unit dummy
  local integer h=GetHandleId(u)
  if(LoadBoolean(HeroStats,h,24)==false)then//dummy not created yet
    call SaveBoolean(HeroStats,h,24,true)
    set dummy=CreateUnit(GetOwningPlayer(IF8),'hBST',GetUnitX(u),GetUnitY(u),0)
    call SaveUnitHandle(HeroStats,h,24,dummy)
    call SetUnitMoveSpeed(dummy,522)
    call IssueTargetOrderById(dummy,851986,u)
  else
    set dummy=LoadUnitHandle(HeroStats,h,24)
    call SetUnitX(dummy,GetUnitX(u))
    call SetUnitY(dummy,GetUnitY(u))
    
    if GenericCondition_IsDotAInvis(u) then
      if GetUnitAbilityLevel(u,'A1HX')>0 then
        call UnitRemoveAbility(dummy,'A30X')
      elseif GetUnitAbilityLevel(dummy,'A30X')==0 then
        call UnitAddAbility(dummy,'A30X')
      endif
    else
      if GetUnitAbilityLevel(dummy,'A30X')>0 then
        call UnitRemoveAbility(dummy,'A30X')
      endif
    endif
  endif
  set dummy=null
endfunction

function Thirst_DeleteDummiesFrom takes unit u returns nothing
  local integer h=GetHandleId(u)
  if(LoadBoolean(HeroStats,h,24))then//dummy was created
    call SaveBoolean(HeroStats,h,24,false)
    call SetUnitPosition(LoadUnitHandle(HeroStats,h,24),7536,-7632)
    call KillUnit(LoadUnitHandle(HeroStats,h,24))
    call UnitRemoveAbility(u,'B0EY')
  endif
endfunction

function Q2F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=GetUnitAbilityLevel(Source,'A0I8')+GetUnitAbilityLevel(Source,'QP1Z')
  local integer damage=Level*10-5
  local boolean BonusHere=LoadBoolean(HY,h,0)
  local integer BonusVal=LoadInteger(HY,h,0)
  local integer msbonus=LoadInteger(HY,h,2)
  local integer count=0
  local integer msboost=0
  local integer fpi=1//first player index
  local integer lpi=5//last player index
  local integer i=0
  local unit u
  if IsSentinel(GetOwningPlayer(Source)) then
    set fpi=7
    set lpi=11
  endif
  set i=fpi
  loop
    set u=udg_Hero[i]
    if u!=null then
      set IF8=Source
      if(Thirst_IsUnitLowHP(u))then
        call Thirst_StickDummiesTo(u)
        set count=count+1
      elseif(LoadBoolean(HeroStats,GetHandleId(u),24))then
        call Thirst_DeleteDummiesFrom(u)
      endif
    endif
    set i=i+1
    exitwhen i>lpi
  endloop
  if count==0 then
    call SaveInteger(HY,h,2,0)
    call UnitRemoveAbility(Source,'A214')
    if BonusHere then
      call LoDStat_Sub(Source,BonusVal,"damage")
      call SaveBoolean(HY,h,0,false)
    endif
    call SaveInteger(HeroStats,GetHandleId(Source),'A214',0)
  else
    set damage=damage*count
    if BonusHere==false then
      call LoDStat_Add(Source,damage,"damage")
      call SaveBoolean(HY,h,0,true)
      call SaveInteger(HY,h,0,damage)
    elseif BonusVal!=damage then
      call LoDStat_Sub(Source,BonusVal,"damage")
      call LoDStat_Add(Source,damage,"damage")
      call SaveInteger(HY,h,0,damage)
    endif
    set msboost=Level*7*count
    if msboost!=msbonus then
      call SaveInteger(HY,h,2,msboost)
    endif
    call SaveInteger(HeroStats,GetHandleId(Source),'A214',count)
    call SaveInteger(HeroStats,GetHandleId(Source),'A215',Level)
    call UnitAddAbility2(Source,'A214')
  endif
  set t=null
  set Source=null
  set u=null
  return false
endfunction

function BS_RemoveSpeedCap_Moveunit takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer bonus=LoadInteger(HY,h,0)
  local real x
  local real y
  local real dx
  local real dy
  local real angle
  local real ms
  local real d
  local real angle2
  local real i=1
  local real currentspeed=GetUnitDefaultMoveSpeed(u)+GetUnitOffsetSpeed(u)
  if currentspeed>1000 then
    set currentspeed=1000-522
  endif
  if LoadBoolean(HY,h,0) then
    set bonus=100
  endif
  call SaveReal(HeroStats,GetHandleId(u),99,R2I(currentspeed*bonus/100))
  if bonus>0 and IsDead(u)==false then
    set x=GetUnitX(u)
    set y=GetUnitY(u)
    set dx=LoadReal(HY,h,10)
    set dy=LoadReal(HY,h,11)
    set d=DistanceBetweenXY(dx,dy,x,y)
    if LoadBoolean(HeroStats,GetHandleId(u),99)==false then//not triggered
      if (d<100 and d>1) and GetUnitCurrentOrder(u)!=851993 and GetUnitCurrentOrder(u)!=851972 and GetUnitCurrentOrder(u)!=851973 then//not holded, stopped or stunned
        set angle=Atan2(y-dy,x-dx)
        set ms=currentspeed*bonus*ThirstInterval/100
        call SaveReal(HeroStats,GetHandleId(u),99,R2I(ms*(1/ThirstInterval)))
        call SetUnitX(u,SafeX50(x+ms*Cos(angle)))
        call SetUnitY(u,SafeY50(y+ms*Sin(angle)))
      endif
    else
      call SaveBoolean(HeroStats,GetHandleId(u),99,false)
    endif
    call SaveReal(HY,h,10,GetUnitX(u))
    call SaveReal(HY,h,11,GetUnitY(u))
  endif
  set t=null
  set u=null
endfunction

function BS_RemoveSpeedCap takes unit u, integer bonus,boolean isVoid returns nothing
  local timer t
  if LoadBoolean(HeroStats,GetHandleId(u),'A214')==false then
    call SaveBoolean(HeroStats,GetHandleId(u),'A214',true)//timer created
    set t=CreateTimer()
    call TimerStart(t,ThirstInterval,true,function BS_RemoveSpeedCap_Moveunit)
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
    call SaveReal(HY,GetHandleId(t),10,GetUnitX(u))
    call SaveReal(HY,GetHandleId(t),11,GetUnitY(u))
    call SaveBoolean(HY,GetHandleId(t),100,true)
    call SaveTimerHandle(HeroStats,GetHandleId(u),'A214',t)
  else
    set t=LoadTimerHandle(HeroStats,GetHandleId(u),'A214')
  endif
  call SaveInteger(HY,GetHandleId(t),0,bonus)
  call SaveBoolean(HY,GetHandleId(t),0,isVoid)
  if isVoid then
    set bonus=100
  endif
  if bonus==0 then
    call PauseTimer(t)
    call SaveReal(HeroStats,GetHandleId(u),99,0)
    call SaveBoolean(HY,GetHandleId(t),100,false)
  elseif LoadBoolean(HY,GetHandleId(t),100)==false then
    call TimerStart(t,ThirstInterval,true,function BS_RemoveSpeedCap_Moveunit)
    call SaveBoolean(HY,GetHandleId(t),100,true)
  endif
  set t=null
endfunction

function BS_update_dummies takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer i=1
  local integer count=LoadInteger(HeroStats,GetHandleId(u),'A214')
  local integer Level=LoadInteger(HeroStats,GetHandleId(u),'A215')
  local integer bonus=(10*Level-5)*count
  loop
    if(LoadBoolean(HeroStats,GetHandleId(udg_Hero[i]),24))then
      call SetUnitX(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),GetUnitX(udg_Hero[i]))
      call SetUnitY(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),GetUnitY(udg_Hero[i]))
      call IssueTargetOrderById(LoadUnitHandle(HeroStats,GetHandleId(udg_Hero[i]),24),851986,udg_Hero[i])
    endif
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>11
  endloop
  call CustomSpeed(u,bonus,0)
  set t=null
  set u=null
endfunction

function Bloodseeker_Thrist_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function Q2F))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function BS_update_dummies))
  call SaveUnitHandle(HY,GetHandleId(t),0,Source)
  set t=null
  set Source=null
endfunction

function BS_Bloodrage_Action takes nothing returns nothing
  local unit Target
  local unit Dummy
  set Target=GetSpellTargetUnit()
  set Dummy=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility(Dummy,'A2TN')
  call IssueTargetOrderById(Dummy,852111,Target)
  if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Target))==false then
    call UnitRemoveAbility(Target,'Aetl')
  endif
  set Target=null
  set Dummy=null
endfunction

function BS_Bloodrage_StopCastInit takes nothing returns nothing
  if GetSpellTargetUnit()!=GetTriggerUnit()and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
  endif
endfunction

function RDF takes nothing returns boolean
  return GetUnitTypeId(GetSummonedUnit())=='o003'
endfunction

function REF takes nothing returns nothing
  local unit RFF=GetSummonedUnit()
  local unit RGF=udg_Hero[GetPlayerId(GetOwningPlayer(GetSummoningUnit()))]
  local integer h=GetHandleId(RGF)
  local integer Level=GetUnitAbilityLevel(RGF,'Z234') //A0BG
  local integer RHF=(LoadInteger(HY,h,(279)))
  local unit RIF=(LoadUnitHandle(HY,h,(1400+1)))
  local integer x=1
  set RHF=RHF+1
  call SetUnitVertexColorBJ(RFF,100,100,100,85)
  call UnitAddAbility2(RFF,'Aloc')
  call SaveUnitHandle(HY,h,(1400+RHF),(RFF))
  if(RHF>Level*2)then
    call KillUnit(RIF)
    loop
      exitwhen x==RHF
      call SaveUnitHandle(HY,h,(1400+x),((LoadUnitHandle(HY,h,(1400+x+1)))))
      set x=x+1
    endloop
    set RHF=RHF-1
  endif
  call SaveInteger(HY,h,(279),(RHF))
  call SetUnitAbilityLevel(RFF,'A0BF',Level)
  set RFF=null
  set RGF=null
  set RIF=null
endfunction

function LoDSpinWeb_Cast takes nothing returns nothing
  local unit RFF=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'o003',GetSpellTargetX(),GetSpellTargetY(),0)
  local unit RGF=udg_Hero[GetPlayerId(GetOwningPlayer(RFF))]
  local integer h=GetHandleId(RGF)
  local integer Level=GetUnitAbilityLevel(RGF,'Z234') //A0BG
  local integer RHF=(LoadInteger(HY,h,(279)))
  local unit RIF=(LoadUnitHandle(HY,h,(1400+1)))
  local integer x=1
  call SetUnitAnimation(RFF,"birth")
  call QueueUnitAnimation(RFF,"stand")
  set RHF=RHF+1
  call SetUnitVertexColorBJ(RFF,100,100,100,85)
  call UnitAddAbility2(RFF,'Aloc')
  call SaveUnitHandle(HY,h,(1400+RHF),(RFF))
  if(RHF>Level*2)then
    call KillUnit(RIF)
    loop
      exitwhen x==RHF
      call SaveUnitHandle(HY,h,(1400+x),((LoadUnitHandle(HY,h,(1400+x+1)))))
      set x=x+1
    endloop
    set RHF=RHF-1
  endif
  call SaveInteger(HY,h,(279),(RHF))
  call SetUnitAbilityLevel(RFF,'A0BF',Level)
  set RFF=null
  set RGF=null
  set RIF=null
endfunction


function OE9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function RDF))
  call TriggerAddAction(t,function REF)
  set t=null
endfunction

function Brood_WebAllies takes nothing returns boolean
  return GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(BroodWebTemp) and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0
endfunction

function Brood_Web_OutOfRange takes nothing returns nothing
  local real x
  local real y
  local unit web
  local integer i=1
  local unit u
  local boolean b=false
  set u=udg_Hero[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]
  if u!=null then
    loop
      set web=LoadUnitHandle(HY,GetHandleId(u),1400+i)
      if web!=null then
        set x=GetUnitX(web)
        set y=GetUnitY(web)
        if(DistanceBetweenXY(x,y,GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()))<875)then
          set b=true
        endif
      else 
        set i=9
      endif
      set i=i+1
      exitwhen i>9 or b
    endloop
  endif
  if b==false then
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)then
      call UnitRemoveAbility(GetEnumUnit(),'A021')
    else
      call UnitRemoveAbility(GetEnumUnit(),'A29C')
    endif
    call UnitRemoveAbility(GetEnumUnit(),'B01C')
    call SetUnitPathing(GetEnumUnit(),true)
  endif
  set web=null
  set u=null
endfunction

function Brood_Web_InRange takes nothing returns nothing
  local unit u=GetEnumUnit()
  if IsUnitType(u,UNIT_TYPE_HERO)then
    if GetUnitAbilityLevel(u,'A021')==0 then
      call UnitAddAbility(u,'A021')
    endif
  else
    if GetUnitAbilityLevel(u,'A29C')==0 then
      call UnitAddAbility(u,'A29C')
    endif
  endif
  call SetUnitPathing(u,LastTimeDamaged_ForDagger[GetPlayerId(GetOwningPlayer(u))]+3 > TimerGetElapsed(GlobalTimer) )
  set u=null
endfunction

function Brood_WebDuration takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g
  local group gg
  local unit u
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyGroup(LoadGroupHandle(HY,h,1))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if LoadBoolean(HY,h,0)==false then
      set g=CreateGroup()
      call SaveBoolean(HY,h,0,true)
      call SaveGroupHandle(HY,h,1,g)
    endif
    set u=LoadUnitHandle(HY,h,0)
    set g=LoadGroupHandle(HY,h,1)
    
    set gg=GetAvailableGroup()
    set BroodWebTemp=u
    call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),900,Condition(function Brood_WebAllies))
    call GroupRemoveGroup(gg,g)//
    set BroodWebTemp=u
    call ForGroup(g,function Brood_Web_OutOfRange)
    call ForGroup(gg,function Brood_Web_InRange)
    call GroupClear(g)
    call GroupAddGroup(gg,g)
    call KillGroup(gg)
    set gg=null
  endif
  set t=null
  set g=null
  set u=null
endfunction

function Brood_WebDecected takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.3,true)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Brood_WebDuration))
  call SaveUnitHandle(HY,h,0,GetTriggerUnit())
  call SaveBoolean(HY,h,0,false)
  set t=null
endfunction

function Brood_RegisterSpinWeb takes nothing returns nothing
  if GetUnitTypeId(GetTriggerUnit())=='o003' then
    call Brood_WebDecected()
  endif
endfunction

function Brood_RegisterSpinWebAppears takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function Brood_RegisterSpinWeb))
  set t=null
endfunction

function RQF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  if GetTriggerEventId()!=EVENT_PLAYER_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and IsPurge(GetSpellAbilityId())and GetSpellTargetUnit()==Hero)then
    if IsDead(Hero)==false then
      call UnitRemoveAbility(Hero,'A0WR')
      call UnitRemoveAbility(Hero,'B01E')
    endif
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function Brood_Hunger takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,14,false)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function RQF))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Items\\VampiricPotion\\VampPotionCaster.mdl",Hero,"origin")))
  call UnitAddAbility2(Hero,'A0WR')
  call SetUnitAbilityLevel(Hero,'A0WR',GetUnitAbilityLevel(Hero,'A0WQ'))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A0WR',false)
  set t=null
  set Hero=null
endfunction

function RTF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  if GetTriggerEvalCount(t)>300 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetUnitAbilityLevel(Target,'B0E7')>0 then
    call DamageTarget(Source,Target,1,LoadInteger(HY,h,0)*75)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Brood_SpawnSpiderlings takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function RTF))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,GetSpellTargetUnit())
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=null
  set Source=null
endfunction






function Chaos_Bolt_Damage takes nothing returns boolean
  local texttag text
  local unit u
  local trigger trig = GetTriggeringTrigger()
  local integer info = GetHandleId(trig)
  local integer i
  local real d
  
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call FlushChildHashtable(MHT,info)
    call CleanTrigger(trig)
  elseif GetEventDamageSource()==LoadUnitHandle(MHT,info,0) then
    set text = CreateTextTag()
    set d = LoadReal(MHT,info,0)
    set i = LoadInteger(MHT,info,0)
    set u = LoadUnitHandle(MHT,info,2)
    call StunTargetLod(u,i*1.0)
    call SetTextTagText(text,"+"+I2S(R2I(d)),.025) //damage
    call SetTextTagPosUnit(text,u,10)
    call SetTextTagColor(text,255,0,0,255)
    call SetTextTagVelocity(text,0,.0355)
    call SetTextTagFadepoint(text,2)
    call SetTextTagPermanent(text,false)
    call SetTextTagLifespan(text,2)
    
    call TextTagOnUnit(I2S(i),i,u,.03,127,127,255,255) //stun
    
    call DamageTarget(LoadUnitHandle(MHT,info,1),u,1,d)
    call FlushChildHashtable(MHT,info)
    call CleanTrigger(trig)
    set text = null
    set u = null
  endif
  
  set trig = null
  return false
endfunction

function Chaos_Bolt_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit t = GetSpellTargetUnit()
  local unit d = CreateUnit(GetOwningPlayer(t),'e00E',GetWidgetX(u),GetWidgetY(u),0)
  local trigger trig = CreateTrigger()
  local integer level = GetUnitAbilityLevel(u,'A055')+GetUnitAbilityLevel(u,'QB00')
  local integer info = GetHandleId(trig)
  local integer stun
  set stun=GetRandomInt(1 + level/4,1 + level - level/4)//this is correct and doesnt require an additional if statement, so dont change it
  if level==1 then
    call SaveReal(MHT,info,0,200/stun)
  elseif level==2 then
    if stun==1 then
      call SaveReal(MHT,info,0,225)
    elseif stun==2 then
      call SaveReal(MHT,info,0,150)
    elseif stun==3 then
      call SaveReal(MHT,info,0,50)
    endif
  elseif level==3 then
    if stun==1 then
      call SaveReal(MHT,info,0,250)
    elseif stun==2 then
      call SaveReal(MHT,info,0,175)
    elseif stun==3 then
      call SaveReal(MHT,info,0,100)
    elseif stun==4 then
      call SaveReal(MHT,info,0,75)
    endif
  else
    if stun==2 then
      call SaveReal(MHT,info,0,275)
    elseif stun==3 then
      call SaveReal(MHT,info,0,180)
    elseif stun==4 then
      call SaveReal(MHT,info,0,100)
    endif
  endif
  call SaveUnitHandle(MHT,info,0,d)
  call SaveUnitHandle(MHT,info,1,u)
  call SaveUnitHandle(MHT,info,2,t)
  call SaveInteger(MHT,info,0,stun)
  call TriggerRegisterTimerEvent(trig,10,false)
  call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(trig,Condition(function Chaos_Bolt_Damage))
  call UnitAddAbility(d,'A04U')
  call SetUnitAbilityLevel(d,'A04U',stun)
  call IssueTargetOrder(d,"thunderbolt",t)
  set trig = null
  set d = null
  set u = null
  set t = null
endfunction

function Chaos_Bolt_Wrap takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Chaos_Bolt_Start()
  endif
endfunction


function RAF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call SaveInteger(HY,GetHandleId(Source),'a430',0)
  call BonusDamageSystem(Source)
  set t=null
  set Source=null
  return false
endfunction

function RBF takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())==GetUnitTypeId(IK8)and GetOwningPlayer(GetFilterUnit())==GetOwningPlayer(IK8)and IsUnitIllusion(GetFilterUnit()) then
    call SetUnitX(GetFilterUnit(),II8)
    call SetUnitY(GetFilterUnit(),IJ8)
    call IssueTargetOrderById(GetFilterUnit(),851983,IM8)
  endif
  return false
endfunction

function CK_RealityRift takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)
  local real YR8=DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)
  local real d=GetRandomReal(YR8*.3,YR8*.8)
  local integer Level=GetUnitAbilityLevel(Source,'A0RW')
  local real AO8=SourceX+d*Cos(a*bj_DEGTORAD)
  local real AP8=SourceY+d*Sin(a*bj_DEGTORAD)
  local unit u=CreateUnit(GetOwningPlayer(Source),IH8,AO8,AP8,0)
  local unit u2
  local group g
  local trigger t
  local integer h
  call SetUnitX(Source,AO8)
  call SetUnitY(Source,AP8)
  call SetUnitFacing(Source,-a)
  call PlaySoundOnUnitBJ(OC,100,Target)
  if IsUnitEnemy(Target,GetOwningPlayer(Source))and GetUnitTypeId(Target)!='n00L' then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,1.2,false)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function RAF))
    call SaveUnitHandle(HY,h,2,(Source))
    set t=null
    call SaveInteger(HY,GetHandleId(Source),'a430',(40+20*Level))
    call BonusDamageSystem(Source)
    set AO8=SourceX+(d-25)*Cos(a*bj_DEGTORAD)
    set AP8=SourceY+(d-25)*Sin(a*bj_DEGTORAD)
    call AddTimedKeyToUnit(Target,4405,1)
    call SetUnitX(Target,AO8)
    call SetUnitY(Target,AP8)
    call SetUnitFacing(Target,a)
    call IssueTargetOrderById(Source,851983,Target)
    set g=GetAvailableGroup()
    set II8=AO8
    set IJ8=AP8
    set IK8=Source
    set IM8=Target
    call GroupEnumUnitsInRange(g,SourceX,SourceY,1400,Condition(function RBF))
    call KillGroup(g)
    set u2=CreateUnit(GetOwningPlayer(Source),IH8,AO8,AP8,0)
    call KillUnit(u2)
  endif
  call KillUnit(u)
  set Source=null
  set Target=null
  set u=null
  set u2=null
  set g=null
endfunction

function CK_Phantasm_Back takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A40D')
  if GetUnitAbilityLevel(u,'A40D')==0 then
    call CleanTimer(t)
  elseif LoadBoolean(HY,GetHandleId(t),0)==false then
    call SaveBoolean(HY,GetHandleId(t),0,true)
    call TimerStart(t,1,true,function CK_Phantasm_Back)
  endif
  set u=null
  set t=null
endfunction

function CK_Phantasm takes nothing returns nothing
  local timer t
  if GetRandomInt(0,1)==1 then
    set t=CreateTimer()
    call TimerStart(t,0.51,false,function CK_Phantasm_Back)
    call UnitAddAbility2(GetTriggerUnit(),'A40D')
    call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
    set t=null
  endif
endfunction

function R6F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit u=CreateUnit(GetOwningPlayer(Hero),IH8,GetUnitX(Hero),GetUnitY(Hero),0)
  call PlaySoundOnUnitBJ(OC,100,Hero)
  call KillUnit(u)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set u=null
  set t=null
  set Hero=null
  return false
endfunction

function CK_RealityRift_OnCast takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerAddCondition(t,Condition(function R6F))
  call TriggerRegisterTimerEvent(t,.3,false)
  call SaveUnitHandle(HY,h,(14),(GetTriggerUnit()))
  set t=null
endfunction

function Bone_SearingArrows_Learn takes nothing returns nothing
  local integer lvl=GetUnitAbilityLevel(GetTriggerUnit(),'A303')
  if lvl==1 then
    call UnitAddAbility2(GetTriggerUnit(),'AHfa')
  endif
  call SetUnitAbilityLevel(GetTriggerUnit(),'AHfa',lvl)
endfunction

function R2F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real S4F=GetWidgetLife(Source)
  call UnitRemoveAbility(Source,'A1R0')
  call UnitRemoveAbility(Source,'B0D5')
  call SaveInteger(HY,GetHandleId(Source),'a272',0)
  call BonusDamageSystem(Source)
  call ManageBonusHP(Source,-1 * LoadInteger(HY,GetHandleId(Source),'h272'))
  call SaveInteger(HY,GetHandleId(Source),'h272',0)
  call SetWidgetLife(Source,S4F)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function S7F takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A04Q')
  local real S8F=GetWidgetLife(Target)
  local real S4F=GetWidgetLife(Source)
  local integer S9F=R2I((.035+.015*Level)*S8F)
  local integer SDF=R2I((.35+.15*Level)*S8F)
  call SaveInteger(HY,GetHandleId(Source),'a272',S9F)
  call BonusDamageSystem(Source)
  call SaveInteger(HY,GetHandleId(Source),'h272',SDF)
  call ManageBonusHP(Source,SDF)
  call UnitAddAbility2(Source,'A1R0')
  call SetWidgetLife(Target,1)
  call DamageTarget(Source,Target,2,20)
  call DamageTarget(Source,Target,1,20)
  call DamageTarget(Source,Target,3,20)
  call SetWidgetLife(Source,S4F+SDF)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",Target,"chest"))
  call SaveUnitHandle(HY,h,2,(Source))
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,35,false)
  call TriggerAddCondition(t,Condition(function R2F))
  set Source=null
  set Target=null
  set t=null
endfunction

function BoneFletcher_DeathPact takes nothing returns nothing
  if GetWidgetLife(GetTriggerUnit())>.5 and IsCourier(GetSpellTargetUnit())==false then
    call S7F()
  endif
endfunction

function SFF takes integer x returns boolean
  return x=='A06X' or x=='A0AQ' or x=='A14O' or x=='A0NE' or x=='A14O' or x=='A1C0' or x=='A0SB' or x=='A418'
endfunction

function SHF takes nothing returns boolean
  return GetUnitAbilityLevel(GetTriggerUnit(),'B06X')>0 and(IsItemAbilityById(GetSpellAbilityId())==false)and SFF(GetSpellAbilityId())==false and isDummyAbility(GetSpellAbilityId())==false and isItemSpellOrNoCd(GetSpellAbilityId())==false and isAintItemAbility(GetSpellAbilityId())
endfunction

function OD_EssenceAura_Delayed takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer lvl=LoadInteger(HY,h,0)
  local unit u=LoadUnitHandle(HY,h,0)
  call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+(.05+.05*lvl)*GetUnitState(u,UNIT_STATE_MAX_MANA))
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
  set u=null
endfunction

function SIF takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit u=GetTriggerUnit()
  local unit SJF=(LoadUnitHandle(HY,h,(254)))
  local integer lvl=GetUnitAbilityLevel(SJF,'P347')
  local timer t
  if DistanceBetweenUnits(u,SJF) < 1400 and PRD_Get(u,'P347',40) then
    set t=CreateTimer()
    call TimerStart(t,0,false,function OD_EssenceAura_Delayed)
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
    call SaveInteger(HY,GetHandleId(t),0,lvl)
    set t=null
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",u,"overhead"))
  endif
  set u=null
  set SJF=null
endfunction

function Destroyer_EssenceAura_Leveling takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A0IF')+GetUnitAbilityLevel(u,'QP1A')
  local trigger t
  if(lvl==1)then
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(t,Condition(function SHF))
    call TriggerAddAction(t,function SIF)
    call SaveUnitHandle(HY,GetHandleId(t),254,u)
  endif
  if(lvl==1)then
    call UnitAddAbility2(u,'A0OL')
  elseif(lvl==2)then
    call UnitAddAbility2(u,'A0OM')
  elseif(lvl==3)then
    call UnitAddAbility2(u,'A0ON')
  elseif(lvl==4)then
    call UnitAddAbility2(u,'A0OH')
  endif
  set u=null
  set t=null
endfunction

function OD_Orb_Hit takes unit attacker, unit target, boolean isOrb returns nothing
  local real d=.01*(5+GetUnitAbilityLevel(attacker,'A0OI'))*(GetUnitState(attacker,UNIT_STATE_MANA)+100)
  call UnitRemoveAbility(target,'B06Y')
  if(IsUnitType(target,UNIT_TYPE_SUMMONED) or IsUnitIllusion(target))and IsSpiritBear(target)==false and GetUnitTypeId(target)!='n00U' and GetUnitTypeId(target)!='n00Y' and GetUnitTypeId(target)!='n00Z' then
    set d=d+100*GetUnitAbilityLevel(attacker,'A0OI')
  endif
  call TextTagOnUnit("+"+I2S(R2I(d)),1,target,.023,191,64,255,216)
  call DamageTarget(attacker,target,3,d)
  if isOrb==false and PRD_Get(attacker,'P347',GetUnitAbilityLevel(attacker,'P347')*10)then
    call SetUnitState(attacker,UNIT_STATE_MANA,GetUnitState(attacker,UNIT_STATE_MANA)+.25*GetUnitState(attacker,UNIT_STATE_MAX_MANA))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCasterOverhead.mdl",attacker,"overhead"))
  endif
endfunction

function SRF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer SSF=(LoadInteger(HY,h,(262)))
  call SetHeroInt(Target,GetHeroInt(Target,false)+SSF,true)
  call SetHeroInt(Source,GetHeroInt(Source,false)-SSF,true)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function STF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  call SaveInteger(HY,(GetHandleId((Target))),((4303)),2)
  call DestroyEffect((LoadEffectHandle(HY,h,(32))))
  call SetUnitInvulnerable(Target,false)
  call PauseUnit(Target,false)
  call ShowUnit(Target,true)
  call ClearSelectionForPlayer(GetOwningPlayer(Target))
  call SelectUnitAddForPlayer(Target,GetOwningPlayer(Target))
  call RemoveSavedHandle(HY,(GetHandleId(Source)),(748))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function OD_AstralImprisonment takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0OJ')
  local integer SSF=IMinIF(GetHeroInt(Target,false),1+Level*3) + 2
  local trigger t
  local integer h
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'o019',GetUnitX(Target),GetUnitY(Target),0)
  call UnitApplyTimedLife(Caster,'BTLF',Level+1)
  if(IsUnitEnemy(Target,GetOwningPlayer(Source)))==false or IsBlocked(GetSpellTargetUnit())==false then
    call SaveInteger(HY,(GetHandleId((Target))),((4303)),(1))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SelectUnitRemoveForPlayer(Target,GetOwningPlayer(Target))
    call SetUnitInvulnerable(Target,true)
    call PauseUnit(Target,true)
    call ShowUnit(Target,false)
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffect("Abilities\\Spells\\Demon\\DarkConversion\\ZombifyTarget.mdl",GetUnitX(Target),GetUnitY(Target))))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call TriggerRegisterTimerEvent(t,Level,false)
    call TriggerAddCondition(t,Condition(function STF))
    if(IsUnitEnemy(Target,GetOwningPlayer(Source))) then
      call SaveUnitHandle(HY,(GetHandleId(Source)),(748),(Target))
      call SetHeroInt(Target,GetHeroInt(Target,false)-SSF,true)
      call SetHeroInt(Source,GetHeroInt(Source,false)+SSF,true)
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call SaveUnitHandle(HY,h,2,(Source))
      call SaveUnitHandle(HY,h,17,(Target))
      call SaveInteger(HY,h,(262),(SSF))
      call TriggerRegisterTimerEvent(t,50,false)
      call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
      call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
      call TriggerAddCondition(t,Condition(function SRF))
    endif
  endif
  set Source=null
  set Target=null
  set Caster=null
  set t=null
endfunction

function OD_AstralImprisonment_OnCast takes nothing returns nothing
  if IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))and(LoadBoolean(HY,(GetHandleId(GetOwningPlayer(GetSpellTargetUnit()))),(139)))and GetSpellTargetUnit()!=GetTriggerUnit()then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
  endif
endfunction

function SZF takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local unit caster=GetTriggerUnit()
  local integer diff
  local integer min
  local integer array SBF
  local integer Level=GetUnitAbilityLevel(caster,'A0OK')
  local integer mult=7+1*Level
  local integer i
  local boolean isagh=GetUnitAbilityLevel(caster,'A1VW')>0
  if GetHeroInt(caster,true)==0 then
    set caster=udg_Hero[GetPlayerId(GetOwningPlayer(caster))]
  endif
  set i=GetUnitPrimaryAttribute(caster)
  if i==1 then
    set diff=GetHeroInt(caster,true)-GetHeroInt(Target,true)
  elseif i==2 then
    set diff=GetHeroAgi(caster,true)-GetHeroAgi(Target,true)
  else
    set diff=GetHeroStr(caster,true)-GetHeroStr(Target,true)
  endif
  if isagh then
    set Level=GetUnitAbilityLevel(caster,'A1VW')
    set mult=7+1*Level+1
  endif
  set min=-10+20*Level
  set SBF[1]=10
  set SBF[2]=30
  set SBF[3]=50
  if(diff>0)then
    call DamageTarget(caster,Target,1,diff*mult)
    call TextTagOnUnit(I2S(R2I(diff*mult)),3,Target,.023,216,30,30,216)
    if(diff < min or isagh)then
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",Target,"overhead"))
      call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)*.25)
    endif
  endif
  set Target=null
  set caster=null
endfunction

function S3F takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function OD_SanityEclipse takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A0OK')
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local group g=GetAvailableGroup()
  local integer offset=0
  local unit SLF=(LoadUnitHandle(HY,(GetHandleId(u)),(748)))
  if lvl==0 then
    set lvl=GetUnitAbilityLevel(u,'A1VW')
  endif
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",x,y))
  loop
    exitwhen offset>=360
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",x+(200+lvl*50)*Cos(offset*bj_DEGTORAD),y+(200+lvl*50)*Sin(offset*bj_DEGTORAD)))
    set offset=offset+45
  endloop
  call GroupEnumUnitsInRange(g,x,y,300+lvl*100,Condition(function S3F))
  if SLF!=null and DistanceBetweenXY(x,y,GetUnitX(SLF),GetUnitY(SLF))<(300+lvl*100)then
    call SetUnitInvulnerable(SLF,false)
    call GroupAddUnit(g,SLF)
  endif
  call ForGroup(g,function SZF)
  if SLF!=null and IsDead(SLF)==false then
    call SetUnitInvulnerable(SLF,true)
  endif
  call KillGroup(g)
  set g=null
  set SLF=null
  set u=null
endfunction

function S1F takes nothing returns nothing
  call DamageTarget(IN8,GetEnumUnit(),1,IO8)
endfunction

function S0F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Source=LoadUnitHandle(HY,h,2)
  local group g
  local integer Count=LoadInteger(HY,h,34)
  if Count>200 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call Buff_Remove(Target,LoDBuff_BuffID[1])
    call DestroyEffect((LoadEffectHandle(HY,h,(31))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A0QG' and GetSpellTargetUnit()==Target then
    call DestroyEffect((LoadEffectHandle(HY,h,(31))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if Count==1 then
      call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    endif
    set Count=Count+1
    call SaveInteger(HY,h,34,Count)
    set g=GetAvailableGroup()
    set tt_unit1=Source
    set IN8=Source
    set IO8=1.+2.*LoadInteger(HY,h,0)
    call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),275,Condition(function DefaultEnemyFilter))
    call GroupRemoveUnit(g,Target)
    call ForGroup(g,function S1F)
    call KillGroup(g)
    set Target=null
  endif
  set t=null
  set Source=null
  set g=null
  return false
endfunction

function DS_IonShell takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit target = GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call Buff_Add(target,LoDBuff_AbilID[1],LoDBuff_BuffID[1],0)
  call PlaySoundAtPos(LC,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
  call SaveUnitHandle(HY,h,2,u)
  call SaveUnitHandle(HY,h,17,target)
  call SaveEffectHandle(HY,h,31,AddSpecialEffectTarget("war3mapImported\\NewSoulArmor.mdx",GetSpellTargetUnit(),"chest"))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterDeathEvent(t,target)
  call TriggerAddCondition(t,Condition(function S0F))
  set u=null
  set t=null
  set target=null
endfunction

function T4F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local integer Level
  local unit Source
  local unit Target
  local real x1
  local real y1
  local real d
  local real a
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set Target=(LoadUnitHandle(HY,h,17))
    set d=(LoadReal(HY,h,(138)))
    set x=(LoadReal(HY,h,6))
    set y=(LoadReal(HY,h,7))
    set a=(LoadReal(HY,h,(137)))
    set x1=GetUnitX(Target)+d/ 15*Cos(a)
    set y1=GetUnitY(Target)+d/ 15*Sin(a)
    if IsUnitType(Target,UNIT_TYPE_HERO) then
      call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
      call SetUnitPosition(Target,x1,y1)
    else
      call SetUnitX(Target,x1)
      call SetUnitY(Target,y1)
    endif
    if GetTriggerEvalCount(t)>15 then
      set Source=(LoadUnitHandle(HY,h,2))
      set Level=(LoadInteger(HY,h,5))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call DamageTarget(Source,Target,1,Level*40)
      set Source=null
    endif
    set Target=null
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function T7F takes nothing returns nothing
  local trigger t=null
  local unit Source=null
  local unit Target=GetEnumUnit()
  local integer h
  if IsUnitInvulnerable(Target) then
    set Target = null
    return
  endif
  set t = CreateTrigger()
  set Source = GetTriggerUnit()
  set h = GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function T4F))
  call SaveReal(HY,h,6,((IP8)*1.))
  call SaveReal(HY,h,7,((IQ8)*1.))
  call SaveReal(HY,h,(138),((DistanceBetweenXY(IP8,IQ8,GetUnitX(Target),GetUnitY(Target)))*1.))
  call SaveReal(HY,h,(137),((Atan2(IQ8-GetUnitY(Target),IP8-GetUnitX(Target)))*1.))
  call SaveInteger(HY,h,5,(IR8))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  set t=null
  set Source=null
  set Target=null
endfunction

function DS_Vacuum takes nothing returns nothing
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A0QE')
  local real r=175+100*Level
  set tt_unit1=GetTriggerUnit()
  call PlaySoundAtPos(CE,x,y)
  call DestroyEffect(AddSpecialEffect("war3mapImported\\Star Aura.mdx",x,y))
  call GroupEnumUnitsInRange(g,x,y,r,Condition(function NonImmuneEnemyFilter))
  set IP8=x
  set IQ8=y
  set IR8=Level
  call ForGroup(g,function T7F)
  call KillTrees(x,y,200)
  call KillGroup(g)
  set g=null
endfunction

function DS_Vacuum_OnCast takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  if IsTerrainPathableFixed(x,y)==false or(IsPointInRegion(RestrictedRegion,((x)*1.),((y)*1.)))then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03K'))
  endif
endfunction

function TFF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  call UnitRemoveAbility(Target,'B07W')
  call UnitRemoveAbility(Target,'Bblo')
  call UnitRemoveAbility(Target,'B062')
  call UnitRemoveAbility(Target,'B065')
  call UnitRemoveAbility(Target,'Bcrs')
  call UnitRemoveAbility(Target,'B016')
  call UnitRemoveAbility(Target,'B05R')
  set t=null
  set Target=null
  return false
endfunction

function DS_Surge takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,GetUnitAbilityLevel(GetTriggerUnit(),'A0R7')*1.5+1.5,false)
  call TriggerAddCondition(t,Condition(function TFF))
  call SaveUnitHandle(HY,(GetHandleId(t)),17,(GetSpellTargetUnit()))
  call PlaySoundAtPos(TD,GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()))
  call DestroyEffect(AddSpecialEffectTarget("effects\\Surge.mdx",GetSpellTargetUnit(),"origin"))
  set t=null
endfunction

function TIF takes boolean RIE returns boolean
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit TJF=LoadUnitHandle(HY,h,259)
  local unit Target=GetTriggerUnit()
  local unit TKF=CreateUnit(GetOwningPlayer(TJF),'e01S',GetUnitX(Target),GetUnitY(Target),0)
  local unit Hero=udg_Hero[GetPlayerId(GetOwningPlayer(TJF))]
  local integer Level=LoadInteger(HY,h,0)
  call SetUnitAbilityLevel(TJF,'A0QL',Level)
  set IS8=GetUnitX(Target)
  set IT8=GetUnitY(Target)
  set IU8=Target
  call SaveUnitHandle(HY,GetHandleId(TJF),'0ILU',Target) //Wall of Replica source info
  if RIE then
    call SetUnitAbilityLevel(TJF,'A0QL',3+Level)
    call IssueTargetOrderById(TJF,852274,Target)
    call DamageTarget(TJF,Target,1,150)
  else
    call IssueTargetOrderById(TJF,852274,Target)
    call DamageTarget(TJF,Target,1,150)
  endif
  call UnitApplyTimedLife(TKF,'BTLF',.5)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
  set TJF=null
  set Target=null
  set TKF=null
  set Hero=null
  return false
endfunction

function TMF takes nothing returns boolean
  local group g
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(259)))))and(GetUnitTypeId((GetFilterUnit()))=='H00J')==false then
    set g=LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),257)
    if IsUnitInGroup(GetFilterUnit(),g)==false then
      call GroupAddUnit(g,GetFilterUnit())
      call TIF(false)
    endif
  endif
  set g=null
  return false
endfunction

function TNF takes nothing returns boolean
  local group g
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer((LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(259)))))and(GetUnitTypeId((GetFilterUnit()))=='H00J')==false then
    set g=LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),257)
    if IsUnitInGroup(GetFilterUnit(),g)==false then
      call GroupAddUnit(g,GetFilterUnit())
      call TIF(true)
    endif
  endif
  set g=null
  return false
endfunction

function TOF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call GroupRemoveUnit(LoadGroupHandle(HY,h,257),LoadUnitHandle(HY,h,261))
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
  call FlushChildHashtable(HY,h)
  call DisableTrigger(t)
  set t=null
  return false
endfunction

function TPF takes nothing returns boolean
  local unit TJF=GetSummoningUnit()
  local unit W39=GetSummonedUnit()
  local integer h=GetHandleId(TJF)
  local integer TQF=(LoadInteger(HY,h,260))
  local trigger t=CreateTrigger()
  call SetUnitVertexColor(W39,255,255,255,100)
  call TriggerRegisterUnitEvent(t,W39,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function TOF))
  call SaveGroupHandle(HY,GetHandleId(t),257,LoadGroupHandle(HY,h,257))
  call SaveUnitHandle(HY,GetHandleId(t),261,IU8)
  set TQF=TQF+1
  call SaveInteger(HY,h,260,TQF)
  call SaveUnitHandle(HY,h,2800+TQF,(W39))
  call SaveTriggerHandle(HY,h,2900+TQF,t)
  call SetUnitX(W39,IS8)
  call SetUnitY(W39,IT8)
  set TJF=null
  set W39=null
  set t=null
  return false
endfunction

function TRF takes nothing returns nothing
  call RemoveUnit(GetEnumUnit())
endfunction

function TSF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local trigger t2=LoadTriggerHandle(HY,h,255)
  local integer h2=GetHandleId(t2)
  local trigger t3=LoadTriggerHandle(HY,h2,256)
  local group g1=LoadGroupHandle(HY,h2,257)
  local group g2=LoadGroupHandle(HY,h2,258)
  local unit u2=LoadUnitHandle(HY,h2,259)
  local integer uh=GetHandleId(u2)
  local integer TQF=LoadInteger(HY,uh,260)
  local integer i
  local unit u
  call ForGroup(g2,function TRF)
  set i=1
  loop
    exitwhen i>TQF
    set u=LoadUnitHandle(HY,uh,2800+i)
    call FlushChildHashtable(HY,GetHandleId(LoadTriggerHandle(HY,uh,2900+i)))
    call CleanTrigger(LoadTriggerHandle(HY,uh,2900+i))
    if IsUnitIllusion(u)then
      call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImageCaster.mdl",GetUnitX(u),GetUnitY(u)))
      call RemoveUnit(u)
    endif
    set i=i+1
  endloop
  call FlushChildHashtable(HY,h)
  call FlushChildHashtable(HY,h2)
  call FlushChildHashtable(HY,uh)
  call RemoveUnit(u2)
  call KillGroup(g1)
  call KillGroup(g2)
  call CleanTrigger(t2)
  call CleanTrigger(t3)
  call CleanTrigger(t)
  set t=null
  set t2=null
  set t3=null
  set g1=null
  set g2=null
  set u2=null
  set u=null
  return false
endfunction

function DS_WallOfReplica takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real TAF=GetUnitFacing(Hero)-45
  local unit TJF=CreateUnit(GetOwningPlayer(Hero),'h00O',x,y,TAF)
  local unit u
  local real M6E
  local real MLE
  local integer i
  local real offset
  local trigger t=CreateTrigger()
  local group g1=GetAvailableGroup()
  local integer h=GetHandleId(t)
  local group g2=GetAvailableGroup()
  local trigger TTF=t
  local integer Level=GetUnitAbilityLevel(Hero,'A0QK')
  local boolean RIE=false
  if Level==0 then
    set RIE=true
    set Level=GetUnitAbilityLevel(Hero,'A21Q')
  endif
  call SetUnitAbilityLevel(TJF,'A0QL',Level)
  call PlaySoundAtPos(DE,x,y)
  call SaveGroupHandle(HY,h,257,g1)
  call SaveGroupHandle(HY,GetHandleId(TJF),257,g1)
  call SaveGroupHandle(HY,h,258,g2)
  call SaveUnitHandle(HY,h,259,TJF)
  call SaveInteger(HY,GetHandleId(TJF),260,0)
  set i=0
  loop
    exitwhen i>39
    set M6E=x+(500-25*i)*Cos((TAF-45)*bj_DEGTORAD)
    set MLE=y+(500-25*i)*Sin((TAF-45)*bj_DEGTORAD)
    set u=CreateUnit(GetOwningPlayer(Hero),'h00P',M6E,MLE,TAF)
    call GroupAddUnit(g2,u)
    call TriggerRegisterUnitInRange(t,u,17,Condition(function ReturnTrue))
    set i=i+1
  endloop
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  if RIE then
    call TriggerAddCondition(t,Condition(function TNF))
  else
    call TriggerAddCondition(t,Condition(function TMF))
  endif
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,TJF,EVENT_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function TPF))
  call SaveTriggerHandle(HY,h,256,t)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,15*Level,false)
  call TriggerAddCondition(t,Condition(function TSF))
  call SaveTriggerHandle(HY,GetHandleId(t),255,TTF)
  set Hero=null
  set u=null
  set t=null
  set TTF=null
  set g1=null
  set g2=null
  set TJF=null
endfunction

function Brewmaster_Brawler_Attacked_Clean takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A34G')
  call CleanTimer(t)
  set t=null
  set u=null
endfunction

function Brewmaster_Brawler_Attacked_remove takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.3,false,function Brewmaster_Brawler_Attacked_Clean)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function Brewmaster_Brawler_Attacking_Clean takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A34H')
  call CleanTimer(t)
  set t=null
  set u=null
endfunction

function Brewmaster_Brawler_Attacking_remove takes unit u returns nothing
  local timer t=CreateTimer()
  if IsRangedUnitHasOverAS(u) then
    call TimerStart(t,0.2,false,function Brewmaster_Brawler_Attacking_Clean)
  else
    call TimerStart(t,0.3,false,function Brewmaster_Brawler_Attacking_Clean)
  endif
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  
  set t=null
endfunction

function Brewmaster_Brawler_Attacked takes nothing returns nothing
  call SaveReal(MHT,GetHandleId(GetTriggerUnit()),'LSTE',TimerGetElapsed(GlobalTimer))
  call Brewmaster_Brawler_Attacked_remove(GetTriggerUnit())
endfunction

function Brewmaster_Brawler_Attacking takes nothing returns nothing
  if GetAttacker()==LoadUnitHandle(HY,GetHandleId(GetTriggeringTrigger()),0) and IsUnitEnemy(GetAttacker(),GetOwningPlayer(GetTriggerUnit())) then
    call SaveReal(MHT,GetHandleId(GetAttacker()),'LSTC',TimerGetElapsed(GlobalTimer))
    call Brewmaster_Brawler_Attacking_remove(GetAttacker())
  endif
endfunction

function Brewmaster_Brawler_Check takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  local integer hu=GetHandleId(u)
  local real curtime=TimerGetElapsed(GlobalTimer)
  if curtime-LoadReal(MHT,hu,'LSTC')>=10 and GetUnitAbilityLevel(u,'A34H')==0 then
    call UnitAddAbility2(u,'A34H')//crit
  endif
  if curtime-LoadReal(MHT,hu,'LSTE')>=10 and GetUnitAbilityLevel(u,'A34G')==0 then
    call UnitAddAbility2(u,'A34G')//evasion
  endif
  set t=null
  set u=null
endfunction

function Brewmaster_Brawler takes nothing returns nothing
  local trigger t=CreateTrigger()
  local unit u=GetTriggerUnit()
  local timer tt=CreateTimer()
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function Brewmaster_Brawler_Attacked))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function Brewmaster_Brawler_Attacking))
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call TimerStart(tt,1,true,function Brewmaster_Brawler_Check)
  call SaveUnitHandle(HY,GetHandleId(tt),0,u)
  call SaveReal(MHT,GetHandleId(u),'LSTC',TimerGetElapsed(GlobalTimer))
  call SaveReal(MHT,GetHandleId(u),'LSTE',TimerGetElapsed(GlobalTimer))
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34G',false)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A34H',false)
  set tt=null
  set u=null
  set t=null
endfunction

function TCF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer str=LoadInteger(HY,h,29)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if(LoadBoolean(HY,h,276))==false and GetTriggerUnit()==(Source)then
      call SaveBoolean(HY,h,276,true)
      call SetHeroStr(Source ,GetHeroStr(Source ,false)-str,true)
      call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)-str)
    elseif(LoadBoolean(HY,h,277))==false and GetTriggerUnit()==Target then
      call SaveBoolean(HY,h,277,true)
      call SetHeroStr(Target ,GetHeroStr(Target ,false)+str,true)
    endif
  else
    if(LoadBoolean(HY,h,276))==false then
      call SaveBoolean(HY,h,276,true)
      call SetHeroStr(Source ,GetHeroStr(Source ,false)-str,true)
      call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)-str)
    endif
    if(LoadBoolean(HY,h,277))==false then
      call SaveBoolean(HY,h,277,true)
      call SetHeroStr(Target ,GetHeroStr(Target ,false)+str,true)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function T6F takes nothing returns nothing
  local unit Source=IV8
  local unit Target=GetEnumUnit()
  local integer T3F
  local integer Level=IW8
  local trigger t
  local integer h
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    set T3F=IMinBJ(GetHeroStr(Target,false)-1,4)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SetHeroStr(Source,GetHeroStr(Source,false)+T3F,true)
    call SaveInteger(HeroStats,GetHandleId(Source),30,LoadInteger(HeroStats,GetHandleId(Source),30)+T3F)
    call SetHeroStr(Target,GetHeroStr(Target,false)-T3F,true)
    call TriggerRegisterTimerEvent(t,40,false)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function TCF))
    call SaveBoolean(HY,h,(276),(false))
    call SaveBoolean(HY,h,(277),(false))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,h,(29),(T3F))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",Source,"origin"))
  endif
  call DamageTarget(Source,Target,1,40*Level - 20)
  set Source=null
  set Target=null
  set t=null
endfunction

function Undying_Decay takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local group g=GetAvailableGroup()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A15S')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'h07J',x,y,0)
  call DestroyEffect(AddSpecialEffect("effects\\DecayGreen_Groundonly_1.mdx",x,y))
  if IsUnitType(Source,UNIT_TYPE_HERO)==false then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  set tt_unit1=Source
  set IV8=Source
  
  set IW8=Level
  call GroupEnumUnitsInRange(g,x,y,350,Condition(function NonImmuneEnemyFilter))
  call ForGroup(g,function T6F)
  call KillGroup(g)
  call KillUnit(Caster)
  set Source=null
  set g=null
  set t=null
  set Caster=null
endfunction

function T0F takes nothing returns nothing
  if IA8<=8+IB8*2 then
    set IA8=IA8+1
    call GroupAddUnit(IX8,GetEnumUnit())
  endif
endfunction

function T5F takes unit Source,unit Target returns nothing
  call ZO8("SPLK",GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target),.1,.6,.44,.9,.6)
endfunction

function T2F takes nothing returns nothing
  call SetWidgetLife(IZ8,GetWidgetLife(IZ8)+14+4*IB8)
  if GetUnitTypeId(GetEnumUnit())!='n0F5' then
    call B18(GetEnumUnit(),14+4*IB8)
  endif
  call T5F(GetEnumUnit(),IZ8)
endfunction

function U4F takes nothing returns nothing
  call DamageTarget(IY8,IZ8,1,14+4*IB8)
  if GetUnitTypeId(GetEnumUnit())!='n0F5' then
    call B18(GetEnumUnit(),14+4*IB8)
  endif
  call T5F(GetEnumUnit(),IZ8)
endfunction

function U7F takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local integer U8F=GetUnitAbilityLevel(Hero,'A0R5')
  set IX8=GetAvailableGroup()
  set IA8=0
  set IB8=U8F
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),1300+25,Condition(function DK9))
  call GroupRemoveUnit(g,Hero)
  call GroupRemoveUnit(g,GetSpellTargetUnit())
  call ForGroup(g,function T0F)
  call KillGroup(g)
  set g=IX8
  set IZ8=GetSpellTargetUnit()
  set IY8=Hero
  if IsUnitAlly(IZ8,GetOwningPlayer(Hero))then
    call ForGroup(g,function T2F)
  else
    call ForGroup(g,function U4F)
  endif
  call KillGroup(g)
  set Hero=null
  set g=null
endfunction

function Undying_SoulRip takes nothing returns nothing
  if (IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_STRUCTURE)==false or GetOwningPlayer(GetSpellTargetUnit())==GetOwningPlayer(GetTriggerUnit()))then
    call U7F()
  endif
endfunction

function UDF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,(30))
  local unit UEF=(LoadUnitHandle(HY,h,(269)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerUnit()==Target then
      call KillUnit(UEF)
    endif
  elseif GameEnded then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call PauseUnit(UEF,true)
  elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER or GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
    call DisableTrigger(t)
    call IssueTargetOrderById(UEF,851983,Target)
    call EnableTrigger(t)
  elseif (GetWidgetLife(Target)<(100*I38)or GetWidgetLife(Target)/GetUnitState(Target,UNIT_STATE_MAX_LIFE) < I38*0.05+0.15)and GetUnitAbilityLevel(UEF,'B0AN')==0 then
    call IssueTargetOrderById(I68[GetPlayerId(GetOwningPlayer(UEF))],852101,UEF)
  elseif IsUnitVisible(Target,GetOwningPlayer(UEF))==false then
    if(LoadBoolean(HY,h,(270))) then
      if(LoadBoolean(HY,h,(271))) then
        if(LoadBoolean(HY,h,(272))) then
          call FlushChildHashtable(HY,h)
          call CleanTrigger(t)
          call KillUnit(UEF)
        else
          call SaveBoolean(HY,h,(272),(true))
        endif
      else
        call SaveBoolean(HY,h,(271),(true))
      endif
    else
      call SaveBoolean(HY,h,(270),(true))
    endif
  else
    call SaveBoolean(HY,h,(270),(false))
    call SaveBoolean(HY,h,(271),(false))
    call SaveBoolean(HY,h,(272),(false))
  endif
  set t=null
  set Target=null
  set UEF=null
  return false
endfunction

function UFF takes nothing returns boolean
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Target=GetEnumUnit()
  local unit UEF=CreateUnit(IC8,'n0F5',GetUnitX(Target),GetUnitY(Target),0)
  call IssueTargetOrderById(UEF,851983,Target)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,UEF,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function UDF))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveUnitHandle(HY,h,(269),(UEF))
  call SaveInteger(HY,h,5,(I38))
  set t=null
  set Target=null
  set UEF=null
  return false
endfunction

function UGF takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='n0F5' and GetWidgetLife(GetFilterUnit())>1 then
    call KillUnit(GetFilterUnit())
  endif
  return false
endfunction

function UHF takes player p returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,p,Condition(function UGF))
  call KillGroup(g)
  set g=null
endfunction

function UIF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit UJF=(LoadUnitHandle(HY,h,(266)))
  local unit UKF=(LoadUnitHandle(HY,h,(267)))
  local unit UMF=(LoadUnitHandle(HY,h,(268)))
  local integer Level=(LoadInteger(HY,h,5))
  local group g
  local player AXD
  if IsSentinel(GetOwningPlayer(Source))then
    set AXD=Scourges[0]
  else
    set AXD=Sentinels[0]
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if(LoadBoolean(HY,h,(265)))then
      call TimedReveal(AXD,.4,GetUnitX(Source),GetUnitY(Source),600)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call ShowUnit(Source,false)
    call RemoveUnit(UJF)
    call RemoveUnit(UKF)
    call RemoveUnit(UMF)
    call UHF(GetOwningPlayer(Source))
  else
    if IsUnitVisible(Source,AXD)then
      call SaveBoolean(HY,h,(265),(true))
    endif
    set g=GetAvailableGroup()
    set tt_unit1=Source
    set IC8=GetOwningPlayer(Source)
    set I38=Level
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),25+400+200*Level,Condition(function LT8))
    if GameEnded==false then
      call ForGroup(g,function UFF)
    endif
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  set UJF=null
  set UKF=null
  set UMF=null
  set AXD=null
  return false
endfunction

function Undying_TombStone takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit obelisk
  local real dx
  local real dy
  local real UOF
  local unit aco1
  local unit aco2
  local unit aco3
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A15V')
  local integer id
  local real a
  local string s
  local integer i=1
  if Level==1 then
    set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FJ',x,y,0)
  elseif Level==2 then
    set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FI',x,y,0)
  elseif Level==3 then
    set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0F6',x,y,0)
  else
    set obelisk=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n0FH',x,y,0)
  endif
  call PlaySoundAtPos(MF,x,y)
  set id=GetPlayerId(GetOwningPlayer(obelisk))
  if I68[id]==null then
    set I68[id]=CreateUnit(GetOwningPlayer(obelisk),'e01V',x,y,0)
    call UnitAddAbility2(I68[id],'A176')
  endif
  call SetUnitPosition(obelisk,SafeX50(x),SafeY50(y))
  call UnitApplyTimedLife(obelisk,'BTLF',10+5*Level)
  call KillTrees(x,y,300)
  set dx=x+200*Cos(0*bj_DEGTORAD)
  set dy=y+200*Sin(0*bj_DEGTORAD)
  set UOF=AngleBetweenXY(dx,dy,x,y)
  set aco1=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)
  set s="Stand Work Gold"
  call SetUnitAnimation(aco1,s)
  loop
    call QueueUnitAnimation(aco1,s)
    set i=i+1
    exitwhen i>17
  endloop
  set dx=x+200*Cos(120*bj_DEGTORAD)
  set dy=y+200*Sin(120*bj_DEGTORAD)
  set UOF=AngleBetweenXY(dx,dy,x,y)
  set aco2=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)
  call SetUnitAnimation(aco2,s)
  set i=1
  loop
    call QueueUnitAnimation(aco2,s)
    set i=i+1
    exitwhen i>17
  endloop
  set dx=x+200*Cos(240*bj_DEGTORAD)
  set dy=y+200*Sin(240*bj_DEGTORAD)
  set UOF=AngleBetweenXY(dx,dy,x,y)
  set aco3=CreateUnit(GetOwningPlayer(obelisk),'h07H',dx,dy,UOF)
  call SetUnitAnimation(aco3,s)
  set i=1
  loop
    call QueueUnitAnimation(aco3,s)
    set i=i+1
    exitwhen i>17
  endloop
  set s="Stand Work"
  call SetUnitAnimation(obelisk,s)
  set i=1
  loop
    call QueueUnitAnimation(obelisk,s)
    set i=i+1
    exitwhen i>17
  endloop
  call TriggerRegisterUnitEvent(t,obelisk,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,3,true)
  call TriggerAddCondition(t,Condition(function UIF))
  call SaveUnitHandle(HY,h,2,(obelisk))
  call SaveUnitHandle(HY,h,(266),(aco1))
  call SaveUnitHandle(HY,h,(267),(aco2))
  call SaveUnitHandle(HY,h,(268),(aco3))
  call SaveInteger(HY,h,5,(Level))
  call SaveBoolean(HY,h,(265),(false))
  call TriggerEvaluate(t)
  set obelisk=null
  set aco1=null
  set aco2=null
  set aco3=null
  set t=null
endfunction

function UQF takes unit whichUnit returns boolean
  return LoadInteger(HeroStats,GetHandleId(whichUnit),'AGH1')=='QM03' or LoadInteger(HeroStats,GetHandleId(whichUnit),'AGH2')=='QM03'
endfunction

function USF takes nothing returns nothing
  if IsUnitType(tt_unit1,UNIT_TYPE_HERO) then
    if UQF(tt_unit2)then
      call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.1)
    else
      call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.06)
    endif
  else
    if UQF(tt_unit2)then
      call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.03)
    else
      call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+GetUnitState(tt_unit2,UNIT_STATE_MAX_LIFE)*.02)
    endif
  endif
endfunction


function Dirge_Golem_Fix_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  call SaveBoolean(MHT,LoadInteger(MHT,GetHandleId(t),0),'QM03',false)
  call Timer_End(t)
  set t = null
endfunction

function Dirge_Golem_Fix_Start takes unit u returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(u)
  call SaveBoolean(MHT,info,'QM03',true)
  call SaveInteger(MHT,GetHandleId(t),0,info)
  call TimerStart(t,.25,false,function Dirge_Golem_Fix_End)
  set t = null
endfunction

function FleshGolemRecountAmpl takes unit source, group g returns nothing
  local group gg=GetAvailableGroup()
  local unit u
  local real oldampl
  local real d
  local real a
  call GroupAddGroup(g,gg)
  loop
    set u=FirstOfGroup(gg)
    exitwhen u==null
    set oldampl=LoadReal(HY,GetHandleId(u),'ZMBI')
    set d=DistanceBetweenUnits(source,u)
    if d<775 then
      set a=20+5*GetUnitAbilityLevel(source,'QM03')
      if UQF(source)then
        set a=a+5
      endif
      if d>200 then
        set a=a-15*((d-150)/(775-150))
      endif
      set a=a/100
      if a!=oldampl then
        call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL') - oldampl + a)
        call SaveReal(HY,GetHandleId(u),'ZMBI',a)
        
      endif
    else
      call SaveReal(HY,GetHandleId(u),'AMPL',LoadReal(HY,GetHandleId(u),'AMPL') - oldampl)
      call RemoveSavedReal(HY,GetHandleId(u),'ZMBI')
      call GroupRemoveUnit(g,u)
    endif
    call GroupRemoveUnit(gg,u)
  endloop
  call KillGroup(gg)
endfunction

function UTF takes nothing returns boolean
  local trigger t2=GetTriggeringTrigger()
  local integer h2=GetHandleId(t2)
  local trigger t1=LoadTriggerHandle(HY,h2,274)
  local integer h=GetHandleId(t1)
  local unit Source=LoadUnitHandle(HY,h2,2)
  local unit Target
  local real d
  local real a
  local boolean b=LoadBoolean(HY,h2,273)
  local real timelim=LoadReal(HY,h2,30)
  if (GetTriggerEventId()==EVENT_UNIT_DEATH and GetTriggerUnit()==Source) or (GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED and TimerGetElapsed(GlobalTimer)>timelim) then
    call Dirge_Golem_Fix_Start(Source)
    call FleshGolemRecountAmpl(null,LoadGroupHandle(HY,h2,30))
    call FlushChildHashtable(HY,h)
    call KillGroup(LoadGroupHandle(HY,h2,30))
    call FlushChildHashtable(HY,h2)
    call CleanTrigger(t1)
    call CleanTrigger(t2)
  elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    call FleshGolemRecountAmpl(Source,LoadGroupHandle(HY,h2,30))
  elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
    if IsUnitIllusion(GetDyingUnit())==false then
      call AddProjectile(GetDyingUnit(),Source,'h07Y',"USF",600,false)
    endif
  endif
  set t2=null
  set t1=null
  set Source=null
  set Target=null
  return false
endfunction

function UVF takes nothing returns boolean
  local trigger t1=GetTriggeringTrigger()
  local integer R2E=GetHandleId(t1)
  local trigger t2=(LoadTriggerHandle(HY,(R2E),(275)))
  local integer Cache2=GetHandleId(t2)
  local unit Target=GetTriggerUnit()
  local unit Source=(LoadUnitHandle(HY,(R2E),2))
  if IsUnitEnemy(Source,GetOwningPlayer(Target)) and IsUnitType(Target,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(Target,'A04R')==0 then
    if(LoadBoolean(HY,(Cache2),(GetHandleId(Target))))==false then
      call GroupAddUnit(LoadGroupHandle(HY,Cache2,30),Target)
      //call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DAMAGED)
      call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DEATH)
      call TriggerRegisterTimerEvent(t2,0.1,true)
      call SaveBoolean(HY,(Cache2),(GetHandleId(Target)),(true))
    endif
  endif
  set t1=null
  set t2=null
  set Target=null
  set Source=null
  return false
endfunction

function UWF takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t1=CreateTrigger()
  local integer R2E=GetHandleId(t1)
  local trigger t2=CreateTrigger()
  local integer Cache2=GetHandleId(t2)
  local integer Level=GetUnitAbilityLevel(Source,'QM03')
  set I18=Level
  call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A17A',false)
  call TriggerRegisterUnitInRange(t1,Source,750,Condition(function ReturnTrue))
  call TriggerAddCondition(t1,Condition(function UVF))
  call SaveTriggerHandle(HY,(R2E),(275),(t2))
  call SaveUnitHandle(HY,(R2E),2,(Source))
  call TriggerRegisterTimerEvent(t2,30,false)
  call SaveReal(HY,Cache2,30,TimerGetElapsed(GlobalTimer)+30.)
  call TriggerRegisterUnitEvent(t2,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t2,Condition(function UTF))
  call SaveTriggerHandle(HY,(Cache2),(274),(t1))
  call SaveUnitHandle(HY,(Cache2),2,(Source))
  call SaveBoolean(HY,(Cache2),(273),(false))
  call SaveGroupHandle(HY,Cache2,30,GetAvailableGroup())
  set Source=null
  set t1=null
  set t2=null
endfunction

function Undying_FleshGolem takes nothing returns nothing
  if GetUnitTypeId(GetTriggerUnit())!='H07I' then
    call UWF()
    call GroupAddUnit(FleshGolems,GetTriggerUnit())
  else
    call GroupRemoveUnit(FleshGolems,GetTriggerUnit())
  endif
  
endfunction

function UYF takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),I58)==false and IsMagicImmune(GetEnumUnit())==false then
    call GroupAddUnit(I58,GetEnumUnit())
    call SetPlayerAbilityAvailable2(GetOwningPlayer(GetEnumUnit()),I28,false)
    call UnitAddAbilityTimedEx(GetEnumUnit(),I28,1,3,'B05Q')
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\SpellShieldAmulet\\SpellShieldCaster.mdl",GetEnumUnit(),"overhead"))
  endif
endfunction

function UZF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real x2=LoadReal(HY,h,66)
  local real y2=LoadReal(HY,h,67)
  local real a=LoadReal(HY,h,137)
  local integer Count=GetTriggerEvalCount(t)
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local real LastX=LoadReal(HY,h,23)
  local real LastY=LoadReal(HY,h,24)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local group g=GetAvailableGroup()
  local group AlreadyHit=LoadGroupHandle(HY,h,187)
  local integer Level=LoadInteger(HY,h,0)
  if DistanceBetweenXY(x,y,x2,y2)<=55 then
    set x=x2
    set y=y2
  else
    set x=LastX+65*Cos(a*bj_DEGTORAD)
    set y=LastY+65*Sin(a*bj_DEGTORAD)
  endif
  if Level==1 then
    set I28='A29A'
  elseif Level==2 then
    set I28='A299'
  elseif Level==3 then
    set I28='A29B'
  elseif Level==4 then
    set I28='A298'
  endif
  set tt_unit1=Hero
  set I58=AlreadyHit
  call GroupEnumUnitsInRange(g,x,y,325,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function UYF)
  call KillGroup(g)
  call SaveReal(HY,h,23,x*1.)
  call SaveReal(HY,h,24,y*1.)
  call SetUnitPosition(Hero,x,y)
  if(x==x2 and y==y2)or Count>40 then
    if IsUnitType(Caster,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Caster),99,true)
    endif
    call SetUnitX(Caster,SafeX50(x))
    call SetUnitY(Caster,SafeY50(y))
    call IssueImmediateOrderById(Caster,852096)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitAnimation(Hero,"stand")
    call SetUnitPathing(Hero,true)
    call SetUnitInvulnerable(Hero,false)
    call RestoreTint(Hero)
    call SaveInteger(HY,GetHandleId((Hero)),4261,2)
  endif
  set t=null
  set Hero=null
  set Caster=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function Void_Timewalk takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real x2
  local real y2
  local real a
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',x1,y1,0)
  if GetSpellTargetUnit()==null then
    set x2=GetSpellTargetX()
    set y2=GetSpellTargetY()
  else
    set x2=GetUnitX(GetSpellTargetUnit())
    set y2=GetUnitY(GetSpellTargetUnit())
  endif
  set a=AngleBetweenXY(x1,y1,x2,y2)
  call SetUnitAnimationByIndex(Hero,0)
  call SetUnitPathing(Hero,false)
  call SetUnitInvulnerable(Hero,true)
  call SetTint(Hero,0,0,0,-1)
  call SaveInteger(HY,GetHandleId(Hero),4261,1)
  call SaveReal(HY,h,66,x2*1.)
  call SaveReal(HY,h,67,y2*1.)
  call SaveReal(HY,h,23,x1*1.)
  call SaveReal(HY,h,24,y1*1.)
  call SaveReal(HY,h,137,a*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveGroupHandle(HY,h,187,GetAvailableGroup())
  call UnitAddAbility2(Caster,'A0LA')
  call SetUnitAbilityLevel(Caster,'A0LA',GetUnitAbilityLevel(Hero,'A0LK'))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function UZF))
  set Hero=null
  set t=null
  set Caster=null
endfunction

function Void_Backtrack_Act takes nothing returns nothing
  local unit void=GetTriggerUnit()
  local real Damage=GetEventDamage()
  if(Damage>0)and GetWidgetLife(void)>1 and IsRealDamage then
    if (Damage<=20) then
      if GetRandomInt(0,100)< 5+5*(GetUnitAbilityLevel(void,'A0CZ')+GetUnitAbilityLevel(void,'QP22')) then
        call SetWidgetLife(void,GetWidgetLife(void)+Damage)
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",void,"hand,left"))
      endif
    elseif PRD_Get(void,'A0CZ',5+5*(GetUnitAbilityLevel(void,'A0CZ')+GetUnitAbilityLevel(void,'QP22'))) then
      call SetWidgetLife(void,GetWidgetLife(void)+Damage)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",void,"hand,left"))
    endif
  endif
  set void=null
endfunction

function Void_Backtrack_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function Void_Backtrack_Act))
  set t=null
endfunction

function U1F takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit U0F=(LoadUnitHandle(HY,h,(19)))
  call PauseTimer(t)
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
  set U0F=null
endfunction

function U5F takes unit whichUnit returns boolean
  local integer ID=GetUnitTypeId(whichUnit)
  return ID=='osp4' or ID=='o008' or ID=='o009' or IsSiegeUnit(whichUnit)
endfunction

function U2F takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetOwningPlayer(GetFilterUnit())!=GetOwningPlayer(tt_unit1)
endfunction

function ChronoPersonal takes unit u returns nothing
  call SetUnitTimeScale(u,0)
  call SaveBoolean(HY,GetHandleId(u),4306,true)
  if IsUnitType(u,UNIT_TYPE_HERO) or IsUnitIllusion(u)then
    if IsUnitPaused(u)==false then
      if IssueTargetOrder(LoadUnitHandle(TempHash,'CHRN',0),"thunderbolt",u)==false then
        call UnitShareVision(u,GetOwningPlayer(LoadUnitHandle(TempHash,'CHRN',0)),true)
        if IssueTargetOrder(LoadUnitHandle(TempHash,'CHRN',0),"thunderbolt",u)==false then
          call PauseUnit(u,true)
        endif
        call UnitShareVision(u,GetOwningPlayer(LoadUnitHandle(TempHash,'CHRN',0)),false)
      endif
    endif
  else
    call PauseUnit(u,true)
  endif
endfunction

function V4F takes nothing returns nothing
  call ChronoPersonal(GetEnumUnit())
endfunction

function V7F takes nothing returns nothing
  local unit u = GetEnumUnit()
  call SaveBoolean(HY,GetHandleId(u),4306,false)
  call PauseUnit(u,false)
  call SetUnitTimeScale(u,1)
  set u = null
endfunction

function V8F takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit d=LoadUnitHandle(HY,h,19)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local integer lvl=LoadInteger(HY,h,5)
  local group g=LoadGroupHandle(HY,h,220)
  local integer c=LoadInteger(HY,h,28)
  local real TargetX=GetUnitX(d)
  local real TargetY=GetUnitY(d)
  local group gg
  local integer dur=LoadInteger(HY,h,6)
  call SaveUnitHandle(TempHash,'CHRN',0,d)
  if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    
    set c=c+1
    call SaveInteger(HY,h,28,c)
    if DistanceBetweenUnits(Hero,d)<435 then
      call CustomSpeed(Hero,999,1000)
    else
      call CustomSpeed(Hero,0,0)
    endif
    set gg=GetAvailableGroup()
    call ForGroup(g,function V7F)
    set tt_unit1=Hero
    call GroupEnumUnitsInRange(gg,TargetX,TargetY,475,Condition(function U2F))
    call GroupClear(g)
    call GroupAddGroup(gg,g)
    call ForGroup(gg,function V4F)
    call KillGroup(gg)
  else
    if IsUnitInGroup(GetTriggerUnit(),g)==false then
      call GroupAddUnit(g,GetTriggerUnit())
      call ChronoPersonal(GetTriggerUnit())
    endif
  endif
  call RemoveSavedHandle(TempHash,'CHRN',0)
  if c>dur then
    if GameEnded==false then
      call ForGroup(g,function V7F)
    endif
    call CustomSpeed(Hero,0,0)
    call KillUnit(d)
    call RemoveUnit(d)
    call KillGroup(g)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  endif
  set t=null
  set d=null
  set Hero=null
  set g=null
  set gg=null
endfunction

function Void_Chronosphere takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0J1')+GetUnitAbilityLevel(Hero,'A1D7')
  local real TargetX=GetSpellTargetX()
  local real TargetY=GetSpellTargetY()
  local unit d=CreateUnit(GetOwningPlayer(Hero),'u00L',TargetX,TargetY,0)
  local integer h
  local trigger tt
  set tt=CreateTrigger()
  set h=GetHandleId(tt)
  call SaveUnitHandle(HY,h,19,d)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveGroupHandle(HY,h,220,GetAvailableGroup())
  call SaveInteger(HY,h,28,0)
  call SaveInteger(HY,h,5,Level)
  if GetUnitAbilityLevel(Hero,'A1D7')>0 then
    call SaveInteger(HY,h,6,30+Level*10)
  else
    call SaveInteger(HY,h,6,35+Level*5)
  endif
  call SavePlayerHandle(HY,h,0,GetOwningPlayer(Hero))
  call TriggerRegisterTimerEvent(tt,.1,true)
  call TriggerRegisterTimerEvent(tt,0,false)
  call TriggerRegisterUnitInRange(tt,d,425,Condition(function U2F))
  call TriggerAddCondition(tt,Condition(function V8F))
  call UnitAddAbility(d,'A45D')
  set Hero=null
  set d=null
  set tt=null
endfunction

function Void_Bash_Effect takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  if GetUnitAbilityLevel(u,'B0C2')==0 then
    call RemoveSavedHandle(MHT,GetHandleId(u),'A081')
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",u,"chest"))
  set t = null
  set u = null
endfunction

function Void_Bash_Start takes unit u, integer info returns nothing
  local timer t = CreateTimer()
  call SaveTimerHandle(MHT,info,'A081',t)
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,0.1,true,function Void_Bash_Effect)
  set t = null
endfunction

function Void_Bash_Condition takes unit u, unit t returns nothing
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'P275')//A081
  if level>0 and GetUnitAbilityLevel(t,'B0C2')==1 and HaveSavedHandle(MHT,info,'A081')==false then
    call Void_Bash_Start(t,GetHandleId(t))
    if LoadBoolean(HY,info,4306)then
      call DamageTarget(u,t,1,level*10 + 30)
    endif
  endif
endfunction

function X7F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,(30))
  local real DRD=(LoadReal(HY,(GetHandleId(Target)),(3007)))
  if DRD+5<=(TimerGetElapsed(GlobalTimer))then
    call UnitRemoveAbility(Target,'A0VW')
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Target=null
  return false
endfunction

function X8F takes unit Target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Target,'A0VW')
  if Level==0 then
    call UnitAddAbility2(Target,'A0VW')
  endif
  call SetUnitAbilityLevel(Target,'A0VW',Level+1)
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveReal(HY,(GetHandleId(Target)),(3007),(((TimerGetElapsed(GlobalTimer)))*1.))
  call TriggerRegisterTimerEvent(t,5,false)
  call TriggerAddCondition(t,Condition(function X7F))
  set t=null
endfunction

function X9F takes nothing returns boolean
  local real d
  if GetUnitAbilityLevel(GetTriggerUnit(),'B091')>0 and GetUnitAbilityLevel(GetEventDamageSource(),'A0VV')>0 and(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))==GetEventDamageSource()then
    call UnitRemoveAbility(GetTriggerUnit(),'B091')
    call DisableTrigger(GetTriggeringTrigger())
    call X8F(GetTriggerUnit())
    call FlushChildHashtable(HY,(GetHandleId(GetTriggeringTrigger())))
    call CleanTrigger(GetTriggeringTrigger())
  endif
  return false
endfunction

function XDF takes nothing returns nothing
  local trigger t
  local unit Target
  local unit Source
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    set Target=GetSpellTargetUnit()
    set Source=GetTriggerUnit()
  else
    set Target=GetTriggerUnit()
    set Source=GetAttacker()
  endif
  if IsUnitIllusion(Source)==false then
    set t=CreateTrigger()
    call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function X9F))
  endif
  set t=null
  set Target=null
  set Source=null
endfunction

function XEF takes nothing returns boolean
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetUnitAbilityLevel(GetAttacker(),'A0VV')>0 and(LoadBoolean(HY,(GetHandleId(GetTriggeringTrigger())),(3008)))and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetAttacker()==(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))then
      call XDF()
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
    if(GetIssuedOrderId()==852255)then
      call SaveBoolean(HY,(GetHandleId(GetTriggeringTrigger())),(3008),(true))
    elseif(GetIssuedOrderId()==852256)then
      call SaveBoolean(HY,(GetHandleId(GetTriggeringTrigger())),(3008),(false))
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A0VV' then
    call XDF()
  endif
  return false
endfunction

function XFF takes unit Source returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function XEF))
  call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
  call SaveBoolean(HY,(GetHandleId(t)),(3008),(true))
  set t=null
endfunction

function YYF takes nothing returns boolean
  if b_isPickTime==false then
    if(isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),316)or isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),212))and IsUnitIllusion(GetTriggerUnit())==false then
      set tt_unit1=GetTriggerUnit()
    elseif isPlayerPickedAbility(GetOwningPlayer(GetTriggerUnit()),356) and IsUnitIllusion(GetTriggerUnit())==false and GetUnitTypeId(GetTriggerUnit())!='H00J' then
      set tt_unit1=GetTriggerUnit()
      call ExeFunc("Register_DividedWeStand")
    endif
  endif
  return false
endfunction

function Lod_DeafeningBlast_DisableAffected takes unit Source,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0VT')
  call SetUnitAbilityLevel(Caster,'A0VT',Level+1)
  call IssueTargetOrderById(Caster,852585,Target)
  set Caster=null
endfunction

function Lod_DeafeningBlast_MoveAffected takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real a=(LoadReal(HY,h,(13)))
  local real QQE=(LoadReal(HY,h,(193)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer RHE=Level*40/ 3
  local real x
  local real y
  local integer Count=GetTriggerEvalCount(t)
  if Count>RHE/ 3 then
    call SaveReal(HY,h,(193),((QQE*.98)*1.))
  endif
  if Count>RHE or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerEventId()!=EVENT_UNIT_DEATH then
      call Lod_DeafeningBlast_DisableAffected(Source,Target,Level)
    endif
  else
    set x=SafeX50(GetUnitX(Target)+QQE*Cos(a))
    set y=SafeY50(GetUnitY(Target)+QQE*Sin(a))
    call KillTrees(x,y,150)
    call SetUnitPosition(Target,x,y)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Lod_DeafeningBlast_Affect takes unit Source,unit Target,integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
  call DamageTarget(Source,Target,1,20+60*Level)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveReal(HY,h,(193),((6)*1.))
  call SaveInteger(HY,h,5,(Level))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Lod_DeafeningBlast_MoveAffected))
  set t=null
endfunction

function Lod_DeafeningBlast_HitCheck takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false and IsMagicImmune(GetEnumUnit())==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call Lod_DeafeningBlast_Affect(tt_unit1,GetEnumUnit(),tt_int1)
  endif
endfunction

function Lod_DeafeningBlast_Move takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local real a=(LoadReal(HY,h,(137)))
  local real x2=(LoadReal(HY,h,(66)))
  local real y2=(LoadReal(HY,h,(67)))
  local group g=(LoadGroupHandle(HY,h,(22)))
  local integer Level=(LoadInteger(HY,h,5))
  local real x=GetUnitX(Caster)
  local real y=GetUnitY(Caster)
  local group g2
  if DistanceBetweenXY(x,y,x2,y2)<100 then
    set x=x2
    set y=y2
  else
    set x=x+33*Cos(a)
    set y=y+33*Sin(a)
  endif
  call SetUnitX(Caster,SafeX50(x))
  call SetUnitY(Caster,SafeY50(y))
  set g2=GetAvailableGroup()
  set tt_unit1=Caster
  set DK=g
  set tt_int1=Level
  call GroupEnumUnitsInRange(g2,x,y,200,Condition(function DefaultEnemyFilter))
  call ForGroup(g2,function Lod_DeafeningBlast_HitCheck)
  call KillGroup(g2)
  if(x==x2 and y==y2)or GetTriggerEvalCount(t)>35 then
    set g2=GetAvailableGroup()
    set tt_unit1=Caster
    set DK=g
    set tt_int1=Level
    call GroupEnumUnitsInRange(g2,x,y,250,Condition(function DefaultEnemyFilter))
    call ForGroup(g2,function Lod_DeafeningBlast_HitCheck)
    call KillGroup(g2)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Caster)
    call KillGroup(g)
  endif
  set t=null
  set Caster=null
  set g=null
  set g2=null
  return false
endfunction

function Lod_DeafeningBlast_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local integer Level=GetUnitAbilityLevel(Source,'Z610')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'n01X',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function Lod_DeafeningBlast_Move))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveReal(HY,h,(66),((GetUnitX(Source)+1000*Cos(a))*1.))
  call SaveReal(HY,h,(67),((GetUnitY(Source)+1000*Sin(a))*1.))
  call SaveGroupHandle(HY,h,(22),(GetAvailableGroup()))
  call SaveInteger(HY,h,5,(Level))
  set t=null
  set Source=null
  set Caster=null
endfunction

function Lod_EMP_Hit takes nothing returns nothing
  local real VWF=RMaxIF(RMinIF(GetUnitState(GetEnumUnit(),UNIT_STATE_MANA),JF8),0)
  local real VXF=VWF*.5
  local real manasteal=0
  if IsMagicImmune(GetEnumUnit())==false and VWF>0 and IsUnitCycloned(GetEnumUnit())==false then
    if IsUnitIllusion(GetEnumUnit())==false then
      if GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)>VWF then
        set manasteal=manasteal+VWF
      else
        set manasteal=manasteal+GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)
      endif
    endif
    if GetWidgetLife(GetEnumUnit())>(VXF+.5) then
      call SetWidgetLife(GetEnumUnit(),GetWidgetLife(GetEnumUnit())-VXF)
    else
      call SetWidgetLife(GetEnumUnit(),1)
      call DamageTarget(JG8,GetEnumUnit(),1,VXF)
    endif
    call SetUnitState(GetEnumUnit(),UNIT_STATE_MANA,GetUnitState(GetEnumUnit(),UNIT_STATE_MANA)-VWF)
  endif
  set manasteal=manasteal/2
  call SetUnitState(tt_unit1,UNIT_STATE_MANA,GetUnitState(tt_unit1,UNIT_STATE_MANA)+manasteal)
endfunction

function Lod_EMP_Explode takes unit Source,integer Level, unit Hero returns nothing
  local group g=GetAvailableGroup()
  set JG8=Source
  set tt_unit1=Source
  set JF8=Level*125
  set tt_unit1=Hero
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),700,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function Lod_EMP_Hit)
  call KillGroup(g)
  set g=null
endfunction

function Lod_EMP_Delay takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local integer Level=(LoadInteger(HY,h,5))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit VCF
  local real V3F=2.6
  local real V6F=1+(3.9-1)*Count/(V3F/ .05)
  call SetUnitScale(Caster,V6F,V6F,V6F)
  if Count>(V3F/ .05)then
    call Lod_EMP_Explode(Caster,Level,Source)
    set VCF=CreateUnit(GetOwningPlayer(Caster),'e01O',GetUnitX(Caster),GetUnitY(Caster),0)
    call SetUnitTimeScale(VCF,.3)
    call RemoveUnit(Caster)
    call KillUnit(VCF)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Caster=null
  set VCF=null
  set Source=null
  return false
endfunction

function Lod_EMP_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local integer Level=GetUnitAbilityLevel(Source,'Z609')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e01M',x,y,a*bj_RADTODEG)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function Lod_EMP_Delay))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  set t=null
  set Source=null
  set Caster=null
endfunction

function Lod_Tornado_Affect takes unit Source,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local unit W4F=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local real W7F=.8+.3*Level
  call UnitAddAbility2(Caster,'A0XK')
  call SetUnitAbilityLevel(Caster,'A0XK',Level+1)
  call IssueTargetOrderById(Caster,852144,Target)
  call DamageTarget_Delayed(W4F,Target,1,60.+Level*60.,W7F)
  set Caster=null
  set W4F=null
endfunction

function Lod_Tornado_HitCheck takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call Lod_Tornado_Affect(tt_unit1,GetEnumUnit(),tt_int1)
  endif
endfunction

function Lod_Tornado_Move takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local real x2=(LoadReal(HY,h,(66)))
  local real y2=(LoadReal(HY,h,(67)))
  local real a=(LoadReal(HY,h,(137)))
  local integer Level=(LoadInteger(HY,h,5))
  local group g=(LoadGroupHandle(HY,h,(22)))
  local real x=GetUnitX(Caster)+25*Cos(a)
  local real y=GetUnitY(Caster)+25*Sin(a)
  local group WDF=GetAvailableGroup()
  local real YR8=DistanceBetweenXY(x,y,x2,y2)
  if YR8<=30 then
    set x=x2
    set y=y2
  endif
  call SetUnitX(Caster,SafeX50(x))
  call SetUnitY(Caster,SafeX50(y))
  set tt_unit1=Caster
  set DK=g
  set tt_int1=Level
  call GroupEnumUnitsInRange(WDF,x,y,200,Condition(function DefaultEnemyFilter))
  call ForGroup(WDF,function Lod_Tornado_HitCheck)
  call KillGroup(WDF)
  if YR8<=30 or GetTriggerEvalCount(t)>125 then
    call KillGroup(g)
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Caster=null
  set g=null
  set WDF=null
  return false
endfunction

function Lod_Tornado_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'Z608')
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local unit Caster
  if GetUnitTypeId(Source)=='e00E' then //Multicast
    if GetRandomInt(0,1)==1 then
      set a=a+GetRandomReal(0,bj_PI/4)
    else
      set a=a-GetRandomReal(0,bj_PI/4)
    endif
  endif
  set x=GetUnitX(Source)
  set y=GetUnitY(Source)
  set Caster=CreateUnit(GetOwningPlayer(Source),'n01U',x,y,a*bj_RADTODEG)
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function Lod_Tornado_Move))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveReal(HY,h,(66),(x+(750+500.*Level)*Cos(a)))
  call SaveReal(HY,h,(67),(y+(750+500.*Level)*Sin(a)))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveGroupHandle(HY,h,(22),(GetAvailableGroup()))
  set t=null
  set Source=null
  set Caster=null
endfunction

function Lod_Alacrity_ExpireRetry takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  call UnitRemoveAbility(Target,'A0VJ')
  call UnitRemoveAbility(Target,'A109')
  if GetUnitAbilityLevel(Target,'A0VJ')==0 and GetUnitAbilityLevel(Target,'A109')==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function Lod_Alacrity_Expire takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer c=GetTriggerEvalCount(t)
  if c>=90 or GetUnitAbilityLevel(Target,'A0VJ')==0 or GetUnitAbilityLevel(Target,'A109')==0 then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Target,'A0VJ')
    call UnitRemoveAbility(Target,'A109')
    if GetUnitAbilityLevel(Target,'A0VJ')>0 or GetUnitAbilityLevel(Target,'A109')>0 then
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call SaveUnitHandle(HY,h,17,(Target))
      call TriggerRegisterTimerEvent(t,1,true)
      call TriggerAddCondition(t,Condition(function Lod_Alacrity_ExpireRetry))
    endif
  endif
  set t=null
  set Target=null
  return false
endfunction

function Lod_Alacrity_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'Z607')
  call UnitAddAbility2(Target,'A0VJ')
  call SetUnitAbilityLevel(Target,'A0VJ',1+Level)
  call UnitAddAbility2(Target,'A109')
  call SetUnitAbilityLevel(Target,'A109',1+Level)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call TriggerAddCondition(t,Condition(function Lod_Alacrity_Expire))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIsp\\SpeedTarget.mdl",Target,"origin")))
  set t=null
  set Hero=null
  set Target=null
endfunction

function Lod_IceWall_GetSlow takes unit Source returns integer
  local integer Level=GetUnitAbilityLevel(Source,'Z606')+1
  if Level==1 then
    return 'A230'
  elseif Level==2 then
    return 'A22Z'
  elseif Level==3 then
    return 'A22Y'
  elseif Level==4 then
    return 'A22U'
  elseif Level==5 then
    return 'A22V'
  elseif Level==6 then
    return 'A22W'
  elseif Level==7 then
    return 'A22X'
  endif
  return 'A230'
endfunction

function Lod_IceWall_RemoveSlow takes unit Target returns nothing
  call UnitRemoveAbility(Target,'A230')
  call UnitRemoveAbility(Target,'A22Z')
  call UnitRemoveAbility(Target,'A22Y')
  call UnitRemoveAbility(Target,'A22U')
  call UnitRemoveAbility(Target,'A22V')
  call UnitRemoveAbility(Target,'A22W')
  call UnitRemoveAbility(Target,'A22X')
  call UnitRemoveAbility(Target,'B08Z')
endfunction

function Lod_IceWall_Remove takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real JSD=(LoadReal(HY,(GetHandleId(Target)),(681)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or JSD<(TimerGetElapsed(GlobalTimer))then
    call Lod_IceWall_RemoveSlow(Target)
  endif
  set t=null
  set Target=null
  return false
endfunction

function Lod_IceWall_Slow takes nothing returns nothing
  local unit Source=tt_unit1
  local unit Target=GetEnumUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real JSD=(LoadReal(HY,(GetHandleId(Target)),(681)))
  if JSD<(TimerGetElapsed(GlobalTimer))then
    call UnitAddAbility2(Target,Lod_IceWall_GetSlow(Source))
  endif
  call SaveReal(HY,(GetHandleId(Target)),(681),(((TimerGetElapsed(GlobalTimer))+2)*1.))
  call SaveUnitHandle(HY,h,17,(Target))
  call TriggerRegisterTimerEvent(t,2.01,false)
  call TriggerRegisterDeathEvent(t,Target)
  call TriggerAddCondition(t,Condition(function Lod_IceWall_Remove))
  set t=null
  set Source=null
  set Target=null
endfunction

function Lod_IceWall_Periodic takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real SourceX=(LoadReal(HY,h,6))
  local real SourceY=(LoadReal(HY,h,7))
  local real a=(LoadReal(HY,h,(137)))
  local real Duration=(LoadReal(HY,h,(57)))
  local real x
  local real y
  local integer i=1
  local integer Count=GetTriggerEvalCount(t)
  local group g
  if Count*.1>Duration then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Source
    loop
      exitwhen i>7
      set x=SourceX+80*i*Cos((a+90)*bj_DEGTORAD)
      set y=SourceY+80*i*Sin((a+90)*bj_DEGTORAD)
      call GroupEnumUnitsInRange(g,x,y,105,Condition(function NonImmuneEnemyFilter))
      call ForGroup(g,function Lod_IceWall_Slow)
      set x=SourceX+80*i*Cos((a-90)*bj_DEGTORAD)
      set y=SourceY+80*i*Sin((a-90)*bj_DEGTORAD)
      call GroupEnumUnitsInRange(g,x,y,105,Condition(function NonImmuneEnemyFilter))
      call ForGroup(g,function Lod_IceWall_Slow)
      set i=i+1
    endloop
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Lod_IceWall_Effect takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real a=GetUnitFacing(Source)
  local integer i=1
  local unit Caster
  local real x
  local real y
  local real SourceX=GetUnitX(Source)+225*Cos(a*bj_DEGTORAD)
  local real SourceY=GetUnitY(Source)+225*Sin(a*bj_DEGTORAD)
  local integer Level=GetUnitAbilityLevel(Source,'Z606')
  local real Duration=1.5+2*Level
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  if GetUnitTypeId(Source)=='e00E' then //Multicast
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
    set a=GetRandomReal(0,360)
    set SourceX=GetUnitX(Source)+225*Cos(a*bj_DEGTORAD)
    set SourceY=GetUnitY(Source)+225*Sin(a*bj_DEGTORAD)
  endif
  loop
    exitwhen i>7
    set x=SourceX+80*i*Cos((a+90)*bj_DEGTORAD)
    set y=SourceY+80*i*Sin((a+90)*bj_DEGTORAD)
    set Caster=CreateUnit(GetOwningPlayer(Source),'u00O',x,y,GetRandomReal(0,360))
    call SetUnitAbilityLevel(Caster,'S00H',1+Level)
    call SetUnitAbilityLevel(Caster,'A0XN',1+Level)
    call SetUnitAnimation(Caster,"birth")
    call QueueUnitAnimation(Caster,"stand")
    call UnitApplyTimedLife(Caster,'BTLF',Duration)
    set x=SourceX+80*i*Cos((a-90)*bj_DEGTORAD)
    set y=SourceY+80*i*Sin((a-90)*bj_DEGTORAD)
    set Caster=CreateUnit(GetOwningPlayer(Source),'u00O',x,y,GetRandomReal(0,360))
    call SetUnitAbilityLevel(Caster,'S00H',1+Level)
    call SetUnitAbilityLevel(Caster,'A0XN',1+Level)
    call SetUnitAnimation(Caster,"birth")
    call QueueUnitAnimation(Caster,"stand")
    call UnitApplyTimedLife(Caster,'BTLF',Duration)
    set i=i+1
  endloop
  call TriggerAddCondition(t,Condition(function Lod_IceWall_Periodic))
  call TriggerRegisterTimerEvent(t,.1,true)
  call SaveReal(HY,h,6,((SourceX)*1.))
  call SaveReal(HY,h,7,((SourceY)*1.))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,(57),((Duration)*1.))
  set Caster=null
  set Source=null
  set t=null
endfunction

function RemoveGhostWalkDeact takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  if IsDead(u)==false then
    call UnitRemoveAbility(u,'QFZZ')
    if GetUnitAbilityLevel(u,'QFZZ')==0 then
      call FlushChildHashtable(HY,GetHandleId(t))
      call DestroyTrigger(t)
    endif
  endif
  set t=null
  set u=null
  return false
endfunction

function Lod_GhostWalk_Move takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local trigger tt
  if GetUnitAbilityLevel(Hero,'B08X')==0 then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'Z605',true)
    call UnitRemoveAbility(Hero,'QFZZ')
    if GetUnitAbilityLevel(Hero,'QFZZ')>0 then
      set tt=CreateTrigger()
      call TriggerRegisterTimerEvent(tt,1,true)
      call TriggerAddCondition(tt,Condition(function RemoveGhostWalkDeact))
      call SaveUnitHandle(HY,GetHandleId(tt),0,Hero)
      set tt=null
    endif
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitAbilityLevel(Caster,'A0VH',GetUnitAbilityLevel(Hero,'Z605'))
    call SetUnitX(Caster,GetUnitX(Hero))
    call SetUnitY(Caster,GetUnitY(Hero))
  endif
  set t=null
  set Caster=null
  set Hero=null
  return false
endfunction

function Lod_GhostWalk_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',GetUnitX(Hero),GetUnitY(Hero),0)
  local integer id='QH50'
  local integer lvl=GetUnitAbilityLevel(Hero,'Z605')
  local integer i=GetUnitAbilityLevel(Hero,'Z605')
  if lvl==4 then
    set id='QH51'
    set i=1
  endif
  call UnitAddAbility2(Caster,id)
  call SetUnitAbilityLevel(Caster,id,i)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function Lod_GhostWalk_Move))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'Z605',false)
  call UnitAddAbility(Hero,'QFZZ')
  call SetUnitAbilityLevel(Hero,'QFZZ',1)
  set t=null
  set Hero=null
  set Caster=null
endfunction

function Lod_ColdSnap_Stun takes unit Source,unit Target, integer lvl returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0VI')
  call IssueTargetOrderById(Caster,852095,Target)
  if IsMagicImmune(Target)==false then
    call DamageTarget(Source,Target,1,25+5*lvl)
  endif
  set Caster=null
endfunction

function Lod_ColdSnap_OnHit takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,(30))
  local integer Level=(LoadInteger(HY,h,5))
  local unit Source=(LoadUnitHandle(HY,h,2))
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamage()>10 and((LoadInteger(HY,(GetHandleId((t))),((4263))))==1)==false and GetOwningPlayer(GetEventDamageSource())!=GetOwningPlayer(GetTriggerUnit()) and IsRealDamage then
      call DisableTrigger(t)
      call Lod_ColdSnap_Stun(Source,Target,Level)
      call EnableTrigger(t)
      call AddTimedKeyForTrigger(t,4263,.6)
    endif
  else
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set Source=null
  return false
endfunction

function Lod_ColdSnap_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'Z604')
  call TriggerRegisterTimerEvent(t,2.5+Level*.5,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function Lod_ColdSnap_OnHit))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,2,(Hero))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Weapons\\SpiritOfVengeanceMissile\\SpiritOfVengeanceMissile.mdl",Target,"overhead")))
  call Lod_ColdSnap_Stun(Hero,Target,Level)
  set t=null
  set Hero=null
  set Target=null
endfunction

function XHF takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='fRG1' or GetUnitTypeId(GetFilterUnit())=='fRG2' or GetUnitTypeId(GetFilterUnit())=='fRG3' or GetUnitTypeId(GetFilterUnit())=='fRG4' then
    call KillUnit(GetFilterUnit())
  endif
  return false
endfunction

function Lod_ForgeSpirit_Filter takes player p returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsOfPlayer(g,p,Condition(function XHF))
  call KillGroup(g)
  set g=null
endfunction

function Lod_ForgeSpirit_Effect takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit d
  local integer Level=GetUnitAbilityLevel(Source,'Z603')
  if GetUnitTypeId(Source)!='e00E' then
    call Lod_ForgeSpirit_Filter(GetOwningPlayer(Source))
  endif
  set d=CreateUnit(GetOwningPlayer(Source),'fRG0'+Level,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  call SetUnitColor(d,GetPlayerColor(Sentinels[0]))
  call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",d,"chest")
  call UnitApplyTimedLife(d,'BTLF',35)
  call SetUnitAbilityLevel(d,'A0VV',1+Level)
  call XFF(d)
  if AutoselectionStatus[GetPlayerId(GetOwningPlayer(Source))]then
    call SelectUnitAddForPlayer(d,GetOwningPlayer(Source))
  endif
  if Level>2 then
    set d=CreateUnit(GetOwningPlayer(Source),'fRG0'+Level,GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
    call SetUnitColor(d,GetPlayerColor(Sentinels[0]))
    call AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspiritdone.mdl",d,"chest")
    call UnitApplyTimedLife(d,'BTLF',35)
    call SetUnitAbilityLevel(d,'A0VV',1+Level)
    call XFF(d)
    if AutoselectionStatus[GetPlayerId(GetOwningPlayer(Source))]then
      call SelectUnitAddForPlayer(d,GetOwningPlayer(Source))
    endif
  endif
  set Source=null
  set d=null
endfunction

function Lod_ChaosMeteor_ResidualPeriodic takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local real Damage=(LoadReal(HY,h,(20)))
  local effect FX=(LoadEffectHandle(HY,h,(32)))
  local integer Count=GetTriggerEvalCount(t)
  call DamageTarget(Source,Target,1,Damage)
  if GetUnitAbilityLevel(Target,'A42R')==0 or Count==3 then
    call SaveInteger(MHT,GetHandleId(Target),'A42R',LoadInteger(MHT,GetHandleId(Target),'A42R')-1)
    if LoadInteger(MHT,GetHandleId(Target),'A42R')<=0 then
      call UnitRemoveAbility(Target,'A42R')
      call UnitRemoveAbility(Target,'B0HI')
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call DestroyEffect(FX)
  endif
  set t=null
  set Source=null
  set Target=null
  set FX=null
  return false
endfunction

function Lod_ChaosMeteor_Residual takes unit Source,unit Target,real Damage, boolean last returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveReal(HY,h,(20),((Damage)*1.))
  call SaveBoolean(HY,h,0,last)
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Environment\\SmallBuildingFire\\SmallBuildingFire2.mdl",Target,"chest")))
  call TriggerRegisterTimerEvent(t,1,true)
  call UnitAddAbility2(Target,'A42R')
  call SaveInteger(MHT,GetHandleId(Target),'A42R',LoadInteger(MHT,GetHandleId(Target),'A42R')+1)
  call TriggerAddCondition(t,Condition(function Lod_ChaosMeteor_ResidualPeriodic))
  set t=null
endfunction

function Lod_ChaosMeteor_Affect takes nothing returns nothing
  call Lod_ChaosMeteor_Residual(tt_unit1,GetEnumUnit(),tt_real1/ 5,tt_bool1)
  call DamageTarget(tt_unit1,GetEnumUnit(),1,tt_real1)
endfunction

function Lod_ChaosMeteor_Rolling takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local real a=(LoadReal(HY,h,(137)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=GetTriggerEvalCount(t)-26
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real AO8
  local real AP8
  local unit Caster
  local group g
  if Count==1 then
    set Caster=CreateUnit(GetOwningPlayer(Source),'e01L',x,y,a*bj_RADTODEG)
    call SaveUnitHandle(HY,h,(19),(Caster))
  elseif Count>1 then
    set Caster=(LoadUnitHandle(HY,h,(19)))
  endif
  if Count>0 then
    set AO8=SafeX50(GetUnitX(Caster)+15*Cos(a))
    set AP8=SafeY50(GetUnitY(Caster)+15*Sin(a))
    call SetUnitX(Caster,AO8)
    call SetUnitY(Caster,AP8)
    if(Count>1 and ModuloInteger(Count,10)==0)or Count==1 then
      set g=GetAvailableGroup()
      set tt_unit1=Source
      set tt_real1=40+20*Level
      call GroupEnumUnitsInRange(g,AO8,AP8,300,Condition(function DefaultEnemyFilter))
      set tt_bool1=Count > LoadInteger(HY,h,7)
      call ForGroup(g,function Lod_ChaosMeteor_Affect)
      call KillGroup(g)
      call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",AO8,AP8))
    endif
    if Count>LoadInteger(HY,h,7) then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call KillUnit(Caster)
    endif
  endif
  set t=null
  set g=null
  set Caster=null
  set Source=null
  return false
endfunction

function Lod_ChaosMeteor_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local unit W5F=CreateUnit(GetOwningPlayer(Source),'e01K',x,y,a*bj_RADTODEG)
  local integer Level=GetUnitAbilityLevel(Source,'Z602')
  call SetUnitTimeScale(W5F,.58)
  call UnitApplyTimedLife(W5F,'BTLF',1.75)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function Lod_ChaosMeteor_Rolling))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveInteger(HY,h,5,Level)
  call SaveInteger(HY,h,7,R2I((350+200*Level)/ 16.6))
  set t=null
  set Source=null
  set W5F=null
endfunction

function Lod_SunStrike_Damage takes nothing returns nothing
  call DamageTarget(tt_unit1,GetEnumUnit(),3,tt_real1)
endfunction

function Lod_SunStrike_Land takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real Damage=(LoadReal(HY,h,(20)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local group g=GetAvailableGroup()
  local integer Count
  set tt_unit1=Hero
  call TimedReveal(GetOwningPlayer(Hero),4,x,y,400)
  call GroupEnumUnitsInRange(g,x,y,200,Condition(function DefaultEnemyFilter))
  set Count=CountUnitsInGroup(g)
  if Count<1 then
    set Count=1
  endif
  set tt_real1=Damage/ Count
  call ForGroup(g,function Lod_SunStrike_Damage)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",x,y))
  call KillGroup(g)
  call DestroyEffect((LoadEffectHandle(HY,h,(32))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  set g=null
  return false
endfunction

function Lod_SunStrike_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real Damage=100+75*GetUnitAbilityLevel(Hero,'Z601')
  local string s=""
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Hero)) or(udg_ObserverMode and(GetLocalPlayer()==udg_Observer1 or GetLocalPlayer()==udg_Observer2))then
    set s="war3mapImported\\SunStrike.mdx"
  endif
  call TimedReveal(GetOwningPlayer(Hero),5.7,x,y,400)
  call TriggerRegisterTimerEvent(t,1.7,false)
  call TriggerAddCondition(t,Condition(function Lod_SunStrike_Land))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SaveReal(HY,h,(20),((Damage)*1.))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffect(s,x,y)))
  set t=null
  set Hero=null
endfunction

function MyTrueshotTargets takes nothing returns boolean
  local unit t=GetFilterUnit()
  local integer dmg=0
  local integer h=GetHandleId(t)
  local integer key=344691
  local boolean b=false//is unit had effect of trueshot?
  if IsUnitAlly(t,TrueshotPlayer) and IsDead(t)==false then
    if LoadBoolean(HY,h,key) then//was affected?
      set dmg=LoadInteger(HY,h,key)
      set b=true
    endif
    if IsUnitType(t,UNIT_TYPE_HERO)==true then
      if IsUnitType(t,UNIT_TYPE_RANGED_ATTACKER)==IsUnitType(TrueshotBearer,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(t,UNIT_TYPE_MELEE_ATTACKER)==IsUnitType(TrueshotBearer,UNIT_TYPE_MELEE_ATTACKER) then
        if b or GetUnitAbilityLevel(t,LoDBuff_BuffID[6])>0 then//already had bonus
          if TrueshotAlive then//trax is alive - add bonus and store it
            if dmg!=TrueshotDmg then
              call LoDStat_Sub(t,dmg,"damage")
              call SaveInteger(HY,h,key,TrueshotDmg)
              call LoDStat_Add(t,TrueshotDmg,"damage")
            endif
          else//trax is dead, remove buff and bonus
            call Buff_Remove(t,LoDBuff_BuffID[6])
            call LoDStat_Sub(t,dmg,"damage")
            call SaveInteger(HY,h,key,0)
            call SaveBoolean(HY,h,key,false)
          endif
        else//first time or new unit
          if TrueshotAlive then
            call SaveInteger(HY,h,key,TrueshotDmg)
            call SaveBoolean(HY,h,key,true)
            call LoDStat_Add(t,TrueshotDmg,"damage")
            call Buff_Add(t,LoDBuff_AbilID[6],LoDBuff_BuffID[6],-1)
          endif
        endif
      else//if types are different, but maybe it morph ability, so lets check was it affected
        if b then//it was, remove bonus
          call LoDStat_Sub(t,dmg,"damage")//remove old
          call SaveInteger(HY,h,key,0)
          call SaveBoolean(HY,h,key,false)
          call Buff_Remove(t,LoDBuff_BuffID[6])
        endif
      endif
    else
      if IsUnitType(t,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then
        if b then//was affected
          if TrueshotAlive and LoadInteger(HY,GetHandleId(TrueshotBearer),344692)==1 then
            if dmg!=TrueshotDmg then
              call SaveInteger(HY,h,key,TrueshotDmg)
              call LoDStat_Sub(t,dmg,"damage")
              call LoDStat_Add(t,TrueshotDmg,"damage")
            endif
          else
            call Buff_Remove(t,LoDBuff_BuffID[6])
            call LoDStat_Sub(t,dmg,"damage")
            call SaveInteger(HY,h,key,0)
            call SaveBoolean(HY,h,key,false)
          endif
        else//wasnt affected
          if TrueshotAlive and LoadInteger(HY,GetHandleId(TrueshotBearer),344692)==1 then
            call SaveInteger(HY,h,key,TrueshotDmg)
            call SaveBoolean(HY,h,key,true)
            call LoDStat_Add(t,TrueshotDmg,"damage")
            call Buff_Add(t,LoDBuff_AbilID[6],LoDBuff_BuffID[6],-1)
          endif
        endif
      endif
    endif
  endif
  set t=null
  return false
endfunction

function MyTrueshotDuration takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local boolean Destroy=LoadBoolean(HY,h,0)
  local integer lvl=GetUnitAbilityLevel(u,'A2O2')//+GetUnitAbilityLevel(u,'QP1R')
  local integer dmg=0
  local integer stat=0
  local integer auralvl=LoadInteger(HY,GetHandleId(u),344692)
  set stat=GetHeroHighestStatValue(u)
  set dmg=R2I((12+6*lvl)*stat/100)
  set TrueshotBearer=u
  set TrueshotPlayer=GetOwningPlayer(u)
  set TrueshotDmg=dmg
  set TrueshotAlive=true
  if IsDead(u)then
    set TrueshotDmg=0
    set TrueshotAlive=false
  endif
  call GroupEnumUnitsInRange(g_TrueshotGroup,0,0,12000,Condition(function MyTrueshotTargets))
  if (u==null) or GetUnitTypeId(u)<1 then
    call SaveBoolean(HY,h,0,true)
  endif
  if Destroy then
    call FlushChildHashtable(HY,h)
    call DestroyTimer(t)
  endif
  set TrueshotDmg=0
  set t=null
  set u=null
endfunction

function MyTrueshot takes nothing returns nothing
  local unit u=GetTriggerUnit()//trax
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0.75,true,function MyTrueshotDuration)
  call SaveUnitHandle(HY,h,0,u)
  set t=null
  set u=null
endfunction

function Drow_Trueshot_Toggling takes nothing returns nothing
  call AddTimedKeyToUnit(GetTriggerUnit(),344692,30)
endfunction


function Traxex_Gust_PushDur takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit target=LoadUnitHandle(HY,h,17)
  local real angle=LoadReal(HY,h,13)
  local real dist=LoadReal(HY,h,138)
  local real amount=LoadInteger(HY,h,0)
  local real pushdist=dist/amount
  local real newX
  local real newY
  local integer c=GetTriggerEvalCount(t)
  if c>amount or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call KillTrees(GetUnitX(target),GetUnitY(target),100)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set newX=SafeX50(GetUnitX(target)+pushdist*Cos(angle))
    set newY=SafeY50(GetUnitY(target)+pushdist*Sin(angle))
    call SetUnitX(target,newX)
    call SetUnitY(target,newY)
  endif
  set t=null
  set caster=null
  set target=null
  return false
endfunction

function Traxex_Gust_PushUnits takes unit dummy,unit target,unit caster,real x,real y returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real angle=Atan2(GetUnitY(target)-GetUnitY(dummy),GetUnitX(target)-GetUnitX(dummy))
  local real dist=DistanceBetweenXY(x,y,GetUnitX(target),GetUnitY(target))
  local real pustdist=RMaxBJ(1,350*(1-dist/900))
  call SaveUnitHandle(HY,h,2,caster)
  call SaveUnitHandle(HY,h,17,target)
  call SaveReal(HY,h,13,(angle*1.0))
  call SaveReal(HY,h,138,(pustdist*1.0))
  call SaveInteger(HY,h,0,25+5*GetUnitUserData(dummy))
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Traxex_Gust_PushDur))
  set t=null
endfunction

function Traxex_Gust_ForGroup takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),Traxex_Gust_TempGroup)==false and IsMagicImmune(GetEnumUnit())==false then
    call GroupAddUnit(Traxex_Gust_TempGroup,GetEnumUnit())
    call Traxex_Gust_PushUnits(tt_unit1,GetEnumUnit(),Traxex_Gust_Tempunit,Traxex_Gust_TempX,Traxex_Gust_TempY)
  endif
endfunction

function Traxex_Gust_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit dummy=LoadUnitHandle(HY,h,19)
  local real angle=LoadReal(HY,h,137)
  local real casterX=LoadReal(HY,h,64)
  local real casterY=LoadReal(HY,h,65)
  local real targetX=LoadReal(HY,h,66)
  local real targetY=LoadReal(HY,h,67)
  local group g=LoadGroupHandle(HY,h,22)
  local real dummyX=GetUnitX(dummy)
  local real dummyY=GetUnitY(dummy)
  local group gg
  local unit dummysilencer=LoadUnitHandle(HY,h,0)
  if DistanceBetweenXY(dummyX,dummyY,targetX,targetY)<100 then
    set dummyX=targetX
    set dummyY=targetY
  else
    set dummyX=dummyX+40*Cos(angle)
    set dummyY=dummyY+40*Sin(angle)
  endif
  set dummyX=SafeX50(dummyX)
  set dummyY=SafeY50(dummyY)
  call SetUnitX(dummy,dummyX)
  call SetUnitY(dummy,dummyY)
  call SetUnitX(dummysilencer,dummyX)
  call SetUnitY(dummysilencer,dummyY)
  if ModuloInteger(GetTriggerEvalCount(t),2)==1 and GetTriggerEvalCount(t)<20 then
    call IssuePointOrder(dummysilencer,"silence",dummyX,dummyY)
  endif
  
  set gg=GetAvailableGroup()
  set tt_unit1=dummy
  set Traxex_Gust_Tempunit=caster
  set Traxex_Gust_TempX=casterX
  set Traxex_Gust_TempY=casterY
  set Traxex_Gust_TempGroup=g
  call GroupEnumUnitsInRange(gg,dummyX,dummyY,275,Condition(function DefaultEnemyFilter))
  call ForGroup(gg,function Traxex_Gust_ForGroup)
  call KillGroup(gg)
  if(dummyX==targetX and dummyY==targetY)or GetTriggerEvalCount(t)>35 then
    set gg=GetAvailableGroup()
    set tt_unit1=dummy
    set Traxex_Gust_Tempunit=caster
    set Traxex_Gust_TempX=casterX
    set Traxex_Gust_TempY=casterY
    set Traxex_Gust_TempGroup=g
    call GroupEnumUnitsInRange(gg,dummyX,dummyY,275,Condition(function DefaultEnemyFilter))
    call ForGroup(gg,function Traxex_Gust_ForGroup)
    call KillGroup(gg)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(dummy)
    call KillGroup(g)
  endif
  set dummysilencer=null
  set t=null
  set dummy=null
  set g=null
  set gg=null
  set caster=null
  return false
endfunction

function Traxex_Gust_Start takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local location l=GetSpellTargetLoc()
  local unit u=GetTriggerUnit()
  local real x=GetLocationX(l)
  local real y=GetLocationY(l)
  local real angle=Atan2(y-GetUnitY(u),x-GetUnitX(u))
  local unit d=CreateUnit(GetOwningPlayer(u),'h02J',GetUnitX(u),GetUnitY(u),angle*bj_RADTODEG)//use Basilius dummy
  local unit dummysilencer=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  call UnitAddAbility(dummysilencer,'A0QB')
  call SetUnitAbilityLevel(dummysilencer,'A0QB',GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerAddCondition(t,Condition(function Traxex_Gust_Duration))
  call SaveUnitHandle(HY,h,2,u)
  call SaveUnitHandle(HY,h,19,d)
  call SetUnitUserData(d,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call SaveUnitHandle(HY,h,0,dummysilencer)
  call SaveReal(HY,h,137,(angle*1.0))
  call SaveReal(HY,h,64,GetUnitX(u))
  call SaveReal(HY,h,65,GetUnitY(u))
  call SaveReal(HY,h,66,GetUnitX(u)+900*Cos(angle))
  call SaveReal(HY,h,67,GetUnitY(u)+900*Sin(angle))
  call SaveGroupHandle(HY,h,22,GetAvailableGroup())
  call RemoveLocation(l)
  set t=null
  set dummysilencer=null
  set l=null
  set d=null
  set u=null
endfunction

function Trax_Marksmanship_Targets takes nothing returns nothing
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  if group_temp_boolean and IsUnitType(t,UNIT_TYPE_HERO) and IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false then
    set group_temp_boolean = false
  endif
  set t = null
  set u = null
endfunction

function Trax_Marksmanship_Duration takes nothing returns nothing
  local integer lvl
  local timer t = GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer id='QF89'
  local unit u=LoadUnitHandle(HY,h,0)
  if GetHandleId(u)>0 then
    set group_temp_unit[0] = u
    set group_temp_boolean = true
    if LoadBoolean(HY,h,0)==false then
      if GetUnitAbilityLevel(u,'A0VC')>0 then
        set id='A0VC'
      endif
      if GetUnitAbilityLevel(u,id)< GetUnitAbilityLevel(u,'QF88') then
        call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(u,'QF88'))
      endif
    endif
    call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),400+25,Condition(function Trax_Marksmanship_Targets))
    if group_temp_boolean or LoadBoolean(HY,GetHandleId(u),4336821) then
      if LoadBoolean(HY,h,0) then
        set lvl=LoadInteger(HY,h,0)
      else
        set lvl = GetUnitAbilityLevel(u,'QF88')
      endif
      if GetUnitAbilityLevel(u,'A2NX')!=lvl then
        call UnitAddAbility2(u,'A2NX')
        call SetUnitAbilityLevel(u,'A2NX',lvl)
        if GetUnitPrimaryAttribute(u)!=2 then
          call UnitAddAbility2(u,'A33L')
          call SetUnitAbilityLevel(u,'A33L',lvl)
        endif
      endif
      set u=null
      set t = null
      return
    endif
    call UnitRemoveAbility(u,'A2NX')
    call UnitRemoveAbility(u,'A33L')
  else
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set u=null
  set t = null
endfunction

function Trax_Marksmanship_learn takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local timer t = CreateTimer()
  local integer id='A0VC'
  if IsMeleeUnit(u,GetPlayerId(GetOwningPlayer(u))*PlayerSkillOffset) then
    set id='QF89'
  endif
  call UnitAddAbility2(u,id)
  call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(u,'QF88'))
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveBoolean(HY,GetHandleId(u),4336821,false)
  call TimerStart(t,0.1,true,function Trax_Marksmanship_Duration)
  set t = null
  set u = null
endfunction

function Trax_Marksmanship_IllusionAdd takes unit u, integer lvl returns nothing
  local timer t = CreateTimer()
  local integer pid=GetPlayerId(GetOwningPlayer(u))
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call TimerStart(t,0.1,true,function Trax_Marksmanship_Duration)
  call SaveInteger(HY,GetHandleId(t),0,lvl)
  call SaveBoolean(HY,GetHandleId(t),0,true)
  set t = null
endfunction

function Trax_Marksmanship_Illusion takes nothing returns nothing
  local unit illus=LoadUnitHandle(TempHash,'ILLU',0)
  local unit origin=LoadUnitHandle(TempHash,'ILLU',1)
  call RemoveSavedHandle(TempHash,'ILLU',0)
  call RemoveSavedHandle(TempHash,'ILLU',1)
  if GetUnitAbilityLevel(origin,'A0VC')>0 or GetUnitAbilityLevel(origin,'QF89')>0 then
    call Trax_Marksmanship_IllusionAdd(illus,GetUnitAbilityLevel(origin,'A0VC')+GetUnitAbilityLevel(origin,'QF89'))
  endif
  set illus=null
  set origin=null
endfunction

function MARKSMANSHIP_EFFECT_END takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call SaveBoolean(HY,GetHandleId(u),4336821,false)
  call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),1))
  call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),2))
  call FlushChildHashtable(HY,GetHandleId(t))
  call UnitRemoveAbility(u,'QF86')
  call UnitRemoveAbility(u,'DF86')
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function MARKSMANSHIP_EFFECT takes nothing returns boolean
  local timer t
  if GetSpellAbilityId()=='QF89' then
    set t=CreateTimer()
    call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),4336821,true)
    call TimerStart(t,6,false,function MARKSMANSHIP_EFFECT_END)
    call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
    call SaveEffectHandle(HY,GetHandleId(t),1,AddSpecialEffectTarget("Abilities\\Weapons\\ProcMissile\\ProcMissile.mdl",GetTriggerUnit(),"left hand"))
    call SaveEffectHandle(HY,GetHandleId(t),2,AddSpecialEffectTarget("Abilities\\Weapons\\ProcMissile\\ProcMissile.mdl",GetTriggerUnit(),"right hand"))
    call UnitAddAbility(GetTriggerUnit(),'QF86')
    set t=null
  endif
  
  return false
endfunction

function MARKSMANSHIP_EFFECT_sup takes nothing returns nothing
  local timer t=CreateTimer()
  call SaveBoolean(HY,GetHandleId(GetTriggerUnit()),4336821,true)
  call TimerStart(t,6,false,function MARKSMANSHIP_EFFECT_END)
  call SaveUnitHandle(HY,GetHandleId(t),0,GetTriggerUnit())
  call SaveEffectHandle(HY,GetHandleId(t),1,AddSpecialEffectTarget("Abilities\\Weapons\\ProcMissile\\ProcMissile.mdl",GetTriggerUnit(),"left hand"))
  call SaveEffectHandle(HY,GetHandleId(t),2,AddSpecialEffectTarget("Abilities\\Weapons\\ProcMissile\\ProcMissile.mdl",GetTriggerUnit(),"right hand"))
  call UnitAddAbility(GetTriggerUnit(),'QF86')
  set t=null
endfunction

function YBF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,5)
  local real Damage
  if Level==1 then
    set Damage=15
  elseif Level==2 then
    set Damage=30
  elseif Level==3 then
    set Damage=40
  elseif Level==4 then
    set Damage=50
  endif
  if GetTriggerEvalCount(t)==3 or GetTriggerEvalCount(t)==4 then
    call DamageTarget(Source,Target,1,Damage)
  endif
  if GetTriggerEvalCount(t)==4 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call UnitRemoveAbility(Target,'A1VS')
    call UnitRemoveAbility(Target,'B0DN')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function YCF takes unit source, unit target, integer lvl returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function YBF))
  call SaveUnitHandle(HY,h,2,source)
  call SaveUnitHandle(HY,h,17,target)
  call SaveInteger(HY,h,5,lvl)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",target,"chest"))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(target),'A1VS',false)
  call UnitAddAbility2(target,'A1VS')
  set t=null
endfunction

function SkeletonKing_HellfireBlastHit takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) then
      call StunTargetLod(GetTriggerUnit(), 2.00)
      call DamageTarget(LoadUnitHandle(HY,h,1),GetTriggerUnit(),1,50*LoadReal(HY,h,0))
      call YCF(LoadUnitHandle(HY,h,1),GetTriggerUnit(),R2I(LoadReal(HY,h,0)))
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  endif
  set t=null
endfunction

function SkeletonKing_HellfireBlast_Real takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  call UnitAddAbility(d,'A42G')
  if IssueTargetOrder(d,"thunderbolt",target) then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3.5,false)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function SkeletonKing_HellfireBlastHit))
    call SaveUnitHandle(HY,h,0,d)
    call SaveUnitHandle(HY,h,1,caster)
    call SaveReal(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
    set t=null
  endif
  set caster=null
  set target=null
  set d=null
endfunction

function SkeletonKing_HellfireBlast_OnCast takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIfb\\AIfbSpecialArt.mdl",GetTriggerUnit(),GetProperAttachPoint_Weapon(GetTriggerUnit())))
endfunction

function SkeletonKing_HellfireBlast takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call SkeletonKing_HellfireBlast_Real()
  endif
endfunction

function SK_VampiricAura_Ranged takes unit attacker, unit target returns nothing
  local integer lvl
  local real percent
  if IsUnitType(target,UNIT_TYPE_STRUCTURE)==false and IsUnitType(target,UNIT_TYPE_MECHANICAL)==false and IsUnitEnemy(attacker,GetOwningPlayer(target)) and (GetUnitAbilityLevel(attacker,'BVA1')>0 or GetUnitAbilityLevel(attacker,'BVA2')>0 or GetUnitAbilityLevel(attacker,'BVA3')>0 or GetUnitAbilityLevel(attacker,'BVA4')>0) and IsDead(attacker)==false then
    set lvl=GetUnitAbilityLevel(attacker,'BVA1')+GetUnitAbilityLevel(attacker,'BVA2')*2+GetUnitAbilityLevel(attacker,'BVA3')*3+GetUnitAbilityLevel(attacker,'BVA4')*4
    set percent=0.1+0.05*lvl
    call SetWidgetLife(attacker,GetWidgetLife(attacker)+GetEventDamage()*percent)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",attacker,"origin"))
  endif
endfunction

function Y1F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call SelectUnitForPlayerSingle(Source,GetOwningPlayer(Source))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set h = GetHandleId(Source)
  if LoadBoolean(MHT,h,StringHash("morphedburn")) then
    call UnMorphUnit(Source,LoadInteger(MHT,h,StringHash("second")))
    call UnMorphUnit(Source,LoadInteger(MHT,h,StringHash("first")))
    call SaveBoolean(MHT,h,StringHash("morphedburn"),false)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Y0F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=GetUnitAbilityLevel(Source,'A01Y')
  local unit Caster
  local integer pid=GetPlayerId(GetOwningPlayer(Source))
  local boolean b=false
  if GetUnitState(Source,UNIT_STATE_MANA)>=160 then
    if SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]]=='A01Y' and TimerGetRemaining(PrimUltiTimer[pid])==0 then
      set b=true
      call TimerStart(PrimUltiTimer[pid],360-100*Level,false,null)
    elseif SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+6]]=='A01Y' and TimerGetRemaining(SecUltiTimer[pid])==0 then
      set b=true
      call TimerStart(SecUltiTimer[pid],360-100*Level,false,null)
    endif
  endif
  if b then
    if IsTerrainPathable(GetUnitX(Source),GetUnitY(Source),PATHING_TYPE_WALKABILITY)then
      call YL9(Source)
    endif
    set t=CreateTrigger()
    set h=GetHandleId(t)
    set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
    call UnitAddAbility(Caster,'A274')
    call IssueImmediateOrderById(Caster,852096)
    set Caster=null
    call TriggerRegisterTimerEvent(t,3+.01,false)
    call TriggerAddCondition(t,Condition(function Y1F))
    call SaveUnitHandle(HY,h,2,(Source))
  endif
  set t=null
  set Source=null
  return false
endfunction

function Leoric_Reincarnation_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function Y0F))
  call SaveUnitHandle(HY,h,2,(Source))
  set t=null
  set Source=null
endfunction

function SkeletonKing_MortalStrike_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit target=LoadUnitHandle(HY,h,17)
  local integer lvl=GetUnitAbilityLevel(caster,'A2S0')
  local real StolenHPCounter=LoadReal(HY,h,797)
  local real StolenHPCounterTarget=LoadReal(HY,h,798)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call SaveInteger(HY,GetHandleId(caster),4338,2)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',true)
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif StolenHPCounter>0 then
    call SaveInteger(HY,GetHandleId(caster),4338,2)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',true)
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if IsDead(caster)==false then
      call SetWidgetLife(caster,RMaxIF(1,GetWidgetLife(caster)-StolenHPCounter))
    endif
    if IsDead(target)==false then
      call SetWidgetLife(target,GetWidgetLife(target)+StolenHPCounterTarget)
    endif
  else
    set StolenHPCounter=GetUnitState(target,UNIT_STATE_MAX_LIFE)*0.2
    call SaveReal(HY,h,798,StolenHPCounter*1.0)
    if IsUnitType(caster,UNIT_TYPE_HERO) then
      call SetWidgetLife(target,RMaxIF(1,GetWidgetLife(target)-StolenHPCounter))
    endif
    if StolenHPCounter+GetWidgetLife(caster)>GetUnitState(caster,UNIT_STATE_MAX_LIFE) then
      set StolenHPCounter=GetUnitState(caster,UNIT_STATE_MAX_LIFE)-GetWidgetLife(caster)
    endif
    if StolenHPCounter==0 then
      set StolenHPCounter=0.01
    endif
    call SetWidgetLife(caster,GetWidgetLife(caster)+StolenHPCounter)
    call SaveReal(HY,h,797,StolenHPCounter*1.0)
  endif
  set t=null
  set caster=null
  set target=null
  return false
endfunction

function SkeletonKing_MortalStrike_Effect takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  call TriggerRegisterTimerEvent(t,0.01,false)
  call TriggerRegisterTimerEvent(t,7,false)
  call TriggerRegisterDeathEvent(t,caster)
  call TriggerAddCondition(t,Condition(function SkeletonKing_MortalStrike_Duration))
  call SaveUnitHandle(HY,h,2,caster)
  call SaveUnitHandle(HY,h,17,target)
  call SaveReal(HY,h,797,0)
  call SaveReal(HY,h,798,0)
  call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("war3mapImported\\MortalStrikeCaster.mdx",caster,"overhead"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("war3mapImported\\MortalStrikeTarget.mdx",target,"overhead"))
  call SaveInteger(HY,GetHandleId(caster),4338,1)
  call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'AOcr',false)
  set t=null
  set caster=null
  set target=null
endfunction

function SkeletonKing_MortalStrike_AddCrit takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A2S0')+GetUnitAbilityLevel(u,'QP0W')
  if lvl==1 then
    call UnitAddAbility2(u,'Q251')
    call UnitMakeAbilityPermanent(u,true,'AOcr')
  endif
  call SetUnitAbilityLevel(u,'AOcr',lvl)
  set u=null
endfunction

function SkeletonKing_MortalStrike_RegSup takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call SkeletonKing_MortalStrike_Effect()
  endif
endfunction

function Z4F takes unit whichUnit returns boolean
  return(GetUnitTypeId(whichUnit)==('H00I')or GetUnitTypeId(whichUnit)==('H00J')or GetUnitTypeId(whichUnit)==GetUnitTypeId(GetTriggerUnit()))and GetWidgetLife(whichUnit)>.5 and GetOwningPlayer(whichUnit)==GetOwningPlayer(GetTriggerUnit())
endfunction

function Z8F takes nothing returns boolean
  return Z4F(GetFilterUnit())
endfunction

function Z9F takes nothing returns nothing
  local unit YLD=GetEnumUnit()
  local real ZDF=YX8(YLD,Y3)
  if ZDF<TmpReal378 then
    set TmpReal378=ZDF
    set TmpUnit376=YLD
  endif
  set YLD=null
endfunction

function ZEF takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0)!=null
endfunction

function ZFF takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\ArcaneTowerAttack.mdl",GetEnumUnit(),"origin"))
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,TmpReal378)
endfunction

function Meepo_Poof takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local location PKE
  local real x
  local real y
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local group g
  local boolean ZHF=false
  if Target!=null and Z4F(Target)then
    set x=GetUnitX(Target)
    set y=GetUnitY(Target)
    set ZHF=true
  else
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,0,0,999999,Condition(function Z8F))
    if Target!=null then
      set PKE=GetUnitLoc(Target)
    else
      set PKE=GetSpellTargetLoc()
    endif
    set TmpUnit376=FirstOfGroup(g)
    if TmpUnit376!=null then
      set ZHF=true
      call GroupRemoveUnit(g,TmpUnit376)
      set TmpReal378=YX8(TmpUnit376,PKE)
      set Y3=PKE
      call ForGroup(g,function Z9F)
      set Target=TmpUnit376
      set x=GetUnitX(Target)
      set y=GetUnitY(Target)
    endif
    call KillGroup(g)
    call RemoveLocation(PKE)
  endif
  if ZHF then
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",SourceX,SourceY))
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",x,y))
    call SetUnitX(Source,x)
    call SetUnitY(Source,y)
    set TmpReal378=60+GetUnitAbilityLevel(GetTriggerUnit(),'A0N8')*40
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,SourceX,SourceY,400,Condition(function ZEF))
    call ForGroup(g,function ZFF)
    call KillGroup(g)
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,400,Condition(function ZEF))
    call ForGroup(g,function ZFF)
    call KillGroup(g)
  endif
  set g=null
  set Source=null
  set Target=null
  set PKE=null
endfunction

function ZNF takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(TmpUnit376)) and GetWidgetLife(GetFilterUnit())>.5 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetUnitTypeId(GetFilterUnit())!='n00L')!=null
endfunction

function ZOF takes nothing returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(TmpUnit376),'e00E',TmpReal378,Meepo_Earthbind_TempY,0)
  call UnitAddAbility2(Caster,'A0NC')
  call SetUnitAbilityLevel(Caster,'A0NC',tt_int1)
  call IssueTargetOrderById(Caster,852106,GetEnumUnit())
  call DamageTarget(Caster,GetEnumUnit(),1,75+25*tt_int1)
  set Caster=null
endfunction

function ZPF takes unit Projectile,real x,real y, integer lvl returns nothing
  local group g=GetAvailableGroup()
  set TmpUnit376=Projectile
  call GroupEnumUnitsInRange(g,x,y,325,Condition(function ZNF))
  set TmpReal378=x
  set Meepo_Earthbind_TempY=y
  set tt_int1=lvl
  call ForGroup(g,function ZOF)
  call KillGroup(g)
  set g=null
endfunction

function ZQF takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  local real a=LoadReal(HY,h,13)
  local real AO8=GetUnitX(Projectile)+30*Cos(a)
  local real AP8=GetUnitY(Projectile)+30*Sin(a)
  if(AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY)<1200 then
    call SetUnitX(Projectile,TargetX)
    call SetUnitY(Projectile,TargetY)
    call ZPF(Projectile,TargetX,TargetY,LoadInteger(HY,h,0))
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call KillUnit(Projectile)
    call DestroyTimer(t)
  else
    call SetUnitX(Projectile,AO8)
    call SetUnitY(Projectile,AP8)
  endif
  set t=null
  set Projectile=null
endfunction

function Meepo_Earthbind takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real TargetX=SafeX50(GetSpellTargetX())
  local real TargetY=SafeY50(GetSpellTargetY())
  local real SourceX=SafeX50(GetUnitX(Hero))
  local real SourceY=SafeY50(GetUnitY(Hero))
  local unit Projectile=CreateUnit(GetOwningPlayer(Hero),'h00C',SourceX,SourceY,0)
  local real a=Atan2(TargetY-SourceY,TargetX-SourceX)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SetUnitScale(Projectile,2,2,2)
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveReal(HY,h,47,TargetX*1.)
  call SaveReal(HY,h,48,TargetY*1.)
  call SaveReal(HY,h,13,a*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call TimerStart(t,.035,true,function ZQF)
  set Hero=null
  set Projectile=null
  set t=null
endfunction

function GeostrikeTriggered_Dur takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit geo=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or LoadReal(HY,h,0)<TimerGetElapsed(GlobalTimer) or GetUnitAbilityLevel(target,'A40F')+GetUnitAbilityLevel(target,'A412')==0 then
    call UnitRemoveAbility(target,'A40F')
    call UnitRemoveAbility(target,'A412')
    call UnitRemoveAbility(target,'B079')
    call DestroyEffect(LoadEffectHandle(HY,h,10))
    call RemoveSavedHandle(MHT,GetHandleId(target),'A40F')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if ModuloInteger(GetTriggerEvalCount(t),2)==1 then//1s tick
      call DamageTarget(geo,target,1,LoadInteger(HY,h,0)*5+10)
    endif
  endif
  set geo=null
  set target=null
  set t=null
endfunction

function GeostrikeTriggered_Apply takes unit u, unit target returns nothing
  local trigger t
  local integer h
  if GetUnitAbilityLevel(target,'A40F')>0 or GetUnitAbilityLevel(target,'A412')>0 then//already affected
    set t=LoadTriggerHandle(MHT,GetHandleId(target),'A40F')
    set h=GetHandleId(t)
    call DestroyEffect(LoadEffectHandle(HY,h,10))
    call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishHealth\\ReplenishHealthCaster.mdl",target,"origin"))
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveTriggerHandle(MHT,GetHandleId(target),'A40F',t)
    call TriggerRegisterTimerEvent(t,0.5,true)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function GeostrikeTriggered_Dur))
    call SaveUnitHandle(HY,h,0,u)
    call SaveUnitHandle(HY,h,1,target)
    if IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER)==true and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
      call UnitAddAbility2(target,'A412')
      call SaveInteger(HY,h,0,SetUnitAbilityLevel(target,'A412',GetUnitAbilityLevel(u,'A0N7')+GetUnitAbilityLevel(u,'QP1B')))
    else
      call UnitAddAbility2(target,'A40F')
      call SaveInteger(HY,h,0,SetUnitAbilityLevel(target,'A40F',GetUnitAbilityLevel(u,'A0N7')+GetUnitAbilityLevel(u,'QP1B')))
    endif
    
    call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishHealth\\ReplenishHealthCaster.mdl",target,"origin"))
    
  endif
  if Mode_BO==false and IsUnitType(u,UNIT_TYPE_RANGED_ATTACKER) and IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false then
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+2)
  else
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+4)
  endif
  set t=null
endfunction

function ZSF takes unit u returns boolean
  return GetUnitTypeId(u)=='H00I' or GetUnitTypeId(u)=='H00J'
endfunction

function IsMeepo takes unit whichUnit returns boolean
  return GetUnitTypeId(whichUnit)==('H00I')or GetUnitTypeId(whichUnit)==('H00J')
endfunction

function ZUF takes nothing returns nothing
  local integer ZVF=GetHandleId(GetTriggeringTrigger())
  local player p=(LoadPlayerHandle(HY,(ZVF),(370)))
  local integer ZWF=GetHandleId(p)
  local unit JJ9=(LoadUnitHandle(HY,(ZWF),(699)))
  local unit JK9=(LoadUnitHandle(HY,(ZWF),(700)))
  local unit JM9=(LoadUnitHandle(HY,(ZWF),(701)))
  local unit JN9=(LoadUnitHandle(HY,(ZWF),(702)))
  local unit JO9=(LoadUnitHandle(HY,(ZWF),(703)))
  local integer ZXF=GetUnitAbilityLevel(JJ9,'Aamk')*2
  local integer BUE=GetHeroAgi(JJ9,false)
  local integer ZYF=GetHeroAgi(JJ9,true)-BUE-ZXF
  local integer BVE=GetHeroStr(JJ9,false)
  local integer ZZF=GetHeroStr(JJ9,true)-BVE-ZXF
  local integer ZAF=GetHeroInt(JJ9,false)
  local integer ZBF=GetHeroInt(JJ9,true)-ZAF-ZXF
  local real ZCF=.25
  local integer Z3F=R2I(BUE+ZYF*ZCF)
  local integer Z6F=R2I(BVE+ZZF*ZCF)
  local integer ZLF=R2I(ZAF+ZBF*ZCF)
  if GetWidgetLife(JJ9)>1 then
    if JK9!=null then
      call SetHeroAgi(JK9,Z3F,false)
      call SetHeroStr(JK9,Z6F,false)
      call SetHeroInt(JK9,ZLF,false)
    endif
    if JM9!=null then
      call SetHeroAgi(JM9,Z3F,false)
      call SetHeroStr(JM9,Z6F,false)
      call SetHeroInt(JM9,ZLF,false)
    endif
    if JN9!=null then
      call SetHeroAgi(JN9,Z3F,false)
      call SetHeroStr(JN9,Z6F,false)
      call SetHeroInt(JN9,ZLF,false)
    endif
    if JO9!=null then
      call SetHeroAgi(JO9,Z3F,false)
      call SetHeroStr(JO9,Z6F,false)
      call SetHeroInt(JO9,ZLF,false)
    endif
  endif
  set p=null
  set JJ9=null
  set JK9=null
  set JM9=null
  set JN9=null
  set JO9=null
endfunction

function Z1F takes nothing returns nothing
  local integer ZVF=GetHandleId(GetTriggeringTrigger())
  local player p=(LoadPlayerHandle(HY,(ZVF),(370)))
  local integer ZWF=GetHandleId(p)
  local unit JJ9=(LoadUnitHandle(HY,(ZWF),(699)))
  local unit JK9=(LoadUnitHandle(HY,(ZWF),(700)))
  local unit JM9=(LoadUnitHandle(HY,(ZWF),(701)))
  local unit JN9=(LoadUnitHandle(HY,(ZWF),(702)))
  local unit JO9=(LoadUnitHandle(HY,(ZWF),(703)))
  local integer Z0F=GetHandleId(JJ9)
  local integer Z5F=GetHandleId(JK9)
  local integer Z2F=GetHandleId(JM9)
  local integer A4F=GetHandleId(JN9)
  local integer A7F=GetHandleId(JO9)
  local integer A8F=(LoadInteger(HY,(Z0F),(367)))
  local integer A9F=(LoadInteger(HY,(Z0F),(368)))
  local integer ADF=(LoadInteger(HY,(Z5F),(367)))
  local integer AEF=(LoadInteger(HY,(Z5F),(368)))
  local integer AFF=(LoadInteger(HY,(Z2F),(367)))
  local integer AGF=(LoadInteger(HY,(Z2F),(368)))
  local integer AHF=(LoadInteger(HY,(A4F),(367)))
  local integer AIF=(LoadInteger(HY,(A4F),(368)))
  local integer AJF=(LoadInteger(HY,(A7F),(367)))
  local integer AKF=(LoadInteger(HY,(A7F),(368)))
  local integer AMF=GetHeroXP(JJ9)
  local integer ANF=GetHeroXP(JK9)
  local integer AOF=GetHeroXP(JM9)
  local integer APF=GetHeroXP(JN9)
  local integer AQF=GetHeroXP(JO9)
  local integer ARF=AMF-A8F-A9F
  local integer ASF=ANF-ADF-AEF
  local integer ATF=AOF-AFF-AGF
  local integer AUF=APF-AHF-AIF
  local integer AVF=AQF-AJF-AKF
  if GetWidgetLife(JJ9)>1 then
    set A8F=A8F+ARF
    set ADF=ADF+ASF
    set AFF=AFF+ATF
    set AHF=AHF+AUF
    set AJF=AJF+AVF
    if JJ9!=null then
      call AddHeroXP(JK9,ARF,false)
      if GetHeroXP(JK9)!=ANF then
        set AEF=AEF+ARF
      endif
      call AddHeroXP(JM9,ARF,false)
      if GetHeroXP(JM9)!=AOF then
        set AGF=AGF+ARF
      endif
      call AddHeroXP(JN9,ARF,false)
      if GetHeroXP(JN9)!=APF then
        set AIF=AIF+ARF
      endif
      call AddHeroXP(JO9,ARF,false)
      if GetHeroXP(JO9)!=AQF then
        set AKF=AKF+ARF
      endif
    endif
    if JK9!=null then
      call AddHeroXP(JJ9,ASF,false)
      if GetHeroXP(JJ9)!=AMF then
        set A9F=A9F+ASF
      endif
      call AddHeroXP(JM9,ASF,false)
      if GetHeroXP(JM9)!=AOF then
        set AGF=AGF+ASF
      endif
      call AddHeroXP(JN9,ASF,false)
      if GetHeroXP(JN9)!=APF then
        set AIF=AIF+ASF
      endif
      call AddHeroXP(JO9,ASF,false)
      if GetHeroXP(JO9)!=AQF then
        set AKF=AKF+ASF
      endif
    endif
    if JM9!=null then
      call AddHeroXP(JK9,ATF,false)
      if GetHeroXP(JK9)!=ANF then
        set AEF=AEF+ATF
      endif
      call AddHeroXP(JJ9,ATF,false)
      if GetHeroXP(JJ9)!=AMF then
        set A9F=A9F+ATF
      endif
      call AddHeroXP(JN9,ATF,false)
      if GetHeroXP(JN9)!=APF then
        set AIF=AIF+ATF
      endif
      call AddHeroXP(JO9,ATF,false)
      if GetHeroXP(JO9)!=AQF then
        set AKF=AKF+ATF
      endif
    endif
    if JN9!=null then
      call AddHeroXP(JK9,AUF,false)
      if GetHeroXP(JK9)!=ANF then
        set AEF=AEF+AUF
      endif
      call AddHeroXP(JM9,AUF,false)
      if GetHeroXP(JM9)!=AOF then
        set AGF=AGF+AUF
      endif
      call AddHeroXP(JJ9,AUF,false)
      if GetHeroXP(JJ9)!=AMF then
        set A9F=A9F+AUF
      endif
      call AddHeroXP(JO9,AUF,false)
      if GetHeroXP(JO9)!=AQF then
        set AKF=AKF+AUF
      endif
    endif
    if JO9!=null then
      call AddHeroXP(JK9,AVF,false)
      if GetHeroXP(JK9)!=ANF then
        set AEF=AEF+AVF
      endif
      call AddHeroXP(JM9,AVF,false)
      if GetHeroXP(JM9)!=AOF then
        set AGF=AGF+AVF
      endif
      call AddHeroXP(JJ9,AVF,false)
      if GetHeroXP(JJ9)!=AMF then
        set A9F=A9F+AVF
      endif
      call AddHeroXP(JN9,AVF,false)
      if GetHeroXP(JN9)!=APF then
        set AIF=AIF+AVF
      endif
    endif
    call SaveInteger(HY,(Z0F),(367),(A8F))
    call SaveInteger(HY,(Z0F),(368),(A9F))
    call SaveInteger(HY,(Z5F),(367),(ADF))
    call SaveInteger(HY,(Z5F),(368),(AEF))
    call SaveInteger(HY,(Z2F),(367),(AFF))
    call SaveInteger(HY,(Z2F),(368),(AGF))
    call SaveInteger(HY,(A4F),(367),(AHF))
    call SaveInteger(HY,(A4F),(368),(AIF))
    call SaveInteger(HY,(A7F),(367),(AJF))
    call SaveInteger(HY,(A7F),(368),(AKF))
  endif
  set p=null
  set JJ9=null
  set JK9=null
  set JM9=null
  set JN9=null
  set JO9=null
endfunction

function AYF takes nothing returns boolean
  return IsMeepo(GetTriggerUnit())and IsUnitIllusion(GetTriggerUnit())==false
endfunction

function AZF takes unit NewHero,unit Hero returns nothing
  local trigger t=(LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Hero))),(369)))
  local integer i=0
  local boolean ABF=false
  local boolean ACF=false
  local boolean A3F=false
  local boolean A6F=false
  local boolean ALF=false
  local boolean A1F=false
  local boolean A0F=false
  local boolean A5F=false
  local boolean A2F=false
  call DisableTrigger(t)
  call DisableTrigger(t_manipulateitem)
  loop
    exitwhen i>5
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_BootsOfSpeed])then
      set ABF=true
    endif
    if (GetItemTypeId(UnitItemInSlot(Hero,i)))==(Item_Real[indexid_bootsOfTravel])then
      set ACF=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_PowerTreadsIntelligence])then
      set A3F=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_PowerTreadsStrength])then
      set A6F=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_PowerTreadsAgility])then
      set ALF=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_PhaseBoots])then
      set A1F=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_ArcaneBoots])then
      set A0F=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_TranquilBoots])then
      set A5F=true
    endif
    if GetItemTypeId(UnitItemInSlot(Hero,i))==(Item_Real[indexid_TranquilBootsBroken])then
      set A2F=true
    endif
    set i=i+1
  endloop
  if A2F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_TranquilBootsBroken]),0,0))
  elseif A5F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_TranquilBoots]),0,0))
  elseif A0F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_ArcaneBoots]),0,0))
  elseif A1F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_PhaseBoots]),0,0))
  elseif ALF then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_PowerTreadsAgility]),0,0))
  elseif A6F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_PowerTreadsStrength]),0,0))
  elseif A3F then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_PowerTreadsIntelligence]),0,0))
  elseif ACF then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_bootsOfTravel]),0,0))
  elseif ABF then
    call UnitAddItem(NewHero,CreateItem((Item_Real[indexid_BootsOfSpeed]),0,0))
  endif
  call EnableTrigger(t)
  call EnableTrigger(t_manipulateitem)
  set t=null
endfunction

function B4F takes nothing returns nothing
  local unit JP9=GetTriggerUnit()
  local integer i=0
  local boolean ABF=false
  local boolean ACF=false
  local boolean A3F=false
  local boolean A6F=false
  local boolean ALF=false
  local boolean A1F=false
  local boolean A0F=false
  local boolean A5F=false
  local boolean A2F=false
  local integer ZWF=GetHandleId(GetOwningPlayer(JP9))
  local unit JJ9=(LoadUnitHandle(HY,(ZWF),(699)))
  local unit JK9=(LoadUnitHandle(HY,(ZWF),(700)))
  local unit JM9=(LoadUnitHandle(HY,(ZWF),(701)))
  local unit JN9=(LoadUnitHandle(HY,(ZWF),(702)))
  local unit JO9=(LoadUnitHandle(HY,(ZWF),(703)))
  local integer FQ9
  local boolean B7F=false
  local integer B8F=0
  local integer B9F=0
  local integer BDF=0
  local integer BEF=0
  local integer BFF=0
  local integer BGF=0
  local integer BHF=0
  local integer BIF=0
  local integer BJF=0
  call DisableTrigger(GetTriggeringTrigger())
  if GetUnitTypeId(JP9)==('H00J')then
    call UnitRemoveItemFromSlot(JP9,0)
    call EnableTrigger(GetTriggeringTrigger())
    return
  endif
  if not(GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_BootsOfSpeed])or (GetItemTypeId(GetManipulatedItem()))==(Item_Real[indexid_bootsOfTravel])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_PowerTreadsIntelligence])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_PowerTreadsStrength])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_PowerTreadsAgility])or (GetItemTypeId(GetManipulatedItem()))==(Item_Real[indexid_PhaseBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_ArcaneBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_TranquilBoots])or GetItemTypeId(GetManipulatedItem())==(Item_Real[indexid_TranquilBootsBroken]))then
    call EnableTrigger(GetTriggeringTrigger())
    return
  endif
  call DisableTrigger(t_manipulateitem)
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_DROP_ITEM then
    set B7F=true
  endif
  loop
    exitwhen i>5
    set FQ9=GetItemTypeId(UnitItemInSlot(JP9,i))
    if FQ9==(Item_Real[indexid_BootsOfSpeed])then
      set B8F=B8F+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(B8F>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set ABF=true
      endif
    endif
    if (FQ9)==(Item_Real[indexid_bootsOfTravel])then
      set B9F=B9F+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(B9F>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set ACF=true
      endif
    endif
    if FQ9==(Item_Real[indexid_PowerTreadsIntelligence])then
      set BDF=BDF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BDF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A3F=true
      endif
    endif
    if FQ9==(Item_Real[indexid_PowerTreadsStrength])then
      set BEF=BEF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BEF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A6F=true
      endif
    endif
    if FQ9==(Item_Real[indexid_PowerTreadsAgility])then
      set BFF=BFF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BFF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set ALF=true
      endif
    endif
    if (FQ9)==(Item_Real[indexid_PhaseBoots])then
      set BGF=BGF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BGF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A1F=true
      endif
    endif
    if FQ9==(Item_Real[indexid_ArcaneBoots])then
      set BHF=BHF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BHF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A0F=true
      endif
    endif
    if FQ9==(Item_Real[indexid_TranquilBoots])then
      set BIF=BIF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BIF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A5F=true
      endif
    endif
    if FQ9==(Item_Real[indexid_TranquilBootsBroken])then
      set BJF=BJF+1
      if(not(B7F and FQ9==GetItemTypeId(GetManipulatedItem())))or(BIF>1 and FQ9==GetItemTypeId(GetManipulatedItem()))then
        set A2F=true
      endif
    endif
    set i=i+1
  endloop
  call RemoveItem(UnitRemoveItemFromSlot(JK9,0))
  if JM9!=null then
    call RemoveItem(UnitRemoveItemFromSlot(JM9,0))
  endif
  if JN9!=null then
    call RemoveItem(UnitRemoveItemFromSlot(JN9,0))
  endif
  if JO9!=null then
    call RemoveItem(UnitRemoveItemFromSlot(JO9,0))
  endif
  if A2F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_TranquilBootsBroken]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_TranquilBootsBroken]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_TranquilBootsBroken]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_TranquilBootsBroken]),0,0))
    endif
  elseif A5F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_TranquilBoots]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_TranquilBoots]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_TranquilBoots]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_TranquilBoots]),0,0))
    endif
  elseif A0F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_ArcaneBoots]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_ArcaneBoots]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_ArcaneBoots]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_ArcaneBoots]),0,0))
    endif
  elseif A1F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_PhaseBoots]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_PhaseBoots]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_PhaseBoots]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_PhaseBoots]),0,0))
    endif
  elseif ALF then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_PowerTreadsAgility]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_PowerTreadsAgility]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_PowerTreadsAgility]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_PowerTreadsAgility]),0,0))
    endif
  elseif A6F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_PowerTreadsStrength]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_PowerTreadsStrength]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_PowerTreadsStrength]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_PowerTreadsStrength]),0,0))
    endif
  elseif A3F then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_PowerTreadsIntelligence]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_PowerTreadsIntelligence]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_PowerTreadsIntelligence]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_PowerTreadsIntelligence]),0,0))
    endif
  elseif ACF then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_bootsOfTravel]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_bootsOfTravel]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_bootsOfTravel]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_bootsOfTravel]),0,0))
    endif
  elseif ABF then
    call UnitAddItem(JK9,CreateItem((Item_Real[indexid_BootsOfSpeed]),0,0))
    if JM9!=null then
      call UnitAddItem(JM9,CreateItem((Item_Real[indexid_BootsOfSpeed]),0,0))
    endif
    if JN9!=null then
      call UnitAddItem(JN9,CreateItem((Item_Real[indexid_BootsOfSpeed]),0,0))
    endif
    if JO9!=null then
      call UnitAddItem(JO9,CreateItem((Item_Real[indexid_BootsOfSpeed]),0,0))
    endif
  endif
  call EnableTrigger(GetTriggeringTrigger())
  call EnableTrigger(t_manipulateitem)
  set JP9=null
  set JM9=null
  set JN9=null
  set JO9=null
  set JJ9=null
  set JK9=null
endfunction

function DoubleTrouble_LevelAbility takes unit BMF,integer BNF returns nothing
  local integer ZWF=GetHandleId(GetOwningPlayer(BMF))
  local unit JJ9=(LoadUnitHandle(HY,(ZWF),(699)))
  local unit JK9=(LoadUnitHandle(HY,(ZWF),(700)))
  local unit JM9=(LoadUnitHandle(HY,(ZWF),(701)))
  local unit JN9=(LoadUnitHandle(HY,(ZWF),(702)))
  local unit JO9=(LoadUnitHandle(HY,(ZWF),(703)))
  if JJ9!=null and JJ9!=BMF then
    call SelectHeroSkill(JJ9,BNF)
  endif
  if JK9!=null and JK9!=BMF then
    call SelectHeroSkill(JK9,BNF)
  endif
  if JM9!=null and JM9!=BMF then
    call SelectHeroSkill(JM9,BNF)
  endif
  if JN9!=null and JN9!=BMF then
    call SelectHeroSkill(JN9,BNF)
  endif
  if JO9!=null and JO9!=BMF then
    call SelectHeroSkill(JO9,BNF)
  endif
  set JM9=null
  set JN9=null
  set JO9=null
  set JJ9=null
  set JK9=null
endfunction

function BOF takes integer AF8,unit YCD,unit Y3D returns nothing
  local integer VT8=1
  local integer VU8=GetUnitAbilityLevel(YCD,AF8)
  loop
    exitwhen VT8>VU8
    call SelectHeroSkill(Y3D,AF8)
    set VT8=VT8+1
  endloop
endfunction

function BPF takes unit NewHero,unit BQF returns nothing
  local integer i=GetPlayerId(GetOwningPlayer(BQF))
  local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
  local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
  local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
  local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]])
  call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]])
  call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]])
  call UnitAddAbility2(NewHero,EngineeringUpgradeSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]])
  call AddHeroXP(NewHero,GetHeroXP(BQF),false)
  call SaveInteger(HY,(GetHandleId(NewHero)),(368),(GetHeroXP(BQF)))
  call SaveInteger(HY,(GetHandleId(NewHero)),(367),(0))
  call BOF(aid1,BQF,NewHero)
  call BOF(aid2,BQF,NewHero)
  call BOF(aid3,BQF,NewHero)
  call BOF('A0NR',BQF,NewHero)
  call BOF(aid4,BQF,NewHero)
  call BOF(aid5,BQF,NewHero)
endfunction

function BRF takes unit JK9,unit JM9,integer BNF,integer B8F,integer B9F returns nothing
  if B8F>B9F then
    call SelectHeroSkill(JM9,BNF)
  elseif B9F>B8F then
    call SelectHeroSkill(JK9,BNF)
  endif
endfunction

function BSF takes unit JK9,unit JM9 returns nothing
  local integer ANF=GetHeroXP(JK9)
  local integer AOF=GetHeroXP(JM9)
  local integer Z5F=GetHandleId(JK9)
  local integer Z2F=GetHandleId(JM9)
  local integer AEF=(LoadInteger(HY,(Z5F),(368)))
  local integer AGF=(LoadInteger(HY,(Z2F),(368)))
  local integer YND
  if ANF>AOF then
    set YND=ANF-AOF
    call AddHeroXP(JM9,YND,true)
    if AOF!=GetHeroXP(JM9)then
      call SaveInteger(HY,(Z2F),(368),(AGF+YND))
    endif
  elseif ANF<AOF then
    set YND=AOF-ANF
    call AddHeroXP(JK9,YND,true)
    if ANF!=GetHeroXP(JK9)then
      call SaveInteger(HY,(Z5F),(368),(AEF+YND))
    endif
  endif
endfunction

function BTF takes unit JK9,unit JM9 returns nothing
  local integer i=GetPlayerId(GetOwningPlayer(JK9))
  local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
  local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
  local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
  local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  local integer BUF=GetUnitAbilityLevel(JK9,aid1)
  local integer BVF=GetUnitAbilityLevel(JK9,aid2)
  local integer BWF=GetUnitAbilityLevel(JK9,aid3)
  local integer BXF=GetUnitAbilityLevel(JK9,aid4)
  local integer BYF=GetUnitAbilityLevel(JK9,'A0NR')
  local integer BZF=GetUnitAbilityLevel(JK9,aid5)
  local integer BAF=GetUnitAbilityLevel(JM9,aid1)
  local integer BBF=GetUnitAbilityLevel(JM9,aid2)
  local integer BCF=GetUnitAbilityLevel(JM9,aid3)
  local integer B3F=GetUnitAbilityLevel(JM9,aid4)
  local integer B6F=GetUnitAbilityLevel(JM9,'A0NR')
  local integer BLF=GetUnitAbilityLevel(JM9,aid5)
  call BSF(JK9,JM9)
  call BRF(JK9,JM9,aid1,BUF,BAF)
  call BRF(JK9,JM9,aid2,BVF,BBF)
  call BRF(JK9,JM9,aid3,BWF,BCF)
  call BRF(JK9,JM9,aid4,BXF,B3F)
  call BRF(JK9,JM9,aid5,BZF,BLF)
  call BRF(JK9,JM9,'A0NR',BYF,B6F)
endfunction

function B1F takes unit JK9,unit JM9 returns nothing
  if JK9!=null and JM9!=null then
    call BTF(JK9,JM9)
  endif
endfunction

function B0F takes nothing returns nothing
  local integer ZWF=GetHandleId((LoadPlayerHandle(HY,(GetHandleId(GetTriggeringTrigger())),(370))))
  local unit JJ9=(LoadUnitHandle(HY,(ZWF),(699)))
  local unit JK9=(LoadUnitHandle(HY,(ZWF),(700)))
  local unit JM9=(LoadUnitHandle(HY,(ZWF),(701)))
  local unit JN9=(LoadUnitHandle(HY,(ZWF),(702)))
  local unit JO9=(LoadUnitHandle(HY,(ZWF),(703)))
  call DisableTrigger(DoubleTroubleTrigger)
  call B1F(JJ9,JK9)
  call B1F(JJ9,JM9)
  call B1F(JJ9,JN9)
  call B1F(JJ9,JO9)
  call B1F(JK9,JM9)
  call B1F(JK9,JN9)
  call B1F(JK9,JO9)
  call B1F(JM9,JN9)
  call B1F(JM9,JO9)
  call B1F(JN9,JO9)
  call EnableTrigger(DoubleTroubleTrigger)
  set JM9=null
  set JN9=null
  set JO9=null
  set JJ9=null
  set JK9=null
endfunction

function B5F takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerAddAction(t,function B0F)
  call SavePlayerHandle(HY,(GetHandleId(t)),(370),(GetOwningPlayer(GetTriggerUnit())))
  set t=null
endfunction

function DividedWeStand_Initialize takes unit Source returns nothing
  local trigger t
  call SaveUnitHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(699),(Source))
  call SaveInteger(HY,(GetHandleId(Source)),(367),(GetHeroXP(Source)))
  call SaveInteger(HY,(GetHandleId(Source)),(368),(0))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddAction(t,function Z1F)
  call SavePlayerHandle(HY,(GetHandleId(t)),(370),(GetOwningPlayer(Source)))
  call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(371),(t))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.3,true)
  call TriggerAddAction(t,function ZUF)
  call SavePlayerHandle(HY,(GetHandleId(t)),(370),(GetOwningPlayer(Source)))
  call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(372),(t))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerAddAction(t,function B4F)
  call TriggerAddCondition(t,Condition(function AYF))
  call SaveTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(369),(t))
  call ExeFunc("B5F")
  set t=null
endfunction

function DividedWeStand_CreateNewClone takes unit Source,boolean CZ9 returns nothing
  local player p=GetOwningPlayer(Source)
  local integer h=GetHandleId(p)
  local unit NewHero
  set dividedwestand_count=dividedwestand_count+1
  if dividedwestand_count==1 then
    call DividedWeStand_Initialize(Source)
    call BJDebugMsg("dividedwestand start")
  endif
  call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(371))))
  call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(Source))),(372))))
  if CZ9==false then
    call DoubleTrouble_LevelAbility(Source,'A0MW')
    call DoubleTrouble_LevelAbility(Source,'A27C')
  endif
  set NewHero=CreateUnit(GetOwningPlayer(Source),'H00J',GetUnitX(Source),GetUnitY(Source),0)
  call BPF(NewHero,Source)
  call AZF(NewHero,Source)
  call SaveUnitHandle(HY,h,(699+dividedwestand_count),(NewHero))
  set p=null
  set NewHero=null
endfunction

function FCD takes nothing returns nothing
  if dividedwestand_usedscepter==false then
    set dividedwestand_usedscepter=true
    call DisableTrigger(DoubleTroubleTrigger)
    call DividedWeStand_CreateNewClone(tt_unit1,true)
    call EnableTrigger(DoubleTroubleTrigger)
  endif
endfunction

function DividedWeStand_Learned takes nothing returns boolean
  local integer i=GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
  local integer aid1=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+1]]
  local integer aid2=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+2]]
  local integer aid3=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+3]]
  local integer aid4=SkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  local integer aid5=AlternateSkillID[PlayerSkillNumber[i*PlayerSkillOffset+4]]
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if IsUnitIllusion(GetTriggerUnit())==false and GetOwningPlayer(GetTriggerUnit())==GetOwningPlayer(Source)then //and ZSF(GetTriggerUnit())then
    if GetLearnedSkill()=='A0MW' or GetLearnedSkill()=='A27C' then //Divided We Stand is leveled
      call DisableTrigger(GetTriggeringTrigger())
      call DividedWeStand_CreateNewClone(GetTriggerUnit(),false)
      call EnableTrigger(GetTriggeringTrigger())
    elseif GetLearnedSkill()=='A0NR' or GetLearnedSkill()==aid1 or GetLearnedSkill()==aid2 or GetLearnedSkill()==aid3 or GetLearnedSkill()==aid4 or GetLearnedSkill()==aid5 then
      call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(GetTriggerUnit()))),(371))))
      call TriggerExecute((LoadTriggerHandle(HY,(GetHandleId(GetOwningPlayer(GetTriggerUnit()))),(372))))
      call DisableTrigger(GetTriggeringTrigger())
      call DoubleTrouble_LevelAbility(GetTriggerUnit(),GetLearnedSkill())
      call EnableTrigger(GetTriggeringTrigger())
    endif
  endif
  set Source=null
  set t=null
  return false
endfunction

function Register_DividedWeStand takes nothing returns nothing
  local unit Source=tt_unit1
  local integer h
  set dividedwestand_t=CreateTrigger()
  set DoubleTroubleTrigger=dividedwestand_t
  set h=GetHandleId(dividedwestand_t)
  call TriggerRegisterAnyUnitEvent(dividedwestand_t,EVENT_PLAYER_HERO_SKILL)
  call TriggerAddCondition(dividedwestand_t,Condition(function DividedWeStand_Learned))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
endfunction

function Leshrak_SplitEarth takes nothing returns nothing
  local location l=GetSpellTargetLoc()
  local unit Caster=CreateUnitAtLoc(GetOwningPlayer(GetTriggerUnit()),'e00E',l,0)
  call UnitAddAbility(Caster,'A06W')
  call SetUnitAbilityLevel(Caster,'A06W',GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  if IssuePointOrderLoc(Caster,"dreadlordinferno",l)==false then
    call IssuePointOrderLoc(Caster,"inferno",l)
  endif
  call ZD8("Abilities\\Spells\\Orc\\EarthQuake\\EarthQuakeTarget.mdl",GetLocationX(l),GetLocationY(l),2)
  call TerrainDeformationRippleBJ(.3,false,l,0,300,100,.4,20)
  call RemoveLocation(l)
  set l=null
  set Caster=null
endfunction

function Leshrak_LightningsFindClosest takes nothing returns nothing
  if DistanceBetweenUnits(tt_unit1,GetEnumUnit())<Lesh_TempReal then
    set Lesh_TempUnit=GetEnumUnit()
    set Lesh_TempReal=DistanceBetweenUnits(tt_unit1,Lesh_TempUnit)
  endif
endfunction

function Leshrak_LightningsFilter takes nothing returns boolean
  return(IsMagicImmune(GetFilterUnit())==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null
endfunction

function Lesh_LightningsRemoveSlow takes nothing returns nothing
  local timer t=GetExpiredTimer()
  call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'A34I')
  call UnitRemoveAbility(LoadUnitHandle(HY,GetHandleId(t),0),'B0H8')
  call CleanTimer(t)
  set t=null
endfunction

function Lesh_LightningsApplySlow takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.75,false,function Lesh_LightningsRemoveSlow)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call UnitAddAbility2(u,'A34I')
  set t=null
endfunction

function Leshrak_LightningsJumps takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local group g=LoadGroupHandle(HY,h,2)
  local group gg=GetAvailableGroup()
  set tt_unit1=caster
  call GroupEnumUnitsInRange(gg,GetUnitX(target),GetUnitY(target),700,Condition(function Leshrak_LightningsFilter))
  call GroupRemoveGroup(g,gg)
  set Lesh_TempReal=9999
  set Lesh_TempUnit=null
  set tt_unit1=target
  call ForGroup(gg,function Leshrak_LightningsFindClosest)
  if Lesh_TempUnit==null or LoadInteger(HY,h,1)>=LoadInteger(HY,h,0)+3 then
    call KillGroup(g)
    call CleanTimer(t)
  else
    call SaveUnitHandle(HY,h,1,Lesh_TempUnit)
    call GroupAddUnit(g,Lesh_TempUnit)
    call DamageTarget(caster,Lesh_TempUnit,1,20+60*LoadInteger(HY,h,0))
    call Lesh_LightningsApplySlow(Lesh_TempUnit)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",Lesh_TempUnit,"origin"))
    call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
  endif
  call KillGroup(gg)
  set caster=null
  set target=null
  set gg=null
  set g=null
  set t=null
endfunction

function Leshrak_LightningsAct takes unit caster, unit target returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local integer lvl=GetUnitAbilityLevel(caster,'A06V')
  call DamageTarget(caster,target,1,20+60*lvl)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",target,"origin"))
  call TimerStart(t,0.25,true,function Leshrak_LightningsJumps)
  call SaveUnitHandle(HY,h,0,caster)
  call SaveUnitHandle(HY,h,1,target)
  call SaveGroupHandle(HY,h,2,GetAvailableGroup())
  call GroupAddUnit(LoadGroupHandle(HY,h,2),target)
  call Lesh_LightningsApplySlow(target)
  call SaveInteger(HY,h,0,lvl)
  call SaveInteger(HY,h,1,0)
  set t=null
endfunction

function Leshrak_Lightnings takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Leshrak_LightningsAct(GetTriggerUnit(),GetSpellTargetUnit())
  endif
endfunction

function CDF takes nothing returns boolean
  return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'Avul')==0
endfunction

function CEF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=(LoadInteger(HY,h,5))
  local group g
  local unit u
  local real d
  local real a
  local real x
  local real y
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  if GetTriggerEvalCount(t)>40 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Hero
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),500,Condition(function CDF))
    set u=GroupPickRandomUnit(g)
    if u==null then
      set d=GetRandomReal(175,400)
      set a=GetRandomReal(0,6)
      set x=GetUnitX(Hero)+d*Cos(a)
      set y=GetUnitY(Hero)+d*Sin(a)
      call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\SteamTank\\SteamTankImpact.mdl",x,y))
    else
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SteamTank\\SteamTankImpact.mdl",u,"origin"))
      call DamageTarget(Caster,u,5,12.5*Level)
    endif
    call KillGroup(g)
  endif
  set u=null
  set g=null
  set t=null
  set Hero=null
  set Caster=null
  return false
endfunction

function Leshrak_DiabolicEdict takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  if GetUnitTypeId(Hero)=='e00E' then
    set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\RocketMissile\\RocketMissile.mdl",Hero,"hand right"))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A20T')))
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function CEF))
  set t=null
  set Hero=null
  set Caster=null
endfunction

function CHF takes nothing returns nothing
  local unit Source=JN8
  local unit Target=GetEnumUnit()
  call DamageTarget(Source,Target,1,JO8)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",Target,"origin"))
  set Source=null
  set Target=null
endfunction

function CIF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=GetUnitAbilityLevel(Source,'A21F')
  local group g
  local boolean b=GetUnitAbilityLevel(Source,'A21G')>0
  if not b then
    set JO8=70+30*Level
  else
    set Level=GetUnitAbilityLevel(Source,'A21G')
    set JO8=130+30*Level
  endif
  if GetTriggerEvalCount(t)==1 then
    call UnitAddAbility2(Source,'A345')
    if b then
      call SetUnitAbilityLevel(Source,'A345',2)
    endif
  endif
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or GetUnitState(Source,UNIT_STATE_MANA)<20*Level or(LoadInteger(HY,(GetHandleId(Source)),(704)))==-1 or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and(GetSpellAbilityId()=='A21H' or GetSpellAbilityId()=='A27H' or GetSpellAbilityId()=='A30J'))then
    if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))=='A21F' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21F',true)
    endif
    if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))=='A21G' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21G',true)
    endif
    call UnitRemoveAbility(Source,'A345')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21H',false)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
    
    
    call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)-20*Level)
    set tt_unit1=Source
    set JN8=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),475,Condition(function DefaultEnemyFilter))
    
    call ForGroup(g,function CHF)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Leshrak_PulseNova takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",Source,"origin"))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21F',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21G',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A21H',true)
  call UnitAddAbility2(Source,'A21H')
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function CIF))
  call SaveUnitHandle(HY,h,2,(Source))
  call TriggerEvaluate(t)
  set Source=null
  set t=null
endfunction

function CMF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit YSE=(LoadUnitHandle(HY,h,(374)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer CNF=(LoadInteger(HY,h,(233)))
  local integer RHE=(LoadInteger(HY,h,(12)))
  local unit Caster
  local group g
  local real a
  local real x
  local real y
  local integer D09=(LoadInteger(HY,h,(720)))
  if D09>0 then
    set D09=D09-1
    call SaveInteger(HY,h,(720),(D09))
    set Source=null
    set t=null
    set Target=null
    set YSE=null
    return false
  endif
  if DistanceBetweenXY(GetUnitX(YSE),GetUnitY(YSE),GetUnitX(Target),GetUnitY(Target))>20 then
    set a=AngleBetweenXY(GetUnitX(YSE),GetUnitY(YSE),GetUnitX(Target),GetUnitY(Target))
    call SetUnitFacing(YSE,a)
    set x=GetUnitX(YSE)+13.5*Cos(a*bj_DEGTORAD)
    set y=GetUnitY(YSE)+13.5*Sin(a*bj_DEGTORAD)
    call SetUnitX(YSE,x)
    call SetUnitY(YSE,y)
  else
    if IsDead(Target)==false then
      set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
      call UnitAddAbility2(Caster,'A091')
      call SetUnitAbilityLevel(Caster,'A091',Level)
      call IssueTargetOrderById(Caster,852226,Target)
    endif
    if CNF>RHE then
      call RemoveUnit(YSE)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      set g=GetAvailableGroup()
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),600,Condition(function LT8))
      call GroupRemoveUnit(g,Target)
      set Target=GroupPickRandomUnit(g)
      call KillGroup(g)
      if Target==null then
        call RemoveUnit(YSE)
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      else
        call SaveInteger(HY,h,(720),(10))
        call SaveInteger(HY,h,(233),(CNF+1))
        call SaveUnitHandle(HY,h,17,(Target))
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set YSE=null
  set Caster=null
  set g=null
  return false
endfunction

function Lich_ChainFrost takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A05T')
  local integer RHE=10
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit YSE
  if GetSpellAbilityId()=='A08H' then
    set Level=GetUnitAbilityLevel(Source,'A08H')+1
    set RHE=99999
  endif
  set YSE=CreateUnit(GetOwningPlayer(Source),'e009',GetUnitX(Source),GetUnitY(Source),0)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(374),(YSE))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(233),(1))
  call SaveInteger(HY,h,(12),(RHE))
  call SaveInteger(HY,h,(720),(0))
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function CMF))
  set Source=null
  set Target=null
  set YSE=null
  set t=null
endfunction

function QID takes unit u,integer d returns nothing
  local texttag t=CreateTextTag()
  call SetTextTagText(t,"+"+I2S(d)+" "+GetObjectName('n0LQ'),.03)
  call SetTextTagPosUnit(t,u,0)
  call SetTextTagColorBJ(t,50,75,255,15)
  call SetTextTagVelocity(t,0,.035)
  call SetTextTagFadepoint(t,3)
  call SetTextTagLifespan(t,2.5)
  call SetTextTagPermanent(t,false)
  call SetTextTagVisibility(t,IsUnitVisible(u,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
  set t=null
endfunction

function Lich_DarkRitual_Delayed takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local real mp=LoadReal(HY,h,0)
  call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+mp)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set u=null
endfunction

function QJD takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t
  local integer h
  if GetUnitTypeId(Source)=='e00C' then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  if GetWidgetLife(Source)>1 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function Lich_DarkRitual_Delayed))
    call SaveUnitHandle(HY,h,0,Source)
    call SaveReal(HY,h,0,GetWidgetLife(Target)*(GetUnitAbilityLevel(Source,'A053')*(.15)+0.1))
    call QID(Target,R2I(GetWidgetLife(Target)*(GetUnitAbilityLevel(Source,'A053')*(.15)+0.1)))
    set SacrificedByLich=true
    call DamageTarget(Source,Target,1,99999)
    call DamageTarget(Source,Target,2,99999)
    call DamageTarget(Source,Target,3,99999)
    set t=null
  endif
  set Source=null
  set Target=null
endfunction

function Lich_DarkRitual takes nothing returns nothing
  if IsCourier(GetSpellTargetUnit())==false then
    call QJD()
  endif
endfunction

function Lich_FrostNove_Remove takes nothing returns nothing 
  call RestoreTint(GetEnumUnit())
  call UnitRemoveAbility(GetEnumUnit(),'A30B')
  call UnitRemoveAbility(GetEnumUnit(),'B30A')
endfunction

function Lich_FrostNova_End takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=LoadGroupHandle(HY,h,1)
  call ForGroup(g,function Lich_FrostNove_Remove)
  call GroupClear(g)
  call DestroyGroup(g)
  set g=null
  set t=null
endfunction

function Lich_FrostNova_Targets takes nothing returns boolean 
  return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(TEMPUNIT))==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(GetFilterUnit())==false
endfunction

function Lich_FrostNova_Group takes nothing returns nothing
  local unit u=GetEnumUnit()
  local integer lvl=tt_int1
  call DamageTarget(TEMPUNIT,u,1,50+25*lvl)
  call UnitAddAbility2(u,'A30B')
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A30B',false)
  call UnitMakeAbilityPermanent(u,true,'A30A')
  call ApplyFrostColor(u)
  set u=null
endfunction

function Lich_FrostNova_Act takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=CreateGroup()
  call TriggerRegisterTimerEvent(t,4,false)
  call TriggerAddCondition(t,Condition(function Lich_FrostNova_End))
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call DamageTarget(u,target,1,50*GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl",target,"origin"))
  set TEMPUNIT=u
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),225,Condition(function Lich_FrostNova_Targets))
  call GroupAddUnit(g,target)
  set TEMPUNIT=u
  set tt_int1=GetUnitAbilityLevel(u,'A07F')
  call ForGroup(g,function Lich_FrostNova_Group)
  call SaveGroupHandle(HY,h,1,g)
  set g=null
  set target=null
  set u=null
  set t=null
endfunction

function Lich_FrostNova_Start takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Lich_FrostNova_Act()
  endif
endfunction

function Lich_FrostArmor_Remove takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  if IsDead(u)==false then
    call UnitRemoveAbility(u,'A309')
    call UnitRemoveAbility(u,'B308')
  endif
  if GetUnitAbilityLevel(u,'B308')==0 then
    call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),1))
    call SaveBoolean(HY,GetHandleId(u),1991,false)
    call RemoveSavedHandle(HY,GetHandleId(u),1991)
    call FlushChildHashtable(HY,GetHandleId(t))
    call DestroyTimer(t)
  else
    call TimerStart(t,1,true,function Lich_FrostArmor_Remove)
  endif
  set t=null
  set u=null
endfunction

function Lich_FrostArmor_RangedAttack takes unit u, unit t returns nothing
  local timer tt
  if IsMagicImmune(u)==false then
    call UnitAddAbility2(u,'A309')
    call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A309',false)
    call UnitMakeAbilityPermanent(u,true,'A308')
    if(LoadBoolean(HY,GetHandleId(u),1991))then
      set tt=LoadTimerHandle(HY,GetHandleId(u),1991)
      call TimerStart(tt,2,false,function Lich_FrostArmor_Remove)
    else
      set tt=CreateTimer()
      call TimerStart(tt,2,false,function Lich_FrostArmor_Remove)
      call SaveUnitHandle(HY,GetHandleId(tt),0,u)
      call SaveBoolean(HY,GetHandleId(u),1991,true)
      call SaveTimerHandle(HY,GetHandleId(u),1991,tt)
      call SaveEffectHandle(HY,GetHandleId(tt),1,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FrostArmor\\FrostArmorDamage.mdl",u,"origin"))
    endif
    set tt=null
  endif
endfunction

function Lion_Impale takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real a
  local real x2
  local real y2
  local integer Level=GetUnitAbilityLevel(Hero,'A0X5')
  local real Damage
  local real DP9
  local unit D09=null
  if GetSpellTargetUnit()!=null then
    set x2=GetUnitX(GetSpellTargetUnit())
    set y2=GetUnitY(GetSpellTargetUnit())
  else
    set x2=GetSpellTargetX()
    set y2=GetSpellTargetY()
  endif
  set a=Atan2(y2-y1,x2-x1)
  set x2=x1+700*Cos(a)
  set y2=y1+700*Sin(a)
  if Level==1 then
    set Damage=60
    set DP9=.5
  elseif Level==2 then
    set Damage=130
    set DP9=1
  elseif Level==3 then
    set Damage=200
    set DP9=1.5
  elseif Level==4 then
    set Damage=260
    set DP9=2
  endif
  if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
    set D09=GetSpellTargetUnit()
  endif
  call ImpaleFactory(Hero,D09,Damage,DP9,.52,x1,y1,x2,y2,150,null,true,1600)
  set Hero=null
  set D09=null
endfunction


function Lion_FingerOfDeath_SplashAct takes nothing returns nothing
  local real dmg=475+125*GetUnitAbilityLevel(Lion_Finger_TempUnit,'A09W')
  call DamageTarget(Lion_Finger_TempUnit,GetEnumUnit(),1,dmg)
endfunction

function Lion_FingerOfDeath_Splash_Delayed takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local integer lvl=LoadInteger(HY,h,0)
  local group g=GetAvailableGroup()
  set tt_unit1=caster
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),200+25,Condition(function NonImmuneEnemyFilter))
  call GroupRemoveUnit(g,target)
  if FirstOfGroup(g)!=null then
    set Lion_Finger_TempUnit=caster
    call ForGroup(g,function Lion_FingerOfDeath_SplashAct)
  endif
  call KillGroup(g)
  call CleanTimer(t)
  set t=null
  set g=null
  set target=null
  set caster=null
endfunction

function Lion_FingerOfDeath_Splash takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,.25,false,function Lion_FingerOfDeath_Splash_Delayed)
  call SaveUnitHandle(HY,h,0,GetTriggerUnit())
  call SaveUnitHandle(HY,h,1,GetSpellTargetUnit())
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  set t=null
endfunction

function Lion_Finger_OnCast takes nothing returns nothing
  if IsMagicImmune(GetSpellTargetUnit())then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LR'))
  endif
endfunction

function Lycan_Shapeshift_Crit_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if GetUnitAbilityLevel(t,'A04R')==0 and GetUnitAbilityLevel(t,'Aloc')==0then
    if LoadBoolean(MHT,99999,99996)then
      call UnitRemoveAbility(t,'A521')
    else
      call UnitAddAbility2(t,'A521')
      call UnitMakeAbilityPermanent(t,true,'A03B')
    endif
  endif
  set t = null
  return false
endfunction

function Lycan_Shapeshift_Crit takes player p, boolean b returns nothing
  call SaveBoolean(MHT,99999,99996,b)
  call GroupEnumUnitsOfPlayer(temp_group,p,Condition(function Lycan_Shapeshift_Crit_Targets))
  call RemoveSavedBoolean(MHT,99999,99996)
endfunction

function CTF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  call Lycan_Shapeshift_Crit(GetOwningPlayer(Hero),true)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
  call UnitRemoveAbility(Hero,'A0ZC')
  call UnitRemoveAbility(Hero,'B00V')
  call UnitRemoveAbility(Hero,'A521')
  call RestoreTint(Hero)
  call SetTint(Hero,-1,-1,-1,255)
  call RemoveUnit(LoadUnitHandle(HY,h,15))
  call CustomSpeed(Hero,0,0)
  call ManageBonusHP(Hero,-1 * LoadInteger(HY,h,16))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function CUF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit d = LoadUnitHandle(HY,h,15)
  local integer bonus=LoadInteger(HY,h,16)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosDone.mdl",Hero,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",Hero,"origin"))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,18-.1,false)
  call TriggerRegisterDeathEvent(t,Hero)
  call TriggerAddCondition(t,Condition(function CTF))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,15,d)
  call SaveInteger(HY,h,16,bonus)
  call CustomSpeed(Hero,999,650)
  call Lycan_Shapeshift_Crit(GetOwningPlayer(Hero),false)
  set d = null
  set t=null
  set Hero=null
  return false
endfunction

function CVF takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',0,0,0)
  local real DP9=18
  local real hp=GetWidgetLife(Hero)
  local real bon=100*GetUnitAbilityLevel(Hero,GetSpellAbilityId())
  call ManageBonusHP(Hero,R2I(bon))
  call SaveInteger(HY,h,16,R2I(bon))
  call SetWidgetLife(Hero,hp+bon)
  call UnitAddAbility2(Caster,'A0ZC')
  call UnitApplyTimedLife(Caster,'BTLF',DP9)
  //call C78(Hero,DP9,175)
  call SetTint(Hero,255,100,255,175)
  call TriggerRegisterTimerEvent(t,.1,false)
  call TriggerAddCondition(t,Condition(function CUF))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,15,Caster)
  set t=null
  set Hero=null
  set Caster=null
endfunction

function Lycan_Shapeshift takes nothing returns nothing
  if GetUnitTypeId(GetTriggerUnit())!='E015' then
    call CVF()
  endif
endfunction

function Lycan_SpiritWolves takes nothing returns nothing
  call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A03B',true)
endfunction


function YOD takes nothing returns nothing
  local unit Source=IM
  local unit Target=AM
  local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Source)),(219)))
  call SaveUnitHandle(HY,(GetHandleId(Source)),(219),(Caster))
  call SetUnitOwner(Caster,GetOwningPlayer(Target),true)
  set Source=null
  set Target=null
  set Caster=null
endfunction

function YD9 takes nothing returns nothing
  local unit Hero=VK
  local unit Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),(219)))
  if Caster!=null and GetUnitTypeId(Caster)=='e01V' then
    call RemoveUnit(Caster)
  endif
  set Hero=null
  set Caster=null
endfunction

function CXF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  if Caster!=null and GetUnitTypeId(Caster)=='e01V' then
    if IsDead(Source)==false then
      call SetUnitX(Caster,GetUnitX(Source))
      call SetUnitY(Caster,GetUnitY(Source))
    endif
  endif
  set t=null
  set Caster=null
  set Source=null
  return false
endfunction

function Lycan_FeralImpulse_Leveling takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A03E')+GetUnitAbilityLevel(Hero,'QP0Q')
  local unit Caster
  local trigger t
  local integer h
  if Level==1 then
    set Caster=CreateUnit(GetOwningPlayer(Hero),'e01V',0,0,0)
    call UnitAddAbility2(Caster,'A0ZJ')
    call SaveUnitHandle(HY,(GetHandleId(Hero)),(219),(Caster))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerAddCondition(t,Condition(function CXF))
    call TriggerRegisterTimerEvent(t,.2,true)
    call SaveUnitHandle(HY,h,2,(Hero))
    call SaveUnitHandle(HY,h,(19),(Caster))
    set t=null
  else
    set Caster=(LoadUnitHandle(HY,(GetHandleId(Hero)),(219)))
  endif
  if Level==2 then
    call UnitRemoveAbility(Caster,'A0ZJ')
    call UnitAddAbility2(Caster,'A0ZI')
    call UnitRemoveAbility(Hero,'B09B')
  elseif Level==3 then
    call UnitRemoveAbility(Caster,'A0ZJ')
    call UnitRemoveAbility(Caster,'A0ZI')
    call UnitRemoveAbility(Hero,'B09A')
    call UnitRemoveAbility(Hero,'B09B')
    call UnitAddAbility2(Caster,'A0ZH')
  elseif Level==4 then
    call UnitRemoveAbility(Caster,'A0ZJ')
    call UnitRemoveAbility(Caster,'A0ZI')
    call UnitRemoveAbility(Caster,'A0ZH')
    call UnitRemoveAbility(Hero,'B097')
    call UnitRemoveAbility(Hero,'B09A')
    call UnitRemoveAbility(Hero,'B09B')
    call UnitAddAbility2(Caster,'A0ZG')
  endif
  set Hero=null
  set Caster=null
endfunction

function Lycan_Howl takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster
  local integer i=1
  local player p
  local integer id1
  local integer id2
  local integer Level=GetUnitAbilityLevel(Hero,'A0ZF')
  if Level==1 then
    set id1='A104'
    set id2='A107'
  elseif Level==2 then
    set id1='A101'
    set id2='A106'
  elseif Level==3 then
    set id1='A102'
    set id2='A105'
  elseif Level==4 then
    set id1='A103'
    set id2='A108'
  endif
  loop
    exitwhen i>5
    if IsSentinel(GetOwningPlayer(Hero)) then
      set p=Sentinels[i]
    else
      set p=Scourges[i]
    endif
    set Caster=CreateUnit(p,'e01V',0,0,0)
    call UnitAddAbility2(Caster,id1)
    call UnitAddAbility2(Caster,id2)
    call UnitApplyTimedLife(Caster,'BTLF',10)
    set i=i+1
  endloop
  set Hero=null
  set Caster=null
  set p=null
endfunction

function Doom_LvlDeath takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer CLF=GetHeroLevel(Target)
  
  if IsUnitType(Source,UNIT_TYPE_HERO) and (ModuloInteger(CLF,7-GetUnitAbilityLevel(Source,'A094'))==0 or CLF==25) then
    call DamageTarget(Source,Target,1,GetUnitState(Target,UNIT_STATE_MAX_LIFE)*.2)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\DemonBoltImpact\\DemonBoltImpact.mdl",Target,"chest"))
  endif
  
  set Source=null
  set Target=null
endfunction

function BasicDoomDmgPer takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit doom=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  if GetUnitAbilityLevel(target,'A464')==0 or IsDead(target) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  else
    call DamageTarget(doom,target,9,LoadReal(HY,h,0))
  endif
  if LoadBoolean(HY,h,0)then
    call RemoveSavedBoolean(HY,h,0)
    call TimerStart(t,1,true,function BasicDoomDmgPer)
  endif
  set doom=null
  set target=null
  set t=null
endfunction

function BasicDoomDmg takes unit u, unit target returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,0,false,function BasicDoomDmgPer)
  call SaveUnitHandle(HY,h,0,u)
  call SaveUnitHandle(HY,h,1,target)
  call SaveReal(HY,h,0,GetUnitAbilityLevel(u,'A0MU')*15.+5.)
  call SaveBoolean(HY,h,0,true)
  set t=null
endfunction

function BasicDoom takes nothing returns nothing
  local unit doom=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit d
  if IsUnitType(target,UNIT_TYPE_HERO)then
    call UnitAddAbilityTimedExF(target,'A464',1,15,'B464')
    call STFU(target,'B464',15)
    call BasicDoomDmg(doom,target)
  else
    set d=CreateUnit(GetOwningPlayer(doom),'e00E',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(d,'A465')
    call SetUnitAbilityLevel(d,'A465',GetUnitAbilityLevel(doom,'A0MU'))
    call IssueTargetOrder(d,"doom",target)
    set d=null
  endif
  set doom=null
  set target=null
  set d=null
endfunction

function Doom_DoomCast takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call RemovePositiveBuffs(GetSpellTargetUnit())
    call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
    call BasicDoom()
  endif
endfunction

function Devour_Refresh_Wrap takes nothing returns nothing
  local unit u=tt_unit1
  local integer hu=GetHandleId(u)
  local integer id1=LoadInteger(HeroStats,hu,'DEVR'+0)
  local integer id2=LoadInteger(HeroStats,hu,'DEVR'+1)
  local boolean isbook1=LoadBoolean(HeroStats,hu,'DEVR'+0)
  local boolean isbook2=LoadBoolean(HeroStats,hu,'DEVR'+1)
  if isbook1==false then
    call UnitRemoveAbility(u,id1)
    call UnitAddAbility2(u,id1)
  endif
  if isbook2==false then
    call UnitRemoveAbility(u,id2)
    call UnitAddAbility2(u,id2)
  endif
  set u=null
endfunction

function Devour_Clear takes unit u returns nothing
  call UnitRemoveAbility(u,LoadInteger(HeroStats,GetHandleId(u),'DEVR'+0))
  call UnitRemoveAbility(u,LoadInteger(HeroStats,GetHandleId(u),'DEVR'+1))
  call RemoveSavedInteger(HeroStats,GetHandleId(u),'DEVR'+0)
  call RemoveSavedInteger(HeroStats,GetHandleId(u),'DEVR'+1)
  call RemoveSavedBoolean(HeroStats,GetHandleId(u),'DEVR'+0)
  call RemoveSavedBoolean(HeroStats,GetHandleId(u),'DEVR'+1)
endfunction

function C5F takes unit u,integer uid returns nothing
  local integer id1=0
  local integer id2=0
  local boolean isbook1=false
  local boolean isbook2=false
  local integer subskill1=0
  local integer subskill2=0
  local integer hu=GetHandleId(u)
  if uid=='n0HX' then
    set id1='A1OQ'
  elseif uid=='nomg' then
    set id1='A1OR'
  elseif uid=='nfpu' then
    set id1='A1OS'
    set id2='QDP3'
    set isbook2=true
    set subskill2='S00N'
  elseif uid=='nstl' then
    set id1='A1OT'
  elseif uid=='nsat' then
    set id1='A1OU'
  elseif uid=='nsth' then//big satyr
    set id1='A1OV'
    set id2='QDP0'
    set isbook2=true
    set subskill2='A1OW'
  elseif uid=='n00S' then
    set id1='QDP6'
    set subskill1='A1OX'
    set isbook1=true
    set subskill2='A1OY'
  elseif uid=='nkol' then
    set id1='QDP1'
    set subskill1='S00M'
    set isbook1=true
  elseif uid=='nfsh' then
    set id1='A1OZ'
    set id2='QDP2'
    set subskill2='A2AG'
    set isbook2=true
  elseif uid=='ncnk' then
    set id1='A1P0'
  elseif uid=='ngns' then
    set id1='QDP4'
    set subskill1='A1P1'
    set isbook1=true
  elseif uid=='ngh1' then
    set id1='QDP7'
    set subskill1='A1P7'
    set isbook1=true
    set subskill2='A1PA'
  elseif uid=='nowe' then
    set id1='QDP5'
    set subskill1='A1P3'
    set isbook1=true
    set id2='A1P4'
  elseif uid=='ndtw' then
    set id1='A1P5'
    set id2='A1P6'
  elseif uid=='nwlg' then
    set id1='QDP8'
    set subskill1='A1OY'
    set isbook1=true
  endif
  if id1!=0 and (LoadInteger(HeroStats,hu,'DEVR'+0)!=id1 or LoadInteger(HeroStats,hu,'DEVR'+1)!=id2) then
    call Devour_Clear(u)
    call UnitAddAbility2(u,id1)
    if isbook1 then
      call SetPlayerAbilityAvailable(GetOwningPlayer(u),id1,false)
      call UnitMakeAbilityPermanent(u,true,subskill1)
      call UnitMakeAbilityPermanent(u,true,subskill2)
    endif
    if id2!=0 then
      call UnitAddAbility2(u,id2)
      if isbook2 then
        call SetPlayerAbilityAvailable(GetOwningPlayer(u),id2,false)
        call UnitMakeAbilityPermanent(u,true,subskill1)
        call UnitMakeAbilityPermanent(u,true,subskill2)
      endif
    endif
    call SaveInteger(HeroStats,hu,'DEVR'+0,id1)
    call SaveBoolean(HeroStats,hu,'DEVR'+0,isbook1)
    call SaveInteger(HeroStats,hu,'DEVR'+1,id2)
    call SaveBoolean(HeroStats,hu,'DEVR'+1,isbook2)
  endif
endfunction

function L8F takes real r returns string
  local string c1="|c00ff0303"
  local string c="||"
  local string p=" "
  local string s=c1+c+"|r"
  local string result
  if r>85 then
    set result=s+p+s+p+s+p+s+p+s+p+s+p+s
  elseif r>70 then
    set result=s+p+s+p+s+p+s+p+s+p+s+p+c
  elseif r>55 then
    set result=s+p+s+p+s+p+s+p+s+p+c+p+c
  elseif r>40 then
    set result=s+p+s+p+s+p+s+p+c+p+c+p+c
  elseif r>25 then
    set result=s+p+s+p+s+p+c+p+c+p+c+p+c
  elseif r>10 then
    set result=s+p+s+p+c+p+c+p+c+p+c+p+c
  elseif r>0 then
    set result=s+p+c+p+c+p+c+p+c+p+c+p+c
  else
    set result=c+p+c+p+c+p+c+p+c+p+c+p+c
  endif
  return result
endfunction

function LDF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=(LoadInteger(HY,h,5))
  local real HP=(LoadReal(HY,h,(232)))
  local texttag tt=(LoadTextTagHandle(HY,h,(231)))
  local integer Count=GetTriggerEvalCount(t)
  local real LFF=RMaxIF(HP-Count,0)
  call SetTextTagText(tt,L8F(100*LFF/ HP),.018)
  call SetTextTagPosUnit(tt,Hero,0)
  call SetTextTagVisibility(tt,IsUnitVisible(Hero,GetLocalPlayer()) or IsObserver(GetLocalPlayer()))
  if LFF==0 then
    call ImitateBountyGain(GetOwningPlayer(Hero),Hero,25*Level)
  endif
  if LFF==0 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A10R',true)
    call UnitRemoveAbility(Hero,'A10S')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call DestroyTextTag(tt)
  endif
  set t=null
  set Hero=null
  set tt=null
  return false
endfunction

function Doom_Devour takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A10R')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real HP=GetWidgetLife(Target)
  local texttag tt=CreateTextTag()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',0,0,0)
  call ZO8("SPLK",GetUnitX(Hero),GetUnitY(Hero),GetUnitX(Target),GetUnitY(Target),.1,.1,.2,.9,.5)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\Devour\\DevourEffectArt.mdl",GetUnitX(Target),GetUnitY(Target)))
  call SetTextTagText(tt,L8F(100),.018)
  call SetTextTagPosUnit(tt,Hero,0)
  call SetTextTagVisibility(tt,IsUnitVisible(Hero,GetLocalPlayer()))
  call SetTextTagPermanent(tt,true)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Hero),'A10R',false)
  call UnitAddAbility2(Hero,'A10S')
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveTextTagHandle(HY,h,(231),(tt))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(232),((HP)*1.))
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function LDF))
  call C5F(Hero,GetUnitTypeId(Target))
  call ShowUnit(Target,false)
  call UnitRemoveBuffs(Target,true,true)
  call UnitRemoveAbility(Target,'Aetl')
  call DamageTarget(Caster,Target,4,100000000)
  set t=null
  set Hero=null
  set Target=null
  set tt=null
  set Caster=null
endfunction

function Doom_Devour_Leveling takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A10R')
  call SetUnitAbilityLevel(GetTriggerUnit(),'A10R',GetUnitAbilityLevel(GetTriggerUnit(),'A32Z'))
endfunction

function LNF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=LoadInteger(HY,h,3)
  local integer bookabil
  local integer fireabil
  local integer regenabil
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if Level==1 then
      set fireabil='A1OE'
      set regenabil='A1OJ'
    elseif Level==2 then
      set fireabil='A1OF'
      set regenabil='A1OH'
    elseif Level==3 then
      set fireabil='A1OG'
      set regenabil='A1OK'
    elseif Level==4 then
      set fireabil='A1OD'
      set regenabil='A1OF'
    endif
    call SetUnitAbilityLevel(Source,fireabil,1)
    call UnitMakeAbilityPermanent(Source,true,fireabil)
    call SetUnitAbilityLevel(Source,regenabil,1)
    call UnitMakeAbilityPermanent(Source,true,regenabil)
  else
    if LoadInteger(HY,h,0)<1 then
      call UnitRemoveAbility(Source,'A1OL')
      call UnitRemoveAbility(Source,'A1ON')
      call UnitRemoveAbility(Source,'A1OO')
      call UnitRemoveAbility(Source,'A1OM')
      call UnitRemoveAbility(Source,'B04J')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call RemoveSavedHandle(HY,GetHandleId(Source),'SCRD')
    else
      call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function Doom_ScorchedEarth takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(Source,'A1OP')
  local integer aid=0
  local integer subaid1=0
  local integer subaid2=0
  if Level==1 then
    set aid='A1OL'
    set subaid1='A1OE'
    set subaid2='A1OJ'
  elseif Level==2 then
    set aid='A1ON'
    set subaid1='A1OF'
    set subaid2='A1OH'
  elseif Level==3 then
    set aid='A1OO'
    set subaid1='A1OG'
    set subaid2='A1OK'
  elseif Level==4 then
    set aid='A1OM'
    set subaid1='A1OD'
    set subaid2='A0FF'
  endif
  if HaveSavedHandle(HY,GetHandleId(Source),'SCRD') then
    set t=LoadTriggerHandle(HY,GetHandleId(Source),'SCRD')
    set h=GetHandleId(t)
    call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
    if LoadInteger(HY,h,3)!=Level then
      call UnitRemoveAbility(Source,'A1OL')
      call UnitRemoveAbility(Source,'A1ON')
      call UnitRemoveAbility(Source,'A1OO')
      call UnitRemoveAbility(Source,'A1OM')
      call UnitRemoveAbility(Source,'B04J')
      call SaveInteger(HY,h,3,Level)
    endif
    call TriggerRegisterTimerEvent(t,6+2*Level,false)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,6+2*Level,false)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(t,Condition(function LNF))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveInteger(HY,h,3,Level)
    call SaveTriggerHandle(HY,GetHandleId(Source),'SCRD',t)
  endif
  call UnitAddAbility2(Source,aid)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),aid,false)
  call UnitMakeAbilityPermanent(Source,true,subaid1)
  call UnitMakeAbilityPermanent(Source,true,subaid2)
  call UnitMakeAbilityPermanent(Source,true,'A33I')
  set Source=null
  set t=null
endfunction

function Doom_AghanimDoom_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit target=LoadUnitHandle(HY,h,17)
  local integer time=LoadInteger(HY,h,34)
  if DistanceBetweenUnits(caster,target)>900 or IsDead(caster)==true then
    set time=time+1
    call SaveInteger(HY,h,34,time)
  endif
  if time>160 then
    call UnitRemoveAbility(target,'BNdo')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetUnitAbilityLevel(target,'BNdo')==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set caster=null
  set target=null
  return false
endfunction

function Doom_AghanimDoom_Act takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(target),GetUnitY(target),0)
  call UnitRemoveAbility(target,'A464')
  call UnitRemoveAbility(target,'B464')
  call UnitRemoveAbility(target,'BNdo')
  //call UnitRemoveBuffs(target,true,false)
  call RemovePositiveBuffs(GetSpellTargetUnit())
  call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call TriggerAddCondition(t,Condition(function Doom_AghanimDoom_Duration))
  call SaveUnitHandle(HY,(h),(2),(u))
  call SaveUnitHandle(HY,(h),(17),(target))
  call SaveInteger(HY,(h),(34),(0))
  call SaveReal(HY,h,5,20+20*GetUnitAbilityLevel(u,'A0A2'))
  call UnitAddAbility(d,'A466')
  call SetUnitAbilityLevel(d,'A466',GetUnitAbilityLevel(u,'A0A2'))
  call IssueTargetOrder(d,"doom",target)
  set d=null
  set u=null
  set target=null
  set t=null
endfunction

function DoomAghActStart takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Doom_AghanimDoom_Act()
  endif
endfunction

//function Doom_AghanimDoom_Act takes nothing returns nothing
//	local unit caster=GetTriggerUnit()
//	local unit target=GetSpellTargetUnit()
//	local trigger t=CreateTrigger()
//	local integer h=GetHandleId(t)
//	call TriggerRegisterTimerEvent(t,0.1,true)
//	call TriggerAddCondition(t,Condition(function Doom_AghanimDoom_Duration))
//	call SaveUnitHandle(HY,h,2,caster)
//	call SaveUnitHandle(HY,h,17,target)
//	call SaveInteger(HY,h,34,0)
//	call RemovePositiveBuffs(GetSpellTargetUnit())
//	call UnitRemoveBuffsEx(GetSpellTargetUnit(),true,false,true,true,false,false,false)
//	set caster=null
//	set target=null
//	set t=null
//endfunction

function LQF takes nothing returns boolean
  local real x
  local real y
  if(IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
    set x=JP8+GetRandomReal(20,70)*Cos(GetUnitFacing(GetTriggerUnit())*bj_DEGTORAD)
    set y=JQ8+GetRandomReal(20,70)*Sin(GetUnitFacing(GetTriggerUnit())*bj_DEGTORAD)
    call SetUnitPosition(GetFilterUnit(),x,y)
  endif
  return false
endfunction

function Magnus_ReversePolarity takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local group g=GetAvailableGroup()
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)
  local integer lvl=GetUnitAbilityLevel(u,'A29L')+GetUnitAbilityLevel(u,'A447')
  local real a=GetUnitFacing(u)
  set JP8=GetUnitX(u)+100*Cos(a*bj_DEGTORAD)
  set JQ8=GetUnitY(u)+100*Sin(a*bj_DEGTORAD)
  call GroupEnumUnitsInRange(g,x,y,410+24,Condition(function LQF))
  call KillGroup(g)
  call UnitAddAbility2(d,'A06F')
  call SetUnitAbilityLevel(d,'A06F',lvl)
  call IssueImmediateOrderById(d,852127)
  if GetUnitAbilityLevel(u,'A447')>0 then
    call UnitAddAbility2(d,'A446')
    call SetUnitAbilityLevel(d,'A446',lvl)
    call IssuePointOrderById(d,852218,x+100*Cos((a+15)*bj_DEGTORAD),y+100*Sin((a+15)*bj_DEGTORAD))
    call IssuePointOrderById(d,852218,x+100*Cos((a-15)*bj_DEGTORAD),y+100*Sin((a-15)*bj_DEGTORAD))
    call IssuePointOrderById(d,852218,x+100*Cos(a*bj_DEGTORAD),y+100*Sin(a*bj_DEGTORAD))
  endif
  set u=null
  set g=null
  set d=null
endfunction

function LTF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetUnitAbilityLevel(Target,'B00U')==0 or GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Target,'A1Q0')
    call UnitRemoveAbility(Target,'A1Q1')
    call UnitRemoveAbility(Target,'A1Q2')
    call UnitRemoveAbility(Target,'A1Q3')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function Magnus_Empower takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A037')
  local integer A38
  local integer realID
  if Level==1 then
    set A38='A1Q0'
    set realID='A1Q0'
  elseif Level==2 then
    set A38='A1Q1'
    set realID='A1PI'
  elseif Level==3 then
    set A38='A1Q2'
    set realID='A1PY'
  elseif Level==4 then
    set A38='A1Q3'
    set realID='A1PX'
  endif
  call UnitRemoveAbility(Target,'A1Q0')
  call UnitRemoveAbility(Target,'A1Q1')
  call UnitRemoveAbility(Target,'A1Q2')
  call UnitRemoveAbility(Target,'A1Q3')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),A38,false)
  call UnitAddAbility2(Target,A38)
  call UnitMakeAbilityPermanent(Target,true,realID)
  call UnitMakeAbilityPermanent(Target,true,'A1PI')
  call UnitMakeAbilityPermanent(Target,true,'A1PX')
  call UnitMakeAbilityPermanent(Target,true,'A1PY')
  call UnitMakeAbilityPermanent(Target,true,'A1PZ')
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function LTF))
  call SaveUnitHandle(HY,h,17,(Target))
  set t=null
  set Source=null
  set Target=null
endfunction

function LWF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  call UnitRemoveAbility(Target,'A1Q6')
  call UnitRemoveAbility(Target,'B0CX')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Target=null
  return false
endfunction

function LXF takes unit Source,unit Target,integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SetUnitPathing(Target,true)
  call TriggerRegisterTimerEvent(t,2.5,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function LWF))
  call SaveUnitHandle(HY,h,17,(Target))
  call UnitAddAbility2(Target,'A1Q6')
  call UnitMakeAbilityPermanent(Target,true,'A1Q6')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A1Q6',false)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\HumanBloodKnight.mdl",Target,"chest"))
  call DamageTarget(Source,Target,1,70*Level)
  set t=null
endfunction

function Magnus_Skewer_Filter takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit())) and IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitInGroup(GetFilterUnit(),TempGroup)==false and(AliveNonBuildOrMarker(GetFilterUnit()))and(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT)==false))!=null
endfunction

function Magnus_Skewer_Moving takes nothing returns nothing
  call SetUnitPosition(GetEnumUnit(),Skewer_x,Skewer_y)
  call SaveBoolean(HeroStats,GetHandleId(GetEnumUnit()),99,true)
  call SetUnitPathing(GetEnumUnit(),false)
endfunction

function Magnus_Skewer_Finish takes nothing returns nothing
  local unit u=GetEnumUnit()
  local location l
  local real x
  local real y
  if IsPointInRegion(RestrictedRegion,GetUnitX(u),GetUnitY(u)) then
    set l=LI8(GetUnitX(u),GetUnitY(u))
    set x=SafeX75(GetLocationX(l))
    set y=SafeY75(GetLocationY(l))
    call SaveBoolean(HeroStats,GetHandleId(u),99,true)
    call SetUnitX(u,x)
    call SetUnitY(u,y)
    call RemoveLocation(l)
    set l=null
  endif
  call LXF(Skewer_Caster,u,Skewer_lvl)
  call KillTrees(x,y,300)
  call SetUnitPathing(u,true)
  set u=null
endfunction

function LYF takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real a=(LoadReal(HY,h,(13)))
  local real NHE=(LoadReal(HY,h,6))
  local real NIE=(LoadReal(HY,h,7))
  local real AO8=SafeX75(NHE+19*Cos(a))
  local real AP8=SafeY75(NIE+19*Sin(a))
  local group g
  local group gg=LoadGroupHandle(HY,h,0)
  local integer L3F=(LoadInteger(HY,h,(12)))
  local location l
  if IsUnitType(Source,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
  endif
  call SetUnitPosition(Source,AO8,AP8)
  call SetUnitFacing(Source,a*bj_RADTODEG)
  call SaveReal(HY,h,6,((AO8)*1.))
  call SaveReal(HY,h,7,((AP8)*1.))
  if ModuloInteger(GetTriggerEvalCount(t),4)==0 then
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",AO8,AP8))
  endif
  if GetTriggerEvalCount(t)==2 then
    call SetUnitAnimationByIndex(Source,3)
  endif
  set g=GetAvailableGroup()
  set tt_unit1=Source
  set TempGroup=gg
  call GroupEnumUnitsInRange(g,AO8,AP8,150+25,Condition(function Magnus_Skewer_Filter))
  if FirstOfGroup(g)!=null then
    call GroupAddGroup(g,gg)
  endif
  call KillGroup(g)
  set Skewer_x=AO8
  set Skewer_y=AP8
  call ForGroup(gg,function Magnus_Skewer_Moving)
  if ModuloInteger(GetTriggerEvalCount(t),3)==0 then
    call KillTrees(AO8,AP8,200)
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>L3F then
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call SetUnitAnimationByIndex(Source,0)
    call SetUnitTimeScale(Source,1.)
    call SetUnitPathing(Source,true)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set Skewer_lvl=Level
    set Skewer_Caster=Source
    call IssueTargetOrderById(Source,851983,FirstOfGroup(gg))
    call ForGroup(gg,function Magnus_Skewer_Finish)
    call KillTrees(AO8,AP8,375)
    if IsPointInRegion(RestrictedRegion,GetUnitX(Source),GetUnitY(Source)) then
      set l=LI8(GetUnitX(Source),GetUnitY(Source))
      if IsUnitType(Source,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
      endif
      call SetUnitX(Source,SafeX75(GetLocationX(l)))
      call SetUnitY(Source,SafeY75(GetLocationY(l)))
      call RemoveLocation(l)
      set l=null
    endif
  endif
  set t=null
  set Source=null
  call KillGroup(gg)
  call KillGroup(g)
  set g=null
  set gg=null
  return false
endfunction

function Magnus_Skewer takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real TargetX=SafeX75(GetSpellTargetX())
  local real TargetY=SafeY75(GetSpellTargetY())
  local unit Source=GetTriggerUnit()
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local integer Level=GetUnitAbilityLevel(Source,'A1RD')
  local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)*bj_DEGTORAD
  local real range = Level*150 + 625
  if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>range then
    set TargetX=SafeX75(SourceX + range*Cos(a))
    set TargetY=SafeY75(SourceY + range*Sin(a))
  endif
  call SetUnitPathing(Source,false)
  call SetUnitAnimationByIndex(Source,3)
  call SetUnitTimeScale(Source,1.5)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function LYF))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,(393),(null))
  call SaveUnitHandle(HY,h,(394),(null))
  call SaveUnitHandle(HY,h,(395),(null))
  call SaveUnitHandle(HY,h,(396),(null))
  call SaveUnitHandle(HY,h,(397),(null))
  call SaveReal(HY,h,(47),((TargetX)*1.))
  call SaveReal(HY,h,(48),((TargetY)*1.))
  call SaveReal(HY,h,6,((SourceX)*1.))
  call SaveReal(HY,h,7,((SourceY)*1.))
  call SaveGroupHandle(HY,h,0,GetAvailableGroup())
  call SaveReal(HY,h,(13),((Atan2(TargetY-SourceY,TargetX-SourceX))*1.))
  call SaveInteger(HY,h,(12),(R2I(DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)/ 19.)))
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("war3mapImported\\SkewerTuskGlow_1.mdx",Source,"head")))
  set t=null
  set Source=null
endfunction

function L0F takes nothing returns boolean
  local real d
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(JS8)) and IsUnitInGroup(GetFilterUnit(),JU8)==false and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(JT8)) then
    set d=DistanceBetweenXY(GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()),GetUnitX(JS8),GetUnitY(JS8))
    if d<JV8 then
      set JR8=GetFilterUnit()
      set JV8=d
    endif
  endif
  return false
endfunction

function L5F takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Level=(LoadInteger(HY,h,5))
  local unit Target=LoadUnitHandle(HY,h,(30))
  local group AlreadyHit=(LoadGroupHandle(HY,h,(187)))
  local real L2F=(LoadReal(HY,h,(222)))
  local real D4G=(LoadReal(HY,h,(223)))
  local real D7G=(LoadReal(HY,h,(224)))
  local real RLD
  local group g
  local real a
  local real x
  local real y
  set a=Atan2(GetUnitY(Target)-GetUnitY(Caster),GetUnitX(Target)-GetUnitX(Caster))
  if Source==Target then
    set x=GetUnitX(Caster)+25*Cos(a)
    set y=GetUnitY(Caster)+25*Sin(a)
  else
    set x=GetUnitX(Caster)+24*Cos(a)
    set y=GetUnitY(Caster)+24*Sin(a)
  endif
  call SetUnitX(Caster,x)
  call SetUnitY(Caster,y)
  if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<60 then
    call SetUnitX(Caster,GetUnitX(Target))
    call SetUnitY(Caster,GetUnitY(Target))
    if Source==Target then
      call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+L2F)
      call KillUnit(Caster)
      call KillGroup(AlreadyHit)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      if IsUnitVisible(Target,GetOwningPlayer(Caster)) then
        if GetUnitAbilityLevel(Target,'A2S5')>0 then //if stoned
          call DamageTarget(Source,Target,3,(40+40*Level)+.25*D7G*(40+40*Level))
        else
          call DamageTarget(Source,Target,1,(40+40*Level)+.25*D7G*(40+40*Level))
        endif
        set D7G=D7G+1
        if GetUnitState(Target,UNIT_STATE_MANA)>0 then
          set RLD=RMinBJ(GetUnitState(Target,UNIT_STATE_MANA),(5+15*Level)+.2*D4G*(5+15*Level))
          call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-RLD)
          call PlaySoundAtPos(NE,GetUnitX(Target),GetUnitY(Target))
          set L2F=L2F+RLD
          set D4G=D4G+1
        endif
      endif
      call SaveReal(HY,h,(222),((L2F)*1.))
      call SaveReal(HY,h,(224),((D7G)*1.))
      call SaveReal(HY,h,(223),((D4G)*1.))
      set g=GetAvailableGroup()
      set JR8=null
      set JS8=Target
      set JU8=AlreadyHit
      set JV8=99999
      set JT8=Source
      call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),500,Condition(function L0F))
      call KillGroup(g)
      if JR8==null or D7G==(2+Level)then
        call SaveUnitHandle(HY,h,(30),((Source)))
      else
        call SaveUnitHandle(HY,h,(30),((JR8)))
        call GroupAddUnit(AlreadyHit,JR8)
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  set g=null
  set AlreadyHit=null
  return false
endfunction

function Medusa_MysticSnake takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0G2')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  local real D7G=0
  local real D4G=0
  local real RLD=0
  local real L2F=0
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'h090',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  call PlaySoundAtPos(ME,GetUnitX(Source),GetUnitY(Source))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function L5F))
  call SaveGroupHandle(HY,h,(187),(g))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(Level))
  call SaveUnitHandle(HY,h,(30),((Target)))
  call SaveInteger(HY,h,(34),(0))
  call SaveReal(HY,h,(222),((L2F)*1.))
  call SaveReal(HY,h,(224),((D7G)*1.))
  call SaveReal(HY,h,(223),((D4G)*1.))
  call GroupAddUnit(g,Target)
  set Source=null
  set Target=null
  set Caster=null
  set t=null
  set g=null
endfunction

function Medusa_SplitShot_Learn takes nothing returns nothing
  
endfunction

function Medusa_SplitShotOff takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer i=GetUnitAbilityLevel(u,'A418')
  call UnitRemoveAbility(u,'A09J')
  call UnitRemoveAbility(u,'A1ER')
  call UnitRemoveAbility(u,'A23F')
  call UnitRemoveAbility(u,'A417')
  call UnitRemoveAbility(u,'A419')
  call SetUnitAbilityLevel(u,'A1C0',i)
  set u=null
endfunction

function Medusa_SplitShot takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A1C0')
  call UnitAddAbility2(u,'A417')
  call SetUnitAbilityLevel(u,'A417',lvl)
  call UnitAddAbility2(u,'A23F')
  call SetUnitAbilityLevel(u,'A09J',lvl)
  call UnitMakeAbilityPermanent(u,true,'A09J')
  call UnitAddAbility2(u,'A1ER')
  call SetUnitAbilityLevel(u,'A1ER',lvl)
  call UnitAddAbility2(u,'A419')
  set u=null
endfunction

function Medusa_StoneGaze_NullTimers takes nothing returns nothing
  local unit u=GetEnumUnit()
  call SaveReal(HY,GetHandleId(u),799,0.0)
  set u=null
endfunction

function Medusa_StoneGaze_RemoveSlow takes nothing returns nothing
  local unit u=GetEnumUnit()
  call UnitRemoveAbility(u,'A2S3')
  call UnitRemoveAbility(u,'A2TM')
  call UnitRemoveAbility(u,'B0BQ')
  call SetUnitTurnSpeed(u,GetUnitDefaultTurnSpeed(u))
  set u=null
endfunction

function Medusa_StoneGaze_DamageAmplify takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,2)
  local unit victim=LoadUnitHandle(HY,h,17)
  local integer lvl=LoadInteger(HY,h,0)
  local real ampl=LoadReal(HY,h,0)
  call SaveReal(HY,GetHandleId(victim),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(victim),'AMPL')-ampl,0))
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call UnitRemoveAbility(victim,'A2S1')
  call UnitRemoveAbility(victim,'A2TL')
  set t=null
  set u=null
  set victim=null
  return false
endfunction

function Medusa_StoneGaze_Paralize takes unit u,unit victim, integer lvl returns nothing
  local trigger t
  local integer h
  local unit dummy
  local real ampl
  if IsUnitIllusion(victim)==true then
    call KillUnit(victim)
    return
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set dummy=CreateUnit(GetOwningPlayer(victim),'e00E',GetUnitX(victim),GetUnitY(victim),0)
  call UnitAddAbility(dummy,'A2S4')
  call IssueTargetOrder(dummy,"thunderbolt",victim)
  call TriggerRegisterDeathEvent(t,victim)
  //call TriggerRegisterUnitEvent(t,victim,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,3,false)
  call TriggerAddCondition(t,Condition(function Medusa_StoneGaze_DamageAmplify))
  call SaveUnitHandle(HY,h,2,u)
  call SaveUnitHandle(HY,h,17,victim)
  call SaveInteger(HY,h,0,lvl)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",victim,"chest"))
  set ampl=0.2+0.1*lvl
  call SaveReal(HY,GetHandleId(victim),'AMPL',LoadReal(HY,GetHandleId(victim),'AMPL')+ampl)
  call SaveReal(HY,h,0,ampl)
  call UnitAddAbility2(victim,'A2S1')
  call UnitAddAbility2(victim,'A2TL')
  call SetPlayerAbilityAvailable(GetOwningPlayer(victim),'A2S1',false)
  set t=null
  set dummy=null
endfunction

function Medusa_StoneGaze_Targets takes nothing returns nothing
  local unit u=GetEnumUnit()
  call SaveReal(HY,GetHandleId(u),799,(LoadReal(HY,GetHandleId(u),799)+0.02)*1.0)
  if GetUnitAbilityLevel(u,'A2S3')==0 then
    call UnitAddAbility2(u,'A2S3')
    call UnitAddAbility2(u,'A2TM')
    call SetUnitTurnSpeed(u,GetUnitDefaultTurnSpeed(u)*0.5)
  endif
  if(LoadReal(HY,GetHandleId(u),799))==2.0 then
    call Medusa_StoneGaze_Paralize(Medusa_StoneGaze_TempUnit,u,tt_int1)
  endif
  set u=null
endfunction

function Medusa_StoneGaze_CheckAngle takes unit u,unit victim returns boolean
  local real angle=GetAngleBetweenUnits(victim,u)
  local real face=GetUnitFacing(victim)
  local real fixface
  local real doubleFace
  local real limit1st=-1.0
  local real limit1st2=-1.0
  local real copyface
  local real fixcopyface
  local real limit2nd=-1.0
  local real limit2nd2=-1.0
  set fixface=RMaxBJ(face-85,0)
  set doubleFace=face
  if face-85<=0 then
    set limit1st=360-(85-(doubleFace-fixface))
    set limit1st2=360
  endif
  set copyface=face
  set fixcopyface=RMinBJ(face+85,360)
  if face+85>=360 then
    set limit2nd=0
    set limit2nd2=0+(85-(fixcopyface-copyface))
  endif
  if angle<0 then
    set angle=angle+360
  elseif angle>360 then
    set angle=angle-360
  endif
  if(angle>fixface and angle<doubleFace)or(limit1st!=-1 and angle>limit1st and angle<limit1st2)or(angle>copyface and angle<fixcopyface)or(limit2nd!=-1 and angle>limit2nd and angle<limit2nd2)then
    return true
  endif
  return false
endfunction

function Medusa_StoneGaze_Filter takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and Medusa_StoneGaze_CheckAngle(tt_unit1,GetFilterUnit())
endfunction

function Medusa_StoneGaze_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local integer lvl=LoadInteger(HY,h,0)
  local group g=GetAvailableGroup()
  local group gg=GetAvailableGroup()
  local group ag=LoadGroupHandle(HY,h,187)
  set Medusa_StoneGaze_Group=ag
  set Medusa_StoneGaze_TempUnit=caster
  set tt_unit1=caster
  set tt_int1=lvl
  call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),1025,Condition(function Medusa_StoneGaze_Filter))
  call ForGroup(g,function Medusa_StoneGaze_Targets)
  call GroupAddGroup(g,ag)
  call GroupAddGroup(ag,gg)
  call GroupRemoveGroup(g,gg)
  call KillGroup(g)
  call KillGroup(gg)
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  if GetTriggerEvalCount(t)>R2I(6/0.02)then
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
    call ForGroup(ag,function Medusa_StoneGaze_RemoveSlow)
    call ForGroup(ag,function Medusa_StoneGaze_NullTimers)
    call KillGroup(ag)
  else
    call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",caster,"chest"))
  endif
  set caster=null
  set g=null
  set gg=null
  set ag=null
  set t=null
  return false
endfunction

function Medusa_StoneGaze_Start takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerRegisterTimerEvent(t,0.0,false)
  call TriggerAddCondition(t,Condition(function Medusa_StoneGaze_Duration))
  call SaveUnitHandle(HY,h,2,GetTriggerUnit())
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\EtherealForm\\SpiritWalkerChange.mdl",GetTriggerUnit(),"chest"))
  call SaveGroupHandle(HY,h,187,GetAvailableGroup())
  set t=null
endfunction

function DKG takes integer Count,unit Source,unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  if Count==0 then
    call IssueTargetOrderById(Source,851983,Target)
  elseif Count==1 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',1)
    call IssueTargetOrderById(Caster,852075,Target)
  elseif Count==2 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',1)
    call IssueTargetOrderById(Caster,852075,Target)
  elseif Count==3 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',2)
    call IssueTargetOrderById(Caster,852075,Target)
  elseif Count==4 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',3)
    call IssueTargetOrderById(Caster,852075,Target)
  elseif Count==5 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',4)
    call IssueTargetOrderById(Caster,852075,Target)
  elseif Count==6 then
    call UnitAddAbility2(Caster,'A0TH')
    call SetUnitAbilityLevel(Caster,'A0TH',5)
    call IssueTargetOrderById(Caster,852075,Target)
  endif
  set Caster=null
endfunction

function DMG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=(LoadInteger(HY,h,(34)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=LoadUnitHandle(HY,h,30)
  local real VUE=(10.+Level*5.)/ 100.
  local unit u=GetEventDamageSource()
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    set Count=Count+1
    call DKG(Count,Source,Target)
    if Count==9 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      call SaveInteger(HY,h,(34),(Count))
    endif
  elseif IsDamageReal(GetEventDamage())and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(u))and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
    if IsUnitType(u,UNIT_TYPE_HERO)or GetUnitAbilityLevel(u,'A04R')==0 then
      call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*VUE)
    else
      set u=udg_Hero[GetPlayerId(GetOwningPlayer(u))]
      call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*VUE)
    endif
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",u,"origin"))
  endif
  set t=null
  set Source=null
  set Target=null
  set u=null
  return false
endfunction

function DNG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call DKG(0,Source,Target)
  call SaveInteger(HY,h,(375),(0))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Source,'A194')))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,30,Target)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function DMG))
  set t=null
  set Source=null
  set Target=null
endfunction

function Lifestealer_OpenWounds takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call DNG()
  endif
endfunction

function Lifestealer_OpenWounds_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0TH')
  
endfunction

function Snatch_Damage takes nothing returns nothing
  call DamageTarget(JZ8,GetEnumUnit(),1,JA8*125+25)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaBlood\\NagaBloodWindserpent.mdl",GetEnumUnit(),"overhead"))
endfunction

function Snatch_Process takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real Damage=(LoadReal(HY,h,(20)))
  call DamageTarget(Source,Target,1,Damage)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaBlood\\NagaBloodWindserpent.mdl",Target,"overhead"))
  set Source=null
  set Target=null
endfunction

function DPG takes nothing returns nothing
  local unit Source=JZ8
  local unit Target=GetEnumUnit()
  local integer Level=JA8
  local trigger t=AddProjectile(Source,Target,'h0DF',"DQG",600,false)
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,(20),((Level*125+25)*1.))
  set Source=null
  set Target=null
  set t=null
endfunction

function DRG takes unit Source,unit Target,integer Level returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set JZ8=Source
  set JA8=Level
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),725,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function DPG)
  call KillGroup(g)
  set g=null
endfunction

function DSG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Level=(LoadInteger(HY,h,5))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitShareVision(Target,GetOwningPlayer(Hero),false)
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
    call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
    call PauseUnit(Hero,false)
    call ShowUnit(Hero,true)
    call SetUnitPathing(Hero,true)
    call ClearSelectionForPlayer(GetOwningPlayer(Hero))
    call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
    call SetUnitInvulnerable(Hero,false)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call RemoveUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call DRG(Hero,Target,Level)
    call SaveInteger(HY,(GetHandleId((Hero))),((4310)),2)
  elseif IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitEnemy(Target,GetOwningPlayer(Hero)) then
    call UnitShareVision(Target,GetOwningPlayer(Hero),false)
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
    call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
    call PauseUnit(Hero,false)
    call ShowUnit(Hero,true)
    call SetUnitPathing(Hero,true)
    call ClearSelectionForPlayer(GetOwningPlayer(Hero))
    call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
    call SetUnitInvulnerable(Hero,false)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call RemoveUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call DRG(Hero,Target,Level)
    call SaveInteger(HY,(GetHandleId((Hero))),((4310)),2)
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A0SX' or GetSpellAbilityId()=='A459' then
      call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanLargeDeathExplode\\HumanLargeDeathExplode.mdl",GetUnitX(Target),GetUnitY(Target)))
      if IsUnitEnemy(Target,GetOwningPlayer(Hero))then
        call SetWidgetLife(Hero,GetWidgetLife(Hero)+GetWidgetLife(Target))
      endif
      call UnitShareVision(Target,GetOwningPlayer(Hero),false)
      call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
      call PauseUnit(Hero,false)
      call ShowUnit(Hero,true)
      call SetUnitPathing(Hero,true)
      call SetUnitAnimation(Hero,"Stand Victory")
      call BF8(Hero,1.5)
      call ClearSelectionForPlayer(GetOwningPlayer(Hero))
      call SelectUnitForPlayerSingle(Hero,GetOwningPlayer(Hero))
      call SetUnitInvulnerable(Hero,false)
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call DestroyEffect((LoadEffectHandle(HY,h,(177))))
      call RemoveUnit(Caster)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call DRG(Hero,Target,Level)
      if IsUnitType(Target,UNIT_TYPE_HERO)==false then
        call UnitRemoveBuffs(Target,true,true)
        call SetNapalmFactory(Target,0,0)
        call DamageTarget(Hero,Target,1,100000)
        call DamageTarget(Hero,Target,2,100000)
        call DamageTarget(Hero,Target,3,100000)
      endif
      call SaveInteger(HY,(GetHandleId((Hero))),((4310)),2)
    elseif GetSpellAbilityId()=='A44H' then
      call SetUnitOwner(Target,GetOwningPlayer(Hero),false)
      call UnitRefillMana(Target)
      if LoadBoolean(HY,h,123)==false then
        call SaveBoolean(HY,h,123,true)
        call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
        if GetUnitTypeId(Target)=='ncnk' or GetUnitTypeId(Target)=='nowe' then
          call UnitAddAbility2(Target,'A459')
        else
          call UnitAddAbility2(Target,'A0SX')
        endif
      endif
      call SetUnitMoveSpeed(Target,GetUnitMoveSpeed(Hero))
      call ClearSelectionForPlayer(GetOwningPlayer(Hero))
      call SelectUnitAddForPlayer(Target,GetOwningPlayer(Hero)) 
    endif
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SELECTED and GetTriggerUnit()==Target and GetOwningPlayer(Target)!=GetOwningPlayer(Hero) then
    call ClearSelectionForPlayer(GetOwningPlayer(Hero))
    call SelectUnitAddForPlayer(Caster,GetOwningPlayer(Hero))
  else
    call SetUnitPosition(Hero,GetUnitX(Target),GetUnitY(Target))
  endif
  set t=null
  set Target=null
  set Hero=null
  set Caster=null
  return false
endfunction

function Lifestealer_Infest takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e010',7260,-7732,0)
  local string DUG="Objects\\Spawnmodels\\Naga\\NagaBlood\\NagaBloodWindserpent.mdl"
  local string DVG="Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBase.mdl"
  local string DWG="Abilities\\Spells\\Other\\Aneu\\AneuTarget.mdl"
  if IsPlayerEnemy(GetLocalPlayer(),GetOwningPlayer(Hero))and IsObserver(GetLocalPlayer())==false then
    set DUG=""
    set DVG=""
    set DWG=""
  endif
  call UnitRemoveBuffs(Hero,true,true)
  call SetNapalmFactory(Hero,0,0)
  call SetUnitInvulnerable(Caster,true)
  call UnitAddAbility2(Caster,'A0SX')
  if IsUnitType(Target,UNIT_TYPE_HERO)==false and GetOwningPlayer(Target)!=GetOwningPlayer(Hero) then
    call UnitAddAbility2(Caster,'A44H')
  endif
  call ClearSelectionForPlayer(GetOwningPlayer(Hero))
  if GetOwningPlayer(Target)==GetOwningPlayer(Hero) then
    if GetUnitTypeId(Target)=='ncnk' or GetUnitTypeId(Target)=='nowe' then
      call UnitAddAbility2(Target,'A459')
    else
      call UnitAddAbility2(Target,'A0SX')
    endif
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_SPELL_EFFECT)
    call SelectUnitForPlayerSingle(Target,GetOwningPlayer(Hero))
  else
    call SelectUnitForPlayerSingle(Caster,GetOwningPlayer(Hero))
  endif
  
  
  call UnitShareVision(Target,GetOwningPlayer(Hero),true)
  call SetUnitInvulnerable(Hero,true)
  call ShowUnit(Hero,false)
  call PauseUnit(Hero,true)
  call SetUnitPathing(Hero,false)
  call DestroyEffect(AddSpecialEffectTarget(DUG,Target,"overhead"))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget(DVG,Target,"overhead")))
  call SaveEffectHandle(HY,h,(177),(AddSpecialEffectTarget(DWG,Target,"overhead")))
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A0SW')))
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterPlayerUnitEvent(t,GetOwningPlayer(Hero),EVENT_PLAYER_UNIT_SELECTED,Condition(function ReturnTrue))
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerAddCondition(t,Condition(function DSG))
  call SaveInteger(HY,GetHandleId(Hero),4310,1)
  set t=null
  set Hero=null
  set Target=null
  set Caster=null
endfunction

function Lifestealer_Infest_OnCast takes nothing returns nothing
  if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and (IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) or IsUnitIllusion(GetSpellTargetUnit()) or IsCourier(GetSpellTargetUnit()) or GetSpellTargetUnit()==Roshan or IsSpiritBear(GetSpellTargetUnit())) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0LV'))
  endif
endfunction

function DZG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  call RestoreTint(Hero)
  call DestroyEffect(LoadEffectHandle(HY,h,175))
  call DestroyEffect(LoadEffectHandle(HY,h,176))
  call UnitRemoveAbility(Hero,'A0SR')
  call UnitRemoveAbility(Hero,'A0ST')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function Lifestealer_Rage takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0T2')+GetUnitAbilityLevel(Hero,'QB0Q')
  local integer i=0
  if GetUnitAbilityLevel(Hero,'QB0Q')>0 then
    set i=-1
  endif
  //call SetUnitVertexColor(Hero,0,0,0,255)
  call SetTint(Hero,0,0,0,-1)
  call SetPlayerAbilityAvailable(GetOwningPlayer(Hero),'A0ST',false)
  call UnitAddAbility2(Hero,'A0ST')
  call UnitAddAbility2(Hero,'A0SR')
  call SetUnitAbilityLevel(Hero,'A0SR',Level)
  call SetNapalmFactory(Hero,0,0)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"right hand"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Bloodlust\\BloodlustTarget.mdl",Hero,"left hand"))
  call TriggerRegisterTimerEvent(t,2+Level+i,false)
  call TriggerAddCondition(t,Condition(function DZG))
  set Hero=null
  set t=null
endfunction

function Lifestealer_Feast_Act takes unit Source,unit Target returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'A0SS')+GetUnitAbilityLevel(Source,'QP1W')
  local real Damage
  //	local unit u=LoadUnitHandle(HeroStats,GetHandleId(Source),'DUMM')
  //	if u==null or IsDead(u) then
  //		set u=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  //	endif
  if(not(Mode_BO))and(IsUnitType(Source,UNIT_TYPE_RANGED_ATTACKER))then
    set Damage=(.0175+.01*Level)*GetWidgetLife(Target)
  else
    set Damage=(.03+.01*Level)*GetWidgetLife(Target)
  endif
  call DamageTarget(Source,Target,2,Damage)
  call SetWidgetLife(Source,Damage+GetWidgetLife(Source))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",Source,"origin"))
  //	set u=null
endfunction

function Necrolyte_Heartstopper_ForGroup takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local real hp=GetWidgetLife(Target)-1
  local real maxhp=GetUnitState(Target,UNIT_STATE_MAX_LIFE)
  local real dmg=0.003*Necrolyte_Heartstopper_Lvl*maxhp/2
  if hp<dmg then
    call SetWidgetLife(Target,1)
    call DamageTarget(Necrolyte_Heartstopper_Caster,Target,1,100)
    call DamageTarget(Necrolyte_Heartstopper_Caster,Target,2,100)
    call DamageTarget(Necrolyte_Heartstopper_Caster,Target,3,100)
  else
    call SetWidgetLife(Target,RMaxIF(GetWidgetLife(Target)-dmg,1))
  endif
  set Target=null
endfunction

function Necrolyte_Heartstopper_Filter takes nothing returns boolean
  return((IsUnitEnemy(Necrolyte_Heartstopper_Caster,GetOwningPlayer(GetFilterUnit()) )and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'B084')>0)!=null
endfunction

function Necrolyte_Heartstopper_Tick takes nothing returns nothing
  local integer h=GetHandleId(GetExpiredTimer())
  local unit Source=LoadUnitHandle(HY,h,2)
  local group g
  if IsDead(Source)==false then
    set g=GetAvailableGroup()
    set Necrolyte_Heartstopper_Caster=Source
    set Necrolyte_Heartstopper_Lvl=GetUnitAbilityLevel(Source,'P302')+1 //A01N
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1225,Condition(function Necrolyte_Heartstopper_Filter))
    call ForGroup(g,function Necrolyte_Heartstopper_ForGroup)
    call KillGroup(g)
  endif
  set g=null
  set Source=null
endfunction

function Necrolyte_Heartstopper_Learn takes nothing returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,.5,true,function Necrolyte_Heartstopper_Tick)
  call SaveUnitHandle(HY,GetHandleId(t),2,GetTriggerUnit())
  set t=null
endfunction

function Sadist_Dur takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  local integer c=LoadInteger(MHT,info,2)+1
  if IsDead(u) or c>6*10 then
    call Timer_End(t)
  else
    call SetWidgetLife(u,GetWidgetLife(u)+LoadInteger(MHT,info,0)*0.1)
    call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+LoadInteger(MHT,info,1)*0.1)
    call SaveInteger(MHT,info,2,c)
  endif
  set t = null
  set u = null
endfunction

function Sadist_Start takes unit u, integer level, boolean b returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  local integer amount = level*2
  if amount==8 then
    set amount=10
  endif
  if b then
    set amount=amount*10
    set level=level*10
  endif
  call Buff_Add(u,LoDBuff_AbilID[12],LoDBuff_BuffID[12],6)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"origin"))
  call SaveUnitHandle(MHT,info,0,u)
  call SaveInteger(MHT,info,0,level)
  call SaveInteger(MHT,info,1,amount)
  call TimerStart(t,0.1,true,function Sadist_Dur)
  set t = null
endfunction

function Sadist_Condition takes unit killer, unit victim returns nothing
  local unit u = udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
  local integer level
  if IsUnitIllusion(victim) then
    set u=null
    return
  endif
  if LoadInteger(HY,GetHandleId(victim),4333)==1 then
    set u=udg_Hero[GetPlayerId(LoadPlayerHandle(HY,GetHandleId(victim),4333))]
  endif
  set level=GetUnitAbilityLevel(u,'P303')
  if level > 0 and IsDead(u)==false then
    call Sadist_Start(u,level,IsUnitType(victim,UNIT_TYPE_HERO)==true)
  endif
  set u = null
endfunction


function DQG takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real Damage=(LoadReal(HY,h,(20)))
  local real DJF=(LoadReal(HY,h,(21)))
  if IsUnitAlly(Target,GetOwningPlayer(Source))then
    call SetWidgetLife(Target,GetWidgetLife(Target)+DJF)
  else
    call DamageTarget(Source,Target,1,Damage)
  endif
  set Source=null
  set Target=null
endfunction

function EGG takes nothing returns nothing
  local trigger t=AddProjectile(tt_unit1,GetEnumUnit(),'h00W',"DQG",400,false)
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,(20),((tt_real1)*1.))
  call SaveReal(HY,h,(21),((TJ)*1.))
  set t=null
endfunction

function EHG takes nothing returns nothing
  if IsUnitVisible(GetEnumUnit(),GetOwningPlayer(tt_unit1))or (IsUnitFogged(GetEnumUnit(),GetOwningPlayer(tt_unit1)) and GenericCondition_IsDotAInvis(GetEnumUnit())==false)then
    call EGG()
  endif
endfunction

function Necrolyte_DeathPulse takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(Hero,'A05V')
  local real r = 500
  local real Damage
  if Level==1 then
    set Damage=75
  elseif Level==2 then
    set Damage=125
  elseif Level==3 then
    set Damage=200
  elseif Level==4 then
    set Damage=275
  endif
  set tt_unit1=Hero
  set tt_real1=Damage
  set TJ=50 + 20*Level
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),r,Condition(function DH9))
  call GroupRemoveUnit(g,Hero)
  call ForGroup(g,function EHG)
  call KillGroup(g)
  call SetWidgetLife(Hero,GetWidgetLife(Hero)+TJ)
  set Hero=null
  set g=null
endfunction

function EKG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real VUE=(LoadReal(HY,h,(680)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl",Target,"origin"))
  call DamageTarget(Source,Target,1,VUE*(GetUnitState(Target,UNIT_STATE_MAX_LIFE)-GetWidgetLife(Target)))
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function EMG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer ENG=GetUnitAbilityLevel(Source,'A067')
  local integer EOG=GetUnitAbilityLevel(Source,'A08P')
  local real VUE
  if ENG==1 then
    set VUE=.4
  elseif ENG==2 or EOG==1 then
    set VUE=.6
  elseif ENG==3 or EOG==2 then
    set VUE=.9
  elseif EOG==3 then
    set VUE=1.2
  endif
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(680),((VUE)*1.))
  call TriggerRegisterTimerEvent(t,1.,false)
  call TriggerAddCondition(t,Condition(function EKG))
  call AddTimedKeyToUnit(Target,4333,1.5)
  call SavePlayerHandle(HY,GetHandleId(Target),4333,GetOwningPlayer(Source))
  if EOG>0 then
    call AddTimedKeyToUnit(Target,4418,1.51)
  endif
  set t=null
  set Source=null
  set Target=null
endfunction

function Necrolyte_ReapersScythe takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call EMG()
  endif
endfunction

function NA_Impale takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real a
  local real x2
  local real y2
  local integer Level=GetUnitAbilityLevel(Hero,'A0X7')
  local real Damage
  local real DP9
  local unit D09=null
  if GetSpellTargetUnit()!=null then
    set x2=GetUnitX(GetSpellTargetUnit())
    set y2=GetUnitY(GetSpellTargetUnit())
  else
    set x2=GetSpellTargetX()
    set y2=GetSpellTargetY()
  endif
  set a=Atan2(y2-y1,x2-x1)
  set x2=x1+700*Cos(a)
  set y2=y1+700*Sin(a)
  if Level==1 then
    set Damage=80
    set DP9=.75
  elseif Level==2 then
    set Damage=140
    set DP9=1.25
  elseif Level==3 then
    set Damage=200
    set DP9=1.75
  elseif Level==4 then
    set Damage=260
    set DP9=2.25
  endif
  if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
    set D09=GetSpellTargetUnit()
  endif
  call ImpaleFactory(Hero,D09,Damage,DP9,.52,x1,y1,x2,y2,150,null,true,1600)
  set Hero=null
  set D09=null
endfunction

function ESG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real r=GetHeroInt(Target,true)*(3+0.5*GetUnitAbilityLevel(Source,'A1H5'))
  local integer M7E=IMinBJ(R2I(r),R2I(GetUnitState(Target,UNIT_STATE_MANA)))
  call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)-M7E)
  call DamageTarget(Source,Target,1,M7E)
  call CR8("MBUR",Source,Target,1,1,1,1,.5)
  call TextTagOnUnit("-"+I2S(M7E),3,Target,.023,82,82,255,255)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\ManaBurn\\ManaBurnTarget.mdl",Target,"chest"))
  set Source=null
  set Target=null
endfunction

function NA_Manaburn takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call ESG()
  endif
endfunction

function Spiked_Carapace_End takes trigger trig, unit u, integer info returns nothing
  call Buff_Remove(u,LoDBuff_BuffID[8])
  call DestroyEffect(LoadEffectHandle(HY,info,3))
  call DestroyEffect(LoadEffectHandle(HY,info,4))
  call DestroyEffect(LoadEffectHandle(HY,info,5))
  call DestroyEffect(LoadEffectHandle(HY,info,6))
  call KillGroup(LoadGroupHandle(HY,info,7))
  call FlushChildHashtable(HY,info)
  call CleanTrigger(trig)
endfunction

function A94 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamage()>0 and IsPlayerEnemy(GetOwningPlayer(GetEventDamageSource()),GetOwningPlayer(Source))==true and IsRealDamage and IsUnitInGroup(udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))],LoadGroupHandle(HY,h,7))==false then
      if IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))and IsDamageReal(GetEventDamage())then
        call HealUnitFor(Source,GetEventDamage())
        if GetUnitAbilityLevel(GetEventDamageSource(),'A04R')>0 or GetUnitAbilityLevel(GetEventDamageSource(),'Aloc')>0 then
          set Target=udg_Hero[GetPlayerId(GetOwningPlayer(GetEventDamageSource()))]
        else
          set Target=GetEventDamageSource()
        endif
        call GroupAddUnit(LoadGroupHandle(HY,h,7),Target)
        if IsDead(Target)==false then
          call StunTargetLod(Target,0.6*LoadInteger(HY,h,0))
          call DamageTarget(Source,Target,3,GetEventDamage())
        endif
      endif
    endif
  else
    call Spiked_Carapace_End(t,Source,h)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function NA_SpikedCarapace takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,2.25,false)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function A94))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call Buff_Add(Source,LoDBuff_AbilID[8],LoDBuff_BuffID[8],2.75)
  call SaveGroupHandle(HY,h,7,GetAvailableGroup())
  call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestLeft.mdl",Source,"chest,left"))
  call SaveEffectHandle(HY,h,4,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestRight.mdl",Source,"chest,right"))
  call SaveEffectHandle(HY,h,5,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestMountLeft.mdl",Source,"mount,left"))
  call SaveEffectHandle(HY,h,6,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ThornyShield\\ThornyShieldTargetChestMountRight.mdl",Source,"mount,right"))
  set Source=null
  set t=null
endfunction

function EXG takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit2
  local unit Target=tt_unit1
  local integer EYG
  local integer EZG
  local integer Level
  if GetUnitAbilityLevel(Source,'A04R')!=0 then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  set EYG=GetUnitAbilityLevel(Source,'A0CQ')
  set Level=GetUnitAbilityLevel(Source,'A0BR')
  if Level==1 then
    set EZG=12
  elseif Level==2 then
    set EZG=20
  elseif Level==3 then
    set EZG=28
  else
    set EZG=36
  endif
  set EZG=EZG+1
  if IsUnitType(Target,UNIT_TYPE_HERO)==false then
    set EYG=EYG+1
  else
    set EYG=EYG+12
  endif
  set EYG=IMinBJ(EZG,EYG)
  call SetUnitAbilityLevel(Source,'A0CQ',EYG)
  call SaveInteger(HY,(GetHandleId(Source)),(710),(EYG))
  set Source=null
  set Target=null
endfunction

function EAG takes nothing returns nothing
  local integer EYG
  local integer Level
  local integer EZG
  local trigger t
  local integer h
  local unit Source=GetKillingUnit()
  if GetUnitTypeId(Source)=='e00E' then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(GetKillingUnit()))]
  endif
  set EYG=GetUnitAbilityLevel(Source,'A0CQ')
  set Level=GetUnitAbilityLevel(Source,'A0BR')
  set EZG=8+7*Level
  if EYG<=EZG then
    set t=AddProjectile(GetTriggerUnit(),Source,'h0CR',"EXG",500,false)
    set h=GetHandleId(t)
    set t=null
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit())))
  endif
  set Source=null
endfunction

function EBG takes nothing returns nothing
  call SaveInteger(HY,GetHandleId(GetTriggerUnit()),710,R2I(GetUnitAbilityLevel(GetTriggerUnit(),'A0CQ')*.5)+1)
  call SetUnitAbilityLevel(GetTriggerUnit(),'A0CQ',R2I(GetUnitAbilityLevel(GetTriggerUnit(),'A0CQ')*.5)+1)
endfunction

function NecromasteryReact takes unit killer, unit victim returns nothing
  if IsUnitIllusion(victim) then
    return
  endif
  if IsUnitType(killer,UNIT_TYPE_HERO)==false then
    set killer=udg_Hero[GetPlayerId(GetOwningPlayer(killer))]
  endif
  if GetUnitAbilityLevel(killer,'A0BR')>0 then
    call EAG()
  endif
  if GetUnitAbilityLevel(victim,'A0BR')>0 then
    call EBG()
  endif
endfunction

function Shadowraze_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetTriggerUnit(),GetOwningPlayer(GetFilterUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0
endfunction

function Shadowraze_Damage takes nothing returns nothing
  call DamageTarget(Shadowraze_Source,GetEnumUnit(),1,25+75*Shadowraze_Level)
endfunction

function Shadowraze_Cast takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local real range
  local real a
  local real x
  local real y
  local group g=GetAvailableGroup()
  if GetUnitAbilityLevel(Hero,'A04R')>0 then // multicast
    set Hero=udg_Hero[GetPlayerId(GetOwningPlayer(Hero))]
  endif
  if GetSpellAbilityId()=='A0EY'then
    set range = 200
  elseif GetSpellAbilityId()=='A0FH'then
    set range = 450
  elseif GetSpellAbilityId()=='A0F0'then
    set range = 700
  endif
  set a = GetUnitFacing(Hero)
  set x = GetWidgetX(Hero) + range*Cos(a*bj_DEGTORAD)
  set y = GetWidgetY(Hero) + range*Sin(a*bj_DEGTORAD)
  set Shadowraze_Source=Hero
  set Shadowraze_Level=GetUnitAbilityLevel(Hero,GetSpellAbilityId())
  call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Hero),'e006',x,y,0),'BTLF',2)
  call GroupEnumUnitsInRange(g,x,y,275,Condition(function Shadowraze_Filter))
  call ForGroup(g,function Shadowraze_Damage)
  call KillGroup(g)
  set Hero = null
  set g=null
  return false
endfunction

function SF_Necromastery_Learn takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A0CQ')
endfunction

function SF_Shadowrazes_Learn takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local integer level = GetUnitAbilityLevel(u,'A0EY')
  if level==1 then
    call UnitAddAbility2(u,'A0F0')
    call UnitAddAbility2(u,'A0FH')
  else
    call SetUnitAbilityLevel(u,'A0F0',level)
    call SetUnitAbilityLevel(u,'A0FH',level)
  endif
  set u = null
endfunction

function Requiem_Start takes unit u, integer max returns nothing
  local real x = GetWidgetX(u)
  local real y = GetWidgetY(u)
  local unit d = CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)
  local integer loopA = 0
  local integer angle = 360/max
  local integer level = GetUnitAbilityLevel(u,'A29J')
  
  call UnitAddAbility(d,'A0HG')
  call SetUnitAbilityLevel(d,'A0HG',level)
  
  loop
    exitwhen loopA > max
    call IssuePointOrderById(d,852218,x+50*Cos(bj_DEGTORAD*loopA*angle),y+50*Sin(bj_DEGTORAD*loopA*angle))
    set loopA = loopA + 1
  endloop
  
  set d = null
endfunction

function RequiemWrapperOnDeath takes unit victim returns nothing
  if (GetUnitAbilityLevel(victim,'A29J')>0 or GetUnitAbilityLevel(victim,'A1MP')>0) then
    call Requiem_Start(victim,9)
  endif
endfunction

function RequiemWrapper takes nothing returns nothing
  call Requiem_Start(GetTriggerUnit(),18)
endfunction

function FEG takes nothing returns boolean
  return(( not(IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)))and( not(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==1))and( not(IsUnitAliveBJ(GetFilterUnit())==false))and( not(GetUnitTypeId(GetFilterUnit())=='o003'))and( not(IsUnitEnemy(GetFilterUnit(),GetTriggerPlayer())==false))and( not(GetTriggerUnit()==GetFilterUnit()))and( not(IsUnitVisible(GetFilterUnit(),GetTriggerPlayer())==false)))!=null
endfunction

function FFG takes nothing returns nothing
  local unit XX8=GetTriggerUnit()
  local location YT9=GetUnitLoc(XX8)
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A29J')
  if Level==0 then
    set Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1MP')
  endif
  call CreateNUnitsAtLoc(1,'e00C',GetOwningPlayer(XX8),YT9,bj_UNIT_FACING)
  call UnitAddAbility(bj_lastCreatedUnit,'A0HH')
  call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0HH',Level)
  call UnitApplyTimedLifeBJ(2.,'BTLF',bj_lastCreatedUnit)
  call IssueTargetOrderById(bj_lastCreatedUnit,852189,GetEnumUnit())
  call SetUnitPathing(bj_lastCreatedUnit,false)
  call SetUnitInvulnerable(bj_lastCreatedUnit,true)
  call UnitAddAbility(bj_lastCreatedUnit,'Aloc')
  call RemoveLocation(YT9)
  set YT9=null
  set XX8=null
endfunction

function FGG takes nothing returns nothing
  local unit XX8=GetTriggerUnit()
  local location YT9=GetUnitLoc(XX8)
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A29J')
  if Level==0 then
    set Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1MP')
  endif
  call CreateNUnitsAtLoc(1,'e00C',GetOwningPlayer(XX8),YT9,bj_UNIT_FACING)
  call UnitAddAbility(bj_lastCreatedUnit,'A0HH')
  call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0HH',Level)
  call UnitApplyTimedLifeBJ(2.,'BTLF',bj_lastCreatedUnit)
  call IssueTargetOrderById(bj_lastCreatedUnit,852189,GetEnumUnit())
  call SetUnitPathing(bj_lastCreatedUnit,false)
  call SetUnitInvulnerable(bj_lastCreatedUnit,true)
  call UnitAddAbility(bj_lastCreatedUnit,'Aloc')
  call RemoveLocation(YT9)
  set YT9=null
  set XX8=null
endfunction

function FHG takes nothing returns nothing
  local unit XX8=GetTriggerUnit()
  local location YT9=GetUnitLoc(XX8)
  local integer Level=GetUnitAbilityLevel(GetTriggerUnit(),'A29J')
  if Level==0 then
    set Level=GetUnitAbilityLevel(GetTriggerUnit(),'A1MP')
  endif
  call CreateNUnitsAtLoc(1,'e00C',GetOwningPlayer(XX8),YT9,bj_UNIT_FACING)
  call UnitAddAbility(bj_lastCreatedUnit,'A0HH')
  call SetUnitAbilityLevel(bj_lastCreatedUnit,'A0HH',Level)
  call UnitApplyTimedLifeBJ(2.,'BTLF',bj_lastCreatedUnit)
  call IssueTargetOrderById(bj_lastCreatedUnit,852189,GetEnumUnit())
  call SetUnitPathing(bj_lastCreatedUnit,false)
  call SetUnitInvulnerable(bj_lastCreatedUnit,true)
  call UnitAddAbility(bj_lastCreatedUnit,'Aloc')
  call RemoveLocation(YT9)
  set YT9=null
  set XX8=null
endfunction

function SF_RequiemOfSouls takes nothing returns nothing
  local location l=GetUnitLoc(GetTriggerUnit())
  local group g
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRangeOfLoc(g,l,700,Condition(function FEG))
  call ForGroup(g,function FFG)
  call KillGroup(g)
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRangeOfLoc(g,l,400,Condition(function FEG))
  call ForGroup(g,function FGG)
  call KillGroup(g)
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRangeOfLoc(g,l,200,Condition(function FEG))
  call ForGroup(g,function FHG)
  call KillGroup(g)
  call RemoveLocation(l)
  set l=null
  set g=null
endfunction

function NightHunter_Void takes nothing returns nothing
  local unit Caster
  if(IsDayTime()==false)then
    set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
    call UnitAddAbility2(Caster,'A02R')
    call IssueTargetOrderById(Caster,852075,GetSpellTargetUnit())
  else
    set Caster=CreateUnit(GetOwningPlayer(GetTriggerUnit()),'e00E',GetUnitX(GetSpellTargetUnit()),GetUnitY(GetSpellTargetUnit()),bj_UNIT_FACING)
    call UnitAddAbility2(Caster,'A1H1')
    call IssueTargetOrderById(Caster,852075,GetSpellTargetUnit())
  endif
  set Caster=null
endfunction

function FMG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,19)
  call ResetUnitAnimation(Source)
  call RemoveUnit(Caster)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set Source=null
  set Caster=null
  set t=null
  return false
endfunction

function FNG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'u01I',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function FMG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,19,Caster)
  call SetUnitVertexColorBJ(Caster,0,0,0,75)
  call SetUnitAnimation(Caster,"spell third")
  set Source=null
  set Caster=null
  set t=null
endfunction

function Fear_Night_OnCast takes nothing returns nothing
  if GetUnitAbilityLevel(GetTriggerUnit(),'A08C')<5 then
    call FNG()
  endif
endfunction

function FQG takes nothing returns boolean
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit stalker=LoadUnitHandle(HY,h,304)
  local unit dummy=LoadUnitHandle(HY,h,305)
  if GetTriggerEvalCount(GetTriggeringTrigger())==1 then
    call UnitAddAbility(dummy,'Aloc')
  endif
  if stalker==null or IsDead(stalker)or IsDayTime() or GetUnitAbilityLevel(stalker,'DRKN')+GetUnitAbilityLevel(stalker,'DRKU')==0 then
    call ShowUnit(dummy,false)
    call SetUnitX(dummy,GetUnitX(stalker))
    call SetUnitY(dummy,GetUnitY(stalker))
    call UnitRemoveAbility(stalker,'A1VA')
  else
    call ShowUnit(dummy,true)
    call SetUnitX(dummy,GetUnitX(stalker))
    call SetUnitY(dummy,GetUnitY(stalker))
    call UnitAddAbility2(stalker,'A1VA')
  endif
  if GetOwningPlayer(dummy)!=GetOwningPlayer(stalker)then
    call SetUnitOwner(dummy,GetOwningPlayer(stalker),true)
  endif
  set stalker=null
  set dummy=null
  return false
endfunction

function HunterInTheNight_Leveling takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A086')+GetUnitAbilityLevel(u,'QP0T')
  call UnitAddAbility2(u,'P247')
  if(IsDayTime())then
    call SetUnitAbilityLevel(u,'P247',5) //S00A
  else
    call SetUnitAbilityLevel(u,'P247',lvl) //S00A
  endif
  set u=null
endfunction

function Stalker_Fear_Leveling takes nothing returns nothing
  local unit u=GetTriggerUnit()
  call UnitAddAbility2(u,'A08C')
  if(IsDayTime())then
    call SetUnitAbilityLevel(u,'A08C',5)
  else
    call SetUnitAbilityLevel(u,'A08C',GetUnitAbilityLevel(u,'A08E'))
  endif
  set u=null
endfunction

function Nightstalker_Darkness_VisionAffected takes nothing returns boolean
  return IsUnitEnemy(GetFilterUnit(),tt_player1) and GetOwningPlayer(GetFilterUnit())!=Neutrals and IsCourier(GetFilterUnit())==false and IsUnitFamiliar(GetUnitTypeId(GetFilterUnit()))==false
endfunction

function Nightstalker_Darkness_RemoveVision takes nothing returns nothing
  local real sight
  local real nsight=800
  local integer id
  local integer i
  if LoadReal(UnitStats,GetUnitTypeId(GetEnumUnit()),NSIGHT)>0 then
    set nsight=LoadReal(UnitStats,GetUnitTypeId(GetEnumUnit()),NSIGHT)
  endif
  set i=IMinIF(R2I(nsight/400),5)
  set id='DRK0'-1+i
  if GetUnitAbilityLevel(GetEnumUnit(),id)==0 then
    call UnitRemoveAbility(GetEnumUnit(),'DRK0')
    call UnitRemoveAbility(GetEnumUnit(),'DRK1')
    call UnitRemoveAbility(GetEnumUnit(),'DRK2')
    call UnitRemoveAbility(GetEnumUnit(),'DRK3')
    call UnitRemoveAbility(GetEnumUnit(),'DRK4')
    call UnitAddAbility2(GetEnumUnit(),id)
  endif
endfunction

function Nightstalker_Darkness_BringVisionBack takes nothing returns nothing
  if GetUnitAbilityLevel(GetEnumUnit(),'DRK0')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK1')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK2')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK3')>0 or GetUnitAbilityLevel(GetEnumUnit(),'DRK4')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'DRK0')
    call UnitRemoveAbility(GetEnumUnit(),'DRK1')
    call UnitRemoveAbility(GetEnumUnit(),'DRK2')
    call UnitRemoveAbility(GetEnumUnit(),'DRK3')
    call UnitRemoveAbility(GetEnumUnit(),'DRK4')
  endif
endfunction

function Nightstalker_Darkness_FixVision takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=LoadPlayerHandle(HY,h,0)
  local real limit=LoadReal(HY,h,0)-0.5
  local group g=GetAvailableGroup()
  call SaveReal(HY,h,0,limit)
  set tt_player1=p
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function Nightstalker_Darkness_VisionAffected))
  if limit>0 then
    call ForGroup(g,function Nightstalker_Darkness_RemoveVision)
  else
    call ForGroup(g,function Nightstalker_Darkness_BringVisionBack)
  endif
  if limit<-20 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  call KillGroup(g)
  set t=null
  set g=null
endfunction

function Nightstalker_Darkness_ReducedVision takes unit u, real dur returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.5,true)
  call TriggerAddCondition(t,Condition(function Nightstalker_Darkness_FixVision))
  call SavePlayerHandle(HY,h,0,GetOwningPlayer(u))
  call SaveReal(HY,h,0,dur)
  set t=null
endfunction

function Nightstalker_Darkness_Start takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local real dur=25
  local real curTime=TimerGetElapsed(GlobalTimer)
  local real darknessEnd=LoadReal(MHT,'DARK',0)
  local real endTime
  local real mindur
  local real finaltime
  if lvl==2 then
    set dur=50
  elseif lvl==3 then
    set dur=80
  endif
  set mindur=dur*1. / 60.
  if curTime+dur>darknessEnd then
    call TimerStart(DarknessTimer,dur,false,function DarknessStop)
    //call SaveReal(MHT,'DARK',0,curTime+dur)
    call SuspendTimeOfDay(true)
    if LoadBoolean(MHT,'DARK',0)==false then//if false there are no other darkness so time is real, not 00:00. when true it always 00:00
      set curTime=GetFloatGameState(GAME_STATE_TIME_OF_DAY)
      set finaltime=curTime+mindur
      if finaltime > 24 then
        set finaltime=finaltime-24.
      endif
      call SaveReal(MHT,'DARK',1,finaltime)
    endif
    call SetFloatGameState(GAME_STATE_TIME_OF_DAY,0)
    call SaveBoolean(MHT,'DARK',0,true)
  endif
  call Nightstalker_Darkness_ReducedVision(u,dur)
  set u=null
endfunction

function FVG takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local integer Level=(LoadInteger(HY,h,5))
  local real Damage=Level*40+20
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local boolean b=false
  if LoadInteger(HY,h,6)>0 and PRD_Get(Source,'P240',15) then
    set b=true
    set Damage=Damage*(1.5+LoadInteger(HY,h,6))
  endif
  call UnitAddAbility2(Caster,'A0YL')
  call SetUnitAbilityLevel(Caster,'A0YL',Level)
  call IssueTargetOrderById(Caster,852075,Target)
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    set Damage=Damage/2
  endif
  call DamageTarget(Source,Target,3,Damage)
  if b then
    call TextTagOnUnit(I2S(R2I(Damage))+"!",3,Target,0.02,255,0,0,255)
  endif
  set Source=null
  set Target=null
  set Caster=null
endfunction

function FWG takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=AddProjectile(Hero,Target,'h010',"FVG",1200,false)
  local integer h=GetHandleId(t)
  call SaveInteger(HY,h,5,(GetUnitAbilityLevel(Hero,'A0YM')))
  call SaveInteger(HY,h,6,GetUnitAbilityLevel(Hero,'A0YM')-1)
  set Hero=null
  set Target=null
  set t=null
endfunction

function PA_StiflingDagger takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call FWG()
  endif
endfunction

function FYG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,30)
  local integer Count=LoadInteger(HY,h,34)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Source,'A1CO')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetTriggerUnit()!=Target and GetAttacker()==Source then
      call UnitRemoveAbility(Source,'A1CO')
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    elseif GetTriggerUnit()==Target and GetAttacker()==Source then
      set Count=Count+1
      call SaveInteger(HY,h,(34),(Count))
      if Count==4 then
        call UnitRemoveAbility(Source,'A1CO')
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      endif
    endif
  else
    call UnitRemoveAbility(Source,'A1CO')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function PA_Blink takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0PL')
  local trigger t
  local integer h
  call DestroyEffect(AddSpecialEffect("war3mapImported\\PhantomStrike.mdx",GetUnitX(Source),GetUnitY(Source)))
  call SetUnitX(Source,GetUnitX(Target))
  call SetUnitY(Source,GetUnitY(Target))
  if IsUnitAlly(Source,GetOwningPlayer(Target))==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call UnitAddAbility2(Source,'A1CO')
    call IssueTargetOrderById(Source,851983,Target)
    call TriggerRegisterTimerEvent(t,3,false)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function FYG))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,30,Target)
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function FBG takes unit Source,boolean show returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'P239')
  if show==false then
    call UnitRemoveAbility(Source,'A13F')
    call UnitRemoveAbility(Source,'B0A2')
  else
    call UnitAddAbility2(Source,'A13F')
  endif
endfunction

function FCG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local group g
  local integer Count=(LoadInteger(HY,h,(34)))
  local boolean F3G=(LoadBoolean(HY,h,(674)))
  set Count=Count+1
  call SaveInteger(HY,h,(34),(Count))
  if Source!=null and IsDead(Source)==false and GetUnitAbilityLevel(Source,'P239')>0 then //A03P
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1625,Condition(function LV8))
    if FirstOfGroup(g)==null then
      if F3G and Count>7 then
        set F3G=false
        call SaveBoolean(HY,h,(674),(F3G))
        set Count=0
        call SaveInteger(HY,h,(34),(Count))
      endif
      if F3G==false then
        set Count=0
        call SaveInteger(HY,h,(34),(Count))
        call SaveInteger(HY,(GetHandleId((Source))),((4302)),2)
        call FBG(Source,false)
        call SetTint(Source,-1,-1,-1,255)
        if GetUnitAbilityLevel(Source,'A20S')==0 then
          call UnitSetUsesAltIcon(Source,false)
        endif
      endif
    else
      if F3G==false and Count>15 then
        set F3G=true
        set Count=0
        call SaveBoolean(HY,h,(674),(F3G))
        call SaveInteger(HY,h,(34),(Count))
      endif
      if F3G then
        set Count=0
        call SaveInteger(HY,h,(34),(Count))
        call SaveInteger(HY,(GetHandleId((Source))),((4302)),(1))
        call FBG(Source,true)
        call SetTint(Source,-1,-1,-1,64)
        call UnitSetUsesAltIcon(Source,IsPlayerEnemy(GetOwningPlayer(Source),GetLocalPlayer()) and IsUnitVisible(Source,GetLocalPlayer()) and IsObserver(GetLocalPlayer())==false)
      endif
    endif
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function PhantomAssassin_Blur_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function FCG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(34),(0))
  call SaveBoolean(HY,h,(674),(false))
  set t=null
  set Source=null
endfunction

function F1G takes nothing returns nothing
  local unit Caster
  if IsUnitInGroup(GetEnumUnit(),DK)==false and IsUnitVisible(GetEnumUnit(),GetOwningPlayer(J08)) then
    call GroupAddUnit(DK,GetEnumUnit())
    set Caster=CreateUnit(GetOwningPlayer(J08),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
    call UnitAddAbility2(Caster,'A0RI')
    call SetUnitAbilityLevel(Caster,'A0RI',GetUnitAbilityLevel(J08,'A0RA'))
    call IssueTargetOrderById(Caster,852106,GetEnumUnit())
    call DamageTarget(J08,GetEnumUnit(),1,100)
  endif
  set Caster=null
endfunction

function F0G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer i
  local group g=(LoadGroupHandle(HY,h,(22)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local group DA9=GetAvailableGroup()
  local unit XX8=(LoadUnitHandle(HY,h,(221)))
  set tt_unit1=XX8
  set J08=XX8
  call GroupEnumUnitsInRange(DA9,x,y,300,Condition(function DefaultEnemyFilter))
  set DK=g
  call ForGroup(DA9,function F1G)
  call KillGroup(DA9)
  if GetTriggerEvalCount(t)>7*10 then
    set i=1
    loop
      exitwhen i>16
      call DestroyEffect((LoadEffectHandle(HY,h,(2700+i))))
      set i=i+1
    endloop
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set g=null
  set DA9=null
  set XX8=null
  return false
endfunction

function PitLord_PitOfMalice takes nothing returns nothing
  local integer i=1
  local real F2G=GetSpellTargetX()
  local real G4G=GetSpellTargetY()
  local real x
  local real y
  local integer E9E=16
  local string fx="Abilities\\Spells\\Undead\\Graveyard\\GraveMarker.mdl"
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  call TimedReveal(GetOwningPlayer(GetTriggerUnit()),7,F2G,G4G,300+500)
  call PlaySoundAtPos(BC,F2G,G4G)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function F0G))
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveUnitHandle(HY,h,(221),(GetTriggerUnit()))
  call SaveReal(HY,h,6,((F2G)*1.))
  call SaveReal(HY,h,7,((G4G)*1.))
  call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),'ugho',F2G,G4G,0)
  loop
    exitwhen i>E9E
    set x=F2G+300*Cos(i*360/ E9E*bj_DEGTORAD)
    set y=G4G+300*Sin(i*360/ E9E*bj_DEGTORAD)
    call SaveEffectHandle(HY,h,(2700+i),(AddSpecialEffect(fx,x,y)))
    if i==1 or i==5 or i==9 or i==13 then
      set x=F2G+275*Cos(i*360/ E9E*bj_DEGTORAD)
      set y=G4G+275*Sin(i*360/ E9E*bj_DEGTORAD)
      call CreateCorpse(GetOwningPlayer(GetTriggerUnit()),'ugho',x,y,0)
    endif
    set i=i+1
  endloop
  set t=null
  set g=null
endfunction

function G8G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(393)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer MIE=90
  local integer Count=GetTriggerEvalCount(t)
  
  if GetSpellAbilityId()=='A2MB'then
    call KillUnit(Caster)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
    
    set t=null
    set Caster=null
    set Source=null
    return false
  endif
  
  if Level==1 then
    set MIE=160
  elseif Level==2 then
    set MIE=120
  endif
  call SetUnitX(Caster,GetUnitX(Source))
  call SetUnitY(Caster,GetUnitY(Source))
  if Count>MIE then
    call KillUnit(Caster)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  elseif Count==30 then
    call ShowUnit(Caster,true)
    call UnitAddAbility(Caster,'Aloc')
  endif
  set t=null
  set Caster=null
  set Source=null
  return false
endfunction

function G9G takes nothing returns nothing
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
  call AddTimedKeyToUnit(GetEnumUnit(),4406,1)
  call SetUnitPosition(GetEnumUnit(),tt_real1,TJ)
  call PanCameraToTimedForPlayer(GetOwningPlayer(GetEnumUnit()),tt_real1,TJ,0)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
endfunction


function Pitlord_Rift_Remove takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local unit u = LoadUnitHandle(MHT,GetHandleId(t),0)
  
  call UnitRemoveAbility(u,'A2MB')
  call UnitAddAbility2(u,'A2MB')
  
  call Timer_End(t)
  
  set t = null
  set u = null
endfunction

function Pitlord_Rift_Stop takes unit u returns nothing
  local timer t = CreateTimer()
  
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,0,false,function Pitlord_Rift_Remove)
  
  set t = null
endfunction

function DarkRiftFilter takes nothing returns boolean
  return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and IsPlayerBelongToTeams(GetOwningPlayer(GetFilterUnit()))
endfunction

function GDG takes unit Source,unit Target returns nothing
  local group g=GetAvailableGroup()
  local player p = GetOwningPlayer(Source)
  local real x1 = GetWidgetX(Source)
  local real y1 = GetWidgetY(Source)
  local real x2 = GetWidgetX(Target)
  local real y2 = GetWidgetY(Target)
  
  call DestroyEffect(AddSpecialEffect("Doodads\\Cinematic\\ShimmeringPortal\\ShimmeringPortal.mdl",x1,y1))
  call DestroyEffect(AddSpecialEffect("Doodads\\Cinematic\\ShimmeringPortal\\ShimmeringPortal.mdl",x2,y2))
  set tt_real1=x2
  set TJ=y2
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x1,y1,475,Condition(function DarkRiftFilter))
  call ForGroup(g,function G9G)
  call KillGroup(g)
  
  call UnitRemoveAbility(Source,'A2MB')
  call SetPlayerAbilityAvailable2(p,'A2MB',false)
  call SetPlayerAbilityAvailable2(p,'A0R0',true)
  
  set g=null
  set p=null
endfunction

function GEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local player p = GetOwningPlayer(Source)
  local boolean b = GetSpellAbilityId()=='A2MB'
  
  if IsDead(Target) or IsDead(Source) or Target==null or Source==null or b then
    if b then
      call Pitlord_Rift_Stop(Source)
    else
      call Error(p,GetObjectName('n03F'))
    endif
    
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call UnitRemoveType(Target,UNIT_TYPE_PEON)
    call SetPlayerAbilityAvailable2(p,'A2MB',false)
    call SetPlayerAbilityAvailable2(p,'A0R0',true)
    
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
    
    set t=null
    set Source=null
    set Target=null
    return false
  endif
  
  if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call GDG(Source,Target)
  endif
  
  set t=null
  set Source=null
  set Target=null
  set p=null
  return false
endfunction

function GFG takes nothing returns boolean
  local real d
  if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))==false or GetUnitAbilityLevel(GetFilterUnit(),'A04R')>0 or GetOwningPlayer(GetFilterUnit())==Player(15) or IsDead(GetFilterUnit()) then
    return false
  endif
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)or(IsCreep(GetFilterUnit()))then
    set d=DistanceBetweenXY(TJ,RJ,GetUnitX(GetFilterUnit()),GetUnitY(GetFilterUnit()))
    if d<tt_real1 then
      set tt_real1=d
      set tt_unit1=GetFilterUnit()
    endif
  endif
  return false
endfunction

function GGG takes unit Source returns unit
  local group g
  local real x
  local real y
  set x=GetSpellTargetX()
  set y=GetSpellTargetY()
  set g=GetAvailableGroup()
  set tt_unit1=null
  set tt_real1=9999
  set TJ=x
  set RJ=y
  call GroupEnumUnitsInRange(g,x,y,4000,Condition(function GFG))
  call KillGroup(g)
  set g=null
  return tt_unit1
endfunction

function GHG takes unit Source returns nothing
  local trigger t
  local integer h
  local unit Target=GetSpellTargetUnit()
  local real x
  local real y
  local unit u
  if Target==null then
    set Target=GGG(Source)
  endif
  if Target==null then
    call Error(GetOwningPlayer(Source),GetObjectName('n03H'))
    return
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A0R0',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2MB',true)
  call UnitAddAbility2(Source,'A2MB')
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,6-GetUnitAbilityLevel(Source,'A0R0'),false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function GEG))
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\DarkHands.mdl",Target,"overhead"))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call UnitAddType(Target,UNIT_TYPE_PEON)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function G8G))
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call SaveInteger(HY,h,5,GetUnitAbilityLevel(Source,'A0R0'))
  call SaveUnitHandle(HY,h,2,Source)
  set u=CreateUnit(GetOwningPlayer(Source),'h098',GetUnitX(Source),GetUnitY(Source),0)
  call SaveUnitHandle(HY,h,393,u)
  call UnitRemoveAbility(u,'Aloc')
  call ShowUnit(u,false)
  set t=null
  set Target=null
  set u=null
endfunction

function Pitlord_DarkRift_OnCast takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  local unit Hero=GetTriggerUnit()
  if Target!=null then
    if IsUnitEnemy(Target,GetOwningPlayer(Hero)) or IsCreep(Target)==false then
      call InterruptUnit(Hero)
      call Error(GetOwningPlayer(Hero),GetObjectName('n041'))
    endif
  else
    set Target=GGG(Hero)
  endif
  if Target==null then
    call InterruptUnit(Hero)
    call Error(GetOwningPlayer(Hero),GetObjectName('n040'))
  endif
  set Target=null
  set Hero=null
endfunction

function PitLord_DarkRift takes nothing returns nothing
  call GHG(GetTriggerUnit())
endfunction

function Pit_DarkRift_Preload takes nothing returns nothing
  call PreloadUnit('h094')
  call PreloadUnit('h095')
  call PreloadUnit('h096')
endfunction

function Pitlord_Firestorm_Damage takes nothing returns nothing
  local unit t = GetEnumUnit()
  
  if GetUnitAbilityLevel(t,'D009')==1 then
    if IsUnitType(t,UNIT_TYPE_STRUCTURE) then
      call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[0]/2)
    else
      call DamageTarget(group_temp_unit[0],t,1,group_temp_integer[0])
    endif
  endif
  
  set t = null
endfunction

function Pitlord_Firestorm_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  
  if IsUnitEnemy(u,GetOwningPlayer(t)) and IsDead(t)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t))then
    if IsUnitType(t,UNIT_TYPE_STRUCTURE) then
      call DamageTarget(u,t,1,group_temp_integer[0]/2)
    else
      call DamageTarget(u,t,1,group_temp_integer[0])
    endif
    call Buff_Add(t,LoDBuff_AbilID[9],LoDBuff_BuffID[9],2)
    call GroupAddUnit(LoadGroupHandle(MHT,group_temp_integer[1],1),t)
  endif
  
  set u = null
  set t = null
  return false
endfunction

function Pitlord_Firestorm_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer loopA = 0
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local real x = LoadReal(MHT,info,0)
  local real y = LoadReal(MHT,info,1)
  local group g = LoadGroupHandle(MHT,info,1)
  set group_temp_unit[0] = LoadUnitHandle(MHT,info,0)
  set group_temp_integer[0] = LoadInteger(MHT,info,1)
  call ForGroup(g,function Pitlord_Firestorm_Damage)
  call SaveInteger(MHT,info,0,count-1)
  if count>2 then
    set group_temp_integer[0] = LoadInteger(MHT,info,2)
    set group_temp_integer[1] = info
    call GroupEnumUnitsInRange(temp_group,x,y,425,Condition(function Pitlord_Firestorm_Targets))
    if count==3 then
      set t = null
      set g = null
      return
    endif
    loop
      exitwhen loopA == 12
      call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget.mdl",x + GetRandomReal(50,275)*Cos(loopA*30*bj_DEGTORAD),y + GetRandomReal(50,275)*Sin(loopA*30*bj_DEGTORAD)))
      set loopA = loopA + 1
    endloop
  elseif count==1 then
    call KillGroup(g)
    call Timer_End(t)
  endif
  set g = null // no gut :<
  set t = null
endfunction

function Pitlord_Firestorm_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local group g = GetAvailableGroup()
  local integer loopA = 0
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A01I')
  local real x = GetSpellTargetX()
  local real y = GetSpellTargetY()
  
  loop
    exitwhen loopA == 12
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget.mdl",x + GetRandomReal(50,275)*Cos(loopA*30*bj_DEGTORAD),y + GetRandomReal(50,275)*Sin(loopA*30*bj_DEGTORAD)))
    set loopA = loopA + 1
  endloop
  
  call SaveInteger(MHT,info,0,8)
  call SaveInteger(MHT,info,1,level*5)
  call SaveInteger(MHT,info,2,10 + 15*level)
  call SaveReal(MHT,info,0,x)
  call SaveReal(MHT,info,1,y)
  call SaveUnitHandle(MHT,info,0,u)
  call SaveGroupHandle(MHT,info,1,g)
  
  call TimerStart(t,.9,true,function Pitlord_Firestorm_Duration)
  
  set g = null //moar gut :3
  set u = null
  set t = null
endfunction




function Pitlord_Atrophy_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  call LoDStat_Sub(LoadUnitHandle(MHT,info,0),LoadInteger(MHT,info,0),"damage")
  
  call Timer_End(t)
  set t = null
endfunction

function Pitlord_Atrophy_Effect takes unit u, boolean b returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  local integer damage = 5
  local integer lvl=GetUnitAbilityLevel(u,'AIcd')
  if lvl==0 and GetUnitAbilityLevel(u,'QP1C')>0 then
    set lvl=GetUnitAbilityLevel(u,'QP1C')
  endif
  if b then
    set damage = 20
  endif
  
  call SaveUnitHandle(MHT,info,0,u)
  call SaveInteger(MHT,info,0,damage)
  call LoDStat_Add(u,damage,"damage")
  
  call TimerStart(t,lvl*5 + 25,false,function Pitlord_Atrophy_End)
  
  set t = null
endfunction

function Pitlord_Atrophy_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if LoadBoolean(MHT,GetHandleId(t),'AIcd')and IsDead(t)==false and IsUnitEnemy(t,group_temp_player) then
    call Pitlord_Atrophy_Effect(t,IsUnitType(group_temp_unit[0],UNIT_TYPE_HERO))
  endif
  
  set t = null
  return false
endfunction

function Pitlord_Atrophy_Start takes nothing returns boolean
  local unit u = GetTriggerUnit()
  local integer id = GetUnitTypeId(u)
  
  if GetUnitAbilityLevel(u,'A04R')==0 and id!='n0F5' and id!='N0MM' and IsUnitIllusion(u)==false and IsDead(u) then
    set group_temp_player = GetOwningPlayer(u)
    set group_temp_unit[0] = u
    
    call GroupEnumUnitsInRange(temp_group,GetWidgetX(group_temp_unit[0]),GetWidgetY(group_temp_unit[0]),925,Condition(function Pitlord_Atrophy_Targets))
  endif
  
  set u = null
  return false
endfunction

function Pitlord_Atrophy_Init takes nothing returns nothing
  local trigger trig = null
  call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'AIcd',true) // works for both illusions as well :3
  if LoadBoolean(MHT,'AIcd',0)then
    return
  endif
  set trig = CreateTrigger()
  call TriggerRegisterAnyUnitEvent(trig,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(trig, Condition(function Pitlord_Atrophy_Start))
  call SaveBoolean(MHT,'AIcd',0,true)
  set trig = null
endfunction

function HEG takes nothing returns boolean
  return GetUnitAbilityLevel(GetTriggerUnit(),'A06K')>0
endfunction

function HFG takes nothing returns nothing
  if(GetIssuedOrderId()==852177)then
    call UnitAddAbility2(GetTriggerUnit(),'A0AZ')
  endif
  if(GetIssuedOrderId()==852178)then
    call UnitRemoveAbility(GetTriggerUnit(),'A0AZ')
  endif
endfunction

function PG9 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function HEG))
  call TriggerAddAction(t,function HFG)
  set t=null
endfunction

function FleshHeapDistr takes nothing returns nothing
  local unit victim=tt_unit1
  local unit killer=tt_unit2
  local integer i=1
  local integer k=5
  if IsSentinel(GetOwningPlayer(victim)) then
    set i=7
    set k=11
  endif
  loop//A06D
    if IsDead(udg_Hero[i])==false and (DistanceBetweenUnits(victim,udg_Hero[i])<475 or GetPlayerId(GetOwningPlayer(killer))==i) then
      set FleshHeapCount[i]=FleshHeapCount[i]+1
    endif
    set i=i+1
    exitwhen i>k
  endloop
  set killer=null
  set victim=null
endfunction

function HJG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  if GetTriggerEvalCount(t)==1 then
    call ShowUnit(Source,false)
  elseif GetTriggerEvalCount(t)>80 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Rot_Suicide takes unit killer, unit victim returns nothing
  local unit u
  local trigger t
  local integer h
  if GetUnitAbilityLevel(killer,'A06K')>0 then
    if victim==killer then
      set u=CreateUnit(GetOwningPlayer(victim),'h0BB',GetUnitX(victim),GetUnitY(victim),GetUnitFacing(victim))
      call SetUnitTimeScale(u,.75)
      call UnitApplyTimedLife(u,'BTLF',1.)
      call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Undead\\UndeadBlood\\UndeadBloodAbomination.mdl",u,"origin"))
      set u=null
      call SetSoundPosition(SE,GetUnitX(victim),GetUnitY(victim),50)
      call SetSoundVolumeBJ(SE,100)
      call PlaySoundBJ(SE)
      call SetSoundPosition(RE,GetUnitX(victim),GetUnitY(victim),50)
      call SetSoundVolumeBJ(RE,100)
      call PlaySoundBJ(RE)
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterTimerEvent(t,.1,true)
      call TriggerAddCondition(t,Condition(function HJG))
      call SaveUnitHandle(HY,h,2,victim)
      set t=null
    endif
  endif
endfunction

function HMG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local unit Source=(LoadUnitHandle(HY,(GetHandleId(t)),2))
  local integer h=GetHandleId(Source)
  local integer oldbonus=LoadInteger(MHT,h,'A06D')
  local integer lvl=GetUnitAbilityLevel(Source,'QP13')+GetUnitAbilityLevel(Source,'A06D')
  local integer newbonus=R2I(I2R(FleshHeapCount[GetPlayerId(GetOwningPlayer(Source))])*(.5+.5*lvl))
  if Source==null then
    call FlushChildHashtable(HY,GetHandleId(t))
    call CleanTrigger(t)
  endif
  if newbonus>oldbonus then
    call ModifyHeroStat(bj_HEROSTAT_STR,Source,bj_MODIFYMETHOD_ADD,newbonus-oldbonus)
    call SaveInteger(MHT,h,'A06D',newbonus)
    call TextTagOnUnit("+"+I2S(newbonus-oldbonus)+" "+GetObjectName('n0MJ'),3,Source,.023,0,255,0,230)
    if GetUnitPrimaryAttribute(Source)!=3 then
      call SaveInteger(HY,GetHandleId(Source),'axxx',newbonus)
      call BonusDamageSystem(Source)
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function Butcher_FleshHeap_Learn takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer i
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function HMG))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set t=null
endfunction

function Pudge_Hook_BonusPathing takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if IsDead(u)==false then
    call SetUnitPathing(u,true)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set u=null
  set t=null
endfunction

function HTG takes unit Source,unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local unit VCF=CreateUnit(GetOwningPlayer(Source),'e02A',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0PZ')
  call IssueTargetOrderById(Caster,852095,Target)
  call UnitApplyTimedLife(Caster,'BTLF',1)
  call UnitApplyTimedLife(VCF,'BTLF',1)
  set Caster=null
  set VCF=null
endfunction

function HUG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer HVG=(LoadInteger(HY,h,(376)))
  local boolean HWG=(LoadBoolean(HY,h,(377)))
  local unit Target
  local unit HXG=(LoadUnitHandle(HY,h,(2100+HVG)))
  local real x
  local real y
  local trigger tt
  if HWG then
    set Target=(LoadUnitHandle(HY,h,17))
    set x=GetUnitX(HXG)
    set y=GetUnitY(HXG)
    if IsUnitType(Target,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
    endif
    call SetUnitX(Target,x)
    call SetUnitY(Target,y)
  endif
  call RemoveUnit(HXG)
  set HVG=HVG-1
  call SaveInteger(HY,h,(376),(HVG))
  if HVG==0 then
    if (IsTerrainPathableFixed(x,y)==false or IsPointInRegion(RestrictedRegion,x,y)) and IsUnitType(Target,UNIT_TYPE_HERO) then
      set tt=CreateTrigger()
      call SaveUnitHandle(HY,GetHandleId(tt),0,Target)
      call TriggerRegisterTimerEvent(tt,5,false)
      call SetUnitPathing(Target,false)
      call TriggerAddCondition(tt,Condition(function Pudge_Hook_BonusPathing))
      set tt=null
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set HXG=null
  return false
endfunction

function HYG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer HVG=(LoadInteger(HY,h,(376)))
  local integer Level=(LoadInteger(HY,h,5))
  local real a=(LoadReal(HY,h,(13)))
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local trigger RPE=(LoadTriggerHandle(HY,h,(11)))
  local integer RME=GetHandleId(RPE)
  local group g
  local unit u
  local real x
  local real y
  local real z
  local integer hp=GetHandleId(GetOwningPlayer(Hero))
  if HVG<20+2.5*Level then
    set HVG=HVG+1
    call SaveInteger(HY,h,(376),(HVG))
    set x=GetUnitX(Hero)+HVG*40*Cos(a*bj_DEGTORAD)
    set y=GetUnitY(Hero)+HVG*40*Sin(a*bj_DEGTORAD)
    call SaveUnitHandle(HY,(RME),(2100+HVG),(CreateUnit(GetOwningPlayer(Hero),'u00H',x,y,a)))
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,125,Condition(function DG9))
    call GroupRemoveUnit(g,Hero)
    if GetUnitTypeId(Hero)=='e00E' then
      call GroupRemoveUnit(g,udg_Hero[GetPlayerId(GetOwningPlayer(Hero))])
    endif
    set u=GroupPickRandomUnit(g)
    call KillGroup(g)
    if u!=null then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call TriggerRegisterTimerEvent(RPE,.03,true)
      call TriggerAddCondition(RPE,Condition(function HUG))
      call SaveInteger(HY,(RME),(376),(HVG))
      call SaveBoolean(HY,(RME),(377),(true))
      call SaveUnitHandle(HY,(RME),17,(u))
      if IsUnitEnemy(u,GetOwningPlayer(Hero))then
        if IsUnitType(u,UNIT_TYPE_HERO) then
          call SaveInteger(HeroStats,hp,'HK_H',LoadInteger(HeroStats,hp,'HK_H')+1)
          call Traffic_RegisterData("HA_Hits"+I2S(GetPlayerId(GetOwningPlayer(Hero))),LoadInteger(HeroStats,hp,'HK_H'))
          call AddTimedKeyToUnit(Hero,4400,1.5)
        endif
        call HTG(Hero,u)
        if IsMagicImmune(u) then
          call DamageTarget(Hero,u,9,90*Level)
        else
          call DamageTarget(Hero,u,3,90*Level)
        endif
        call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",u,"origin"))
      endif
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call TriggerRegisterTimerEvent(RPE,.03,true)
    call TriggerAddCondition(RPE,Condition(function HUG))
    call SaveInteger(HY,(RME),(376),(HVG))
    call SaveBoolean(HY,(RME),(377),(false))
  endif
  set t=null
  set Hero=null
  set RPE=null
  set g=null
  set u=null
  return false
endfunction

function Pudge_MeatHook takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
  local integer Level=GetUnitAbilityLevel(Hero,'A06I')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer hp=GetHandleId(GetOwningPlayer(Hero))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveInteger(HY,h,(376),(0))
  call SaveTriggerHandle(HY,h,(11),(CreateTrigger()))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function HYG))
  call SaveInteger(HeroStats,hp,'HK_T',LoadInteger(HeroStats,hp,'HK_T')+1)
  call Traffic_RegisterData("HA_Total"+I2S(GetPlayerId(GetOwningPlayer(Hero))),LoadInteger(HeroStats,hp,'HK_T'))
  set Hero=null
  set t=null
endfunction

function HCG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local real Damage=(75+50*Level)+GetHeroMainStatValue(Source)
  local integer Count=(LoadInteger(HY,h,(34)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and GetSpellAbilityId()=='A1CX')then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  elseif GetTriggerEvalCount(t)>7 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call InterruptUnit(Source)
  else
    if Level>0 then
      set Count=Count+1
      if(Count<4 and IsUnitType(Target,UNIT_TYPE_HERO))or(Count<8 and IsUnitType(Target,UNIT_TYPE_HERO)==false)then
        call SetWidgetLife(Source,GetWidgetLife(Source)+Damage)
        call DamageTarget(Source,Target,1,Damage)
      endif
      call SaveInteger(HY,h,(34),(Count))
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function H3G takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A1CX')
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function HCG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(34),(0))
  call TriggerEvaluate(t)
  set t=null
  set Source=null
  set Target=null
endfunction

function Pudge_Dismember takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call H3G()
  endif
endfunction

function HealNetherWard takes unit ward,real for returns nothing
  local real maxlife=GetUnitState(ward,UNIT_STATE_MAX_LIFE)
  local real curlife=GetWidgetLife(ward)
  if for>0 then
    if for>(maxlife-curlife)then
      if for>=curlife then
        call SetWidgetLife(ward,maxlife)
        call HealUnitFor(ward,for-(maxlife-curlife))
      else
        call HealUnitFor(ward,for)
      endif
    else
      call SetWidgetLife(ward,GetWidgetLife(ward)+for)
    endif
  endif
endfunction

function Oblivion_NetherWard_DmgBlock takes nothing returns nothing
  local real dmg=.25
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if IsUnitType(GetEventDamageSource(),UNIT_TYPE_HERO)==false then
      call HealNetherWard(GetTriggerUnit(),GetEventDamage()-0.25)
    else
      call HealNetherWard(GetTriggerUnit(),GetEventDamage()-1)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
    call CleanTrigger(GetTriggeringTrigger())
  endif
endfunction

function H1G takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,GetSummonedUnit(),EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,GetSummonedUnit(),EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Oblivion_NetherWard_DmgBlock))
  call SetUnitAbilityLevel(GetSummonedUnit(),'A08T',GetUnitAbilityLevel(GetSummoningUnit(),'A09D'))
  call SetUnitAbilityLevel(GetSummonedUnit(),'A0CF',GetUnitAbilityLevel(GetSummoningUnit(),'A09D'))
  call IssueImmediateOrderById(GetSummonedUnit(),852512)
  set t=null
endfunction

function HLG takes nothing returns boolean
  return(GetUnitTypeId(GetSummonedUnit())=='o00L')or(GetUnitTypeId(GetSummonedUnit())=='o00M')or(GetUnitTypeId(GetSummonedUnit())=='o00N')or(GetUnitTypeId(GetSummonedUnit())=='o00O')
endfunction

function Oblivion_Ward_Summon takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function HLG))
  call TriggerAddAction(t,function H1G)
  set t=null
endfunction

function Oblivion_LifeDrain_Duration takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local real lvl=LoadInteger(HY,h,0)
  local boolean isAgh=LoadBoolean(HY,h,0)
  local real suck=0
  local real targetsMana=0
  if GetUnitAbilityLevel(u,'Bdcl')==0 or (GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and(GetSpellAbilityId()=='A0CC' or GetSpellAbilityId()=='A02Z')) then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if isAgh then
      set suck=30+15*lvl
    else
      set suck=20+10*lvl
    endif
    if (GetWidgetLife(u)+suck>=GetUnitState(u,UNIT_STATE_MAX_LIFE))then
      call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+suck)
    endif
  endif
  set u=null
  set target=null
  set t=null
endfunction


function Oblivion_LifeDrain_Start takes nothing returns nothing
  local unit u
  local unit target
  local trigger t
  local integer h
  local boolean isAgh
  if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO)then
    set isAgh=GetSpellAbilityId()=='A02Z'
    set t=CreateTrigger()
    set h=GetHandleId(t)
    set target=GetSpellTargetUnit()
    set u=GetTriggerUnit()
    call TriggerRegisterTimerEvent(t,0.25,true)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
    call SaveInteger(HY,h,0,GetUnitAbilityLevel(u,GetSpellAbilityId()))
    call SaveBoolean(HY,h,0,isAgh)
    call SaveUnitHandle(HY,h,0,u)
    call SaveUnitHandle(HY,h,1,target)
    call TriggerAddCondition(t,Condition(function Oblivion_LifeDrain_Duration))
  endif
  set t=null
  set target=null
  set u=null
endfunction

function Oblivion_Decripify_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit target=(LoadUnitHandle(HY,h,17))
  call SetUnitVertexColor(target,255,255,255,255)
  call DestroyEffect((LoadEffectHandle(HY,h,(32))))
  call UnitRemoveAbility(target,'A30D')
  call UnitRemoveAbility(target,'A30E')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set target=null
  return false
endfunction

function DecrepifyBonusDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetUnitAbilityLevel(u,'B01N')==0 or IsDead(u) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call UnitRemoveAbility(u,LoadInteger(HY,h,0))
    call FlushChildHashtable(HY,h)
    call UnitRemoveAbility(u,'A44I')
    call UnitRemoveAbility(u,'B0HM')
  endif
  set u=null
  set t=null
endfunction

function DecrepifyBonus takes unit caster, unit target returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local integer id
  local integer id2
  if IsPlayerAlly(GetOwningPlayer(caster),GetOwningPlayer(target)) then
    set id='A43W'
    set id2='A30D'
    call UnitAddAbility2(target,'A44I')
  else
    set id='A43X'
    set id2='A30E'
  endif
  call TimerStart(t,0.1,true,function DecrepifyBonusDur)
  call SaveUnitHandle(HY,h,0,target)
  call SaveInteger(HY,h,0,id)
  call UnitAddAbility2(target,id)
  call UnitMakeAbilityPermanent(target,true,id2)
  set t=null
endfunction

function Oblivion_Decripify_Act takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)
  local integer lvl=GetUnitAbilityLevel(caster,'A2TD')
  local trigger t
  local integer h
  call UnitAddAbility(dummy,'A0CE')
  call SetUnitAbilityLevel(dummy,'A0CE',lvl)
  call IssueTargetOrder(dummy,"banish",target)
  if GetUnitTypeId(target)=='n0FJ' or GetUnitTypeId(target)=='n0FI' or GetUnitTypeId(target)=='n0F6' or GetUnitTypeId(target)=='n0FH' then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,1.5+0.5*lvl,false)
    call TriggerRegisterDeathEvent(t,target)
    call TriggerAddCondition(t,Condition(function Oblivion_Decripify_Duration))
    call SaveUnitHandle(HY,h,17,(target))
    call SetUnitVertexColor(target,50,255,50,150)
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffect("Abilities\\Spells\\Undead\\Cripple\\CrippleTarget.mdl",GetUnitX(target),GetUnitY(target))))
    set t=null
  else
    call DecrepifyBonus(caster,target)
  endif
  set caster=null
  set target=null
  set dummy=null
endfunction

function Oblivion_Decripify_OnCast takes nothing returns nothing
  local unit u=GetSpellTargetUnit()
  if not ((IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and IsMagicImmune(u)==false)or GetUnitTypeId(u)=='n0FJ' or GetUnitTypeId(u)=='n0FI' or GetUnitTypeId(u)=='n0F6' or GetUnitTypeId(u)=='n0FH') then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Invalid Target")
  endif
  set u=null
endfunction

function H0G takes unit Source,unit Target returns nothing
  local real H5G=20+40*KE8
  local real E29=70+30*KE8
  local real DV9=H5G+(E29-H5G)*KG8/ 700
  call DamageTarget(Source,Target,1,DV9)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",Target,"chest"))
endfunction

function H2G takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local group HND=KD8
  local unit Source=KF8
  if IsUnitInGroup(Target,HND)==false then
    call GroupAddUnit(HND,Target)
    call H0G(Source,Target)
  endif
  set Target=null
  set HND=null
  set Source=null
endfunction

function I4G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local group HND=LoadGroupHandle(HY,h,133)
  local effect fx
  local integer Count=GetTriggerEvalCount(t)
  local real x
  local real x0=GetUnitX(Source)
  local real y
  local real y0=GetUnitY(Source)
  local integer i
  local integer d
  local group g=GetAvailableGroup()
  call SetUnitX(Caster,GetUnitX(Source))
  call SetUnitY(Caster,GetUnitY(Source))
  set KD8=HND
  set KF8=Source
  set KE8=LoadInteger(HY,h,0)
  if Count>20 then
    set d=21*36+(20-Count)*36
    set KG8=d
    set i=0
    loop
      exitwhen i>36
      set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
      set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,100,Condition(function LA8))
      call ForGroup(g,function H2G)
      set i=i+1
    endloop
  else
    set d=Count*36
    set KG8=d
    set i=0
    loop
      exitwhen i>36
      set x=x0+d*Cos(360*i/ 36*bj_DEGTORAD)
      set y=y0+d*Sin(360*i/ 36*bj_DEGTORAD)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,100,Condition(function LA8))
      call ForGroup(g,function H2G)
      set i=i+1
    endloop
  endif
  call KillGroup(g)
  if Count==40 then
    call KillUnit(Caster)
    call KillGroup(HND)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif Count==20 then
    call GroupClear(HND)
    set fx=null
  endif
  set t=null
  set Caster=null
  set HND=null
  set Source=null
  set g=null
  return false
endfunction

function Razor_PlasmaField takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h092',x,y,0)
  local integer i=0
  local integer AUD=36
  local group HND=GetAvailableGroup()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",Hero,"origin"))
  call SaveGroupHandle(HY,h,133,HND)
  call SaveUnitHandle(HY,h,2,Hero)
  call SaveUnitHandle(HY,h,19,Caster)
  call TriggerRegisterTimerEvent(t,.06,true)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  call TriggerAddCondition(t,Condition(function I4G))
  set t=null
  set Caster=null
  set Hero=null
  set HND=null
endfunction

function I9G takes integer IDG returns boolean
  return IDG!='A09V' and IDG!='A026' and IDG!='A0LZ' and IDG!='A0OI' and IDG!='A0DY' and IDG!='A1WB' and IDG!='AHfa'
endfunction

function IEG takes unit WH8,unit Source,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(WH8),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  call UnitAddAbility2(Caster,'A1AK')
  call SetUnitAbilityLevel(Caster,'A1AK',Level)
  call IssueTargetOrderById(Caster,852119,Target)
  call UnitAddAbility2(Caster,'A18D')
  call SetUnitAbilityLevel(Caster,'A18D',Level)
  call IssueTargetOrderById(Caster,852111,Target)
  set Caster=null
endfunction

function IFG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level
  if GetSpellTargetUnit()==Source and I9G(GetSpellAbilityId()) and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Source))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    set Level=GetUnitAbilityLevel(Source,'P283') //A1E6
    call IEG(Source,Source,GetTriggerUnit(),Level)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Razor_UnstableCurrent_Learn takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function IFG))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set t=null
endfunction

function Razor_Link_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer i = LoadInteger(MHT,info,1)
  
  call LoDStat_Sub(LoadUnitHandle(MHT,info,1),i,"damageneg")
  call LoDStat_Sub(LoadUnitHandle(MHT,info,0),i,"damage")
  
  call Timer_End(t)
  set t = null
endfunction

function Razor_Link_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0) + 1
  local integer amount = LoadInteger(MHT,info,1)
  local unit u1 = LoadUnitHandle(MHT,info,0)
  local unit u2 = LoadUnitHandle(MHT,info,1)
  local unit dummy=LoadUnitHandle(MHT,info,33)
  local real x2 = GetWidgetX(u2)
  local real y2 = GetWidgetY(u2)
  local real x1 = GetWidgetX(u1)
  local real y1 = GetWidgetY(u1)
  
  if count==320 or IsDead(u1) or IsDead(u2) or SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))>700 then
    call DestroyLightning(LoadLightningHandle(MHT,info,2))
    call Buff_Add(u1,LoDBuff_AbilID[23],LoDBuff_BuffID[23],18)
    call Buff_Add(u2,LoDBuff_AbilID[24],LoDBuff_BuffID[24],18)
    call TimerStart(t,18,false,function Razor_Link_End)
    call RemoveUnit(dummy)
    set u2 = null
    set u1 = null
    set t = null
    set dummy=null
    return
  endif
  
  call SaveInteger(MHT,info,0,count)
  call MoveLightning(LoadLightningHandle(MHT,info,2),false,x1,y1,x2,y2)
  call SetUnitPosition(dummy,GetUnitX(u2),GetUnitY(u2))
  if count/40 == count/40. then
    set count = LoadInteger(MHT,info,2)
    set amount = amount + count
    call LoDStat_Add(u2,count,"damageneg")
    call LoDStat_Add(u1,count,"damage")
    
    call SaveInteger(MHT,info,1,amount)
  endif
  set dummy=null
  set u2 = null
  set u1 = null
  set t = null
endfunction

function Razor_Link_Start takes nothing returns nothing
  local lightning l = null
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local unit d = GetSpellTargetUnit()
  local integer info = GetHandleId(t)
  local integer i
  local unit dummy
  
  //check for mulitcast
  if GetUnitTypeId(u)=='e00E'then
    set u = udg_Hero[GetPlayerId(GetOwningPlayer(u))]
  else
    set dummy=CreateUnit(GetOwningPlayer(u),'h088',GetUnitX(d),GetUnitY(d),0)
  endif
  
  set l = AddLightning("CLSB",true,GetWidgetX(u),GetWidgetY(u),GetWidgetX(d),GetWidgetY(d))
  set i = 7*GetUnitAbilityLevel(u,'A1DP')
  
  call SetLightningColor(l,0.3,0.5,1,1)
  
  call SaveUnitHandle(MHT,info,0,u)
  call SaveUnitHandle(MHT,info,1,d)
  call SaveUnitHandle(MHT,info,33,dummy)
  call SaveLightningHandle(MHT,info,2,l)
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,i)
  call SaveInteger(MHT,info,2,i)
  
  call LoDStat_Add(d,i,"damageneg")
  call LoDStat_Add(u,i,"damage")
  
  call TimerStart(t,0.025,true,function Razor_Link_Duration)
  
  set d = null //dult :3
  set u = null
  set l = null
  set t = null
  set dummy=null
endfunction





function ISG takes integer h returns nothing
  local integer i=1
  local integer JBE=LoadInteger(HY,h,136)
  local unit Target
  if JBE==0 then
    return
  endif
  loop
    exitwhen i>JBE
    set Target=LoadUnitHandle(HY,h,2200+i)
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[0])
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[1])
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[2])
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[3])
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[4])
    call UnitRemoveAbility(Target,Razor_EyeOfStormContainers[5])
    set i=i+1
  endloop
  set Target=null
endfunction

function ITG takes unit Target,integer h returns nothing
  local integer JBE=LoadInteger(HY,h,136)
  set JBE=JBE+1
  call SaveInteger(HY,h,136,JBE)
  call SaveUnitHandle(HY,h,2200+JBE,Target)
endfunction

function IUG takes unit u returns integer
  return GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[0])*1+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[1])*2+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[2])*4+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[3])*8+GetUnitAbilityLevel(u,Razor_EyeOfStormContainers[4])*16
endfunction

function IVG takes unit u,integer d returns nothing
  local integer array b
  local integer a=d
  local integer c=1
  local integer i=0
  local integer E29
  if d<1 then
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[0])
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[1])
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[2])
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[3])
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[4])
    call UnitRemoveAbility(u,Razor_EyeOfStormContainers[5])
    return
  endif
  loop
    exitwhen c==0
    set c=a/ 2
    set b[i]=a-c*2
    set a=c
    set i=i+1
  endloop
  set E29=i
  set i=0
  loop
    exitwhen i>E29
    if b[i]==1 then
      call UnitAddAbility2(u,Razor_EyeOfStormContainers[i])
    else
      call UnitRemoveAbility(u,Razor_EyeOfStormContainers[i])
    endif
    set i=i+1
  endloop
endfunction

function IWG takes unit u,integer d returns nothing
  if IsUnitType(u,UNIT_TYPE_STRUCTURE)==false then
    call IVG(u,d+IUG(u))
    call ITG(u,KO8)
  endif
endfunction

function IXG takes unit Source,unit Caster,unit Target,integer Level returns nothing
  call IssueTargetOrderById(Caster,852119,Target)
  call DamageTarget_Delayed(Source,Target,2,(50+25*Level)/ 2,.3)
  call IWG(Target,1)
endfunction

function IYG takes nothing returns boolean
  if(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))and GetUnitTypeId(GetFilterUnit())!='n00L' then
    if GetWidgetLife(GetFilterUnit())<KN8 then
      set KN8=GetWidgetLife(GetFilterUnit())
      set KM8=GetFilterUnit()
    endif
  endif
  return false
endfunction

function IZG takes nothing returns boolean
  if(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1))and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false))and GetUnitTypeId(GetFilterUnit())!='emow' and GetUnitTypeId(GetFilterUnit())!='uzig' and GetUnitTypeId(GetFilterUnit())!='n00L' then
    if GetWidgetLife(GetFilterUnit())<KN8 then
      set KN8=GetWidgetLife(GetFilterUnit())
      set KM8=GetFilterUnit()
    endif
  endif
  return false
endfunction

function IAG takes unit Source,unit Caster,integer Level returns nothing
  local group g=GetAvailableGroup()
  set KM8=null
  set KN8=999999
  set tt_unit1=Source
  if GetUnitAbilityLevel(Source,'A1UV')>0 then
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function IZG))
  else
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),525,Condition(function IYG))
  endif
  call KillGroup(g)
  if KM8!=null then
    call IXG(Source,Caster,KM8,Level)
  endif
endfunction

function IBG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=GetTriggerEvalCount(t)
  local integer interval
  local real delay
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call ISG(h)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerUnit()==Source then
      call KillUnit(Caster)
    endif
  else
    if GetUnitAbilityLevel(Source,'A1UV')>0 then
      if Level==1 then
        set delay=0.6
      elseif Level==2 then
        set delay=0.5
      else
        set delay=0.4
      endif
    else
      if Level==1 then
        set delay=0.7
      elseif Level==2 then
        set delay=0.6
      else
        set delay=0.5
      endif
    endif
    set delay=delay/0.05
    if ModuloInteger(Count,R2I(delay))==0 or Count==1 then
      set KO8=h
      call IAG(Source,Caster,Level)
    endif
    call SetUnitX(Caster,GetUnitX(Source))
    call SetUnitY(Caster,GetUnitY(Source))
  endif
  set t=null
  set Source=null
  set Caster=null
  return false
endfunction

function Razor_EyeOfTheStorm takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A1AO')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'h081',GetUnitX(Source),GetUnitY(Source),0)
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A1UV')
  endif
  if GetUnitTypeId(Source)=='e00E' then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  call UnitApplyTimedLife(Caster,'BTLF',30)
  call SetUnitAbilityLevel(Caster,'A1DJ',Level)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function IBG))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  set Source=null
  set Caster=null
  set t=null
endfunction

function Razor_EyeOfStorm_Init takes nothing returns nothing
  set Razor_EyeOfStormContainers[0]='A1DK'
  set Razor_EyeOfStormContainers[1]='A1DL'
  set Razor_EyeOfStormContainers[2]='A1DN'
  set Razor_EyeOfStormContainers[3]='A1DM'
  set Razor_EyeOfStormContainers[4]='A1DO'
endfunction

function I6G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  call SetUnitPosition(Hero,SafeX50(x),SafeY50(y))
  call SetUnitAnimation(Hero,"morph ALTERNATE")
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function SK_Burrowstrike takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A06O')
  local real a
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local real TargetX
  local real TargetY
  local real I1G
  local real I0G
  local real CasterX
  local real CasterY
  local integer CasterAbility
  local unit Caster
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real Damage
  local real DP9=1.65
  local unit D09=null
  if Level==1 then
    set Damage=100
  elseif Level==2 then
    set Damage=160
  elseif Level==3 then
    set Damage=220
  elseif Level==4 then
    set Damage=280
  endif
  if GetSpellTargetUnit()!=null then
    set TargetX=GetUnitX(GetSpellTargetUnit())
    set TargetY=GetUnitY(GetSpellTargetUnit())
  else
    set TargetX=GetSpellTargetX()
    set TargetY=GetSpellTargetY()
  endif
  set a=AngleBetweenXY(x,y,TargetX,TargetY)
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveReal(HY,h,6,((TargetX)*1.))
  call SaveReal(HY,h,7,((TargetY)*1.))
  call TriggerRegisterTimerEvent(t,DistanceBetweenXY(x,y,TargetX,TargetY)/ 2000,false)
  call TriggerAddCondition(t,Condition(function I6G))
  if DistanceBetweenXY(x,y,TargetX,TargetY)<150 then
    set TargetX=x+150*Cos(a*bj_DEGTORAD)
    set TargetY=y+150*Sin(a*bj_DEGTORAD)
  endif
  if GetSpellTargetUnit()!=null and IsBlocked(GetSpellTargetUnit())then
    set D09=GetSpellTargetUnit()
  endif
  call ImpaleFactory(Hero,D09,Damage,DP9,.52,x,y,TargetX,TargetY,175,null,true,1600)
  set Caster=null
  set Hero=null
  set t=null
  set D09=null
endfunction

function I2G takes nothing returns nothing
  local unit d=CreateUnit(GetOwningPlayer(GetEnumUnit()),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
  call UnitAddAbility(d,'A33J')
  call IssueTargetOrderById(d,852095,GetEnumUnit())
  set d=null
  call DamageTarget(KQ8,GetEnumUnit(),1,130)
  call IssueTargetOrderById(KR8,852075,GetEnumUnit())
endfunction

function J4G takes unit Source,real x,real y,integer Level,integer J7G returns nothing
  local group g=GetAvailableGroup()
  local real r
  local string fx
  if J7G==8 then
    set r=675
  elseif J7G==9 then
    set r=700
  elseif J7G==10 then
    set r=725
  else
    set r=250+50*J7G
  endif
  if J7G<4 then
    set fx="war3mapImported\\EpiPulse_1_4.mdx"
  elseif J7G<8 then
    set fx="war3mapImported\\EpiPulse_5_8.mdx"
  else
    set fx="war3mapImported\\EpiPulse_9_12.mdx"
  endif
  call DestroyEffect(AddSpecialEffect(fx,x,y))
  set tt_unit1=Source
  set KQ8=Source
  set KR8=KP8[GetPlayerId(GetOwningPlayer(Source))]
  call GroupEnumUnitsInRange(g,x,y,r,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function I2G)
  call KillGroup(g)
  call BG8(.03,false,x,y,150+100*J7G,150+100*J7G,72,.03,512)
  set g=null
endfunction

function J8G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local player p=LoadPlayerHandle(HY,h,54)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real LastX=LoadReal(HY,h,23)
  local real LastY=LoadReal(HY,h,24)
  local boolean RIE=LoadBoolean(HY,h,15)
  local integer Level=LoadInteger(HY,h,5)
  local integer EZE=LoadInteger(HY,h,25)
  local integer J9G=4+Level*2
  local real x=LastX
  local real y=LastY
  if RIE then
    set J9G=J9G+2
  endif
  if EZE>J9G then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if Hero!=null and IsDead(Hero)==false then
      set x=GetUnitX(Hero)
      set y=GetUnitY(Hero)
    endif
    call J4G(Hero,x,y,Level,EZE)
    call SaveInteger(HY,h,25,EZE+1)
    call SaveReal(HY,h,23,x*1.)
    call SaveReal(HY,h,24,y*1.)
  endif
  set t=null
  set p=null
  set Hero=null
  return false
endfunction

function JDG takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local player p=GetOwningPlayer(Hero)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Hero,'A06R')
  local boolean RIE=false
  if Level==0 then
    set RIE=true
    set Level=GetUnitAbilityLevel(Hero,'A1B4')
  endif
  if IsSentinel(p)then
    set KP8[GetPlayerId(p)]=CreateUnit(Scourges[0],'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  else
    set KP8[GetPlayerId(p)]=CreateUnit(Sentinels[0],'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  endif
  call UnitAddAbility2(KP8[GetPlayerId(p)],'A17B')
  call SaveUnitHandle(HY,h,14,Hero)
  call SavePlayerHandle(HY,h,54,GetOwningPlayer(Hero))
  call SaveReal(HY,h,23,GetUnitX(Hero))
  call SaveReal(HY,h,24,GetUnitY(Hero))
  call SaveInteger(HY,h,5,Level)
  call SaveInteger(HY,h,25,2)
  call SaveBoolean(HY,h,15,(RIE))
  call TriggerRegisterTimerEvent(t,.35,true)
  call TriggerAddCondition(t,Condition(function J8G))
  call J4G(Hero,GetUnitX(Hero),GetUnitY(Hero),Level,1)
  set Hero=null
  set p=null
  set t=null
endfunction

function JEG takes nothing returns boolean
  if GetSpellAbilityId()=='A06R' or GetSpellAbilityId()=='A1B4' then
    call JDG()
  endif
  return false
endfunction

function SK_Epicenter takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_FINISH)
  call TriggerAddCondition(t,Condition(function JEG))
  call PreloadQueryAdd('A17B')
  set t=null
  
endfunction

function CausticFinalTriggered_Filter takes nothing returns boolean
  if (IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(CausticFinal_SK,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))!=null then
    call DamageTarget(CausticFinal_SK,GetFilterUnit(),1,CausticFinal_dmg)
  endif
  return false
endfunction

function CausticFinalVisuals_Clean takes nothing returns nothing
  local timer t=GetExpiredTimer()
  call DestroyEffect(LoadEffectHandle(HY,GetHandleId(t),0))
  call CleanTimer(t)
  set t=null
endfunction

function CausticFinalVisuals takes unit victim returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,1,false,function CausticFinalVisuals_Clean)
  call SaveEffectHandle(HY,GetHandleId(t),0,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\PlagueCloud\\PlagueCloudCaster.mdl",victim,"chest"))
  set t=null
endfunction

function CausticFinalTriggered_Tick takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit victim
  local unit sk
  local integer lvl
  local group g
  local real dmg
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    set sk=LoadUnitHandle(HY,h,0)
    set victim=LoadUnitHandle(HY,h,1)
    set lvl=LoadInteger(HY,h,0)
    set dmg=50+40*lvl// only lvl 4 mismatch
    if lvl==4 then
      set dmg=220
    endif
    set g=GetAvailableGroup()
    set CausticFinal_SK=sk
    set CausticFinal_dmg=dmg
    call DestroyEffect(LoadEffectHandle(HY,h,10))
    call CausticFinalVisuals(victim)
    call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),425,Condition(function CausticFinalTriggered_Filter))
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call RemoveSavedHandle(HY,GetHandleId(victim),'CFNL')
    call RemoveSavedBoolean(HY,GetHandleId(victim),'CFNL')
  elseif GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0)then
      set victim=LoadUnitHandle(HY,h,1)
      call UnitRemoveAbility(victim,'A348')
      call UnitRemoveAbility(victim,'B03F')
      call DestroyEffect(LoadEffectHandle(HY,h,10))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call RemoveSavedHandle(HY,GetHandleId(victim),'CFNL')
      call RemoveSavedBoolean(HY,GetHandleId(victim),'CFNL')
    endif
  else//called to burst
    set sk=LoadUnitHandle(HY,h,0)
    set victim=LoadUnitHandle(HY,h,1)
    set lvl=LoadInteger(HY,h,0)
    set dmg=50+40*lvl// only lvl 4 mismatch
    if lvl==4 then
      set dmg=220
    endif
    set dmg=dmg/2
    set g=GetAvailableGroup()
    set CausticFinal_SK=sk
    set CausticFinal_dmg=dmg
    call CausticFinalVisuals(victim)
    call GroupEnumUnitsInRange(g,GetUnitX(victim),GetUnitY(victim),425,Condition(function CausticFinalTriggered_Filter))
    call KillGroup(g)
  endif
  set t=null
  set sk=null
  set victim=null
endfunction

function CausticFinalTriggered_Apply takes unit sk, unit target returns nothing
  local trigger t
  local integer h
  local integer ht=GetHandleId(target)
  if LoadBoolean(HY,ht,'CFNL')==false then//no caustic final applied yet
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function CausticFinalTriggered_Tick))
    call SaveBoolean(HY,ht,'CFNL',true)//trigger is there
    call SaveTriggerHandle(HY,ht,'CFNL',t)
    call SaveUnitHandle(HY,h,1,target)//victim
    call SaveEffectHandle(HY,h,10,AddSpecialEffectTarget("Abilities\\Spells\\Other\\AcidBomb\\BottleImpact.mdl",target,"chest"))
    call UnitAddAbility2(target,'A348')
    call SaveBoolean(HY,h,0,IsUnitType(sk,UNIT_TYPE_MELEE_ATTACKER))
  else//there are another caustic finale applied
    set t=LoadTriggerHandle(HY,ht,'CFNL')
    set h=GetHandleId(t)
  endif
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+8)//save timestamp where buff should be removed
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(sk,'A0FA')+GetUnitAbilityLevel(sk,'QP16'))//store level
  call SaveUnitHandle(HY,h,0,sk)//store passive's owner
  if (LoadBoolean(HY,h,0) and LoadInteger(HY,h,1)==2) or LoadInteger(HY,h,1)==4 then
    call SaveInteger(HY,h,1,0)
    call TriggerEvaluate(t)
  else
    call SaveInteger(HY,h,1,LoadInteger(HY,h,1)+1)
  endif
  set t=null
endfunction

function JFG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  if((LoadInteger(HY,(GetHandleId((Hero))),((4299))))==1)==false then
    call UnitRemoveAbility(Hero,'B04R')
  endif
  call RemoveUnit((LoadUnitHandle(HY,h,(379))))
  call RemoveUnit((LoadUnitHandle(HY,h,(380))))
  call RemoveUnit((LoadUnitHandle(HY,h,(381))))
  call RemoveUnit((LoadUnitHandle(HY,h,(382))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function JGG takes unit Hero,integer Level,unit JHG,unit JIG,unit JJG,unit JKG returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real DP9=1.5
  
  call SaveInteger(HY,(GetHandleId((Hero))),((4299)),2)
  call TriggerRegisterTimerEvent(t,DP9,false)
  call TriggerAddCondition(t,Condition(function JFG))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveUnitHandle(HY,h,(379),(JHG))
  call SaveUnitHandle(HY,h,(380),(JIG))
  call SaveUnitHandle(HY,h,(381),(JJG))
  call SaveUnitHandle(HY,h,(382),(JKG))
  set t=null
endfunction

function JMG takes nothing returns boolean
  if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
    call DamageTarget(tt_unit1,GetFilterUnit(),1,tt_real1)
  endif
  return false
endfunction

function JNG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit JHG=(LoadUnitHandle(HY,h,(379)))
  local unit JIG=(LoadUnitHandle(HY,h,(380)))
  local unit JJG=(LoadUnitHandle(HY,h,(381)))
  local unit JKG=(LoadUnitHandle(HY,h,(382)))
  local integer Level=GetUnitAbilityLevel(Hero,'A0H0')
  local integer Count=GetTriggerEvalCount(t)
  local group g
  local integer JOG=550
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST or Count>Level*40 then
    call JGG(Hero,Level,JHG,JIG,JJG,JKG)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Hero
    set tt_real1=Level*25/2
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),JOG,Condition(function JMG))
    call KillGroup(g)
  endif
  set t=null
  set Hero=null
  set JHG=null
  set JIG=null
  set JJG=null
  set JKG=null
  set g=null
  return false
endfunction

function SK_Sandstorm takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit JHG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)+150,GetUnitY(Hero)+150,0)
  local unit JIG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)+150,GetUnitY(Hero)-150,0)
  local unit JJG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)-150,GetUnitY(Hero)+150,0)
  local unit JKG=CreateUnit(GetOwningPlayer(Hero),'e00Q',GetUnitX(Hero)-150,GetUnitY(Hero)-150,0)
  local integer Level=GetUnitAbilityLevel(Hero,'A0H0')
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Hero),GetUnitY(Hero),0)
  call UnitAddAbility(JHG,'A45U')
  call UnitAddAbility(JHG,'A45V')
  call UnitAddAbility(JIG,'A45U')
  call UnitAddAbility(JIG,'A45V')
  call UnitAddAbility(JJG,'A45U')
  call UnitAddAbility(JJG,'A45V')
  call UnitAddAbility(JKG,'A45U')
  call UnitAddAbility(JKG,'A45V')
  call SaveInteger(HY,GetHandleId(Hero),4299,1)
  call UnitAddAbility2(Caster,'A0HO')
  call SetUnitAbilityLevel(Caster,'A0HO',Level)
  call IssueTargetOrderById(Caster,852069,Hero)
  call TriggerRegisterTimerEvent(t,0.5,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function JNG))
  call SaveUnitHandle(HY,h,14,(Hero))
  call SaveUnitHandle(HY,h,(379),(JHG))
  call SaveUnitHandle(HY,h,(380),(JIG))
  call SaveUnitHandle(HY,h,(381),(JJG))
  call SaveUnitHandle(HY,h,(382),(JKG))
  call SetUnitTimeScale(JHG,0)
  call SetUnitTimeScale(JIG,0)
  call SetUnitTimeScale(JJG,0)
  call SetUnitTimeScale(JKG,0)
  set t=null
  set Hero=null
  set Caster=null
  set JHG=null
  set JIG=null
  set JJG=null
  set JKG=null
endfunction

function JRG takes nothing returns nothing
  call DamageTarget(KS8,GetEnumUnit(),2,50*KT8)
  call StunTargetLod(GetEnumUnit(),0.5 + KT8 * 1.0 * 0.5)
endfunction

function Slardar_SlithereenCrush takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(Source,GetSpellAbilityId())
  call UnitAddAbility2(Caster,'A0M9')
  call SetUnitAbilityLevel(Caster,'A0M9',Level)
  call IssueImmediateOrderById(Caster,852096)
  set KS8=Source
  set KT8=Level
  call GroupEnumUnitsInRange(g,x,y,350+25,Condition(function LR8))
  call ForGroup(g,function JRG)
  call KillGroup(g)
  set Source=null
  set Caster=null
  set g=null
endfunction

function Slardar_AmplifyDamage_Check takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,0)
  local real time=TimerGetElapsed(GlobalTimer)
  local real limit=LoadReal(MHT,GetHandleId(target),'A034')
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(target,'A310')
    call UnitRemoveAbility(target,'B30Z')
    call FlushChildHashtable(HY,h)
    call RemoveSavedHandle(MHT,GetHandleId(target),'A034')
    call CleanTrigger(t)
  else
    if time>limit then
      call UnitRemoveAbility(target,'A310')
      call UnitRemoveAbility(target,'B30Z')
      call FlushChildHashtable(HY,h)
      call RemoveSavedHandle(MHT,GetHandleId(target),'A034')
      call CleanTrigger(t)
    endif
  endif
  
  set t=null
  set target=null
endfunction

function Slardar_AmplifyDamage takes nothing returns nothing
  local trigger t
  local integer h
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local real duration
  local integer lvl=GetUnitAbilityLevel(caster,GetSpellAbilityId())
  if(IsBlocked(target))then
    set caster=null
    set target=null
    return
  endif
  if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) then
    set duration=30
  else
    set duration=120
  endif
  call SaveReal(MHT,GetHandleId(target),'A034',TimerGetElapsed(GlobalTimer)+duration)
  call UnitAddAbility2(target,'A310')
  call SetPlayerAbilityAvailable(GetOwningPlayer(target),'A310',false)
  call UnitMakeAbilityPermanent(target,true,'A30Y')
  call UnitMakeAbilityPermanent(target,true,'A30Z')
  call SetUnitAbilityLevel(target,'A30Y',lvl)
  call ShareVision(target,caster,'A310')
  call DetectMagicDispell(target,'A310','B30Z')
  if LoadTriggerHandle(MHT,GetHandleId(target),'A304')==null then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function Slardar_AmplifyDamage_Check))
    call SaveUnitHandle(HY,h,0,target)
    call SaveTriggerHandle(MHT,GetHandleId(target),'A034',t)
    set t=null
  endif
  set caster=null
  set target=null
endfunction

function JUG takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,221)
  local unit JVG=LoadUnitHandle(HY,h,383)
  local unit Caster
  local real DP9=LoadReal(HY,h,57)
  local integer Level=LoadInteger(HY,h,0)
  local real JWG=(LoadReal(HY,h,6))
  local real JXG=(LoadReal(HY,h,7))
  local real AO8=GetUnitX(u)
  local real AP8=GetUnitY(u)
  if(AO8-JWG)*(AO8-JWG)+(AP8-JXG)*(AP8-JXG)>900 then
    set Caster=CreateUnit(GetOwningPlayer(JVG),('h002'),GetUnitX(u),GetUnitY(u),0)
    call SetUnitAbilityLevel(Caster,('A0I2'),Level)
    call SetUnitAbilityLevel(Caster,('A0HY'),Level)
    call UnitApplyTimedLife(Caster,'BTLF',7)
    call SaveReal(HY,h,6,((AO8)*1.))
    call SaveReal(HY,h,7,((AP8)*1.))
  endif
  set DP9=DP9+.2
  call SaveReal(HY,h,(57),((DP9)*1.))
  if DP9>7 or GetWidgetLife(u)<1 then
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
  endif
  set t=null
  set u=null
  set JVG=null
  set Caster=null
endfunction

function JYG takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local sound XP8
  local timer t
  local integer h
  call DamageTarget(TmpUnit376,Target,1,TmpReal378)
  
  call GroupAddUnit(TempGroup2,Target)
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    set t=CreateTimer()
    set h=GetHandleId(t)
    set XP8=CreateSound("Sounds\\Spectral Dagger.mp3",false,true,true,10,10,"DefaultEAXON")
    call SetSoundPosition(XP8,GetUnitX(Target),GetUnitY(Target),0)
    call SetSoundDistanceCutoff(XP8,700)
    call StartSound(XP8)
    call KillSoundWhenDone(XP8)
    call SaveUnitHandle(HY,h,(221),(Target))
    call SaveUnitHandle(HY,h,(383),(TmpUnit376))
    call SaveReal(HY,h,6,((GetUnitX(Target))*1.))
    call SaveReal(HY,h,7,((GetUnitY(Target))*1.))
    call SaveInteger(HY,h,0,tt_int1)
    call TimerStart(t,.2,true,function JUG)
  endif
  set Target=null
  set t=null
endfunction

function JZG takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitInGroup(GetFilterUnit(),TempGroup2)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false)!=null
endfunction

function JAG takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group gg=LoadGroupHandle(HY,h,133)
  local group g=GetAvailableGroup()
  local unit Hero=LoadUnitHandle(HY,h,14)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local unit Target=LoadUnitHandle(HY,h,30)
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real SourceX=GetUnitX(Projectile)
  local real SourceY=GetUnitY(Projectile)
  local real angle=Atan2(TargetY-SourceY,TargetX-SourceX)
  local real AO8=SafeX50(GetUnitX(Projectile)+30*Cos(angle))
  local real AP8=SafeY50(GetUnitY(Projectile)+30*Sin(angle))
  local unit Caster
  local integer Level=LoadInteger(HY,h,0)
  if(LoadBoolean(HY,h,384))then
    call SaveBoolean(HY,h,384,false)
    set Caster=CreateUnit(GetOwningPlayer(Hero),'h002',SourceX,SourceY,0)
    call SetUnitAbilityLevel(Caster,'A0I2',Level)
    call SetUnitAbilityLevel(Caster,'A0HY',Level)
    call UnitApplyTimedLife(Caster,'BTLF',12)
  else
    call SaveBoolean(HY,h,384,true)
  endif
  call SetUnitX(Projectile,AO8)
  call SetUnitY(Projectile,AP8)
  call SetUnitFacing(Projectile,angle*bj_RADTODEG)
  set TempGroup2=gg
  set TmpUnit376=Hero
  set TmpReal378=50*Level
  set tt_int1=Level
  call GroupEnumUnitsInRange(g,AO8,AP8,150,Condition(function JZG))
  call ForGroup(g,function JYG)
  call KillGroup(g)
  if(AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY)<1600 then
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call KillUnit(Projectile)
    call KillGroup(gg)
  endif
  set gg=null
  set t=null
  set g=null
  set Hero=null
  set Projectile=null
  set Target=null
  set Caster=null
endfunction

function JBG takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local group gg=(LoadGroupHandle(HY,h,(133)))
  local group g=GetAvailableGroup()
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real SourceX=GetUnitX(Projectile)
  local real SourceY=GetUnitY(Projectile)
  local real angle=(LoadReal(HY,h,(13)))
  local real nX=SafeX50(GetUnitX(Projectile)+30*Cos(angle))
  local real nY=SafeY50(GetUnitY(Projectile)+30*Sin(angle))
  local unit Caster
  local integer Level=LoadInteger(HY,h,0)
  if(LoadBoolean(HY,h,(384)))then
    call SaveBoolean(HY,h,(384),(false))
    set Caster=CreateUnit(GetOwningPlayer(Hero),('h002'),SourceX,SourceY,0)
    call SetUnitAbilityLevel(Caster,('A0I2'),Level)
    call SetUnitAbilityLevel(Caster,('A0HY'),Level)
    call UnitApplyTimedLife(Caster,'BTLF',12)
  else
    call SaveBoolean(HY,h,(384),(true))
  endif
  call SetUnitX(Projectile,nX)
  call SetUnitY(Projectile,nY)
  set TempGroup2=gg
  set TmpUnit376=Hero
  set TmpReal378=50*GetUnitAbilityLevel(Hero,'A0HW')+50
  call GroupEnumUnitsInRange(g,nX,nY,165,Condition(function JZG))
  call ForGroup(g,function JYG)
  call KillGroup(g)
  if(nX-TargetX)*(nX-TargetX)+(nY-TargetY)*(nY-TargetY)<1600 then
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call KillUnit(Projectile)
    call KillGroup(gg)
  endif
  set gg=null
  set t=null
  set g=null
  set Hero=null
  set Projectile=null
  set Caster=null
endfunction

function JCG takes unit XX8,integer ZG8 returns boolean
  return(GetItemTypeId(UnitItemInSlot(XX8,ZG8))=='pspd')or(GetItemTypeId(UnitItemInSlot(XX8,ZG8))=='oflg')
endfunction

function J3G takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real DP9=LoadReal(HY,h,57)
  local integer VT8=0
  loop
    exitwhen VT8>5
    if JCG(Hero,VT8)then
      if GetUnitAbilityLevel(Hero,('B047'))==0 then
        call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),true)
        if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
          call SetItemDroppable(UnitItemInSlot(Hero,VT8),true)
        endif
      else
        call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),false)
        if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
          call SetItemDroppable(UnitItemInSlot(Hero,VT8),false)
        endif
      endif
    endif
    set VT8=VT8+1
  endloop
  set DP9=DP9+.2
  call SaveReal(HY,h,57,DP9*1.)
  if GetUnitAbilityLevel(Hero,('B047'))==0 then
    call SetUnitPathing(Hero,true)
  else
    call SetUnitPathing(Hero,false)
  endif
  if DP9>30 then
    call PauseTimer(t)
    call FlushChildHashtable(HY,h)
    call SetUnitPathing(Hero,true)
    set VT8=0
    loop
      exitwhen VT8>5
      if JCG(Hero,VT8)then
        call SetItemDropOnDeath(UnitItemInSlot(Hero,VT8),true)
        if GetItemTypeId(UnitItemInSlot(Hero,VT8))=='oflg' then
          call SetItemDroppable(UnitItemInSlot(Hero,VT8),true)
        endif
      endif
      set VT8=VT8+1
    endloop
  endif
  set t=null
  set Hero=null
endfunction

function Spectre_SpectralDagger takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real SourceX=SafeX50(GetUnitX(Hero))
  local real SourceY=SafeY50(GetUnitY(Hero))
  local unit Projectile=CreateUnit(GetOwningPlayer(Hero),('h003'),SourceX,SourceY,0)
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local group HND=GetAvailableGroup()
  local real a
  local real TargetX
  local real TargetY
  call SetUnitPathing(Projectile,false)
  call SaveGroupHandle(HY,h,133,HND)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,45,Projectile)
  if Target!=null then
    call SaveUnitHandle(HY,h,30,Target)
    call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
    call TimerStart(t,.035,true,function JAG)
  else
    set TargetX=GetSpellTargetX()
    set TargetY=GetSpellTargetY()
    set a=Atan2(TargetY-SourceY,TargetX-SourceX)
    call SetUnitFacing(Projectile,a*bj_RADTODEG)
    set TargetX=SafeX50(SourceX+2100*Cos(a))
    set TargetY=SafeY50(SourceY+2100*Sin(a))
    call SaveReal(HY,h,47,TargetX*1.)
    call SaveReal(HY,h,48,TargetY*1.)
    call SaveReal(HY,h,13,a*1.)
    call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
    call TimerStart(t,.035,true,function JBG)
  endif
  set t=CreateTimer()
  set h=GetHandleId(t)
  call SetUnitPathing(Hero,false)
  call SaveUnitHandle(HY,h,14,Hero)
  call TimerStart(t,.2,true,function J3G)
  set Hero=null
  set Target=null
  set Projectile=null
  set t=null
  set HND =null
endfunction

function Spectre_Dagger_Preload takes nothing returns nothing
  call CreateSound("Sounds\\Spectral Dagger.mp3",false,false,false,10,10,"DefaultEAXON")
  call PreloadQueryAdd('A0I2')
  call PreloadQueryAdd('A0HY')
endfunction

function Spectre_Desolate_Filter takes nothing returns boolean
  return(IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false)!=null
endfunction

function Spectre_Desolate_act takes unit attacker, unit target returns nothing
  local group g=GetAvailableGroup()
  local real d=0+20*GetUnitAbilityLevel(attacker,'P338')
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),275,Condition(function Spectre_Desolate_Filter))
  call GroupRemoveUnit(g,target)
  if FirstOfGroup(g)==null then
    if IsUnitIllusion(attacker) or IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
      set d=0+10*GetUnitAbilityLevel(attacker,'P338')
      if GetUnitAbilityLevel(attacker,'B06L')>0then
        set d=d*0.75
      endif
    endif
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl",target,"overhead"))
    call AddTimedKeyToUnit(attacker,4275,.3)
    call DamageTarget(attacker,target,3,d)
  endif
  call KillGroup(g)
  set g=null
endfunction

function Spectre_Desolate takes unit attacker, unit target returns nothing
  if IsUnitType(target,UNIT_TYPE_HERO) and GetUnitAbilityLevel(attacker,'P338')+GetUnitAbilityLevel(attacker,'A322')>0 and (IsUnitIllusion(attacker) or IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)) and LoadInteger(HY,GetHandleId(attacker),4275)!=1 then
    call Spectre_Desolate_act(attacker,target)
  endif
endfunction

function Spectre_Dispersion_Spread takes nothing returns nothing
  local real d=DistanceBetweenUnits(GetTriggerUnit(),GetEnumUnit())-25
  local real multiplier=(1000-d)/700
  if multiplier>1. then
    set multiplier=1.
  endif
  if multiplier>0 then
    set WL7[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=true
    call DamageTarget(GetTriggerUnit(),GetEnumUnit(),3,KU8*multiplier)
    set WL7[GetPlayerId(GetOwningPlayer(GetEnumUnit()))]=false
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayDamage.mdl",GetEnumUnit(),"chest"))
  endif
endfunction

function Spectre_Dispersion_Act takes nothing returns boolean
  local unit Hero=GetTriggerUnit()
  local real Damage=GetEventDamage()
  local integer Level=GetUnitAbilityLevel(Hero,'A0NA')+GetUnitAbilityLevel(Hero,'QP20')
  local group g
  if IsDamageReal(Damage) and IsRealDamage and GetUnitAbilityLevel(Hero,'BNdo')==0 then
    set g=GetAvailableGroup()
    if not(Mode_BO) and GetUnitPrimaryAttribute(Hero)==3 then
      set KU8=Damage*(.06+.02*Level)
    else
      set KU8=Damage*(.06+.04*Level)
    endif
    call HealUnitFor(Hero,KU8)
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),1025,Condition(function LR8))
    call ForGroup(g,function Spectre_Dispersion_Spread)
    call KillGroup(g)
  endif
  set Hero=null
  set g=null
  return false
endfunction

function Spectre_Dispersion_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function Spectre_Dispersion_Act))
  set t=null
endfunction

function KDG takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local unit Hero=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call SaveUnitHandle(HY,(GetHandleId(Caster)),(387),(Target))
  call UnitAddAbility2(Caster,('A0N9'))
  call SetUnitAbilityLevel(Caster,('A0N9'),GetUnitAbilityLevel(Hero,'A0H9'))
  call IssueTargetOrderById(Caster,852274,Hero)
  
  set Target = null
  set Caster = null
  set Hero = null
endfunction

function KEG takes nothing returns boolean
  return(IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())))!=null
endfunction

function KFG takes nothing returns nothing
  local trigger trig = GetTriggeringTrigger()
  local integer h=GetHandleId(trig)
  local unit W39=(LoadUnitHandle(HY,h,(386)))
  local unit Target=(LoadUnitHandle(HY,h,(387)))
  local integer KGG=(LoadInteger(HY,h,(385)))
  if GetTriggerEventId()!=EVENT_UNIT_DEATH and GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_POINT_ORDER then
    set KGG=KGG+1
    call SaveInteger(HY,h,(385),(KGG))
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DisableTrigger(GetTriggeringTrigger())
    call FlushChildHashtable(HY,(GetHandleId(trig)))
    call SaveInteger(HY,h,(385),(KGG))
    if Target==GetTriggerUnit()then
      call KillUnit(W39)
    endif
    call CleanTrigger(trig)
  elseif IsUnitPaused(W39)==false then
    if KGG==2 then
      call SetUnitVertexColor(W39,255,255,255,255)
    endif
    if KGG>1 then
      call DisableTrigger(trig)
      call IssueTargetOrderById(W39,851983,Target)
      call EnableTrigger(trig)
    else
      call DisableTrigger(trig)
      call IssueTargetOrderById(W39,851986,Target)
      call EnableTrigger(trig)
    endif
  endif
  
  set Target = null
  set trig = null
  set W39 = null
endfunction

function KHG takes nothing returns boolean
  return GetUnitAbilityLevel(GetSummonedUnit(),'B06L')>0
endfunction

function KIG takes nothing returns nothing
  local unit Caster=GetSummoningUnit()
  local unit W39=GetSummonedUnit()
  local unit Target=LoadUnitHandle(HY,GetHandleId(Caster),387)
  local trigger t=CreateTrigger()
  call SaveUnitHandle(HY,GetHandleId(udg_Hero[GetPlayerId(GetOwningPlayer(Caster))]),7100+GetHandleId(W39),Target)
  call SetUnitPathing(W39,false)
  call SetUnitMoveSpeed(W39,400)
  call SetUnitX(W39,GetUnitX(Target))
  call SetUnitY(W39,GetUnitY(Target))
  call IssueTargetOrderById(W39,851986,Target)
  call SetUnitVertexColor(W39,255,255,255,50)
  call TriggerRegisterUnitEvent(t,W39,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterUnitEvent(t,W39,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,W39,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddAction(t,function KFG)
  call DestroyEffect(AddSpecialEffect("units\\nightelf\\SpiritOfVengeance\\SpiritOfVengeance.mdl",GetUnitX(W39),GetUnitY(W39)))
  call SaveUnitHandle(HY,GetHandleId(t),387,Target)
  call SaveUnitHandle(HY,GetHandleId(t),386,W39)
  call SaveInteger(HY,GetHandleId(t),385,0)
  call FlushChildHashtable(HY,GetHandleId(Caster))
  set Caster=null
  set W39=null
  set Target=null
  set t=null
endfunction

function Spectre_Haunt takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local sound s
  call UnitAddAbility2(GetTriggerUnit(),'A0HA')
  call SetUnitPathing(Hero,false)
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function KEG))
  call ForGroup(g,function KDG)
  call SetUnitPathing(Hero,true)
  if FirstOfGroup(g)!=null then
    set s=CreateSound("Abilities\\Spells\\Other\\ANsa\\SacrificeUnit.wav",false,false,false,10,10,"DefaultEAXON")
    call StartSound(s)
    call KillSoundWhenDone(s)
  endif
  call KillGroup(g)
  set g=null
  set Hero=null
endfunction

function Spectre_AddHaunt takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A0HA')
endfunction

function Spectre_HauntReg takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function KHG))
  call TriggerAddAction(t,function KIG)
  call CreateSound("Abilities\\Spells\\Other\\ANsa\\SacrificeUnit.wav",false,false,false,10,10,"DefaultEAXON")
  call PreloadQueryAdd('A0N9')
  set t = null
  
endfunction

function KOG takes nothing returns boolean
  return GetUnitAbilityLevel(GetFilterUnit(),('B06L'))>0
endfunction

function KPG takes nothing returns nothing
  local unit XX8
  local real YR8=YX8(GetEnumUnit(),GetSpellTargetLoc())
  if YR8<TmpReal378 then
    set TmpUnit376=GetEnumUnit()
    set TmpReal378=YR8
  endif
  set XX8=null
endfunction

function KQG takes nothing returns unit
  local group g=GetAvailableGroup()
  set TmpUnit376=null
  set TmpReal378=9999999
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(GetTriggerUnit()),Condition(function KOG))
  call ForGroup(g,function KPG)
  call KillGroup(g)
  set g=null
  return TmpUnit376
endfunction

function Spectre_Reality_DmgFunc takes nothing returns nothing
  call DamageTarget(RealityTempUnit,GetEnumUnit(),1,GetUnitAbilityLevel(RealityTempUnit,'A0H9')*50+50)
endfunction

function Spectre_Reality_AoEDamage takes unit hero, unit illus returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=hero
  call GroupEnumUnitsInRange(g,GetUnitX(illus),GetUnitY(illus),375,Condition(function DefaultEnemyFilter))
  set RealityTempUnit=hero
  call ForGroup(g,function Spectre_Reality_DmgFunc)
  call KillGroup(g)
  set g=null
endfunction

function Spectre_Reality takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=KQG()
  local unit HYD=(LoadUnitHandle(HY,(GetHandleId(Hero)),(7100+GetHandleId(Target))))
  local real TargetX
  local real TargetY
  if Target==null then
    call Error(GetOwningPlayer(Hero),GetObjectName('n03Z'))
  else
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
    call Spectre_Reality_AoEDamage(Hero,Target)
    call SetUnitX(Hero,TargetX)
    call SetUnitY(Hero,TargetY)
    call KillUnit(Target)
    
    if DistanceBetweenXY(GetCameraEyePositionX(),GetCameraEyePositionY(),GetUnitX(Target),GetUnitY(Target))>1400 then
      call PanCameraToTimedForPlayer(GetOwningPlayer(Hero),TargetX,TargetY,0)
    endif
    call IssueTargetOrderById(Hero,851983,HYD)
  endif
  set Hero=null
  set Target=null
  set HYD=null
endfunction

function Spiritbreaker_GreaterBash_Pushing takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit target=(LoadUnitHandle(HY,h,17))
  local unit caster=(LoadUnitHandle(HY,h,2))
  local real angle=(LoadReal(HY,h,(13)))
  local real x=GetUnitX(target)
  local real y=GetUnitY(target)
  local integer count=GetTriggerEvalCount(t)
  local real dist=LoadReal(HY,h,193)
  local integer limit=(LoadInteger(HY,h,(12)))
  local integer i
  if count>35 then
    call SaveReal(HY,h,193,dist*0.98)
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH or count>limit then
    set i = LoadInteger(MHT,h,'A0G5')-1
    call SaveInteger(MHT,h,'A0G5',i)
    call UnitRemoveAbility(caster,'A24H')
    call UnitRemoveAbility(caster,'B0EC')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\FlakCannons\\FlakTarget.mdl",x,y))
    call KillTrees(x,y,150)
    set x=SafeX50(x+dist*Cos(angle))
    set y=SafeY50(y+dist*Sin(angle))
    if(IsPointInRegion(RestrictedRegion,((x)*1.0),((y)*1.0)))==false then
      if IsUnitType(target,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(target),99,true)
      endif
      call SetUnitX(target,x)
      call SetUnitY(target,y)
    endif
    if count==1 and LoadBoolean(HY,h,0) then
      call IssueTargetOrder(caster,"attack",target)
    endif
  endif
  set t=null
  set target=null
  set caster=null
  return false
endfunction

function Spiritbreaker_Greaterbash_Start takes unit caster, unit target, integer level, boolean attack returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.01,true)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Spiritbreaker_GreaterBash_Pushing))
  call SaveInteger(HY,h,12,80+20*level)//1,1.2,1.4,1.6
  call SaveUnitHandle(HY,h,2,caster)
  call SaveUnitHandle(HY,h,17,target)
  call SaveBoolean(HY,h,0,attack)
  call SaveReal(HY,h,193,2.0)
  call SaveReal(HY,h,13,Atan2(GetUnitY(target)-GetUnitY(caster),GetUnitX(target)-GetUnitX(caster)))
  call UnitAddAbility2(caster,'A24H')
  call DamageTarget(caster,target,1,GetUnitMoveSpeedLOD(caster)*0.1*level)
  call SaveInteger(MHT,GetHandleId(caster),'A0G5',LoadInteger(MHT,GetHandleId(caster),'A0G5')+1)
  set t=null
endfunction

function Spiritbreaker_Greaterbash_Cast takes unit u, unit t, boolean b, integer i returns nothing
  //types: 1=greater bash itself, 2=ulti's strike, 3=charge
  local unit d 
  local integer level
  if GetUnitAbilityLevel(u,'BNdo')>0 then
    return
  endif
  set level=GetUnitAbilityLevel(u,'A0G5')+GetUnitAbilityLevel(u,'QP1X')
  set d=CreateUnit(GetOwningPlayer(t),'e00E',0,0,0)
  if level==0 then
    if i==2 then
      set level=4
    elseif i==3 then
      set level=GetUnitAbilityLevel(u,'A1P8')
    endif
  endif
  call UnitAddAbility(d,'A1WQ')
  call SetUnitAbilityLevel(d,'A1WQ',level)
  
  if IssueTargetOrderById(d,852095,t)then
    call Spiritbreaker_Greaterbash_Start(u,t,level,b)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile_mini.mdl",u,GetProperAttachPoint_Weapon(u)))
  endif
  
  set d = null
endfunction

function GreaterBash_Apply takes unit attacker, unit target returns nothing
  if IsUnitIllusion(attacker)==false and GetUnitTypeId(target)!='n00L' and (Mode_BO or LoadReal(MHT,GetHandleId(attacker),'A0G5')<TimerGetElapsed(GlobalTimer)) then
    if PRD_Get(attacker,'A0G5',17) then
      call SaveReal(MHT,GetHandleId(attacker),'A0G5',TimerGetElapsed(GlobalTimer)+1.5)
      call Spiritbreaker_Greaterbash_Cast(attacker,target,true,1)
    endif
  endif
endfunction

function Spiritbreaker_Charge_Retargets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  local real x1
  local real y1
  local real x2
  local real y2
  local real distance
  
  if IsUnitEnemy(u,GetOwningPlayer(t)) and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitVisible(t,GetOwningPlayer(u)) and IsDead(t)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) and IsMagicImmune(t)==false then
    set u = group_temp_unit[2]
    set x1 = GetWidgetX(u)
    set y1 = GetWidgetY(u)
    set x2 = GetWidgetX(t)
    set y2 = GetWidgetY(t)
    set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
    
    if group_temp_real[0] > distance then
      set group_temp_unit[1] = t
      set group_temp_real[0] = distance
    endif
  endif
  set t = null
  set u = null
  return false
endfunction

function Spiritbreaker_Charge_Retarget takes unit u, unit t, integer i returns boolean
  local string s = ""
  
  set group_temp_unit[0] = u
  set group_temp_unit[1] = null
  set group_temp_unit[2] = t
  set group_temp_real[0] = 99999.0
  
  call GroupEnumUnitsInRange(temp_group,GetWidgetX(t),GetWidgetY(t),4000,Condition(function Spiritbreaker_Charge_Retargets))
  
  if group_temp_unit[1]==null then
    call IssueImmediateOrder(u,"stop")
    return true
  endif
  if group_temp_unit[1]!=null then
    //call UnitShareVision(group_temp_unit[1],GetOwningPlayer(u),true)
    call UnitAddAbility2(group_temp_unit[1],'A315')
    call ShareVision(group_temp_unit[1],u,'A315')
    call SaveUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit"),group_temp_unit[1])
  endif
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(u))or IsObserver(GetLocalPlayer())then
    set s="Abilities\\Spells\\Other\\HowlOfTerror\\HowlTarget.mdl"
  endif
  
  call DestroyEffect(LoadEffectHandle(MHT,i,5))
  call DestroyEffect(LoadEffectHandle(MHT,i,4))
  
  call SaveEffectHandle(MHT,i,4,AddSpecialEffectTarget(s,group_temp_unit[1],"overhead"))
  call SaveEffectHandle(MHT,i,5,AddSpecialEffectTarget(s,group_temp_unit[1],"overhead"))
  
  call SaveUnitHandle(MHT,i,1,group_temp_unit[1])
  //call UnitShareVision(group_temp_unit[2],GetOwningPlayer(u),false)
  call UnitRemoveAbility(group_temp_unit[2],'A315')
  return false
endfunction

function Spiritbreaker_Charge_End takes timer t, unit u, unit target, integer info returns nothing
  call SetUnitTimeScale(u,1)
  call SetUnitPathing(u,true)
  call SetUnitAnimation(u,"stand")
  call SetTint(u,-1,-1,-1,255)
  if LoadUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit"))!=null then
    call UnitRemoveAbility(LoadUnitHandle(MHT,GetHandleId(u),StringHash("ChargedUnit")),'A315')
  endif
  call UnitRemoveAbility(target,'A315')
  call SaveBoolean(MHT,GetHandleId(u),'A1P8',false)
  
  call DestroyEffect(LoadEffectHandle(MHT,info,5))
  call DestroyEffect(LoadEffectHandle(MHT,info,4))
  call DestroyEffect(LoadEffectHandle(MHT,info,3))
  call KillGroup(LoadGroupHandle(MHT,info,2))
  
  call Timer_End(t)
endfunction

function Spiritbreaker_Charge_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  local group g = LoadGroupHandle(MHT,group_temp_integer[0],2)
  
  if IsUnitEnemy(u,GetOwningPlayer(t)) and IsUnitInGroup(t,g)==false and t!=group_temp_unit[1] and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsDead(t)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call GroupAddUnit(g,t)
    call Spiritbreaker_Greaterbash_Cast(u,t,false,3)
  endif
  
  set t = null // reverse gut E:
  set u = null
  set g = null
  return false
endfunction

function Spiritbreaker_Charge_Duration takes nothing returns nothing
  local timer time = GetExpiredTimer()
  local integer info = GetHandleId(time)
  local unit u = LoadUnitHandle(MHT,info,0)
  local unit t = LoadUnitHandle(MHT,info,1)
  local real x1 = GetWidgetX(u)
  local real y1 = GetWidgetY(u)
  local real distance
  local real angle
  local real speed
  local real x2
  local real y2
  if LoadBoolean(MHT,GetHandleId(u),'A1P8')==false  or (IsDead(t) and Spiritbreaker_Charge_Retarget(u,t,info))then
    call Spiritbreaker_Charge_End(time,u,t,info)
    call KillTrees(x1,y1,200)
    set time = null
    set t = null
    set u = null
    return
  endif
  set x2 = GetWidgetX(t)
  set y2 = GetWidgetY(t)
  set speed = LoadReal(MHT,info,0)
  set distance = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
  if 100 > distance then
    call Spiritbreaker_Charge_End(time,u,t,info)
    call IssueTargetOrder(u,"attack",t)
    call SetUnitAnimation(u,"attack")
    call Spiritbreaker_Greaterbash_Cast(u,t,true,3)
    call KillTrees(x1,y1,200)
    set u=CreateUnit(GetOwningPlayer(t),'e00E',GetWidgetX(t),GetWidgetY(t),0)
    call StunTargetLod(u,(0.4*LoadInteger(MHT,info,0))+0.8)
    set time = null
    set t = null
    set u = null
    return
  endif
  set angle = Atan2(y2-y1,x2-x1)
  set group_temp_integer[0] = info
  set x2 = x1 + speed*Cos(angle)
  set y2 = y1 + speed*Sin(angle)
  set group_temp_unit[0] = u
  set group_temp_unit[1] = t
  
  call SetUnitFacing(u,angle*bj_RADTODEG)
  call SetUnitX(u,x2)
  call SetUnitY(u,y2)
  
  call GroupEnumUnitsInRange(temp_group,x2,y2,325,Condition(function Spiritbreaker_Charge_Targets))
  
  set time = null
  set t = null
  set u = null
endfunction

function Spiritbreaker_Charge_Stop takes nothing returns nothing
  local unit target=LoadUnitHandle(MHT,GetHandleId(GetTriggerUnit()),StringHash("ChargedUnit"))
  call SaveBoolean(MHT,GetHandleId(GetTriggerUnit()),'A1P8',false)
  call UnitRemoveAbility(target,'A315')
  set target=null
endfunction

function Spiritbreaker_Charge_Start takes nothing returns nothing
  local timer time = CreateTimer()
  local unit caster = GetTriggerUnit()
  local unit target = GetSpellTargetUnit()
  local integer info = GetHandleId(time)
  local integer save = GetHandleId(caster)
  local integer level = GetUnitAbilityLevel(caster,'A1P8')
  local string s=""
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(caster))or IsObserver(GetLocalPlayer())then
    set s="Abilities\\Spells\\Other\\HowlOfTerror\\HowlTarget.mdl"
    call PingMinimapEx(GetWidgetX(target),GetWidgetY(target),2,255,255,255,false)
  endif
  call SetUnitPathing(caster,false)
  call SetUnitTimeScale(caster,2.5)
  call SetUnitAnimationByIndex(caster,LoadInteger(MHT,GetUnitTypeId(caster),'A1P8'))
  call SetTint(caster,-1,-1,-1,100)
  call UnitAddAbility2(target,'A315')
  call ShareVision(target,caster,'A315')
  
  call SaveBoolean(MHT,save,'A1P8',true)
  
  call SaveUnitHandle(MHT,info,0,caster)
  call SaveUnitHandle(MHT,info,1,target)
  call SaveUnitHandle(MHT,GetHandleId(caster),StringHash("ChargedUnit"),target)
  call SaveGroupHandle(MHT,info,2,GetAvailableGroup())
  call SaveEffectHandle(MHT,info,3,AddSpecialEffectTarget("war3mapImported\\ShockwaveMissilePurple.mdx",caster,"origin"))
  call SaveEffectHandle(MHT,info,4,AddSpecialEffectTarget(s,target,"overhead"))
  call SaveEffectHandle(MHT,info,5,AddSpecialEffectTarget(s,target,"overhead"))
  call SaveInteger(MHT,info,0,level)
  call SaveReal(MHT,info,0,level*1.25 + 13.75)
  
  call TimerStart(time,0.025,true,function Spiritbreaker_Charge_Duration)
  
  set caster = null
  set target = null
  set time = null
endfunction

function Spiritbreaker_Charge_Learn takes nothing returns nothing
  call SetPlayerAbilityAvailable2(GetOwningPlayer(GetTriggerUnit()),'A179',false)
endfunction

function Spiritbreaker_Charge_Init takes nothing returns nothing
  //walking animations
  call SaveInteger(MHT,'H06S','A1P8',11) //kunka
  call SaveInteger(MHT,'H00D','A1P8',0)  //Beastmaster
  call SaveInteger(MHT,'H503','A1P8',5)  //Crabe
  call SaveInteger(MHT,'H000','A1P8',0)  //Centaur
  call SaveInteger(MHT,'Otch','A1P8',1)  //Earthshaker
  call SaveInteger(MHT,'Harf','A1P8',12) //Omniknight
  call SaveInteger(MHT,'Npbm','A1P8',0)  //Panda Brewmaster
  call SaveInteger(MHT,'H001','A1P8',0)  //Sven
  call SaveInteger(MHT,'Ucrl','A1P8',1)  //Tiny, no tree
  call SaveInteger(MHT,'Ucrl','A1P8',8)  //Tiny, with tree
  call SaveInteger(MHT,'O015','A1P8',1)  //Tauren Chieften
  call SaveInteger(MHT,'Hamg','A1P8',8)  //Roof
  call SaveInteger(MHT,'O01F','A1P8',3)  //Wisp
  call SaveInteger(MHT,'N01I','A1P8',4)  //Alchemist, normal
  call SaveInteger(MHT,'N01H','A1P8',15) //Alchemist, chemical rage 1
  call SaveInteger(MHT,'N01T','A1P8',15) //Alchemist, chemical rage 2
  call SaveInteger(MHT,'N01J','A1P8',15) //Alchemist, chemical rage 3
  call SaveInteger(MHT,'H600','A1P8',15) //Alchemist, chemical rage 1
  call SaveInteger(MHT,'H601','A1P8',15) //Alchemist, chemical rage 2
  call SaveInteger(MHT,'H602','A1P8',15) //Alchemist, chemical rage 3
  call SaveInteger(MHT,'H00T','A1P8',0)  //Clockwerk
  call SaveInteger(MHT,'Hlgr','A1P8',6)  //Dragon Knight
  call SaveInteger(MHT,'H00E','A1P8',4)  //Dragon Knight, dragon 1
  call SaveInteger(MHT,'H00F','A1P8',4)  //Dragon Knight, dragon 2
  call SaveInteger(MHT,'H00G','A1P8',4)  //Dragon Knight, dragon 3
  call SaveInteger(MHT,'H00Q','A1P8',17) //Huskar
  call SaveInteger(MHT,'H008','A1P8',1)  //Bristleback
  call SaveInteger(MHT,'E02F','A1P8',5)  //Phoenix
  call SaveInteger(MHT,'E02I','A1P8',12) //Tuskarr
  call SaveInteger(MHT,'E02K','A1P8',0)  //Legion Commander
  call SaveInteger(MHT,'E032','A1P8',6)  //Shredder
  call SaveInteger(MHT,'N0MU','A1P8',0)  //Kaolin
  
  call SaveInteger(MHT,'Edem','A1P8',8)  //antimage
  call SaveInteger(MHT,'Usyl','A1P8',4)  //sniper
  call SaveInteger(MHT,'Nbbc','A1P8',6)  //juggernaut
  call SaveInteger(MHT,'N01O','A1P8',8)  //Syllabear, normal form
  call SaveInteger(MHT,'N013','A1P8',13) //Syllabear, bear form 1
  call SaveInteger(MHT,'N014','A1P8',13) //Syllabear, bear form 2
  call SaveInteger(MHT,'N015','A1P8',13) //Syllabear, bear form 3
  call SaveInteger(MHT,'E005','A1P8',1)  //Luna
  call SaveInteger(MHT,'H0DL','A1P8',1)  //morphling
  call SaveInteger(MHT,'HC49','A1P8',2)  //Siren
  call SaveInteger(MHT,'Ogrh','A1P8',0)  //Phantom Lancer
  call SaveInteger(MHT,'N01V','A1P8',6)  //Potm
  call SaveInteger(MHT,'HC92','A1P8',10) //Riki
  call SaveInteger(MHT,'N016','A1P8',8)  //Troll Warlord, normal form
  call SaveInteger(MHT,'N017','A1P8',8)  //Troll Warlord, melee1
  call SaveInteger(MHT,'QTW2','A1P8',8)  //Troll Warlord, melee2
  call SaveInteger(MHT,'QTW3','A1P8',8)  //Troll Warlord, melee3
  call SaveInteger(MHT,'N02B','A1P8',8)  //Troll Warlord, melee4
  call SaveInteger(MHT,'E02N','A1P8',2)  //gryo, normal form
  call SaveInteger(MHT,'E02O','A1P8',2)  //gryo, barrage form
  call SaveInteger(MHT,'Nbrn','A1P8',8)  //Drow Ranger
  call SaveInteger(MHT,'E01Y','A1P8',2)  //Templar Assassin, dat ass :3
  call SaveInteger(MHT,'Huth','A1P8',0)  //Ursa Warrior
  call SaveInteger(MHT,'Hvwd','A1P8',5)  //Vengeful Spirit	
  call SaveInteger(MHT,'Naka','A1P8',2)  //Bounty Hunter
  call SaveInteger(MHT,'N0M0','A1P8',0)  //Ember Spirit
  
  call SaveInteger(MHT,'H501','A1P8',3)  //Sieger
  call SaveInteger(MHT,'H502','A1P8',10)  //Sorceress
  
  call SaveInteger(MHT,'H500','A1P8',9)  //formless
  
  call SaveInteger(MHT,'Hjai','A1P8',6)  //Crystal Maiden
  call SaveInteger(MHT,'Emoo','A1P8',8)  //Enchantress
  call SaveInteger(MHT,'N00B','A1P8',3)  //Fairie Dragon
  call SaveInteger(MHT,'H00A','A1P8',2)  //Chen
  call SaveInteger(MHT,'Hblm','A1P8',0)  //keeper of the light
  call SaveInteger(MHT,'Hmbr','A1P8',20) //Zeus
  call SaveInteger(MHT,'Emns','A1P8',7)  //Furion
  call SaveInteger(MHT,'N01A','A1P8',1)  //Silencer
  call SaveInteger(MHT,'H004','A1P8',2)  //Lina
  call SaveInteger(MHT,'H00S','A1P8',0)  //Storm
  call SaveInteger(MHT,'N0MU','A1P8',0)  //Kaolin
  call SaveInteger(MHT,'N0EG','A1P8',8)  //Windrunner
  call SaveInteger(MHT,'E02J','A1P8',2)  //Thrall
  call SaveInteger(MHT,'Hmkg','A1P8',11) //Ogre
  call SaveInteger(MHT,'H00K','A1P8',0)  //Techies
  call SaveInteger(MHT,'E00P','A1P8',4)  //Twin Headed Dragon
  call SaveInteger(MHT,'Ntin','A1P8',0)  //Tinker
  if GetRandomReal(0,1)>0.9 then
    call SaveInteger(MHT,'Ntin','A1P8',13) //Tinker, robogobo!
  endif
  call SaveInteger(MHT,'Orkn','A1P8',0)  //Rhasta
  call SaveInteger(MHT,'E02X','A1P8',1)  //Rubick
  call SaveInteger(MHT,'H0DO','A1P8',4)  //Skyhawk
  call SaveInteger(MHT,'NOMD','A1P8',1)  //Oracle
  
  call SaveInteger(MHT,'Opgh','A1P8',6)  //Axe
  call SaveInteger(MHT,'U00A','A1P8',7)  //Chaos Knight
  call SaveInteger(MHT,'UC42','A1P8',1)  //Doombringer
  call SaveInteger(MHT,'U007','A1P8',1)  //Niax
  call SaveInteger(MHT,'Udea','A1P8',0)  //Abaddon
  call SaveInteger(MHT,'U008','A1P8',2)  //Lycan, normal form
  call SaveInteger(MHT,'E015','A1P8',2)  //Lycan, wolf form
  call SaveInteger(MHT,'Udre','A1P8',4)  //Night Stalker
  call SaveInteger(MHT,'N00R','A1P8',3)  //Pit Lord
  call SaveInteger(MHT,'U00F','A1P8',1)  //Pudge
  call SaveInteger(MHT,'NC00','A1P8',2)  //Skeleton King
  call SaveInteger(MHT,'UC91','A1P8',1)  //Slardar
  call SaveInteger(MHT,'H00R','A1P8',1)  //Dirge, normal form
  call SaveInteger(MHT,'H07I','A1P8',8)  //Dirge, flesh golem
  call SaveInteger(MHT,'Ofar','A1P8',1)  //Tide
  call SaveInteger(MHT,'UC11','A1P8',3)  //Magnus
  call SaveInteger(MHT,'O00J','A1P8',2)  //Spirit Breaker
  call SaveInteger(MHT,'U00K','A1P8',1)  //Sandking
  call SaveInteger(MHT,'KODO','A1P8',9)  //KODO
  
  call SaveInteger(MHT,'Hvsh','A1P8',3)  //Bloodseeker
  call SaveInteger(MHT,'E004','A1P8',4)  //Clinkz
  call SaveInteger(MHT,'U006','A1P8',1)  //Broodmother
  call SaveInteger(MHT,'U000','A1P8',13) //Nerubian Assassin
  call SaveInteger(MHT,'Ubal','A1P8',2)  //Nerubian weaver
  call SaveInteger(MHT,'Ewar','A1P8',2)  //Phantom Assassin
  call SaveInteger(MHT,'Nfir','A1P8',2)  //Shadow Fiend
  call SaveInteger(MHT,'Eevi','A1P8',7)  //terrorblade
  call SaveInteger(MHT,'Eevm','A1P8',14) //terrorblade morphed 1
  call SaveInteger(MHT,'E02V','A1P8',14) //terrorblade morphed 2
  call SaveInteger(MHT,'E02W','A1P8',14) //terrorblade morphed 3
  call SaveInteger(MHT,'E02U','A1P8',14) //terrorblade morphed 4
  call SaveInteger(MHT,'E01B','A1P8',1)  //Spectre
  call SaveInteger(MHT,'EC57','A1P8',2)  //Venomancer
  call SaveInteger(MHT,'EC77','A1P8',5)  //Viper
  call SaveInteger(MHT,'H00I','A1P8',1)  //Meepo
  call SaveInteger(MHT,'E002','A1P8',1)  //Razor
  call SaveInteger(MHT,'H071','A1P8',1)  //Night crawler
  call SaveInteger(MHT,'EC45','A1P8',0)  //Faceless Void
  call SaveInteger(MHT,'H00V','A1P8',1)  //Medusa
  call SaveInteger(MHT,'N0MK','A1P8',9)  //Arc Warden
  
  call SaveInteger(MHT,'Oshd','A1P8',5)  //Bane Elemental
  call SaveInteger(MHT,'H00N','A1P8',2)  //Dark Seer
  call SaveInteger(MHT,'UC76','A1P8',2)  //Krobelus
  call SaveInteger(MHT,'UC18','A1P8',0)  //Lion
  call SaveInteger(MHT,'Uktl','A1P8',2)  //Enigma
  call SaveInteger(MHT,'Ulic','A1P8',4)  //Lich
  call SaveInteger(MHT,'U00E','A1P8',6)  //Necro
  call SaveInteger(MHT,'H00H','A1P8',3)  //pugna
  call SaveInteger(MHT,'U00P','A1P8',4)  //Oblivion Destroyer
  call SaveInteger(MHT,'UC01','A1P8',7)  //Queen of Pain
  call SaveInteger(MHT,'E01C','A1P8',5)  //Warlock
  call SaveInteger(MHT,'E02H','A1P8',2)  //Shadow Deamon
  call SaveInteger(MHT,'O016','A1P8',3)  //Batrider
  call SaveInteger(MHT,'O017','A1P8',3)  //Batrider, firefly
  call SaveInteger(MHT,'N01W','A1P8',8)  //Dazzle
  call SaveInteger(MHT,'H00U','A1P8',2)  //Invoker
  call SaveInteger(MHT,'UC60','A1P8',5)  //Visage
  call SaveInteger(MHT,'Ekee','A1P8',2)  //Leshrac
  call SaveInteger(MHT,'E01A','A1P8',8)  //Witch Doctor
  call SaveInteger(MHT,'N0HP','A1P8',9)  //Ancient Apperation
  call SaveInteger(MHT,'N0M7','A1P8',3)  //Winter Wyvern
  call SaveInteger(MHT,'N0MB','A1P8',3)  //Winter Wyvern, flyer 1
  call SaveInteger(MHT,'N0MC','A1P8',3)  //Winter Wyvern, flyer 2
  call SaveInteger(MHT,'N0MO','A1P8',3)  //Winter Wyvern, flyer 3
  call SaveInteger(MHT,'N0MA','A1P8',3)  //Winter Wyvern, flyer 4
endfunction

function Spiritbreaker_EmpoweringHaste_Periodic takes nothing returns nothing
  local integer i=1
  local integer prevbonus
  local integer newbonus
  local unit u
  loop
    set u=udg_Hero[i]
    if GetUnitAbilityLevel(u,'P310')>0 and u!=null and IsDead(u)==false and IsHeroDead[i]==false then
      set prevbonus=LoadInteger(MHT,GetHandleId(u),'P310')
      set newbonus=R2I(0.03*GetUnitAbilityLevel(u,'P310')*GetUnitMoveSpeedLOD(u))
      if prevbonus!=newbonus then
        if prevbonus>newbonus then
          call LoDStat_Sub(u,prevbonus-newbonus,"damage")
          call SaveInteger(MHT,GetHandleId(u),'P310',newbonus)
        else
          call LoDStat_Add(u,newbonus-prevbonus,"damage")
          call SaveInteger(MHT,GetHandleId(u),'P310',newbonus)
        endif
      endif
    endif
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>11
  endloop
  set u=null
endfunction

function Spiritbreaker_EmpoweringHaste takes nothing returns nothing
  call TimerStart(CreateTimer(),0.5,true,function Spiritbreaker_EmpoweringHaste_Periodic)
endfunction

function Spiritbreaker_EmpoweringHaste_PostEnd takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  call UnitRemoveAbility(u,'A44L')
  call UnitRemoveAbility(u,'B03Y')
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'P310',true)
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function Spiritbreaker_EmpoweringHaste_End takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  call UnitRemoveAbility(u,'A44J')
  call UnitRemoveAbility(u,'B03Y')
  call UnitAddAbility(u,'A44L')
  call SetUnitAbilityLevel(u,'A44M',lvl)
  call UnitMakeAbilityPermanent(u,true,'A44M')
  call TimerStart(t,9,false,function Spiritbreaker_EmpoweringHaste_PostEnd)
  set u=null
  set t=null
endfunction

function SBAuraTick2 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call UnitRemoveAbility(u,'A44M')
  call UnitRemoveAbility(u,'B44M')
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function SBAuraTick1 takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call UnitRemoveAbility(u,'A44K')
  call UnitRemoveAbility(u,'B44K')
  if IsDead(u)==false then
    call UnitAddAbility3(u,'A44M',GetUnitAbilityLevel(u,'A0ES'))
    call TimerStart(t,10,false,function SBAuraTick2)
  else
    call FlushChildHashtable(HY,h)
    call DestroyTimer(t)
  endif
  set u=null
  set t=null
endfunction

function Spiritbreaker_EmpoweringHaste_Act takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local unit u=GetTriggerUnit()
  call TimerStart(t,6,false,function SBAuraTick1)
  call SaveUnitHandle(HY,h,0,u)
  call UnitAddAbility3(u,'A44K',GetUnitAbilityLevel(u,'A0ES'))
  set u=null
  set t=null
endfunction

function M7G takes unit Source,unit Target returns nothing
  call Spiritbreaker_Greaterbash_Cast(Source,Target,true,2)
endfunction

function M8G takes nothing returns nothing
  call Spiritbreaker_Greaterbash_Cast(K38,GetEnumUnit(),false,2)
endfunction

function M9G takes unit Source,unit Targer returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set K38=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),275,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function M8G)
  call KillGroup(g)
  set g=null
endfunction

function MDG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Count=GetTriggerEvalCount(t)
  local integer MEG
  local integer Level
  local real a
  local real LastX=(LoadReal(HY,h,(23)))
  local real LastY=(LoadReal(HY,h,(24)))
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local real d=DistanceBetweenXY(x,y,LastX,LastY)
  call SaveReal(HY,h,(23),((x)*1.))
  call SaveReal(HY,h,(24),((y)*1.))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or d>1800 or Count>100 then
    call SetTint(Source,-1,-1,-1,255)
    call UnitRemoveAbility(Target,'A314')
    call UnitRemoveAbility(Source,'A179')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set MEG=50+Count*2
    call SetTint(Source,-1,-1,-1,MEG)
    if Count==1 then
      set Level=(LoadInteger(HY,h,5))
      set a=Atan2(GetUnitY(Target)-GetUnitY(Source),GetUnitX(Target)-GetUnitX(Source))
      call SetUnitPosition(Source,GetUnitX(Target)+80*Cos(a),GetUnitY(Target)+80*Sin(a))
      call SetUnitAnimation(Source,"attack")
      call IssueTargetOrderById(Source,851983,Target)
      if GetUnitAbilityLevel(Source,'A0G4')>0 then
        call M7G(Source,Target)
      else
        call M9G(Source,Target)
      endif
      call DamageTarget(Source,Target,1,50+100*Level)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function MFG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A0G4')
  local boolean b=false
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A1D8')
    set b=true
  endif
  call UnitAddAbility2(Target,'A314')
  call ShareVision(Target,Source,'A314')
  call IssueImmediateOrder(Source,"halt")
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(23),((GetUnitX(Target))*1.))
  call SaveReal(HY,h,(24),((GetUnitY(Target))*1.))
  call TriggerRegisterTimerEvent(t,.01,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function MDG))
  if b then
    call UnitAddAbility2(Source,'A179')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A179',false)
  endif
  set t=null
  set Source=null
  set Target=null
endfunction

function Spiritbreaker_NetherStrike takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call MFG()
  endif
endfunction

function MJG takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real MKG=(LoadReal(HY,h,(295)))
  local real MMG=(LoadReal(HY,h,(296)))
  local integer Level=GetUnitAbilityLevel(Source,'A07Q')
  local real MNG=.33
  if Level==2 then
    set MNG=.28
  elseif Level==3 then
    set MNG=.23
  endif
  if GetSpellTargetUnit()==Source then
    call SetWidgetLife(Source,RMaxBJ(GetUnitState(Source,UNIT_STATE_MAX_LIFE)*MMG*.01,GetUnitState(Source,UNIT_STATE_MAX_LIFE)*MNG))
  endif
  if GetSpellTargetUnit()==Target then
    call SetUnitLifePercentBJ(Target,MKG)
    if GetUnitLifePercent(Target)<25. and Level==1 and GetWidgetLife(Target)>1 then
      call SetUnitLifePercentBJ(Target,25.)
    endif
    if GetUnitLifePercent(Target)<20. and Level==2 and GetWidgetLife(Target)>1 then
      call SetUnitLifePercentBJ(Target,20.)
    endif
    if GetUnitLifePercent(Target)<15. and Level==3 and GetWidgetLife(Target)>1 then
      call SetUnitLifePercentBJ(Target,15.)
    endif
  endif
  if GetTriggerEvalCount(t)==2 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function MOG takes nothing returns boolean
  if GetSpellAbilityId()=='A07R' then
    call MJG()
  endif
  return false
endfunction

function TB_Sunder takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local unit Caster
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(295),((GetUnitLifePercent(Source))*1.))
  call SaveReal(HY,h,(296),((GetUnitLifePercent(Target))*1.))
  call TriggerAddCondition(t,Condition(function MOG))
  set Caster=CreateUnit(GetOwningPlayer(Target),'e00Y',GetUnitX(Target),GetUnitY(Target),0)
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
  call UnitAddAbility2(Caster,'A07R')
  call IssueTargetOrderById(Caster,852095,Source)
  call ShowUnit(Caster,false)
  call SetUnitPathing(Caster,false)
  call SetUnitInvulnerable(Caster,true)
  call UnitApplyTimedLife(Caster,'BTLF',.2)
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00Y',GetUnitX(Source),GetUnitY(Source),0)
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_SPELL_EFFECT)
  call UnitAddAbility2(Caster,'A07R')
  call IssueTargetOrderById(Caster,852095,Target)
  call ShowUnit(Caster,false)
  call SetUnitPathing(Caster,false)
  call SetUnitInvulnerable(Caster,true)
  call UnitApplyTimedLife(Caster,'BTLF',.2)
  set t=null
  set Source=null
  set Target=null
  set Caster=null
endfunction

function Terrorblase_Reflection_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit d = LoadUnitHandle(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,1)
  
  if IsDead(u) or IsDead(d)then
    call DestroyEffect(LoadEffectHandle(MHT,info,2))
    call KillUnit(d)
    call Timer_End(t)
  endif
  
  call IssueTargetOrder(d,"attack",u)
  
  set d = null
  set u = null
  set t = null
endfunction

function Terrorblase_Reflection_Illusion takes nothing returns nothing
  local integer load = GetHandleId(GetTriggerUnit())
  local unit d = GetSummonedUnit()
  local unit u = LoadUnitHandle(MHT,load,0)
  local timer t = LoadTimerHandle(MHT,load,1)
  local integer info = GetHandleId(t)
  call SetUnitMoveSpeed(d,522)
  call UnitAddAbility(d,'Aloc')
  call SetUnitOwner(d,LoadPlayerHandle(MHT,load,2),false)
  call IssueTargetOrder(d,"attack",u)
  call SetUnitX(d,GetWidgetX(u) + 100*Cos(GetRandomReal(-1.8,1.8)))
  call SetUnitY(d,GetWidgetY(u) + 100*Sin(GetRandomReal(-1.8,1.8)))
  
  call SaveUnitHandle(MHT,info,0,d)
  call SaveUnitHandle(MHT,info,1,u)
  call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\UnholyPresence.mdx",u,"overhead"))
  
  call TimerStart(t,0.2,true,function Terrorblase_Reflection_Duration)
  call FlushChildHashtable(MHT,load)
  
  set t = null
  set u = null
  set d = null
endfunction

function Terrorblade_Reflection_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit t = GetSpellTargetUnit()
  local unit d = CreateUnit(GetOwningPlayer(u),'e00E',0,0,0)
  local timer time = CreateTimer()
  local integer info = GetHandleId(d)
  set TempInteger=GetPlayerId(GetOwningPlayer(t))
  call Buff_Add(t,LoDBuff_AbilID[16],LoDBuff_BuffID[16],5)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,d,EVENT_UNIT_SUMMON)
  call SaveUnitHandle(MHT,info,0,t)
  call SaveTimerHandle(MHT,info,1,time)
  call SavePlayerHandle(MHT,info,2,GetOwningPlayer(u))
  call SaveInteger(MHT,info,'SPEL','A24K') //used to detected illusion spells
  call UnitAddAbility(d,'A24K')
  call SetUnitAbilityLevel(d,'A24K',GetUnitAbilityLevel(u,'A2KZ'))
  call IssueTargetOrderById(d,852274,t)
  set time = null //look, not the usual order of nulling :O
  set d = null
  set t = null
  set u = null
endfunction

function TB_SoulSteal_Clear takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local unit d=(LoadUnitHandle(HY,h,(19)))
  local integer lvl=(LoadInteger(HY,h,5))
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)>(28)or IsUnitSilenced(target)or DistanceBetweenUnits(caster,target)>600 or IsUnitVisible(target,GetOwningPlayer(caster))==false then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(d)
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetTriggerEvalCount(t)>1 and GetSpellAbilityId()=='A1RA' then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call UnitRemoveAbility(caster,'A1RA')
      call KillUnit(d)
    endif
  else
    if IsUnitAlly(caster,GetOwningPlayer(target))==false then
      call SetWidgetLife(caster,GetWidgetLife(caster)+lvl*20.0/4.0)
    else
      call SetWidgetLife(target,GetWidgetLife(target)+lvl*20.0/4.0)
    endif
  endif
  set t=null
  set caster=null
  set target=null
  set d=null
  return false
endfunction

function TB_SoulSteal_Moves takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local unit d=(LoadUnitHandle(HY,h,(19)))
  local boolean b=HaveSavedHandle(HY,h,21)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(caster,'A1RA')
    if b then
      call RemoveUnit(LoadUnitHandle(HY,h,21))
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if GetTriggerEvalCount(t)==1 then
      call IssueImmediateOrderById(caster,851993)
    endif
    if IsUnitEnemy(caster,GetOwningPlayer(target)) then
      call SetUnitX(d,GetUnitX(caster))
      call SetUnitY(d,GetUnitY(caster))
      call SetUnitX(LoadUnitHandle(HY,h,21),GetUnitX(target))
      call SetUnitY(LoadUnitHandle(HY,h,21),GetUnitY(target))
    else
      call SetUnitX(d,GetUnitX(target))
      call SetUnitY(d,GetUnitY(target))
    endif
  endif
  set t=null
  set caster=null
  set target=null
  set d=null
  return false
endfunction

function TB_SoulSteal_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer lvl=GetUnitAbilityLevel(caster,'A1PH')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d
  if IsUnitAlly(caster,GetOwningPlayer(target))==false then
    set d=CreateUnit(GetOwningPlayer(caster),'u01G',0,0,0)
    call UnitAddAbility(d,'A04L')
    call SetUnitAbilityLevel(d,'A04L',lvl)
    call SetUnitX(d,GetUnitX(caster))
    call SetUnitY(d,GetUnitY(caster))
    call IssueTargetOrderById(d,852487,target)
  else
    call UnitAddAbility(caster,'A1RA')
    call UnitMakeAbilityPermanent(caster,true,'A1RA')
    set d=CreateUnit(Neutrals,'u01G',0,0,0)
    call SetUnitUserData(d,GetPlayerId(GetOwningPlayer(caster)))
    call UnitAddAbility(d,'A04L')
    call SetUnitAbilityLevel(d,'A04L',lvl)
    call SetUnitX(d,GetUnitX(target))
    call SetUnitY(d,GetUnitY(target))
    call IssueTargetOrderById(d,852487,caster)
  endif
  call TriggerRegisterTimerEvent(t,0.25,true)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function TB_SoulSteal_Clear))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveUnitHandle(HY,h,(19),(d))
  call SaveInteger(HY,h,5,(lvl))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0.01,true)
  call TriggerRegisterUnitEvent(t,d,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function TB_SoulSteal_Moves))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveUnitHandle(HY,h,(19),(d))
  if IsUnitEnemy(target,GetOwningPlayer(caster)) then
    call SaveUnitHandle(HY,h,21,CreateUnit(GetOwningPlayer(caster),'hBST',GetUnitX(target),GetUnitY(target),0))
  endif
  set caster=null
  set target=null
  set t=null
  set d=null
endfunction

function TB_SoulSteal takes nothing returns boolean
  if GetUnitTypeId(GetSpellTargetUnit())!='n00L' and(IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))or(IsBlocked(GetSpellTargetUnit())==false))then
    call TB_SoulSteal_Start()
  endif
  return false
endfunction

function TB_ConjureImage takes nothing returns nothing
  local unit XX8=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(XX8,'A0H4')
  local unit Caster=CreateUnit(GetOwningPlayer(XX8),'e00E',GetUnitX(XX8),GetUnitY(XX8),0)
  if GetUnitTypeId(XX8)=='e00E' then
    set XX8=udg_Hero[GetPlayerId(GetOwningPlayer(XX8))]
  endif
  call UnitAddAbility(Caster,'A2JN')
  call SetUnitAbilityLevel(Caster,'A2JN',Level)
  call IssueTargetOrderById(Caster,852274,XX8)
  set Caster = null
  set XX8 = null
endfunction

function TB_ConjureImage_Leveled takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,'A0H4')
  local integer id='A275'+lvl
  if lvl==1 then
    call UnitAddAbility2(u,'A33N')
  else
    call SetUnitAbilityLevel(u,'A33N',lvl)
    call UnitRemoveAbility(u,id-1)//remove prev hp regen
  endif
  call UnitAddAbility2(u,id)
  set u=null
endfunction

function M5G takes nothing returns nothing
  local unit t=GetSpellTargetUnit()
  local real M2G=(60.+(50.*I2R(GetUnitAbilityLevel(GetTriggerUnit(),'A046'))))
  call DamageTarget(GetTriggerUnit(),t,1,M2G)
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",t,"chest"))
  set t=null
endfunction

function Tidehunter_Gush takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call M5G()
  endif
endfunction

function N4G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=GetEventDamageSource()
  local real d=GetEventDamage()
  local real dmgStored=LoadReal(HY,h,412)
  local real time=LoadReal(HY,h,411)
  local integer lvl=GetUnitAbilityLevel(Source,'QP10')+GetUnitAbilityLevel(Source,'A04E')
  if IsPlayerBelongToTeams(GetOwningPlayer(Target))then
    if(time+6)<(TimerGetElapsed(GlobalTimer))then
      set dmgStored=0
    endif
    set time=TimerGetElapsed(GlobalTimer)
    set dmgStored=dmgStored+d
    if dmgStored>650-50*lvl and GetUnitAbilityLevel(Source,'BNdo')==0 then
      set dmgStored=0
      call RemoveDispellableBuffs(Source)
      call SetNapalmFactory(Source,0,0)
      call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",Source,"origin"))
    endif
    call SaveReal(HY,h,412,dmgStored)
    call SaveReal(HY,h,411,time)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Tidehunter_KrakenShell_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function N4G))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,412,0.0)
  call SaveReal(HY,h,411,TimerGetElapsed(GlobalTimer))
  set t=null
  set Source=null
endfunction

function N9G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(22)))
  call KillGroup(g)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set g=null
  return false
endfunction

function NDG takes group g returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveGroupHandle(HY,h,(22),(g))
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerAddCondition(t,Condition(function N9G))
  set t=null
endfunction

function Tidehunter_Ravage takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Caster
  local integer i=1
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real x2
  local real y2
  local real Damage
  local real DP9
  local integer Level=GetUnitAbilityLevel(Hero,'A29I')
  local group g=GetAvailableGroup()
  local real d=500
  if Level==1 then
    set DP9=1.5
    set Damage=200
  elseif Level==2 then
    set DP9=1.8
    set Damage=290
  elseif Level==3 then
    set DP9=2.25
    set Damage=380
  endif
  loop
    exitwhen i>16
    set x2=x1+(d+3*100)*Cos(22.5*i*bj_DEGTORAD)
    set y2=y1+(d+3*100)*Sin(22.5*i*bj_DEGTORAD)
    call ImpaleFactory(Hero,null,Damage,DP9,.52,x1,y1,x2,y2,250,g,false,775)
    set i=i+1
  endloop
  call NDG(g)
  set Hero=null
  set Caster=null
  set g=null
endfunction

function NGG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  if(LoadReal(HY,GetHandleId(Target),715)<TimerGetElapsed(GlobalTimer))then
    call UnitRemoveAbility(Target,'A228')
    call UnitRemoveAbility(Target,'B0E8')
  endif
  
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set Target=null
  set t=null
  return false
endfunction

function NHG takes unit Target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(Target,'A228')
  call TriggerRegisterDeathEvent(t,Target)
  call TriggerRegisterTimerEvent(t,6,false)
  call TriggerAddCondition(t,Condition(function NGG))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,(GetHandleId(Target)),(715),((5.9+(TimerGetElapsed(GlobalTimer)))*1.))
  set t=null
endfunction

function NIG takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())==false then
    call NHG(GetEnumUnit())
  endif
  call DamageTarget(K18,GetEnumUnit(),2,25+50*K08)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\CrushingWave\\CrushingWaveDamage.mdl",GetEnumUnit(),"chest"))
endfunction

function Tidehunter_AnchorSmash_Filter takes nothing returns boolean
  return(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit())))!=null
endfunction

function Tidehunter_AnchorSmash takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A226')
  set tt_unit1=Source
  set K08=Level
  set K18=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),500,Condition(function Tidehunter_AnchorSmash_Filter))
  call ForGroup(g,function NIG)
  call KillGroup(g)
  set g=null
  set Source=null
endfunction

function NKG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call SetUnitTimeScale(Source,1)
  set t=null
  set Source=null
  return false
endfunction

function Tidehunter_AnhorSmash_OnCast takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.3,false)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerAddCondition(t,Condition(function NKG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SetUnitTimeScale(Source,2)
  set t=null
  set Source=null
endfunction

function NPG takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0)!=null
endfunction

function NQG takes nothing returns nothing
  call DamageTarget(TmpUnit376,GetEnumUnit(),2,TmpReal378)
endfunction

function NRG takes unit Source,unit Target,real Damage returns nothing
  local group g=GetAvailableGroup()
  set TmpUnit376=Source
  set TmpReal378=Damage
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),210,Condition(function NPG))
  call ForGroup(g,function NQG)
  call KillGroup(g)
  set g=null
endfunction

function NSG takes nothing returns boolean
  return(IsUnitInGroup(GetFilterUnit(),TempGroup2)==false and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(TmpUnit376)) and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false and GetFilterUnit()!=K58)!=null
endfunction

function NTG takes group AffectedGroup,unit LastTarget,unit Source,unit OriginalTargetreturns returns unit
  local group g=GetAvailableGroup()
  local unit altu=null
  local unit u
  set TempGroup2=AffectedGroup
  set TmpUnit376=Source
  call GroupEnumUnitsInRange(g,GetUnitX(LastTarget),GetUnitY(LastTarget),500,Condition(function NSG))
  set u=FirstOfGroup(g)
  set altu=u
  loop
    exitwhen u==null
    if GetWidgetLife(u)!=GetUnitState(u,UNIT_STATE_MAX_LIFE)then
      if u!=Source and IsUnitType(u,UNIT_TYPE_HERO) and IsUnitType(altu,UNIT_TYPE_HERO)==false then
        set altu=u
      elseif u!=Source and GetWidgetLife(u)< GetWidgetLife(altu) and IsUnitType(u,UNIT_TYPE_HERO) and IsUnitType(altu,UNIT_TYPE_HERO) then
        set altu=u
      elseif u!=Source and IsUnitType(altu,UNIT_TYPE_HERO)==false and GetWidgetLife(u)< GetWidgetLife(altu)then
        set altu=u
      elseif u==Source then
        set altu=u
      endif
    endif
    call GroupRemoveUnit(g,u)
    set u=FirstOfGroup(g)
  endloop
  call KillGroup(g)
  set g=null
  set u=null
  set TEMPUNIT=altu
  set altu=null
  return TEMPUNIT
endfunction

function Dazzle_ShadowWave takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local string NZG="Abilities\\Spells\\Undead\\ReplenishMana\\ReplenishManaCaster.mdl"
  local string NAG="origin"
  local unit array NBG
  local integer x
  local integer i=1
  local integer Level=GetUnitAbilityLevel(Hero,'A0OR')
  local real Damage=60+Level*20
  local group NUG=GetAvailableGroup()
  local integer limit=Level+2
  local boolean N3G=false
  set K58=Hero
  call SetWidgetLife(Hero,GetWidgetLife(Hero)+Damage)
  call NRG(Hero,Hero,Damage)
  call GroupAddUnit(NUG,Hero)
  call Z48(NZG,Hero,NAG,2)
  if Target==Hero then
    set NBG[i]=NTG(NUG,Hero,Hero,Target)
  else
    set NBG[i]=Target
  endif
  if NBG[i]==null then
    call KillGroup(NUG)
    set Hero=null
    set Target=null
    return
  endif
  call SetWidgetLife(NBG[i],GetWidgetLife(NBG[i])+Damage)
  call NRG(Hero,NBG[i],Damage)
  call GroupAddUnit(NUG,NBG[i])
  call Z48(NZG,NBG[i],NAG,2)
  call ZO8("SPLK",GetUnitX(Hero),GetUnitY(Hero),GetUnitX(NBG[i]),GetUnitY(NBG[i]),.3,.5,.9,1,.7)
  set i=2
  loop
    exitwhen i>limit or N3G
    set NBG[i]=NTG(NUG,NBG[i-1],Hero,Target)
    if NBG[i]==null then
      set N3G=true
    else
      call GroupAddUnit(NUG,NBG[i])
      call Z48(NZG,NBG[i],NAG,2)
      call SetWidgetLife(NBG[i],GetWidgetLife(NBG[i])+Damage)
      call NRG(Hero,NBG[i],Damage)
      call ZO8("SPLK",GetUnitX(NBG[i-1]),GetUnitY(NBG[i-1]),GetUnitX(NBG[i]),GetUnitY(NBG[i]),.3,.5,.9,1,.7)
      set i=i+1
    endif
  endloop
  call KillGroup(NUG)
  set NUG=null
  set Hero=null
  set Target=null
endfunction

function NLG takes unit Source,unit Target,integer Level returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A0NJ')
  call SetUnitAbilityLevel(Caster,'A0NJ',Level)
  call IssueTargetOrderById(Caster,852075,Target)
  set Caster=null
endfunction

function N0G takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  local integer c=GetTriggerEvalCount(t)
  local real Damage=8+6*Level
  local unit Caster=LoadUnitHandle(HY,h,19)
  if GetUnitAbilityLevel(Target,'A0OW')==0 or c > 6 then
    call UnitRemoveAbility(Target,'A0OW')
    call UnitRemoveAbility(Target,'B07I')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DamageTarget(Caster,Target,2,Damage)//8 ticks
    if Level==1 then
      if c <= 3 then
        call NLG(Source,Target,1)
      endif
    elseif Level==2 then
      if c <= 2 then
        call NLG(Source,Target,1)
      elseif c==3 then
        call NLG(Source,Target,2)
      endif
    elseif Level==3 then
      if c <= 3 then
        call NLG(Source,Target,c)
      endif
    else//lvl 4
      if c < 3 then
        call NLG(Source,Target,c)
      elseif c==3 then
        call StunTargetLod(Target,1.0)
      endif
    endif
  endif
  set Caster=null
  set Source=null
  set Target=null
  set t=null
endfunction

function N5Gold takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',GetUnitX(tt_unit2),GetUnitY(tt_unit2),0)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function N0G))
  call SaveUnitHandle(HY,h,2,tt_unit1)
  call SaveUnitHandle(HY,h,17,tt_unit2)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveInteger(HY,h,0,LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),5))
  call UnitAddAbility2(tt_unit2,'A0OW')
  call TriggerEvaluate(t)
  set Caster=null
  set t=null
endfunction

function N5G takes nothing returns nothing
  local trigger t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'e00E',"N5Gold",1300,true)
  call SaveInteger(HY,GetHandleId(t),5,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  set t=null
endfunction

function Dazzle_PoisonTouch takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call N5G()
  endif
endfunction

function Dazzle_PoisonTouch_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0NJ')
  call PreloadQueryAdd('A0NK')
endfunction

function N2G takes nothing returns nothing//weave
  local unit Target=GetEnumUnit()
  local integer armor=LoadInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()))
  if IsUnitAlly(Target,tt_player1)==false then
    call LoDStat_Sub(Target,armor,"armourneg")
  else
    call LoDStat_Sub(Target,armor,"armour")
  endif
  call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),0)
  set Target=null
endfunction

function O4G takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local integer armor=R2I(tt_int1*tt_real1)
  local integer prevarmor
  if tt_int1>0 then
    set prevarmor=R2I((tt_int1-1)*tt_real1)
    if IsUnitAlly(Target,tt_player1)==false then
      call LoDStat_Sub(Target,prevarmor,"armourneg")
    else
      call LoDStat_Sub(Target,prevarmor,"armour")
    endif
  endif
  if IsDead(Target)==false then
    if IsUnitAlly(Target,tt_player1)==false then
      call LoDStat_Add(Target,armor,"armourneg")
      call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),armor)
    else
      call LoDStat_Add(Target,armor,"armour")
      call SaveInteger(HeroStats,GetHandleId(Target),GetHandleId(GetTriggeringTrigger()),armor)
    endif
  endif
  set Target=null
endfunction

function O7G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(22)))
  local player p=(LoadPlayerHandle(HY,h,(54)))
  local integer Count=GetTriggerEvalCount(t)
  local integer DP9=(LoadInteger(HY,h,(188)))
  local real armor=LoadReal(HY,h,0)
  set tt_player1=p
  set tt_int1=Count
  set tt_real1=armor
  if Count==DP9 then
    call ForGroup(g,function N2G)
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call ForGroup(g,function O4G)
  endif
  set t=null
  set g=null
  set p=null
  return false
endfunction

function O8G takes nothing returns nothing
  call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"chest",3)
  call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"chest",3)
  call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"right hand",3)
  call Z48("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",GetEnumUnit(),"left hand",3)
endfunction

function Dazzle_Weave takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Hero,'A10Q')
  local integer DP9=24
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h007',x,y,0)
  local integer a=0
  local boolean RIE=false
  local real armor=Level*0.25+0.5
  if Level==0 then
    set Level=GetUnitAbilityLevel(Hero,'A1DB')
    set DP9=20
    set RIE=true
    set armor=Level*0.25+1.0
  endif
  set tt_int1=DP9
  set a=255
  call SetUnitVertexColor(Caster,255,255,255,a)
  call UnitApplyTimedLife(Caster,'BTLF',5)
  if RIE then
    call GroupEnumUnitsInRange(g,x,y,800,Condition(function DI9))
  else
    call GroupEnumUnitsInRange(g,x,y,600,Condition(function DI9))
  endif
  call ForGroup(g,function O8G)
  call SaveGroupHandle(HY,h,(22),(g))
  call SavePlayerHandle(HY,h,(54),(GetOwningPlayer(Hero)))
  call SaveInteger(HY,h,(188),(DP9))
  call SaveReal(HY,h,0,armor)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function O7G))
  call TriggerEvaluate(t)
  set Hero=null
  set g=null
  set t=null
  set Caster=null
endfunction

function OEG takes string ZS8,unit Target,unit Hero returns nothing
  local texttag tt=CreateTextTag()
  if GetHandleId(tt)>0 then
    call SetTextTagText(tt,ZS8,.033)
    call SetTextTagPosUnit(tt,Target,64)
    call SetTextTagColor(tt,160,0,255,255)
    call SetTextTagVelocity(tt,0,.0355)
    call SetTextTagFadepoint(tt,.15)
    call SetTextTagPermanent(tt,false)
    call SetTextTagLifespan(tt,.65)
    call SetTextTagVisibility(tt,IsUnitAlly(Hero,GetLocalPlayer())or IsObserver(GetLocalPlayer()))
  else
    call DestroyTextTag(tt)
  endif
  set tt=null
endfunction

function OFG takes real DP9 returns string
  if DP9>4.5 then
    return"5.0"
  elseif DP9>4. then
    return"4.5"
  elseif DP9>3.5 then
    return"4.0"
  elseif DP9>3. then
    return"3.5"
  elseif DP9>2.5 then
    return"3.0"
  elseif DP9>2. then
    return"2.5"
  elseif DP9>1.5 then
    return"2.0"
  elseif DP9>1. then
    return"1.5"
  elseif DP9>.5 then
    return"1.0"
  elseif DP9>.0 then
    return"0.5"
  else
    return"0.0"
  endif
  return" "
endfunction

function OGG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Count=GetTriggerEvalCount(t)
  if Count>11 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call OEG(OFG(5.5-.5*Count),Target,Target)
  endif
  set t=null
  set Target=null
  return false
endfunction

function OHG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real Damage=(LoadReal(HY,h,(20)))
  local real OIG=RMaxIF(GetWidgetLife(Target)-Damage,1)
  local real OJG=(LoadReal(HY,(GetHandleId(Target)),(243)))
  call SetWidgetLife(Target,OIG)
  call SaveReal(HY,(GetHandleId(Target)),(243),((OJG-Damage)*1.))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Target=null
  return false
endfunction

function OKG takes unit Target,real Damage returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real OJG=(LoadReal(HY,(GetHandleId(Target)),(243)))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveReal(HY,h,(20),((Damage)*1.))
  call SaveReal(HY,(GetHandleId(Target)),(243),((OJG+Damage)*1.))
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function OHG))
  set t=null
endfunction

function OMG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target
  local real OBF
  local real Damage
  local integer Count=GetTriggerEvalCount(t)
  local real OJG
  local real ONG=(LoadReal(HY,h,(389)))
  local real OOG=(LoadReal(HY,h,(390)))
  if ONG!=(TimerGetElapsed(GlobalTimer))then
    set ONG=(TimerGetElapsed(GlobalTimer))
    set OOG=0
    call SaveReal(HY,h,(389),((ONG)*1.))
    call SaveReal(HY,h,(390),((OOG)*1.))
  endif
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if IsRealDamage then
      set Target=GetTriggerUnit()
      set OJG=(LoadReal(HY,(GetHandleId(Target)),(243)))
      set OBF=GetWidgetLife(Target)
      set Damage=GetEventDamage()
      if((OBF-OJG-OOG)-Damage)<1 then
        call SetWidgetLife(Target,OBF+Damage+OOG)
        call OKG(Target,Damage)
      else
        set OOG=OOG+Damage
        call SaveReal(HY,h,(390),((OOG)*1.))
      endif
    endif
  else
    call SaveInteger(HY,(GetHandleId(((LoadUnitHandle(HY,h,17))))),((2485)),2)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call UnitRemoveAbility((LoadUnitHandle(HY,h,17)),'A21I')
    call UnitRemoveAbility((LoadUnitHandle(HY,h,17)),'B07D')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Target=null
  set t=null
  return false
endfunction

function Dazzle_Grave takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  call UnitAddAbility2(Target,'A21I')
  call TriggerRegisterTimerEvent(t,5,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function OMG))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\DarkHands.mdx",Target,"overhead")))
  call SaveReal(HY,(GetHandleId(Target)),(243),((0)*1.))
  call SaveReal(HY,h,(389),(((TimerGetElapsed(GlobalTimer)))*1.))
  call SaveReal(HY,h,(390),((0)*1.))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,(GetHandleId((Target))),((2485)),(1))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function OGG))
  call SaveUnitHandle(HY,h,17,(Target))
  set t=null
  set Source=null
  set Target=null
endfunction

function ORG takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false then
    set K28=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),0)
    call UnitShareVision(GetEnumUnit(),GetOwningPlayer(tt_unit1),true)
    call UnitAddAbility2(K28,'A17N')
    call SetUnitAbilityLevel(K28,'A17N',M48)
    call IssueTargetOrderById(K28,852527,GetEnumUnit())
    call GroupAddUnit(DK,GetEnumUnit())
    call UnitShareVision(GetEnumUnit(),GetOwningPlayer(tt_unit1),false)
  endif
endfunction

function OSG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(22)))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local integer Level=(LoadInteger(HY,h,5))
  local real a=(LoadReal(HY,h,(13)))
  local group V7E
  local real x
  local real y
  local real OTG
  local real OUG
  local real QQE=30
  set M48=Level
  if GetTriggerEvalCount(t)>28 then
    call KillGroup(g)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call ShowUnit(Caster,false)
    call KillUnit(Caster)
  else
    set x=GetUnitX(Caster)
    set y=GetUnitY(Caster)
    set V7E=GetAvailableGroup()
    set DK=g
    set tt_unit1=Caster
    set tt_real1=Level*70
    call GroupEnumUnitsInRange(V7E,x,y,150,Condition(function LA8))
    call ForGroup(V7E,function ORG)
    call KillGroup(V7E)
    set OTG=SafeX50(x+QQE*Cos(a*bj_DEGTORAD))
    set OUG=SafeY50(y+QQE*Sin(a*bj_DEGTORAD))
    call SetUnitX(Caster,OTG)
    call SetUnitY(Caster,OUG)
  endif
  set t=null
  set g=null
  set V7E=null
  set Caster=null
  return false
endfunction

function Venomancer_VenomousGale takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group g=GetAvailableGroup()
  local unit Hero=GetTriggerUnit()
  local real x1=GetUnitX(Hero)
  local real y1=GetUnitY(Hero)
  local real x2=GetSpellTargetX()
  local real y2=GetSpellTargetY()
  local real a=AngleBetweenXY(x1,y1,x2,y2)
  local integer Level=GetUnitAbilityLevel(Hero,'A173')
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'h07K',x1,y1,a)
  call PlaySoundAtPos(GE,x1,y1)
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(Level))
  call SaveGroupHandle(HY,h,(22),(g))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveUnitHandle(HY,h,(14),(Hero))
  call TriggerRegisterTimerEvent(t,.025,true)
  call TriggerAddCondition(t,Condition(function OSG))
  set t=null
  set Caster=null
  set g=null
  set Hero=null
endfunction

function Venomancer_PlagueWard_Vision takes nothing returns nothing
  call ShowUnit(GetTriggerUnit(),false)
  call DestroyTrigger(GetTriggeringTrigger())
endfunction

function Venomancer_PlagueWard_Check takes nothing returns nothing
  local integer id=GetUnitTypeId(GetSummonedUnit())
  local integer lvl
  local trigger t
  local integer h
  if id=='o00T' or id=='o00U' or id=='o00V' or id=='o00W' then
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,GetSummonedUnit(),EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function Venomancer_PlagueWard_Vision))
    set t=null
    set lvl=id+1-'o00T'
    call UnitAddAbility2(GetSummonedUnit(),'QVEN')
    call SetUnitAbilityLevel(GetSummonedUnit(),'QVEN',lvl)
    if RectContainsUnit(WardAbuseRect,GetSummonedUnit()) then
      call UnitAddAbility(GetSummonedUnit(),'Aeth')
    endif
  endif
endfunction

function Venomancer_PlagueWard_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function Venomancer_PlagueWard_Check))
  set t=null
  set WardAbuseRect=Rect(-1104,-7248,-1474,-6668)
endfunction

function DamageTargetPoison takes unit attacker, unit target, real dmg returns nothing
  if GetWidgetLife(target)>dmg then
    call DamageTarget(attacker,target,1,dmg)
  else
    call DamageTarget(attacker,target,1,RMaxIF(GetWidgetLife(target)-1,0))
  endif
endfunction

function Veno_PoisonNova_Act takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit d
  local integer i=1
  local real angle
  local real x
  local real y
  local real dx
  local real dy
  local real dur=LoadReal(HY,h,0)
  if LoadInteger(HY,h,0)>50*dur then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
    set t=null
    return
  endif
  loop
    set d=LoadUnitHandle(HY,h,i)
    set x=GetUnitX(d)
    set y=GetUnitY(d)
    set angle=i*20*bj_DEGTORAD
    set dx=SafeX50(x+10*Cos(angle))
    set dy=SafeY50(y+10*Sin(angle))
    call SetUnitX(d,dx)
    call SetUnitY(d,dy)
    set i=i+1
    exitwhen i>18
  endloop
  call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
  set d=null
  set t=null
endfunction

function Venomancer_PoisonNova_Dur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit damager
  local unit victim=LoadUnitHandle(HY,h,2)
  local integer dur=LoadInteger(HY,h,0)
  local unit rhero
  if IsDead(victim) or dur<1 or GetUnitAbilityLevel(victim,'A42O')==0 then
    call RemoveSavedHandle(MHT,GetHandleId(victim),'A0A6')
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
    call UnitRemoveAbility(victim,'A42O')
    call UnitRemoveAbility(victim,'B028')
  else
    set damager=LoadUnitHandle(HY,h,0)
    set rhero=LoadUnitHandle(HY,h,1)
    if IsDead(damager) and damager!=rhero then
      set damager=rhero
    endif
    call DamageTargetPoison(damager,victim,LoadReal(HY,h,0))
    call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
  endif
  set rhero=null
  set damager=null
  set victim=null
  set t=null
endfunction

function Venomancer_PoisonNova_Poisoning takes unit caster, unit u, real dmg, real dur returns nothing
  local timer t
  local integer h
  if HaveSavedHandle(MHT,GetHandleId(u),'A0A6') then
    set t=LoadTimerHandle(MHT,GetHandleId(u),'A0A6')
    set h=GetHandleId(t)
    call SaveInteger(HY,h,0,R2I(dur))
  else
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,1,true,function Venomancer_PoisonNova_Dur)
    call SaveReal(HY,h,0,dmg)
    call SaveInteger(HY,h,0,R2I(dur))
    call SaveUnitHandle(HY,h,0,caster)
    call SaveUnitHandle(HY,h,2,u)
    call SaveUnitHandle(HY,h,1,udg_Hero[GetPlayerId(GetOwningPlayer(caster))])
    call SaveTimerHandle(MHT,GetHandleId(u),'A0A6',t)
    call UnitAddAbility2(u,'A42O')
  endif
  
  set t=null
endfunction

function Venomancer_PoisonNova_Filter takes unit u, unit veno returns boolean
  return IsDead(u)==false and IsUnitEnemy(u,GetOwningPlayer(veno)) and GetUnitAbilityLevel(u,'A04R')==0 and GetUnitAbilityLevel(u,'Aloc')==0 and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and IsUnitType(u,UNIT_TYPE_MECHANICAL)==false
endfunction

function Venomancer_PoisonNova_Collide takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local unit veno
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyTrigger(t)
    call FlushChildHashtable(HY,h)
  else
    set u=GetTriggerUnit()
    set veno=LoadUnitHandle(HY,h,0)
    if Venomancer_PoisonNova_Filter(u,veno) then
      call Venomancer_PoisonNova_Poisoning(veno,u,LoadReal(HY,h,0),LoadReal(HY,h,1))
    endif
    set u=null
    set veno=null
  endif
  set t=null
endfunction

function Venomancer_PoisonNova takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local integer i=1
  local real x=GetUnitX(Hero)
  local real y=GetUnitY(Hero)
  local unit d
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  local trigger tt
  local integer ht
  local real dmg
  local integer lvl=GetUnitAbilityLevel(Hero,GetSpellAbilityId())
  local boolean upg=GetSpellAbilityId()=='A0A6'
  local real dur=1.05+0.1*lvl
  local real lifedur=1.05+0.1*lvl
  
  call TimerStart(t,0.02,true,function Veno_PoisonNova_Act)
  call SaveReal(HY,h,0,dur)
  if upg==false then
    if lvl==1 then
      set dur=12
      set dmg=36
    else
      set dur=13+lvl
      if lvl==2 then
        set dmg=58
      else
        set dmg=81
      endif
    endif
  else
    set dur=13+lvl
    if lvl==1 then
      set dmg=58
    elseif lvl==2 then
      set dmg=81
    else
      set dmg=108
    endif
  endif
  loop
    set d=CreateUnit(GetOwningPlayer(Hero),'e017',x,y,0)
    call SaveUnitHandle(HY,h,i,d)
    call UnitApplyTimedLife(d,'BTLF',lifedur)
    set tt=CreateTrigger()
    set ht=GetHandleId(tt)
    //set tt_unit1=Hero
    call TriggerRegisterUnitInRange(tt,d,256+25,Condition(function ReturnTrue))
    call TriggerRegisterUnitEvent(tt,d,EVENT_UNIT_DEATH)
    call TriggerAddCondition(tt,Condition(function Venomancer_PoisonNova_Collide))
    call SaveReal(HY,ht,0,dmg)
    call SaveReal(HY,ht,1,dur)
    call SaveUnitHandle(HY,ht,0,Hero)
    set i=i+1
    exitwhen i>18
  endloop
  set tt=null
  set t=null
  set Hero=null
  set d=null
endfunction


function Viper_Toxin_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  call LoDStat_Sub(LoadUnitHandle(MHT,info,0),LoadInteger(MHT,info,0),"damage")
  call SaveBoolean(MHT,LoadInteger(MHT,info,1),'A1A3',false) //finish cooldown
  call Timer_End(t)
  set t = null
endfunction

function Viper_Toxin_Start takes unit u, unit d, integer level returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  local integer amount = R2I(2.5*level)
  local real r=100*GetWidgetLife(d)/GetUnitState(d,UNIT_STATE_MAX_LIFE)
  if IsUnitType(d,UNIT_TYPE_HERO)==false then
    set amount = amount/2
  endif
  if r>80 then
  elseif r>60 then
    set amount=amount*2
  elseif r>40 then
    set amount=amount*4
  elseif r>20 then
    set amount=amount*8
  else
    set amount=amount*16
  endif
  call LoDStat_Add(u,amount,"damage")
  call SaveUnitHandle(MHT,info,0,u)
  call SaveInteger(MHT,info,0,amount)
  call SaveInteger(MHT,info,1,GetHandleId(u))
  call SaveBoolean(MHT,GetHandleId(u),'A1A3',true) //start cooldown
  call TimerStart(t,.5,false,function Viper_Toxin_End)
  set t = null
endfunction

function Viper_NetherToxin takes unit attacker, unit target returns nothing
  local integer level = GetUnitAbilityLevel(attacker,'A1A3')+GetUnitAbilityLevel(attacker,'QP21')
  if level==0 or LoadBoolean(MHT,GetHandleId(attacker),'A1A3') then
    return
  endif
  if IsUnitEnemy(attacker,GetOwningPlayer(target))then
    call Viper_Toxin_Start(attacker,target,level)
  endif
endfunction

function Viper_CorrosiveSkin_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,5)
  local real JSD=LoadReal(HY,GetHandleId(Target),684)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or JSD<(TimerGetElapsed(GlobalTimer))or IsMagicImmune(Target)then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveReal(HY,GetHandleId(Target),684,0.0)
    call UnitRemoveAbility(Target,'A23W')
    call UnitRemoveAbility(Target,'A23U')
    call UnitRemoveAbility(Target,'A23V')
    call UnitRemoveAbility(Target,'A23X')
    call UnitRemoveAbility(Target,'B0EA')
  else
    set IsCorrosiveSkinDamage=true
    call DamageTarget(Source,Target,1,5+5*Level)
    set IsCorrosiveSkinDamage=false
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Viper_CorrosiveSkin_Tick takes nothing returns nothing
  local trigger t
  local integer h
  local unit Source=GetTriggerUnit()
  local unit Target=GetEventDamageSource()
  local real JSD=LoadReal(HY,GetHandleId(Target),684)
  local integer Level=GetUnitAbilityLevel(Source,'A0MM')+GetUnitAbilityLevel(Source,'QP0Y')
  if JSD<=(TimerGetElapsed(GlobalTimer))then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerRegisterDeathEvent(t,Target)
    call TriggerAddCondition(t,Condition(function Viper_CorrosiveSkin_Duration))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,17,Target)
    call SaveInteger(HY,h,5,Level)
    if IsUnitBADWithSpellbooks(Target)==false then
      if Level==1 then
        call UnitAddAbility2(Target,'A23W')
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A23W',false)
      elseif Level==2 then
        call UnitAddAbility2(Target,'A23U')
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A23U',false)
      elseif Level==3 then
        call UnitAddAbility2(Target,'A23V')
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A23V',false)
      elseif Level==4 then
        call UnitAddAbility2(Target,'A23X')
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A23X',false)
      endif
    endif
  endif
  call SaveReal(HY,GetHandleId(Target),684,TimerGetElapsed(GlobalTimer)+4)
  set t=null
  set Source=null
  set Target=null
endfunction

function Viper_CorrosiveSkin_Start takes nothing returns boolean
  if GetUnitAbilityLevel(GetTriggerUnit(),'A0MM')+GetUnitAbilityLevel(GetTriggerUnit(),'QP0Y') >0 and GetUnitAbilityLevel(GetEventDamageSource(),'A04R')==0 and IsUnitType(GetEventDamageSource(),UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(GetEventDamageSource(),GetOwningPlayer(GetTriggerUnit()))and IsMagicImmune(GetEventDamageSource())==false and DistanceBetweenUnits(GetEventDamageSource(),GetTriggerUnit())<=1400 then //A0MM
    if GetUnitAbilityLevel(GetTriggerUnit(),'BNdo')==0 and IsCorrosiveSkinDamage==false then
      call Viper_CorrosiveSkin_Tick()
    endif
  endif
  return false
endfunction

function Viper_CorrosiveSkin_Reg2 takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function Viper_CorrosiveSkin_Start))
  set t=null
endfunction

function Viper_ViperStrike takes nothing returns nothing
  local unit Target=GetSpellTargetUnit()
  call UnitRemoveAbility(Target,'BEsh')
  call UnitRemoveAbility(Target,'B0AQ')
  set Target=null
endfunction

function GraveChillOff takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call LoDStat_Sub(u,64,"attack")
  call SubBonusMSPercent(u,32)
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function Visage_GraveChill takes nothing returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,GetUnitAbilityLevel(GetTriggerUnit(),'A08X')+2,false,function GraveChillOff)
  call SaveUnitHandle(HY,h,0,GetTriggerUnit())
  call LoDStat_Add(GetTriggerUnit(),64,"attack")
  call AddBonusMSPercent(GetTriggerUnit(),32)
  set t=null
endfunction

function P8G takes unit Source,integer Level,integer P9G returns nothing
  call UnitRemoveAbility(Source,'A1KR')
  call UnitRemoveAbility(Source,'A1KS')
  call UnitRemoveAbility(Source,'A1KQ')
  call UnitRemoveAbility(Source,'A1KP')
  call UnitRemoveAbility(Source,'A1K1')
  call UnitRemoveAbility(Source,'A1KW')
  call UnitRemoveAbility(Source,'A1KX')
  call UnitRemoveAbility(Source,'A1KY')
  call UnitRemoveAbility(Source,'A1L4')
  call UnitRemoveAbility(Source,'A1L3')
  call UnitRemoveAbility(Source,'A1L2')
  call UnitRemoveAbility(Source,'A1L1')
  call UnitRemoveAbility(Source,'A1L8')
  call UnitRemoveAbility(Source,'A1L7')
  call UnitRemoveAbility(Source,'A1L9')
  call UnitRemoveAbility(Source,'A1LB')
  if Level==1 then
    if P9G==1 then
      call UnitAddAbility2(Source,'A1KR')
    elseif P9G==2 then
      call UnitAddAbility2(Source,'A1KS')
    elseif P9G==3 then
      call UnitAddAbility2(Source,'A1KQ')
    elseif P9G==4 then
      call UnitAddAbility2(Source,'A1KP')
    endif
  elseif Level==2 then
    if P9G==1 then
      call UnitAddAbility2(Source,'A1K1')
    elseif P9G==2 then
      call UnitAddAbility2(Source,'A1KW')
    elseif P9G==3 then
      call UnitAddAbility2(Source,'A1KX')
    elseif P9G==4 then
      call UnitAddAbility2(Source,'A1KY')
    endif
  elseif Level==3 then
    if P9G==1 then
      call UnitAddAbility2(Source,'A1L4')
    elseif P9G==2 then
      call UnitAddAbility2(Source,'A1L3')
    elseif P9G==3 then
      call UnitAddAbility2(Source,'A1L2')
    elseif P9G==4 then
      call UnitAddAbility2(Source,'A1L1')
    endif
  elseif Level==4 then
    if P9G==1 then
      call UnitAddAbility2(Source,'A1L8')
    elseif P9G==2 then
      call UnitAddAbility2(Source,'A1L7')
    elseif P9G==3 then
      call UnitAddAbility2(Source,'A1L9')
    elseif P9G==4 then
      call UnitAddAbility2(Source,'A1LB')
    endif
  endif
endfunction

function PDG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer PEG=(LoadInteger(HY,h,(426)))
  local unit Source=(LoadUnitHandle(HY,(PEG),2))
  local integer P9G=(LoadInteger(HY,(PEG),(425)))
  local integer Level=GetUnitAbilityLevel(Source,'A0VX')+GetUnitAbilityLevel(Source,'QP23')
  set P9G=IMinIF(P9G+1,4)
  call SaveInteger(HY,(PEG),(425),(P9G))
  call P8G(Source,Level,P9G)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function rthyrtt takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Cache=LoadInteger(HY,h,426)
  local unit u=LoadUnitHandle(HY,Cache,2)
  local integer P9G=LoadInteger(HY,Cache,425)
  local integer Level=GetUnitAbilityLevel(u,'A0VX')+GetUnitAbilityLevel(u,'QP23')
  call P8G(u,Level,P9G)
  call DestroyTrigger(t)
  call FlushChildHashtable(HY,h)
  set u=null
  set t=null
  
endfunction

function PFG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer P9G=(LoadInteger(HY,h,(425)))
  local integer Level=IMaxIF(GetUnitAbilityLevel(GetTriggerUnit(),'A0VX'),GetUnitAbilityLevel(GetTriggerUnit(),'QP23'))
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource())) and IsRealDamage then
      set P9G=IMaxIF(P9G-1,0)
      call SaveInteger(HY,h,(425),(P9G))
      call P8G(Source,Level,P9G)
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterTimerEvent(t,6,false)
      call TriggerAddCondition(t,Condition(function PDG))
      call SaveInteger(HY,h,(426),(GetHandleId(GetTriggeringTrigger())))
    endif
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.4,false)
    call TriggerAddCondition(t,Condition(function rthyrtt))
    call SaveInteger(HY,h,(426),GetHandleId(GetTriggeringTrigger()))
  endif
  set t=null
  set Source=null
  return false
endfunction

function Visage_GravekeeperCloak_Leveling takes nothing returns nothing
  local trigger t
  local integer h
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'QP23')+GetUnitAbilityLevel(Source,'A0VX')
  if Level==1 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(t,Condition(function PFG))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveInteger(HY,h,(425),(4))
  endif
  call P8G(Source,Level,4)
  set t=null
  set Source=null
endfunction

function Visage_GravekeeperClock_Reg takes nothing returns nothing
  call HideAbility('A1KR')
  call HideAbility('A1KS')
  call HideAbility('A1KQ')
  call HideAbility('A1KP')
  call HideAbility('A1K1')
  call HideAbility('A1KW')
  call HideAbility('A1KX')
  call HideAbility('A1KY')
  call HideAbility('A1L4')
  call HideAbility('A1L3')
  call HideAbility('A1L2')
  call HideAbility('A1L1')
  call HideAbility('A1L8')
  call HideAbility('A1L7')
  call HideAbility('A1L9')
  call HideAbility('A1LB')
endfunction

function PJG takes nothing returns nothing
  local integer Level
  local unit Source=GetTriggerUnit()
  local unit Caster
  if GetUnitTypeId(Source)=='u017' or GetUnitTypeId(Source)=='u019' or GetUnitTypeId(Source)=='u018' or GetUnitTypeId(Source)=='u01A' or GetUnitTypeId(Source)=='u01B' or GetUnitTypeId(Source)=='u01C' or GetUnitTypeId(Source)=='u01U' or GetUnitTypeId(Source)=='u01V' or GetUnitTypeId(Source)=='u01W' then
    return
  endif
  set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  if GetUnitTypeId(Source)=='u014' or GetUnitTypeId(Source)=='u01D' or GetUnitTypeId(Source)=='u01R' then
    set Level=1
  elseif GetUnitTypeId(Source)=='u015' or GetUnitTypeId(Source)=='u01E' or GetUnitTypeId(Source)=='u01S' then
    set Level=2
  else
    set Level=3
  endif
  call UnitAddAbility2(Caster,'A1NF')
  call SetUnitAbilityLevel(Caster,'A1NF',Level)
  call IssueImmediateOrderById(Caster,852127)
  set Source=null
  set Caster=null
endfunction

function PKG takes unit PMG,integer Y59,integer Level returns nothing
  local integer PNG
  if Level==1 then
    set PNG=8
  elseif Level==2 then
    set PNG=14
  elseif Level==3 then
    set PNG=22
  endif
  call AddBonusDamage(PMG,Y59*PNG)
endfunction

function POG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit PMG=(LoadUnitHandle(HY,h,2))
  local unit Source=PMG
  local integer Level=(LoadInteger(HY,h,5))
  local integer KAE=(LoadInteger(HY,h,(28)))
  local integer Y59=(LoadInteger(HY,h,(194)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if GetAttacker()==PMG then
      set Y59=IMaxBJ(Y59-1,0)
      call SaveInteger(HY,h,(194),(Y59))
      call PKG(PMG,Y59,Level)
    endif
  else
    set KAE=KAE+1
    call SaveInteger(HY,h,(28),(KAE))
    if ModuloInteger(KAE,15)==0 then
      set Y59=IMinBJ(Y59+1,7)
      call SaveInteger(HY,h,(194),(Y59))
    endif
    if GetUnitTypeId(Source)=='u017' or GetUnitTypeId(Source)=='u019' or GetUnitTypeId(Source)=='u018' or GetUnitTypeId(Source)=='u01A' or GetUnitTypeId(Source)=='u01B' or GetUnitTypeId(Source)=='u01C' or GetUnitTypeId(Source)=='u01U' or GetUnitTypeId(Source)=='u01V' or GetUnitTypeId(Source)=='u01W' then
      set Y59=7
      call SaveInteger(HY,h,(194),(Y59))
    endif
    call PKG(PMG,Y59,Level)
    if GetUnitTypeId(PMG)=='u017' or GetUnitTypeId(PMG)=='u019' or GetUnitTypeId(PMG)=='u018' or GetUnitTypeId(PMG)=='u01A' or GetUnitTypeId(PMG)=='u01B' or GetUnitTypeId(PMG)=='u01C' or GetUnitTypeId(PMG)=='u01U' or GetUnitTypeId(PMG)=='u01V' or GetUnitTypeId(PMG)=='u01W' then
      call SetWidgetLife(PMG,GetWidgetLife(PMG)+31.25+18.75*Level)
    endif
  endif
  set t=null
  set PMG=null
  set Source=null
  return false
endfunction

function PPG takes nothing returns boolean
  if GetUnitTypeId(GetFilterUnit())=='u014' or GetUnitTypeId(GetFilterUnit())=='u015' or GetUnitTypeId(GetFilterUnit())=='u016' or GetUnitTypeId(GetFilterUnit())=='u01D' or GetUnitTypeId(GetFilterUnit())=='u01E' or GetUnitTypeId(GetFilterUnit())=='u01F' or GetUnitTypeId(GetFilterUnit())=='u01R' or GetUnitTypeId(GetFilterUnit())=='u01S' or GetUnitTypeId(GetFilterUnit())=='u01T' or GetUnitTypeId(GetFilterUnit())=='u017' or GetUnitTypeId(GetFilterUnit())=='u019' or GetUnitTypeId(GetFilterUnit())=='u018' or GetUnitTypeId(GetFilterUnit())=='u01A' or GetUnitTypeId(GetFilterUnit())=='u01B' or GetUnitTypeId(GetFilterUnit())=='u01C' or GetUnitTypeId(GetFilterUnit())=='u01U' or GetUnitTypeId(GetFilterUnit())=='u01V' or GetUnitTypeId(GetFilterUnit())=='u01W' then
    call KillUnit(GetFilterUnit())
  endif
  return false
endfunction

function Visage_Familiars takes nothing returns nothing
  local group g=GetAvailableGroup()
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local integer Level=GetUnitAbilityLevel(Source,'A1NE')
  local unit PRG
  local unit PSG
  local unit PTG
  local trigger t
  local integer h
  local boolean PYF=false
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function PPG))
  call KillGroup(g)
  if Level==0 then
    set Level=GetUnitAbilityLevel(Source,'A2IG')
    set PYF=true
  endif
  if Level==1 then
    set PRG=CreateUnit(GetOwningPlayer(Source),'u014',x+75,y+75,GetUnitFacing(Source))
    set PSG=CreateUnit(GetOwningPlayer(Source),'u01D',x-75,y-75,GetUnitFacing(Source))
  elseif Level==2 then
    set PRG=CreateUnit(GetOwningPlayer(Source),'u015',x+75,y+75,GetUnitFacing(Source))
    set PSG=CreateUnit(GetOwningPlayer(Source),'u01E',x-75,y-75,GetUnitFacing(Source))
  elseif Level==3 then
    set PRG=CreateUnit(GetOwningPlayer(Source),'u016',x+75,y+75,GetUnitFacing(Source))
    set PSG=CreateUnit(GetOwningPlayer(Source),'u01F',x-75,y-75,GetUnitFacing(Source))
  endif
  call SelectUnitAddForPlayer(PRG,GetOwningPlayer(Source))
  call SelectUnitAddForPlayer(PSG,GetOwningPlayer(Source))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PRG,"origin"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PSG,"origin"))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,PRG,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function POG))
  call SaveUnitHandle(HY,h,2,(PRG))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(28),(0))
  call SaveInteger(HY,h,(194),7)
  call PKG(PRG,7,Level)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,PSG,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function POG))
  call SaveUnitHandle(HY,h,2,(PSG))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(28),(0))
  call SaveInteger(HY,h,(194),7)
  call PKG(PSG,7,Level)
  if PYF then
    if Level==1 then
      set PTG=CreateUnit(GetOwningPlayer(Source),'u01R',x+75,y,GetUnitFacing(Source))
    elseif Level==2 then
      set PTG=CreateUnit(GetOwningPlayer(Source),'u01S',x+75,y,GetUnitFacing(Source))
    elseif Level==3 then
      set PTG=CreateUnit(GetOwningPlayer(Source),'u01T',x+75,y,GetUnitFacing(Source))
    endif
    call SelectUnitAddForPlayer(PTG,GetOwningPlayer(Source))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\RaiseSkeletonWarrior\\RaiseSkeleton.mdl",PTG,"origin"))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerRegisterUnitEvent(t,PTG,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function POG))
    call SaveUnitHandle(HY,h,2,(PTG))
    call SaveInteger(HY,h,5,(Level))
    call SaveInteger(HY,h,(28),(0))
    call SaveInteger(HY,h,(194),7)
    call PKG(PTG,7,Level)
  endif
  set g=null
  set Source=null
  set PRG=null
  set PSG=null
  set PTG=null
  set t=null
endfunction

function PUG takes nothing returns boolean
  if GetSpellAbilityId()=='A1NB' or GetSpellAbilityId()=='A1NC' or GetSpellAbilityId()=='A1ND' or GetSpellAbilityId()=='A1NL' or GetSpellAbilityId()=='A1NM' or GetSpellAbilityId()=='A1NN' or GetSpellAbilityId()=='A2IZ' or GetSpellAbilityId()=='A2J0' or GetSpellAbilityId()=='A2J1' then
    call PJG()
  endif
  return false
endfunction

function Visage_Familiar_StoneForm takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function PUG))
  set t=null
endfunction

function PVG takes unit Source,integer HTD,integer PWG returns nothing
  local string c1="|c0000cc00"
  local string c="||"
  local string p=" "
  local string s=c1+"|||r"
  local string result
  local texttag tt=(LoadTextTagHandle(HY,(GetHandleId(Source)),(451)))
  if HTD==0 then
    set result=" "
  elseif PWG==1 then
    if HTD==0 then
      set result=c+p+c+p+c
    elseif HTD==1 then
      set result=s+p+c+p+c
    elseif HTD==2 then
      set result=s+p+s+p+c
    elseif HTD==3 then
      set result=s+p+s+p+s
    endif
  elseif PWG==2 then
    if HTD==0 then
      set result=c+p+c+p+c+p+c
    elseif HTD==1 then
      set result=s+p+c+p+c+p+c
    elseif HTD==2 then
      set result=s+p+s+p+c+p+c
    elseif HTD==3 then
      set result=s+p+s+p+s+p+c
    elseif HTD==4 then
      set result=s+p+s+p+s+p+s
    endif
  elseif PWG==3 then
    if HTD==0 then
      set result=c+p+c+p+c+p+c+p+c
    elseif HTD==1 then
      set result=s+p+c+p+c+p+c+p+c
    elseif HTD==2 then
      set result=s+p+s+p+c+p+c+p+c
    elseif HTD==3 then
      set result=s+p+s+p+s+p+c+p+c
    elseif HTD==4 then
      set result=s+p+s+p+s+p+s+p+c
    elseif HTD==5 then
      set result=s+p+s+p+s+p+s+p+s
    endif
  elseif PWG==4 then
    if HTD==0 then
      set result=c+p+c+p+c+p+c+p+c+p+c
    elseif HTD==1 then
      set result=s+p+c+p+c+p+c+p+c+p+c
    elseif HTD==2 then
      set result=s+p+s+p+c+p+c+p+c+p+c
    elseif HTD==3 then
      set result=s+p+s+p+s+p+c+p+c+p+c
    elseif HTD==4 then
      set result=s+p+s+p+s+p+s+p+c+p+c
    elseif HTD==5 then
      set result=s+p+s+p+s+p+s+p+s+p+c
    elseif HTD==6 then
      set result=s+p+s+p+s+p+s+p+s+p+s
    endif
  endif
  call SetTextTagText(tt,result,.023)
  call SetTextTagPosUnit(tt,Source,0)
  call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer() and IsDead(Source)==false)
  call SetTextTagPermanent(tt,true)
  set tt=null
endfunction

function PXG takes unit Hero,integer Level returns nothing
  local integer PWG=GetUnitAbilityLevel(Hero,'A1NA')
  call PVG(Hero,Level,PWG)
  if Level==0 or((LoadInteger(HY,(GetHandleId((Hero))),((2484))))==1) then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitAddAbility2(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
  elseif Level==1 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitAddAbility2(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    call UnitAddAbility2(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
  elseif Level==2 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitAddAbility2(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitAddAbility2(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
  elseif Level==3 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitAddAbility2(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    if PWG==1 then
      call UnitAddAbility2(Hero,'A1O7')
    else
      call UnitAddAbility2(Hero,'A1N9')
    endif
  elseif Level==4 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitAddAbility2(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    if PWG==2 then
      call UnitAddAbility2(Hero,'A1O8')
    else
      call UnitAddAbility2(Hero,'A1NY')
    endif
  elseif Level==5 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitAddAbility2(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitAddAbility2(Hero,'A0NF')
    call UnitRemoveAbility(Hero,'A0MD')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitRemoveAbility(Hero,'A1O3')
    if PWG==3 then
      call UnitAddAbility2(Hero,'A1O9')
    else
      call UnitAddAbility2(Hero,'A1O0')
    endif
  elseif Level==6 then
    call UnitRemoveAbility(Hero,'A1O7')
    call UnitRemoveAbility(Hero,'A1O8')
    call UnitRemoveAbility(Hero,'A1O9')
    call UnitRemoveAbility(Hero,'A1O1')
    call UnitRemoveAbility(Hero,'A1O2')
    call UnitRemoveAbility(Hero,'A1NZ')
    call UnitRemoveAbility(Hero,'A1N9')
    call UnitRemoveAbility(Hero,'A1NY')
    call UnitRemoveAbility(Hero,'A1O0')
    call UnitAddAbility2(Hero,'A1O3')
    call UnitRemoveAbility(Hero,'A0LR')
    call UnitRemoveAbility(Hero,'A0YP')
    call UnitRemoveAbility(Hero,'A0OG')
    call UnitRemoveAbility(Hero,'A0YO')
    call UnitRemoveAbility(Hero,'A0NF')
    call UnitAddAbility2(Hero,'A0MD')
  endif
  if(GetUnitAbilityLevel(Hero,'A1NA')+2)==Level then
    call UnitAddAbility2(Hero,'A1NJ')
  else
    call UnitRemoveAbility(Hero,'A1NJ')
  endif
endfunction

function PYG takes unit Source,real Damage returns nothing
  local integer Level=0
  local real PZG=110
  if Damage>PZG*6 then
    set Level=6
  elseif Damage>PZG*5 then
    set Level=5
  elseif Damage>PZG*4 then
    set Level=4
  elseif Damage>PZG*3 then
    set Level=3
  elseif Damage>PZG*2 then
    set Level=2
  elseif Damage>PZG*1 then
    set Level=1
  endif
  set Level=IMinIF(Level,2+GetUnitAbilityLevel(Source,'A1NA'))
  call SaveInteger(HY,(GetHandleId(Source)),(450),(Level))
  call PXG(Source,Level)
endfunction

function PAG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer PWG=GetUnitAbilityLevel(Source,'A1NA')
  call PVG(Source,(LoadInteger(HY,(GetHandleId((Source))),(450))),PWG)
  call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),(443))))
  set t=null
  set Source=null
  return false
endfunction

function PBG takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real Damage=(LoadReal(HY,h,(20)))
  if IsUnitAlly(Target,GetOwningPlayer(Source))==false then
    set M88=true
    call DamageTarget(Source,Target,1,Damage)
    set M88=false
  else
    call SetWidgetLife(Target,GetWidgetLife(Target)+Damage)
  endif
  set Source=null
  set Target=null
endfunction

function PCG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),(443))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Visage_SoulAssumption takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=(LoadInteger(HY,(GetHandleId((Source))),(450)))
  local trigger t=AddProjectile(Source,Target,'h0BE',"PBG",1000,false)
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,(20),((20+Level*65)*1.))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AntiMagicShell\\AntiMagicShell.mdl",Source,"chest"))
  call SaveReal(HY,(GetHandleId(Source)),(443),((0)*1.))
  call PYG(Source,0)
  call AddTimedKeyToUnit(Source,2484,4)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerAddCondition(t,Condition(function PCG))
  call TriggerRegisterTimerEvent(t,4,false)
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set Target=null
  set t=null
endfunction

function P6G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real Damage=(LoadReal(HY,h,(20)))
  if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1NA')then
    if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
      call SaveReal(HY,(GetHandleId(Source)),(443),(((LoadReal(HY,(GetHandleId(Source)),(443)))-Damage)*1.))
    endif
    call PYG(Source,(LoadReal(HY,(GetHandleId(Source)),(443))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Visage_SoulAssumption_Learn takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer h=GetHandleId(Source)
  local texttag tt=CreateTextTag()
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function PAG))
  call SaveUnitHandle(HY,(GetHandleId(t)),2,(Source))
  call SetTextTagText(tt," ",.023)
  call SetTextTagPosUnit(tt,Source,0)
  call SetTextTagVisibility(tt,GetOwningPlayer(Source)==GetLocalPlayer())
  call SetTextTagPermanent(tt,true)
  set M78[GetPlayerId(GetOwningPlayer(Source))]=Source
  call SaveReal(HY,h,(443),((0)*1.))
  call PYG(Source,0)
  call SaveTextTagHandle(HY,h,(451),(tt))
  set Source=null
  set t=null
  set tt=null
endfunction

function P1G takes unit P0G,unit P5G returns nothing
  local real Damage=GetEventDamage()
  local integer Level=GetUnitAbilityLevel(P0G,'A1NA')
  local real P2G=(LoadReal(HY,(GetHandleId(P0G)),(443)))
  local trigger t
  local integer h
  if DistanceBetweenUnits(P0G,P5G)<1400 and M88==false and IsRealDamage then
    if IsDamageReal(Damage)and GetEventDamage()>2 and GetEventDamageSource()!=GetTriggerUnit()and(IsPlayerBelongToTeams(GetOwningPlayer(GetEventDamageSource()))or GetUnitTypeId(GetEventDamageSource())=='n00L')then
      set P2G=P2G+Damage
      call SaveReal(HY,(GetHandleId(P0G)),(443),((P2G)*1.))
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call SaveUnitHandle(HY,h,2,(P0G))
      call SaveReal(HY,h,(20),((Damage)*1.))
      call TriggerRegisterTimerEvent(t,6,false)
      call TriggerRegisterUnitEvent(t,P0G,EVENT_UNIT_DEATH)
      call TriggerRegisterUnitEvent(t,P0G,EVENT_UNIT_SPELL_EFFECT)
      call TriggerAddCondition(t,Condition(function P6G))
      call PYG(P0G,P2G)
    endif
  endif
  set t=null
endfunction

function Q4G takes nothing returns nothing
  local integer i=0
  loop
    exitwhen i>12
    if M78[i]!=null then
      call P1G(M78[i],GetTriggerUnit())
    endif
    set i=i+1
  endloop
endfunction

function Visage_SoulAssumption_Reg takes nothing returns nothing
  call RAD("Q4G")
endfunction

function QDG takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TmpUnit376))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetWidgetLife(GetFilterUnit())>1)!=null
endfunction

function QEG takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(TmpUnit376),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,('A0JE'))
  call SetUnitAbilityLevel(Caster,('A0JE'),TmpInt377)
  call IssueTargetOrderById(Caster,852075,Target)
  set Target=null
  set Caster=null
endfunction

function QFG takes unit Caster,unit Hero returns nothing
  local group g=GetAvailableGroup()
  set TmpUnit376=Hero
  call GroupEnumUnitsInRange(g,GetUnitX(Caster),GetUnitY(Caster),675,Condition(function QDG))
  call ForGroup(g,function QEG)
  call KillGroup(g)
  set g=null
endfunction

function QGG takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero
  local unit Caster=LoadUnitHandle(HY,h,19)
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)>22 then
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call InterruptUnit(LoadUnitHandle(HY,h,14))
  else
    call SetUnitAnimation(Caster,"birth")
    set Hero=LoadUnitHandle(HY,h,14)
    set TmpInt377=GetTriggerExecCount(t)*LoadInteger(HY,h,0)/ 2
    call QFG(Caster,Hero)
  endif
  set t=null
  set Caster=null
  set Hero=null
endfunction

function WL_Upheaval takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Hero),'e01G',GetSpellTargetX(),GetSpellTargetY(),0)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddAction(t,function QGG)
  call SaveUnitHandle(HY,h,14,Hero)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  set Hero=null
  set Caster=null
  set t=null
endfunction

function WL_Upheaval_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0JE')
endfunction

function QJG takes nothing returns nothing
  call UnitAddAbility2(GetEnumUnit(),('A0P2'))
endfunction

function QKG takes nothing returns nothing
  call UnitRemoveAbility(GetEnumUnit(),('A0P2'))
endfunction

function QMG takes unit QNG,unit QOG returns nothing
  if QNG!=null and QOG!=null then
    call ZO8("CLPB",GetUnitX(QNG),GetUnitY(QNG),GetUnitX(QOG),GetUnitY(QOG),.7,.1,.9,1,.3)
  endif
endfunction

function QPG takes nothing returns nothing
  local unit Hero=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),(14)))
  local real Damage=.2*GetEventDamage()
  set Damage=RMinIF(Damage,GetWidgetLife(GetTriggerUnit()))
  if GetWidgetLife(GetEnumUnit())>1 and GetEnumUnit()!=GetTriggerUnit()then
    if GetWidgetLife(GetEnumUnit())<Damage then
      call DamageTarget(Hero,GetEnumUnit(),3,Damage)
    else
      call B18(GetEnumUnit(),Damage)
    endif
  endif
  set Hero=null
endfunction

function QQG takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g=(LoadGroupHandle(HY,h,(220)))
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call ForGroup(g,function QKG)
    call FlushChildHashtable(HY,h)
    call KillGroup(g)
    call CleanTrigger((t))
  elseif GetEventDamage()>10 and GetEventDamage()<6000 and IsRealDamage then
    call DisableTrigger(t)
    call ForGroup(g,function QPG)
    call EnableTrigger(t)
  endif
  set t=null
  set g=null
endfunction

function QRG takes nothing returns boolean
  return(IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and IsDead(GetFilterUnit())==false)!=null
endfunction

function WL_FatalBonds_FindClosest takes nothing returns nothing
  set tt_real1=DistanceBetweenUnits(GetEnumUnit(),tt_unit1)
  if tt_real1<tt_real2 then
    set tt_real2=tt_real1
    set TEMPUNIT=GetEnumUnit()
  endif
endfunction

function WL_FatalBounds takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(Hero,('A0J5'))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer i=2
  local group WDF=GetAvailableGroup()
  local unit array QTG
  local string FX="Abilities\\Spells\\Undead\\Curse\\CurseTarget.mdl"
  call SaveUnitHandle(HY,h,(14),(Hero))
  call QMG(Hero,Target)
  call Z48(FX,Target,"overhead",25)
  set QTG[1]=Target
  call SaveUnitHandle(HY,h,(246),(QTG[1]))
  call TriggerRegisterUnitEvent(t,QTG[1],EVENT_UNIT_DAMAGED)
  call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),725,Condition(function QRG))
  call GroupRemoveUnit(g,Target)
  call GroupAddUnit(WDF,Target)
  call SaveGroupHandle(HY,h,(220),(WDF))
  set tt_unit1=null
  loop
    exitwhen i>(1+2*Level)or FirstOfGroup(g)==null
    set tt_real2=9999
    set tt_unit1=QTG[i-1]
    set TEMPUNIT=null
    call ForGroup(g,function WL_FatalBonds_FindClosest)
    if TEMPUNIT!=null then
      set QTG[i]=TEMPUNIT
      call QMG(QTG[i-1],QTG[i])
      call TriggerRegisterUnitEvent(t,QTG[i],EVENT_UNIT_DAMAGED)
      call GroupAddUnit(WDF,QTG[i])
      call GroupRemoveUnit(g,QTG[i])
      call Z48(FX,QTG[i],"overhead",25)
      set i=i+1
    else
      exitwhen true
      
    endif
  endloop
  call SaveInteger(HY,h,(245),(i-1))
  set TmpInt377=GetUnitAbilityLevel(Hero,('A0J5'))
  call ForGroup(WDF,function QJG)
  call TriggerRegisterTimerEvent(t,25,false)
  call TriggerAddAction(t,function QQG)
  call KillGroup(g)
  set g=null
  set t=null
  set Hero=null
  set Target=null
  set WDF=null
endfunction

function QVG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  if GetTriggerEvalCount(t)>LoadInteger(HY,h,1) or GetTriggerEventId()==EVENT_UNIT_DEATH or GetUnitAbilityLevel(Target,'A17K')==0 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call UnitRemoveAbility(Target,'A17K')
    call UnitRemoveAbility(Target,'B0AP')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call DamageTarget(Source,Target,1,Level*10+10)
  endif
  set Source=null
  set Target=null
  set t=null
  return false
endfunction

function QWG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  if GetTriggerEvalCount(t)>LoadInteger(HY,h,1) or GetTriggerEventId()==EVENT_UNIT_DEATH or GetUnitAbilityLevel(Target,'BNdo')>0 or GetUnitAbilityLevel(Target,'A0P0')==0 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call UnitRemoveAbility(Target,'A0P0')
    call UnitRemoveAbility(Target,'B073')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call Y18(Target,Level*10+10)
  endif
  set Source=null
  set Target=null
  set t=null
  return false
endfunction

function WL_ShadowWord takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveInteger(HY,h,1,11)//duration
  if IsUnitAlly(Target,GetOwningPlayer(Source))then
    call TriggerAddCondition(t,Condition(function QWG))
    call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Items\\StaffOfSanctuary\\Staff_Sanctuary_Target.mdl",Target,"chest"))
    call UnitAddAbility2(Target,'A0P0')
  elseif IsBlocked(GetSpellTargetUnit())==false then
    call TriggerAddCondition(t,Condition(function QVG))
    call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Voodoo\\VoodooAuraTarget.mdl",Target,"overhead"))
    call UnitAddAbility2(Target,'A17K')
  endif
  set Source=null
  set Target=null
  set t=null
endfunction

function WL_ShadowWordOnCast takes nothing returns nothing
  if IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and IsMagicImmune(GetSpellTargetUnit()) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot target magic immune enemies")
  endif
endfunction

function WL_ShadowWord_Preload takes nothing returns nothing
  call PreloadQueryAdd('A0P0')
  call PreloadQueryAdd('A17K')
endfunction

function QZG takes nothing returns nothing
  call DamageTarget(M98,GetEnumUnit(),1,20+10*MD8)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Immolation\\ImmolationDamage.mdl",GetEnumUnit(),"head"))
endfunction

function QAG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level
  local integer W78=GetUnitTypeId(Source)
  local group g
  if W78=='n00U' or W78=='n0KU' then
    set Level=1
  elseif W78=='n00Y' or W78=='n0KV' then
    set Level=2
  elseif W78=='n00Z' or W78=='n0KW' then
    set Level=3
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt_unit1=Source
    set M98=Source
    set MD8=Level
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),325,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function QZG)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function QBG takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function QAG))
  call SaveUnitHandle(HY,h,2,(u))
  set t=null
endfunction

function IsInfernal takes unit u returns boolean
  local integer i=GetUnitTypeId(u)
  return i=='n00U' or i=='n0KU' or i=='n00Y' or i=='n0KV' or i=='n00Z' or i=='n0KW'
endfunction

function QCG takes nothing returns boolean
  local integer W78=GetUnitTypeId(GetTriggerUnit())
  if W78=='n00U' or W78=='n0KU' or W78=='n00Y' or W78=='n0KV' or W78=='n00Z' or W78=='n0KW' then
    call QBG(GetTriggerUnit())
  endif
  return false
endfunction

function Q3G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local real PLE=(LoadReal(HY,h,(191)))
  local real P1E=(LoadReal(HY,h,(192)))
  local integer Level=GetUnitAbilityLevel(Source,'S00U')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',PLE,P1E,0)
  call UnitAddAbility2(Caster,'S00U')
  call SetUnitAbilityLevel(Caster,'S00U',Level)
  call IssuePointOrderById(Caster,852224,x,y)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set Source=null
  set Caster=null
  set t=null
  return false
endfunction

function Q6G takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.3,false)
  call TriggerAddCondition(t,Condition(function Q3G))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,6,((GetSpellTargetX())*1.))
  call SaveReal(HY,h,7,((GetSpellTargetY())*1.))
  call SaveReal(HY,h,(191),((GetUnitX(Source))*1.))
  call SaveReal(HY,h,(192),((GetUnitY(Source))*1.))
  set Source=null
  set t=null
endfunction

function WL_Infernal takes nothing returns nothing
  if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    call Q6G()
  endif
endfunction

function WL_Infernal_Detect takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function QCG))
  set t=null
endfunction

function WLFlamingFistAct takes unit attacker, unit target returns nothing
  local group g
  local unit u
  local real a
  local real dmg
  if GetRandomReal(0,100)<40 then
    set g=GetAvailableGroup()
    set a=GetAngleBetweenUnits(attacker,target)*bj_DEGTORAD
    if GetUnitAbilityLevel(attacker,'A0IM')==1 then
      set dmg=80
    elseif GetUnitAbilityLevel(attacker,'A0IQ')==1 then
      set dmg=115
    else
      set dmg=150
    endif
    call GroupEnumUnitsInRange(g,GetUnitX(target)+150*Cos(a),GetUnitY(target)+150*Sin(a),325,Condition(function DefaultEnemyFilter))
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      call DamageTarget(attacker,u,9,dmg)
      call GroupRemoveUnit(g,u)
    endloop
    call KillGroup(g)
  endif
endfunction

function WLFlamingFistWrapper takes nothing returns nothing
  if IsInfernal(UDSG_Attacker) and IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false then
    call WLFlamingFistAct(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function Weaver_Shukuchi_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = LoadUnitHandle(TempHash,'A0CA',0)
  local group g = LoadGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup"))
  if u!=null and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(u)) and (t!=u) and IsUnitInGroup(t,g)==false and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call GroupAddUnit(g,t)
    call DamageTarget(u,t,1,LoadInteger(MHT,GetHandleId(u),StringHash("ShukuDamage")))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\AbsorbMana\\AbsorbManaBirthMissile.mdl",t,"chest"))
  endif
  set g=null
  set u=null
  set t = null
  return false
endfunction

function Weaver_Shukuchi_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  local group g
  if GetUnitAbilityLevel(u,'BHfs')==0 then
    call KillGroup(LoadGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup")))
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  call SaveUnitHandle(TempHash,'A0CA',0,u)
  set g= GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetWidgetX(u),GetWidgetY(u),200,Condition(function Weaver_Shukuchi_Targets))
  call KillGroup(g)
  call RemoveSavedHandle(TempHash,'A0CA',0)
  set g=null
  set t = null
  set u = null
endfunction

function Weaver_Shukuchi_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local integer info = GetHandleId(t)
  local integer level=GetUnitAbilityLevel(u,'A0CA')+GetUnitAbilityLevel(u,'QB01')
  call SaveUnitHandle(MHT,info,0,u)
  call SaveGroupHandle(MHT,GetHandleId(u),StringHash("ShukuGroup"),GetAvailableGroup())
  call SaveInteger(MHT,GetHandleId(u),StringHash("ShukuDamage"),level*25 + 50)
  call TimerStart(t,0.05,true,function Weaver_Shukuchi_Duration)
  set t = null
  set u = null
endfunction

function GeminateAttack_Learn takes nothing returns nothing
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CN')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CR')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CS')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0CM')
endfunction

function IncapacitatingBite_Learn takes nothing returns nothing
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BM')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BL')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BN')
  call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0BO')
endfunction

function Q2G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  call SetUnitState((LoadUnitHandle(HY,h,(26))),UNIT_STATE_MANA,(LoadReal(HY,h,(242))))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function R4G takes unit u,real R7G returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function Q2G))
  call SaveUnitHandle(HY,h,(26),(u))
  call SaveReal(HY,h,(242),((R7G)*1.))
  set t=null
endfunction

function Weaver_TimeLapse takes nothing returns nothing
  local integer h=GetHandleId(GetTriggerUnit())
  local real hp=RMaxIF((LoadReal(HY,h,(7200+1))),1)
  local real mp=RMaxIF((LoadReal(HY,h,(7250+1))),1)
  local real x=(LoadReal(HY,h,(7300+1)))
  local real y=(LoadReal(HY,h,(7350+1)))
  local unit u=GetTriggerUnit()
  if(LoadReal(HY,h,(7200+1)))>1 and GetWidgetLife(u)>1 then
    call AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl",GetUnitX(u),GetUnitY(u))
    call SetUnitX(u,x)
    call SetUnitY(u,y)
    call SetWidgetLife(u,hp)
    call SetUnitState(u,UNIT_STATE_MANA,mp)
    call UnitRemoveBuffs(u,false,true)
    call RemoveDispellableBuffs(u)
    call R4G(u,mp)
  endif
  set u=null
endfunction

function RDG takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local unit u=(LoadUnitHandle(HY,(GetHandleId(t)),(221)))
  local integer h=GetHandleId(u)
  local integer i=1
  local integer k=10
  loop
    exitwhen i>k
    call SaveReal(HY,h,(7300+(i-1)),(((LoadReal(HY,h,(7300+(i)))))*1.))
    call SaveReal(HY,h,(7350+(i-1)),(((LoadReal(HY,h,(7350+(i)))))*1.))
    call SaveReal(HY,h,(7200+(i-1)),(((LoadReal(HY,h,(7200+(i)))))*1.))
    call SaveReal(HY,h,(7250+(i-1)),(((LoadReal(HY,h,(7250+(i)))))*1.))
    set i=i+1
  endloop
  call SaveReal(HY,h,(7300+10),((GetUnitX(u))*1.))
  call SaveReal(HY,h,(7350+10),((GetUnitY(u))*1.))
  call SaveReal(HY,h,(7200+10),((GetWidgetLife(u))*1.))
  call SaveReal(HY,h,(7250+10),((GetUnitState(u,UNIT_STATE_MANA))*1.))
  set t=null
  set u=null
endfunction

function Weaver_TimeLapse_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEventPeriodic(t,.5)
  call TriggerAddAction(t,function RDG)
  call SaveUnitHandle(HY,GetHandleId(t),221,GetTriggerUnit())
  set t=null
endfunction

function RKG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitRemoveAbility(Target,'A1QZ')
    call SaveInteger(HY,(GetHandleId((Target))),((4290)),2)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerUnit()==Target then
      call KillUnit(Source)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source then
      call SetUnitAbilityLevel(Target,'A1QZ',GetUnitAbilityLevel(Target,'A1QZ')+1)
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SkeletalMageMissile\\SkeletalMageMissile.mdl",Target,"chest"))
    endif
  else
    call SetUnitX(Source,GetUnitX(Target)-40)
    call SetUnitY(Source,GetUnitY(Target)-40)
    if GenericCondition_IsDotAInvis(Target)and IsUnitVisible(Target,GetOwningPlayer(Source))==false then
      call KillUnit(Source)
    elseif ModuloInteger(GetTriggerEvalCount(t),5)==0 then
      call IssueTargetOrderById(Source,851983,Target)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function RMG takes unit RNG,unit Target,integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitRemoveAbility(RNG,'Avul')
  call SaveUnitHandle(HY,h,2,(RNG))
  call SaveUnitHandle(HY,h,17,(Target))
  call UnitAddAbility2(Target,'A1QZ')
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,RNG,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function RKG))
  call TriggerEvaluate(t)
  call UnitApplyTimedLife(RNG,'BTLF',4+4*Level)
  set t=null
endfunction

function ROG takes nothing returns boolean
  return((IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))and((LoadInteger(HY,(GetHandleId((GetFilterUnit()))),((4290))))==1)==false and(IsUnitVisible(GetFilterUnit(),GetOwningPlayer(tt_unit1)) or GenericCondition_IsDotAInvis(GetFilterUnit())==false))!=null
endfunction

function RPG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local group g
  local integer i=1
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local real a=LoadReal(HY,h,137)
  local unit RNG
  local unit Target
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  set x=SafeX50(x+18*Cos(a))
  set y=SafeY50(y+18*Sin(a))
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  if GetTriggerEvalCount(t)>166 then
    loop
      exitwhen i>12
      if(LoadBoolean(HY,h,511+i-1))==false then
        call KillUnit(LoadUnitHandle(HY,h,393+i-1))
      endif
      set i=i+1
    endloop
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Source
    call GroupEnumUnitsInRange(g,x,y,400,Condition(function ROG))
    loop
      exitwhen i>12
      if(LoadBoolean(HY,h,511+i-1))==false then
        set RNG=LoadUnitHandle(HY,h,393+i-1)
        set x=LoadReal(HY,h,549+i-1)
        set y=LoadReal(HY,h,567+i-1)
        set x=SafeX50(x+18*Cos(a))
        set y=SafeY50(y+18*Sin(a))
        call SaveReal(HY,h,549+i-1,x*1.)
        call SaveReal(HY,h,567+i-1,y*1.)
        call SetUnitX(RNG,x)
        call SetUnitY(RNG,y)
        set Target=FirstOfGroup(g)
        if Target!=null then
          call GroupRemoveUnit(g,Target)
          call SaveInteger(HY,GetHandleId(Target),4290,1)
          call SaveBoolean(HY,h,511+i-1,true)
          call RMG(RNG,Target,LoadInteger(HY,h,0))
        endif
      endif
      set i=i+1
    endloop
    call KillGroup(g)
    set g=null
    set RNG=null
    set Target=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Weaver_TheSwarm takes nothing returns nothing
  local real TargetX=GetSpellTargetX()
  local real TargetY=GetSpellTargetY()
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local real a=AngleBetweenXY(x,y,TargetX,TargetY)*bj_DEGTORAD
  local unit Caster
  local real AO8=SafeX50(x+3000*Cos(a))
  local real AP8=SafeY50(y+3000*Sin(a))
  local integer i=1
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real offset
  local integer Level=GetUnitAbilityLevel(Source,'A1QW')
  local integer W78
  if Level==1 then
    set W78='u01K'
  elseif Level==2 then
    set W78='u01H'
  elseif Level==3 then
    set W78='u01J'
  elseif Level==4 then
    set W78='u01L'
  endif
  loop
    exitwhen i>12
    set Caster=CreateUnit(GetOwningPlayer(Source),W78,x+GetRandomInt(-300,300),y+GetRandomInt(-300,300),a*bj_RADTODEG)
    call SaveUnitHandle(HY,h,393+i-1,Caster)
    call SaveBoolean(HY,h,511+i-1,false)
    call SaveReal(HY,h,549+i-1,GetUnitX(Caster)*1.)
    call SaveReal(HY,h,567+i-1,GetUnitY(Caster)*1.)
    set i=i+1
  endloop
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function RPG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveReal(HY,h,137,a*1.)
  call SaveReal(HY,h,47,AO8*1.)
  call SaveReal(HY,h,48,AP8*1.)
  call SaveInteger(HY,h,0,Level)
  set Source=null
  set Caster=null
  set t=null
endfunction

function Weaver_Swarm_Preload takes nothing returns nothing
  call PreloadUnit('u01K')
  call PreloadUnit('u01H')
  call PreloadUnit('u01J')
  call PreloadUnit('u01L')
  call PreloadQueryAdd('A1QZ')
endfunction

function RVG takes unit Source,unit FJD returns unit
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,GetUnitX(FJD),GetUnitY(FJD),600,Condition(function NonImmuneEnemyFilter))
  call GroupRemoveUnit(g,FJD)
  set tt_unit1=GroupPickRandomUnit(g)
  call KillGroup(g)
  set g=null
  return tt_unit1
endfunction

function CaskConnect takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit dummy=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local unit source=LoadUnitHandle(HY,h,2)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==dummy then
      if IsUnitType(target,UNIT_TYPE_HERO) then
        call StunTargetLod(target,1)
        call DamageTarget(source,target,1,50+25*LoadInteger(HY,h,0))
      else
        call StunTargetLod(target,5)
        call DamageTarget(source,target,1,50)
      endif
      if LoadInteger(HY,h,1)>0 then
        call SaveUnitHandle(TempHash,'cask',0,target)
        call RemoveSavedHandle(TempHash,'cask',1)
        call SaveUnitHandle(TempHash,'cask',2,source)
        call SaveInteger(TempHash,'cask',0,LoadInteger(HY,h,0))
        call SaveInteger(TempHash,'cask',1,LoadInteger(HY,h,1))
        call ExeFunc("CaskBounce")
      else
        call FlushChildHashtable(TempHash,'cask')
      endif
      call CleanTrigger(t)
      call FlushChildHashtable(HY,h)
    endif
  else
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  endif
  set dummy=null
  set target=null
  set t=null
endfunction

function CastCask takes unit Source,unit bounceFrom, unit bounceTo, integer lvl, integer c returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(bounceFrom),GetUnitY(bounceFrom),0)
  local boolean b=IsUnitType(bounceTo,UNIT_TYPE_HERO)
  call TriggerRegisterUnitEvent(t,bounceTo,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(t,15,false)
  call SaveUnitHandle(HY,h,0,Caster)
  call SaveUnitHandle(HY,h,1,bounceTo)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,lvl)
  call SaveInteger(HY,h,1,c-1)
  call TriggerAddCondition(t,Condition(function CaskConnect))
  set t=null
  if IsUnitIllusion(bounceTo) then
    call UnitAddAbility(Caster,'QBT5')
  else
    if b then
      call UnitAddAbility(Caster,'A0WY')
    else
      call UnitAddAbility(Caster,'A0NL')
    endif
  endif
  call IssueTargetOrderById(Caster,852095,bounceTo)
  set Caster=null
endfunction

function CaskBounce takes nothing returns nothing
  local unit bounceFrom=LoadUnitHandle(TempHash,'cask',0)
  local unit bounceTo=LoadUnitHandle(TempHash,'cask',1)
  local unit Source=LoadUnitHandle(TempHash,'cask',2)
  local integer lvl=LoadInteger(TempHash,'cask',0)
  local integer c=LoadInteger(TempHash,'cask',1)
  if bounceTo==null then
    set bounceTo=RVG(Source,bounceFrom)
  endif
  if bounceTo!=null then
    call CastCask(Source,bounceFrom,bounceTo,lvl,c)
  endif
  set bounceFrom=null
  set Source=null
endfunction

function myParalyzinCask takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Hero,'A0NM')
  call SaveUnitHandle(TempHash,'cask',0,Hero)
  call SaveUnitHandle(TempHash,'cask',1,target)
  call SaveUnitHandle(TempHash,'cask',2,Hero)
  call SaveInteger(TempHash,'cask',0,Level)
  call SaveInteger(TempHash,'cask',1,Level*2+1)
  call CaskBounce()
  set Hero=null
  set target=null
endfunction

function WD_ParalyzingCask takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call myParalyzinCask()
  endif
endfunction

function RBG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  local integer Level=GetUnitAbilityLevel(Hero,'A0NE')
  call UnitRemoveAbility(Hero,'A0NE')
  call UnitAddAbility2(Hero,'A0NE')
  call SetUnitAbilityLevel(Hero,'A0NE',Level)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Hero=null
  return false
endfunction

function RCG takes unit Target,integer Level returns nothing
  local real VBE=(8+Level*8)/ 3
  call SetWidgetLife(Target,GetWidgetLife(Target)+VBE)
endfunction

function R3G takes nothing returns boolean
  if(IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))==false and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
    call RCG(GetFilterUnit(),tt_int1)
  endif
  return false
endfunction

function R6G takes unit Hero returns nothing
  local integer Level=GetUnitAbilityLevel(Hero,'A0NE')
  local group g=GetAvailableGroup()
  set tt_unit1=Hero
  set tt_int1=Level
  call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),525,Condition(function R3G))
  call KillGroup(g)
  set g=null
endfunction

function RLG takes unit Hero returns nothing
  local integer Level=GetUnitAbilityLevel(Hero,'A0NE')
  local real R1G=4+4*Level
  call SetUnitState(Hero,UNIT_STATE_MANA,GetUnitState(Hero,UNIT_STATE_MANA)-(R1G/ 3))
  if GetUnitState(Hero,UNIT_STATE_MANA)<R1G then
    if((LoadInteger(HY,(GetHandleId((Hero))),((4265))))==1)==false then
      call IssueImmediateOrderById(Hero,852178)
    endif
  endif
endfunction

function R0G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=(LoadUnitHandle(HY,h,(14)))
  if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
    if GetIssuedOrderId()==852178 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call SaveUnitHandle(HY,h,(14),(Hero))
      call TriggerRegisterTimerEvent(t,0,false)
      call TriggerAddCondition(t,Condition(function RBG))
    endif
  else
    call R6G(Hero)
    call RLG(Hero)
  endif
  set t=null
  set Hero=null
  return false
endfunction

function WD_VoodooRestoration takes nothing returns nothing
  local unit Hero=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,14,Hero)
  call TriggerRegisterTimerEvent(t,.33,true)
  call TriggerRegisterUnitEvent(t,Hero,EVENT_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function R0G))
  set Hero=null
  set t=null
endfunction

function S4G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  local integer Count=GetTriggerEvalCount(t)
  local real S7G=LoadReal(HY,h,392)
  local real S9F=0
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call Buff_Remove(Target,LoDBuff_BuffID[2])
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if Count==4 or Count==8 or Count==12 then
      call DestroyEffect(LoadEffectHandle(HY,h,32))
      if Count==12 then
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      elseif Count==4 or Count==8 then
        call DestroyEffect(LoadEffectHandle(HY,h,32))// to prevent leaks from this \/  stupid frog D:
        call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
      endif
      set S9F=(Level*.08 + 0.08)*RMaxIF(S7G-GetWidgetLife(Target),0)
      if S9F>0 then
        call TextTagOnUnit("+"+I2S(R2I(S9F)),2,Target,.023,68,0,187,216)
      endif
    endif
    call DamageTarget(Source,Target,1,Level*5+S9F)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function S8G takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  call Buff_Add(Target,LoDBuff_AbilID[2],LoDBuff_BuffID[2],12.)
  call DestroyEffect(AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function S4G))
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveReal(HY,h,392,GetWidgetLife(Target)*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("effects\\NetherInferno.mdx",Target,"origin"))
  set t=null
  set Source=null
  set Target=null
endfunction

function WD_Maledict takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),190,Condition(function D89))
  call ForGroup(g,function S8G)
  call KillGroup(g)
  set g=null
endfunction

function SEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if GetTriggerEventId()!=EVENT_UNIT_SPELL_ENDCAST then
    call InterruptUnit(Source)
  endif
  set Source=null
  set t=null
  return false
endfunction

function WD_DeathWard takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(Source))
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerAddCondition(t,Condition(function SEG))
  call LinkenSphere_SpreadOn(Source,false)
  set t=null
  set Source=null
endfunction

function SHG takes nothing returns boolean
  if GetUnitTypeId(GetSummonedUnit())=='o000' or GetUnitTypeId(GetSummonedUnit())=='o001' or GetUnitTypeId(GetSummonedUnit())=='o00A' or GetUnitTypeId(GetSummonedUnit())=='o00X' then
    call AddTimedKeyToUnit(GetSummoningUnit(),4265,8)
  endif
  return false
endfunction

function WD_DeathWard_Summon takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function SHG))
  set t=null
endfunction

function SIG takes nothing returns boolean
  local integer id=0
  local unit u
  local real time=TimerGetElapsed(GlobalTimer)
  local real hp
  loop
    exitwhen id>12
    set u=udg_Hero[id]
    if u!=null and GetUnitAbilityLevel(u,'B0CD')==0 and IceBlastTimestamp[id]>time then
      set IceBlastTimestamp[id]=0
    endif
    if u!=null and GetUnitAbilityLevel(u,'B0CD')>0 then
      if IceBlastTimestamp[id]>time and IsDead(u)==false then
        set hp=GetWidgetLife(u)
        if hp<IceBlastLife[id]then
          set IceBlastLife[id]=hp
        endif
        call SetWidgetLife(u,IceBlastLife[id])
        set IceBlastTicks[id]=IceBlastTicks[id]+1
        if IceBlastTicks[id]==10 then
          set IceBlastTicks[id]=0
          call DamageTarget(IceBlastCaster[id],u,1,5+10*IceBlastLevel[id])
        endif
      elseif IceBlastTimestamp[id]>time and IsDead(u) then
        set IceBlastTimestamp[id]=0
        set IceBlastLife[id]=9999
      endif
      if(GetUnitAbilityLevel(u,'B0CD')>0 and IceBlastTimestamp[id]<time)then
        call UnitRemoveAbility(u,'A1JA')
        call UnitRemoveAbility(u,'B0CD')
        call UnitRemoveAbility(u,'A1LD')
      endif
    endif
    set id=id+1
  endloop
  set u=null
  return false
endfunction

function SJG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,5)
  local unit Caster
  local string s
  if GetUnitAbilityLevel(Target,'B0CD')==0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetOwningPlayer(Target)!=GetOwningPlayer(GetEventDamageSource())and GetUnitState(Target,UNIT_STATE_MAX_LIFE)*(.09+.01*Level)>GetWidgetLife(Target)and((LoadInteger(HY,(GetHandleId((Target))),((2485))))==1)==false then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Target,'A1JA')
    call UnitRemoveAbility(Target,'B0CD')
    call UnitRemoveAbility(Target,'A1LD')
    set s="Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl"
    call DestroyEffect(AddSpecialEffectTarget(s,Target,"overhead"))
    call DestroyEffect(AddSpecialEffectTarget(s,Target,"chest"))
    call DestroyEffect(AddSpecialEffectTarget(s,Target,"origin"))
    set Caster=CreateUnit(GetOwningPlayer(GetEventDamageSource()),'e00E',0,0,0)
    call UnitRemoveBuffs(Target,true,true)
    call UnitRemoveAbility(Target,'Aetl')
    call DamageTarget(Caster,Target,4,100000000.)
    set Caster=null
  endif
  set t=null
  set Target=null
  return false
endfunction

function AA_IceBlast_Frozen takes unit Source,unit Target returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'A1MI')+GetUnitAbilityLevel(Source,'A2QE')
  local integer id=GetPlayerId(GetOwningPlayer(Target))
  local trigger t
  local integer h
  set IceBlastTimestamp[id]=TimerGetElapsed(GlobalTimer)+7+Level
  if GetUnitAbilityLevel(Source,'A2QE')>0 then
    set IceBlastTimestamp[id]=TimerGetElapsed(GlobalTimer)+17
  endif
  if Level>0 and IsUnitType(Target,UNIT_TYPE_HERO) and GetUnitAbilityLevel(Target,'A04R')==0 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function SJG))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,h,5,(Level))
    call UnitAddAbility2(Target,'A1JA')
    call UnitAddAbility2(Target,'A1LD')
    set IceBlastLife[id]=GetWidgetLife(Target)
    set IceBlastCaster[id]=Source
    set IceBlastLevel[id]=Level
  endif
  set t=null
endfunction

function SMG takes nothing returns nothing
  local unit Source=tt_unit1
  local unit Target=GetEnumUnit()
  local integer id=GetPlayerId(GetOwningPlayer(Target))
  local integer Level=GetUnitAbilityLevel(Source,'A1MI')+GetUnitAbilityLevel(Source,'A2QE')
  local trigger t
  local integer h
  if IsUnitType(Target,UNIT_TYPE_HERO) and IsUnitIllusion(Target)==false and GetUnitAbilityLevel(Target,'B0CD')==0 and GetUnitTypeId(Target)!='H00J' then
    set IceBlastTimestamp[id]=(TimerGetElapsed(GlobalTimer))+7+Level
    call UnitAddAbility2(Target,'A1JA')
    call UnitAddAbility2(Target,'A1LD')
    set IceBlastLife[id]=GetWidgetLife(Target)
    set IceBlastCaster[id]=Source
    set IceBlastLevel[id]=Level
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function SJG))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,h,5,(Level))
    set t=null
  endif
  set Source=null
  set Target=null
endfunction

function AA_Ulti_Preload takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer id=0
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function SIG))
  loop
    exitwhen id>12
    set IceBlastLife[id]=9999
    set id=id+1
  endloop
  set t=null
endfunction

function SRG takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1HZ')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1HZ')
    call UnitRemoveAbility(GetEnumUnit(),'B0C5')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1I4')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1I4')
    call UnitRemoveAbility(GetEnumUnit(),'B0C5')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1I3')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1I3')
    call UnitRemoveAbility(GetEnumUnit(),'B0C5')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A1I6')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A1I6')
    call UnitRemoveAbility(GetEnumUnit(),'B0C5')
  endif
endfunction

function SSG takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if IsMagicImmune(GetEnumUnit())==false then
    if MK8==1 then
      if GetUnitAbilityLevel(GetEnumUnit(),'A1HZ')==0 then
        call UnitRemoveAbility(GetEnumUnit(),'B0C5')
        call UnitAddAbility2(GetEnumUnit(),'A1HZ')
      endif
    elseif MK8==2 then
      if GetUnitAbilityLevel(GetEnumUnit(),'A1I4')==0 then
        call UnitRemoveAbility(GetEnumUnit(),'B0C5')
        call UnitAddAbility2(GetEnumUnit(),'A1I4')
      endif
    elseif MK8==3 then
      if GetUnitAbilityLevel(GetEnumUnit(),'A1I3')==0 then
        call UnitRemoveAbility(GetEnumUnit(),'B0C5')
        call UnitAddAbility2(GetEnumUnit(),'A1I3')
      endif
    elseif MK8==4 then
      if GetUnitAbilityLevel(GetEnumUnit(),'A1I6')==0 then
        call UnitRemoveAbility(GetEnumUnit(),'B0C5')
        call UnitAddAbility2(GetEnumUnit(),'A1I6')
      endif
    endif
  endif
endfunction

function STG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local group GGF=LoadGroupHandle(HY,h,340)
  local real x=GetUnitX(Caster)
  local real y=GetUnitY(Caster)
  local group g=GetAvailableGroup()
  local group g2
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call ForGroup(GGF,function SRG)
    call KillGroup(g)
    call KillGroup(GGF)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call ShowUnit(Caster,false)
    set t=null
    set Source=null
    set Caster=null
    set GGF=null
    return false
  endif
  set MK8=LoadInteger(HY,h,0)
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilter))
  call GroupRemoveGroup(g,GGF)
  call ForGroup(GGF,function SRG)
  call ForGroup(g,function SSG)
  call SaveGroupHandle(HY,h,340,g)
  call KillGroup(GGF)
  set t=null
  set Source=null
  set Caster=null
  set GGF=null
  set g=null
  set g2=null
  return false
endfunction

function AA_IceVortex takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'n0HQ',GetSpellTargetX(),GetSpellTargetY(),0)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitApplyTimedLife(Caster,'BTLF',16)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,Caster,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function STG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveGroupHandle(HY,h,340,GetAvailableGroup())
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1HS'))
  set Source=null
  set Caster=null
  set t=null
endfunction

function SWG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local integer lvl=LoadInteger(HY,h,5)
  local real Damage=(100+50*lvl)/ 4
  local integer i=GetTriggerEvalCount(t)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))>765 or GetUnitAbilityLevel(Target,'B0CC')==0 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call UnitRemoveAbility(Target,'A1J9')
    call UnitRemoveAbility(Target,'B0CC')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif i==8 or i==16 or i==25 or i==34 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\ShivasEnchantment.mdx",Target,"overhead"))
    call DamageTarget(Source,Target,1,Damage)
  elseif i>39 then
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call UnitRemoveAbility(Target,'A1J9')
    call UnitRemoveAbility(Target,'B0CC')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call StunTargetLod(Target,0.5+0.75*lvl)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function SXG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A1MG')
  local string s="Doodads\\Cinematic\\GlowingRunes\\GlowingRunes4.mdl"
  if GetUnitTypeId(Source)=='e00E' then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
  endif
  call UnitAddAbility2(Target,'A1J9')
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveReal(HY,h,6,GetUnitX(Target)*1.)
  call SaveReal(HY,h,7,GetUnitY(Target)*1.)
  call SaveInteger(HY,h,5,Level)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\ShivasEnchantment.mdx",Target,"overhead"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffect(s,GetUnitX(Target),GetUnitY(Target)))
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function SWG))
  set Source=null
  set Target=null
  set t=null
endfunction

function AA_ColdFeet takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call SXG()
  endif
endfunction

function SZG takes nothing returns nothing
  local unit Source=MO8
  local unit Target=GetEnumUnit()
  local integer Level=MN8
  call AA_IceBlast_Frozen(Source,Target)
  call DamageTarget(Source,Target,1,150+100*Level)
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\PlasmaShot.mdl",Target,"chest"))
  set Source=null
  set Target=null
endfunction

function SAG takes nothing returns nothing
  local unit Source=MO8
  local unit Target=GetEnumUnit()
  local integer Level=MN8
  call AA_IceBlast_Frozen(Source,Target)
  set Source=null
  set Target=null
endfunction

function SBG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  local real a=LoadReal(HY,h,13)
  local real RFE=LoadReal(HY,h,432)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,5)
  local real x=GetUnitX(Projectile)+30*Cos(a)
  local real y=GetUnitY(Projectile)+30*Sin(a)
  local group g
  local fogmodifier fm
  if DistanceBetweenXY(x,y,TargetX,TargetY)<35 or x!=SafeX50(x)or y!=SafeY50(y)then
    set x=TargetX
    set y=TargetY
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    set fm=LoadFogModifierHandle(HY,h,440)
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    set fm=null
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(Projectile)
    set tt_unit1=Source
    set MO8=Source
    set MN8=Level
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,RFE+25,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function SZG)
    call KillGroup(g)
    set g=null
  else
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    set tt_unit1=Source
    set MO8=Source
    set MN8=Level
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function SAG)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Projectile=null
  set Source=null
  return false
endfunction

function SCG takes unit Source,real x,real y,real N2F,effect FX,fogmodifier fm, integer Level returns nothing
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0B6',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  local real RFE=RMinIF(275+25*N2F*2,1000)
  local real YR8=DistanceBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)
  if IsUnitEnemy(Projectile,GetLocalPlayer())and IsObserver(GetLocalPlayer())==false then
    call UnitSetUsesAltIcon(Projectile,true)
  endif
  call TriggerRegisterTimerEvent(t,RMinIF(2./(YR8/ 30),.04),true)
  call TriggerAddCondition(t,Condition(function SBG))
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveReal(HY,h,47,x*1.)
  call SaveReal(HY,h,48,y*1.)
  call SaveReal(HY,h,13,a*1.)
  call SaveReal(HY,h,432,RFE*1.)
  call SaveInteger(HY,h,5,Level)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveFogModifierHandle(HY,h,440,fm)
  call SaveEffectHandle(HY,h,32,FX)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MI',true)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2QE',true)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MN',false)
  set t=null
  set Projectile=null
endfunction

function S3G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real a=LoadReal(HY,h,13)
  local real x
  local real y
  local real N2F=TimerGetElapsed(GlobalTimer)-LoadReal(HY,h,431)
  local string s
  local fogmodifier fm
  local effect FX
  local real S6G=GetUnitX(Projectile)+30*Cos(a)
  local real SLG=GetUnitY(Projectile)+30*Sin(a)
  local integer lvl=LoadInteger(HY,h,0)
  set x=SafeX50(S6G)
  set y=SafeY50(SLG)
  call SetUnitX(Projectile,x)
  call SetUnitY(Projectile,y)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1MN')or x!=S6G or y!=SLG then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call RemoveUnit(Projectile)
    set s=""
    if IsPlayerAlly(GetOwningPlayer(Source),GetLocalPlayer())or IsObserver(GetLocalPlayer())then
      set s="war3mapImported\\IceWindGroundFX.mdl"
    endif
    set fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,500,true,true)
    call FogModifierStart(fm)
    set FX=AddSpecialEffect(s,x,y)
    call SCG(Source,x,y,N2F,FX,fm,lvl)
    set fm=null
    set FX=null
  endif
  set t=null
  set Projectile=null
  set Source=null
  return false
endfunction

function AA_IceBlast takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=Atan2(y-GetUnitY(Source),x-GetUnitX(Source))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'H0B8',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  if IsUnitEnemy(Projectile,GetLocalPlayer())and IsObserver(GetLocalPlayer())==false then
    call UnitSetUsesAltIcon(Projectile,true)
  endif
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,13,a*1.)
  call SaveReal(HY,h,431,TimerGetElapsed(GlobalTimer)*1.)
  call TriggerRegisterTimerEvent(t,.02,true)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveInteger(HY,h,1,GetSpellAbilityId())
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function S3G))
  call SetUnitColor(Projectile,GetPlayerColor(Player(14)))
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MI',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2QE',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1MN',true)
  call UnitAddAbility2(Source,'A1MN')
  set Source=null
  set t=null
  set Projectile=null
endfunction

function S5G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  local integer S2G=(LoadInteger(HY,(GetHandleId(Source)),(449)))
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and GetEventDamage()>1 and IsRealDamage then
      call DisableTrigger(t)
      if S2G>0 then
        call SaveInteger(HY,(GetHandleId(Source)),(449),(S2G-1))
        call TextTagOnUnit("+"+I2S(40+10*Level),1,Source,.024,100,200,255,255)
        call DamageTarget(Source,Target,1,40+10*Level)
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function T4G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,5)
  if GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED or(LoadInteger(HY,GetHandleId(Source),449))==0 or GetUnitAbilityLevel(Source,'A1HN')==0 then
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call SaveInteger(HY,GetHandleId(Source),449,0)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'A1HN')
    call UnitRemoveAbility(Source,'B0CJ')
    call UnitRemoveAbility(Source,'A1IP')
  elseif GetAttacker()==Source and (LoadInteger(HY,GetHandleId(Source),4289)!=1)then
    call AddTimedKeyToUnit(Source,4289,.4)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(t,2.,false)
    call TriggerAddCondition(t,Condition(function S5G))
    call SaveUnitHandle(HY,h,17,GetTriggerUnit())
    call SaveUnitHandle(HY,h,2,Source)
    call SaveInteger(HY,h,5,Level)
  endif
  set t=null
  set Source=null
  return false
endfunction

function T7G takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A1HQ')
  call UnitAddAbility2(Target,'A1HN')
  call UnitAddAbility2(Target,'A1IP')
  call SaveInteger(HY,GetHandleId(Target),449,2+Level)
  call SaveUnitHandle(HY,h,2,Target)
  call SaveInteger(HY,h,5,Level)
  call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("war3mapImported\\FrostHands.mdx",Target,"right,hand"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("war3mapImported\\FrostHands.mdx",Target,"left,hand"))
  call TriggerRegisterTimerEvent(t,30,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function T4G))
  set Source=null
  set Target=null
  set t=null
endfunction

function AA_ChillingTouch takes nothing returns nothing
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  call DestroyEffect(AddSpecialEffect("war3mapImported\\IcyWind.mdl",x,y))
  call GroupEnumUnitsInRange(g,x,y,550,Condition(function L58))
  call GroupAddUnit(g,GetTriggerUnit())
  call ForGroup(g,function T7G)
  call KillGroup(g)
  set g=null
endfunction

function Slark_DP_Self takes unit u, real dmg returns nothing
  if GetWidgetLife(u)<=dmg*.75 then
    set dmg=GetWidgetLife(u)/ .75-10
  endif
  call DamageTarget(u,u,1,dmg)
endfunction

function TFG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g
  local integer i=GetTriggerEvalCount(t)
  local unit u
  local real dmg
  local boolean b=LoadBoolean(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set Source=null
    return false
  else
    set dmg=LoadReal(HY,h,0)
    if i==1 then
      call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'h0B2',x,y,0),'BTLF',1)
      call TriggerRegisterTimerEvent(t,.1,true)
    elseif i==10 then
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
    call RemoveDispellableBuffs(Source)
    call SetNapalmFactory(Source,0,0)
    set g=GetAvailableGroup()
    set tt_unit1=Source
    call GroupEnumUnitsInRange(g,x,y,350,Condition(function DefaultEnemyFilter))
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      call DamageTarget(Source,u,1,dmg)
      call GroupRemoveUnit(g,u)
    endloop
    if b then
      call Slark_DP_Self(Source,dmg / 2)
    endif
    call KillGroup(g)
  endif
  set t=null
  set g=null
  set Source=null
  return false
endfunction

function Slark_DarkPact takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call SaveBoolean(HY,h,0,true)
  if GetUnitTypeId(Source)=='e00E'then
    set Source=udg_Hero[GetPlayerId(GetOwningPlayer(Source))]
    call SaveBoolean(HY,h,0,false)
  endif
  call TriggerRegisterTimerEvent(t,1.5,false)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function TFG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId())*7.5)
  set t=null
  set Source=null
endfunction

function TIG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local player p
  local integer Level=GetUnitAbilityLevel(Source,'A1IN')
  local real Time=TimerGetElapsed(GlobalTimer)
  local real seen=LoadReal(HY,h,415)
  local real fade=LoadReal(HY,h,416)
  local integer mult
  if IsDead(Source)then
    set t=null
    set Source=null
    return false
  endif
  if IsSentinel(GetOwningPlayer(Source))then
    set p=Scourges[1]
  else
    set p=Sentinels[1]
  endif
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED and GetOwningPlayer(GetEventDamageSource())==Neutrals then
    if GetUnitAbilityLevel(Source,'A1IE')>0 then
      call UnitRemoveAbility(Source,'A1IE')
      call UnitRemoveAbility(Source,'B0C9')
    endif
    if GetUnitAbilityLevel(Source,'A1IF')>0 then
      call UnitRemoveAbility(Source,'A1IF')
      call UnitRemoveAbility(Source,'B0C9')
    endif
    if GetUnitAbilityLevel(Source,'A1IG')>0 then
      call UnitRemoveAbility(Source,'A1IG')
      call UnitRemoveAbility(Source,'B0C9')
    endif
    call SaveReal(HY,h,414,(Time+2)*1.)
    set t=null
    set Source=null
    return false
  endif
  if(LoadReal(HY,h,414))>Time then
    set t=null
    set Source=null
    return false
  endif
  if (IsUnitVisible(Source,p) and GetUnitAbilityLevel(Source,'A1HX')==0) or GetUnitAbilityLevel(Source,'BNdo')>0 then
    set fade=0
    if GetUnitAbilityLevel(Source,'A1IE')>0 or GetUnitAbilityLevel(Source,'A1IF')>0 or GetUnitAbilityLevel(Source,'A1IG')>0 then
      set seen=seen+.1
      if seen>.4 then
        set seen=0
        if GetUnitAbilityLevel(Source,'A1IE')>0 then
          call UnitRemoveAbility(Source,'A1IE')
          call UnitRemoveAbility(Source,'B0C9')
        endif
        if GetUnitAbilityLevel(Source,'A1IF')>0 then
          call UnitRemoveAbility(Source,'A1IF')
          call UnitRemoveAbility(Source,'B0C9')
        endif
        if GetUnitAbilityLevel(Source,'A1IG')>0 then
          call UnitRemoveAbility(Source,'A1IG')
          call UnitRemoveAbility(Source,'B0C9')
        endif
      endif
    endif
    call SaveReal(HY,h,415,seen*1.)
    call SaveReal(HY,h,416,fade*1.)
  elseif IsUnitVisible(Source,p)==false or GetUnitAbilityLevel(Source,'A1HX')>0 then
    set seen=0
    if(GetUnitAbilityLevel(Source,'A1IE'-1+Level)==0)then
      set fade=fade+.1
      if fade>.4 then
        set fade=0
        if Level==1 then
          if GetUnitAbilityLevel(Source,'A1IE')==0 then
            call UnitAddAbility2(Source,'A1IE')
            call UnitMakeAbilityPermanent(Source,true,'A1I7')
            call UnitMakeAbilityPermanent(Source,true,'A1I8')
          endif
        endif
        if Level==2 then
          if GetUnitAbilityLevel(Source,'A1IE')>0 then
            call UnitRemoveAbility(Source,'A1IE')
            call UnitRemoveAbility(Source,'B0C9')
          endif
          if GetUnitAbilityLevel(Source,'A1IF')==0 then
            call UnitAddAbility2(Source,'A1IF')
            call UnitMakeAbilityPermanent(Source,true,'A1I7')
            call UnitMakeAbilityPermanent(Source,true,'A1I9')
          endif
        endif
        if Level==3 then
          if GetUnitAbilityLevel(Source,'A1IE')>0 then
            call UnitRemoveAbility(Source,'A1IE')
            call UnitRemoveAbility(Source,'B0C9')
          endif
          if GetUnitAbilityLevel(Source,'A1IF')>0 then
            call UnitRemoveAbility(Source,'A1IF')
            call UnitRemoveAbility(Source,'B0C9')
          endif
          if GetUnitAbilityLevel(Source,'A1IG')==0 then
            call UnitAddAbility2(Source,'A1IG')
            call UnitMakeAbilityPermanent(Source,true,'A1I7')
            call UnitMakeAbilityPermanent(Source,true,'A1IA')
          endif
        endif
      endif
    elseif IsDead(Source)==false then
      set mult=2+Level
      call SetWidgetLife(Source,GetWidgetLife(Source)+GetUnitState(Source,UNIT_STATE_MAX_LIFE)/1000*mult)//1000 = 0.1% per 0.1s
    endif
    call SaveReal(HY,h,415,seen*1.)
    call SaveReal(HY,h,416,fade*1.)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Slark_ShadowDance_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveReal(HY,h,415,0.0)
  call SaveReal(HY,h,416,0.0)
  call SaveReal(HY,h,414,TimerGetElapsed(GlobalTimer))
  call SaveUnitHandle(HY,h,2,GetTriggerUnit())
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function TIG))
  set t=null
endfunction

function Slark_ShadowDance_Attacked takes unit attacker, unit victim returns boolean
  if GetUnitAbilityLevel(victim,'A1HX')>0 then
    call IssueImmediateOrder(attacker,"stop")
    call Error(GetOwningPlayer(attacker),"This unit can't be attacked")
    return true
  endif
  return false
endfunction

function Slark_ImitateInvis takes nothing returns nothing
  local unit target=GetSpellTargetUnit()
  local unit u=GetTriggerUnit()
  if GetUnitAbilityLevel(target,'A1HX')>0 and ((IsUnitEnemy(target,GetOwningPlayer(u)) and GetUnitAbilityLevel(u,'Aloc')==0) or IsUnitType(u,UNIT_TYPE_HERO)==false and GetUnitTypeId(u)!='u00L') then
    call IssueImmediateOrder(u,"stop")
    if IsUnitType(u,UNIT_TYPE_HERO)==false then
      call Error(GetOwningPlayer(u),"This unit can't be target for spell")
    endif
  endif
  set target=null
  set u=null
endfunction

function Slark_ShadowDance_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_CAST)
  call TriggerAddCondition(t,Condition(function Slark_ImitateInvis))
  set t=null
endfunction

function Slark_EssenceShift_RestoreStats takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer agi=LoadInteger(HY,h,(422))
  local integer str=LoadInteger(HY,h,(423))
  local integer int=LoadInteger(HY,h,(424))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if(LoadBoolean(HY,h,(276)))==false and GetTriggerUnit()==Source then
      call SaveBoolean(HY,h,(276),(true))
      call SetHeroAgi(Source,GetHeroAgi(Source,false)-agi-str-int,true)
      call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)-agi-str-int)
      if LoadInteger(HY,h,0)>0 then
        call LoDStat_Sub(Source,LoadInteger(HY,h,0),"damage")
      endif
    elseif(LoadBoolean(HY,h,(277)))==false and GetTriggerUnit()==Target then
      call SaveBoolean(HY,h,(277),(true))
      call SetHeroAgi(Target,GetHeroAgi(Target,false)+agi,true)
      call SetHeroStr(Target,GetHeroStr(Target,false)+str,true)
      call SetHeroInt(Target,GetHeroInt(Target,false)+int,true)
    endif
  else
    if(LoadBoolean(HY,h,(276)))==false then
      call SaveBoolean(HY,h,(276),(true))
      call SetHeroAgi(Source,GetHeroAgi(Source,false)-agi-str-int,true)
      call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)-agi-str-int)
      if LoadInteger(HY,h,0)>0 then
        call LoDStat_Sub(Source,LoadInteger(HY,h,0),"damage")
      endif
    endif
    if(LoadBoolean(HY,h,(277)))==false then
      call SaveBoolean(HY,h,(277),(true))
      call SetHeroAgi(Target,GetHeroAgi(Target,false)+agi,true)
      call SetHeroStr(Target,GetHeroStr(Target,false)+str,true)
      call SetHeroInt(Target,GetHeroInt(Target,false)+int,true)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Slark_EssenceShift_StealPart takes unit Source,unit Target returns nothing
  local integer Level=GetUnitAbilityLevel(Source,'A1HR')+GetUnitAbilityLevel(Source,'QP1F')
  local trigger t
  local integer h
  local integer agi
  local integer str
  local integer int
  local real dur
  local integer i=LoadInteger(MHT,GetHandleId(Source),EssenceShiftHash)+1
  local integer pid=GetPlayerId(GetOwningPlayer(Source))
  set agi=IMinBJ(GetHeroAgi(Target,false)-1,1)
  set str=IMinBJ(GetHeroStr(Target,false)-1,1)
  set int=IMinBJ(GetHeroInt(Target,false)-1,1)
  if i>3 then
    set i=1
  endif
  call SaveInteger(MHT,GetHandleId(Source),EssenceShiftHash,i)
  if((not(Mode_BO))and (i<3 or IsUnitIdType(GetUnitTypeId(Source),UNIT_TYPE_RANGED_ATTACKER)==false)) or Mode_BO then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SetHeroAgi(Source,GetHeroAgi(Source,false)+agi+str+int,true)
    call SaveInteger(HeroStats,GetHandleId(Source),31,LoadInteger(HeroStats,GetHandleId(Source),31)+agi+str+int)
    if GetUnitPrimaryAttribute(Source)!=2 then
      call LoDStat_Add(Source,agi+str+int,"damage")
      call SaveInteger(HY,h,0,agi+str+int)
    endif
    call SetHeroAgi(Target,GetHeroAgi(Target,false)-agi,true)
    call SetHeroStr(Target,GetHeroStr(Target,false)-str,true)
    call SetHeroInt(Target,GetHeroInt(Target,false)-int,true)
    call SaveInteger(HY,h,422,agi)
    call SaveInteger(HY,h,424,str)
    call SaveInteger(HY,h,423,int)
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,17,Target)
    call SaveBoolean(HY,h,276,false)
    call SaveBoolean(HY,h,277,false)
    set dur=20*Level
    call TriggerRegisterTimerEvent(t,dur,false)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function Slark_EssenceShift_RestoreStats))
    set t=null
  endif
endfunction

function Slark_EssenceShift_Actions takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  if GetTriggerEventId()!=EVENT_UNIT_DEATH then
    call Slark_EssenceShift_StealPart(Source,Target)
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function Slark_EssenceShift_OnHit takes unit attacker, unit target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function Slark_EssenceShift_Actions))
  call TriggerRegisterUnitEvent(t,attacker,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DEATH)
  call SaveUnitHandle(HY,h,2,attacker)
  call SaveUnitHandle(HY,h,17,target)
  set t=null
endfunction

function TAG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Caster=LoadUnitHandle(HY,h,(19))
  local integer Level=LoadInteger(HY,h,5)
  if GetTriggerEvalCount(t)>(4)/ .03 then
    call KillUnit(Caster)
    call SetTint(Source,-1,-1,-1,255)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetUnitX(Caster,GetUnitX(Source))
    call SetUnitY(Caster,GetUnitY(Source))
  endif
  //call UnitRemoveAbility(Source,'A04R')
  call UnitRemoveType(Source,UNIT_TYPE_PEON)
  set t=null
  set Source=null
  set Caster=null
  return false
endfunction

function Slark_ShadowDance takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A1IN')
  local real d=4
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'h0B1',GetUnitX(Source),GetUnitY(Source),0)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer i=-5
  local integer trans=255
  call ShowUnit(Source,false)
  call ShowUnit(Source,true)
  if GetLocalPlayer()==GetOwningPlayer(Source)then
    call ClearSelection()
    call SelectUnit(Source,true)
  endif
  call AddTimedAbility(Source,'A1HW',1,d)
  call AddTimedAbility(Source,'A1HX',1,d)
  call UnitAddType(Source,UNIT_TYPE_PEON)
  if IsUnitAlly(Source,GetLocalPlayer()) then
    set trans=0
  endif
  call SetTint(Source,-1,-1,-1,trans)
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function TAG))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  
  set Source=null
  set Caster=null
  set t=null
endfunction

function T3G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local lightning ZQ8=LoadLightningHandle(HY,h,(196))
  local integer Level=LoadInteger(HY,h,5)
  local real SourceX=LoadReal(HY,h,(189))
  local real SourceY=LoadReal(HY,h,(190))
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real AO8
  local real AP8
  local real LastX=LoadReal(HY,h,(23))
  local real LastY=LoadReal(HY,h,(24))
  local real a
  local real YR8=DistanceBetweenXY(LastX,LastY,TargetX,TargetY)
  call SaveReal(HY,h,(23),((TargetX)*1.))
  call SaveReal(HY,h,(24),((TargetY)*1.))
  if YR8>100 or Count>(3.5/ .03)or IsMagicImmune(Target) then
    call DestroyLightning(ZQ8)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call MoveLightning(ZQ8,true,SourceX,SourceY,TargetX,TargetY)
    if DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)>325 then
      set a=Atan2(TargetY-SourceY,TargetX-SourceX)
      set AO8=SourceX+(325)*Cos(a)
      set AP8=SourceY+(325)*Sin(a)
      call SetUnitX(Target,AO8)
      call SetUnitY(Target,AP8)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set ZQ8=null
  return false
endfunction

function T6G takes unit Source,unit Target,integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local lightning ZQ8=AddLightning("PONC",true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
  call SetLightningColor(ZQ8,1,1,1,1)
  call SaveLightningHandle(HY,h,(196),(ZQ8))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(189),((GetUnitX(Source))*1.))
  call SaveReal(HY,h,(190),((GetUnitY(Source))*1.))
  call SaveReal(HY,h,(23),((GetUnitX(Target))*1.))
  call SaveReal(HY,h,(24),((GetUnitY(Target))*1.))
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function T3G))
  call DamageTarget(Source,Target,1,60*Level)
  call IssueTargetOrderById(Source,851983,Target)
  set t=null
  set ZQ8=null
endfunction

function TLG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local integer Level=LoadInteger(HY,h,5)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real a=LoadReal(HY,h,(13))
  local real PLE=LoadReal(HY,h,(189))
  local real P1E=LoadReal(HY,h,(190))
  local real TargetX=LoadReal(HY,h,(47))
  local real TargetY=LoadReal(HY,h,(48))
  local real AO8=PLE+(30*(20+4*2)/ 30)*Count*Cos(a*bj_DEGTORAD)
  local real AP8=P1E+(30*(20+4*2)/ 30)*Count*Sin(a*bj_DEGTORAD)
  local real AHE=SquareRoot((AO8-TargetX)*(AO8-TargetX)+(AP8-TargetY)*(AP8-TargetY))
  local real AIE=700
  local real AJE=175
  local real AKE=(1-AHE/ AIE)*AJE*2
  local group g=GetAvailableGroup()
  local unit Target
  if Count==1 then
    call SetUnitTimeScale(Source,1.5)
  endif
  if AKE>AJE then
    set AKE=AJE*2-AKE
  endif
  if IsBuggyFlying(Source)==false then
    call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source)+RMaxIF(AKE,0),0)
  endif
  if IsUnitType(Source,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
  endif
  call SetUnitX(Source,SafeX50(AO8))
  call SetUnitY(Source,SafeY50(AP8))
  call SetUnitFacing(Source,a)
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,AO8,AP8,120,Condition(function DF9))
  set Target=FirstOfGroup(g)
  call KillGroup(g)
  if AHE<30 or Target!=null or GetTriggerEvalCount(t)>75 then
    if IsBuggyFlying(Source)==false then
      call SetUnitFlyHeight(Source,GetUnitDefaultFlyHeight(Source),0)
    endif
    call SetUnitFacing(Source,a)
    call SetUnitTimeScale(Source,1)
    call SetUnitAnimation(Source,"stand")
    call SetUnitPathing(Source,true)
    call UnitRemoveAbility(Source,'A1J6')
    call KillTrees(GetUnitX(Source),GetUnitY(Source),100)
    if Target!=null and IsMagicImmune(Target)==false then
      call AddTimedKeyToUnit(Target,4408,5)
      call T6G(Source,Target,Level)
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  set g=null
  return false
endfunction

function Slark_Pounce takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A1J7')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real YR8=700
  local real a=GetUnitFacing(Source)
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=SafeX50(SourceX+YR8*Cos(a*bj_DEGTORAD))
  local real TargetY=SafeY50(SourceY+YR8*Sin(a*bj_DEGTORAD))
  call UnitAddAbility2(Source,'Amrf')
  call UnitRemoveAbility(Source,'Amrf')
  call SetUnitPathing(Source,false)
  call UnitAddAbility2(Source,'A1J6')
  call TriggerRegisterTimerEvent(t,.03,true)
  call TriggerAddCondition(t,Condition(function TLG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveReal(HY,h,(189),((SourceX)*1.))
  call SaveReal(HY,h,(190),((SourceY)*1.))
  call SaveReal(HY,h,(47),((TargetX)*1.))
  call SaveReal(HY,h,(48),((TargetY)*1.))
  set Source=null
  set t=null
endfunction

function T5G takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local real Damage=LoadReal(HY,h,(20))
  call DamageTarget(Source,Target,1,Damage)
  set Source=null
  set Target=null
endfunction

function T2G takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local trigger t=AddProjectile(Source,Target,'h0BP',"T5G",700,false)
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A04A')
  local real Damage
  if Level==1 then
    set Damage=85
  elseif Level==2 then
    set Damage=165
  elseif Level==3 then
    set Damage=225
  elseif Level==4 then
    set Damage=300
  endif
  call SaveReal(HY,h,(20),((Damage)*1.))
  set Source=null
  set Target=null
  set t=null
endfunction

function QoP_ScreamOfPain takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local integer Level=GetUnitAbilityLevel(Source,'A04A')
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),500,Condition(function LR8))
  call ForGroup(g,function T2G)
  call KillGroup(g)
  call PlaySoundOnUnitBJ(QE,100,Source)
  set Source=null
  set g=null
endfunction

function myWavesFilter takes unit u, unit dummy returns boolean
  return(IsUnitEnemy(dummy,GetOwningPlayer(u))and( AliveNonBuildOrMarker(u)))!=null
endfunction

function myWavesDamage takes unit u, unit victim, integer dt, real dmg, boolean immune returns nothing
  if myWavesFilter(victim,u) then
    if IsMagicImmune(victim)==false then
      call DamageTarget(u,victim,dt,dmg)
    elseif immune then
      call DamageTarget(u,victim,7,dmg)
    endif
  endif
endfunction

function myWaves takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local real dmg=LoadReal(HY,h,0)
  local real angle=LoadReal(HY,h,3)*bj_DEGTORAD
  local real speed=LoadReal(HY,h,4)
  local real tX=LoadReal(HY,h,5)
  local real tY=LoadReal(HY,h,6)
  local real startaoe=LoadReal(HY,h,8)
  local real step=LoadReal(HY,h,9)
  local unit victim
  local group g
  local group gg
  local boolean isDynamic=LoadBoolean(HY,h,10)
  local boolean final=false
  local integer dt=LoadInteger(HY,h,1)
  local boolean immune=LoadBoolean(HY,h,0)
  if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED then
    call SetUnitX(u,GetUnitX(u)+speed*Cos(angle))
    call SetUnitY(u,GetUnitY(u)+speed*Sin(angle))
    call SaveInteger(HY,h,12,LoadInteger(HY,h,12)+1)
    if DistanceBetweenXY(GetUnitX(u),GetUnitY(u),tX,tY) < 100 or LoadInteger(HY,h,12) > LoadInteger(HY,h,13) then
      set final=true
      call SetUnitX(u,tX)
      call SetUnitY(u,tY)
    endif
  else
    set victim=GetTriggerUnit()
  endif
  if isDynamic then
    set g=LoadGroupHandle(HY,h,2)
    set gg=GetAvailableGroup()
    set tt_unit1=u
    call GroupEnumUnitsInRange(gg,GetUnitX(u),GetUnitY(u),startaoe + step * (GetTriggerEvalCount(t)-1),Condition(function LA8))
    call GroupRemoveGroup(g,gg)
    loop
      set victim=FirstOfGroup(gg)
      exitwhen victim==null
      call GroupRemoveUnit(gg,victim)
      call GroupAddUnit(g,victim)
      call myWavesDamage(LoadUnitHandle(HY,h,17),victim,dt,dmg,immune)
    endloop
    call KillGroup(gg)
    set gg=null
    if final then
      call KillGroup(g)
    endif
  else
    call myWavesDamage(LoadUnitHandle(HY,h,17),victim,dt,dmg,immune)
  endif
  if final then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(u)
    //call echo("destroyed")
  endif
  set u=null
  set g=null
  set gg=null
  set t=null
endfunction

function mySonicWave takes unit caster, integer uid, real dmg, real distance, real startaoe, real aoe, real fX, real fY, real tX, real tY, real speed, integer dt, boolean immune returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real angle=AngleBetweenXY(fX,fY,tX,tY)
  local unit u=CreateUnit(GetOwningPlayer(caster),uid,fX,fY,angle)
  local real per=0.02
  call SetUnitX(u,fX+startaoe*Cos(angle*bj_DEGTORAD))
  call SetUnitY(u,fY+startaoe*Sin(angle*bj_DEGTORAD))
  //call echo(R2S(fX)+" - "+R2S(fY)+" : "+R2S(GetUnitX(u))+" - "+R2S(GetUnitY(u)))
  call SaveUnitHandle(HY,h,0,u)
  call SaveReal(HY,h,0,dmg)
  call SaveReal(HY,h,1,distance)
  call SaveReal(HY,h,2,aoe)
  call SaveUnitHandle(HY,h,17,caster)
  if startaoe != aoe then
    call SaveReal(HY,h,8,startaoe)
    call SaveReal(HY,h,9,(aoe - startaoe) * per)
    call SaveGroupHandle(HY,h,2,GetAvailableGroup())
    call SaveBoolean(HY,h,10,true)//its dynamic aoe
  else
    call TriggerRegisterUnitInRange(t,u,aoe+25,Condition(function ReturnTrue))
  endif
  call SaveReal(HY,h,3,angle)
  call SaveReal(HY,h,4,speed * per)
  call SaveInteger(HY,h,13,R2I(distance / LoadReal(HY,h,4))+1)
  call SaveReal(HY,h,5,GetUnitX(u)+distance*Cos(angle*bj_DEGTORAD))
  call SaveReal(HY,h,6,GetUnitY(u)+distance*Sin(angle*bj_DEGTORAD))
  call SaveInteger(HY,h,1,dt)//damage type
  call SaveBoolean(HY,h,0,immune)//affects magic immune
  call TriggerRegisterTimerEvent(t,per,true)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerAddCondition(t,Condition(function myWaves))
  set u=null
  set t=null
endfunction

function MyQoPSW takes nothing returns nothing
  local real dmg=200+125*GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())
  call mySonicWave(GetTriggerUnit(),'h02C',dmg,800,100,450,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetSpellTargetX(),GetSpellTargetY(),800,3,true)
endfunction

function MyQoPSWBasic takes nothing returns nothing
  local real dmg=190+100*GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId())
  call mySonicWave(GetTriggerUnit(),'h02C',dmg,800,100,450,GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),GetSpellTargetX(),GetSpellTargetY(),800,3,true)
endfunction

function QoP_SonicWave takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  local integer id=GetSpellAbilityId()
  local integer lvl=GetUnitAbilityLevel(caster,id)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  if GetSpellAbilityId()=='A28R' then
    set id='A42U'
  else
    set id='A42V'
  endif
  call UnitAddAbility(d,id)
  call SetUnitAbilityLevel(d,id,lvl)
  call IssuePointOrderById(d,852218,x,y)
  set caster=null
  set d=null
endfunction

function U8G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call InterruptUnit(Source)
  endif
  set t=null
  set Source=null
  return false
endfunction

function ShadowShaman_Shackles takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A00P')
  call TriggerRegisterTimerEvent(t,1+1.75+.75*Level,false)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function U8G))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set t=null
endfunction

function UEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit target = LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,5)
  
  if GetTriggerEventId()==EVENT_UNIT_DEATH or GetTriggerEvalCount(t)==4 or IsMagicImmune(Source)then
    call Buff_Remove(target,LoDBuff_BuffID[11])
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  if GetTriggerEventId()!=EVENT_WIDGET_DEATH then
    call DamageTarget(Source,target,1,10 + (Level-1)*20)
  endif
  
  set t=null
  set target = null
  set Source=null
  return false
endfunction

function Phoenix_Dive_DisarmEnd takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer c=LoadInteger(HY,h,0)+1
  if IsMagicImmune(u) or c>20 then
    call UnitRemoveAbility(u,'A43V')
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  else
    call SaveInteger(HY,h,0,c)
  endif
  set u=null
  set t=null
endfunction

function Phoenix_Dive_Disarm takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.1,true,function Phoenix_Dive_DisarmEnd)
  call UnitAddAbility2(u,'A43V')
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function UFG takes unit u, unit Source, integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function UEG))
  call Buff_Add(Source,LoDBuff_AbilID[11],LoDBuff_BuffID[11],4)
  if IsUnitType(Source,UNIT_TYPE_HERO) then
    call Phoenix_Dive_Disarm(Source)
  endif
  call SaveUnitHandle(HY,h,2,u)
  call SaveUnitHandle(HY,h,17,Source)
  call SaveInteger(HY,h,5,(Level))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",Source,"chest")))
  set t=null
endfunction

function UGG takes nothing returns boolean
  local unit u = GetEnumUnit()
  
  if IsUnitInGroup(u,MQ8)==false and IsMagicImmune(u)==false then
    call GroupAddUnit(MQ8,u)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\FireBlast.mdx",u,"chest"))
    call UFG(MS8,u,MR8)
  endif
  
  set u = null
  return false
endfunction

function UHG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=(LoadInteger(HY,h,(34)))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real SourceX=(LoadReal(HY,h,(189)))
  local real SourceY=(LoadReal(HY,h,(190)))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real a=(LoadReal(HY,h,(13)))
  local real UIG=(1-I2R(Count)/ 50)*bj_PI
  local real UJG=1400/ 2*Cos(UIG)
  local real UKG=500/ 2*Sin(UIG)
  local real x=SafeX50(TargetX+UJG*Cos(a)-UKG*Sin(a))
  local real y=SafeY50(TargetY+UJG*Sin(a)+UKG*Cos(a))
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local group g
  local integer Level=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()!='A1Z2' and Count>0)or Count>100 or L88(Source)then
    call KillTrees(x,y,300)
    call SetTint(Source,-1,-1,-1,255)
    if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))=='A1RJ' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1RJ',true)
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20N',false)
    call SetUnitPathing(Source,true)
    call KillGroup(HND)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    if ModuloInteger(Count,10)==0 then
      call KillTrees(x,y,200)
    endif
    call SaveInteger(HY,h,(34),(Count+1))
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitX(Source,x)
    call SetUnitY(Source,y)
    call SetUnitFacing(Source,(a+UIG-bj_PI/ 2)*bj_RADTODEG)
    set g=GetAvailableGroup()
    set MQ8=HND
    set tt_unit1=Source
    set MS8=Source
    set MR8=Level
    call GroupEnumUnitsInRange(g,x,y,325,Condition(function NonImmuneEnemyFilter))
    call ForGroup(g,function UGG)
    call KillGroup(g)
  endif
  set t=null
  set Source=null
  set g=null
  set HND=null
  return false
endfunction

function Phoenix_Dive takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real a=AngleBetweenXY(SourceX,SourceY,GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
  local real TargetX=SourceX+1400/ 2*Cos(a)
  local real TargetY=SourceY+1400/ 2*Sin(a)
  local real life = GetWidgetLife(Source)
  call SetWidgetLife(Source,life - life*.15)
  call AddTimedKeyToUnit(Source,4301,2)
  call AddTimedKeyToUnit(Source,4415,2)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function UHG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,(189),((SourceX)*1.))
  call SaveReal(HY,h,(190),((SourceY)*1.))
  call SaveReal(HY,h,(47),((TargetX)*1.))
  call SaveReal(HY,h,(48),((TargetY)*1.))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveGroupHandle(HY,h,(133),(GetAvailableGroup()))
  call SetUnitPathing(Source,false)
  call SetTint(Source,-1,-1,-1,50)
  call UnitAddAbility2(Source,'A20N')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1RJ',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A20N',true)
  set t=null
  set Source=null
endfunction

function UOG takes nothing returns nothing
  local unit Source=MT8
  local unit Target=GetEnumUnit()
  call DamageTarget(Source,Target,1,40+20*MU8)
  call Z48("Doodads\\Cinematic\\FireTrapUp\\FireTrapUp.mdl",Target,"origin",1)
  set Source=null
  set Target=null
endfunction

function UPG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,0)
  local group g
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt_unit1=Source
    set MT8=Source
    set MU8=Level
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1025,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function UOG)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function UQG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit URG=LoadUnitHandle(HY,h,589)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    //call echo(R2S(GetEventDamage())+" from "+GetUnitName(GetEventDamageSource())+" "+B2S(IsFakeDamage)+" "+I2S(FakeDamageType))
    if IsFakeDamage or IsUnitIllusion(GetEventDamageSource()) then
      call HealUnitFor(URG,GetEventDamage())
    endif
  else
    if GetUnitX(URG)!=x or GetUnitY(URG)!=y then
      call SetUnitPosition(URG,x,y)
    endif
    if GetUnitY(Source)!=x or GetUnitY(Source)!=y then
      call SetUnitPosition(Source,x,y)
    endif
    set URG = LoadUnitHandle(HY,h,19)
    call SetUnitX(URG,GetWidgetX(Source))
    call SetUnitY(URG,GetWidgetY(Source))
  endif
  if GetTriggerEvalCount(t)==1 then
    call PauseUnit(Source,true)
  endif
  set t=null
  set URG=null
  set Source=null
  return false
endfunction

function USG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit target=LoadUnitHandle(HY,h,3)
  local unit UTG=LoadUnitHandle(HY,h,588)
  local unit URG=LoadUnitHandle(HY,h,589)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local unit WCE=LoadUnitHandle(HY,h,239)
  local integer Level=LoadInteger(HY,h,0)
  local group g
  local unit Caster
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call StopSound(IF,false,false)
    call ShowUnit(UTG,false)
    call ShowUnit(WCE,false)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call ShowUnit(Source,true)
    call UnitRemoveAbility(Source,'A04R')
    call SetUnitInvulnerable(Source,false)
    call PauseUnit(Source,false)
    
    if target!=null and target!=Source then
      call ShowUnit(target,true)
      call UnitRemoveAbility(target,'A04R')
      call SetUnitInvulnerable(target,false)
      call PauseUnit(target,false)
      if GetLocalPlayer()==GetOwningPlayer(target)then
        call ClearSelection()
        call SelectUnit(target,true)
      endif
      call SetWidgetLife(target,1)
      set Caster=CreateUnit(GetOwningPlayer(GetKillingUnit()),'e00E',0,0,0)
      call UnitRemoveBuffs(target,true,true)
      call UnitRemoveAbility(target,'Aetl')
      call DamageTarget(Caster,target,4,100000000)
    endif
    if GetLocalPlayer()==GetOwningPlayer(Source)then
      call ClearSelection()
      call SelectUnit(Source,true)
    endif
    call SetWidgetLife(Source,1)
    set Caster=CreateUnit(GetOwningPlayer(GetKillingUnit()),'e00E',0,0,0)
    call UnitRemoveBuffs(Source,true,true)
    call UnitRemoveAbility(Source,'Aetl')
    call DamageTarget(Caster,Source,4,100000000)
    set Caster=null
  else
    if GetTriggerEvalCount(t)==1 then
      call SetUnitFlyHeight(URG,0,200)
    elseif GetTriggerEvalCount(t)==2 then
      call PauseUnit(URG,false)
      call UnitApplyTimedLife(URG,'BTLF',.1)
      call StopSound(IF,false,false)
      call StartSound(OF)
      call DestroyEffect(AddSpecialEffect("war3mapImported\\FireNova2.mdx",GetUnitX(UTG),GetUnitY(UTG)))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      
      call ShowUnit(Source,true)
      call UnitRemoveAbility(Source,'A04R')
      call SetUnitInvulnerable(Source,false)
      call SetUnitAnimationByIndex(Source,8)
      call QueueUnitAnimation(Source,"idle")
      call PauseUnit(Source,false)
      if GetLocalPlayer()==GetOwningPlayer(Source)then
        call ClearSelection()
        call SelectUnit(Source,true)
      endif
      
      if target!=null and target!=Source then
        call ShowUnit(target,true)
        call UnitRemoveAbility(target,'A04R')
        call SetUnitInvulnerable(target,false)
        call SetUnitAnimationByIndex(target,8)
        call QueueUnitAnimation(target,"idle")
        call PauseUnit(target,false)
        if GetLocalPlayer()==GetOwningPlayer(target) and IsUnitIllusion(target)==false then
          call ClearSelection()
          call SelectUnit(target,true)
        endif
        call SetWidgetLife(target,GetUnitState(target,UNIT_STATE_MAX_LIFE))
        call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MAX_MANA))
      endif
      call ShowUnit(UTG,false)
      call ShowUnit(WCE,false)
      
      call SetWidgetLife(Source,GetUnitState(Source,UNIT_STATE_MAX_LIFE))
      call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MAX_MANA))
      set Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
      call UnitAddAbility2(Caster,'A1ZT')
      call SetUnitAbilityLevel(Caster,'A1ZT',Level)
      call IssueImmediateOrderById(Caster,852127)
      set Caster=null
    endif
  endif
  set t=null
  set Source=null
  set UTG=null
  set WCE=null
  set URG=null
  set g=null
  set target=null
  return false
endfunction

function UUG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit UTG
  local unit URG
  local unit WCE=CreateUnit(GetOwningPlayer(Source),'h0CL',GetUnitX(Source),GetUnitY(Source),0)
  local integer Level=GetUnitAbilityLevel(Source,'A1RK')+GetUnitAbilityLevel(Source,'A43H')
  local unit Caster
  local unit target=GetSpellTargetUnit()
  
  set UTG=CreateUnit(GetOwningPlayer(Source),'h0BX',x,y,0)
  if Level==1 then
    set URG=CreateUnit(GetOwningPlayer(Source),'h0CV',x,y,0)
  elseif Level==2 then
    set URG=CreateUnit(GetOwningPlayer(Source),'h0CX',x,y,0)
  elseif Level==3 then
    set URG=CreateUnit(GetOwningPlayer(Source),'h0CW',x,y,0)
  endif
  call AddSpecialEffectTarget("war3mapImported\\PhoenixDown_2.mdl",UTG,"origin")
  if GetLocalPlayer()==GetOwningPlayer(Source)then
    call ClearSelection()
    call SelectUnit(URG,true)
  endif
  call KillTrees(x,y,400)
  
  call RefreshWithBalance(Source,false)
  call RemoveAbilsForUnit(Source)
  call ShowUnit(Source,false)
  call UnitAddAbility2(Source,'A04R')
  call SetNapalmFactory(Source,0,0)
  call SetUnitInvulnerable(Source,true)
  call UnitRemoveBuffs(Source,true,true)
  
  if target!=null and target!=Source then
    if IsUnitIllusion(target)==false then
      call RefreshWithBalance(target,false)
      call RemoveAbilsForUnit(target)
      call SetNapalmFactory(target,0,0)
      call SetUnitInvulnerable(target,true)
      call UnitRemoveBuffs(target,true,true)
    endif
    call ShowUnit(target,false)
    call UnitAddAbility2(target,'A04R')
    call SetUnitX(target,x)
    call SetUnitY(target,y)
  endif
  
  call StartSound(IF)
  call UnitRemoveAbility(URG,'Arav')
  call UnitApplyTimedLife(UTG,'BTLF',6.1)
  call UnitApplyTimedLife(WCE,'BTLF',6.1)
  call UnitApplyTimedLife(URG,'BTLF',6.1)
  call TriggerRegisterTimerEvent(t,5.2,false)
  call TriggerRegisterTimerEvent(t,6,false)
  call TriggerAddCondition(t,Condition(function USG))
  call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,3,target)
  call SaveUnitHandle(HY,h,588,UTG)
  call SaveUnitHandle(HY,h,589,URG)
  call SaveUnitHandle(HY,h,239,WCE)
  call SaveReal(HY,h,6,GetUnitX(Source)*1.)
  call SaveReal(HY,h,7,GetUnitY(Source)*1.)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function UPG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,URG,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function UQG))
  call SaveUnitHandle(HY,h,589,URG)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,GetUnitX(Source)*1.)
  call SaveReal(HY,h,7,GetUnitY(Source)*1.)
  if EM9(Source,'I0A8')then
    set Caster = CreateUnit(GetOwningPlayer(Source),'e00E',x,y,0)
    call UnitAddAbility2(Caster,'A04I')
    call SaveUnitHandle(HY,h,19,Caster)
    set Caster = null
  endif
  set WCE=null
  set t=null
  set Source=null
  set UTG=null
  set URG=null
  set target=null
endfunction

function Phoenix_Supernova takes nothing returns nothing
  if LoadInteger(HY,GetHandleId(GetTriggerUnit()),1111111)!=1 then
    call UUG()
  endif
endfunction

function Phoenix_Supernova_Preload takes nothing returns nothing
  call PreloadQueryAdd('A1ZT')
endfunction

function Phoenix_Sunray_End takes unit u, timer t, integer info returns nothing
  local player p = GetOwningPlayer(u)
  local integer save = GetHandleId(u)
  
  call DestroyLightning(LoadLightningHandle(MHT,info,6))
  call DestroyLightning(LoadLightningHandle(MHT,info,5))
  call DestroyLightning(LoadLightningHandle(MHT,info,4))
  call DestroyLightning(LoadLightningHandle(MHT,info,3))
  call DestroyLightning(LoadLightningHandle(MHT,info,2))
  call KillGroup(LoadGroupHandle(MHT,info,1))
  
  call SaveInteger(HY,save,4312,2)
  
  if LoadInteger(HY,save,704)==0 or LoadInteger(HY,save,704)=='A1YY' then
    call SetPlayerAbilityAvailable2(p,'A1YY',true)
  endif
  if LoadInteger(HY,save,4311)!=1 then
    call UnitRemoveAbility(u,'Abun')
  endif
  
  call SetPlayerAbilityAvailable2(p,'A1YY',true)
  call SaveBoolean(MHT,save,'A1YY',false)
  call SaveBoolean(MHT,save,'A205',false)
  call UnitRemoveAbility(u,'A205')
  call UnitRemoveAbility(u,'A1Z3')
  call SetUnitPathing(u,true)
  
  call SetUnitAnimation(u,"stand")
  
  call StopSound(WF,false,true)
  
  call Timer_End(t)
  set p=null
endfunction

function Phoenix_Sunray_Target_Condition takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if GetUnitAbilityLevel(t,'A04R')==0 and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and t!=group_temp_unit[0] and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)!=null) then
    call GroupAddUnit(LoadGroupHandle(MHT,group_temp_integer[0],1),t)
  endif
  
  set t = null
  return false
endfunction

function Phoenix_Sunray_Targets takes nothing returns nothing
  local unit t = GetEnumUnit()
  local real amount = (group_temp_real[0] + group_temp_real[1]*GetUnitState(t,UNIT_STATE_MAX_LIFE))/5.
  
  if IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t))then
    call SetWidgetLife(t,GetWidgetLife(t) + amount*0.5)
  else
    call DamageTarget(group_temp_unit[0],t,3,amount)
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\FireRayTarget.mdx",t,"origin"))
    call TimedReveal(GetOwningPlayer(t),2,GetUnitX(group_temp_unit[0]),GetUnitY(group_temp_unit[0]),500)
  endif
  
  set t = null
endfunction

function Phoenix_Sunray_Stop takes unit u, integer spell returns nothing
  //disables sunray when the units casts
  //supernova, spell steal, or cancel sunray
  if spell=='A1Z3' or spell=='A1RK' or spell=='A43H' or spell=='A27H' or spell=='A30J' then
    call SaveBoolean(MHT,GetHandleId(u),'A1YY',true)
  endif
endfunction

function Phoenix_Sunray_Orders takes unit u, integer order returns nothing
  local integer info
  local real x2
  local real y2
  local real x1
  local real y1
  
  //pi parti :D
  //2 pi: 6.28318
  //1 pi: 3.14159
  //cake > pi \:D/
  
  if GetUnitAbilityLevel(u,'A205')>0then
    if order==851983 then //prevents the unit from fleeing
      call DisableTrigger(GAME_TRIGGER)
      call InterruptUnit(u)
      call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))
      call EnableTrigger(GAME_TRIGGER)
      return
    endif
    
    set info = LoadInteger(MHT,GetHandleId(u),'A1YY')
    
    if order==852177then //toggle movement on and off
      call SaveBoolean(MHT,info,1,true)
      call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))
    elseif order==852178then
      call SaveBoolean(MHT,info,1,false)
      call SetUnitAnimation(u,"stand")
    endif
    
    if order==851971 then //change angle order
      set x1 = GetWidgetX(u)
      set y1 = GetWidgetY(u)
      
      if GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
        set x2 = GetWidgetX(GetOrderTargetUnit())
        set y2 = GetWidgetY(GetOrderTargetUnit())
      else
        set x2 = GetOrderPointX()
        set y2 = GetOrderPointY()
      endif
      
      set x1 = Atan2(y2-y1,x2-x1)
      
      if 0 > x1 then
        //call BJDebugMsg("adding pi to angle cause blizzard is dumb") //BEST COMMENT EVA!!! >:333
        set x1 = x1 + 6.28318
      endif
      
      call SaveBoolean(MHT,info,0,true)
      call SaveReal(MHT,info,0,x1)
      call SaveReal(MHT,info,1,GetUnitFacing(u)*bj_DEGTORAD)
      
      call DisableTrigger(GAME_TRIGGER)
      call InterruptUnit(u)
      call EnableTrigger(GAME_TRIGGER)
    endif
  endif
endfunction

function Phoenix_Sunray_Duration takes nothing returns nothing
  local group g = null
  local lightning l = null
  local timer t = GetExpiredTimer()
  local integer load
  local integer level
  local integer loopA = 2
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local boolean active
  local real offset
  local real angle
  local real ax2
  local real ay2
  local real ax1
  local real ay1
  local real x2
  local real y2
  local real z2
  local real x1
  local real y1
  local real z1
  set load = GetHandleId(u)
  if IsDead(u) or IsUnitDisabled(u)or IsUnitSilenced(u) or IsUnitPaused(u) or IsUnitCycloned(u) or LoadInteger(HY,GetHandleId(u),704)==-1 or count>239 or LoadBoolean(MHT,load,'A1YY') then
    call Phoenix_Sunray_End(u,t,info)
    set t = null
    set u = null
    return
  endif
  set x1 = GetWidgetX(u)
  set y1 = GetWidgetY(u)
  set ax2 = GetWidgetLife(u)
  set angle = GetUnitFacing(u)*bj_DEGTORAD
  call SetWidgetLife(u,ax2 - ax2*0.0015)//6*0.025*0.01
  if LoadBoolean(MHT,info,0) then
    set angle = LoadReal(MHT,info,0)
    set ay2 = angle - GetUnitFacing(u)*bj_DEGTORAD
    set offset = LoadReal(MHT,info,1)
    set ax2 = angle - offset
    if ax2 > 0 then
      set ax1 = bj_DEGTORAD/2
    else
      set ax1 = -bj_DEGTORAD/2
    endif
    if -180*bj_DEGTORAD > ax2 or ax2 > 180*bj_DEGTORAD then
      set ax1 = -ax1
    endif
    set angle = offset + ax1
    call SaveReal(MHT,info,1,angle)
    if HaveSavedReal(MHT,info,2)then
      if 0>ay2 then
        set ay2 = -ay2
      endif
      if 0.02>ay2 then
        call SaveBoolean(MHT,info,0,false)
        call RemoveSavedReal(MHT,info,2)
      endif
    endif
    if LoadBoolean(MHT,info,0) then
      call SaveReal(MHT,info,2,ay2)
    endif
    //is the unit icarus diving \:3/
    if LoadInteger(HY,load,4301)!=1 then
      call SetUnitFacing(u,angle*bj_RADTODEG)
    endif
  endif
  if LoadBoolean(MHT,info,1)then
    set x1 = SafeX50(x1 +5*Cos(angle))
    set y1 = SafeY50(y1 +5*Sin(angle))
    call KillTrees(x1,y1,200)
    if IsUnitType(u,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(u),99,true)
    endif
    call SetUnitX(u,x1)
    call SetUnitY(u,y1)
  endif
  if count==1 then
    call DisableTrigger(GAME_TRIGGER)
    call InterruptUnit(u)
    call EnableTrigger(GAME_TRIGGER)
  endif
  set ax1 = Cos(angle)
  set ay1 = Sin(angle)
  set angle = (GetUnitFacing(u)+90)*bj_DEGTORAD
  set ax2 = Cos(angle)
  set ay2 = Sin(angle)
  set x1 = GetWidgetX(u) + 50*ax1
  set y1 = GetWidgetY(u) + 50*ay1
  call MoveLocation(ZeroLocation,x1,y1)
  set z1 = GetUnitFlyHeight(u)
  if 50>z1 then
    set z1 = 50
  endif
  set z1 = z1 + GetLocationZ(ZeroLocation)
  set x2 = x1 + 1150*ax1
  set y2 = y1 + 1150*ay1
  call MoveLocation(ZeroLocation,x2,y2)
  set z2 = GetLocationZ(ZeroLocation)
  loop
    exitwhen loopA == 7
    set angle = 30*(loopA/5)*Pow(-1,loopA)
    set offset = 30*((8-loopA)/5)*Pow(-1,loopA)
    set l = LoadLightningHandle(MHT,info,loopA)
    call MoveLightningEx(l,false, x1 + angle*ax2,y1 + angle*ay2,z1 + offset, x2,y2,z2)
    set loopA = loopA + 1
  endloop
  call DestroyEffect(AddSpecialEffect("war3mapImported\\FireRayTarget.mdx",x2,y2))
  call SaveInteger(MHT,info,0,count+1)
  if count/10 == count/10. then
    set x2 = x1
    set y2 = y1
    set loopA = 0
    set g = LoadGroupHandle(MHT,info,1)
    set group_temp_unit[0] = u
    set group_temp_integer[0] = info
    loop
      exitwhen loopA == 26
      set x2 = x2 + 50*ax1
      set y2 = y2 + 50*ay1
      call GroupEnumUnitsInRange(temp_group,x2,y2,100,Condition(function Phoenix_Sunray_Target_Condition))
      if loopA/3 == loopA/3.then
        call TimedReveal(GetOwningPlayer(u),2,x2,y2,225)
      endif
      set loopA = loopA + 1
    endloop
    set level = LoadInteger(MHT,info,-1)
    set angle = count/239.
    set offset = 8*level + 8
    set group_temp_real[0] = offset + offset*angle
    set group_temp_real[1] = (level + angle*level)/100
    call ForGroup(g,function Phoenix_Sunray_Targets)
    call GroupClear(g)
  endif
  set g = null //moar gut! :D
  set u = null
  set t = null
  set l=null   //no gut :P
endfunction

function Phoenix_Sunray_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local timer t = CreateTimer()
  local integer loopA = 2
  local integer info = GetHandleId(t)
  local integer save = GetHandleId(u)
  
  call UnitAddAbility2(u,'Abun')
  call UnitAddAbility2(u,'A205')
  call UnitAddAbility2(u,'A1Z3')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1YY',false)
  
  call SetUnitPathing(u,false)
  call SaveInteger(MHT,save,'A1YY',info)
  call SaveBoolean(MHT,save,'A1YY',false)
  
  call SaveUnitHandle(MHT,info,0,u)
  call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
  call SaveBoolean(MHT,info,0,false)
  call SaveBoolean(MHT,info,1,false)
  call SaveInteger(MHT,info,-1,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call StartSound(WF)
  call SetSoundPosition(WF,GetWidgetX(u),GetWidgetY(u),100)
  
  call SetUnitAnimationByIndex(u,LoadInteger(MHT,GetUnitTypeId(u),'A1P8'))
  
  loop
    exitwhen loopA == 7
    call SaveLightningHandle(MHT,info,loopA,AddLightning("SRAY",false,0,0,0,0))
    set loopA = loopA + 1
  endloop
  
  call TimerStart(t,0.025,true,function Phoenix_Sunray_Duration)
  
  set u = null
  set t = null
endfunction

function Phoenix_Spirits_Leveling takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A1YX')
  call SetUnitAbilityLevel(GetTriggerUnit(),'A1YX',GetUnitAbilityLevel(GetTriggerUnit(),'A331'))
endfunction

function Phoenix_Spirits_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit target = LoadUnitHandle(MHT,info,0)
  
  if count<=1 or IsMagicImmune(target) or IsDead(target) then
    call RemoveSavedHandle(MHT,GetHandleId(target),'A1YX')
    call DestroyEffect(LoadEffectHandle(MHT,info,2))
    call Timer_End(t)
    call UnitRemoveAbility(target,LoDBuff_AbilID[10])
    call UnitRemoveAbility(target,LoDBuff_BuffID[10])
    set t = null
    set target = null
    return
  endif
  
  if count/4 == count/4. then
    call DamageTarget(LoadUnitHandle(MHT,info,1),target,1,LoadInteger(MHT,info,1))
  endif
  
  call SaveInteger(MHT,info,0,count-1)
  
  set t = null
  set target = null
endfunction

function Phoenix_Spirits_Damage_Start takes unit caster, unit target, integer lvl returns nothing
  local timer time=LoadTimerHandle(MHT,GetHandleId(target),'A1YX')
  local integer info
  if time!=null then
    call SaveInteger(MHT,GetHandleId(time),0,16)
  else
    set time = CreateTimer()
    set info = GetHandleId(time)
    call SaveUnitHandle(MHT,info,0,target)
    call SaveUnitHandle(MHT,info,1,caster)
    call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("Environment\\LargeBuildingFire\\LargeBuildingFire1.mdl",target,"chest"))
    call SaveInteger(MHT,info,0,16)
    call SaveInteger(MHT,info,1,lvl*20-5)
    call TimerStart(time,0.25,true,function Phoenix_Spirits_Duration)
    call SaveTimerHandle(MHT,GetHandleId(target),'A1YX',time)
  endif
  set time = null
endfunction

function Phoenix_Spirits_Damage takes unit target, integer lvl returns nothing
  call Phoenix_Spirits_Damage_Start(group_temp_unit[0],target,lvl)
  call UnitAddAbility2(target,LoDBuff_AbilID[10])
endfunction

function Phoenix_Spirits_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  local unit u = group_temp_unit[0]
  
  if IsDead(t)==false and IsUnitEnemy(u,GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call UnitAddAbilityTimedExF(t,'A45O'-1+TempInteger,1,4,0)
    call Phoenix_Spirits_Damage(t,TempInteger)
  endif
  
  set t = null
  set u = null
  return false
endfunction

function WXG takes unit Source, unit Projectile, real x, real y, integer lvl returns nothing
  set group_temp_unit[0] = Source
  set TempInteger=lvl
  call GroupEnumUnitsInRange(temp_group,x,y,200,Condition(function Phoenix_Spirits_Targets))
  call DestroyEffect(AddSpecialEffect("war3mapImported\\Firaga_2.mdx",x,y))
  call KillUnit(Projectile)
  call ShowUnit(Projectile,false)
endfunction

function WYG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=LoadInteger(HY,h,34)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit WZG=LoadUnitHandle(HY,h,393)
  local real GWG=LoadReal(HY,h,685)
  local real TargetX
  local real TargetY
  local real x
  local real y
  local real a
  local real r=18
  local integer Level=LoadInteger(HY,h,0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
    call SaveReal(HY,h,47,TargetX*1.)
    call SaveReal(HY,h,48,TargetY*1.)
    call RemoveSavedHandle(HY,h,17)
    call SaveUnitHandle(HY,h,17,null)
  elseif Target==null then
    set TargetX=LoadReal(HY,h,47)
    set TargetY=LoadReal(HY,h,48)
  else
    set TargetX=GetUnitX(Target)
    set TargetY=GetUnitY(Target)
  endif
  set a=AngleBetweenXY(GetUnitX(WZG),GetUnitY(WZG),TargetX,TargetY)
  call SetUnitFacing(WZG,a)
  set a = a*bj_DEGTORAD
  set x=GetWidgetX(WZG)+r*Cos(a)
  set y=GetWidgetY(WZG)+r*Sin(a)
  call SetUnitX(WZG,x)
  call SetUnitY(WZG,y)
  if DistanceBetweenXY(x,y,TargetX,TargetY)<r*2 then
    call WXG(Source,WZG,x,y,Level)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  set WZG=null
  return false
endfunction

function WAG takes unit Source,unit WZG,unit Target,real GWG,unit Caster returns nothing
  local trigger t=null
  local integer h
  if Source==Target then
    call KillUnit(WZG)
    call ShowUnit(WZG,false)
    return
  endif
  set t = CreateTrigger()
  set h = GetHandleId(t)
  call SetUnitVertexColor(WZG,255,255,255,255)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function WYG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,393,WZG)
  call SaveReal(HY,h,47,GetSpellTargetX()*1.)
  call SaveReal(HY,h,48,GetSpellTargetY()*1.)
  call SaveReal(HY,h,685,GWG*1.)
  call SaveInteger(HY,h,0,Phoenix_TempInt)
  set t=null
endfunction

function WBG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=LoadInteger(HY,h,34)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local unit WCG=LoadUnitHandle(HY,h,393)
  local unit W3G=LoadUnitHandle(HY,h,394)
  local unit W6G=LoadUnitHandle(HY,h,395)
  local unit WLG=LoadUnitHandle(HY,h,396)
  local integer Level=LoadInteger(HY,h,0)
  local real a=GetUnitFacing(Source)
  local real x
  local real y
  local group g
  local group g2
  local real rate=-1*360*.02/ 4
  local real a2
  local real offset
  local real GWG=LoadReal(HY,h,685)
  local real EMF
  local unit Caster=LoadUnitHandle(HY,h,19)
  set Phoenix_TempInt=Level
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A1Z2' then
      if IsDead(WCG)==false then
        call WAG(Source,WCG,GetSpellTargetUnit(),GWG,Caster)
        call RemoveSavedHandle(HY,h,393)
      elseif IsDead(W3G)==false then
        call WAG(Source,W3G,GetSpellTargetUnit(),GWG,Caster)
        call RemoveSavedHandle(HY,h,394)
      elseif IsDead(W6G)==false then
        call WAG(Source,W6G,GetSpellTargetUnit(),GWG,Caster)
        call RemoveSavedHandle(HY,h,395)
      elseif IsDead(WLG)==false then
        call WAG(Source,WLG,GetSpellTargetUnit(),GWG,Caster)
        call RemoveSavedHandle(HY,h,396)
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)
        if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then
          call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)
        endif
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      endif
    elseif GetSpellAbilityId()=='A1RK' or GetSpellAbilityId()=='A43H' then
      if WCG!=null and IsDead(WCG)==false then
        call WAG(Source,WCG,Source,GWG,Caster)
      endif
      if W3G!=null and IsDead(W3G)==false then
        call WAG(Source,W3G,Source,GWG,Caster)
      endif
      if W6G!=null and IsDead(W6G)==false then
        call WAG(Source,W6G,Source,GWG,Caster)
      endif
      if WLG!=null and IsDead(WLG)==false then
        call WAG(Source,WLG,Source,GWG,Caster)
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)
      if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    set Count=Count+1
    call SaveInteger(HY,h,34,Count)
    if WCG!=null and IsDead(WCG)==false then
      set offset=360*4/ 4.
      set a2=offset+rate*Count
      set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
      set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
      call SetUnitFacing(WCG,a2-90)
      call SetUnitX(WCG,x)
      call SetUnitY(WCG,y)
    endif
    if W3G!=null and IsDead(W3G)==false then
      set offset=360*3/ 4.
      set a2=offset+rate*Count
      set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
      set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
      call SetUnitFacing(W3G,a2-90)
      call SetUnitX(W3G,x)
      call SetUnitY(W3G,y)
    endif
    if W6G!=null and IsDead(W6G)==false then
      set offset=360*2/ 4.
      set a2=offset+rate*Count
      set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
      set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
      call SetUnitFacing(W6G,a2-90)
      call SetUnitX(W6G,x)
      call SetUnitY(W6G,y)
    endif
    if WLG!=null and IsDead(WLG)==false then
      set offset=360*1/ 4.
      set a2=offset+rate*Count
      set x=SafeX50(SourceX+200*Cos(a2*bj_DEGTORAD))
      set y=SafeY50(SourceY+200*Sin(a2*bj_DEGTORAD))
      call SetUnitFacing(WLG,a2-90)
      call SetUnitX(WLG,x)
      call SetUnitY(WLG,y)
    endif
    if Count>800 or GetTriggerEventId()==EVENT_UNIT_DEATH then
      if WCG!=null and IsDead(WCG)==false then
        call WAG(Source,WCG,Source,GWG,Caster)
      endif
      if W3G!=null and IsDead(W3G)==false then
        call WAG(Source,W3G,Source,GWG,Caster)
      endif
      if W6G!=null and IsDead(W6G)==false then
        call WAG(Source,W6G,Source,GWG,Caster)
      endif
      if WLG!=null and IsDead(WLG)==false then
        call WAG(Source,WLG,Source,GWG,Caster)
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',false)
      if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))=='A1YX' then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',true)
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      call SaveReal(HY,h,685,RMinBJ(.25+.75*(I2R(Count)/ 500.),1))
      if Count==625 then
        call BY8(XF,GetOwningPlayer(Source))
      endif
      if Count>600 then
        if ModuloInteger(Count,10)==0 or ModuloInteger(Count,10)==1 or ModuloInteger(Count,10)==2 or ModuloInteger(Count,10)==3 or ModuloInteger(Count,10)==4 then
          call SetUnitVertexColor(WCG,255,0,0,255)
          call SetUnitVertexColor(W3G,255,0,0,255)
          call SetUnitVertexColor(W6G,255,0,0,255)
          call SetUnitVertexColor(WLG,255,0,0,255)
        else
          call SetUnitVertexColor(WCG,255,255,255,255)
          call SetUnitVertexColor(W3G,255,255,255,255)
          call SetUnitVertexColor(W6G,255,255,255,255)
          call SetUnitVertexColor(WLG,255,255,255,255)
        endif
      endif
    endif
  endif
  set t=null
  set Source=null
  set WCG=null
  set W3G=null
  set W6G=null
  set WLG=null
  set g=null
  set g2=null
  set Caster=null
  return false
endfunction

function Phoenix_FireSpirits takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real x
  local real y
  local unit WCG
  local unit W3G
  local unit W6G
  local unit WLG
  local real a=GetUnitFacing(Source)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',SourceX,SourceY,0)
  call UnitAddAbility(Caster,'A21U')
  call SetWidgetLife(Source,GetWidgetLife(Source)-GetWidgetLife(Source)*.15)
  call UnitAddAbility2(Source,'A1Z2')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1Z2',true)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1YX',false)
  set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*4/ 4.*-1.)
  set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*4/ 4.*-1.)
  set WCG=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*4/ 4.*-1.)
  set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*3/ 4.*-1.)
  set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*3/ 4.*-1.)
  set W3G=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*3/ 4.*-1.)
  set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*2/ 4.*-1.)
  set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*2/ 4.*-1.)
  set W6G=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*2/ 4.*-1.)
  set x=GetUnitX(Source)+200*Cos(bj_DEGTORAD*360*1/ 4.*-1.)
  set y=GetUnitY(Source)+200*Sin(bj_DEGTORAD*360*1/ 4.*-1.)
  set WLG=CreateUnit(GetOwningPlayer(Source),'h0CU',x,y,360*1/ 4.*-1.)
  call SetUnitScale(WCG,2.25,2.25,2.25)
  call SetUnitScale(W3G,2.25,2.25,2.25)
  call SetUnitScale(W6G,2.25,2.25,2.25)
  call SetUnitScale(WLG,2.25,2.25,2.25)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function WBG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,393,WCG)
  call SaveUnitHandle(HY,h,394,W3G)
  call SaveUnitHandle(HY,h,395,W6G)
  call SaveUnitHandle(HY,h,396,WLG)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  set t=null
  set Source=null
  set WCG=null
  set W3G=null
  set W6G=null
  set WLG=null
  set Caster=null
endfunction

function W5G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Count=(LoadInteger(HY,(GetHandleId(Target)),(627)))
  local real W2G=(LoadReal(HY,(GetHandleId(Target)),(628)))
  local integer Level=GetUnitAbilityLevel(Source,'A1S4')
  local real Damage=(5+Level*15)*Pow(2,IMinBJ(Count,5)-1)
  set Damage=Damage+IMaxBJ(Count-5,0)*50
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveInteger(HY,(GetHandleId(Target)),(627),(0))
    call SaveReal(HY,(GetHandleId(Target)),(628),((0)*1.))
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A1S9' then
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call SaveInteger(HY,(GetHandleId(Target)),(627),(0))
      call SaveReal(HY,(GetHandleId(Target)),(628),((0)*1.))
      if((LoadInteger(HY,(GetHandleId((Target))),((4293))))==1)then
        call SetUnitInvulnerable(Target,false)
      endif
      call DamageTarget(Source,Target,1,Damage)
      if((LoadInteger(HY,(GetHandleId((Target))),((4293))))==1)then
        call SetUnitInvulnerable(Target,true)
      endif
      call TextTagOnUnit(I2S(R2I(Damage))+"!",2,Target,.025,100,0,200,216)
    endif
  elseif(TimerGetElapsed(GlobalTimer))>W2G then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveInteger(HY,(GetHandleId(Target)),(627),(0))
    call SaveReal(HY,(GetHandleId(Target)),(628),((0)*1.))
    if((LoadInteger(HY,(GetHandleId((Target))),((4293))))==1)then
      call SetUnitInvulnerable(Target,false)
    endif
    call DamageTarget(Source,Target,1,Damage)
    if((LoadInteger(HY,(GetHandleId((Target))),((4293))))==1)then
      call SetUnitInvulnerable(Target,true)
    endif
    call TextTagOnUnit(I2S(R2I(Damage))+"!",2,Target,.025,100,0,200,216)
  else
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function X4G takes unit Source,unit Target returns nothing
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(Source,'A1S4')
  local unit Projectile
  if(LoadInteger(HY,(GetHandleId(Target)),(627)))>0 then
    call SaveInteger(HY,(GetHandleId(Target)),(627),((LoadInteger(HY,(GetHandleId(Target)),(627)))+1))
    call SaveReal(HY,(GetHandleId(Target)),(628),(((TimerGetElapsed(GlobalTimer))+10)*1.))
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveInteger(HY,(GetHandleId(Target)),(627),(1))
    if IsUnitType(Target,UNIT_TYPE_HERO) then
      call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\shamanyouranus-ShadowyMissile.mdl",Target,"chest")))
    else
      call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\shamanyouranus-ShadowyMissile.mdl",Target,"origin")))
    endif
    call SaveReal(HY,(GetHandleId(Target)),(628),(((TimerGetElapsed(GlobalTimer))+10)*1.))
    call TriggerRegisterTimerEvent(t,.05,true)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
    call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function W5G))
    set Projectile=null
  endif
  call TextTagOnUnit("+"+I2S((LoadInteger(HY,(GetHandleId(Target)),(627)))),3,Target,.025,100,0,200,216)
  call DamageTarget(Source,Target,1,50)
  set t=null
endfunction

function X7G takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),ND8)==false then
    call GroupAddUnit(ND8,GetEnumUnit())
    call X4G(N98,GetEnumUnit())
  endif
endfunction

function X8G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local integer Count=GetTriggerEvalCount(t)
  local real a=(LoadReal(HY,h,(137)))
  local real x=SafeX50(GetUnitX(Projectile)+(20)*Cos(a))
  local real y=SafeY50(GetUnitY(Projectile)+(20)*Sin(a))
  local group g
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local unit Target
  if Count==75 then
    call KillGroup(HND)
    call KillUnit(Projectile)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set tt_unit1=Source
    set N98=Source
    set ND8=HND
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,215,Condition(function NonImmuneEnemyFilter))
    set Target=(LoadUnitHandle(HY,(GetHandleId(Source)),(673)))
    if Target!=null then
      if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),x,y)<215 and IsUnitEnemy(Target,GetOwningPlayer(Source)) then
        call GroupAddUnit(g,Target)
      endif
    endif
    call ForGroup(g,function X7G)
    set Target=FirstOfGroup(g)
    call KillGroup(g)
  endif
  set t=null
  set Source=null
  set Projectile=null
  set g=null
  set Target=null
  set HND=null
  return false
endfunction

function SD_ShadowPoison takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C2',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function X8G))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveReal(HY,h,(137),((a)*1.))
  call SaveGroupHandle(HY,h,(133),(GetAvailableGroup()))
  call UnitAddAbility2(Source,'A1S9')
  set t=null
  set Source=null
  set Projectile=null
endfunction

function XEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit XFG=GetSummonedUnit()
  if GetTriggerEventId()!=EVENT_PLAYER_UNIT_SUMMON then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetUnitAbilityLevel(XFG,'B0DA')>0 and GetOwningPlayer(GetSummoningUnit())==GetOwningPlayer(Source)then
    if IsUnitAlly(Target,GetOwningPlayer(Source)) then
      call SelectUnitAddForPlayer(XFG,GetOwningPlayer(Source))
    else
      call IssueTargetOrderById(XFG,851983,Target)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set XFG=null
  return false
endfunction

function XGG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local integer lvl=LoadInteger(HY,h,0)
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  call SaveInteger(HY,GetHandleId(Target),4293,2)
  call SetUnitInvulnerable(Target,false)
  call PauseUnit(Target,false)
  call ShowUnit(Target,true)
  call RemoveSavedHandle(HY,GetHandleId(Target),673)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  if GetTriggerEventId()!=EVENT_UNIT_DEATH then
    call ClearSelectionForPlayer(GetOwningPlayer(Target))
    call SelectUnitAddForPlayer(Target,GetOwningPlayer(Target))
    call PlaySoundAtPos(AF,GetUnitX(Target),GetUnitY(Target))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3,false)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
    call TriggerAddCondition(t,Condition(function XEG))
    call SaveUnitHandle(HY,h,2,Source)
    call SaveUnitHandle(HY,h,17,Target)
    call UnitAddAbility2(Caster,'A1S5')
    if IsUnitIllusion(Target) then
      call SaveUnitHandle(HY,GetHandleId(Caster),'0ILU',LoadUnitHandle(HY,GetHandleId(Target),'0ILU')) //Disruption source info (illu)
    else
      call SaveUnitHandle(HY,GetHandleId(Caster),'0ILU',Target) //Disruption source info (real)
    endif
    call SetUnitAbilityLevel(Caster,'A1S5',lvl)
    call IssueTargetOrderById(Caster,852274,Target)
    call IssueTargetOrderById(Caster,852274,Target)
  endif
  set t=null
  set Source=null
  set Caster=null
  set Target=null
  return false
endfunction

function XHG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'o019',GetUnitX(Target),GetUnitY(Target),0)
  call UnitApplyTimedLife(Caster,'BTLF',2.6)
  if IsUnitAlly(Target,GetOwningPlayer(Source))==false then
    set Caster=CreateUnit(GetOwningPlayer(Source),'o019',GetUnitX(Target),GetUnitY(Target),0)
    call UnitApplyTimedLife(Caster,'BTLF',2.6)
  endif
  call SetUnitInvulnerable(Target,true)
  call PauseUnit(Target,true)
  call ShowUnit(Target,false)
  call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\WILLTHEALMIGHTY-Void5.mdx",GetUnitX(Target),GetUnitY(Target)))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call TriggerRegisterTimerEvent(t,2.5,false)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function XGG))
  call SaveUnitHandle(HY,GetHandleId(Source),673,Target)
  call SaveInteger(HY,GetHandleId(Target),4293,1)
  set Source=null
  set Target=null
  set t=null
  set Caster=null
endfunction

function SD_Disruption takes nothing returns nothing
  if (IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) or IsBlocked(GetSpellTargetUnit())==false)then
    call XHG()
  endif
endfunction

function SD_Disruption_OnCast takes nothing returns nothing
  if GetSpellTargetUnit()!=GetTriggerUnit()and IsUnitAlly(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit())) and LoadBoolean(HY,GetHandleId(GetOwningPlayer(GetSpellTargetUnit())),139) then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n038'))
  endif
endfunction

function XJG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=LoadInteger(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,0)
  call SaveReal(HY,GetHandleId(target),'AMPL',RMaxIF(LoadReal(HY,GetHandleId(target),'AMPL')-LoadReal(HY,h,0),0))
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  return false
endfunction

function SD_SoulCatcher takes nothing returns nothing
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local group g=GetAvailableGroup()
  local unit Source=GetTriggerUnit()
  local unit Target
  local trigger t
  local integer h
  local real r
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,475,Condition(function NonImmuneEnemyFilter))
  set Target=LoadUnitHandle(HY,GetHandleId(Source),673)
  if Target!=null then
    if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),x,y)<475 and IsUnitEnemy(Target,GetOwningPlayer(Source)) then
      call GroupAddUnit(g,Target)
    endif
  endif
  set Target=GroupPickRandomUnit(g)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffect("war3mapImported\\Desecrate.mdx",x,y))
  if Target!=null then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    //call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(t,12,false)
    set r=0.1+0.1*GetUnitAbilityLevel(Source,GetSpellAbilityId())
    call SaveReal(HY,GetHandleId(Target),'AMPL',LoadReal(HY,GetHandleId(Target),'AMPL')+r)
    call TriggerAddCondition(t,Condition(function XJG))
    call SaveReal(HY,h,0,r)
    call SaveUnitHandle(HY,h,0,Target)
    call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
    call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\void.mdx",Target,"chest"))
  endif
  set g=null
  set Source=null
  set Target=null
  set t=null
endfunction

function XNG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Count=GetTriggerEvalCount(t)
  if Count==5 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if(LoadInteger(HY,GetHandleId(Target),4293)==1)then
      call SetUnitInvulnerable(Target,false)
    endif
    call DamageTarget(Source,Target,1,4*(25+25*LoadInteger(HY,h,0)))
    if(LoadInteger(HY,GetHandleId(Target),4293)==1)then
      call SetUnitInvulnerable(Target,true)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function SD_DemonicPurge_Apply takes unit Source, unit Target returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit d=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function XNG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call UnitAddAbility(d,'A1SA')
  call SetUnitAbilityLevel(d,'A1SA',GetUnitAbilityLevel(Source,'A343'))
  call IssueTargetOrder(d,"purge",Target)
  call TriggerEvaluate(t)
  set t=null
  set d=null
endfunction

function SD_DemonicPurge_Filter takes nothing returns boolean
  if (IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsDead(GetFilterUnit())==false)and IsNonAncient(GetFilterUnit()))!=null then
    call SD_DemonicPurge_Apply(tt_unit1,GetFilterUnit())
  endif
  return false
endfunction

function SD_DemonicPurge takes nothing returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=GetTriggerUnit()
  call GroupEnumUnitsInRange(g,GetSpellTargetX(),GetSpellTargetY(),265,Condition(function SD_DemonicPurge_Filter))
  call KillGroup(g)
  set g=null
endfunction

function SD_DemonicPurgeAghReplenish takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call SaveInteger(MHT,GetHandleId(u),'DMNP',LoadInteger(MHT,GetHandleId(u),'DMNP')+1)
  call CleanTimer(t)
  set u=null
  set t=null
endfunction

function SD_DemonicPurgeAghCD takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,40,false,function SD_DemonicPurgeAghReplenish)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function SD_DemonicPurgeAgh takes nothing returns nothing
  local unit u=GetTriggerUnit()
  if LoadInteger(MHT,GetHandleId(u),'DMNP')>0 then
    call SD_DemonicPurge()
    call SaveInteger(MHT,GetHandleId(u),'DMNP',LoadInteger(MHT,GetHandleId(u),'DMNP')-1)
    call SD_DemonicPurgeAghCD(u)
  endif
  set u=null
endfunction

function SD_DemonicPurgeAghCast takes nothing returns nothing
  local unit u=GetTriggerUnit()
  if LoadInteger(MHT,GetHandleId(u),'DMNP')<1 then
    call Error(GetOwningPlayer(u),"Demonic Purge has no charges left.")
    call InterruptUnit(u)
  endif
  set u=null
endfunction

function SD_DemonicPurgeAgh_Learn takes nothing returns nothing
  local integer h=GetHandleId(GetTriggerUnit())
  if LoadBoolean(MHT,h,'DMNP')==false then
    call SaveBoolean(MHT,h,'DMNP',true)
    call SaveInteger(MHT,h,'DMNP',3)
  endif
endfunction

function SD_DemonicPurgeAgh_Pickup takes nothing returns nothing
  local integer h=GetHandleId(tt_unit1)
  if LoadBoolean(MHT,h,'DMNP')==false then
    call SaveBoolean(MHT,h,'DMNP',true)
    call SaveInteger(MHT,h,'DMNP',3)
  endif
endfunction

function SD_DemonicPurgeAgh_Drop takes nothing returns nothing
endfunction

function XQG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  call UnitRemoveAbility(Source,'A1SP')
  set t=null
  set Source=null
  return false
endfunction

function Gyro_RocketBarrage takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call UnitAddAbility2(Source,'A1SP')
  call UnitMakeAbilityPermanent(Source,true,'A1SP')
  call SetUnitAbilityLevel(Source,'A1SP',GetUnitAbilityLevel(Source,'A1SO'))
  call TriggerRegisterTimerEvent(t,3,false)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function XQG))
  call SaveUnitHandle(HY,h,2,Source)
  set t=null
  set Source=null
endfunction

function XTG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Count=GetTriggerEvalCount(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real x
  local real y
  local real d
  local real DV9
  local real LastX=GetUnitX(Projectile)
  local real LastY=GetUnitY(Projectile)
  local real a=AngleBetweenXY(LastX,LastY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call UnitShareVision(Projectile,GetOwningPlayer(Target),false)
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if GetTriggerUnit()!=Projectile then
      call KillUnit(Projectile)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    call UnitRemoveBuffs(Projectile,true,true)
  elseif Count<3/ .02 then
    call SetUnitFacing(Projectile,a*bj_RADTODEG)
  else
    if Count==4/ .02 then
      call UnitShareVision(Projectile,GetOwningPlayer(Target),true)
    endif
    call SetUnitFacing(Projectile,a*bj_RADTODEG)
    set x=LastX+(280+20*Count*.02)*.02*Cos(a)
    set y=LastY+(280+20*Count*.02)*.02*Sin(a)
    call SetUnitPosition(Projectile,x,y)
    call SaveReal(HY,h,23,x*1.)
    call SaveReal(HY,h,24,y*1.)
    if DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))<20 then
      set d=RMinBJ(DistanceBetweenXY(x,y,LoadReal(HY,h,6),LoadReal(HY,h,7)),1500)
      set x = LoadInteger(HY,h,0)
      set DV9=d/ 1500*(125*x)
      set DV9=RMaxBJ(DV9,50)
      call KillUnit(Projectile)
      call DestroyEffect(LoadEffectHandle(HY,h,32))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call DamageTarget(Source,Target,1,DV9)
      call StunTargetLod(Target,2 + .2*x)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set Projectile=null
  return false
endfunction

function XUG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
  local real x=SafeX50(GetUnitX(Source)+150*Cos(a))
  local real y=SafeY50(GetUnitY(Source)+150*Sin(a))
  local integer Level=GetUnitAbilityLevel(Source,'A1SQ')
  local unit Projectile
  local integer W78
  local string s="effects\\Snipe Target.mdx"
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source))==false and IsObserver(GetLocalPlayer())==false then
    set s=""
  endif
  if Level==1 then
    set W78='h0CG'
  elseif Level==2 then
    set W78='h0C1'
  elseif Level==3 then
    set W78='h0CF'
  elseif Level==4 then
    set W78='h0CH'
  endif
  set Projectile=CreateUnit(GetOwningPlayer(Source),W78,x,y,a*bj_RADTODEG)
  call UnitRemoveAbility(Projectile,'Amov')
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Projectile,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Projectile,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function XTG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,Level)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveReal(HY,h,6,GetUnitX(Source)*1.)
  call SaveReal(HY,h,7,GetUnitY(Source)*1.)
  call SaveReal(HY,h,23,GetUnitX(Projectile)*1.)
  call SaveReal(HY,h,24,GetUnitY(Projectile)*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget(s,Target,"overhead"))
  set t=null
  set Source=null
  set Target=null
  set Projectile=null
endfunction

function Gyro_HomingMissile takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call XUG()
  endif
endfunction

function XAG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local group g
  local integer Count=GetTriggerEvalCount(t)
  local fogmodifier fm=LoadFogModifierHandle(HY,h,42)
  local integer lvl=LoadInteger(HY,h,0)
  local unit u2
  if Count==1 then
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Calldown_FlyUp.mdx",Source,"chest"))
  elseif Count==2 then
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Calldown_FlyUp.mdx",Source,"chest"))
  elseif Count==3 then
    call DestroyEffect(AddSpecialEffect("war3mapImported\\Calldown_FlyDown.mdx",x,y))
  elseif Count==4 then
    set g=GetAvailableGroup()
    set tt_unit1=Source
    call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilter))
    
    loop
      set u2=FirstOfGroup(g)
      exitwhen u2==null
      call DamageTarget(Source,u2,1,lvl*50+200)
      call UnitAddAbilityTimedExF(u2,'A1T3',1,2,'B0DG')
      call GroupRemoveUnit(g,u2)
    endloop
    
    call KillGroup(g)
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
  elseif Count==5 then
    call DestroyEffect(AddSpecialEffect("war3mapImported\\Calldown_FlyDown.mdx",x,y))
  elseif Count==6 then
    set g=GetAvailableGroup()
    set tt_unit1=Source
    call GroupEnumUnitsInRange(g,x,y,625,Condition(function DefaultEnemyFilter))
    
    loop
      set u2=FirstOfGroup(g)
      exitwhen u2==null
      if LoadBoolean(HY,h,0) then
        call DamageTarget(Source,u2,1,lvl*50+50+75)
      else
        call DamageTarget(Source,u2,1,lvl*50+50)
      endif
      call UnitAddAbilityTimedExF(u2,'A1ST',1,3,'B0DE')
      call GroupRemoveUnit(g,u2)
    endloop
    
    call KillGroup(g)
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",x,y))
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set g=null
  set fm=null
  return false
endfunction

function Gyro_Calldown takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local string s=""
  local fogmodifier fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,450,true,true)
  call FogModifierStart(fm)
  if IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Source)) or IsObserver(GetLocalPlayer())then
    set s="war3mapImported\\CallDown_4.mdx"
  endif
  call TriggerRegisterTimerEvent(t,.1,false)
  call TriggerRegisterTimerEvent(t,.8,false)
  call TriggerRegisterTimerEvent(t,1.6,false)
  call TriggerRegisterTimerEvent(t,2,false)
  call TriggerRegisterTimerEvent(t,3.6,false)
  call TriggerRegisterTimerEvent(t,4,false)
  call TriggerAddCondition(t,Condition(function XAG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A235')
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffect(s,x,y))
  call SaveFogModifierHandle(HY,h,42,fm)
  set t=null
  set Source=null
  set fm=null
endfunction

function X3G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer JDF=LoadInteger(HY,h,375)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Count
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==Source and(GetEventDamage()>20 or IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)) and IsRealDamage then
      set Count=LoadInteger(HY,JDF,34)
      if Count>0 then
        call SaveInteger(HY,JDF,34,Count+1)
      endif
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function X6G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  if IsHexed(Source)==false then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'A237')
    call UnitAddAbility(Source,'A22B')
    call UnitRemoveAbility(Source,'A22B')
  endif
  set t=null
  set Source=null
  return false
endfunction

function XLG takes unit Source returns nothing
  local trigger t
  local integer h
  if IsHexed(Source)==false then
    call UnitRemoveAbility(Source,'A237')
    call UnitAddAbility(Source,'A22B')
    call UnitRemoveAbility(Source,'A22B')
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call TriggerRegisterTimerEvent(t,.1,true)
    call TriggerAddCondition(t,Condition(function X6G))
    set t=null
  endif
endfunction

function X1G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Count=LoadInteger(HY,h,34)
  local integer Level=LoadInteger(HY,h,0)
  local integer JDF=h
  if GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
    if IsUnitIllusion(GetAttacker()) and GetUnitAbilityLevel(GetAttacker(),'A1TW')>0 then
      call XLG(GetAttacker())
      call UnitRemoveAbility(GetAttacker(),'A1TW')
    endif
    if GetAttacker()==Source then
      set Count=Count+1
      if Count>3+Level then
        call UnitRemoveAbility(Source,'A1TW')
        call UnitRemoveAbility(Source,'B0DJ')
        call XLG(Source)
        call FlushChildHashtable(HY,h)
        call CleanTrigger(t)
      else
        set t=CreateTrigger()
        set h=GetHandleId(t)
        call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_DAMAGED)
        call TriggerRegisterTimerEvent(t,2,false)
        call TriggerAddCondition(t,Condition(function X3G))
        call SaveUnitHandle(HY,h,2,Source)
        call SaveInteger(HY,h,375,JDF)
      endif
    endif
  else
    call UnitRemoveAbility(Source,'A1TW')
    call UnitRemoveAbility(Source,'B0DJ')
    call XLG(Source)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Gyro_FlakCannon takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call UnitAddAbility(Source,'A1TW')
  call UnitMakeAbilityPermanent(Source,true,'A1TW')
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function X1G))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveInteger(HY,h,34,1)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call UnitRemoveAbility(Source,'A237')
  set t=null
  set Source=null
endfunction

function Y4G takes nothing returns boolean
  local unit Target=GetFilterUnit()
  local unit Source=NG8
  local real SourceX=NH8
  local real SourceY=NI8
  local real NHE=NJ8
  local real NIE=NK8
  local real x
  local real y
  local real a
  local real d
  if(IsMagicImmune(GetFilterUnit())==false and IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit()))then
    set d=DistanceBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))
    set a=AngleBetweenXY(SourceX,SourceY,GetUnitX(Target),GetUnitY(Target))*bj_DEGTORAD
    if d>NM8 then
      set x=GetUnitX(Target)+11*Cos(a)
      set y=GetUnitY(Target)+11*Sin(a)
    else
      set x=GetUnitX(Target)-11*Cos(a)
      set y=GetUnitY(Target)-11*Sin(a)
    endif
    call SetUnitX(Target,x)
    call SetUnitY(Target,y)
  endif
  set Target=null
  set Source=null
  return false
endfunction

function Y7G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real SourceX=LoadReal(HY,h,6)
  local real SourceY=LoadReal(HY,h,7)
  local real x
  local real y
  local integer i=0
  local group g
  local integer lvl=LoadInteger(HY,h,0)
  if GetTriggerEvalCount(t)>(50*(2+.5*lvl))then
    loop
      exitwhen i>16
      set i=i+1
    endloop
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set NH8=SourceX
    set NI8=SourceY
    set NG8=Source
    set tt_unit1=Source
    loop
      exitwhen i>16
      set x=SourceX+NM8*Cos(bj_DEGTORAD*360.*i/ 16.)
      set y=SourceY+NM8*Sin(bj_DEGTORAD*360.*i/ 16.)
      set NJ8=x
      set NK8=y
      call GroupEnumUnitsInRange(g,x,y,75,Condition(function Y4G))
      set i=i+1
    endloop
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Y8G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real SourceX=LoadReal(HY,h,6)
  local real SourceY=LoadReal(HY,h,7)
  local real x
  local real y
  local integer i=0
  local integer lvl=LoadInteger(HY,h,0)
  call DestroyEffect(LoadEffectHandle(HY,h,32))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  loop
    exitwhen i>16
    set x=SourceX+NM8*Cos(bj_DEGTORAD*360.*i/ 16.)
    set y=SourceY+NM8*Sin(bj_DEGTORAD*360.*i/ 16.)
    set i=i+1
  endloop
  call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\KineticField_FX_Stand.mdx",SourceX,SourceY))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,SourceX*1.)
  call SaveReal(HY,h,7,SourceY*1.)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function Y7G))
  set t=null
  set Source=null
  return false
endfunction

function Disruptor_KineticField takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real SourceX=GetSpellTargetX()
  local real SourceY=GetSpellTargetY()
  call SaveEffectHandle(HY,h,32,AddSpecialEffect("war3mapImported\\KineticField_FX_Start.mdx",SourceX,SourceY))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,SourceX*1.)
  call SaveReal(HY,h,7,SourceY*1.)
  call TriggerRegisterTimerEvent(t,1.2,false)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,'A1SU'))
  call TriggerAddCondition(t,Condition(function Y8G))
  call TimedReveal(GetOwningPlayer(Source),5.5,SourceX,SourceY,325)
  set t=null
  set Source=null
endfunction

function YEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local real TargetX=(LoadReal(HY,h,6))
  local real TargetY=(LoadReal(HY,h,7))
  local real x=GetUnitX(Projectile)
  local real y=GetUnitY(Projectile)
  local real a=AngleBetweenXY(x,y,TargetX,TargetY)
  local real d=DistanceBetweenXY(x,y,TargetX,TargetY)
  local real r=(LoadReal(HY,h,(671)))
  call SetUnitFacing(Projectile,a)
  set x=x+r*Cos(a*bj_DEGTORAD)
  set y=y+r*Sin(a*bj_DEGTORAD)
  call SetUnitX(Projectile,x)
  call SetUnitY(Projectile,y)
  if d<40 then
    call KillUnit(Projectile)
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call AddTimedKeyToUnit(Target,4411,1)
    call SetUnitPosition(Target,TargetX,TargetY)
    call PanCameraToTimedForPlayer(GetOwningPlayer(Target),TargetX,TargetY,0)
  elseif IsMagicImmune(Target)then
    call KillUnit(Projectile)
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  set Projectile=null
  return false
endfunction

function YFG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local real x=(LoadReal(HY,(GetHandleId(Target)),(7400)))
  local real y=(LoadReal(HY,(GetHandleId(Target)),(7500)))
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C6',GetUnitX(Target),GetUnitY(Target),0)
  local real d=DistanceBetweenXY(x,y,GetUnitX(Target),GetUnitY(Target))
  local real r=.02*(RMaxBJ(d/ 1.8,600))
  call TriggerAddCondition(t,Condition(function YEG))
  call TriggerRegisterTimerEvent(t,.02,true)
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call SaveReal(HY,h,(671),((r)*1.))
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("effects\\Lightning_Ball_Tail_FX.mdx",Target,"overhead")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffect("effects\\Lightning_Ball_Tail_FX.mdx",x,y)))
  call TriggerEvaluate(t)
  set Source=null
  set Target=null
  set Projectile=null
  set t=null
endfunction

function Disruptor_Glimpse takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    if IsUnitIllusion(GetSpellTargetUnit())then
      call KillUnit(GetSpellTargetUnit())
    else
      call YFG()
    endif
  endif
endfunction

function YHG takes nothing returns nothing
  local unit Target=GetEnumUnit()
  local integer h=GetHandleId(Target)
  local integer i=1
  loop
    exitwhen i>14
    call SaveReal(HY,h,7400+i-1,LoadReal(HY,h,7400+i)*1.)
    call SaveReal(HY,h,7500+i-1,LoadReal(HY,h,7500+i)*1.)
    set i=i+1
  endloop
  call SaveReal(HY,h,7400+14,GetUnitX(Target)*1.)
  call SaveReal(HY,h,7500+14,GetUnitY(Target)*1.)
  set Target=null
endfunction

function YIG takes nothing returns boolean
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,0,0,99999,Condition(function DI9))
  call ForGroup(g,function YHG)
  call KillGroup(g)
  set g=null
  return false
endfunction

function Disruptor_Glimpse_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function YIG))
  set t=null
endfunction

function Disruptor_ThunderStrike_Damage takes nothing returns nothing
  if NN8!=GetEnumUnit() then
    call DamageTarget(NO8,GetEnumUnit(),1,NP8*20+20)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\Bolt\\BoltImpact.mdl",GetEnumUnit(),"chest"))
  endif
endfunction

function Disruptor_ThunderStrike_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit Caster=LoadUnitHandle(HY,h,19)
  local integer Level=LoadInteger(HY,h,5)
  local group g
  local integer Count=GetTriggerEvalCount(t)
  local unit d=null
  call SetUnitX(Caster,GetUnitX(Target))
  call SetUnitY(Caster,GetUnitY(Target))
  if Count==1 or Count==100 or Count==200 or Count==300 then
    set g=GetAvailableGroup()
    if IsDead(Target)then
      set d=CreateUnit(GetOwningPlayer(Target),'e00C',GetUnitX(Target),GetUnitY(Target),0)
      call UnitApplyTimedLife(d,'BTLF',.2)
      call IssueTargetOrderById(Caster,852119,d)
      set d=null
    else
      call IssueTargetOrderById(Caster,852119,Target)
      call DamageTarget(Source,Target,1,Level*20+20)
    endif
    call Z48("war3mapImported\\ThunderStorm_Groundeffect.mdx",Target,"origin",.6)
    set tt_unit1=Source
    set NO8=Source
    set NN8=Target
    set NP8=Level
    call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),265,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function Disruptor_ThunderStrike_Damage)
    call KillGroup(g)
    set g=null
  endif
  if GetUnitAbilityLevel(Target,'A42Q')==0 or GetTriggerEvalCount(t)==300 then
    call UnitRemoveAbility(Target,'A42Q')
    call UnitRemoveAbility(Target,'B0HH')
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  return false
endfunction

function Disruptor_ThunderStrike_Start takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A1TV')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e02P',GetUnitX(Target),GetUnitY(Target),0)
  call UnitAddAbility2(Caster,'A1U7')
  call SetUnitAbilityLevel(Caster,'A1U7',Level)
  call UnitAddAbility2(Caster,'Aloc')
  call UnitAddAbility2(Target,'A42Q')
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function Disruptor_ThunderStrike_Duration))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,19,Caster)
  call SaveInteger(HY,h,5,Level)
  set Source=null
  set Target=null
  set Caster=null
  set t=null
endfunction

function Disruptor_ThunderStrike_StartSup takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Disruptor_ThunderStrike_Start()
  endif
endfunction

function Disruptor_StaticStormClear takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    if GetUnitAbilityLevel(u,'QINV')>0 then
      call UnitRemoveAbility(u,'QINV')
    endif
    call FlushChildHashtable(HY,GetHandleId(t))
    call CleanTrigger(t)
  else
    if GetUnitAbilityLevel(u,'B0DL')==0 then
      if GetUnitAbilityLevel(u,'QINV')>0 then
        call UnitRemoveAbility(u,'QINV')
      endif
      call FlushChildHashtable(HY,GetHandleId(t))
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set u=null
endfunction

function Disruptor_StaticStormSilenceItems takes unit u returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call UnitAddAbility2(u,'QINV')
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'QINV',false)
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Disruptor_StaticStormClear))
  call SaveUnitHandle(HY,h,0,u)
  
  set t=null
endfunction

function YOG takes nothing returns nothing
  call DamageTarget(NR8,GetEnumUnit(),1,NQ8)
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Purge_NoBirth.mdx",GetEnumUnit(),"origin"))
  if NS8 and GetUnitAbilityLevel(GetEnumUnit(),'QINV')==0 and GetUnitAbilityLevel(GetEnumUnit(),'AInv')>0 and IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO)==true then
    call Disruptor_StaticStormSilenceItems(GetEnumUnit())
  endif
endfunction

function YPG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer Level=(LoadInteger(HY,h,5))
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Projectile=(LoadUnitHandle(HY,h,(45)))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  local group g
  local integer Count=GetTriggerEvalCount(t)
  local boolean isAgh=LoadBoolean(HY,h,0)
  local integer limit=20
  if isAgh then
    set limit=28
  endif
  if Count>limit then
    call StopSound(BF,false,true)
    call KillUnit(Projectile)
    call ShowUnit(Projectile,false)
    call KillUnit(Caster)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Source
    set NR8=Source
    set NQ8=.25*(150+50*Level)*(Count/ 20.)
    set NS8=isAgh
    call GroupEnumUnitsInRange(g,GetUnitX(Projectile),GetUnitY(Projectile),475,Condition(function LA8))
    call ForGroup(g,function YOG)
    
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  set Projectile=null
  set Caster=null
  return false
endfunction

function Disruptor_StaticField takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real TargetX=GetSpellTargetX()
  local real TargetY=GetSpellTargetY()
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0CK',TargetX,TargetY,0)
  local integer Level=GetUnitAbilityLevel(Source,'A1U6')+GetUnitAbilityLevel(Source,'A30N')
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',TargetX,TargetY,0)
  call SetSoundVolume(BF,200)
  call StartSound(BF)
  call SetSoundPosition(BF,TargetX,TargetY,100)
  if IsScourge(GetOwningPlayer(Source))then
    call UnitAddAbility2(Caster,'A1U5')
    if GetSpellAbilityId()=='A30N' then
      call SetUnitAbilityLevel(Caster,'A1U5',2)
    endif
  else
    call UnitAddAbility2(Caster,'A1U4')
    if GetSpellAbilityId()=='A30N' then
      call SetUnitAbilityLevel(Caster,'A1U4',2)
    endif
  endif
  call IssuePointOrderById(Caster,852473,TargetX,TargetY)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(45),(Projectile))
  call SaveUnitHandle(HY,h,(19),(Caster))
  call SaveInteger(HY,h,5,(Level))
  call SaveBoolean(HY,h,0,GetSpellAbilityId()=='A30N')
  call TriggerRegisterTimerEvent(t,.25,true)
  call TriggerAddCondition(t,Condition(function YPG))
  set t=null
  set Source=null
  set Caster=null
  set Projectile=null
endfunction

function YSG takes nothing returns nothing
  local integer YTG=NY8
  local unit Target=GetEnumUnit()
  local integer YUG=662-1+YTG
  local real YVG=(LoadReal(HY,(GetHandleId(Target)),(YUG)))
  local real UK8=(TimerGetElapsed(GlobalTimer))
  if YVG<UK8 then
    call SaveReal(HY,(GetHandleId(Target)),(YUG),((UK8+2)*1.))
    if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE)==false then
      call DamageTarget(NT8,Target,1,2+6*NX8)
    endif
  endif
  set Target=null
endfunction

function YWG takes nothing returns nothing
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_STRUCTURE)==false then
    call DamageTarget(NT8,GetEnumUnit(),1,NV8)
    if IsMagicImmune(GetEnumUnit())==false then
      call UnitAddAbilityTimedEx(GetEnumUnit(),'A437',3,1,'B0DI')
      call DetectMagicDispell(GetEnumUnit(),'A437','B0DI')
    endif
  endif
endfunction

function YXG takes unit Source,unit YYG returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set NV8=25*NX8
  set NT8=Source
  call GroupEnumUnitsInRange(g,GetUnitX(YYG),GetUnitY(YYG),325,Condition(function L38))
  call ForGroup(g,function YWG)
  call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",GetUnitX(YYG),GetUnitY(YYG)))
  call KillUnit(YYG)
  call KillGroup(g)
  call UnitApplyTimedLife(CreateUnit(GetOwningPlayer(Source),'o00Q',GetUnitX(YYG),GetUnitY(YYG),0),'BTLF',2)
  set g=null
endfunction

function YZG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit U01=(LoadUnitHandle(HY,h,(393)))
  local unit U02=(LoadUnitHandle(HY,h,(394)))
  local unit U03=(LoadUnitHandle(HY,h,(395)))
  local unit U04=(LoadUnitHandle(HY,h,(396)))
  local unit U05=(LoadUnitHandle(HY,h,(397)))
  local real x
  local real y
  local real a
  local real d=(LoadReal(HY,h,(138)))
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real rate
  local integer Count=GetTriggerEvalCount(t)
  local real offset
  local group g
  local integer StillAlive=0
  local real time=2.25
  local real CurrentAngle
  if IsDead(U01)==false then
    set StillAlive=StillAlive+1
  endif
  if IsDead(U02)==false then
    set StillAlive=StillAlive+1
  endif
  if IsDead(U03)==false then
    set StillAlive=StillAlive+1
  endif
  if IsDead(U04)==false then
    set StillAlive=StillAlive+1
  endif
  if IsDead(U05)==false then
    set StillAlive=StillAlive+1
  endif
  if StillAlive==5 then
    set time=2.25
  elseif StillAlive==4 then
    set time=2.1
  elseif StillAlive==3 then
    set time=1.95
  elseif StillAlive==2 then
    set time=1.8
  elseif StillAlive==1 then
    set time=1.65
  endif
  set rate=-1*360*.02/ time
  set CurrentAngle=(LoadReal(HY,h,(137)))+rate
  call SaveReal(HY,h,(137),((CurrentAngle)*1.))
  set NX8=GetUnitAbilityLevel(Source,'A1T8')
  set NT8=Source
  if Count==50 then
    call ShowUnit(U02,true)
    call SaveBoolean(HY,h,(512),(true))
    call UnitAddAbility2(U02,'Aloc')
  endif
  if Count==100 then
    call ShowUnit(U03,true)
    call SaveBoolean(HY,h,(513),(true))
    call UnitAddAbility2(U03,'Aloc')
  endif
  if Count==150 then
    call ShowUnit(U04,true)
    call SaveBoolean(HY,h,(514),(true))
    call UnitAddAbility2(U04,'Aloc')
  endif
  if Count==200 then
    call ShowUnit(U05,true)
    call SaveBoolean(HY,h,(515),(true))
    call UnitAddAbility2(U05,'Aloc')
  endif
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A24A' then
      if(LoadBoolean(HY,h,(655))) then
        call SaveBoolean(HY,h,(655),(false))
        call SaveBoolean(HY,h,(656),(false))
      else
        call SaveBoolean(HY,h,(655),(true))
        call SaveBoolean(HY,h,(656),(false))
      endif
    elseif GetSpellAbilityId()=='A24B' then
      if(LoadBoolean(HY,h,(656))) then
        call SaveBoolean(HY,h,(655),(false))
        call SaveBoolean(HY,h,(656),(false))
      else
        call SaveBoolean(HY,h,(655),(false))
        call SaveBoolean(HY,h,(656),(true))
      endif
    endif
  endif
  if(LoadBoolean(HY,h,(655)))then
    set d=RMaxBJ(d-5,100)
    call SaveReal(HY,h,(138),((d)*1.))
  elseif(LoadBoolean(HY,h,(656)))then
    set d=RMinBJ(d+5,875)
    call SaveReal(HY,h,(138),((d)*1.))
  endif
  if GetTriggerEventId()==EVENT_UNIT_DEATH or Count==950 or(IsDead(U01)and IsDead(U02)and IsDead(U03)and IsDead(U04)and IsDead(U05))or(Count>1 and GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1T8')then
    if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT then
      call UnitRemoveAbility(Source,'A24A')
      call UnitRemoveAbility(Source,'A24B')
    endif
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if IsDead(U01)==false then
      call YXG(Source,U01)
    endif
    if IsDead(U02)==false then
      call YXG(Source,U02)
    endif
    if IsDead(U03)==false then
      call YXG(Source,U03)
    endif
    if IsDead(U04)==false then
      call YXG(Source,U04)
    endif
    if IsDead(U05)==false then
      call YXG(Source,U05)
    endif
  else
    set g=GetAvailableGroup()
    if IsDead(U01)==false and(LoadBoolean(HY,h,(511)))then
      set offset=360*5/ 5.
      set a=offset+CurrentAngle
      set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
      set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
      call SetUnitX(U01,x)
      call SetUnitY(U01,y)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
      if FirstOfGroup(g)!=null then
        call YXG(Source,U01)
      endif
      call GroupClear(g)
      set NW8=U01
      set NY8=1
      set NT8=Source
      call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
      call ForGroup(g,function YSG)
      call GroupClear(g)
    endif
    if IsDead(U02)==false and(LoadBoolean(HY,h,(512)))then
      set offset=360*4/ 5.
      set a=offset+CurrentAngle
      set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
      set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
      call SetUnitX(U02,x)
      call SetUnitY(U02,y)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
      if FirstOfGroup(g)!=null then
        call YXG(Source,U02)
      endif
      call GroupClear(g)
      set NW8=U02
      set NY8=2
      set NT8=Source
      call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
      call ForGroup(g,function YSG)
      call GroupClear(g)
    endif
    if IsDead(U03)==false and(LoadBoolean(HY,h,(513)))then
      set offset=360*3/ 5.
      set a=offset+CurrentAngle
      set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
      set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
      call SetUnitX(U03,x)
      call SetUnitY(U03,y)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
      if FirstOfGroup(g)!=null then
        call YXG(Source,U03)
      endif
      call GroupClear(g)
      set NW8=U03
      set NY8=3
      set NT8=Source
      call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
      call ForGroup(g,function YSG)
      call GroupClear(g)
    endif
    if IsDead(U04)==false and(LoadBoolean(HY,h,(514)))then
      set offset=360*2/ 5.
      set a=offset+CurrentAngle
      set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
      set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
      call SetUnitX(U04,x)
      call SetUnitY(U04,y)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
      if FirstOfGroup(g)!=null then
        call YXG(Source,U04)
      endif
      call GroupClear(g)
      set NW8=U04
      set NY8=4
      set NT8=Source
      call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
      call ForGroup(g,function YSG)
      call GroupClear(g)
    endif
    if IsDead(U05)==false and(LoadBoolean(HY,h,(515)))then
      set offset=360*1/ 5.
      set a=offset+CurrentAngle
      set x=SafeX50(SourceX+d*Cos(a*bj_DEGTORAD))
      set y=SafeY50(SourceY+d*Sin(a*bj_DEGTORAD))
      call SetUnitX(U05,x)
      call SetUnitY(U05,y)
      set tt_unit1=Source
      call GroupEnumUnitsInRange(g,x,y,95,Condition(function DF9))
      if FirstOfGroup(g)!=null then
        call YXG(Source,U05)
      endif
      call GroupClear(g)
      set NW8=U05
      set NY8=5
      set NT8=Source
      call GroupEnumUnitsInRange(g,x,y,175,Condition(function LC8))
      call ForGroup(g,function YSG)
      call GroupClear(g)
    endif
    call KillGroup(g)
  endif
  set t=null
  set Source=null
  set U01=null
  set U02=null
  set U03=null
  set U04=null
  set U05=null
  set g=null
  return false
endfunction

function Wisp_Spirits takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit U01
  local unit U02
  local unit U03
  local unit U04
  local unit U05
  local real x
  local real y
  set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*5/ 5.*-1.)
  set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*5/ 5.*-1.)
  set U01=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*5/ 5.*-1.)
  call UnitAddAbility2(U01,'Aloc')
  set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*4/ 5.*-1.)
  set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*4/ 5.*-1.)
  set U02=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*4/ 5.*-1.)
  call ShowUnit(U02,false)
  call SetUnitInvulnerable(U02,true)
  set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*3/ 5.*-1.)
  set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*3/ 5.*-1.)
  set U03=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*3/ 5.*-1.)
  call ShowUnit(U03,false)
  call SetUnitInvulnerable(U02,true)
  set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*2/ 5.*-1.)
  set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*2/ 5.*-1.)
  set U04=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*2/ 5.*-1.)
  call ShowUnit(U04,false)
  call SetUnitInvulnerable(U04,true)
  set x=GetUnitX(Source)+250*Cos(bj_DEGTORAD*360*1/ 5.*-1.)
  set y=GetUnitY(Source)+250*Sin(bj_DEGTORAD*360*1/ 5.*-1.)
  set U05=CreateUnit(GetOwningPlayer(Source),'h0CJ',x,y,360*1/ 5.*-1.)
  call ShowUnit(U05,false)
  call SetUnitInvulnerable(U05,true)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(393),(U01))
  call SaveUnitHandle(HY,h,(394),(U02))
  call SaveUnitHandle(HY,h,(395),(U03))
  call SaveUnitHandle(HY,h,(396),(U04))
  call SaveUnitHandle(HY,h,(397),(U05))
  call SaveBoolean(HY,h,(511),(true))
  call SaveBoolean(HY,h,(512),(false))
  call SaveBoolean(HY,h,(513),(false))
  call SaveBoolean(HY,h,(514),(false))
  call SaveBoolean(HY,h,(515),(false))
  call SaveBoolean(HY,h,(655),(false))
  call SaveBoolean(HY,h,(656),(false))
  call SaveReal(HY,h,(138),((150)*1.))
  call UnitAddAbility2(Source,'A24B')
  call UnitAddAbility2(Source,'A24A')
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function YZG))
  set Source=null
  set t=null
  set U01=null
  set U02=null
  set U03=null
  set U04=null
  set U05=null
endfunction

function YLG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Level=(LoadInteger(HY,h,5))
  if IsRealDamage then
    call HealUnitFor(Source,GetEventDamage()*.05*Level)
  endif
  set t=null
  set Source=null
  return false
endfunction

function Y1G takes unit u returns nothing
  local trigger t
  call UnitRemoveAbility(u,'A1TS')
  call UnitRemoveAbility(u,'A1TR')
  call UnitRemoveAbility(u,'A1TT')
  call UnitRemoveAbility(u,'A1TP')
  if(LoadBoolean(HY,(GetHandleId(u)),(708)))then
    call SaveBoolean(HY,(GetHandleId(u)),(708),(false))
    set t=(LoadTriggerHandle(HY,(GetHandleId(u)),(709)))
    call FlushChildHashtable(HY,(GetHandleId(t)))
    call CleanTrigger(t)
    call RemoveSavedHandle(HY,(GetHandleId(u)),(709))
    set t=null
  endif
endfunction

function Y0G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call Y1G(Source)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Y5G takes unit u,integer i returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,(u))
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Y0G))
  if i==1 then
    call UnitAddAbility2(u,'A1TS')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1TS',false)
  elseif i==2 then
    call UnitAddAbility2(u,'A1TR')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1TR',false)
  elseif i==3 then
    call UnitAddAbility2(u,'A1TT')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1TT',false)
  elseif i==4 then
    call UnitAddAbility2(u,'A1TP')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(u),'A1TP',false)
  endif
  if(LoadBoolean(HY,(GetHandleId(u)),(708)))==false then
    call SaveBoolean(HY,(GetHandleId(u)),(708),(true))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(t,Condition(function YLG))
    call SaveTriggerHandle(HY,(GetHandleId(u)),(709),(t))
    call SaveUnitHandle(HY,(GetHandleId(t)),2,(u))
    call SaveInteger(HY,(GetHandleId(t)),5,(i))
  endif
  set t=null
endfunction

function Wisp_Overcharge_Act takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Count=(LoadInteger(HY,h,(34)))
  local integer Level=GetUnitAbilityLevel(Source,'A28Q')
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Z4G=(LoadUnitHandle(HY,(GetHandleId(Source)),(652)))
  local boolean DCD=false
  local real hpcost=.2*(GetWidgetLife(Source)*.025)
  local real mpcost=.2*(GetUnitState(Source,UNIT_STATE_MANA)*.025)
  if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
    if GetIssuedOrderId()==852589then
      call Y5G(Source,Level)
    elseif GetIssuedOrderId()==852590then
      call Y1G(Source)
    endif
  endif
  if GetUnitAbilityLevel(Source,'A1TS')>0 or GetUnitAbilityLevel(Source,'A1TR')>0 or GetUnitAbilityLevel(Source,'A1TT')>0 or GetUnitAbilityLevel(Source,'A1TP')>0 then
    set DCD=true
    call SetWidgetLife(Source,RMaxBJ(GetWidgetLife(Source)-hpcost,1))
    call SetUnitState(Source,UNIT_STATE_MANA,RMaxBJ(GetUnitState(Source,UNIT_STATE_MANA)-mpcost,1))
  endif
  if Z4G==null then
    if Target!=null then
      call Y1G(Target)
      set Target=null
      call SaveUnitHandle(HY,h,17,(Target))
    endif
  else
    if Target==null then
      set Target=Z4G
      if DCD then
        call SaveUnitHandle(HY,h,17,(Target))
        call Y5G(Target,Level)
      else
        call Y1G(Target)
      endif
    elseif Target!=Z4G then
      call Y1G(Target)
      if DCD then
        set Target=Z4G
        call SaveUnitHandle(HY,h,17,(Target))
        call Y5G(Target,Level)
      endif
    elseif DCD==false then
      call Y1G(Target)
    elseif Target==Z4G then
      if DCD then
        set Target=Z4G
        call SaveUnitHandle(HY,h,17,(Target))
        call Y5G(Target,Level)
      endif
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set Z4G=null
  return false
endfunction

function Wisp_Overcharge_Learn takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A28Q')
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(null))
  call TriggerRegisterTimerEvent(t,.2,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
  call TriggerAddCondition(t,Condition(function Wisp_Overcharge_Act))
  set Source=null
  set t=null
endfunction

function Tether_RemoveSlow takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if not(UnitRemoveAbility(u,'A304') and UnitRemoveAbility(u,'B304')) or GetUnitAbilityLevel(u,'B304')>0 then
    if LoadBoolean(HY,h,0)==false then
      call TriggerRegisterTimerEvent(t,1,true)
      call SaveBoolean(HY,h,0,true)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set u=null
  set t=null
endfunction

function Tether_ApplySlow takes unit u,real dur returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,dur,false)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call TriggerAddCondition(t,Condition(function Tether_RemoveSlow))
  call UnitAddAbility2(u,'A305')
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A305',false)
  call SaveUnitHandle(HY,h,0,u)
  set t=null
endfunction

function ZEG takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),NA8)==false then
    call GroupAddUnit(NA8,GetEnumUnit())
    call Tether_ApplySlow(GetEnumUnit(),.25+.5*NC8)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",GetEnumUnit(),"chest"))
  endif
endfunction

function ZFG takes unit Source,unit Target,group HND, integer lvl returns nothing
  local real x1=GetUnitX(Source)
  local real y1=GetUnitY(Source)
  local real x2=GetUnitX(Target)
  local real y2=GetUnitY(Target)
  local real a=AngleBetweenXY(x1,y1,x2,y2)*bj_DEGTORAD
  local real x
  local real y
  local real d=DistanceBetweenXY(x1,y1,x2,y2)
  local group g=GetAvailableGroup()
  local integer i=1
  set NA8=HND
  set NC8=lvl
  loop
    exitwhen i>8
    set tt_unit1=Source
    set x=x1+d*i/ 8*Cos(a)
    set y=y1+d*i/ 8*Sin(a)
    call GroupEnumUnitsInRange(g,x,y,100,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function ZEG)
    call GroupClear(g)
    set i=i+1
  endloop
  call KillGroup(g)
  set g=null
endfunction

function ZGG takes unit Source,unit Target returns boolean
  return((LoadInteger(HY,(GetHandleId((Source))),((4294))))==1)
endfunction

function ZHG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real d=DistanceBetweenUnits(Source,Target)
  local real a=GetAngleBetweenUnits(Source,Target)*bj_DEGTORAD
  local real x=GetUnitX(Source)+20*Cos(a)
  local real y=GetUnitY(Source)+20*Sin(a)
  local location l
  if d<300 or d>2150 then
    set l=LI8(x,y)
    set x=GetLocationX(l)
    set y=GetLocationY(l)
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitX(Source,SafeX50(x))
    call SetUnitY(Source,SafeY50(y))
    call KillTrees(x,y,350)
    call RemoveLocation(l)
    set l=null
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SaveInteger(HY,(GetHandleId((Source))),((4295)),2)
  else
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitX(Source,x)
    call SetUnitY(Source,y)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function ZIG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local group HND=(LoadGroupHandle(HY,h,(133)))
  local lightning ZQ8=(LoadLightningHandle(HY,h,(196)))
  local integer Count=GetTriggerEvalCount(t)
  local real d=DistanceBetweenUnits(Source,Target)
  local real a=1
  local real WEE=GetWidgetLife(Source)
  local real IVD=GetUnitState(Source,UNIT_STATE_MANA)
  local real ZJG=(LoadReal(HY,h,(670)))
  local real ZKG=(LoadReal(HY,h,(667)))
  local real ZMG
  local real ZNG
  if Target==null or Source==null or IsDead(Source) or(Count>600 and ZGG(Source,Target)==false and((LoadInteger(HY,(GetHandleId((Source))),((4295))))==1)==false)or(d>925 and((LoadInteger(HY,(GetHandleId((Source))),((4295))))==1)==false)or GetTriggerEventId()==EVENT_UNIT_DEATH or(GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT and GetSpellAbilityId()=='A1TU')then
    call KillGroup(HND)
    call DestroyLightning(ZQ8)
    call UnitRemoveAbility(Target,'A1TH')
    call UnitRemoveAbility(Target,'A1TI')
    call UnitRemoveAbility(Target,'A1TG')
    call UnitRemoveAbility(Target,'A1TJ')
    call UnitRemoveAbility(Target,'B0DH')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'A1TH')
    call UnitRemoveAbility(Source,'A1TI')
    call UnitRemoveAbility(Source,'A1TG')
    call UnitRemoveAbility(Source,'A1TJ')
    call UnitRemoveAbility(Source,'B0DH')
    call UnitRemoveAbility(Source,'A1TU')
    if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))=='A1TA' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1TA',true)
    endif
    call RemoveSavedHandle(HY,GetHandleId(Source),652)
  else
    set ZMG=WEE/ GetUnitState(Source,UNIT_STATE_MAX_LIFE)
    set ZNG=IVD/ GetUnitState(Source,UNIT_STATE_MAX_MANA)
    if ZMG-ZJG>0 and(ZMG-ZJG)<.5 then
      if((LoadInteger(HY,(GetHandleId((Source))),((4298))))==1)==false then
        call SetWidgetLife(Target,GetWidgetLife(Target) + (ZMG-ZJG)*GetUnitState(Source,UNIT_STATE_MAX_LIFE)*1.5)
      endif
    endif
    if ZNG-ZKG>0 and(ZNG-ZKG)<.5 then
      call SetUnitState(Target,UNIT_STATE_MANA,GetUnitState(Target,UNIT_STATE_MANA)+(ZNG-ZKG)*GetUnitState(Source,UNIT_STATE_MAX_MANA)*1.5)
    endif
    call SaveReal(HY,h,(670),((GetWidgetLife(Source)/ GetUnitState(Source,UNIT_STATE_MAX_LIFE))*1.))
    call SaveReal(HY,h,(667),((GetUnitState(Source,UNIT_STATE_MANA)/ GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
    call MoveLightning(ZQ8,true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
    call ZFG(Source,Target,HND,LoadInteger(HY,h,0))
    if IsUnitVisible(Source,GetLocalPlayer())==false and IsUnitVisible(Target,GetLocalPlayer())==false then
      set a=0
    endif
    if IsObserver(GetLocalPlayer())then
      set a=1
    endif
    if d<700 or((LoadInteger(HY,(GetHandleId((Source))),((4295))))==1) then
      call SetLightningColor(ZQ8,.0,1.,1.,a)
    else
      call SetLightningColor(ZQ8,.8,.7,.4,a)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set HND=null
  set ZQ8=null
  return false
endfunction

function Wisp_Tether takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local lightning ZQ8=AddLightning("CHIM",true,GetUnitX(Source),GetUnitY(Source),GetUnitX(Target),GetUnitY(Target))
  local integer Level=GetUnitAbilityLevel(Source,'A1TA')
  local integer ZEE
  local real d=DistanceBetweenUnits(Source,Target)
  local real a=GetAngleBetweenUnits(Source,Target)*bj_DEGTORAD
  local location l
  local real x
  local real y
  call SetLightningColor(ZQ8,.0,1.,1.,1)
  call UnitAddAbility2(Source,'A1TU')
  if Level==1 then
    set ZEE='A1TH'
  elseif Level==2 then
    set ZEE='A1TI'
  elseif Level==3 then
    set ZEE='A1TG'
  elseif Level==4 then
    set ZEE='A1TJ'
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A1TA',false)
  call UnitAddAbility2(Source,ZEE)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),ZEE,false)
  call UnitAddAbility2(Target,ZEE)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),ZEE,false)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,0,Level)
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveGroupHandle(HY,h,(133),(GetAvailableGroup()))
  call SaveLightningHandle(HY,h,(196),(ZQ8))
  call SaveReal(HY,h,(670),((GetWidgetLife(Source)/ GetUnitState(Source,UNIT_STATE_MAX_LIFE))*1.))
  call SaveReal(HY,h,(667),((GetUnitState(Source,UNIT_STATE_MANA)/ GetUnitState(Source,UNIT_STATE_MAX_MANA))*1.))
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function ZIG))
  call SaveUnitHandle(HY,(GetHandleId(Source)),(652),(Target))
  if d>700 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveUnitHandle(HY,h,17,(Target))
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",Source,"chest")))
    call TriggerRegisterTimerEvent(t,.02,true)
    call TriggerAddCondition(t,Condition(function ZHG))
    call SaveInteger(HY,(GetHandleId((Source))),((4295)),(1))
  endif
  set Source=null
  set Target=null
  set ZQ8=null
  set t=null
  set l=null
endfunction

function ZQG takes unit Source,real x,real y returns boolean
  local boolean result=false
  local player p=GetOwningPlayer(Source)
  local unit Caster=CreateUnit(p,'e02Q',GetUnitX(Source),GetUnitY(Source),0)
  call UnitAddAbility2(Caster,'A1V4')
  if IssuePointOrderById(Caster,852525,x,y) then
    call KillUnit(Caster)
    set Caster=null
    set p=null
    return true
  else
    call KillUnit(Caster)
    set Caster=null
    set p=null
    return false
  endif
endfunction

function ZRG takes string ZS8,unit Target returns nothing
  local texttag tt=CreateTextTag()
  call SetTextTagText(tt,ZS8,.033)
  call SetTextTagPosUnit(tt,Target,64)
  call SetTextTagColor(tt,0,50,255,255)
  call SetTextTagVelocity(tt,0,.0355)
  call SetTextTagFadepoint(tt,.15)
  call SetTextTagPermanent(tt,false)
  call SetTextTagLifespan(tt,.85)
  call SetTextTagVisibility(tt,IsPlayerAlly(GetLocalPlayer(),GetOwningPlayer(Target)))
  set tt=null
endfunction

function ZSG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer Count=GetTriggerEvalCount(t)
  if IsDead(Source)==false and Count<12 then
    call ZRG(I2S(12-Count),Source)
  endif
  if Count==12 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function ZTG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,(GetHandleId(Source)),(652)))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real SourceX=(LoadReal(HY,h,(189)))
  local real SourceY=(LoadReal(HY,h,(190)))
  local fogmodifier fm=(LoadFogModifierHandle(HY,h,(42)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call SaveInteger(HY,(GetHandleId((Source))),((4294)),2)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call KillTrees(TargetX,TargetY,250)
    call KillTrees(SourceX,SourceY,250)
    if GetTriggerEvalCount(t)==1 then
      if IsDead(Source)==false then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Source),GetUnitY(Source)))
        call SetUnitPosition(Source,TargetX,TargetY)
        call PanCameraToTimedForPlayer(GetOwningPlayer(Source),TargetX,TargetY,0)
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Source),GetUnitY(Source)))
      endif
      if Target!=null and IsDead(Target)==false and GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0]and((LoadBoolean(HY,(GetHandleId(GetOwningPlayer((Target)))),(139)))==false)then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Target),GetUnitY(Target)))
        call AddTimedKeyToUnit(Target,4402,1)
        call SetUnitPosition(Target,TargetX,TargetY)
        if IsUnitType(Target,UNIT_TYPE_HERO) and IsDead(Target)==false then
          call PanCameraToTimedForPlayer(GetOwningPlayer(Target),TargetX,TargetY,0)
        endif
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Target),GetUnitY(Target)))
      endif
    else
      if IsDead(Source)==false then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Source),GetUnitY(Source)))
        call SetUnitPosition(Source,SourceX,SourceY)
        call PanCameraToTimedForPlayer(GetOwningPlayer(Source),SourceX,SourceY,0)
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Source),GetUnitY(Source)))
      endif
      if Target!=null and IsDead(Target)==false and GetOwningPlayer(Target)!=Sentinels[0]and GetOwningPlayer(Target)!=Scourges[0]and((LoadBoolean(HY,(GetHandleId(GetOwningPlayer((Target)))),(139)))==false)then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Target),GetUnitY(Target)))
        call AddTimedKeyToUnit(Target,4402,1)
        call SetUnitPosition(Target,SourceX,SourceY)
        if IsUnitType(Target,UNIT_TYPE_HERO) and IsDead(Target)==false then
          call PanCameraToTimedForPlayer(GetOwningPlayer(Target),SourceX,SourceY,0)
        endif
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",GetUnitX(Target),GetUnitY(Target)))
      endif
      call SaveInteger(HY,(GetHandleId((Source))),((4294)),2)
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call FogModifierStop(fm)
      call DestroyFogModifier(fm)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set fm=null
  return false
endfunction

function ZUG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local fogmodifier fm
  local integer Level=GetUnitAbilityLevel(Source,'A1TB')
  if IsUnitDisabled(Source)or IsUnitEntangled(Source)or IsDead(Source)then
    call SaveInteger(HY,(GetHandleId((Source))),((4294)),2)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)==(2.75-.25*Level)/ .05 then
    set fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,GetUnitX(Source),GetUnitY(Source),400,true,true)
    call FogModifierStart(fm)
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call TriggerRegisterTimerEvent(t,.01,false)
    call TriggerRegisterTimerEvent(t,12,false)
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_DEATH)
    call TriggerAddCondition(t,Condition(function ZTG))
    call SaveReal(HY,h,(189),((GetUnitX(Source))*1.))
    call SaveReal(HY,h,(190),((GetUnitY(Source))*1.))
    call SaveReal(HY,h,(47),((TargetX)*1.))
    call SaveReal(HY,h,(48),((TargetY)*1.))
    call SaveEffectHandle(HY,h,(32),(AddSpecialEffect("war3mapImported\\EarthlyEminence.mdl",GetUnitX(Source),GetUnitY(Source))))
    call SaveFogModifierHandle(HY,h,(42),(fm))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function ZSG))
  endif
  set Source=null
  set t=null
  set fm=null
  return false
endfunction

function Wisp_Relocate takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local unit Target=(LoadUnitHandle(HY,(GetHandleId(Source)),(652)))
  local integer id=GetPlayerId(GetOwningPlayer(Source))
  local integer Level=GetUnitAbilityLevel(Source,'A1TB')
  local boolean b=false
  call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\NightElf\\NECancelDeath\\NECancelDeath.mdl",Source,"chest"))
  if IsPlayerAlly(GetOwningPlayer(Source),GetLocalPlayer()) or (udg_ObserverMode and IsObserver(GetLocalPlayer())) or IsVisibleToPlayer(x,y,GetLocalPlayer()) then
    set b=true
    call PingMinimapEx(x,y,4.,255,0,0,false)
  endif
  call TimedReveal(GetOwningPlayer(Source),2.5,x,y,300)
  call SaveUnitHandle(HY,h,2,(Source))
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerAddCondition(t,Condition(function ZUG))
  call SaveReal(HY,h,(47),((x)*1.))
  call SaveReal(HY,h,(48),((y)*1.))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffect("war3mapImported\\EarthlyEminence.mdl",x,y)))
  call SaveInteger(HY,(GetHandleId((Source))),((4294)),(1))
  set Source=null
  set Target=null
  set t=null
endfunction

function Wisp_Relocate_OnCast takes nothing returns nothing
  if ZQG(GetTriggerUnit(),GetSpellTargetX(),GetSpellTargetY())==false then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n0KX'))
  else
    if IsSentinel(GetOwningPlayer(GetTriggerUnit()))then
      if IsPointInRegion(N68,GetSpellTargetX(),GetSpellTargetY()) then
        call InterruptUnit(GetTriggerUnit())
        call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03Y'))
      endif
    else
      if IsPointInRegion(N38,GetSpellTargetX(),GetSpellTargetY()) then
        call InterruptUnit(GetTriggerUnit())
        call Error(GetOwningPlayer(GetTriggerUnit()),GetObjectName('n03Y'))
      endif
    endif
  endif
endfunction

function Wisp_Relocate_Init takes nothing returns nothing
  set N38=CreateRegion()
  call RegionAddRect(N38,G4)
  call RegionAddRect(N38,H5)
  set N68=CreateRegion()
  call RegionAddRect(N68,F4)
  call RegionAddRect(N68,Z5)
endfunction

function ZXG takes unit Source,unit Target,real SourceX,real SourceY,real a2 returns nothing
  local integer i=0
  local real TargetX
  local real TargetY=GetUnitY(Target)
  local real a
  local real x
  local real y
  local real ZYG
  set a=a2
  set TargetX=SourceX+50*Cos(a*bj_DEGTORAD)
  set TargetY=SourceY+50*Sin(a*bj_DEGTORAD)
  set ZYG=a
  set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
  set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
  call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)
  call KillTrees(x,y,300)
  set ZYG=a-40
  set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
  set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
  call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)
  call KillTrees(x,y,300)
  set ZYG=a-80
  set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
  set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
  call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)
  call KillTrees(x,y,300)
  set ZYG=a+40
  set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
  set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
  call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)
  call KillTrees(x,y,300)
  set ZYG=a+80
  set x=TargetX+200*Cos(ZYG*bj_DEGTORAD)
  set y=TargetY+200*Sin(ZYG*bj_DEGTORAD)
  call B88(CreateDestructable('B006',x,y,-1*ZYG,.6,1),7)
  call KillTrees(x,y,300)
endfunction

function ZZG takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),N58)==false then
    call GroupAddUnit(N58,GetEnumUnit())
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\ChainFreeze_F6.mdx",GetEnumUnit(),"chest"))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetEnumUnit(),"chest"))
    call DamageTarget(NL8,GetEnumUnit(),1,N08*70)
  endif
endfunction

function ZAG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local unit proj=LoadUnitHandle(HY,h,45)
  local real maxX=LoadReal(HY,h,683)
  local real maxY=LoadReal(HY,h,684)
  local real SourceX=GetUnitX(proj)
  local real SourceY=GetUnitY(proj)
  local real angle=Atan2(maxY-SourceY,maxX-SourceX)
  local real nx=SourceX+22*Cos(angle)
  local real ny=SourceY+22*Sin(angle)
  local group gg=LoadGroupHandle(HY,h,133)
  local integer Level=LoadInteger(HY,h,0)
  local group g=GetAvailableGroup()
  set tt_unit1=Source
  set NL8=Source
  set N58=gg
  set N08=Level
  set N18=null
  call GroupEnumUnitsInRange(g,nx,ny,225,Condition(function DefaultEnemyFilter))
  call ForGroup(g,function ZZG)
  call KillGroup(g)
  call SetUnitPosition(proj,nx,ny)
  if DistanceBetweenXY(nx,ny,maxX,maxY)<40 then
    call KillUnit(proj)
    call ShowUnit(proj,false)
    call SetUnitPathing(proj,true)
    call ZXG(Source,null,nx,ny,angle*bj_RADTODEG)
    call KillGroup(gg)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set Source=null
  set Target=null
  set t=null
  set proj=null
  set gg=null
  set g=null
  return false
endfunction

function Tuskar_IceShards takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit proj=CreateUnit(GetOwningPlayer(Source),'h0CS',GetUnitX(Source),GetUnitY(Source),0)
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetSpellTargetX()
  local real TargetY=GetSpellTargetY()
  local real angle=Atan2(TargetY-SourceY,TargetX-SourceX)
  local real maxX=SafeX50(TargetX)
  local real maxY=SafeY50(TargetY)
  call SetUnitFacing(proj,angle*bj_RADTODEG)
  call SetUnitPathing(proj,false)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function ZAG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,683,maxX*1.)
  call SaveReal(HY,h,684,maxY*1.)
  call SaveReal(HY,h,13,angle*1.)
  call SaveUnitHandle(HY,h,45,proj)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call SaveGroupHandle(HY,h,133,GetAvailableGroup())
  set Source=null
  set proj=null
  set t=null
endfunction

function Z6G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  local integer Count=GetTriggerEvalCount(t)
  local real y=(Count-50)*(Count-50)/ 4.3
  local real Damage
  if Level==1 then
    set Damage=75
  elseif Level==2 then
    set Damage=150
  else
    set Damage=225
  endif
  if Count==1 then
    call IssueTargetOrderById(Source,851983,Target)
  endif
  if Count<50 then
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,700*Count/ 50,0)
    endif
  elseif Count<100 then
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,700-700*(Count-50)/ 50,0)
    endif
  else
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
    endif
    call DestroyEffect(LoadEffectHandle(HY,h,175))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitAddAbilityTimedEx(Target,'A204',1,1+Level,'B0DY')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),'A204',false)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function ZLG takes unit Source,unit Target, integer Level returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TextTagOnUnit("WALRUS PUNCH !!",3.5,Source,.03,255,0,0,255)
  call PlaySoundAtPos(VF,GetUnitX(Target),GetUnitY(Target))
  call StunTargetLod(Target,1.0)
  if IsBuggyFlying(Target)==false then
    call UnitAddAbility2(Target,'Amrf')
    call UnitRemoveAbility(Target,'Amrf')
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"overhead"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"head"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"left,hand"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"right,hand"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"chest"))
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostBolt\\FrostBoltMissile.mdl",Target,"origin"))
  call TriggerRegisterTimerEvent(t,.01,true)
  call TriggerAddCondition(t,Condition(function Z6G))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveInteger(HY,h,0,Level)
  call SaveEffectHandle(HY,h,175,AddSpecialEffectTarget("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",Target,"chest"))
  set t=null
endfunction

function WalrusPunchASFixSup takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A1UH')
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTimer(t)
  set u=null
  set t=null
endfunction

function WalrusPunchASFix takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.2,false,function WalrusPunchASFixSup)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function Z1G takes nothing returns boolean
  local trigger t2=GetTriggeringTrigger()
  local integer h2=GetHandleId(t2)
  local unit Source=LoadUnitHandle(HY,h2,2)
  local unit Target=LoadUnitHandle(HY,h2,17)
  local effect Visual=LoadEffectHandle(HY,h2,32)
  local trigger t=LoadTriggerHandle(HY,h2,35)
  local integer h=LoadInteger(HY,h2,375)
  if GetTriggerEvalCount(t2)==1 then
    call IssueTargetOrderById(Source,851983,Target)
  else
    if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
      if GetEventDamageSource()==Source and GetEventDamage()>30 and IsRealDamage and IsFakeDamage==false then
        call AddTimedAbility(Source,'A1UH',1,.1)
        call DestroyEffect(Visual)
        call CleanTrigger(t2)
        call FlushChildHashtable(HY,h2)
        call CleanTrigger(t)
        call FlushChildHashtable(HY,h)
        call ZLG(Source,Target,LoadInteger(HY,h2,0))
      endif
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_ATTACKED then
      if GetAttacker()==Source and GetTriggerUnit()!=Target then
        call FlushChildHashtable(HY,h2)
        call CleanTrigger(t2)
      endif
    else
      
      call UnitRemoveAbility(Source,'A1UH')
      call RemoveSavedHandle(HY,h,17)
      call FlushChildHashtable(HY,h2)
      call CleanTrigger(t2)
    endif
  endif
  set t2=null
  set t=null
  set Source=null
  set Target=null
  set Visual=null
  return false
endfunction

function Z5G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target
  local effect Visual=LoadEffectHandle(HY,h,32)
  local trigger t2
  local integer h2
  if GetTriggerEventId()!=EVENT_PLAYER_UNIT_ATTACKED then
    call DestroyEffect(Visual)
    call UnitRemoveAbility(Source,'A1UH')
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetAttacker()==Source and GetTriggerUnit()!=(LoadUnitHandle(HY,h,17))and IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(Source))==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false and GetUnitTypeId(Source)!='N0MH' then
    set Target=GetTriggerUnit()
    call SaveUnitHandle(HY,h,17,Target)
    set t2=CreateTrigger()
    set h2=GetHandleId(t2)
    call TriggerRegisterTimerEvent(t2,0,false)
    call TriggerRegisterTimerEvent(t2,2,false)
    call TriggerRegisterUnitEvent(t2,Target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterAnyUnitEvent(t2,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerAddCondition(t2,Condition(function Z1G))
    call SaveUnitHandle(HY,h2,2,Source)
    call SaveUnitHandle(HY,h2,17,Target)
    call SaveEffectHandle(HY,h2,32,Visual)
    call SaveInteger(HY,h2,375,h)
    call SaveTriggerHandle(HY,h2,35,t)
    call SaveInteger(HY,h2,0,LoadInteger(HY,h,0))
  endif
  set t=null
  set Source=null
  set Target=null
  set Visual=null
  set t2=null
  return false
endfunction

function Tuskar_WalrusPunch takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerAddCondition(t,Condition(function Z5G))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,null)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\WalrusPunchWeaponFX.mdx",Source,GetProperAttachPoint_Weapon(Source)))
  call UnitAddAbility2(Source,'A1UH')
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  if(GetUnitAbilityLevel(Source,'A0DL')>0) then
    call SetUnitAbilityLevel(Source,'A1UL',2)
  endif
  call UnitMakeAbilityPermanent(Source,true,'A1UL')
  set t=null
  set Source=null
endfunction

function A7G takes nothing returns nothing
  call ShowUnit(GetEnumUnit(),true)
  call UnitRemoveAbility(GetEnumUnit(),'A04R')
  call SetUnitInvulnerable(GetEnumUnit(),false)
  call PauseUnit(GetEnumUnit(),false)
  call echo(GetUnitName(GetEnumUnit())+"shown")
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
    call SetUnitPosition(GetEnumUnit(),OD8,OE8)
    call SelectUnitForPlayerSingle(GetEnumUnit(),GetOwningPlayer(GetEnumUnit()))
  else
    call SetUnitX(GetEnumUnit(),OD8)
    call SetUnitY(GetEnumUnit(),OE8)
  endif
  if GetEnumUnit()==O48 and O78!=null then
    call IssueTargetOrderById(O48,851983,O78)
  endif
  call DestroyEffect(AddSpecialEffect("war3mapImported\\ChainFreeze_F6.mdx",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
endfunction

function A8G takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),N28)==false then
    call GroupAddUnit(N28,GetEnumUnit())
    call DamageTarget(O48,GetEnumUnit(),1,40*O98+40)
    call StunTargetLod(GetEnumUnit(),0.25*O98 + 0.25)
  endif
endfunction

function A9G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer Cache=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,(Cache),(2)))
  local unit Target=(LoadUnitHandle(HY,(Cache),(17)))
  local unit Projectile=(LoadUnitHandle(HY,(Cache),(45)))
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real r=(LoadReal(HY,(Cache),(671)))
  local real a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),TargetX,TargetY)*bj_DEGTORAD
  local real x=GetUnitX(Projectile)+r*Cos(a)
  local real y=GetUnitY(Projectile)+r*Sin(a)
  local group HND=(LoadGroupHandle(HY,(Cache),(133)))
  local group g
  local integer Count=GetTriggerEvalCount(t)
  local real EMF=RMinBJ(2.5+(Count*.02),10)
  local real RFE=225+40*(Count*.02)
  set O98=GetUnitAbilityLevel(Source,'A1S7')
  set tt_unit1=Source
  set N28=HND
  set O48=Source
  set O78=Target
  set O88=(LoadUnitHandle(HY,(Cache),(19)))
  call SetUnitX(Projectile,x)
  call SetUnitY(Projectile,y)
  call SetUnitFacing(Projectile,a*bj_RADTODEG-180)
  call SetUnitScale(Projectile,EMF,EMF,EMF)
  if DistanceBetweenXY(x,y,TargetX,TargetY)<r*2 or Count==150 then
    call KillTrees(x,y,300)
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function A8G)
    call KillGroup(g)
    set g=null
    set OD8=x
    set OE8=y
    set g=LoadGroupHandle(HY,(Cache),(22))
    call echo(I2S(GetHandleId(g))+" -> "+I2S(CountUnitsInGroup(g)))
    call ForGroup((g),function A7G)
    call KillGroup(g)
    call KillGroup(HND)
    call KillUnit(Projectile)
    call FlushChildHashtable(HY,(Cache))
    call CleanTrigger(t)
  else
    if ModuloInteger(GetTriggerEvalCount(t),5)==0 then
      call KillTrees(x,y,300)
      set g=GetAvailableGroup()
      call GroupEnumUnitsInRange(g,x,y,RFE,Condition(function DefaultEnemyFilter))
      call ForGroup(g,function A8G)
      call KillGroup(g)
      set g=null
    endif
  endif
  set t=null
  set Source=null
  set Projectile=null
  set HND=null
  set Target=null
  return false
endfunction

function ADG takes nothing returns nothing
  call DestroyEffect(AddSpecialEffect("war3mapImported\\ChainFreeze_F6.mdx",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
  call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FrostWyrmMissile\\FrostWyrmMissile.mdl",GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit())))
  call ShowUnit(GetEnumUnit(),false)
  call UnitAddAbility2(GetEnumUnit(),'A04R')
  call SetUnitInvulnerable(GetEnumUnit(),true)
  call PauseUnit(GetEnumUnit(),true)
  call echo(GetUnitName(GetEnumUnit())+"hidden")
endfunction

function AEG takes nothing returns boolean
  local unit t = GetFilterUnit()
  local player p = GetOwningPlayer(t)
  local boolean b=false
  if IsUnitAlly(O48,p) and (p==GetOwningPlayer(O48) or (LoadBoolean(HY,GetHandleId(p),139)==false and IsUnitType(t,UNIT_TYPE_HERO))) and (GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsDead(t)==false) and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    set b=true
  endif
  set t = null
  return b
endfunction

function Tuskar_Snowball takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer Cache=GetHandleId(t)
  local real SourceX=GetUnitX(Source)
  local real SourceY=GetUnitY(Source)
  local real TargetX=GetUnitX(Target)
  local real TargetY=GetUnitY(Target)
  local real a=AngleBetweenXY(SourceX,SourceY,TargetX,TargetY)*bj_DEGTORAD
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0C3',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  local group g=GetAvailableGroup()
  set OF8=0
  set OG8=1
  set O48=Source
  set OF8=1.5*RMaxBJ(133,GetUnitMoveSpeedLOD(Source))
  call GroupEnumUnitsInRange(g,SourceX,SourceY,255,Condition(function AEG))
  call ForGroup(g,function ADG)
  set O88=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  call SetUnitTimeScale(Projectile,2)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function A9G))
  call SaveUnitHandle(HY,(Cache),(2),(Source))
  call SaveUnitHandle(HY,(Cache),(17),(Target))
  call SaveUnitHandle(HY,(Cache),(19),(O88))
  call SaveUnitHandle(HY,(Cache),(45),(Projectile))
  call SaveReal(HY,(Cache),(137),((a)*1.))
  call SaveReal(HY,(Cache),(671),((OF8*.02)*1.))
  call SaveReal(HY,(Cache),(47),((TargetX)*1.))
  call SaveReal(HY,(Cache),(48),((TargetY)*1.))
  call echo(I2S(GetHandleId(g)))
  call SaveGroupHandle(HY,(Cache),(22),(g))
  call SaveGroupHandle(HY,(Cache),(133),(GetAvailableGroup()))
  set t=null
  set Source=null
  set Target=null
  set Projectile=null
  set g=null
endfunction

function Tuskar_FrozenSigil_Register takes unit u returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_DEATH)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call TriggerAddCondition(t,Condition(function Oblivion_NetherWard_DmgBlock))
  set t=null
endfunction

function AHG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit sigil=LoadUnitHandle(HY,h,2)
  local unit tusk=LoadUnitHandle(HY,h,17)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call IssueTargetOrderById(sigil,851986,tusk)//move
  set t=null
  set sigil=null
  set tusk=null
  return false
endfunction

function AIG takes nothing returns nothing
  local unit sigil=GetSummonedUnit()
  local unit tusk=GetSummoningUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerAddCondition(t,Condition(function AHG))
  call TriggerRegisterTimerEvent(t,.2,false)
  call SaveUnitHandle(HY,h,2,sigil)
  call SaveUnitHandle(HY,h,17,tusk)
  set t=null
  set sigil=null
  set tusk=null
endfunction

function AJG takes nothing returns boolean
  local integer id=GetUnitTypeId(GetSummonedUnit())
  if id=='o01J' or id=='o01K' or id=='o01L' or id=='o01M' then
    call Tuskar_FrozenSigil_Register(GetSummonedUnit())
    call AIG()
  endif
  return false
endfunction

function Tusk_Sigil_Summon takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function AJG))
  set t=null
endfunction



function AMG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local unit Caster=(LoadUnitHandle(HY,h,(19)))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED and IsRealDamage then
    set OH8=GetEventDamageSource()
  else
    call SetUnitX(Source,GetUnitX(Target))
    call SetUnitY(Source,GetUnitY(Target))
    call SetUnitX(Caster,GetUnitX(Target))
    call SetUnitY(Caster,GetUnitY(Target))
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  return false
endfunction

function ANG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  if GetTriggerEventId()==EVENT_UNIT_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    set OH8=GetEventDamageSource()
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function AOG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetSummoningUnit()
  local unit Target=GetSummonedUnit()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  local integer lvl
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function AMG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveUnitHandle(HY,h,(19),(Caster))
  if EM9(Source,'I0A8')then
    call UnitAddAbility(Caster,'A04I')
  endif
  if GetUnitAbilityLevel(Source,'A14K')>0 then
    call UnitAddAbility(Caster,'A14K')
  endif
  set lvl=GetUnitAbilityLevel(Source,'A06M')
  if lvl==0 then
    set lvl=4
  endif
  if GetUnitAbilityLevel(Source,'A1B6')>0 then
    call UnitAddAbility2(Target,'A06M')
    call SetUnitAbilityLevel(Target,'A06M',lvl)
  endif
  call SaveInteger(HY,GetHandleId(Source),4500,1)
  set t=null
  set Source=null
  set Target=null
  set Caster=null
endfunction

function APG takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetSummoningUnit()
  local unit Target=GetSummonedUnit()
  local integer lvl
  local integer id
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function ANG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  if GetUnitAbilityLevel(Source,'A1B6')>0 then
    if GetUnitTypeId(Target)=='npn2' or GetUnitTypeId(Target)=='npn5' or GetUnitTypeId(Target)=='n012' then//storm
      set id='Acdh'
      set lvl=GetUnitAbilityLevel(Source,'Acdh')
      if lvl==0 then
        set lvl=4
      endif
    else
      set id='Q119'
      set lvl=GetUnitAbilityLevel(Source,'P119')
      if lvl==0 then
        set lvl=4
      endif
    endif
    if id=='Q119' then
      call UnitAddAbility2(Target,id)
      call SetUnitAbilityLevel(Target,'P119',lvl)
      call UnitAddAbility2(Target,'A0MX')
      call SetUnitAbilityLevel(Target,'A0MX',lvl)
    else
      call UnitAddAbility2(Target,id)
      call SetUnitAbilityLevel(Target,id,lvl)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
endfunction

function AQG takes nothing returns boolean
  local integer W78=GetUnitTypeId(GetSummonedUnit())
  if W78=='npn3' or W78=='npn6' or W78=='n010' or W78=='n0GZ' then
    call AOG()
  elseif AKG(W78)then
    call APG()
  endif
  return false
endfunction

function Pandaren_PrimalSplit_Summon takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function AQG))
  set t=null
endfunction

function ARG takes nothing returns nothing
  call StunTargetLod(GetEnumUnit(),.75+.25*Rubick_TempInt)
endfunction

function ASG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local real a=LoadReal(HY,h,137)
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  local real SourceX=LoadReal(HY,h,189)
  local real SourceY=LoadReal(HY,h,190)
  local group g
  local real d=DistanceBetweenXY(SourceX,SourceY,TargetX,TargetY)/ 25
  local location l
  local integer Count=GetTriggerEvalCount(t)
  local real x=SourceX+d*Count*Cos(a)
  local real y=SourceY+d*Count*Sin(a)
  
  if IsUnitType(Target,UNIT_TYPE_HERO)then
    call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
  endif
  call SetUnitX(Target,SafeX50(x))
  call SetUnitY(Target,SafeY50(y))
  if IsBuggyFlying(Target)==false then
    call SetUnitFlyHeight(Target,325-13*Count,0)
  endif
  if Count==25 then
    if IsUnitType(Target,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
    endif
    call SetUnitX(Target,SafeX50(TargetX))
    call SetUnitY(Target,SafeY50(TargetY))
    if IsPointInRegion(RestrictedRegion,GetUnitX(Target),GetUnitY(Target)) then
      set l=LI8(GetUnitX(Target),GetUnitY(Target))
      if IsUnitType(Target,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(Target),99,true)
      endif
      call SetUnitX(Target,SafeX75(GetLocationX(l)))
      call SetUnitY(Target,SafeY75(GetLocationY(l)))
      call RemoveLocation(l)
      set l=null
    endif
    set tt_unit1=Source
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Target),GetUnitY(Target),350,Condition(function DefaultEnemyFilter))
    call GroupRemoveUnit(g,Target)
    set Rubick_TempInt=LoadInteger(HY,h,0)
    call ForGroup(g,function ARG)
    call KillGroup(g)
    call KillTrees(GetUnitX(Target),GetUnitY(Target),150)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(Target),GetUnitY(Target)))
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call DestroyEffect(LoadEffectHandle(HY,h,176))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    if IsBuggyFlying(Target)==false then
      call SetUnitFlyHeight(Target,GetUnitDefaultFlyHeight(Target),0)
    endif
    call SetUnitPathing(Target,true)
  endif
  set t=null
  set Source=null
  set Target=null
  set g=null
  return false
endfunction

function ATG takes unit Source,unit Target,unit Target2,real AUG,real AVG,effect FX,effect AWG, integer lvl returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local real TargetX=AUG
  local real TargetY=AVG
  local real a=AngleBetweenXY(GetUnitX(Target),GetUnitY(Target),AUG,AVG)*bj_DEGTORAD
  if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),AUG,AVG)>375 then
    set TargetX=GetUnitX(Target)+375*Cos(a)
    set TargetY=GetUnitY(Target)+375*Sin(a)
  endif
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveReal(HY,h,137,a*1.)
  call SaveReal(HY,h,47,TargetX*1.)
  call SaveReal(HY,h,48,TargetY*1.)
  call SaveReal(HY,h,189,GetUnitX(Target)*1.)
  call SaveReal(HY,h,190,GetUnitY(Target)*1.)
  call SaveEffectHandle(HY,h,32,FX)
  call SaveEffectHandle(HY,h,176,AWG)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function ASG))
  set t=null
endfunction

function AXG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Count=LoadInteger(HY,h,34)
  local integer RHE=LoadInteger(HY,h,12)
  local real TargetX=LoadReal(HY,h,47)
  local real TargetY=LoadReal(HY,h,48)
  local integer AYG=LoadInteger(HY,h,706)
  local real a
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or(GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and IsUnitDisabled(Target)==false)then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',true)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',false)
    call ATG(Source,Target,LoadUnitHandle(HY,h,711),TargetX,TargetY,LoadEffectHandle(HY,h,32),LoadEffectHandle(HY,h,176),LoadInteger(HY,h,0))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()=='A27X' then
      call DestroyEffect((LoadEffectHandle(HY,h,(176))))
      set a=AngleBetweenXY(GetUnitX(Target),GetUnitY(Target),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
      if DistanceBetweenXY(GetUnitX(Target),GetUnitY(Target),GetSpellTargetX(),GetSpellTargetY())>375 then
        set TargetX=GetUnitX(Target)+375*Cos(a)
        set TargetY=GetUnitY(Target)+375*Sin(a)
      else
        set TargetX=GetSpellTargetX()
        set TargetY=GetSpellTargetY()
      endif
      call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",TargetX,TargetY))
      call SaveReal(HY,h,47,TargetX*1.)
      call SaveReal(HY,h,48,TargetY*1.)
      call SaveUnitHandle(HY,h,711,GetSpellTargetUnit())
      call SaveEffectHandle(HY,h,176,AddSpecialEffectTarget("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",GetSpellTargetUnit(),"origin"))
    endif
  else
    set Count=Count+1
    call SaveInteger(HY,h,34,Count)
    call SetUnitPathing(Target,false)
    if(LoadInteger(HY,h,707))==1 then
      set AYG=AYG+3
    else
      set AYG=AYG-3
    endif
    call SaveInteger(HY,h,706,AYG)
    if AYG==30 then
      call SaveInteger(HY,h,707,-1)
    elseif AYG==-30 then
      call SaveInteger(HY,h,707,1)
    endif
    if IsBuggyFlying(Target)==false then
      if Count<15 then
        call SetUnitFlyHeight(Target,Count*20,0)
      else
        call SetUnitFlyHeight(Target,300+AYG,0)
      endif
    endif
    if Count>(RHE-25)then
      if IsBuggyFlying(Target)==false then
        call SetUnitFlyHeight(Target,300,0)
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',true)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',false)
      call ATG(Source,Target,LoadUnitHandle(HY,h,711),TargetX,TargetY,LoadEffectHandle(HY,h,32),LoadEffectHandle(HY,h,176),LoadInteger(HY,h,0))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function AZG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer Level=GetUnitAbilityLevel(Source,'A27F')
  local real stundur=1.25+.25*Level
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  set stundur=StunTargetLod(Target,stundur)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27F',false)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A27X',true)
  call UnitAddAbility(Source,'A27X')
  call SetUnitPathing(Target,false)
  if IsBuggyFlying(Target)==false then
    call UnitAddAbility2(Target,'Amrf')
    call UnitRemoveAbility(Target,'Amrf')
  endif
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveUnitHandle(HY,h,711,Target)
  call SaveInteger(HY,h,12,R2I(stundur/ .02))
  call SaveInteger(HY,h,34,0)
  call SaveInteger(HY,h,0,Level)
  call SaveInteger(HY,h,706,0)
  call SaveInteger(HY,h,707,1)
  call SaveReal(HY,h,47,GetUnitX(Target)*1.)
  call SaveReal(HY,h,48,GetUnitY(Target)*1.)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\AntiGravityTarget.mdx",Target,"origin"))
  call SaveEffectHandle(HY,h,176,AddSpecialEffect("Abilities\\Spells\\Other\\GeneralAuraTarget\\GeneralAuraTarget.mdl",GetUnitX(Target),GetUnitY(Target)))
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterDeathEvent(t,Target)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function AXG))
  set Source=null
  set Target=null
  set t=null
  set Caster=null
endfunction

function Rubick_Telekinesis takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call AZG()
  endif
endfunction

function Rubick_Telekinez_Preload takes nothing returns nothing
  call PreloadQueryAdd('A282')
endfunction

function ABG takes unit Source,unit Target, integer lvl returns nothing
  local integer id
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    if lvl==1 then
      set id='A27W'
    elseif lvl==2 then
      set id='A286'
    elseif lvl==3 then
      set id='A285'
    else
      set id='A287'
    endif
  else
    if lvl==1 then
      set id='A291'
    elseif lvl==2 then
      set id='A28Z'
    elseif lvl==3 then
      set id='A292'
    else
      set id='A290'
    endif
  endif
  call AddTimedAbility(Target,id,1,10)
  call PlaySoundAtPos(SF,GetUnitX(Target),GetUnitY(Target))
endfunction

function ACG takes nothing returns nothing
  local real d
  if IsUnitInGroup(GetEnumUnit(),OM8)==false then
    set d=DistanceBetweenUnits(GetEnumUnit(),OK8)
    if d<ON8 then
      set ON8=d
      set OJ8=GetEnumUnit()
    endif
  endif
endfunction

function A3G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local group AlreadyHit=LoadGroupHandle(HY,h,187)
  local real x=GetUnitX(Target)
  local real y=GetUnitY(Target)
  local group g=GetAvailableGroup()
  call GroupAddUnit(AlreadyHit,Target)
  call ABG(Source,Target,LoadInteger(HY,h,0))
  set tt_unit1=Source
  set OJ8=null
  set OK8=Target
  set OM8=AlreadyHit
  set ON8=999999
  call GroupEnumUnitsInRange(g,x,y,465,Condition(function NonImmuneVisibleEnemyFilter))
  call ForGroup(g,function ACG)
  call KillGroup(g)
  if OJ8==null or GetTriggerEvalCount(t)>26 then
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set Target=OJ8
    call SaveUnitHandle(HY,h,17,Target)
  endif
  set g=null
  set t=null
  set Source=null
  set Target=null
  set AlreadyHit=null
  return false
endfunction

function A6G takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local group AlreadyHit=GetAvailableGroup()
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  call PlaySoundAtPos(SF,GetUnitX(Source),GetUnitY(Source))
  call UnitAddAbility2(Caster,'A284')
  call SetUnitAbilityLevel(Caster,'A284',GetUnitAbilityLevel(Source,'A27G'))
  call IssueTargetOrderById(Caster,852119,Target)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveGroupHandle(HY,h,187,AlreadyHit)
  call TriggerRegisterTimerEvent(t,.25,true)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call TriggerAddCondition(t,Condition(function A3G))
  set Source=null
  set Target=null
  set t=null
  set Caster=null
  set AlreadyHit=null
endfunction

function Rubick_Fadebolt takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call A6G()
  endif
endfunction

function A0G takes integer id returns nothing
  set OO8[OP8]=id
  set OP8=OP8+1
endfunction

function A5G takes integer id returns boolean
  local integer i=0
  loop
    exitwhen i==OP8
    if id==OO8[i]then
      return true
    endif
    set i=i+1
  endloop
  return false
endfunction

function A2G takes nothing returns boolean
  local unit u = GetTriggerUnit()
  local integer spell = GetSpellAbilityId()
  local integer info
  
  if IsUnitType(u,UNIT_TYPE_HERO) and A5G(spell)==false and GetUnitAbilityLevel(u,'A04R')==0then
    set info = GetHandleId(u)
    call SaveInteger(HY,info,705,spell)
    call SaveInteger(HY,info,712,GetUnitAbilityLevel(u,spell))
  endif
  
  set u = null
  return false
endfunction

function B4G takes unit u returns nothing
  call UnitRemoveAbility(u,'A13D')
  call UnitRemoveAbility(u,'A21J')
  call UnitRemoveAbility(u,'A1QV')
  call UnitRemoveAbility(u,'A1TU')
  call UnitRemoveAbility(u,'A24A')
  call UnitRemoveAbility(u,'A24B')
  call UnitRemoveAbility(u,'A1NH')
  call UnitRemoveAbility(u,'A20N')
  call UnitRemoveAbility(u,'A1Z2')
  call UnitRemoveAbility(u,'A1Z3')
  call UnitRemoveAbility(u,'A205')
  call UnitRemoveAbility(u,'A1VU')
  call UnitRemoveAbility(u,'A0GC')
  call UnitRemoveAbility(u,'A24E')
  call UnitRemoveAbility(u,'A0RT')
  call UnitRemoveAbility(u,'A1RA')
  call UnitRemoveAbility(u,'A0HA')
  call UnitRemoveAbility(u,'A0SA')
  call UnitRemoveAbility(u,'A121')
  call UnitRemoveAbility(u,'A1WF')
  call UnitRemoveAbility(u,'A02T')
  call UnitRemoveAbility(u,'A1S9')
  call UnitRemoveAbility(u,'A21H')
  call UnitRemoveAbility(u,'A1MN')
  call UnitRemoveAbility(u,'A06K')
  call UnitRemoveAbility(u,'A0NE')
  call UnitRemoveAbility(u,'A0MP')
endfunction

function B7G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer B8G=(LoadInteger(HY,h,(704)))
  local integer W7F=(LoadInteger(HY,h,(713)))
  if B8G==(LoadInteger(HY,(GetHandleId(Source)),(704)))then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif GetTriggerEvalCount(t)>(15-W7F)and IsDead(Source)==false then
    call UnitRemoveAbility(Source,B8G)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Source=null
  return false
endfunction

function B9G takes unit Source,integer B8G,real DRD returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function B7G))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(704),(B8G))
  call SaveInteger(HY,(GetHandleId(Source)),(704),(-1))
  call SaveInteger(HY,h,(713),(R2I((TimerGetElapsed(GlobalTimer))-DRD)))
  set t=null
endfunction

function BDG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer B8G=(LoadInteger(HY,h,(704)))
  local integer Count=(LoadInteger(HY,h,(34)))
  local integer Level=IMaxIF(GetUnitAbilityLevel(Source,'A27H'),GetUnitAbilityLevel(Source,'A30J'))
  local real DRD=(LoadReal(HY,h,(411)))
  if GetTriggerEventId()!=EVENT_UNIT_SPELL_EFFECT and GetTriggerEventId()!=EVENT_WIDGET_DEATH then
    if Count==0 then
      call SaveInteger(HY,h,(34),(1))
      call DisplayTimedTextToPlayer(GetOwningPlayer(Source),0,0,10,"|c00ff0303"+GetObjectName('n0LW')+"|r")
    else
      call B4G(Source)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call B9G(Source,B8G,DRD)
    endif
  elseif GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if (GetSpellAbilityId()=='A27H' or GetSpellAbilityId()=='A30J') then
      call B4G(Source)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      call B9G(Source,B8G,DRD)
    elseif GetSpellAbilityId()==B8G then
      call SaveReal(HY,h,(411),(((TimerGetElapsed(GlobalTimer)))*1.))
    endif
  elseif GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call B4G(Source)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,false)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call B9G(Source,B8G,DRD)
  endif
  set t=null
  set Source=null
  return false
endfunction

function BEG takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer B8G=(LoadInteger(HY,h,(704)))
  local integer Level=(LoadInteger(HY,h,5))
  local real BFG=60*(2+IMaxIF(GetUnitAbilityLevel(Source,'A27H'),GetUnitAbilityLevel(Source,'A30J')))
  local integer id=GetPlayerId(GetOwningPlayer(Source))
  local boolean canSteal=(GetUnitAbilityLevel(Source,B8G)==0)
  local integer i=1
  call PlaySoundAtPos(LF,GetUnitX(Source),GetUnitY(Source))
  loop
    exitwhen i>4+NumberOfExtraAbilities or canSteal==false
    if SkillID[PlayerSkillNumber[id*PlayerSkillOffset+i]]==B8G then
      set canSteal=false
    endif
    if AlternateSkillID[PlayerSkillNumber[id*PlayerSkillOffset+i]]==B8G then
      set canSteal=false
    endif
    set i=i+1
  endloop
  if canSteal then
    if(LoadInteger(HY,(GetHandleId(Target)),(710)))>0 then
      call SaveInteger(HY,(GetHandleId(Source)),(710),((LoadInteger(HY,(GetHandleId(Target)),(710)))))
    endif
    if B8G=='A064' and LoadBoolean(HY,GetHandleId(Source),'A064')==false then
      call ShrapnelInitRechargingForRubick(Source)
    endif
    call TextTagOnUnit(GetObjectName(B8G),3.5,Source,.024,170,0,255,216)
    call SaveInteger(HY,(GetHandleId(Source)),(704),(B8G))
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),B8G,true)
    call UnitAddAbility2(Source,B8G)
    call SetUnitAbilityLevel(Source,B8G,Level)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveInteger(HY,h,(34),(0))
    call SaveInteger(HY,h,(704),(B8G))
    call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
    call TriggerRegisterTimerEvent(t,BFG,false)
    call TriggerRegisterDeathEvent(t,Source)
    call TriggerRegisterTimerEvent(t,BFG-20,false)
    call TriggerAddCondition(t,Condition(function BDG))
  else
    call TextTagOnUnit("Failed ;(",3.5,Source,.024,170,0,255,216)
  endif
  set t=null
  set Source=null
  set Target=null
endfunction

function BGG takes unit Source,unit Target,integer B8G,integer Level returns nothing
  local trigger t=AddProjectile(Target,Source,'h0DB',"BEG",900,false)
  local integer h=GetHandleId(t)
  call PlaySoundAtPos(KF,GetUnitX(Target),GetUnitY(Target))
  call TextTagOnUnit(GetObjectName(B8G),3.75,Target,.024,170,0,255,216)
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,(704),(B8G))
  call SaveInteger(HY,h,5,(Level))
  set t=null
endfunction

function GetAghaVersion takes integer id returns integer
  local integer i=1
  loop
    exitwhen i>AghaCounter
    if id==AghaUpgradedSpellID[i] or id==AghaBaseSpellID[i]  then
      return i
    endif
    
    set i=i+1
  endloop
  return 0
endfunction

function BIG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  
  local integer id=LoadInteger(HY,(GetHandleId(Target)),(705))
  local boolean b=GetSpellAbilityId()=='A30J'
  if(id)!=0 then
    if b then//upgraded
      if GetAghaVersion(id)>0 and AghaUpgradedSpellID[GetAghaVersion(id)]>0 then
        set id=AghaUpgradedSpellID[GetAghaVersion(id)]
      endif
    else
      if GetAghaVersion(id)>0 and AghaBaseSpellID[GetAghaVersion(id)]>0 then
        set id=AghaBaseSpellID[GetAghaVersion(id)]
      endif
    endif
    call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Nebula.mdx",Target,"origin"))
    call BGG(Source,Target,id,LoadInteger(HY,GetHandleId(Target),712))
  endif
  set Source=null
  set Target=null
endfunction

function Rubick_SpellSteal takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call BIG()
  endif
endfunction

function BKG takes nothing returns nothing
  call A0G('A0WP')
  call A0G('A43D')
  call A0G('ANcr')
  call A0G('QB0K')
  call A0G('A03G')
  call A0G('QM00')
  call A0G('A093')
  call A0G('QM02')
  call A0G('QM03')
  call A0G('A0AG')
  call A0G('A0BE')
  call A0G('A1TX')
  call A0G('A229')
  call A0G('A1RI')
  call A0G('A1C0')
  call A0G('A418')
  
  call A0G('A11T')
  call A0G('QM01')
  call A0G('QM04')
  call A0G('A13D')
  call A0G('A21J')
  call A0G('A1QV')
  call A0G('A1TU')
  call A0G('A2O2')
  call A0G('A24A')
  call A0G('A24B')
  call A0G('A1NH')
  call A0G('A20N')
  call A0G('A1Z2')
  call A0G('A1Z3')
  call A0G('A205')
  call A0G('A1VU')
  call A0G('A0GC')
  call A0G('A24E')
  call A0G('A0RT')
  call A0G('A1RA')
  call A0G('A0HA')
  call A0G('A0SA')
  call A0G('A121')
  call A0G('A1WF')
  call A0G('A02T')
  call A0G('A1S9')
  call A0G('A21H')
  call A0G('A1MN')
  call A0G('A0KX')
  call A0G('A0KW')
  call A0G('A0A5')
  call A0G('A0BG')
  call A0G('Z234')
  call A0G('A32D')
  call A0G('A1VH')
  call A0G('A1VG')
  call A0G('A026')
  call A0G('AHfa')
  call A0G('A09V')
  call A0G('A0DY')
  call A0G('A1WB')
  call A0G('A0LZ')
  call A0G('A0OI')
  call A0G('A1NA')
  call A0G('A1EA')
  call A0G('QB03')
  call A0G('A0NS')
  call A0G('A1DA')
  call A0G('A28Q')
  call A0G('A0WQ')
  call A0G('A1T8')
  call A0G('A10R')
  call A0G('A11N')
  call A0G('A0EY')
  call A0G('A0FH')
  call A0G('A073')
  call A0G('A03J')
  call A0G('A0ES')
  call A0G('A04J')
  call A0G('A04M')
  call A0G('A04N')
  call A0G('A27F')
  call A0G('A27X')
  call A0G('A27G')
  
  call A0G('A27H')
  call A0G('A30J')
  
  call A0G('A0Q5')
  call A0G('A0TK')
  call A0G('AIbk')
  call A0G('A0JY')
  call A0G('A1WA')
  call A0G('A1AC')
  call A0G('AIpl')
  call A0G('AIpr')
  call A0G('Aeat')
  call A0G('ANTG')
  call A0G('ANLS')
  call A0G('A0K0')
  call A0G('A0H7')
  call A0G('A0H6')
  call A0G('A0FO')
  call A0G('A02X')
  call A0G('AIsw')
  call A0G('AItb')
  call A0G('A0B6')
  call A0G('A1R5')
  call A0G('A206')
  call A0G('A1FD')
  call A0G('A1FO')
  call A0G('A1FQ')
  call A0G('A1IO')
  call A0G('A0B8')
  call A0G('A1WE')
  call A0G('A0T8')
  call A0G('A0T7')
  call A0G('A017')
  call A0G('A1QD')
  call A0G('A1FP')
  call A0G('A0JL')
  call A0G('ACch')
  call A0G('AIxk')
  call A0G('AIpg')
  call A0G('A11F')
  call A0G('A11E')
  call A0G('A0S3')
  call A0G('A11D')
  call A0G('A11G')
  call A0G('A11H')
  call A0G('A2LI')
  call A0G('A0T9')
  call A0G('A15W')
  call A0G('AChx')
  call A0G('A0FD')
  call A0G('A0TE')
  call A0G('A1T7')
  call A0G('A19M')
  call A0G('A02O')
  call A0G('A08Y')
  call A0G('A08Z')
  call A0G('A090')
  call A0G('A092')
  call A0G('A0HB')
  call A0G('A0D3')
  call A0G('A0DF')
  call A0G('A02W')
  call A0G('A0CK')
  call A0G('A0K7')
  call A0G('A0JT')
  call A0G('AIda')
  call A0G('A269')
  call A0G('A1WO')
  call A0G('A1EW')
  call A0G('A1MO')
  call A0G('A1ZI')
  call A0G('A1ZH')
  call A0G('A1ZW')
  call A0G('A231')
  call A0G('A12W')
  call A0G('A14A')
  call A0G('A1Q8')
  call A0G('A28Y')
  call A0G('A28D')
  call A0G('A28F')
  call A0G('A2JO')
  call A0G('A2JQ')
  call A0G('A2JP')
  call A0G('A2JR')
  call A0G('A2JL')
  call A0G('A2FX')
  call A0G('A43P')
  call A0G('A2K1')
  call A0G('A2K4')
  call A0G('A2K7')
  call A0G('A2KG')
  call A0G('A2KE')
  call A0G('A2KH')
  call A0G('A2K9')
  call A0G('A2EA')
  call A0G('A2N1') // shadow amulet
endfunction

function Rubick_SpellSteal_Init takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function A2G))
  set t=null
  call BKG()
endfunction

function BMG takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A27S')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A27S')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A27Q')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A27Q')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A27R')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A27R')
  endif
  if GetUnitAbilityLevel(GetEnumUnit(),'A27T')>0 then
    call UnitRemoveAbility(GetEnumUnit(),'A27T')
  endif
endfunction

function BNG takes nothing returns nothing
  if IsUnitBADWithSpellbooks(GetEnumUnit())then
    return
  endif
  if OQ8==1 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A27S')==0 then
      call UnitAddAbility2(GetEnumUnit(),'A27S')
    endif
  elseif OQ8==2 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A27Q')==0 then
      call UnitRemoveAbility(GetEnumUnit(),'A27S')
      call UnitAddAbility2(GetEnumUnit(),'A27Q')
    endif
  elseif OQ8==3 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A27R')==0 then
      call UnitRemoveAbility(GetEnumUnit(),'A27S')
      call UnitRemoveAbility(GetEnumUnit(),'A27Q')
      call UnitAddAbility2(GetEnumUnit(),'A27R')
    endif
  elseif OQ8==4 then
    if GetUnitAbilityLevel(GetEnumUnit(),'A27T')==0 then
      call UnitRemoveAbility(GetEnumUnit(),'A27S')
      call UnitRemoveAbility(GetEnumUnit(),'A27Q')
      call UnitRemoveAbility(GetEnumUnit(),'A27R')
      call UnitAddAbility2(GetEnumUnit(),'A27T')
    endif
  endif
endfunction

function BOG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local group GGF=(LoadGroupHandle(HY,h,(340)))
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local group g=GetAvailableGroup()
  if Source==null or GetUnitTypeId(Source)!='E02X' then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call ForGroup(GGF,function BMG)
    call KillGroup(GGF)
    call KillGroup(g)
    return false
  endif
  set tt_unit1=Source
  set OQ8=GetUnitAbilityLevel(Source,'P211')
  if IsDead(Source)==false then
    call GroupEnumUnitsInRange(g,x,y,925,Condition(function D79))
  endif
  call GroupRemoveGroup(g,GGF)
  call ForGroup(GGF,function BMG)
  if IsDead(Source)==false then
    call ForGroup(g,function BNG)
  endif
  call SaveGroupHandle(HY,h,(340),(g))
  call KillGroup(GGF)
  set t=null
  set Source=null
  set GGF=null
  set g=null
  return false
endfunction

function Rubick_NullField_Learn takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  call TriggerRegisterTimerEvent(t,.3,true)
  call TriggerAddCondition(t,Condition(function BOG))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveGroupHandle(HY,h,(340),(GetAvailableGroup()))
  set t=null
  set Source=null
endfunction

function Exorcism_MoveDummy takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit hero=LoadUnitHandle(HY,h,1)
  local unit d=LoadUnitHandle(HY,h,0)
  local real lastlife=LoadReal(HY,h,0)
  local integer c=LoadInteger(HY,h,0)+1
  if IsDead(hero) and LoadBoolean(HY,h,0)==false then
    call SaveBoolean(HY,h,0,true)
  endif
  if LoadBoolean(HY,h,0)==false then
    call SetUnitPosition(d,GetUnitX(hero),GetUnitY(hero))
    if GetWidgetLife(d)>lastlife then
      call SetWidgetLife(hero,GetWidgetLife(hero)+(GetWidgetLife(d)-lastlife))
      call SaveReal(HY,h,0,GetWidgetLife(d))
    endif
  endif
  if c>50*50 or IsDead(hero) or IsDead(d) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
    call KillUnit(d)
  else
    call SaveInteger(HY,h,0,c)
  endif
  set d=null
  set hero=null
  set t=null
endfunction

function Banshee_Exorcism takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local unit d=CreateUnit(GetOwningPlayer(u),'e01V',GetUnitX(u),GetUnitY(u),0)
  local timer t=CreateTimer()
  call KillUnit(LoadUnitHandle(HY,GetHandleId(u),'EXOR'))
  call UnitAddAbility2(d,'A44C')
  call SetUnitAbilityLevel(d,'A44C',GetUnitAbilityLevel(u,GetSpellAbilityId()))
  call IssueImmediateOrder(d,"locustswarm")
  call SetWidgetLife(d,1)
  call TimerStart(t,0.02,true,function Exorcism_MoveDummy)
  call SaveUnitHandle(HY,GetHandleId(t),0,d)
  call SaveUnitHandle(HY,GetHandleId(t),1,u)
  call SaveReal(HY,GetHandleId(t),0,1)
  call SaveUnitHandle(HY,GetHandleId(u),'EXOR',d)
  set t=null
  set u=null
  set d=null
endfunction

function StormModel_Death takes unit u returns nothing
  if GetUnitTypeId(u)=='H00S' then
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",u,"origin"))
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",u,"origin"))
  endif
endfunction

function BBG takes nothing returns nothing
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedDamage.mdl",GetEnumUnit(),"chest"))
  call DamageTarget(OR8,GetEnumUnit(),1,(20+10*OS8)/ 5)
endfunction

function BCG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer Level=LoadInteger(HY,h,0)
  local group g
  if GetUnitAbilityLevel(Source,'B0FP')==0 and GetUnitAbilityLevel(Source,'B0FQ')==0 then
    call DestroyEffect(LoadEffectHandle(HY,h,32))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call UnitRemoveAbility(Source,'A2H7')
    call UnitRemoveAbility(Source,'B0FO')
    call UnitRemoveAbility(Source,'A2IX')
    call UnitRemoveAbility(Source,'A2IW')
    call UnitRemoveAbility(Source,'A2IV')
    call UnitRemoveAbility(Source,'A2IY')
  else
    set tt_unit1=Source
    set OR8=Source
    set OS8=Level
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),400+25,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function BBG)
    call KillGroup(g)
  endif
  set g=null
  set t=null
  set Source=null
  return false
endfunction

function Xin_FlameGuard takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Source),GetUnitY(Source),0)
  local integer Level=GetUnitAbilityLevel(Source,'A2HS')
  call UnitAddAbility(Caster,'A2H5')
  call SetUnitAbilityLevel(Caster,'A2H5',Level)
  call IssueTargetOrderById(Caster,852186,Source)
  call TriggerRegisterTimerEvent(t,.2,true)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  call TriggerAddCondition(t,Condition(function BCG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveEffectHandle(HY,h,32,AddSpecialEffectTarget("war3mapImported\\FlameGuard.mdx",Source,"origin"))
  set Source=null
  set Caster=null
  set t=null
endfunction

function SoF_HexDispelling takes unit Source returns nothing
  call UnitRemoveAbility(Source,'BOhx')
  call UnitRemoveAbility(Source,'B00H')
endfunction

function SoF_CustomBuffRemoval takes unit Source returns nothing
  call UnitRemoveAbility(Source,'A2H9')
  call UnitRemoveAbility(Source,'B0FM')
endfunction

function SoF_BonusDmgRemoval takes unit Source returns nothing
  call UnitRemoveAbility(Source,'A2JH')
  call UnitRemoveAbility(Source,'A2JG')
  call UnitRemoveAbility(Source,'A2JJ')
  call UnitRemoveAbility(Source,'A2JI')
  call UnitRemoveAbility(Source,'B0FL')
endfunction

function SleithOfFistGrow takes unit Source returns nothing
  local integer pid=GetPlayerId(GetOwningPlayer(Source))
  local boolean isranged
  local integer lvl
  if GetUnitAbilityLevel(Source,'A0CY')>0 or GetUnitAbilityLevel(Source,'QP1K')>0 then
    set isranged=IsRangedUnit(Source,pid*PlayerSkillOffset)
    if GetUnitAbilityLevel(Source,'A0CY')>0 then
      set lvl=GetUnitAbilityLevel(Source,'A0CY')
    elseif GetUnitAbilityLevel(Source,'QP1K')>0 then
      set lvl=GetUnitAbilityLevel(Source,'QP1K')
    endif
    if isranged==false then
      call UnitAddAbility2(Source,'QF90'-1+lvl)
    else
      call UnitAddAbility2(Source,'QF92'+lvl)
    endif
  endif
  
endfunction

function B5G takes unit Source returns nothing
  call UnitAddAbility2(Source,'A2H9')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2H9',false)
endfunction

function B2G takes unit Source, integer Level returns nothing
  if Level<1 then
    return
  endif
  if Level==1 then
    call UnitAddAbility2(Source,'A2JH')
  elseif Level==2 then
    call UnitAddAbility2(Source,'A2JG')
  elseif Level==3 then
    call UnitAddAbility2(Source,'A2JJ')
  else
    call UnitAddAbility2(Source,'A2JI')
  endif
endfunction

function SleightOfFistCheck takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit xin=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  local group g=LoadGroupHandle(HY,h,2)
  local group gg=LoadGroupHandle(HY,h,3)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if GetEventDamageSource()==xin and IsFakeDamage==false then
      call GroupAddUnit(g,target)
      call GroupRemoveUnit(gg,target)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    endif
  else
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set xin=null
  set target=null
  set t=null
endfunction

function SoF_Jumping takes unit xin,unit target, integer lvl returns nothing
  local real a=GetRandomReal(0,360)
  local real x=GetUnitX(target)+50*Cos(a*bj_DEGTORAD)
  local real y=GetUnitY(target)+50*Sin(a*bj_DEGTORAD)
  local trigger t
  local integer h
  call SetUnitPosition(xin,x,y)
  call SetUnitFacing(xin,bj_RADTODEG*Atan2(GetUnitY(target)-GetUnitY(xin),GetUnitX(target)-GetUnitX(xin)))
  call SetUnitAnimation(xin,"Attack")
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\Fire_Blink_2.mdx",xin,"chest"))
  call SoF_BonusDmgRemoval(xin)
  if IsUnitType(target,UNIT_TYPE_HERO) or IsUnitIllusion(target) then
    call B2G(xin,lvl)
    call echo(I2S(lvl))
    call UnitRemoveAbility(xin,'A2JF')
    if Mode_EB then
      if(GetUnitAbilityLevel(xin,'A1J2')>0) then
        call SetUnitAbilityLevel(xin,'A1J2',2)
      elseif(GetUnitAbilityLevel(xin,'A1IT')>0) then
        call SetUnitAbilityLevel(xin,'A1IT',2)
      elseif(GetUnitAbilityLevel(xin,'A1J1')>0) then
        call SetUnitAbilityLevel(xin,'A1J1',2)
      elseif(GetUnitAbilityLevel(xin,'A1J0')>0) then
        call SetUnitAbilityLevel(xin,'A1J0',2)
      endif
    endif
  else
    call UnitAddAbility2(xin,'A2JF')
    call SetPlayerAbilityAvailable2(GetOwningPlayer(xin),'A2JF',false)
  endif
  if IssueTargetOrder(xin,"attack",target)then
    set t=CreateTrigger()
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(t,0.2,false)
    call TriggerAddCondition(t,Condition(function SleightOfFistCheck))
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,0,xin)
    call SaveUnitHandle(HY,h,1,target)
    call SaveGroupHandle(HY,h,2,LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),187))
    call SaveGroupHandle(HY,h,3,LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),22))
    set t=null
  else
    call GroupAddUnit(LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),187),target)
    call GroupRemoveUnit(LoadGroupHandle(HY,GetHandleId(GetTriggeringTrigger()),22),target)
  endif
  //call IssueTargetOrderById(xin,851983,target)
endfunction

function C7G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local real x=LoadReal(HY,h,6)
  local real y=LoadReal(HY,h,7)
  local real SourceX=LoadReal(HY,h,189)
  local real SourceY=LoadReal(HY,h,190)
  local group AlreadyHit=LoadGroupHandle(HY,h,187)
  local group g=LoadGroupHandle(HY,h,22)
  local unit Target=null
  local boolean found=false
  local fogmodifier fm=LoadFogModifierHandle(HY,h,42)
  local integer Level=LoadInteger(HY,h,0)// GetUnitAbilityLevel(Source,'A2H0')
  local trigger tt
  //	if Level<1 then
  //		set Level=GetUnitAbilityLevel(Source,'QB0L')
  //	endif
  loop
    exitwhen FirstOfGroup(g)==null or found
    set Target=FirstOfGroup(g)
    call GroupRemoveUnit(g,Target)
    if IsUnitInGroup(Target,AlreadyHit)and Target!=null then
      set Target=null
      set found=false
    else
      set found=true
    endif
  endloop
  call SetUnitPathing(Source,false)
  call SetUnitInvulnerable(Source,true)
  call SoF_RemoveDisables(Source)
  if found==false or (LoadInteger(HY,GetHandleId(Source),4319))==1 then
    call SaveInteger(HY,GetHandleId(Source),4318,2)
    call SoF_CustomBuffRemoval(Source)
    call UnitRemoveAbility(Source,'QF90')
    call UnitRemoveAbility(Source,'QF91')
    call UnitRemoveAbility(Source,'QF92')
    call UnitRemoveAbility(Source,'QF93')
    call UnitRemoveAbility(Source,'QF94')
    call UnitRemoveAbility(Source,'QF95')
    call UnitRemoveAbility(Source,'A2JF')
    call SoF_BonusDmgRemoval(Source)
    call SoF_RemoveDisables(Source)
    call SoF_HexDispelling(Source)
    call UnitAddAbility(Source,'A2H2')
    call UnitRemoveAbility(Source,'A2H2')
    call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1UL',true)
    call UnMorphUnit(Source,LoadInteger(HY,h,25))
    call RemoveAbilsForUnit(Source)
    call SoF_RemoveDisables(Source)
    if((LoadInteger(HY,(GetHandleId((Source))),((4319))))==1)==false then
      call SetUnitX(Source,SourceX)
      call SetUnitY(Source,SourceY)
    endif
    call RestoreTint(Source)
    call SetTint(Source,-1,-1,-1,255)
    call SetUnitPathing(Source,true)
    call SetUnitInvulnerable(Source,false)
    if GetUnitAbilityLevel(Source,'A0MQ')+GetUnitAbilityLevel(Source,'A1B6')>0 then
      call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A0MQ',true)
      call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1B6',true)
    endif
    call SetUnitTimeScale(Source,1)
    call KillGroup(AlreadyHit)
    call KillGroup(g)
    call RemoveUnit((LoadUnitHandle(HY,h,(19))))
    call FogModifierStop(fm)
    call DestroyFogModifier(fm)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call GroupAddUnit(AlreadyHit,Target)
    call SoF_Jumping(Source,Target,Level)
  endif
  set fm=null
  set t=null
  set Source=null
  set Target=null
  set g=null
  set tt=null
  set AlreadyHit=null
  return false
endfunction

function Xin_SleightOfFist takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,0)
  local real x=LoadReal(HY,h,1)
  local real y=LoadReal(HY,h,2)
  local integer Level=LoadInteger(HY,h,0)
  local trigger tt=CreateTrigger()
  local integer th=GetHandleId(tt)
  local fogmodifier fm=CreateFogModifierRadius(GetOwningPlayer(Source),FOG_OF_WAR_VISIBLE,x,y,600,true,true)
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'h0E7',GetUnitX(Source),GetUnitY(Source),GetUnitFacing(Source))
  local group g=GetAvailableGroup()
  local integer id=W28(GetUnitTypeId(Source))
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  if Mode_EB then
    call SleithOfFistGrow(Source)
  endif
  call UnitRemoveAbility(Source,'B01N')
  call UnitRemoveAbility(Source,'Aetl')
  call SetUnitVertexColor(Caster,255,255,255,100)
  call FogModifierStart(fm)
  call SaveInteger(HY,GetHandleId(Source),4318,1)
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,150+100*Level+25,Condition(function LZ8))
  call SoF_RemoveDisables(Source)
  call SoF_HexDispelling(Source)
  if GetUnitAbilityLevel(Source,'A0MQ')+GetUnitAbilityLevel(Source,'A1B6')>0 then//ban primal split, else - spirits + hero comeback together (bug-abuse)
    call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A0MQ',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1B6',false)
  endif
  call SetPlayerAbilityAvailable(GetOwningPlayer(Source),'A1UL',false)
  call SaveInteger(HY,th,25,MorphUnit(Source)+1)
  call UnitAddAbility(Source,'A2H1')
  call UnitRemoveAbility(Source,'A2H1')
  call RemoveAbilsForUnit(Source)
  call SetTint(Source,-1,-1,-1,125)
  call SetUnitPathing(Source,false)
  call SetUnitInvulnerable(Source,true)
  call SetUnitTimeScale(Source,3)
  call TriggerRegisterTimerEvent(tt,.2,true)
  call TriggerAddCondition(tt,Condition(function C7G))
  call SaveUnitHandle(HY,th,2,Source)
  call SaveInteger(HY,th,0,Level)
  call SaveReal(HY,th,6,x*1.)
  call SaveReal(HY,th,7,y*1.)
  call SaveReal(HY,th,189,GetUnitX(Source)*1.)
  call SaveReal(HY,th,190,GetUnitY(Source)*1.)
  call SaveGroupHandle(HY,th,187,GetAvailableGroup())
  call SaveGroupHandle(HY,th,22,g)
  call SaveFogModifierHandle(HY,th,42,fm)
  call SaveUnitHandle(HY,th,19,Caster)
  call B5G(Source)
  call TriggerEvaluate(tt)
  set Source=null
  set t=null
  set fm=null
  set Caster=null
  set g=null
  set tt=null
endfunction

function Xin_SleightOfFistWrap takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local integer lvl=GetUnitAbilityLevel(u,'A2H0')+GetUnitAbilityLevel(u,'QB0L')
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,0,u)
  call SaveReal(HY,h,1,x)
  call SaveReal(HY,h,2,y)
  call SaveInteger(HY,h,0,lvl)
  call TimerStart(t,0,false,function Xin_SleightOfFist)
  set t=null
  set u=null
endfunction

function CDG takes nothing returns boolean
  local unit W39=GetSummonedUnit()
  if IsUnitIllusion(W39) and GetUnitTypeId(W39)=='N0MH' then
    call SoF_CustomBuffRemoval(W39)
    call UnitRemoveAbility(W39,'A2JF')
    call SoF_BonusDmgRemoval(W39)
    call UnitAddAbility(W39,'A2H2')
    call UnitRemoveAbility(W39,'A2H2')
  endif
  set W39=null
  return false
endfunction

function SleightOfFistAbuseStop takes nothing returns nothing
  if GetUnitAbilityLevel(GetTriggerUnit(),'Aetl')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B01N')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B15V')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'Abun')>0 or GetUnitAbilityLevel(GetTriggerUnit(),'B08Y')>0 then
    call InterruptUnit(GetTriggerUnit())
    call Error(GetOwningPlayer(GetTriggerUnit()),"Cannot use this now.")
  endif
endfunction

function Xin_SleightOfFist_Illusions takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddCondition(t,Condition(function CDG))
  set t=null
endfunction

function CEG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer Level=LoadInteger(HY,h,0)
  local integer RHE=2
  if Level>2 then
    set RHE=3
  endif
  if GetTriggerEvalCount(t)==RHE then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  call DamageTarget(Source,Target,1,20+20*Level)
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function CFG takes nothing returns nothing
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local unit Caster=CreateUnit(GetOwningPlayer(Target),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer lvl=LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),0)
  call UnitAddAbility(Caster,'A2H4')
  call IssueTargetOrderById(Caster,852106,Target)
  call TriggerAddCondition(t,Condition(function CEG))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,0,false)
  call TriggerRegisterTimerEvent(t,1,true)
  set Caster=null
  set Source=null
  set Target=null
  set t=null
endfunction

function Xin_SearingChains takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local real x=GetUnitX(Source)
  local real y=GetUnitY(Source)
  local unit u1=null
  local unit u2=null
  local unit u3=null
  local integer AUD=0
  local unit u
  local trigger t
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,x,y,425,Condition(function NonImmuneVisibleEnemyFilter))
  loop
    exitwhen FirstOfGroup(g)==null or AUD==2
    set u=GroupPickRandomUnit(g)
    if u!=null then
      if AUD==0 then
        set u1=u
      elseif AUD==1 then
        set u2=u
      elseif AUD==2 then
        set u3=u
      endif
      set AUD=AUD+1
      call GroupRemoveUnit(g,u)
    endif
  endloop
  call KillGroup(g)
  if u1!=null then
    set t=AddProjectile(Source,u1,'h0E0',"CFG",9000,false)
    call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  endif
  if u2!=null then
    set t=AddProjectile(Source,u2,'h0E0',"CFG",9000,false)
    call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  endif
  if u3!=null then
    set t=AddProjectile(Source,u3,'h0E0',"CFG",9000,false)
    call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
  endif
  set g=null
  set Source=null
  set u=null
  set u1=null
  set u2=null
  set u3=null
  set t=null
endfunction

function CIG takes nothing returns boolean
  local unit Source=(LoadUnitHandle(HY,(GetHandleId(GetTriggeringTrigger())),2))
  local integer h=GetHandleId(Source)
  local integer i=0
  local real UK8=(TimerGetElapsed(GlobalTimer))
  local integer CJG=(LoadInteger(HY,h,(749)))
  local real x
  local real y
  local real t
  loop
    exitwhen i>CJG
    set t=(LoadReal(HY,h,(10000+i)))
    if t+10>UK8 then
      set x=(LoadReal(HY,h,(11000+i)))
      set y=(LoadReal(HY,h,(12000+i)))
    endif
    set i=i+1
  endloop
  set Source=null
  return false
endfunction

function CKG takes integer h,integer CJG,real AO8,real AP8 returns boolean
  local real x
  local real y
  local real t
  local integer i=0
  local real UK8=(TimerGetElapsed(GlobalTimer))
  loop
    exitwhen i>CJG
    set t=(LoadReal(HY,h,(10000+i)))
    if t+10>UK8 then
      set x=(LoadReal(HY,h,(11000+i)))
      set y=(LoadReal(HY,h,(12000+i)))
      if DistanceBetweenXY(x,y,AO8,AP8)<75 then
        return true
      endif
    endif
    set i=i+1
  endloop
  return false
endfunction

function CMG takes integer h,integer CJG returns integer
  local real t
  local integer i=0
  local real UK8=(TimerGetElapsed(GlobalTimer))
  loop
    exitwhen i>CJG
    set t=(LoadReal(HY,h,(10000+i)))
    if t+10<UK8 then
      return i
    endif
    set i=i+1
  endloop
  return-1
endfunction

function CNG takes unit Source,integer COG,real x,real y returns nothing
  local integer h=GetHandleId(Source)
  local integer CJG=(LoadInteger(HY,h,(749)))
  local integer CPG
  if CKG(h,CJG,x,y)then
    return
  endif
  set CPG=CMG(h,CJG)
  if CPG==-1 then
    set CPG=CJG
    set CJG=CJG+1
    call SaveInteger(HY,h,(749),(CJG))
  endif
  call SaveInteger(HY,h,(13000),(COG))
  call SaveReal(HY,h,(10000),(((TimerGetElapsed(GlobalTimer)))*1.))
  call SaveReal(HY,h,(11000),((x)*1.))
  call SaveReal(HY,h,(11000),((y)*1.))
endfunction

function CQG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function CIG))
  call SaveUnitHandle(HY,h,2,(Source))
  set Source=null
  set t=null
endfunction

function CRG takes nothing returns nothing
  call DamageTarget(OU8,GetEnumUnit(),1,50+OT8*50)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\LordofFlameMissile\\LordofFlameMissile.mdl",GetEnumUnit(),"origin"))
endfunction

function CSG takes unit Source,unit S4E,real x,real y returns nothing
  local group g
  call KillUnit(S4E)
  call ZD8("war3mapImported\\Firaga_2.mdx",x,y,2)
  set g=GetAvailableGroup()
  set tt_unit1=Source
  set OU8=Source
  set OT8=GetUnitAbilityLevel(Source,'A2JK')
  call GroupEnumUnitsInRange(g,x,y,450+25,Condition(function DefaultEnemyFilter))
  call UnitRemoveAbility(Source,'A04R')
  call ForGroup(g,function CRG)
  call UnitAddAbility2(Source,'A04R')
  call KillGroup(g)
  set g=null
endfunction

function CTG takes unit Source,unit CUG returns nothing
  local integer h=GetHandleId(Source)
  local integer CVG=(LoadInteger(HY,h,(746)))
  local unit CWG
  local integer i=1
  local integer x
  loop
    exitwhen i>CVG
    set CWG=(LoadUnitHandle(HY,h,(1450+i)))
    if CWG==CUG then
      set CVG=CVG-1
      call SaveUnitHandle(HY,h,(1450+i),((LoadUnitHandle(HY,h,(1450+i+1)))))
      call SaveInteger(HY,h,(746),(CVG))
      set x=i+1
      loop
        exitwhen x>CVG
        call SaveUnitHandle(HY,h,(1450+x),((LoadUnitHandle(HY,h,(1450+x+1)))))
        set x=x+1
      endloop
    endif
    set i=i+1
  endloop
  set CWG=null
endfunction

function CXG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit S4E=(LoadUnitHandle(HY,h,(19)))
  local real NHE=GetUnitX(S4E)
  local real NIE=GetUnitY(S4E)
  local real TargetX=(LoadReal(HY,h,(47)))
  local real TargetY=(LoadReal(HY,h,(48)))
  local real a=AngleBetweenXY(NHE,NIE,TargetX,TargetY)*bj_DEGTORAD
  local real AO8
  local real AP8
  local real d=DistanceBetweenXY(NHE,NIE,TargetX,TargetY)
  local real rate=GetUnitMoveSpeedLOD(Source)*2.5*.02
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call CTG(Source,S4E)
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif d<2 then
    call SetUnitAnimationByIndex(S4E,1)
  else
    if d<rate then
      set AO8=TargetX
      set AP8=TargetY
    else
      set AO8=NHE+rate*Cos(a)
      set AP8=NIE+rate*Sin(a)
    endif
    call SetUnitX(S4E,AO8)
    call SetUnitY(S4E,AP8)
  endif
  set t=null
  set Source=null
  set S4E=null
  return false
endfunction

function CYG takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),GetSpellTargetX(),GetSpellTargetY())*bj_DEGTORAD
  local integer h=GetHandleId(Source)
  local integer CVG=(LoadInteger(HY,h,(746)))
  local integer Level=GetUnitAbilityLevel(Source,'A2JK')
  local unit d=CreateUnit(GetOwningPlayer(Source),'h0E8',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  local trigger t
  local integer i=1
  set CVG=CVG+1
  call SaveUnitHandle(HY,h,(1450+CVG),(d))
  call SaveInteger(HY,h,(746),(CVG))
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SetUnitVertexColor(d,255,255,255,75)
  call SetUnitTimeScale(d,2)
  call SetUnitAnimationByIndex(d,0)
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerAddCondition(t,Condition(function CXG))
  call TriggerRegisterDeathEvent(t,d)
  call UnitApplyTimedLife(d,'BTLF',45)
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",d,"hand right alternate")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",d,"hand left alternate")))
  call SaveEffectHandle(HY,h,(177),(AddSpecialEffectTarget("war3mapImported\\FlameDash_Ground.mdx",d,"origin")))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,(19),(d))
  call SaveReal(HY,h,(47),SafeX50((GetSpellTargetX())*1.))
  call SaveReal(HY,h,(48),SafeY50((GetSpellTargetY())*1.))
  set Source=null
  set t=null
  set d=null
endfunction

function Xin_FireRemnants takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local integer HTD=(LoadInteger(HY,(GetHandleId(Source)),(747)))
  if HTD>0 then
    call CYG()
    call UnitRemoveAbility(Source,OZ8[HTD])
    set HTD=HTD-1
    call SaveInteger(HY,(GetHandleId(Source)),(747),(HTD))
    call UnitAddAbility2(Source,OZ8[HTD])
  else
    call Error(GetOwningPlayer(GetTriggerUnit()),"No more charges")
  endif
  set Source=null
endfunction

function CBG takes nothing returns boolean
  return GetUnitTypeId(GetFilterUnit())=='h0E8'
endfunction

function CCG takes nothing returns nothing
  local real YR8=DistanceBetweenXY(GetUnitX(GetEnumUnit()),GetUnitY(GetEnumUnit()),OV8,OW8)
  if YR8>OX8 and IsDead(GetEnumUnit())==false then
    set OY8=GetEnumUnit()
    set OX8=YR8
  endif
endfunction

function C3G takes unit Source,real x,real y returns unit
  local group g=GetAvailableGroup()
  set OY8=null
  set OX8=-1
  set OV8=x
  set OW8=y
  call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(Source),Condition(function CBG))
  call ForGroup(g,function CCG)
  call KillGroup(g)
  set g=null
  return OY8
endfunction

function C6G takes unit u1,unit u2 returns real
  local real TAE=DistanceBetweenUnits(u1,u2)
  local real time=TAE/ 1300.
  if time>.4 then
    return TAE/.4
  endif
  return 1300.
endfunction

function CLG takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real I1G=(LoadReal(HY,h,(47)))
  local real I0G=(LoadReal(HY,h,(48)))
  local unit S4E=(LoadUnitHandle(HY,h,(19)))
  local real NHE=GetUnitX(Source)
  local real NIE=GetUnitY(Source)
  local real TargetX=(LoadReal(HY,h,6))
  local real TargetY=(LoadReal(HY,h,7))
  local real a
  local real AO8
  local real AP8
  local real d
  local real AJ8=(LoadReal(HY,h,(44)))
  local real rate=AJ8*.02
  local group g
  local integer Count=(LoadInteger(HY,h,(34)))
  if S4E!=null then
    set TargetX=GetUnitX(S4E)
    set TargetY=GetUnitY(S4E)
    call SaveReal(HY,h,6,((TargetX)*1.))
    call SaveReal(HY,h,7,((TargetY)*1.))
  endif
  set a=AngleBetweenXY(NHE,NIE,TargetX,TargetY)*bj_DEGTORAD
  set d=DistanceBetweenXY(NHE,NIE,TargetX,TargetY)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call SaveInteger(HY,GetHandleId(Source),4319,2)
    call RestoreTint(Source)
    call SetTint(Source,-1,-1,-1,255)
    call SetUnitTimeScale(Source,1)
    call SetUnitAnimationByIndex(Source,0)
    call SetUnitPathing(Source,true)
    call SetUnitInvulnerable(Source,false)
    call UnitRemoveAbility(Source,'A04R')
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call DestroyEffect((LoadEffectHandle(HY,h,(177))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif d<rate then
    call SetUnitX(Source,TargetX)
    call SetUnitY(Source,(TargetY))
    call KillTrees(TargetX,TargetY,100)
    call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    call CSG(Source,S4E,TargetX,TargetY)
    set S4E=C3G(Source,I1G,I0G)
    if S4E==null then
      call SaveInteger(HY,GetHandleId(Source),4319,2)
      call RestoreTint(Source)
      call SetTint(Source,-1,-1,-1,255)
      call SetUnitTimeScale(Source,1)
      call SetUnitAnimationByIndex(Source,1)
      call SetUnitPathing(Source,true)
      call SetUnitInvulnerable(Source,false)
      call UnitRemoveAbility(Source,'A04R')
      call DestroyEffect((LoadEffectHandle(HY,h,(175))))
      call DestroyEffect((LoadEffectHandle(HY,h,(176))))
      call DestroyEffect((LoadEffectHandle(HY,h,(177))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      call SaveInteger(HY,h,(34),(Count+1))
      call SaveUnitHandle(HY,h,(19),(S4E))
      call SaveReal(HY,h,(44),((C6G(Source,S4E))*1.))
      call SaveReal(HY,h,6,((GetUnitX(S4E))*1.))
      call SaveReal(HY,h,7,((GetUnitY(S4E))*1.))
    endif
  else
    call SetUnitAnimationByIndex(Source,0)
    call SetUnitPathing(Source,false)
    set AO8=NHE+rate*Cos(a)
    set AP8=NIE+rate*Sin(a)
    if IsUnitType(Source,UNIT_TYPE_HERO)then
      call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    endif
    call SetUnitX(Source,(AO8))
    call SetUnitY(Source,AP8)
    call SaveBoolean(HeroStats,GetHandleId(Source),99,true)
    call KillTrees(AO8,AP8,100)
    call SetUnitFacing(Source,a*bj_RADTODEG)
  endif
  call CNG(Source,Count,GetUnitX(Source),GetUnitY(Source))
  set t=null
  set Source=null
  set S4E=null
  set g=null
  return false
endfunction

function C1G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)+150)
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Xin_FireRemnantsB takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t
  local integer h=GetHandleId(Source)
  local integer CVG=(LoadInteger(HY,h,(746)))
  local unit S4E
  if CVG>0 and LoadInteger(HY,GetHandleId(Source),4319)!=1 then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SetTint(Source,255,0,0,75)
    call SetUnitTimeScale(Source,2)
    call SetUnitAnimationByIndex(Source,0)
    call SetUnitPathing(Source,false)
    call SetUnitInvulnerable(Source,true)
    call UnitAddAbility2(Source,'A04R')
    call SaveInteger(HY,GetHandleId(Source),4319,1)
    call TriggerRegisterTimerEvent(t,.02,true)
    call TriggerAddCondition(t,Condition(function CLG))
    call TriggerRegisterDeathEvent(t,Source)
    call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",Source,"hand right alternate")))
    call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("war3mapImported\\Phoenix_Missile_smaller.mdx",Source,"hand left alternate")))
    call SaveEffectHandle(HY,h,(177),(AddSpecialEffectTarget("war3mapImported\\FlameDash_Ground.mdx",Source,"origin")))
    call SaveUnitHandle(HY,h,2,(Source))
    call SaveReal(HY,h,(47),((GetSpellTargetX())*1.))
    call SaveReal(HY,h,(48),((GetSpellTargetY())*1.))
    set S4E=C3G(Source,GetSpellTargetX(),GetSpellTargetY())
    call SaveUnitHandle(HY,h,(19),(S4E))
    call SaveReal(HY,h,(44),((C6G(Source,S4E))*1.))
    call SaveReal(HY,h,6,((GetUnitX(S4E))*1.))
    call SaveReal(HY,h,7,((GetUnitY(S4E))*1.))
    call SaveInteger(HY,h,(34),(1))
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.0,false)
    call TriggerAddCondition(t,Condition(function C1G))
    call SaveUnitHandle(HY,h,2,(Source))
  endif
  set t=null
  set Source=null
  set S4E=null
endfunction

function C2G takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer HTD=(LoadInteger(HY,(GetHandleId(Source)),(747)))
  local integer Count=(LoadInteger(HY,h,(34)))
  if HTD<3 then
    set Count=Count-1
    call SaveInteger(HY,h,(34),(Count))
    if Count==0 then
      call UnitRemoveAbility(Source,OZ8[HTD])
      set Count=35
      call SaveInteger(HY,h,(34),(Count))
      set HTD=HTD+1
      call SaveInteger(HY,(GetHandleId(Source)),(747),(HTD))
      call UnitAddAbility2(Source,OZ8[HTD])
    endif
  endif
  set t=null
  set Source=null
  return false
endfunction

function L4G takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveInteger(HY,(GetHandleId(Source)),(747),(3))
  call UnitAddAbility2(Source,OZ8[3])
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function C2G))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveInteger(HY,h,(34),(30))
  set Source=null
  set t=null
endfunction

function Xin_FireRemnants_Learn takes nothing returns nothing
  call UnitAddAbility2(GetTriggerUnit(),'A2JL')
  call SetUnitAbilityLevel(GetTriggerUnit(),'A2JL',GetUnitAbilityLevel(GetTriggerUnit(),'A2JK'))
  if GetUnitAbilityLevel(GetTriggerUnit(),'A2JK')==1 then
    call L4G()
    call CQG()
  endif
endfunction

function Xin_FireRemnantes_Init takes nothing returns nothing
  set OZ8[0]='A2JO'
  set OZ8[1]='A2JQ'
  set OZ8[2]='A2JP'
  set OZ8[3]='A2JR'
endfunction



function DFH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local integer CG8=(LoadInteger(HY,h,(59)))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call UnitRemoveAbility(Source,CG8)
  call UnitRemoveAbility(Source,'B0FJ')
  call UnitRemoveAbility(Source,'B0FK')
  set t=null
  set Source=null
  return false
endfunction

function Legion_MoC_Remove takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local unit u=LoadUnitHandle(HY,GetHandleId(t),0)
  call UnitRemoveAbility(u,'A2GD')
  call UnitRemoveAbility(u,'A2GE')
  call UnitRemoveAbility(u,'A2GF')
  call UnitRemoveAbility(u,'A2GC')
  call UnitRemoveAbility(u,'B0FJ')
  call UnitRemoveAbility(u,'B0FK')
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTimer(t)
  set t=null
  set u=null
endfunction

function Legion_MoC_Clear takes unit u, unit target returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function Legion_MoC_Remove)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  if IsUnitType(u,UNIT_TYPE_MELEE_ATTACKER)==false and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false then
    call SetWidgetLife(u,GetWidgetLife(u)+GetEventDamage()*0.2*(GetUnitAbilityLevel(u,'A2EY')+GetUnitAbilityLevel(u,'QP1O')))
  endif
  set t=null
endfunction

function Legion_MoC_Act takes unit target returns nothing
  local trigger t
  local integer h
  local integer Level=GetUnitAbilityLevel(target,'A2EY')+GetUnitAbilityLevel(target,'QP1O')
  local integer id
  if PRD_Get(target,'A2EY',14+2*Level) then
    call AddTimedKeyToUnit(target,4316,0.9)
    if Level==1 then
      set id='A2GD'
    elseif Level==2 then
      set id='A2GE'
    elseif Level==3 then
      set id='A2GF'
    elseif Level==4 then
      set id='A2GC'
    endif
    call SetPlayerAbilityAvailable(GetOwningPlayer(target),id,false)
    call UnitAddAbility2(target,id)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterDeathEvent(t,target)
    call TriggerRegisterTimerEvent(t,0.5,false)
    call TriggerAddCondition(t,Condition(function DFH))
    call SaveUnitHandle(HY,h,2,target)
    call SaveInteger(HY,h,59,id)
    set t=null
  endif
endfunction

function Legion_MoC_OnAttack takes unit attacker, unit target returns nothing
  if (GetUnitAbilityLevel(target,'A2EY')>0 or GetUnitAbilityLevel(target,'QP1O')>0) and LoadInteger(HY,GetHandleId(target),4316)!=1 and IsUnitEnemy(target,GetOwningPlayer(attacker)) then
    call Legion_MoC_Act(target)
  endif
endfunction

function DKH takes unit Source,integer Level,unit Target returns nothing
  local integer ph=GetHandleId(GetOwningPlayer(Source))
  local integer dmg=LoadInteger(HeroStats,ph,'DDUE')
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    set ph=GetHandleId(GetOwningPlayer(Source))
    call SaveInteger(HeroStats,ph,'DUEL',LoadInteger(HeroStats,ph,'DUEL')+1)
    call SaveInteger(HeroStats,ph,'DDUE',LoadInteger(HeroStats,ph,'DDUE')+6+4*Level)
    call TextTagOnUnit(GetUnitName(Source)+" Won The Duel!!",5,Source,.03,255,0,0,255)
    call BonusDamageSystem(Source)
  endif
endfunction

function DNH takes unit u returns boolean
  return GetUnitAbilityLevel(u,'Bcyc')==0 or IsUnitCycloned(u)==false
endfunction

function DOH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer lvl=(LoadInteger(HY,h,5))
  local real Time=(LoadReal(HY,h,(442)))
  local unit Caster
  local integer ph
  local unit u
  if GetTriggerEvalCount(t)==1 then
    call STFU(Source,'B467',0.75*lvl+3.25)
    call STFU(Target,'B467',0.75*lvl+3.25)
    call UnitAddAbilityTimedExF(Source,'A467',1,Time,'B467')
    call UnitAddAbilityTimedExF(Target,'A467',1,Time,'B467')
  endif
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or Time<(TimerGetElapsed(GlobalTimer))or DNH(Source)==false or DNH(Target)==false then
    if GetTriggerEventId()==EVENT_WIDGET_DEATH then
      if GetTriggerUnit()==Source then
        set u=Target
      else
        set u=Source
      endif
      call DKH(u,lvl,GetTriggerUnit())
    endif
    call SaveBoolean(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Source),'STFU')),'SLDR',true)
    call SaveBoolean(HY,GetHandleId(LoadTriggerHandle(HY,GetHandleId(Target),'STFU')),'SLDR',true)
    call UnitRemoveAbility(Source,'A467')
    call UnitRemoveAbility(Source,'B467')
    call UnitRemoveAbility(Target,'A467')
    call UnitRemoveAbility(Target,'B467')
    call DestroyEffect((LoadEffectHandle(HY,h,(175))))
    call DestroyEffect((LoadEffectHandle(HY,h,(176))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call SetUnitPathing(Source,true)
    call SetUnitPathing(Target,true)
  elseif GetIssuedOrderId()!=851973 then
    call SetUnitPathing(Source,false)
    call SetUnitPathing(Target,false)
    call DisableTrigger(t)
    call IssueTargetOrderById(Source,851983,Target)
    call IssueTargetOrderById(Target,851983,Source)
    call EnableTrigger(t)
  else
    if GetUnitAbilityLevel(Source,'NOAT')>0 or GetUnitAbilityLevel(Source,'Abun')>0 then
      call UnitRemoveAbility(Source,'NOAT')
      call UnitRemoveAbility(Source,'Abun')
    endif
    if GetUnitAbilityLevel(Target,'NOAT')>0 or GetUnitAbilityLevel(Target,'Abun')>0 then
      call UnitRemoveAbility(Target,'NOAT')
      call UnitRemoveAbility(Target,'Abun')
    endif
  endif
  set t=null
  set Source=null
  set Target=null
  set Caster=null
  return false
endfunction

function DPH takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A2CI')
  local trigger t
  local integer h
  call SetUnitPathing(Source,false)
  call SetUnitPathing(Target,false)
  call IssueTargetOrderById(Source,851983,Target)
  call IssueTargetOrderById(Target,851983,Source)
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call SaveEffectHandle(HY,h,(175),(AddSpecialEffectTarget("war3mapImported\\DuelFX.mdx",Source,"overhead")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffectTarget("war3mapImported\\DuelFX.mdx",Target,"overhead")))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(442),(((TimerGetElapsed(GlobalTimer))+.75*Level+3.25)*1.))
  call TriggerAddCondition(t,Condition(function DOH))
  call TriggerRegisterTimerEvent(t,.05,true)
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerRegisterDeathEvent(t,Target)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,Target,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_ISSUED_ORDER)
  set Source=null
  set Target=null
  set t=null
endfunction

function LegionCommander_Duel takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call DPH()
  endif
endfunction

function Legion_Duel_Init takes nothing returns nothing
  
endfunction


function DUH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer Level=(LoadInteger(HY,h,5))
  local integer Count=(LoadInteger(HY,h,(34)))
  set Count=Count+1
  call SaveInteger(HY,h,(34),(Count))
  if GetTriggerEventId()==EVENT_WIDGET_DEATH or Count>5 or GetUnitAbilityLevel(Target,O08[Level])==0 then
    call UnitRemoveAbility(Target,O08[Level])
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    call SetWidgetLife(Target,GetWidgetLife(Target)+20+10*Level)
    call Z48("Abilities\\Spells\\Orc\\SpiritLink\\SpiritLinkZapTarget.mdl",Target,"chest",1.9)
  endif
  set t=null
  set Source=null
  set Target=null
  return false
endfunction

function LegionCommander_PressTheAttack takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A2J2')
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call RemoveDispellableBuffs(Target)
  call SetNapalmFactory(Target,0,0)
  call UnitAddAbility2(Target,O08[Level])
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("Abilities\\Spells\\Human\\InnerFire\\InnerFireTarget.mdl",Target,"overhead")))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveUnitHandle(HY,h,17,(Target))
  call SaveInteger(HY,h,5,(Level))
  call SaveInteger(HY,h,(34),(0))
  call TriggerAddCondition(t,Condition(function DUH))
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerRegisterDeathEvent(t,Target)
  call TriggerEvaluate(t)
  set Source=null
  set Target=null
  set t=null
endfunction

function Legion_PtA_Init takes nothing returns nothing
  set O08[1]='A2J9'
  set O08[2]='A2JA'
  set O08[3]='A2J8'
  set O08[4]='A2J7'
endfunction

function DYH takes nothing returns nothing
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_SUMMONED) or IsUnitIllusion(GetEnumUnit()) then
    call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_LIFE)*.5)
  endif
  call DamageTarget(GetTriggerUnit(),GetEnumUnit(),1,50*P48+(12+P48*2)*O58+(5+P48*15)*O28)
endfunction

function DZH takes nothing returns nothing
  if IsUnitType(GetEnumUnit(),UNIT_TYPE_HERO) then
    set O28=O28+1
  else
    set O58=O58+1
  endif
endfunction

function Legion_Odds_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  call SubBonusMSPercent(LoadUnitHandle(MHT,info,0),R2I(LoadReal(MHT,info,0)))
  call Timer_End(t)
  set t = null
endfunction

function LegionCommander_OverhelmingOdds takes nothing returns nothing
  local timer t = CreateTimer()
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local integer Level=GetUnitAbilityLevel(Source,'A2JB')
  local group g=GetAvailableGroup()
  call DestroyEffect(AddSpecialEffect("war3mapImported\\OverwhelmingOdds.mdx",x,y))
  call GroupEnumUnitsInRange(g,x,y,330+25,Condition(function LR8))
  set O58=0
  set O28=0
  set P48=Level
  call ForGroup(g,function DZH)
  call ForGroup(g,function DYH)
  call KillGroup(g)
  set x = (9*O28 + 3*O58)
  call AddBonusMSPercent(Source,R2I(x))
  if x>0then
    call Buff_Add(Source,LoDBuff_AbilID[20],LoDBuff_BuffID[20],7)
  endif
  set Level = GetHandleId(t)
  call SaveUnitHandle(MHT,Level,0,Source)
  call SaveReal(MHT,Level,0,x)
  call TimerStart(t,7,false,function Legion_Odds_End)
  set Source = null
  set g = null
  set t = null
endfunction

function DCH takes nothing returns nothing
  call DamageTarget(P78,GetEnumUnit(),1,((200+400*P98)/ P88)/ 20)
endfunction

function D3H takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  local real x=(LoadReal(HY,h,6))
  local real y=(LoadReal(HY,h,7))
  local group g
  if GetTriggerEvalCount(t)>20 then
    call DestroyEffect((LoadEffectHandle(HY,h,(32))))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  else
    set g=GetAvailableGroup()
    set tt_unit1=Source
    call GroupEnumUnitsInRange(g,x,y,170+25,Condition(function DE9))
    set P98=GetUnitAbilityLevel(Source,'A2BG')+GetUnitAbilityLevel(Source,'A30H')
    set P78=Source
    set P88=CountUnitsInGroup(g)
    call ForGroup(g,function DCH)
    call KillGroup(g)
    set g=null
  endif
  set t=null
  set Source=null
  return false
endfunction

function Skywrath_MysticFlare takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local string s="war3mapImported\\DivineWrathTarget.mdx"
  local location l=GetSpellTargetLoc()
  call PlaySoundAtPointBJ(PD8,100,l,0)
  call RemoveLocation(l)
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function D3H))
  call SaveUnitHandle(HY,h,2,(Source))
  call SaveReal(HY,h,6,((x)*1.))
  call SaveReal(HY,h,7,((y)*1.))
  call DestroyEffect(AddSpecialEffect(s,x,y))
  set t=null
  set Source=null
  set l=null
endfunction

function Skywrath_Ulti_init takes nothing returns nothing
  set PD8=CreateSound("Abilities\\Spells\\Demon\\RainOfFire\\RainOfFireTarget2.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(PD8,"StarfallTarget")
  call SetSoundDuration(PD8,3000)
endfunction

function E9H takes nothing returns nothing
  local unit Source=tt_unit1
  local unit Target=tt_unit2
  local integer Level=LoadInteger(HY,GetHandleId(GetTriggeringTrigger()),0)
  local integer i=GetHeroHighestStatValue(Source)
  local real Damage=40+20*Level+1.6*i
  if i==0 then
    set Damage=40+20*Level+1.6*GetHeroHighestStatValue(udg_Hero[GetPlayerId(GetOwningPlayer(Source))])
  endif
  call DamageTarget(Source,Target,1,Damage)
  set Source=null
  set Target=null
endfunction

function EDH takes nothing returns nothing
  local trigger t=AddProjectile(GetTriggerUnit(),GetSpellTargetUnit(),'h0DQ',"E9H",500,false)
  call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()))
  set t=null
endfunction

function Skywrath_ArcaneBolt takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call EDH()
  endif
endfunction

function EFH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local real d
  call UnitRemoveAbility(Target,'A2HX')
  call UnitRemoveAbility(Target,'A2I0')
  call UnitRemoveAbility(Target,'A2HY')
  call UnitRemoveAbility(Target,'A2HZ')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set Target=null
  set t=null
  return false
endfunction

function EGH takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Source=GetTriggerUnit()
  local unit Target=GetSpellTargetUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A2HN')
  local real SB8=2+Level
  local integer id='A2HX'
  if Level==2 then
    set id='A2I0'
  elseif Level==3 then
    set id='A2HY'
  elseif Level==4 then
    set id='A2HZ'
  endif
  call UnitAddAbility2(Target,id)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Target),id,false)
  call TriggerRegisterTimerEvent(t,SB8,false)
  call TriggerAddCondition(t,Condition(function EFH))
  call SaveUnitHandle(HY,h,2,Source)
  call SaveUnitHandle(HY,h,17,Target)
  set Source=null
  set Target=null
  set t=null
endfunction

function Skywrath_AncientSeal takes nothing returns nothing
  if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and IsBlocked(GetSpellTargetUnit())==false then
    call EGH()
  endif
endfunction

function EIH takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local real x=GetUnitX(tt_unit2)
  local real y=GetUnitY(tt_unit2)
  local unit Caster=CreateUnit(GetOwningPlayer(tt_unit1),'e00E',x,y,0)
  call UnitAddAbility(Caster,'A2IU')
  call SetUnitAbilityLevel(Caster,'A2IU',LoadInteger(HY,h,0))
  call IssueImmediateOrderById(Caster,852096)
  set Caster=null
endfunction

function EJH takes unit Source,group g returns unit
  local unit EKH=null
  local real d=99999
  local unit EMH=FirstOfGroup(g)
  call GroupRemoveUnit(g,EMH)
  loop
    exitwhen EMH==null
    if DistanceBetweenUnits(Source,EMH)<d then
      set d=DistanceBetweenUnits(Source,EMH)
      set EKH=EMH
    endif
    set EMH=FirstOfGroup(g)
    call GroupRemoveUnit(g,EMH)
  endloop
  set EMH=null
  set TEMPUNIT=EKH
  set EKH=null
  return TEMPUNIT
endfunction

function Skywrath_ConcussiveShot takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=null
  local group g=GetAvailableGroup()
  local trigger t
  set tt_unit1=Source
  call GroupEnumUnitsInRange(g,GetUnitX(Source),GetUnitY(Source),1600+25,Condition(function DD9))
  set Target=EJH(Source,g)
  call KillGroup(g)
  if Target!=null then
    set t=AddProjectile(Source,Target,'h0E6',"EIH",800,false)
    call SaveInteger(HY,GetHandleId(t),0,GetUnitAbilityLevel(Source,GetSpellAbilityId()))
    set t=null
  endif
  set g=null
  set Target=null
  set Source=null
endfunction

function FFH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Target=(LoadUnitHandle(HY,h,17))
  local integer TQG=(LoadInteger(HY,h,(422)))
  local integer TRG=(LoadInteger(HY,h,(423)))
  local integer SSF=(LoadInteger(HY,h,(424)))
  if GetUnitAbilityLevel(Target,'A42S')==0 or GetTriggerEvalCount(t)>35 then
    call UnitRemoveAbility(Target,'A42S')
    call UnitRemoveAbility(Target,'B0HJ')
    call SetHeroAgi(Target,GetHeroAgi(Target,false)+TQG,true)
    call SetHeroStr(Target,GetHeroStr(Target,false)+TRG,true)
    call SetHeroInt(Target,GetHeroInt(Target,false)+SSF,true)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Target=null
  return false
endfunction

function FGH takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local unit Target=GetEnumUnit()
  local integer Level=GetUnitAbilityLevel(Source,'A2FK')
  local trigger t
  local integer h
  local integer attr
  local integer agi
  local integer str
  local integer int
  local real rate
  if IsUnitType(Target,UNIT_TYPE_HERO) then
    set attr=GetUnitPrimaryAttribute(Target)
    set rate=.15
    if attr==2 then
      set agi=R2I(rate*GetHeroAgi(Target,false))-1
      set str=0
      set int=0
    elseif attr==3 then
      set agi=0
      set str=R2I(rate*GetHeroStr(Target,false))-1
      set int=0
    elseif attr==1 then
      set agi=0
      set str=0
      set int=R2I(rate*GetHeroInt(Target,false))-1
    endif
    call SetHeroAgi(Target,GetHeroAgi(Target,false)-agi,true)
    call SetHeroStr(Target,GetHeroStr(Target,false)-str,true)
    call SetHeroInt(Target,GetHeroInt(Target,false)-int,true)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,0.2,true)
    call TriggerRegisterDeathEvent(t,Target)
    call TriggerAddCondition(t,Condition(function FFH))
    call SaveInteger(HY,h,422,agi)
    call SaveInteger(HY,h,424,int)
    call SaveInteger(HY,h,423,str)
    call SaveUnitHandle(HY,h,17,Target)
    call UnitAddAbility2(Target,'A42S')
    set t=null
  endif
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",Target,"chest"))
  call DamageTarget(Source,Target,PM8,50+50*Level)
  set Source=null
  set Target=null
endfunction

function Shredder_WhirlingDeath takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
  set x=GetUnitX(Source)
  set y=GetUnitY(Source)
  if KillTrees(x,y,300)>0 then
    set PM8=3
  else
    set PM8=1
  endif
  call GroupEnumUnitsInRange(g,x,y,300+25,Condition(function LR8))
  call ForGroup(g,function FGH)
  call KillGroup(g)
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\WhirlingDeath_01.mdx",Source,"origin"))
  set Source=null
  set g=null
endfunction

function FJH takes unit Source,unit Target returns nothing
  local integer Level=Shredder_TempInt
  call DamageTarget(Source,Target,3,60+40*Level)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",Target,"origin"))
endfunction

function FKH takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),DK)==false then
    call GroupAddUnit(DK,GetEnumUnit())
    call FJH(tt_unit1,GetEnumUnit())
  endif
endfunction

function FMH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local unit Target=LoadUnitHandle(HY,h,17)
  local integer R9E=LoadInteger(HY,h,18)
  local integer Count=GetTriggerEvalCount(t)
  local unit RDE
  local group REE=LoadGroupHandle(HY,h,16)
  local group g
  local boolean WD9=LoadBoolean(HY,h,727)
  local boolean FNH=LoadBoolean(HY,h,740)
  set Shredder_TempInt=LoadInteger(HY,h,0)
  if IsUnitDisabled(Hero)then
    set FNH=true
    call SaveBoolean(HY,h,740,FNH)
  endif
  if WD9==false then
    set RDE=LoadUnitHandle(HY,h,700+R9E+1-Count)
    call RemoveUnit(RDE)
  else
    set RDE=LoadUnitHandle(HY,h,700+Count)
    if FNH==false then
      if IsUnitType(Hero,UNIT_TYPE_HERO)then
        call SaveBoolean(HeroStats,GetHandleId(Hero),99,true)
      endif
      call SetUnitX(Hero,GetUnitX(RDE))
      call SetUnitY(Hero,GetUnitY(RDE))
    endif
    call RemoveUnit(RDE)
    set g=GetAvailableGroup()
    set tt_unit1=Hero
    set DK=REE
    call GroupEnumUnitsInRange(g,GetUnitX(Hero),GetUnitY(Hero),250,Condition(function LW8))
    call ForGroup(g,function FKH)
    call KillGroup(g)
  endif
  if Count==(R9E)then
    call KillTrees(GetUnitX(Hero),GetUnitY(Hero),90)
    call KillGroup(REE)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set Hero=null
  set Target=null
  set RDE=null
  set REE=null
  set g=null
  return false
endfunction

function FOH takes nothing returns nothing
  if IsValidTree(GetEnumDestructable())and IsDestructableDeadBJ(GetEnumDestructable())==false then
    set PN8=PN8+1
  endif
endfunction

function FPH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=LoadUnitHandle(HY,h,14)
  local real a=LoadReal(HY,h,13)
  local integer RHE=LoadInteger(HY,h,12)
  local integer Count=GetTriggerEvalCount(t)
  local real x=LoadReal(HY,h,6)+Count*50*Cos(a*bj_DEGTORAD)
  local real y=LoadReal(HY,h,7)+Count*50*Sin(a*bj_DEGTORAD)
  local boolean RIE=LoadBoolean(HY,h,15)
  local unit RJE
  local trigger RKE=LoadTriggerHandle(HY,h,11)
  local integer RME=GetHandleId(RKE)
  local integer ID='u01Q'
  local real RFE=250
  local rect r
  local real d=90
  local integer lvl=LoadInteger(HY,h,0)
  set r=Rect(x-d,y-d,x+d,y+d)
  set PN8=0
  call EnumDestructablesInRect(r,Condition(function ReturnTrue),function FOH)
  if PN8>0 or Count==RHE or Count==(RHE-1)or Count==(RHE-2)then
    set ID='u01P'
  endif
  set RJE=CreateUnit(GetOwningPlayer(Hero),ID,x,y,a)
  call SaveUnitHandle(HY,RME,700+Count,RJE)
  if PN8>0 then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
    call TriggerAddCondition(RKE,Condition(function FMH))
    call SaveInteger(HY,RME,18,Count)
    call SaveInteger(HY,RME,0,lvl)
    call SaveBoolean(HY,RME,727,true)
    call SaveUnitHandle(HY,RME,14,Hero)
    call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
    call SaveReal(HY,RME,6,x*1.)
    call SaveReal(HY,RME,7,y*1.)
    call SaveBoolean(HY,RME,740,false)
  elseif Count>RHE then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call TriggerRegisterTimerEvent(RKE,.5/ RHE,true)
    call TriggerAddCondition(RKE,Condition(function FMH))
    call SaveInteger(HY,RME,18,Count)
    call SaveInteger(HY,RME,0,lvl)
    call SaveBoolean(HY,RME,727,false)
    call SaveUnitHandle(HY,RME,14,Hero)
    call SaveGroupHandle(HY,RME,16,GetAvailableGroup())
    call SaveBoolean(HY,RME,740,false)
  endif
  set t=null
  set Hero=null
  set RJE=null
  set RKE=null
  return false
endfunction

function Shredder_Timberchain takes nothing returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit Hero=GetTriggerUnit()
  local real a=AngleBetweenXY(GetUnitX(Hero),GetUnitY(Hero),GetSpellTargetX(),GetSpellTargetY())
  local integer Level=GetUnitAbilityLevel(Hero,'A2E3')
  local integer ROE
  local integer RHE
  local trigger RPE=CreateTrigger()
  set ROE=600+200*Level
  set RHE=ROE/ 50
  call SaveUnitHandle(HY,h,(14),(Hero))
  call SaveInteger(HY,h,5,(Level))
  call SaveReal(HY,h,(13),((a)*1.))
  call SaveInteger(HY,h,(12),(RHE))
  call SaveTriggerHandle(HY,h,(11),(RPE))
  call SaveReal(HY,h,6,((GetUnitX(Hero))*1.))
  call SaveReal(HY,h,7,((GetUnitY(Hero))*1.))
  call TriggerRegisterTimerEvent(t,.5/ RHE,true)
  call TriggerAddCondition(t,Condition(function FPH))
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Hero,GetSpellAbilityId()))
  set t=null
  set Hero=null
  set RPE=null
endfunction

function FTH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local integer info = GetHandleId(Source)
  call LoDStat_Sub(Source,1,"regen")
  call LoDStat_Sub(Source,1,"armour")
  call SaveInteger(HY,info,'A2E4',LoadInteger(HY,info,'A2E4')-1)
  if GetTriggerEventId()==EVENT_UNIT_DEATH then//not really needed, but just incase of respawn and such
    call Buff_Remove(Source,LoDBuff_BuffID[5])
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function Shredder_ReactiveArmor_Proc takes unit timber returns nothing
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call Buff_Add(timber,LoDBuff_AbilID[5],LoDBuff_BuffID[5],16)
  call LoDStat_Add(timber,1,"regen")
  call LoDStat_Add(timber,1,"armour")
  call SaveInteger(HY,GetHandleId(timber),'A2E4',LoadInteger(HY,GetHandleId(timber),'A2E4')+1)
  call DestroyEffect(AddSpecialEffectTarget("war3mapImported\\ReactiveArmor.mdx",timber,"chest"))
  call TriggerRegisterTimerEvent(t,16,false)
  call TriggerRegisterDeathEvent(t,timber)
  call TriggerAddCondition(t,Condition(function FTH))
  call SaveUnitHandle(HY,h,2,timber)
  set t=null
endfunction

function Shredder_ReactiveArmor_OnAttack takes unit attacker, unit target returns nothing
  if (GetUnitAbilityLevel(target,'A2E4')>0 or GetUnitAbilityLevel(target,'QP1P')>0) and IsUnitEnemy(attacker,GetOwningPlayer(target)) and 4*(GetUnitAbilityLevel(target,'A2E4')+GetUnitAbilityLevel(target,'QP1P'))>LoadInteger(HY,GetHandleId(target),'A2E4') then
    call Shredder_ReactiveArmor_Proc(target)
  endif
endfunction

function FXH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=(LoadUnitHandle(HY,h,2))
  call UnitRemoveAbility(Source,'Bpig')
  call UnitRemoveAbility(Source,'BEia')
  call UnitRemoveAbility(Source,'BNms')
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set Source=null
  return false
endfunction

function FYH takes unit Source,unit Target returns nothing
  local unit Caster=CreateUnit(GetOwningPlayer(Source),'e00E',GetUnitX(Target),GetUnitY(Target),0)
  local integer WFE=R2I(100*GetWidgetLife(Target)/ GetUnitState(Target,UNIT_STATE_MAX_LIFE))
  local integer Level=IMaxIF( IMinIF( R2I(100-WFE) / 5, 20 ), 1 )
  call UnitAddAbility(Caster,'A2DV')
  call SetUnitAbilityLevel(Caster,'A2DV',Level)
  call IssueTargetOrderById(Caster,852075,Target)
  set Caster=null
endfunction

function FZH takes nothing returns nothing
  if GameEnded==false then
    call DamageTarget(PS8,GetEnumUnit(),3,(25+25*PT8)*.5)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
    call FYH(PS8,GetEnumUnit())
  endif
endfunction

function FAH takes nothing returns nothing
  if IsUnitInGroup(GetEnumUnit(),PR8)==false then
    call GroupAddUnit(PR8,GetEnumUnit())
    call DamageTarget(PS8,GetEnumUnit(),3,60+40*PT8)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnumUnit(),"origin"))
    call FYH(PS8,GetEnumUnit())
  endif
endfunction

function DelayedRemoveTurnOffB takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A43P')
  call FlushChildHashtable(HY,h)
  call PauseTimer(t)
  call DestroyTimer(t)
  set t=null
endfunction

function DelayedRemoveTurnOff takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function DelayedRemoveTurnOffB)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  set t=null
endfunction

function FBH takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit Source=LoadUnitHandle(HY,h,2)
  local unit Projectile=LoadUnitHandle(HY,h,45)
  local real TargetX=LoadReal(HY,h,6)
  local real TargetY=LoadReal(HY,h,7)
  local real x
  local real y
  local real a
  local integer state=LoadInteger(HY,h,33)
  local group AlreadyHit=LoadGroupHandle(HY,h,187)
  local group g
  local integer Count=LoadInteger(HY,h,34)
  local real manacost
  local integer spellid=LoadInteger(HY,h,2)
  local integer abun=LoadInteger(HY,h,3)
  local integer turnoff=LoadInteger(HY,h,4)
  call UnitAddAbility2(Source,abun)
  if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
    if GetSpellAbilityId()==turnoff then
      call SaveInteger(HY,h,33,2)
      call GroupClear(AlreadyHit)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
      set t=CreateTrigger()
      set h=GetHandleId(t)
      call TriggerRegisterTimerEvent(t,0,false)
      call TriggerAddCondition(t,Condition(function FXH))
      call SaveUnitHandle(HY,h,2,(Source))
      if turnoff=='A43P' then
        call DelayedRemoveTurnOff(Source)
      else
        call UnitRemoveAbility(Source,turnoff)
      endif
    endif
  elseif GetTriggerEventId()==EVENT_WIDGET_DEATH or(LoadInteger(HY,GetHandleId(Source),704))==-1 then
    call UnitRemoveAbility(Source,turnoff)
    if(LoadInteger(HY,GetHandleId(Source),704))==0 or(LoadInteger(HY,GetHandleId(Source),704))==spellid then
      if spellid=='A43Q' then
        if LoadBoolean(MHT,GetHandleId(tt_unit1),'A43Q') then
          call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
        endif
      else
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
      endif
    endif
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
    if spellid!='A43Q' then
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',true)
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',true)
    endif
    call UnitRemoveAbility(Source,'Bpig')
    call UnitRemoveAbility(Source,'BEia')
    call UnitRemoveAbility(Source,'BNms')
    call KillUnit(Projectile)
    call KillGroup(AlreadyHit)
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  elseif state==0 then
    set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),TargetX,TargetY)*bj_DEGTORAD
    set x=GetUnitX(Projectile)+18*Cos(a)
    set y=GetUnitY(Projectile)+18*Sin(a)
    call KillTrees(x,y,175)
    if DistanceBetweenXY(x,y,TargetX,TargetY)<40 then
      set x=TargetX
      set y=TargetY
    endif
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    set tt_unit1=Source
    set PS8=Source
    set PT8=LoadInteger(HY,h,0)
    set PR8=AlreadyHit
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function FAH)
    call KillGroup(g)
    if x==TargetX and y==TargetY then
      call SaveInteger(HY,h,(33),(1))
      call GroupClear(AlreadyHit)
    endif
  elseif state==1 then
    set Count=Count+1
    if Count==25 then
      set x=GetUnitX(Projectile)
      set y=GetUnitY(Projectile)
      call KillTrees(x,y,175)
      set Count=0
      set tt_unit1=Source
      set PS8=Source
      set PT8=LoadInteger(HY,h,0)
      set g=GetAvailableGroup()
      call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilter))
      call ForGroup(g,function FZH)
      call KillGroup(g)
      set manacost=(15+5*PT8)/ 2
      if GetUnitState(Source,UNIT_STATE_MANA)<manacost or DistanceBetweenUnits(Source,Projectile)>2000 then
        call SaveInteger(HY,h,(33),2)
        call GroupClear(AlreadyHit)
        call UnitRemoveAbility(Source,turnoff)
        
        call UnitRemoveAbility(Source,'Bpig')
        call UnitRemoveAbility(Source,'BEia')
        call UnitRemoveAbility(Source,'BNms')
      else
        call SetUnitState(Source,UNIT_STATE_MANA,GetUnitState(Source,UNIT_STATE_MANA)-manacost)
      endif
    endif
    call SaveInteger(HY,h,(34),(Count))
  elseif state==2 then
    set a=AngleBetweenXY(GetUnitX(Projectile),GetUnitY(Projectile),GetUnitX(Source),GetUnitY(Source))*bj_DEGTORAD
    set x=GetUnitX(Projectile)+16*Cos(a)
    set y=GetUnitY(Projectile)+16*Sin(a)
    call KillTrees(x,y,175)
    call SetUnitX(Projectile,x)
    call SetUnitY(Projectile,y)
    set tt_unit1=Source
    set PS8=Source
    set PT8=LoadInteger(HY,h,0)
    set PR8=AlreadyHit
    set g=GetAvailableGroup()
    call GroupEnumUnitsInRange(g,x,y,200+25,Condition(function DefaultEnemyFilter))
    call ForGroup(g,function FAH)
    call KillGroup(g)
    if DistanceBetweenXY(x,y,GetUnitX(Source),GetUnitY(Source))<40 then
      call UnitRemoveAbility(Source,abun)
      call KillUnit(Projectile)
      call KillGroup(AlreadyHit)
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
      if(LoadInteger(HY,(GetHandleId(Source)),(704)))==0 or(LoadInteger(HY,(GetHandleId(Source)),(704)))==spellid then
        if spellid=='A43Q' then
          if LoadBoolean(MHT,GetHandleId(tt_unit1),'A43Q') then
            call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
          endif
        else
          call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,true)
        endif
      endif
      call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,false)
      if spellid!='A43Q' then
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',true)
        call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',true)
      endif
      call UnitRemoveAbility(Source,turnoff)
    endif
  endif
  set t=null
  set Source=null
  set Projectile=null
  set AlreadyHit=null
  set g=null
  return false
endfunction

function Shredder_Chakram takes nothing returns nothing
  local unit Source=GetTriggerUnit()
  local real x=GetSpellTargetX()
  local real y=GetSpellTargetY()
  local real a=AngleBetweenXY(GetUnitX(Source),GetUnitY(Source),x,y)*bj_DEGTORAD
  local unit Projectile=CreateUnit(GetOwningPlayer(Source),'h0DS',GetUnitX(Source),GetUnitY(Source),a*bj_RADTODEG)
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer abun
  local integer turnoff
  local integer spellid=GetSpellAbilityId()
  call TriggerRegisterTimerEvent(t,.02,true)
  call TriggerRegisterDeathEvent(t,Source)
  call TriggerRegisterUnitEvent(t,Source,EVENT_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function FBH))
  call SaveUnitHandle(HY,h,45,Projectile)
  call SaveUnitHandle(HY,h,2,Source)
  call SaveReal(HY,h,6,x*1.)
  call SaveReal(HY,h,7,y*1.)
  call SaveInteger(HY,h,33,0)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(Source,spellid))
  call SaveGroupHandle(HY,h,187,GetAvailableGroup())
  call SaveInteger(HY,h,2,spellid)
  if spellid=='A2E5' or spellid=='A43S' then
    set abun='A43N'
    set turnoff='A2FX'
  else
    set abun='A43O'
    set turnoff='A43P'
  endif
  
  call UnitAddAbility2(Source,abun)
  call UnitAddAbility2(Source,turnoff)
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),spellid,false)
  if spellid!='A43Q' then
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A2E5',false)
    call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),'A43S',false)
  endif
  call SetPlayerAbilityAvailable2(GetOwningPlayer(Source),turnoff,true)
  
  call SaveInteger(HY,h,3,abun)
  call SaveInteger(HY,h,4,turnoff)
  set Source=null
  set t=null
  set Projectile=null
endfunction

function ChakramLevelup takes nothing returns nothing
  if GetUnitAbilityLevel(GetTriggerUnit(),'A43Q')>0 then
    call SetUnitAbilityLevel(GetTriggerUnit(),'A43Q',GetUnitAbilityLevel(GetTriggerUnit(),'A2E5')+GetUnitAbilityLevel(GetTriggerUnit(),'A43S'))
  endif
endfunction

function AghaChakram_Add takes nothing returns nothing
  call UnitAddAbility2(tt_unit1,'A43Q')
  call SetPlayerAbilityAvailable2(GetOwningPlayer(tt_unit1),'A43Q',true)
  call SaveBoolean(MHT,GetHandleId(tt_unit1),'A43Q',true)
  call SetUnitAbilityLevel(tt_unit1,'A43Q',GetUnitAbilityLevel(tt_unit1,'A2E5')+GetUnitAbilityLevel(tt_unit1,'A43S'))
endfunction

function AghaChakram_Remove takes nothing returns nothing
  call SetPlayerAbilityAvailable2(GetOwningPlayer(tt_unit1),'A43Q',false)
  call SaveBoolean(MHT,GetHandleId(tt_unit1),'A43Q',false)
endfunction

function Timber_Chakram_Preload takes nothing returns nothing
  call PreloadQueryAdd('A2DV')
endfunction

function Formless_Clear takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer aid=LoadInteger(HY,h,1)
  local integer hu=GetHandleId(u)
  local integer c=LoadInteger(HY,h,100)+1
  local integer slot
  if c==240 or aid=='DRKN' or aid=='A29J' then
    if LoadInteger(MHT,hu,'A40K')!=aid and LoadInteger(MHT,hu,'A40K'+1)!=aid and LoadInteger(MHT,hu,'A40K'+2)!=aid and LoadInteger(MHT,hu,'A40K'+3)!=aid then
      call UnitRemoveAbility(u,aid)
      set slot=LoadInteger(HY,h,2)
      if(LoadBoolean(MHT,hu,'A40K'+slot))then
        call RemoveSavedBoolean(MHT,hu,'A40K'+slot)
      endif
    endif
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  else
    call SaveInteger(HY,h,100,c)
    if LoadInteger(MHT,hu,'A40K')!=aid and LoadInteger(MHT,hu,'A40K'+1)!=aid and LoadInteger(MHT,hu,'A40K'+2)!=aid and LoadInteger(MHT,hu,'A40K'+3)!=aid then
      call SetPlayerAbilityAvailable(GetOwningPlayer(u),aid,false)
    endif
  endif
  set t=null
  set u=null
endfunction

function Formless_DelayedClear takes unit u, integer aid1, integer slot returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.5,true,function Formless_Clear)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),aid1,false)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call SaveInteger(HY,GetHandleId(t),1,aid1)
  call SaveInteger(HY,GetHandleId(t),2,slot)
  call SaveInteger(MHT,GetHandleId(u),'A40K'+slot,0)
  set t=null
endfunction

function Formless_SpellEffect takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local integer lvl=LoadInteger(HY,h,2)
  local integer i=LoadInteger(HY,h,3)
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST and GetSpellAbilityId()==LoadInteger(HY,h,0) then
    set i=i+1
    if i>=LoadInteger(HY,h,4) then
      set u=LoadUnitHandle(HY,h,0)
      call Formless_DelayedClear(u,LoadInteger(HY,h,0),LoadInteger(HY,h,1))
      call UnitRemoveAbility(u,LoadInteger(HY,h,1)+'A40O')
      call SetPlayerAbilityAvailable(GetOwningPlayer(u),LoadInteger(HY,h,0),false)
      set u=null
      call FlushChildHashtable(HY,h)
      call DestroyTrigger(t)
    else
      call SaveInteger(HY,h,3,i)
    endif
  else
    set u=LoadUnitHandle(HY,h,0)
    if GetUnitAbilityLevel(u,'A40S'+LoadInteger(HY,h,1))!=GetUnitAbilityLevel(u,LoadInteger(HY,h,0)) then
      call SetUnitAbilityLevel(u,LoadInteger(HY,h,0),GetUnitAbilityLevel(u,'A40S'+LoadInteger(HY,h,1)))
    endif
    set u=null
  endif
  set t=null
endfunction

function FormlessAddLimitations takes unit u, integer aid returns nothing
  local string s=""
  local integer i
  local integer h=GetHandleId(u)
  
endfunction

function Formless_AddSpell takes unit u, integer sid, integer castid, integer lvl returns nothing
  local trigger t
  local integer h
  if not UnitAddAbility2(u,SkillID[PlayerSkillNumber[sid]]) and GetUnitAbilityLevel(u,SkillID[PlayerSkillNumber[sid]])==0 then
    return
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  call TriggerRegisterUnitEvent(t,u,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function Formless_SpellEffect))
  call SaveUnitHandle(HY,h,0,u)
  call SaveInteger(HY,h,0,SkillID[PlayerSkillNumber[sid]])
  call SetUnitAbilityLevel(u,SkillID[PlayerSkillNumber[sid]],lvl)
  call SetPlayerAbilityAvailable(GetOwningPlayer(u),SkillID[PlayerSkillNumber[sid]],true)
  call SaveInteger(MHT,GetHandleId(u),'A40K'+castid,SkillID[PlayerSkillNumber[sid]])
  call SaveInteger(HY,h,1,castid)
  call SaveInteger(HY,h,2,lvl)
  if CheckStacking(GetSkillIndex(sid),-1,"metamorphosis",null) then
    call SaveBoolean(MHT,GetHandleId(u),'A40K'+castid,true)
  endif
  if castid==3 then
    call SaveInteger(HY,h,4,lvl)
  else
    call SaveInteger(HY,h,4,lvl+1)
  endif
  if (castid==3 and lvl<3) or (castid<3 and lvl<4) then
    call TriggerRegisterTimerEvent(t,1,true)
  endif
  call UnitAddAbility2(u,castid+'A40O')
  set t=null
endfunction

function Formless_SpellFilter takes unit u, integer sid, integer sindex returns boolean
  local integer i=GetPlayerId(GetOwningPlayer(u))
  local integer xx
  local integer k
  if isFormlessAbility(sid) or isPoisonArrowSkill(sid) or isDummyAbility(sid) then
    return false
  endif
  if sid=='A0KX' or sid=='A0G8' or sid=='A07U' or sid=='A0A5' or sid=='A0AG' or sid=='QM01' or sid=='A0BE' or sid=='A0EY' or sid=='A0NS' or sid=='A0H9' or sid=='A0NE' or sid=='A32E' or sid=='A21F' or sid=='A1S4' or sid=='A1NA' or sid=='A2QM' or sid=='A2TJ' or sid=='A2QI' or sid=='A2TI' or sid=='A06K' or sid=='A1T8' or sid=='A28Q' or sid=='A1TB' or sid=='A0MQ' or sid=='A2O2' or sid=='QF89' or sid=='A0OO' or sid=='A14O' or sid=='A1EA' or sid=='QB03' or sid=='A27H' or sid=='A2JR' or sid=='Z234' or sid=='A0WQ' or sid=='A1C0' or sid=='A0MP' or sid=='A01Y' or sid=='A32Z' or sid=='A0SW' or sid=='A0LV' or sid=='A21M' or sid=='A40B' or sid=='A418' or sid=='A0ES' then
    return false
  endif
  set xx=1
  loop
    if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+xx]]==sid or CheckStacking(sindex,PlayerSkillNumber[i*PlayerSkillOffset+xx],null,null) then
      return false
    endif
    set xx=xx+1
    exitwhen xx>6
  endloop
  if CheckStacking(sindex,-1,"metamorphosis",null) and (isMorphedUnit(u) or LoadBoolean(MHT,GetHandleId(u),'A40K') or LoadBoolean(MHT,GetHandleId(u),'A40K'+1) or LoadBoolean(MHT,GetHandleId(u),'A40K'+2) or LoadBoolean(MHT,GetHandleId(u),'A40K'+3))then
    return false
  endif
  
  if (LoadInteger(MHT,GetHandleId(u),'A40K')==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+1)==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+2)==sid or LoadInteger(MHT,GetHandleId(u),'A40K'+3)==sid) then
    return false
  endif
  return true
endfunction

function Formless_SpellCast takes nothing returns nothing
  local integer i=0
  local integer iu=0
  local integer array a
  local integer array b
  local integer k=1
  local integer pid=0
  local integer xx=0
  local unit u=GetTriggerUnit()
  local integer casterpid=GetPlayerId(GetOwningPlayer(u))
  local integer castid=GetSpellAbilityId()-'A40K'
  local integer rid=0
  local integer c=0
  if k==casterpid then
    set k=2
  endif
  loop
    set xx=1
    loop
      if PlayerSkillNumber[k*PlayerSkillOffset+xx]!=0 then
        if IsPassiveAbility[PlayerSkillNumber[k*PlayerSkillOffset+xx]]==false and Formless_SpellFilter(u,SkillID[PlayerSkillNumber[k*PlayerSkillOffset+xx]],PlayerSkillNumber[k*PlayerSkillOffset+xx]) then
          if xx==4 or xx==6 then
            set b[iu]=k*PlayerSkillOffset+xx
            set iu=iu+1
          else
            set a[i]=k*PlayerSkillOffset+xx
            set i=i+1
          endif
        endif
      endif
      set xx=xx+1
      exitwhen xx>PlayerSkillOffset
    endloop
    set k=k+1
    if k==casterpid then
      set k=k+1
    endif
    if k==6 then
      set k=7
    endif
    exitwhen k>11
  endloop
  if castid==3 then
    if iu>0 then
      set rid=b[GetRandomInt(0,iu-1)]
    endif
  else
    if i>0 then
      set rid=a[GetRandomInt(0,i-1)]
    endif
  endif
  if rid==0 then
    call Error(GetOwningPlayer(u),"Copy failed")
  else
    call Formless_AddSpell(u,rid,castid,GetUnitAbilityLevel(u,GetSpellAbilityId()))
  endif
  set u=null
endfunction

function UndyingZombieHeal takes nothing returns nothing
  if IsDead(tt_unit2)==false then
    call SetWidgetLife(tt_unit2,GetWidgetLife(tt_unit2)+50)
  endif
endfunction

function UndyingZombie takes unit u returns nothing
  if GetUnitTypeId(u)=='n020' and IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(u))])==false then
    call AddProjectile(u,udg_Hero[GetPlayerId(GetOwningPlayer(u))],'h00W',"UndyingZombieHeal",400,false)
  endif
endfunction

function OldMarksmanshipBonus takes nothing returns nothing
  local integer i
  if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    set i=GetUnitPrimaryAttribute(GetTriggerUnit())
    if i==1 then
      call SetHeroInt(GetTriggerUnit(),GetHeroInt(GetTriggerUnit(),false)+15,true)
    elseif i==2 then
      call SetHeroAgi(GetTriggerUnit(),GetHeroAgi(GetTriggerUnit(),false)+15,true)
    elseif i==3 then
      call SetHeroStr(GetTriggerUnit(),GetHeroStr(GetTriggerUnit(),false)+15,true)
    endif
  endif
endfunction

function OldMarksmanship_Instagib takes unit attacker, unit target returns nothing
  if IsUnitType(target,UNIT_TYPE_HERO)==false and IsUnitType(target,UNIT_TYPE_ANCIENT)==false and IsUnitIllusion(target)==false and PRD_Get(attacker,'A43Z',10) then
    call DamageTarget(attacker,target,1,10000)
  endif
endfunction

function HEH takes nothing returns nothing
  local trigger t
  
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddAction(t,function SH8)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_LEVEL)
  call TriggerAddAction(t,function FixOverexp)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddAction(t,function BYD)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddAction(t,function BXD)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerAddAction(t,function SpellPickingPreventOrders)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_LEVEL)
  call TriggerAddAction(t,function Q08)
  if Mode_Debug then
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
    call TriggerAddAction(t,function QU8)
    set t=CreateTrigger()
    call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddAction(t,function QT8)
    set t=CreateTrigger()
    call TriggerRegisterPlayerSelectionEventBJ(t,Player(1),true)
    call TriggerAddAction(t,function QS8)
  endif
  call RP8()
  call TriggerSleepAction(1)
  set t=null
endfunction


function Gnoll_Flux_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsDead(t)==false and IsUnitAlly(group_temp_unit[0],GetOwningPlayer(t)) and GetUnitAbilityLevel(t,'A04R')==0 and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) and t!=group_temp_unit[0] then
    call SaveBoolean(MHT,99999,99999,false)
    set t = null
  endif
  
  set t = null
  return false
endfunction

function Gnoll_Flux_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  
  if count==120 or IsDead(u)then
    call DestroyEffect(LoadEffectHandle(MHT,info,2))
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  
  call SaveInteger(MHT,info,0,count + 1)
  
  set group_temp_unit[0] = u
  call SaveBoolean(MHT,99999,99999,true)
  
  call GroupEnumUnitsInRange(temp_group,GetWidgetX(u),GetWidgetY(u),250,Condition(function Gnoll_Flux_Targets))
  
  if LoadBoolean(MHT,99999,99999)then
    if GetUnitAbilityLevel(u,LoDBuff_BuffID[27])==0then
      call Buff_Add(u,LoDBuff_AbilID[27],LoDBuff_BuffID[27],6 - count*0.05)
    endif
    if count/10 == count/10. then
      call DamageTarget(LoadUnitHandle(MHT,info,1),u,1,LoadReal(MHT,info,0))
    endif
  else
    call Buff_Remove(u,LoDBuff_BuffID[27])
  endif
  
  set t = null
  set u = null
endfunction

function Gnoll_Flux_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local unit d = GetSpellTargetUnit()
  local integer info = GetHandleId(t)
  
  call SaveUnitHandle(MHT,info,0,d)
  call SaveUnitHandle(MHT,info,1,u)
  call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\Flux3.mdx",d,"origin"))
  call SaveInteger(MHT,info,0,0)
  call SaveReal(MHT,info,0,GetUnitAbilityLevel(u,'A2M1')*7.5)
  
  call TimerStart(t,0.05,true,function Gnoll_Flux_Duration)
  call Buff_Add(d,LoDBuff_AbilID[27],LoDBuff_BuffID[27],6)
  
  set d = null
  set u = null
  set t = null
endfunction


function Gnoll_Field_Targets takes nothing returns nothing
  local integer key
  local integer info
  local unit u = GetFilterUnit()
  if IsUnitAlly(u,group_temp_player)and (IsUnitType(u,UNIT_TYPE_HERO)or IsUnitType(u,UNIT_TYPE_STRUCTURE)==true)and GetUnitAbilityLevel(u,'A04R')==0 and IsDead(u)==false then
    call GroupAddUnit(temp_group2,u)   //adds the unit to group of currently affected units
    if IsUnitInGroup(u,group_temp_group)==false then  //hasn'u been affected by the field
      set info = GetHandleId(u)
      set key = StringHash("field_count")
      call Buff_Add(u,LoDBuff_AbilID[28],LoDBuff_BuffID[28],-1) //adds the buff
      if IsUnitType(u,UNIT_TYPE_HERO)then
        call LoDStat_Add(u,group_temp_integer[0],"attack")
      else
        call LoDStat_Add(u,group_temp_integer[1],"attack")
      endif
      call SaveInteger(MHT,info,key,LoadInteger(MHT,info,key) + 1) //keeps track of the number of times the unit has been affected for field stacking
      call UnitAddAbility(u,'A515')
      call UnitMakeAbilityPermanent(u,true,'A515')
      call UnitMakeAbilityPermanent(u,true,'ACes')
      set u = null
      return
    endif
    call GroupRemoveUnit(group_temp_group,u) //removes the unit from the group of previously affected units
  endif
  set u = null
endfunction

function Gnoll_Field_Duration takes nothing returns nothing
  local unit u = null
  local timer t = GetExpiredTimer()
  local integer key = StringHash("field_count")
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local integer amount = LoadInteger(MHT,info,1)
  set group_temp_group = LoadGroupHandle(MHT,info,1)
  if count==0 then
    call DestroyEffect(LoadEffectHandle(MHT,info,2))
    loop
      set u = FirstOfGroup(group_temp_group)
      exitwhen u==null
      set info = GetHandleId(u)
      set count = LoadInteger(MHT,info,key)
      if count==1then
        call UnitRemoveAbility(u,'A515')
        call Buff_Remove(u,LoDBuff_BuffID[28])
      endif
      call SaveInteger(MHT,info,key,count - 1)
      call LoDStat_Sub(u,amount,"attack")
      call GroupRemoveUnit(group_temp_group,u)
    endloop
    call KillGroup(group_temp_group)
    call Timer_End(t)
    set t = null
    return
  endif
  call SaveInteger(MHT,info,0,count - 1)
  set group_temp_player = LoadPlayerHandle(MHT,info,0)
  set group_temp_integer[0] = amount
  set group_temp_integer[1] = amount/2
  call GroupEnumUnitsInRange(temp_group,LoadReal(MHT,info,0),LoadReal(MHT,info,1),325,Condition(function Gnoll_Field_Targets))
  //removes the bonuses from any unit out of range
  loop
    set u = FirstOfGroup(group_temp_group)
    exitwhen u==null
    set info = GetHandleId(u)
    set count = LoadInteger(MHT,info,key)
    if count==1then
      call UnitRemoveAbility(u,'A515')
      call Buff_Remove(u,LoDBuff_BuffID[28])
    endif
    call SaveInteger(MHT,info,key,count - 1)
    call LoDStat_Sub(u,amount,"attack")
    call GroupRemoveUnit(group_temp_group,u)
  endloop
  //updates the current group with the newly affected units
  loop
    set u = FirstOfGroup(temp_group2)
    exitwhen u==null
    call GroupRemoveUnit(temp_group2,u)
    call GroupAddUnit(group_temp_group,u)
  endloop
  set u=null
  set t = null
endfunction

function Gnoll_Field_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local real x = GetSpellTargetX()
  local real y = GetSpellTargetY()
  local integer info = GetHandleId(t)
  local integer level = GetUnitAbilityLevel(u,'A2LM')
  
  call SavePlayerHandle(MHT,info,0,GetOwningPlayer(u))
  call SaveGroupHandle(MHT,info,1,GetAvailableGroup())
  call SaveEffectHandle(MHT,info,2,AddSpecialEffect("war3mapImported\\MagneticField04.mdl",x,y))
  call SaveInteger(MHT,info,0,30 + 5*level)
  call SaveInteger(MHT,info,1,40 + 10*level)
  call SaveReal(MHT,info,0,x)
  call SaveReal(MHT,info,1,y)
  
  call TimerStart(t,0.1,true,function Gnoll_Field_Duration)
  
  set t = null
  set u = null
endfunction


function Gnoll_Spark_Closest takes unit u returns nothing
  local real x = GetWidgetX(u) - group_temp_real[0]
  local real y = GetWidgetY(u) - group_temp_real[1]
  local real d = SquareRoot(x*x + y*y)
  
  if group_temp_real[2] > d then
    set group_temp_real[2] = d
    set group_temp_unit[0] = u
  endif
endfunction

function Gnoll_Spark_Targets takes nothing returns boolean
  local unit t = GetFilterUnit()
  
  if IsUnitEnemy(t,group_temp_player) and GetUnitAbilityLevel(t,'A04R')==0 and IsMagicImmune(t)==false and IsDead(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and (IsUnitType(t,UNIT_TYPE_ANCIENT)==false or IsUnitSpiritBear(t)) then
    call Gnoll_Spark_Closest(t)
  endif
  
  set t = null
  return false
endfunction

function Gnoll_Spark_Chase takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u1 = LoadUnitHandle(MHT,info,0)
  local unit u2 = LoadUnitHandle(MHT,info,1)
  local real x2
  local real y2
  local real x1
  local real y1
  
  if IsDead(u2)then
    call KillUnit(u1)
    
    call Timer_End(t)
    set u2 = null
    set u1 = null
    set t = null
    return
  endif
  
  set x1 = GetWidgetX(u1)
  set y1 = GetWidgetY(u1)
  set x2 = x1 - GetWidgetX(u2)
  set y2 = y1 - GetWidgetY(u2)
  
  if 15>SquareRoot(x2*x2 + y2*y2)then
    call DamageTarget(LoadUnitHandle(MHT,info,3),u2,1,LoadInteger(MHT,info,1))
    call KillUnit(u1)
    
    call Timer_End(t)
    set u2 = null
    set u1 = null
    set t = null
    return
  endif
  
  set x2 = Atan2(-y2,-x2)
  
  call SetUnitX(u1,x1 + 10.625*Cos(x2))
  call SetUnitY(u1,y1 + 10.625*Sin(x2))
  
  set u2 = null
  set u1 = null
  set t = null
endfunction

function Gnoll_Spark_Duration takes nothing returns nothing
  local unit u = null
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  if count==1000 then
    call KillUnit(LoadUnitHandle(MHT,info,0))
    call Timer_End(t)
    set t = null
    return
  endif
  set group_temp_player = LoadPlayerHandle(MHT,info,2)
  set group_temp_unit[0] = null
  set group_temp_real[0] = LoadReal(MHT,info,0)
  set group_temp_real[1] = LoadReal(MHT,info,1)
  set group_temp_real[2] = 450
  call GroupEnumUnitsInRange(temp_group,group_temp_real[0],group_temp_real[1],400,Condition(function Gnoll_Spark_Targets))
  call SaveInteger(MHT,info,0,count + 1)
  if group_temp_unit[0]!=null then
    set u = LoadUnitHandle(MHT,info,0)
    call SetUnitAnimationByIndex(u,2)
    call SetTint(u,-1,-1,-1,150)
    call SaveUnitHandle(MHT,info,1,group_temp_unit[0])
    call TimerStart(t,0.025,true,function Gnoll_Spark_Chase)
    set u = null
  endif
  set t = null
endfunction

function Gnoll_Spark_Delay takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  
  call TimerStart(t,0.05,true,function Gnoll_Spark_Duration)
  
  call SetUnitAnimationByIndex(LoadUnitHandle(MHT,info,0),1)
  
  set t = null
endfunction

function Gnoll_Spark_Start takes nothing returns nothing
  local timer t = CreateTimer()
  local unit u = GetTriggerUnit()
  local player p = GetOwningPlayer(u)
  local real x = GetSpellTargetX()
  local real y = GetSpellTargetY()
  local unit d = CreateUnit(p,'h0EG',x,y,270)
  local integer info = GetHandleId(t)
  
  call UnitAddAbility(d,'Aloc')
  call UnitAddAbility(d,'A04R')
  call UnitAddAbility(d,'Arav')
  
  call SaveUnitHandle(MHT,info,0,d)
  call SaveUnitHandle(MHT,info,3,u)
  call SavePlayerHandle(MHT,info,2,p)
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,1,100 + 50*GetUnitAbilityLevel(u,'A2LL'))
  call SaveReal(MHT,info,0,x)
  call SaveReal(MHT,info,1,y)
  
  call SetUnitAnimationByIndex(d,0)
  
  call TimerStart(t,3,false,function Gnoll_Spark_Delay)
  
  set p = null
  set d = null
  set u = null
  set t = null
endfunction


function Func4152 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit tempest=(LoadUnitHandle(HY,h,17))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,(GetHandleId(tempest)))
  call RemoveUnit(tempest)
  set t=null
  set tempest=null
  return false
endfunction

function Func4153 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit tempest=(LoadUnitHandle(HY,h,2))
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  call FlushChildHashtable(HY,(GetHandleId(tempest)))
  call ShowUnit(tempest,false)
  set t=null
  set tempest=null
  return false
endfunction

function Func4154 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit tempest=(LoadUnitHandle(HY,h,17))
  local integer lvl=GetUnitAbilityLevel(caster,'A2M0')
  if GetTriggerEvalCount(t)==200 or GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
    call KillUnit(tempest)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",GetUnitX(tempest),GetUnitX(tempest)))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveUnitHandle(HY,h,2,(tempest))
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function Func4153))
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,3,false)
    call TriggerAddCondition(t,Condition(function Func4152))
    call SaveUnitHandle(HY,h,17,(tempest))
  else
    call SuspendHeroXP(tempest,true)
    call UnitModifySkillPoints(tempest,-25)
  endif
  set t=null
  set caster=null
  set tempest=null
  return false
endfunction

function Zet_Tempest_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit tempest
  local integer lvl=GetUnitAbilityLevel(caster,'A2M0')
  local integer i=0
  local item it
  local integer dummyItemId='I02M'
  local integer pid=GetPlayerId(GetOwningPlayer(caster))
  call DisableTrigger(HeroEnters)
  set tempest=CreateUnit(GetOwningPlayer(caster),GetUnitTypeId(caster),GetUnitX(caster),GetUnitY(caster),0)
  call EnableTrigger(HeroEnters)
  //call SetUnitVertexColor(tempest,255,255,255,130)
  call SetTint(tempest,-1,-1,-1,130)
  call SaveBoolean(HY,GetHandleId(tempest),TEMPEST,true)
  call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",tempest,"chest"))
  if IsSentinel(GetOwningPlayer(tempest))==false then
  endif
  call SelectUnitAddForPlayer(tempest,GetOwningPlayer(caster))
  call DisableTrigger(t_manipulateitem)
  loop
    exitwhen i>5
    if UnitItemInSlot(caster,i)!=null and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[indexid_Aegis]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[indexid_RefresherOrb]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[indexid_ObserverWards]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[indexid_SentryWards]and GetItemTypeId(UnitItemInSlot(caster,i))!=Item_Real[indexid_Smoke]then
      set it=CreateItem(GetItemTypeId(UnitItemInSlot(caster,i)),0,0)
      if GetItemCharges(UnitItemInSlot(caster,i))>0 then
        call SetItemCharges(it,GetItemCharges(UnitItemInSlot(caster,i)))
      endif
      call UnitAddItem(tempest,it)
      call SetItemPlayer(it,GetOwningPlayer(tempest),false)
      if GetItemTypeId(it)==Item_Real[indexid_DivineRapier]or GetItemTypeId(it)==Item_Real[indexid_DivineRapierFree]or GetItemTypeId(it)==Item_Real[indexid_Gem]then
        call SetItemDropOnDeath(it,false)
      endif
    else
      call UnitAddItem(tempest,CreateItem(dummyItemId,0,0))
    endif
    set i=i+1
  endloop
  call EnableTrigger(t_manipulateitem)
  call SetHeroLevel(tempest,GetHeroLevel(caster),false)
  set i=1
  loop
    exitwhen i>GetUnitAbilityLevel(caster,'Aamk')
    call SelectHeroSkill(tempest,'Aamk')
    set i=i+1
  endloop
  call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
  call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
  call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
  call UnitAddAbility2(tempest,EngineeringUpgradeSkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
  
  set i=1
  loop
    exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
    call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+1]])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
    call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+2]])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
    call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+3]])
    set i=i+1
  endloop
  set i=1
  loop
    exitwhen i>GetUnitAbilityLevel(caster,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
    call SelectHeroSkill(tempest,SkillID[PlayerSkillNumber[pid*PlayerSkillOffset+4]])
    set i=i+1
  endloop
  call UnitRemoveAbility(tempest,'A2M0')
  call UnitModifySkillPoints(tempest,-25)
  call SuspendHeroXP(tempest,true)
  call TriggerRegisterTimerEvent(t,0.1,true)
  call TriggerRegisterDeathEvent(t,tempest)
  call TriggerAddCondition(t,Condition(function Func4154))
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(tempest))
  call SetWidgetLife(caster,GetWidgetLife(caster)*(1-(0.45-0.15*lvl)))
  call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)*(1-(0.45-0.15*lvl)))
  call SetWidgetLife(tempest,GetWidgetLife(caster))
  call SetUnitState(tempest,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA))
  set caster=null
  set tempest=null
  set t=null
  set it=null
endfunction


function Wyvern_Burn_Buff takes unit u returns boolean
  return GetUnitAbilityLevel(u,'D100')==1 or GetUnitAbilityLevel(u,'D101')==1 or GetUnitAbilityLevel(u,'D102')==1 or GetUnitAbilityLevel(u,'D103')==1
endfunction

function Wyvern_Burn_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local real life
  if count==4 or IsDead(u) or Wyvern_Burn_Buff(u)==false then
    call DestroyEffect(LoadEffectHandle(MHT,info,1))
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  set life = GetWidgetLife(u)
  set life = life - life*0.09
  if 0.405 > life then
    set life = 0.406
  endif
  call SetWidgetLife(u,life)
  call SaveInteger(MHT,info,0,count + 1)
  set t = null
  set u = null
endfunction

function Wyvern_Burn_Effect takes unit u, unit d, integer level returns nothing
  local timer t = CreateTimer()
  local integer info = GetHandleId(t)
  call Buff_Add(d,'C100' + level,'D100' + level,5)
  call SaveUnitHandle(MHT,info,0,d)
  call SaveEffectHandle(MHT,info,1,AddSpecialEffectTarget("Abilities\\Spells\\Other\\FrostDamage\\FrostDamage.mdl",d,"chest"))
  call SaveInteger(MHT,info,0,0)
  call TimerStart(t,1,true,function Wyvern_Burn_Duration)
  set t = null
endfunction

function Wyvern_Burn_Damage_Detect takes nothing returns nothing
  local unit u = null
  local trigger t = GetTriggeringTrigger()
  local integer h = GetHandleId(t)
  if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
    call CleanTrigger(t)
    call FlushChildHashtable(MHT,h)
    set t = null
    return
  endif
  set u = GetEventDamageSource()
  if u==LoadUnitHandle(MHT,h,0) and GetEventDamage()>5 then
    call Wyvern_Burn_Effect(u,GetTriggerUnit(),LoadInteger(MHT,h,0)-1)
    call CleanTrigger(t)
    call FlushChildHashtable(MHT,h)
  endif
  set t = null
  set u = null
endfunction

function Wyvern_Burn_Damage_Start takes unit u, unit t returns nothing
  local trigger trig = CreateTrigger()
  call SaveUnitHandle(MHT,GetHandleId(trig),0,u)
  call TriggerRegisterUnitEvent(trig,t,EVENT_UNIT_DAMAGED)
  call TriggerRegisterTimerEvent(trig,3,false)
  call SaveInteger(MHT,GetHandleId(trig),0,GetUnitAbilityLevel(u,'A332'))
  call TriggerAddCondition(trig,Condition(function Wyvern_Burn_Damage_Detect))
  set trig = null
endfunction

function Wyvern_Burn_Attack_Condition takes unit u, unit t returns nothing
  if GetUnitAbilityLevel(u,LoDBuff_BuffID[29])==1 and GetUnitAbilityLevel(t,'A04R')==0 and Wyvern_Burn_Buff(t)==false and IsUnitType(t,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(u,GetOwningPlayer(t)) and GetUnitTypeId(t)!='n00L'then
    call Wyvern_Burn_Damage_Start(u,t)
  endif
endfunction

function Wyvern_Burn_End takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  local integer lvl
  local integer h
  if IsDead(u)==false and LoadBoolean(MHT,GetHandleId(u),StringHash("morphedburn")) then
    call UnMorphUnit(u,LoadInteger(MHT,info,1))
    call UnMorphUnit(u,LoadInteger(MHT,info,0))
    call KillTrees(GetWidgetX(u),GetWidgetY(u),150)
    call SaveBoolean(MHT,GetHandleId(u),StringHash("morphedburn"),false)
    call SaveInteger(MHT,GetHandleId(u),StringHash("morphedburn"),0)
    call RemoveAbilsForUnit(u)
    if GetUnitAbilityLevel(u,'A2AI')>0 then
      call UnitRemoveAbility(u,'QF0O')
      call SetUnitAbilityLevel(u,'QB0G',GetUnitAbilityLevel(u,'A2AI'))
    endif
    call Timer_End(t)
  elseif IsDead(u) and LoadBoolean(MHT,GetHandleId(u),StringHash("morphedburn")) then
    call TimerStart(t,1,true,function Wyvern_Burn_End)
  endif
  set t = null
  set u = null
endfunction

function Wyvern_Burn_Start takes nothing returns nothing
  local unit u = GetTriggerUnit()
  if GetUnitTypeId(u)!='N0MA' and GetUnitTypeId(u)!='N0MO' and GetUnitTypeId(u)!='N0MB' and GetUnitTypeId(u)!='N0MC' then
    call RemoveAbilsForUnit(u)
    call Buff_Add(u,LoDBuff_AbilID[29],LoDBuff_BuffID[29],6)
  else
    call KillTrees(GetUnitX(u),GetUnitY(u),200)
  endif
  set u = null
endfunction

function SplinterBlast_TargetsAvailable takes nothing returns boolean
  return IsUnitEnemy(tt_unit1,GetOwningPlayer(GetFilterUnit()))and(AliveNonBuildOrMarker(GetFilterUnit()))and IsNonAncient(GetFilterUnit())
endfunction

function Func4060 takes nothing returns nothing
  local integer h=GetHandleId(GetTriggeringTrigger())
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit target=TempTarget
  local integer lvl=LoadInteger(HY,h,0)
  if IsMagicImmune(target)==false then
    call DamageTarget(caster,target,1,20+80*lvl)
    call Buff_Add(target,LoDBuff_AbilID[30],LoDBuff_BuffID[30],4)
    call AddTimedAbility(target,'A2MJ',1,4)
  endif
  set caster=null
  set target=null
endfunction

function Func4061 takes nothing returns nothing
  local unit u=Wyvern_SplinterBlast_InitialCaster
  local unit target=GetEnumUnit()
  local trigger t=CreateDummyProjectile(Wyvern_SplinterBlast_Helper,target,'h0EC',"Func4060",600)
  local integer h=GetHandleId(t)
  call SaveUnitHandle(HY,h,2,u)
  call SaveInteger(HY,h,0,tt_int1)
  set u=null
  set target=null
  set t=null
endfunction

function Func4062 takes unit caster,unit target, integer lvl returns nothing
  local group g=GetAvailableGroup()
  set tt_unit1=caster
  set Wyvern_SplinterBlast_InitialCaster=caster
  set Wyvern_SplinterBlast_Helper=target
  set tt_int1=lvl
  call GroupEnumUnitsInRange(g,GetUnitX(target),GetUnitY(target),525,Condition(function SplinterBlast_TargetsAvailable))
  call GroupRemoveUnit(g,target)
  call ForGroup(g,function Func4061)
  call KillGroup(g)
  set caster=null
  set target=null
  set g=null
endfunction

function Func4063 takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,2)
  local unit target=LoadUnitHandle(HY,h,17)
  local unit proj=LoadUnitHandle(HY,h,45)
  local real px=GetUnitX(proj)
  local real py=GetUnitY(proj)
  local real tx=GetUnitX(target)
  local real ty=GetUnitY(target)
  local real distance=DistanceBetweenXY(tx,ty,px,py)
  local integer count=GetTriggerEvalCount(t)
  local real angle=AngleBetweenXY(px,py,tx,ty)
  local real newX
  local real newY
  local real speed=distance/((1.35/.02)-count)
  if speed<500*0.02 then
    set speed=500*0.02
  endif
  set newX=px+speed*Cos(angle*bj_DEGTORAD)
  set newY=py+speed*Sin(angle*bj_DEGTORAD)
  call SetUnitX(proj,newX)
  call SetUnitY(proj,newY)
  call SetUnitFacing(proj,angle)
  if DistanceBetweenXY(tx,ty,newX,newY)<=speed then
    call KillUnit(proj)
    call Func4062(caster,target,LoadInteger(HY,h,0))
    call FlushChildHashtable(HY,h)
    call CleanTrigger(t)
  endif
  set t=null
  set target=null
  set caster=null
  set proj=null
  return false
endfunction

function Wyvern_SplinterBlast_Start takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit proj=CreateUnit(GetOwningPlayer(caster),'e01E',GetUnitX(caster),GetUnitY(caster),0)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerAddCondition(t,Condition(function Func4063))
  call SaveUnitHandle(HY,h,2,caster)
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
  call SaveUnitHandle(HY,h,17,target)
  call SaveUnitHandle(HY,h,45,proj)
  set caster=null
  set target=null
  set proj=null
  set t=null
endfunction


function Wyvern_Embrace_Duration takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  local real life
  if count==40 or IsDead(u) or IsUnitHidden(u) or GetUnitAbilityLevel(u,'BNdo')>0 then
    set count = 1
    loop
      exitwhen count==10
      call DestroyEffect(LoadEffectHandle(MHT,info,count))
      set count = count + 1
    endloop
    set info = GetHandleId(u)
    set count = LoadInteger(MHT,info,'A516')
    if count==1then
      call UnitRemoveAbility(u,'A516')
    endif
    call SaveInteger(MHT,info,'A516',count - 1)
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  set life = GetWidgetLife(u)
  call SetWidgetLife(u,life + 2 + GetUnitState(u,UNIT_STATE_MAX_LIFE)*LoadReal(MHT,info,0))
  call SaveInteger(MHT,info,0,count + 1)
  set t = null
  set u = null
endfunction

function Wyvern_Embrace_Start takes nothing returns nothing
  local timer t = null
  local integer info
  local unit u = GetTriggerUnit()
  local unit u2 = GetSpellTargetUnit()
  local unit dummy=CreateUnit(GetOwningPlayer(u2),'e00E',GetUnitX(u2),GetUnitY(u2),0)
  call UnitAddAbility(dummy,'A2LG')
  if IssueTargetOrder(dummy,"thunderbolt",u2)==true then 
    set t = CreateTimer()
    set info = GetHandleId(t)
    call SaveUnitHandle(MHT,info,0,u2)
    call SaveReal(MHT,info,0,GetUnitAbilityLevel(udg_Hero[GetPlayerId(GetOwningPlayer(u))],'A2LB')*0.001 + 0.002)
    call SaveInteger(MHT,info,0,0)
    call SaveEffectHandle(MHT,info,1,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"hand right"))
    call SaveEffectHandle(MHT,info,2,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"hand left"))
    call SaveEffectHandle(MHT,info,3,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot right"))
    call SaveEffectHandle(MHT,info,4,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot left"))
    call SaveEffectHandle(MHT,info,5,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot right mount rear"))
    call SaveEffectHandle(MHT,info,6,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"foot left mount rear"))
    call SaveEffectHandle(MHT,info,7,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"head"))
    call SaveEffectHandle(MHT,info,8,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,"chest"))
    call SaveEffectHandle(MHT,info,9,AddSpecialEffectTarget("war3mapImported\\Cryofreeze5.mdx",u2,GetProperAttachPoint_Weapon(u2)))
    call UnitAddAbility(u2,'A516')
    call SaveInteger(MHT,GetHandleId(u2),'A516',LoadInteger(MHT,GetHandleId(u2),'A516') + 1) //for multicast stacking
    call TimerStart(t,0.1,true,function Wyvern_Embrace_Duration)
    set t = null
  endif
  set dummy=null
  set u2 = null
  set u = null
  set t = null
endfunction

function Wyvern_Curse_Reorder takes unit u returns nothing
  if GetUnitAbilityLevel(u,LoDBuff_BuffID[31])>0 and UnitIsSleeping(u)==false and GetUnitAbilityLevel(u,'B008')==0 and HW8==false then
    call DisableTrigger(GAME_TRIGGER)
    call IssueTargetOrder(u,"attack",LoadUnitHandle(MHT,GetHandleId(u),'A0Z0'))
    call EnableTrigger(GAME_TRIGGER)
  endif
endfunction

function Wyvern_Curse_ForceAttack takes nothing returns nothing
  local unit u=GetEnumUnit()
  call DisableTrigger(trig_WintersCurse)
  call UnitWakeUp(u)
  call IssueTargetOrder(u,"attack",unit_WinterCurseTarget)
  call EnableTrigger(trig_WintersCurse)
  set u=null
endfunction

function Wyvern_Curse_AddKeys takes nothing returns nothing
  call AddTimedKeyToUnit(GetEnumUnit(),4328,0.75)
endfunction

function Wyvern_Curse_ForGroup takes nothing returns nothing
  local unit u=GetEnumUnit()
  if IsUnitInGroup(u,group_WinterCurse)==false then
    call GroupAddUnit(group_WinterCurse,u)
    call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
    call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trig_WintersCurse,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
    call SaveInteger(HY,GetHandleId(u),4328,1)
  endif
  set u=null
endfunction

function Wyvern_Curse_Duration takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=(LoadUnitHandle(HY,h,2))
  local unit target=(LoadUnitHandle(HY,h,17))
  local integer lvl=(LoadInteger(HY,h,5))
  local integer counter=(LoadInteger(HY,h,34))
  local group g=(LoadGroupHandle(HY,h,22))
  local group gg
  if GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_POINT_ORDER and GetTriggerEventId()!=EVENT_UNIT_ISSUED_TARGET_ORDER then
    set counter=counter+1
    call SaveInteger(HY,h,(34),(counter))
    set group_WinterCurse=g
    set trig_WintersCurse=t
    set gg=GetAvailableGroup()
    set tt_unit1=caster
    call GroupEnumUnitsInRange(gg,GetUnitX(target),GetUnitY(target),375,Condition(function NonImmuneEnemyFilter))
    call GroupRemoveUnit(gg,target)
    call ForGroup(gg,function Wyvern_Curse_ForGroup)
    call KillGroup(gg)
    if counter==(2.25+0.25*lvl)*20 or IsDead(target)then
      call ForGroup(g,function Wyvern_Curse_AddKeys)
      call UnitRemoveAbility(target,'A342')
      call KillGroup(g)
      call DestroyEffect((LoadEffectHandle(HY,h,(32))))
      call DestroyEffect((LoadEffectHandle(HY,h,(176))))
      call FlushChildHashtable(HY,h)
      call CleanTrigger(t)
    else
      set trig_WintersCurse=t
      set unit_WinterCurseTarget=target
      call ForGroup(g,function Wyvern_Curse_ForceAttack)
      if ModuloInteger(counter,20)==0 or counter==0 then
      endif
    endif
  else
    if UnitIsSleeping(GetTriggerUnit())==false and GetUnitAbilityLevel(GetTriggerUnit(),'B008')==0 and GetIssuedOrderId()!=851973 then
      call DisableTrigger(t)
      call ClearSelectionForPlayer(GetOwningPlayer(GetTriggerUnit()))
      call IssueTargetOrder(GetTriggerUnit(),"attack",target)
      call EnableTrigger(t)
    endif
  endif
  set t=null
  set caster=null
  set target=null
  set g=null
  set gg=null
  return false
endfunction

function Wyvern_Curse_Acts takes nothing returns nothing
  local unit caster=GetTriggerUnit()
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local integer lvl=GetUnitAbilityLevel(caster,'A0Z0')
  local unit target=GetSpellTargetUnit()
  local unit dummy=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(target),GetUnitY(target),0)
  set unit_WinterCurseCaster=caster
  call UnitAddAbility2(target,'A342')
  call UnitAddAbility(dummy,'A2NJ')
  call SetUnitAbilityLevel(dummy,'A2NJ',lvl)
  call IssueTargetOrder(dummy,"thunderbolt",target)
  call TriggerRegisterTimerEvent(t,0.05,true)
  call SaveUnitHandle(HY,h,2,(caster))
  call SaveUnitHandle(HY,h,17,(target))
  call SaveInteger(HY,h,5,(lvl))
  call SaveGroupHandle(HY,h,(22),(GetAvailableGroup()))
  call SaveEffectHandle(HY,h,(32),(AddSpecialEffectTarget("war3mapImported\\WintersCurse.mdx",target,"overhead")))
  call SaveEffectHandle(HY,h,(176),(AddSpecialEffect("war3mapImported\\WintersCurseAoE.mdx",GetUnitX(target),GetUnitY(target))))
  call TriggerAddCondition(t,Condition(function Wyvern_Curse_Duration))
  set caster=null
  set target=null
  set dummy=null
  set t=null
endfunction

function Wyvern_Curse_Real_Start takes nothing returns nothing
  if IsBlocked(GetSpellTargetUnit())==false then
    call Wyvern_Curse_Acts()
  endif
endfunction

function Shadow_Amulet_Effect takes nothing returns nothing
  local unit d = null
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local integer count = LoadInteger(MHT,info,0)
  local unit u = LoadUnitHandle(MHT,info,0)
  if IsDead(u) or (GetUnitAbilityLevel(u,'B0G8')==0 and count > LoadInteger(MHT,info,2)) or (LoadBoolean(MHT,info,0) and (LoadReal(MHT,info,0)!=GetWidgetX(u) or LoadReal(MHT,info,1)!=GetWidgetY(u))) then
    call SaveBoolean(MHT,GetHandleId(u),'A2N5',false)
    call UnitRemoveAbility(u,'B0G8')
    call Timer_End(t)
    set t = null
    set u = null
    return
  endif
  if count==LoadInteger(MHT,info,2) then
    set d = CreateUnit(Player(15),'e00E',0,0,0)
    call UnitAddAbility(d,'A2N5')
    call IssueTargetOrder(d,"invisibility",u)
    call SaveBoolean(MHT,GetHandleId(u),'A2N5',false)
    set d = null
    call IssueImmediateOrder(u,"holdposition")
    call SaveReal(MHT,info,0,GetWidgetX(u))
    call SaveReal(MHT,info,1,GetWidgetY(u))
    call SaveBoolean(MHT,info,0,true)
  endif
  
  call SaveInteger(MHT,info,0,count + 1)
  
  set t = null
  set u = null
endfunction

function Shadow_Amulet_Setup takes nothing returns nothing
  local timer t = GetExpiredTimer()
  local integer info = GetHandleId(t)
  local unit u = LoadUnitHandle(MHT,info,0)
  call SaveInteger(MHT,info,0,0)
  call SaveInteger(MHT,info,2,R2I(1.5/0.05))
  call TimerStart(t,0.05,true,function Shadow_Amulet_Effect)
  set t = null
  set u = null
endfunction

function Shadow_Amulet_Start takes unit u returns nothing
  local timer t = CreateTimer()
  local string s = ""
  if GetOwningPlayer(u)==GetLocalPlayer()then
    set s = "Abilities\\Spells\\Undead\\DeathandDecay\\DeathandDecayTarget.mdl"
  endif
  
  call DestroyEffect(AddSpecialEffectTarget(s,u,"chest"))
  call DestroyEffect(AddSpecialEffectTarget(s,u,"hand,left"))
  call DestroyEffect(AddSpecialEffectTarget(s,u,"hand,right"))
  
  call SaveUnitHandle(MHT,GetHandleId(t),0,u)
  call TimerStart(t,0.01,false,function Shadow_Amulet_Setup)
  
  set t = null
endfunction

function Shadow_Amulet_Condition takes nothing returns nothing
  local unit u = GetTriggerUnit()
  local unit target=GetSpellTargetUnit()
  local integer info = GetHandleId(target)
  if target==null and GetSpellTargetItem()!=null then
    set target=u
    set info = GetHandleId(target)
  endif
  if target!=null then
    if LoadBoolean(MHT,info,'A2N5')==false then
      call SaveBoolean(MHT,info,'A2N5',true)
      call Shadow_Amulet_Start(target)
    endif
  endif
  set target=null
  set u = null
endfunction

function KotaKotaWindsFilter takes nothing returns boolean
  if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsDead(GetFilterUnit())==false and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
    if IsBuggyFlying(GetFilterUnit())==false then
      call UnitAddAbility2(GetFilterUnit(),'Amrf')
      call UnitRemoveAbility(GetFilterUnit(),'Amrf')
    endif
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Polymorph\\PolyMorphTarget.mdl",GetFilterUnit(),"origin"))
    call UnitAddAbility2(GetFilterUnit(),'A45G')
    //call SaveEffectHandle(HY,GetHandleId(LoadTriggerHandle(TempHash,'KOTA',0)),GetHandleId(GetFilterUnit()),AddSpecialEffectTarget("war3mapImported\\MistAura.mdx",GetFilterUnit(),"origin"))
    call TriggerRegisterDeathEvent(LoadTriggerHandle(TempHash,'KOTA',0),GetFilterUnit())
    call TriggerRegisterUnitEvent(LoadTriggerHandle(TempHash,'KOTA',0),GetFilterUnit(),EVENT_UNIT_DAMAGED)
    return true
  endif
  return false
endfunction

function KotaKotaDistrib takes nothing returns nothing
  local unit u=GetEnumUnit()
  if u!=LoadUnitHandle(TempHash,'KOTA',0)then
    call DamageTarget(GetEventDamageSource(),u,3,LoadReal(TempHash,'KOTA',0))
  endif
  set u=null
endfunction

function KotaKotaWindsLinks takes unit u, group g, real dmg, integer c returns nothing
  call SaveReal(TempHash,'KOTA',0,dmg/c)
  call SaveUnitHandle(TempHash,'KOTA',0,u)
  call ForGroup(g,function KotaKotaDistrib)
  call HealUnitFor(u,dmg)
endfunction

function KotaKotaWindsDur takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u
  local group g=LoadGroupHandle(HY,h,0)
  local integer lvl=LoadInteger(HY,h,0)
  local integer c=LoadInteger(HY,h,3)+1
  local integer height=LoadInteger(HY,h,706)
  local group gg=LoadGroupHandle(HY,h,1)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call DestroyEffect(LoadEffectHandle(HY,h,GetHandleId(GetTriggerUnit())))
    if IsBuggyFlying(GetTriggerUnit())==false then
      call SetUnitFlyHeight(GetTriggerUnit(),GetUnitDefaultFlyHeight(GetTriggerUnit()),0)
    endif
    call UnitRemoveAbility(GetTriggerUnit(),'A45G')
    call UnitRemoveAbility(GetTriggerUnit(),'B45G')
    call GroupRemoveUnit(g,GetTriggerUnit())
    set t=null
    return
  elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    if LoadBoolean(HY,h,0)==false and GetEventDamage()>0 and GetEventDamage()<8000 then
      call SaveBoolean(HY,h,0,true)
      call KotaKotaWindsLinks(GetTriggerUnit(),g,GetEventDamage()*(0.35+0.15*lvl),CountUnitsInGroup(g))
      call SaveBoolean(HY,h,0,false)
    endif
    set t=null
    return
  endif
  if c > 50 * (lvl+2) then
    loop
      set u=FirstOfGroup(g)
      exitwhen u==null
      if IsBuggyFlying(u)==false then
        call SetUnitFlyHeight(u,GetUnitDefaultFlyHeight(u),0)
      endif
      call DestroyEffect(LoadEffectHandle(HY,h,GetHandleId(u)))
      call UnitRemoveAbility(u,'A45G')
      call UnitRemoveAbility(u,'B45G')
      call GroupRemoveUnit(g,u)
    endloop
    call KillGroup(g)
    call KillGroup(gg)
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  else
    call SaveInteger(HY,h,3,c)
    if c < 50 * (lvl+2) - 15 then
      if(LoadInteger(HY,h,707))==1 then
        set height=height+1
      else
        set height=height-1
      endif
      call SaveInteger(HY,h,706,height)
      if height==10 then
        call SaveInteger(HY,h,707,-1)
      elseif height==-10 then
        call SaveInteger(HY,h,707,1)
      endif
      call GroupAddGroup(g,gg)
      loop
        set u=FirstOfGroup(gg)
        exitwhen u==null
        if IsBuggyFlying(u)==false then
          if c<15 then
            call SetUnitFlyHeight(u,c*7,0)
          else
            call SetUnitFlyHeight(u,100+height,0)
          endif
        endif
        call GroupRemoveUnit(gg,u)
      endloop
    else
      call GroupAddGroup(g,gg)
      loop
        set u=FirstOfGroup(gg)
        exitwhen u==null
        if IsBuggyFlying(u)==false then
          call SetUnitFlyHeight(u,100-7*(c-(50 * (lvl+2) - 15)),0)
        endif
        call GroupRemoveUnit(gg,u)
      endloop
    endif
  endif
  
  
  set t=null
endfunction

function KotaKotaWinds takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local group g=GetAvailableGroup()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  call SaveTriggerHandle(TempHash,'KOTA',0,t)
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),600,Condition(function KotaKotaWindsFilter))
  call SaveGroupHandle(HY,h,0,g)
  call SaveInteger(HY,h,0,lvl)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call RemoveSavedHandle(TempHash,'KOTA',0)
  call TriggerAddCondition(t,Condition(function KotaKotaWindsDur))
  call SaveInteger(HY,h,706,0)
  call SaveInteger(HY,h,707,1)
  call SaveGroupHandle(HY,h,1,GetAvailableGroup())
  set t=null
  set u=null
endfunction

function KotaKotaGuardDur takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetTriggerEventId()==EVENT_WIDGET_DEATH then
    call UnitRemoveAbility(u,'A45N')
    call UnitRemoveAbility(u,'A45K')
    call UnitRemoveAbility(u,'A45L')
    call CleanTrigger(t)
    call FlushChildHashtable(HY,h)
  else
    if GetUnitCurrentOrder(u)!=851973 then
      if GetUnitAbilityLevel(u,'A45K')>0 then
        call UnitRemoveAbility(u,'A45K')
        call UnitRemoveAbility(u,'A45L')
      endif
      call SetWidgetLife(u,GetWidgetLife(u)+(20+5*LoadInteger(HY,h,0)/50))
    else
      if GetUnitAbilityLevel(u,'A45K')==0 then
        call UnitAddAbility3(u,'A45K',LoadInteger(HY,h,0))
        call UnitAddAbility2(u,'A45M')
        call SetUnitAbilityLevel(u,'A45L',LoadInteger(HY,h,0))
        call UnitMakeAbilityPermanent(u,true,'A45L')
      endif
    endif
  endif
  set t=null
  set u=null
endfunction

function KotaKotaGuard takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer lvl=GetUnitAbilityLevel(u,GetSpellAbilityId())
  local trigger t=CreateTrigger()
  local integer h=GetHandleId(t)
  local unit target=GetSpellTargetUnit()
  call SaveUnitHandle(HY,h,0,target)
  call TriggerRegisterDeathEvent(t,target)
  call TriggerRegisterTimerEvent(t,0.02,true)
  call TriggerAddCondition(t,Condition(function KotaKotaGuardDur))
  call SaveInteger(HY,h,0,lvl)
  call UnitAddAbility2(target,'A45N')
  set t=null
  set target=null
  set u=null
endfunction

function CrimsonGuard_Filter takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(tt_unit1)) and IsDead(GetFilterUnit())==false and LoadInteger(HY,GetHandleId(GetFilterUnit()),'CRMS')!=1
endfunction

function CrimsonGuard_Defense takes nothing returns nothing
  call AddTimedKeyToUnit(GetEnumUnit(),'CRMS',70)
  call AddTimedAbility(GetEnumUnit(),'A42L',1,10)
  call UnitAddAbilityTimedEx(GetEnumUnit(),'A42N',1,10,'B0HG')
  call UnitAddAbilityTimedEx(GetEnumUnit(),'A45A',1,10,0)
endfunction

function CrimsonGuard_Act takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local group g=GetAvailableGroup()
  set tt_unit1=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),750+25,Condition(function CrimsonGuard_Filter))
  call ForGroup(g,function CrimsonGuard_Defense)
  
  call KillGroup(g)
  set u=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  call UnitAddAbility(u,'AIda')
  call IssueImmediateOrderById(u,852269)
  set g=null
  set u=null
endfunction

function Butterfly_FlutterDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if LoadReal(HY,h,0) < TimerGetElapsed(GlobalTimer) then
    call UnitRemoveAbility(u,'A42Y')
    call UnitRemoveAbility(u,'B0HK')
    if FindItemOfType(u,Item_Real[indexid_Butterfly])!=null then
      call UnitAddAbility2(u,'A431')
      call UnitMakeAbilityPermanent(u,true,'AIev')
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
    call RemoveSavedHandle(HY,GetHandleId(u),'AIev')
  else
    
  endif
  set t=null
  set u=null
endfunction

function Butterfly_Flutter takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local timer t
  if HaveSavedHandle(HY,GetHandleId(u),'AIev') then
    set t=LoadTimerHandle(HY,GetHandleId(u),'AIev')
  else
    set t=CreateTimer()
    call UnitRemoveAbility(u,'AIev')
    call TimerStart(t,0.5,true,function Butterfly_FlutterDur)
    call SaveUnitHandle(HY,GetHandleId(t),0,u)
    call SaveTimerHandle(HY,GetHandleId(u),'AIev',t)
  endif
  call SaveReal(HY,GetHandleId(t),0,TimerGetElapsed(GlobalTimer)+8)
  call UnitRemoveAbility(u,'A431')
  call CountEvasionPercent(u)
  call UnitAddAbility2(u,'A42Y')
  set t=null
  set u=null
endfunction

function Silencer_LastWordPassive_Act takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit caster=LoadUnitHandle(HY,h,0)
  local unit silencer=LoadUnitHandle(HY,h,1)
  local unit d
  if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
    set d=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
    call UnitAddAbility(d,'A33T')
    call SetUnitAbilityLevel(d,'A33T',GetUnitAbilityLevel(silencer,'A33O'))
    call IssueTargetOrder(d,"drunkenhaze",caster)
    set d=null
  endif
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
  set caster=null
  set silencer=null
endfunction

function Silencer_LastWordPassive_FindSilencer takes nothing returns boolean
  return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)==true and IsDead(GetFilterUnit())==false and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) and GetUnitAbilityLevel(GetFilterUnit(),'A33O')>0
endfunction

function Silencer_LastWordPassive_Check takes unit caster, integer aid returns nothing
  local trigger t
  local integer h
  local group g
  local unit silencer
  if BalanceOffSpellChecker(aid)==false then
    return
  endif
  set t=CreateTrigger()
  set h=GetHandleId(t)
  set g=GetAvailableGroup()
  call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),800,Condition(function Silencer_LastWordPassive_FindSilencer))
  set silencer=FirstOfGroup(g)
  call KillGroup(g)
  set g=null
  call TriggerRegisterTimerEvent(t,10,false)
  call TriggerRegisterUnitEvent(t,caster,EVENT_UNIT_SPELL_ENDCAST)
  call TriggerAddCondition(t,Condition(function Silencer_LastWordPassive_Act))
  call SaveUnitHandle(HY,h,0,caster)
  call SaveUnitHandle(HY,h,1,silencer)
  set silencer=null
  set t=null
endfunction

function UrnaSwarmInfestC takes nothing returns nothing
  call IssueTargetOrder(SwarmTempUnit,"soulburn",GetEnumUnit())
endfunction

function UrnaSwarmInfestB takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  local unit d=CreateUnit(GetOwningPlayer(u),'e00E',x,y,0)
  local group g=GetAvailableGroup()
  local unit u2
  call UnitAddAbility(d,'A1GG')
  set tt_unit1=u
  call GroupEnumUnitsInRange(g,x,y,300,Condition(function DefaultEnemyFilter))
  loop
    set u2=FirstOfGroup(g)
    exitwhen u2==null
    call IssueTargetOrder(d,"soulburn",u2)
    call GroupRemoveUnit(g,u2)
  endloop
  call KillGroup(g)
  call KillUnit(u)
  call SetUnitAnimation(u,"death")
  call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadLargeDeathExplode\\UndeadLargeDeathExplode.mdl",x,y))
  set u=null
  set d=null
  set g=null
endfunction

function UrnaSwarmInfest takes nothing returns boolean
  if GetSpellAbilityId()=='A1HH' then
    call UrnaSwarmInfestB()
  endif
  return false
endfunction

function SkadiSlowTick takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  if TimerGetElapsed(GlobalTimer)>LoadReal(HY,h,0) or GetUnitAbilityLevel(LoadUnitHandle(HY,h,0),'A40W')==0 then
    call RestoreTint(LoadUnitHandle(HY,h,0))
    call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'A40W')
    call UnitRemoveAbility(LoadUnitHandle(HY,h,0),'B0HF')
    call RemoveSavedHandle(HY,GetHandleId(LoadUnitHandle(HY,h,0)),'A40W')
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  endif
  set t=null
endfunction

function SkadiSlow takes unit u, boolean melee returns nothing
  local timer t=LoadTimerHandle(HY,GetHandleId(u),'A40W')
  local integer h
  if t!=null then
    set h=GetHandleId(t)
  else
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,0.1,true,function SkadiSlowTick)
    call UnitAddAbility2(u,'A40W')
    call SaveUnitHandle(HY,h,0,u)
    call SaveTimerHandle(HY,GetHandleId(u),'A40W',t)
  endif
  if melee then
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+5)
  else
    call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+3)
  endif
  call ApplyFrostColor(u)
  set t=null
endfunction

function OrbOfVenomDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer c=LoadInteger(HY,h,0)+1
  local real hp
  local unit u=LoadUnitHandle(HY,h,0)
  if c==4 or GetUnitAbilityLevel(u,'Bpsd')==0 then
    call FlushChildHashtable(HY,h)
    call PauseTimer(t)
    call DestroyTimer(t)
  else
    call SaveInteger(HY,h,0,c)
    set hp=GetWidgetLife(u)
    if hp>6 then
      call DamageTarget(LoadUnitHandle(HY,h,1),u,1,4)
    else
      call SetWidgetLife(u,RMaxIF(1,hp-4))
    endif
  endif
  set u=null
  set t=null
endfunction

function OrbOfVenomApply takes unit attacker, unit target returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,1,true,function OrbOfVenomDur)
  call SaveUnitHandle(HY,h,0,target)
  call SaveUnitHandle(HY,h,1,attacker)
  set t=null
endfunction

function PoisonStingDur takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local integer lvl=LoadInteger(HY,h,0)
  local unit veno=LoadUnitHandle(HY,h,0)
  local unit target=LoadUnitHandle(HY,h,1)
  if GetUnitAbilityLevel(target,'Bpsd')==0 then
    call RemoveSavedHandle(MHT,GetHandleId(target),'Pois')
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
  else
    call DamageTarget(veno,target,1,5*lvl)
  endif
  set veno=null
  set target=null
  set t=null
endfunction

function PoisonStingApply takes unit attacker, unit target returns nothing
  local timer t
  local integer h
  local integer hu=GetHandleId(target)
  if HaveSavedHandle(MHT,hu,'Pois') then
    set t=LoadTimerHandle(MHT,hu,'Pois')
    set h=GetHandleId(t)
  else
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,1,true,function PoisonStingDur)
    call SaveUnitHandle(HY,h,0,attacker)
    call SaveUnitHandle(HY,h,1,target)
    call SaveTimerHandle(MHT,hu,'Pois',t)
  endif
  call SaveInteger(HY,h,0,GetUnitAbilityLevel(attacker,'P418'))
  set t=null
endfunction

function QuellingBladeDmg takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit target=LoadUnitHandle(HY,h,1)
  local unit attacker
  local real dmg
  if IsDead(target)==false then
    set attacker=LoadUnitHandle(HY,h,0)
    set dmg=LoadReal(HY,h,0)
    if GetUnitAbilityLevel(attacker,'A1AB')>0 then
      call DamageTarget(attacker,target,3,dmg*0.32)
    else
      call DamageTarget(attacker,target,3,dmg*0.12)
    endif
  endif
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set target=null
  set attacker=null
  set t=null
endfunction

function QuellingBladeBonus takes unit attacker, unit target, real dmg returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0,false,function QuellingBladeDmg)
  call SaveUnitHandle(HY,GetHandleId(t),0,attacker)
  call SaveUnitHandle(HY,GetHandleId(t),1,target)
  call SaveReal(HY,GetHandleId(t),0,dmg)
  set t=null
endfunction

function CustomUnitBountyAllyFilter takes nothing returns boolean
  return (IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GlobalKiller)) and IsDead(GetFilterUnit())==false and IsHexed(GetFilterUnit())==false)
endfunction

function CustomUnitBountyEnemyFilter takes nothing returns boolean
  return (IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) and IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GlobalKiller)) and IsDead(GetFilterUnit())==false and IsHexed(GetFilterUnit())==false)
endfunction

function GiveRealExpToUnitsAround takes nothing returns nothing
  if(GetUnitLevel(GetEnumUnit())<25 or Mode_UL)then 
    call AddHeroXP(GetEnumUnit(),GlobalKillerExp,true)
  endif
endfunction

function CustomUnitBountySystemInit takes unit killer, unit dead returns nothing
  local integer i=0
  local integer gold=0
  local integer xp=0
  local group g=null
  local group gg=null
  local integer count=0
  local boolean b=false
  local integer greed=0
  local integer greedlvl=0
  local player p
  if IsUnitType(dead,UNIT_TYPE_HERO) or IsUnitIllusion(dead) then
    set dead=null
    set killer=null
    return
  endif
  if(killer!=null) then
    set b=IsUnitAlly(killer,GetOwningPlayer(dead))
    if b then
      set i=GetUnitTypeId(dead)
      if SacrificedByLich then
        set xp=LoadInteger(UnitStats,i,EXP)
      else
        set xp=LoadInteger(UnitStats,i,EXP)/2
      endif
      
      if xp>0 then
        set g=GetAvailableGroup()
        set GlobalKiller=killer
        call GroupEnumUnitsInRange(g,GetUnitX(dead),GetUnitY(dead),EXPAOE,Condition(function CustomUnitBountyEnemyFilter))//alive non-hexed enemy heroes
        if(FirstOfGroup(g)!=null)then
          set GlobalKillerExp=R2I(xp / CountUnitsInGroup(g))
          call ForGroup(g,function GiveRealExpToUnitsAround)
        endif
        call KillGroup(g)
        set GlobalKiller=null
      endif
    endif
    if b==false or SacrificedByLich then
      set i=GetUnitTypeId(dead)
      set p=GetOwningPlayer(killer)
      if(SacrificedByLich==false) and (p!=Sentinels[0] and p!=Scourges[0] and p!=Neutrals)then
        if LoadReal(HeroStats,GetHandleId(p),25)<TimerGetElapsed(GlobalTimer)then
          if IsUnitType(killer,UNIT_TYPE_HERO) or IsUnitIllusion(killer) then
            set greedlvl=GetUnitAbilityLevel(killer,'P155')//Goblin's greed
          else
            set greedlvl=GetUnitAbilityLevel(udg_Hero[GetPlayerId(p)],'P155')//Goblin's greed
          endif
          if greedlvl>0 and IsUnitType(dead,UNIT_TYPE_STRUCTURE)==false and (GetUnitAbilityLevel(dead,'A04R')==0 or IsSiegeUnit(dead)) then
            set greed=IMinIF(4+2*greedlvl+LoadInteger(MHT,GetHandleId(killer),'A0O3'),4+8*greedlvl)//define gold
            call SaveInteger(MHT,GetHandleId(p),'A0O3',LoadInteger(MHT,GetHandleId(p),'A0O3') + greed)
          endif
          set gold=GetRandomInt(LoadInteger(UnitStats,i,BOUNTYL),LoadInteger(UnitStats,i,BOUNTYH))+greed
          if gold>0 then
            call ImitateBountyGain(p,dead,gold)
          endif
        endif
      endif
      set xp=LoadInteger(UnitStats,i,EXP)
      if(xp>0 and p!=Neutrals) then
        if IsUnitType(dead,UNIT_TYPE_SUMMONED) then
          set xp=R2I(xp*0.5)
        endif
        set g=GetAvailableGroup()
        set GlobalKiller=killer
        call GroupEnumUnitsInRange(g,GetUnitX(dead),GetUnitY(dead),EXPAOE,Condition(function CustomUnitBountyAllyFilter))//alive non-hexed allied heroes
        if(GetOwningPlayer(dead)==Neutrals and IsUnitType(dead,UNIT_TYPE_ANCIENT)==false)then
          set gg=GetAvailableGroup()
          call GroupEnumUnitsInRange(gg,GetUnitX(dead),GetUnitY(dead),EXPAOE,Condition(function CustomUnitBountyEnemyFilter))//alive non-hexed enemy heroes
          call GroupAddGroup(gg,g)
          call KillGroup(gg)
          set gg=null
        endif
        if(FirstOfGroup(g)!=null)then
          set GlobalKillerExp=R2I(xp/CountUnitsInGroup(g))
          call ForGroup(g,function GiveRealExpToUnitsAround)
        endif
        set GlobalKiller=null
        call KillGroup(g)
      endif
      set SacrificedByLich=false
    endif
  endif
  set g=null
endfunction

function DiffusalBlade takes unit attacker, unit target returns nothing
  local real mp=GetUnitState(target,UNIT_STATE_MANA)
  local real burn
  if IsUnitIllusion(attacker) and IsUnitType(attacker,UNIT_TYPE_MELEE_ATTACKER)==false then
    set burn=RMinIF(mp,12)
  else
    set burn=RMinIF(mp,25)
  endif
  if mp > 0 and IsMagicImmune(target)==false then
    call DamageTarget(attacker,target,2,burn)
    call SetUnitState(target,UNIT_STATE_MANA,mp-burn)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Feedback\\ArcaneTowerAttack.mdl",target,"origin"))
  endif
endfunction

function UDS_Summon takes integer i returns nothing
  local integer k=0
  loop
    exitwhen HaveSavedString(UTable,'DMGE'+i,k)==false
    call ExeFunc(LoadStr(UTable,'DMGE'+i,k))
    //		call echo(LoadStr(UTable,'DMGE'+i,k)+" "+I2S(i))
    set k=k+1
  endloop
endfunction

function LichFromArmorWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Target,'B0H6')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_RANGED_ATTACKER) then
    call Lich_FrostArmor_RangedAttack(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function LeoricLifestealWrapper takes nothing returns nothing
  call SK_VampiricAura_Ranged(UDSG_Attacker,UDSG_Target)
endfunction

function TranquilBootsWrapper takes nothing returns nothing
  if IsUnitType(UDSG_Target,UNIT_TYPE_HERO) or IsSpiritBear(UDSG_Target) then
    call TranquilBoots_Attackd(UDSG_Target)
  endif
  if IsUnitType(UDSG_Attacker,UNIT_TYPE_HERO) or IsSpiritBear(UDSG_Attacker) then
    call TranquilBoots_Attackd(UDSG_Attacker)
  endif
endfunction

function QuellingBladeWrapper takes nothing returns nothing
  if IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and IsUnitEnemy(UDSG_Target,GetOwningPlayer(UDSG_Attacker)) and IsUnitType(UDSG_Target,UNIT_TYPE_HERO)==false and (GetUnitAbilityLevel(UDSG_Attacker,'A1AB')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A1AD')>0) then
    call QuellingBladeBonus(UDSG_Attacker,UDSG_Target,UDSG_Dmg)
  endif
endfunction

function MjollnirsWrapper takes nothing returns nothing
  if IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE)==false and IsUnitType(UDSG_Target,UNIT_TYPE_MECHANICAL)==false and IsUnitEnemy(UDSG_Target,GetOwningPlayer(UDSG_Attacker)) and (GetUnitAbilityLevel(UDSG_Attacker,'A0JH')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A0FJ')>0) then
    call MjollnirLightnings(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function LunaGlaiveWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'P098')>0 then
    call MoonGlaive(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function DiffusalBladeWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'Afbt')>0 and GetUnitAbilityLevel(UDSG_Attacker,'P133')==0 then
    call DiffusalBlade(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function EnchantTotemWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'Broa')>0 then//Enchant Totem
    call UnitRemoveAbility(UDSG_Attacker,'Broa')
  endif
endfunction

function EnchantTotemWrapperOnAttack takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'Broa')>0 and IsRangedUnitHasOverAS(UDSG_Attacker) then//Enchant Totem
    call EnchantTotemRangedFix()
  endif
endfunction

function MoCWrapperAdvanced takes nothing returns nothing
  if LoadInteger(HY,UDSG_TempInt,120)>0 and (GetUnitAbilityLevel(UDSG_Attacker,'A2GD')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GE')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GF')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A2GC')>0) then//MoC on one hit only!
    call SaveInteger(HY,UDSG_TempInt,120,LoadInteger(HY,UDSG_TempInt,120)-1)
    call Legion_MoC_Clear(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function MoCWrapperOnAttack takes nothing returns nothing
  call SaveBoolean(HY,UDSG_TempInt,120,GetUnitAbilityLevel(UDSG_Attacker,'B0FJ')>0)//check for MoC
  if GetUnitAbilityLevel(UDSG_Attacker,'B0FJ')>0 then
    call SaveInteger(HY,UDSG_TempInt,120,LoadInteger(HY,UDSG_TempInt,120)+1)
  endif
endfunction

function ElderDragonCorrosiveWrapper takes nothing returns nothing
  if GetUnitTypeId(UDSG_Attacker)=='H00E' or GetUnitTypeId(UDSG_Attacker)=='H00F' or GetUnitTypeId(UDSG_Attacker)=='H00G' then
    call ElderDragon_CorrosiveBreath(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function CausticFinalWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A0FA')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP16')>0 then
    call CausticFinalTriggered_Apply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function OldMarksmanshipWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A43Z')>0 then
    call OldMarksmanship_Instagib(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function Ench_Impetus_HitWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Target,'B03U')>0 then
    call Ench_Impetus_Hit(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function LifestealerWrapper takes nothing returns nothing
  if (GetUnitAbilityLevel(UDSG_Attacker,'A0SS')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP1W')>0) and GetUnitTypeId(UDSG_Target)!='n00L' and GetUnitAbilityLevel(UDSG_Attacker,'BNdo')==0 then
    call Lifestealer_Feast_Act(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function ODOrbWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Target,'B06Y')>0 then
    call OD_Orb_Hit(UDSG_Attacker,UDSG_Target,LoadBoolean(HY,UDSG_TempInt,0))
  endif
endfunction

function SilencerOrbWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Target,'B05X')>0 then
    call Silencer_Glaive_Hit(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function SlarkEssenceShiftWrapper takes nothing returns nothing
  if (GetUnitAbilityLevel(UDSG_Attacker,'A1HR')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP1F')>0) and IsUnitType(UDSG_Target,UNIT_TYPE_HERO)==true then
    call Slark_EssenceShift_OnHit(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function BarabashWrapper takes nothing returns nothing
  if (GetUnitAbilityLevel(UDSG_Attacker,'A0G5')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP1X')>0) and GetUnitAbilityLevel(UDSG_Attacker,'BNdo')==0 then
    call GreaterBash_Apply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function UrsaSwipesWrapper takes nothing returns nothing
  if (GetUnitAbilityLevel(UDSG_Attacker,'P067')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP0A')>0) and GetUnitAbilityLevel(UDSG_Attacker,'BNdo')==0 then
    call FurySwipesTriggered_Apply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function OrbOfVenomWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A1V7')>0 and GetUnitAbilityLevel(UDSG_Target,'B0DM')>0 then
    call OrbOfVenomApply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function SkadiWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A2KV')>0 then
    call SkadiSlow(UDSG_Target,IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER))
  endif
endfunction

function PoisonStingWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'P418')>0 and GetUnitAbilityLevel(UDSG_Target,'Bpsd')>0 then
    call PoisonStingApply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function SpectreDesolateWrapper takes nothing returns nothing
  if IsUnitType(UDSG_Target,UNIT_TYPE_HERO) and GetUnitAbilityLevel(UDSG_Attacker,'P338')+GetUnitAbilityLevel(UDSG_Attacker,'A322')>0 and IsUnitType(UDSG_Attacker,UNIT_TYPE_MELEE_ATTACKER)==false and LoadInteger(HY,GetHandleId(UDSG_Attacker),4275)!=1 then
    call Spectre_Desolate_act(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function AbaFrostmourneWrapper takes nothing returns nothing
  if GetUnitAbilityLevel(UDSG_Attacker,'A0MG')>0 or GetUnitAbilityLevel(UDSG_Attacker,'QP18')>0 then//frostmourne
    call Abaddon_Frostmourne_Apply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function SpiritBearDmgWrapper takes  nothing returns nothing
  if IsSpiritBear(UDSG_Attacker) then
    call SpiritBearAttack(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function HuskarArrowsWrapper takes nothing returns nothing
  call Huskar_BurningSpears_Wrapper(UDSG_Attacker,UDSG_Target)
endfunction

function GeoStrikeWrapper takes nothing returns nothing
  if (GetUnitAbilityLevel(UDSG_Attacker,'QP1B')>0 or GetUnitAbilityLevel(UDSG_Attacker,'A0N7')>0) and GetUnitAbilityLevel(UDSG_Attacker,'BNdo')==0 then
    call GeostrikeTriggered_Apply(UDSG_Attacker,UDSG_Target)
  endif
endfunction

function HuskarBurningSpearsWrapperInit takes nothing returns nothing
  call Huskar_BurningSpears_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function VoidBashWrapper takes nothing returns nothing
  call Void_Bash_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function TidebringerWrapper takes nothing returns nothing
  if IsFakeDamage==false and UDSG_Dmg>40 or IsUnitType(UDSG_Target,UNIT_TYPE_STRUCTURE) then
    call Kunka_Tidebringer_Effect(UDSG_Attacker,UDSG_Target,UDSG_Dmg)
  endif
endfunction

function TidebringerWrapperOnAttack takes nothing returns nothing
  call Kunka_Tidebringer_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function LanayaBladesWrapper takes nothing returns nothing
  call Psi_Blades_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function WyvernWrapper takes nothing returns nothing
  call Wyvern_Burn_Attack_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function TreantInvisWrapper takes nothing returns nothing
  call Tree_Invis_Cancel(UDSG_Attacker)
endfunction

function AbaFrostmourneWrapperOnAttack takes nothing returns nothing
  call Abbadon_Frostmourne_Attack(UDSG_Attacker,UDSG_Target)
endfunction

function RikiBackStabWrapper takes nothing returns nothing
  call Rikki_BackStab_Condition(UDSG_Attacker,UDSG_Target)
endfunction

function PLOnAttackWrapper takes nothing returns nothing
  call PL_Illusions_OnAttackWrap(UDSG_Attacker,UDSG_Target)
endfunction

function TrollWrapper takes nothing returns nothing
  call Troll_Fervor(UDSG_Attacker,UDSG_Target)
endfunction

function AxeWrappers takes nothing returns nothing
  call AxeAttacked(UDSG_Attacker,UDSG_Target)
endfunction

function ViperWrappers takes nothing returns nothing
  call Viper_NetherToxin(UDSG_Attacker,UDSG_Target)
endfunction

function SpectreWrappers takes nothing returns nothing
  call Spectre_Desolate(UDSG_Attacker,UDSG_Target)
endfunction

function CentaurReturnWrapper takes nothing returns nothing
  call Centaur_Return(UDSG_Attacker,UDSG_Target)
endfunction

function ShredderWrapper takes nothing returns nothing
  call Shredder_ReactiveArmor_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function MoCWrapperOnAttacked takes nothing returns nothing
  call Legion_MoC_OnAttack(UDSG_Attacker,UDSG_Target)
endfunction

function BaneUltiWrapper takes nothing returns nothing
  call Bane_FiendGripUpg_Nightmare(UDSG_Attacker,UDSG_Target)
endfunction

function UDS_Landing takes unit attacker, unit target, real dmg returns nothing
  set UDSG_Attacker=attacker
  set UDSG_Target=target
  set UDSG_Dmg=dmg
  set UDSG_TempInt=GetHandleId(GetTriggeringTrigger())
  call UDS_Summon(0)
  if not(LoadBoolean(HY,UDSG_TempInt,10)) then
    return
  endif
  call UDS_Summon(1)
  
  if LoadBoolean(HY,UDSG_TempInt,11)==false and (LoadBoolean(HY,UDSG_TempInt,13) or (LoadBoolean(HY,UDSG_TempInt,12)==false and LoadBoolean(HY,UDSG_TempInt,14))) then
    call UDS_Summon(2)
    if LoadBoolean(HY,UDSG_TempInt,15) then
      call UDS_Summon(3)
      if IsMagicImmune(target)==false then
        call UDS_Summon(4)
      endif
    endif
  endif
endfunction

function UDS_Tick takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED and LoadInteger(HY,h,0)>0 then
    if GetEventDamageSource()==LoadUnitHandle(HY,h,0) and GetEventDamage()>3 and IsRealDamage and IsFakeDamage==false then
      call DisableTrigger(t)
      call UDS_Landing(LoadUnitHandle(HY,h,0),LoadUnitHandle(HY,h,1),GetEventDamage())
      call EnableTrigger(t)
      if LoadInteger(HY,h,0)==1 then
        call RemoveSavedHandle(MHT,GetHandleId(LoadUnitHandle(HY,h,0)),GetHandleId(LoadUnitHandle(HY,h,1)))
        call FlushChildHashtable(HY,h)
        call DisableTrigger(t)
        call DestroyTrigger(t)
        set UDSTriggers=UDSTriggers-1
      else
        call SaveInteger(HY,h,0,LoadInteger(HY,h,0)-1)
      endif
    endif
  elseif TimerGetElapsed(GlobalTimer)-LoadReal(HY,h,0)>0 then
    call RemoveSavedHandle(MHT,LoadInteger(HY,h,10),LoadInteger(HY,h,11))
    call FlushChildHashtable(HY,h)
    call DisableTrigger(t)
    call DestroyTrigger(t)
    set UDSTriggers=UDSTriggers-1
  endif
  set t=null
endfunction

function UDS takes unit attacker, unit target, boolean isOrb returns nothing
  local trigger t
  local integer h
  set UDSG_Attacker=attacker
  set UDSG_Target=target
  set UDSG_IsOrb=isOrb
  call UDS_Summon(-1)
  if IsPlayerBelongToTeams(GetOwningPlayer(attacker))==false and IsPlayerBelongToTeams(GetOwningPlayer(target))==false then
    return
  endif
  set t=LoadTriggerHandle(MHT,GetHandleId(attacker),GetHandleId(target))
  if t!=null then
    set h=GetHandleId(t)
    call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
  else
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call SaveTriggerHandle(MHT,GetHandleId(attacker),GetHandleId(target),t)
    call SaveInteger(HY,h,0,1)
    call TriggerRegisterUnitEvent(t,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function UDS_Tick))
    call SaveUnitHandle(HY,h,0,attacker)
    call SaveUnitHandle(HY,h,1,target)
    call SaveInteger(HY,h,10,GetHandleId(attacker))//backup IDs in case if unit removed from game
    call SaveInteger(HY,h,11,GetHandleId(target))
    call SaveBoolean(HY,h,10,IsUnitType(attacker,UNIT_TYPE_HERO) or IsSpiritBear(attacker))
    call SaveBoolean(HY,h,11,IsUnitType(target,UNIT_TYPE_STRUCTURE))
    call SaveBoolean(HY,h,12,IsUnitType(target,UNIT_TYPE_MECHANICAL))
    call SaveBoolean(HY,h,13,IsSiegeUnit(target))
    call SaveBoolean(HY,h,14,GetUnitAbilityLevel(target,'A04R')==0)
    call SaveBoolean(HY,h,15,IsUnitEnemy(attacker,GetOwningPlayer(target)))
    set UDSTriggers=UDSTriggers+1
  endif
  set UDSG_TempInt=h
  if IsUnitType(attacker,UNIT_TYPE_HERO)then
    call UDS_Summon(-2)
  endif
  //call DisableEvasion(target,0.5)
  call SaveReal(HY,h,0,TimerGetElapsed(GlobalTimer)+4)
  call SaveBoolean(HY,h,0,isOrb)
  set t=null
endfunction

function BlademailWrapper takes unit attacker, unit target, real dmg returns nothing
  local integer hu=GetHandleId(target)
  if LoadBoolean(HY,hu,'BMON')then
    if IsUnitType(attacker,UNIT_TYPE_STRUCTURE)==false then
      if IsUnitType(attacker,UNIT_TYPE_HERO)or GetUnitAbilityLevel(attacker,'A04R')==0 then
        call SaveBoolean(HY,hu,'BMON',false)
        call DamageTarget(target,attacker,3,dmg)
        call SaveBoolean(HY,hu,'BMON',true)
      endif
    endif
  endif
endfunction

function DamageHappened takes nothing returns boolean
  local unit target=GetTriggerUnit()
  local unit attacker
  local unit adjattacker
  local real dmg
  local integer hu
  local real bonusdmg
  if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
    set attacker=GetEventDamageSource()
    set dmg=GetEventDamage()
    set bonusdmg=0.
    //call echo("Damage to "+GetUnitName(target)+" from "+GetUnitName(attacker))
    if IsDamageReal(dmg) then
      set hu=GetHandleId(target)
      if LoadBoolean(HY,GetHandleId(GetTriggeringTrigger()),'AMPL')==false and NoReflection==false then
        set bonusdmg=LoadReal(HY,hu,'AMPL')
        if HeroInGame_Queen and (GetUnitAbilityLevel(attacker,'A460')>0 or GetUnitAbilityLevel(attacker,'QP27')>0) and IsUnitEnemy(attacker,GetOwningPlayer(target)) and AliveNonBuildOrMarker(target) then
          call MortalWoundsWrapper(attacker,target)
        endif
        if HeroInGame_BS then
          if (GetUnitAbilityLevel(attacker,'Aloc')>0 or GetUnitAbilityLevel(attacker,'A04R')>0) and IsUnitType(attacker,UNIT_TYPE_HERO)==false then
            set adjattacker=udg_Hero[GetPlayerId(GetOwningPlayer(attacker))]
          else
            set adjattacker=attacker
          endif
          if GetUnitAbilityLevel(adjattacker,'A44Y')>0 or GetUnitAbilityLevel(target,'A44Y')>0 then
            if DistanceBetweenUnits(adjattacker,target)<2200 then
              if GetUnitAbilityLevel(adjattacker,'A44Y')>0 then
                set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(adjattacker),'A2X9')
              endif
            else
              if GetUnitAbilityLevel(adjattacker,'A44Y')>0 then
                set bonusdmg=bonusdmg+LoadReal(HY,GetHandleId(adjattacker),'A2X9')/2
              endif
              if GetUnitAbilityLevel(target,'A44Y')>0 then
                set bonusdmg=bonusdmg-LoadReal(HY,GetHandleId(target),'A2X9')/2
              endif
            endif
          endif
          //					//call echo(R2S(dmg)+" dealt, bloodrage bonus = "+R2S(bonusdmg)+" which means "+R2S(dmg*bonusdmg)+" total bonus damage")
        endif
        if bonusdmg > 0 then
          call SaveBoolean(HY,GetHandleId(GetTriggeringTrigger()),'AMPL',true)
          call DamageTarget(attacker,target,3,dmg*bonusdmg)
          call TextTagOnUnitEx("+"+I2S(R2I(dmg*bonusdmg)),4,target,0.028,128,255,0,0,216)//+ " ("+R2S(bonusdmg)+")"
          call SaveBoolean(HY,GetHandleId(GetTriggeringTrigger()),'AMPL',false)
        endif
        //call TextTagOnUnitEx("+"+I2S(R2I(dmg)),4,target,0.028,64,255,0,0,216)
      endif
      if IsUnitEnemy(attacker,GetOwningPlayer(target)) and NoReflection==false then
        if GetUnitAbilityLevel(target,'A43C')>0 then
          call BlademailWrapper(attacker,target,dmg)
        endif
      endif
      if IsUnitType(target,UNIT_TYPE_STRUCTURE) and IsUnitIllusion(attacker) and IsUnitEnemy(target,GetOwningPlayer(attacker)) then
        call HealUnitFor(target,dmg*0.25)
        //call echo("illu")
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",target,"origin"))
      endif
      if IsFakeDamage==false then
        
      endif
      
    endif
  endif
  
  set target=null
  set attacker=null
  return false
endfunction

function DamageRegisterEnter takes nothing returns boolean
  local unit u=GetTriggerUnit()
  local integer hu=GetHandleId(u)
  //	call echo(GetUnitName(u)+" entered")
  if GetUnitAbilityLevel(u,'Aloc')==0 and GetOwningPlayer(u)!=Player(15) then
    call TriggerRegisterUnitEvent(DamageRegister,u,EVENT_UNIT_DAMAGED)
  endif
  set u=null
  return false
endfunction

function NoteSpellForEnemy takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local integer id=GetSpellAbilityId()
  local player enemy
  local integer key
  if IsUnitType(u,UNIT_TYPE_HERO) then
    if IsSentinel(GetOwningPlayer(u)) then
      set enemy=Scourges[1]
      set key='SPL0'
    else
      set enemy=Sentinels[1]
      set key='SPLH'
    endif
    if LoadBoolean(MHT,key+GetPlayerId(GetOwningPlayer(u)),id)==false and IsUnitVisible(u,enemy) then
      call SaveBoolean(MHT,key+GetPlayerId(GetOwningPlayer(u)),id,true)
    endif
  endif
  set u=null
endfunction

//Generic event functions that are called everytime the event occurs
//===========================================================================================
function LoDSpell_Generic takes unit u, integer spell returns nothing
  //call NoteSpellForEnemy()
  if GetUnitAbilityLevel(u,'B0H0')>0 then
    call Silencer_LastWordPassive_Check(u,spell)
  endif
  if Reduced_Spell(spell)then
    call Reduced_Spell_Proc(u,spell)
  endif
  if isPoisonArrowSkill(spell) then
    call UDS(u,GetSpellTargetUnit(),true)
  endif
  call Silencer_Last_Word_Cast(u)
  call Zeus_Static_Field_Condition(u,spell)
  call Bristleback_Warpath_Condition(u,spell)
  call Earthshaker_Aftershock_Condition(u,spell)
  call Phoenix_Sunray_Stop(u,spell)
endfunction

function LoDOrder_Generic takes unit u, integer order, eventid id returns nothing
  if id==EVENT_UNIT_ISSUED_ORDER then
    if GetUnitAbilityLevel(u,'A0QN')>0 then
      if order==852255 or order==852458 then//poison arrows on
        call SaveBoolean(MHT,GetHandleId(u),'A0QN',true)
        call UnitAddAbility2(u,'A40H')
      elseif order==852256 or order==852459 then//poison arrows off
        call SaveBoolean(MHT,GetHandleId(u),'A0QN',false)
        call UnitRemoveAbility(u,'A40H')
      endif
    endif
  endif
  if id==EVENT_UNIT_ISSUED_TARGET_ORDER then
    if GetUnitAbilityLevel(u,'A0QN')>0 then
      if order==852225 then//frost armor
        call InterruptUnit(u)
        set IsOrbAttack=true
        call IssueTargetOrder(u,"attackonce",GetOrderTargetUnit())
        set IsOrbAttack=false
        call UnitAddAbility2(u,'A40H')
        call SaveBoolean(MHT,GetHandleId(u),'A0QN'+1,true)
        call SaveUnitHandle(MHT,GetHandleId(u),'A0QN'+1,GetOrderTargetUnit())
      endif
    endif
  endif
  call Phoenix_Sunray_Orders(u,order)
  call Wyvern_Curse_Reorder(u)
endfunction

function LoDAttack_Generic takes unit attacker, unit target returns nothing
  if Slark_ShadowDance_Attacked(attacker,target) then
    return
  endif
  call UDS(attacker,target,false)
endfunction

function LoDDeath_Generic takes unit killer, unit victim returns nothing
  if LoadBoolean(UnitStats,GetUnitTypeId(victim),0) then
    return
  endif
  if IsUnitType(victim,UNIT_TYPE_HERO) and LoadBoolean(HY,GetHandleId(victim),TEMPEST)==false then
    call HeroDeath()
    call FB_Check(killer,victim)
    call RequiemWrapperOnDeath(victim)
    call Rot_Suicide(killer,victim)
    call StormModel_Death(victim)
    call XinModel_Death(victim)
    call BH_TrackKill(victim)
    call Silencer_IntSteal(killer,victim)
    call KaolinModel_Death(victim)
    call StoneOwnerDeath(victim)
    call Lone_HeroDeath_KillBear(victim)
    call BloodStoneWrap(victim)
  else
    call CreepDeath(killer,victim)
  endif
  if GetOwningPlayer(victim)==Neutrals then
    call RoshanDeath(victim)
  else
    call RemoteMineDeath(victim)
    call UndyingZombie(victim)
    call Templar_Trap_Start_Wrap(victim)
    call CourierDeath(victim)
    call SpiritBear_Death(killer,victim)
    call NecronomiconKilled(killer,victim)
  endif
  call CustomUnitBountySystemInit(killer,victim)
  call Alchemist_Greed_Condition(killer,victim)
  call BS_BloodBath(killer,victim)
  call Sadist_Condition(killer,victim)
  call NecromasteryReact(killer,victim)
  if GetUnitAbilityLevel(victim,'ACac')>0 and IsUnitIllusion(victim)==false and IsPlayerBelongToTeams(GetOwningPlayer(killer)) and IsUnitEnemy(killer,GetOwningPlayer(victim))  then
    if IsUnitType(killer,UNIT_TYPE_HERO) then
      call VS_VengeanceAuraApply(GetUnitAbilityLevel(victim,'ACac'),killer,victim)
    else
      if IsDead(udg_Hero[GetPlayerId(GetOwningPlayer(killer))])==false then
        call VS_VengeanceAuraApply(GetUnitAbilityLevel(victim,'ACac'),udg_Hero[GetPlayerId(GetOwningPlayer(killer))],victim)
      endif
    endif
  endif
endfunction

//function LoDSummon_Generic takes unit u, unit t returns nothing

//endfunction


function LoDDamage_Generic takes unit u, unit t, real d returns nothing
  if d>0 then
    call Abbadon_Time_Condition(t,d)
  endif
endfunction

function EnchantedTotemEffectFromDummy takes nothing returns boolean
  local trigger t=GetTriggeringTrigger()
  local unit caster=LoadUnitHandle(HY,GetHandleId(t),0)
  local unit u=CreateUnit(GetOwningPlayer(caster),'e00E',GetUnitX(caster),GetUnitY(caster),0)
  local integer id='QFZX'
  call UnitRemoveAbility(caster,'Broa')
  if Mode_EB and ((GetUnitAbilityLevel(caster,'A0CG')>0 and IsUnitType(caster,UNIT_TYPE_MELEE_ATTACKER)) or GetUnitAbilityLevel(caster,'A1IQ')>0 or GetUnitAbilityLevel(caster,'A13T')>0 or GetUnitAbilityLevel(caster,'A1YQ')>0 or GetUnitAbilityLevel(caster,'A2H0')>0 or GetUnitAbilityLevel(caster,'QB0L')>0 or GetUnitAbilityLevel(caster,'A0KX')>0) then
    set id='QFZY'
  endif
  call UnitAddAbility(u,id)
  call SetUnitAbilityLevel(u,id,GetUnitAbilityLevel(caster,'A0DL'))
  call IssueImmediateOrder(u,"roar")
  call FlushChildHashtable(HY,GetHandleId(t))
  call DestroyTrigger(t)
  set t=null
  set u=null
  set caster=null
  return false
endfunction

function EnchantedTotemCasting takes nothing returns nothing
  local unit caster
  local trigger t
  set caster=GetTriggerUnit()
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.01,false)
  call TriggerAddCondition(t,Condition(function EnchantedTotemEffectFromDummy))
  call SaveUnitHandle(HY,GetHandleId(t),0,caster)
  set t=null
  set caster=null
endfunction

function OrbWalkingCheck takes unit u returns nothing
  if GetUnitAbilityLevel(u,'Aetl')>0 or GetUnitAbilityLevel(u,'B017')>0 then
    call InterruptUnit(u)
  endif
endfunction

//Specific functions are executed here
//===========================================================================================
function LoD_Event_Condition takes nothing returns boolean
  local unit u = null
  local integer i = GetSpellAbilityId()
  local integer l
  local eventid id = GetTriggerEventId()
  if i!=0 then
    if id == EVENT_UNIT_SPELL_EFFECT then
      call LoDSpell_Generic(GetTriggerUnit(),i)
      if HaveSavedString(MHT,i,0) then
        call ExeFunc(LoadStr(MHT,i,0))
      endif
    elseif id==EVENT_UNIT_SPELL_ENDCAST then
      if HaveSavedString(MHT,i,1) then
        call ExeFunc(LoadStr(MHT,i,1))
      endif
    elseif id==EVENT_UNIT_SPELL_FINISH then
      if HaveSavedString(MHT,i,2) then
        call ExeFunc(LoadStr(MHT,i,2))
      endif
    elseif id==EVENT_UNIT_SPELL_CAST then
      if isPoisonArrowSkill(i) then
        call OrbWalkingCheck(GetTriggerUnit())
        call Viper_NetherToxin(GetTriggerUnit(),GetSpellTargetUnit())
      endif
      if HaveSavedString(MHT,i,3) then
        call ExeFunc(LoadStr(MHT,i,3))
      endif
    elseif id==EVENT_UNIT_SPELL_CHANNEL then
      if HaveSavedString(MHT,i,7) then
        call ExeFunc(LoadStr(MHT,i,7))
      endif
    endif
  endif
  if id == EVENT_UNIT_HERO_SKILL then
    set u = GetTriggerUnit()
    set i = GetLearnedSkill()
    set l = GetLearnedSkillLevel()
    call Passive_Cooldown_Learn(u,i,l)
    if HaveSavedString(MHT,i,5) then
      call ExeFunc(LoadStr(MHT,i,5))
    endif
    if l==1then
      if HaveSavedString(MHT,i,4) then
        call ExeFunc(LoadStr(MHT,i,4))
      endif
    endif
    set u = null
  elseif id == EVENT_PLAYER_UNIT_ATTACKED then
    call LoDAttack_Generic(GetAttacker(),GetTriggerUnit())
  elseif id == EVENT_UNIT_ISSUED_ORDER or id == EVENT_UNIT_ISSUED_POINT_ORDER or id == EVENT_UNIT_ISSUED_TARGET_ORDER then
    call LoDOrder_Generic(GetTriggerUnit(),GetIssuedOrderId(),id)//Save (udgtable,handle,2,true) when a units orders are added as an event
  elseif id == EVENT_PLAYER_UNIT_DEATH then
    call LoDDeath_Generic(GetKillingUnit(),GetTriggerUnit())
  elseif id == EVENT_UNIT_SUMMON then
    set u = GetSummoningUnit()
    
    //call LoDSummon_Generic(u,GetTriggerUnit())
    if HaveSavedString(MHT,LoadInteger(MHT,GetHandleId(u),'SPEL'),9) then
      call ExeFunc(LoadStr(MHT,LoadInteger(MHT,GetHandleId(u),'SPEL'),9))
    endif
    set u = null
  elseif id == EVENT_UNIT_DAMAGED then
    call LoDDamage_Generic(GetEventDamageSource(),GetTriggerUnit(),GetEventDamage())
  endif
  set u=null
  return false
endfunction

function LoD_Chat_Event takes nothing returns boolean
  // only used for EVENT_PLAYER_CHAT, all other events should be register
  // with GAME_TRIGGER
  if HaveSavedString(MHT,StringHash(GetEventPlayerChatString()),10) then
    call ExeFunc(LoadStr(MHT,StringHash(GetEventPlayerChatString()),10))
  endif
  return false
endfunction

function LoDEvent_Init takes nothing returns nothing
  //EVENT_UNIT_SPELL_EFFECT
  call SaveStr(MHT,'A2NT',0,"Silencer_LastWord")
  call SaveStr(MHT,'A0ES',0,"Spiritbreaker_EmpoweringHaste_Act")
  call SaveStr(MHT,'A0MT',0,"Netherblast_Start")
  call SaveStr(MHT,'A1P8',0,"Spiritbreaker_Charge_Start")
  call SaveStr(MHT,'A01I',0,"Pitlord_Firestorm_Start")
  call SaveStr(MHT,'A1YY',0,"Phoenix_Sunray_Start")
  call SaveStr(MHT,'A0O6',0,"Jakiro_Icepath_Start")
  call SaveStr(MHT,'A0IL',0,"Alchemist_Acidspray_Start")
  call SaveStr(MHT,'A1A8',0,"Tauren_Spirit_Start")
  call SaveStr(MHT,'A21J',0,"Tauren_Spirit_Stop")
  call SaveStr(MHT,'A2KZ',0,"Terrorblade_Reflection_Start")
  call SaveStr(MHT,'A04V',0,"Bane_Enfeeble_Condition")
  call SaveStr(MHT,'A0LV',0,"Chen_Test_Condition")
  call SaveStr(MHT,'A2MC',0,"Chen_Teleport_Condition")
  call SaveStr(MHT,'A0NS',0,"Abbadon_Time_Start")
  call SaveStr(MHT,'A1DA',0,"Abbadon_Time_Start")
  call SaveStr(MHT,'A1DP',0,"Razor_Link_Start")
  call SaveStr(MHT,'A2IS',0,"mySven_Warcry")
  call SaveStr(MHT,'A0RP',0,"Templar_Trap_Place")
  call SaveStr(MHT,'A449',0,"Templar_Trap_Place")
  
  call SaveStr(MHT,'A0RT',0,"Templar_Trap_Start")
  call SaveStr(MHT,'A0RQ',0,"Templar_Trap_Start")
  call SaveStr(MHT,'A2ML',0,"Tree_Armour_Start")
  call SaveStr(MHT,'A2M1',0,"Gnoll_Flux_Start")
  call SaveStr(MHT,'A2LM',0,"Gnoll_Field_Start")
  call SaveStr(MHT,'A2LL',0,"Gnoll_Spark_Start")
  call SaveStr(MHT,'A332',0,"Wyvern_Burn_Start")
  call SaveStr(MHT,'DRKN',0,"Nightstalker_Darkness_Start")
  call SaveStr(MHT,'DRKU',0,"Nightstalker_Darkness_Start")
  call SaveStr(MHT,'A2LA',0,"Wyvern_SplinterBlast_Start")
  call SaveStr(MHT,'A2M0',0,"Zet_Tempest_Start")
  call SaveStr(MHT,'A136',0,"Admiral_Torrent")
  call SaveStr(MHT,'A11K',0,"Admiral_GhostShip")
  call SaveStr(MHT,'A1NI',0,"Alchemist_UnstableConcoction")
  call SaveStr(MHT,'A0E3',0,"AM_ManaVoid")
  call SaveStr(MHT,'AEbl',0,"AM_Blink")
  call SaveStr(MHT,'QB08',0,"AM_Blink")
  call SaveStr(MHT,'A0O1',0,"Beastmaster_WildAxes")
  call SaveStr(MHT,'A0O2',0,"Beastmaster_PrimalRoar")
  call SaveStr(MHT,'A289',0,"Beastmaster_PrimalRoar")
  call SaveStr(MHT,'A13Z',0,"Beastmaster_HawkInvis")
  call SaveStr(MHT,'A0B4',0,"Bounty_Track")
  call SaveStr(MHT,'QB0D',0,"Bounty_Track")
  call SaveStr(MHT,'A07A',0,"Bounty_Windwalk")
  call SaveStr(MHT,'QB09',0,"Bounty_Windwalk")
  call SaveStr(MHT,'A0FW',0,"BB_Goo")
  call SaveStr(MHT,'A0GP',0,"myBB_Spray")
  
  call SaveStr(MHT,'A2O6',0,"Stampede_Cast")
  call SaveStr(MHT,'A00L',0,"Double_Edge_Start")
  call SaveStr(MHT,'A00S',0,"Centaur_HoofStomp")
  call SaveStr(MHT,'A0KM',0,"Chen_Penitence")
  call SaveStr(MHT,'A28T',0,"Chen_HolyPersuation")
  call SaveStr(MHT,'A0LT',0,"Chen_HandOfGod")
  call SaveStr(MHT,'A034',0,"Slardar_AmplifyDamage")
  call SaveStr(MHT,'QB0C',0,"Slardar_AmplifyDamage")
  call SaveStr(MHT,'A0DL',0,"EnchantedTotemCasting")
  call SaveStr(MHT,'A1CS',0,"Chen_HandOfGod")
  call SaveStr(MHT,'A0Z6',0,"Clockwerk_RocketFlare")
  call SaveStr(MHT,'A0Z5',0,"Clockwerk_PowerCogs_Start")
  call SaveStr(MHT,'A0Z8',0,"Clockwerk_Hookshot")
  call SaveStr(MHT,'A1CV',0,"Clockwerk_Hookshot")
  call SaveStr(MHT,'A0Z4',0,"Clockwerk_BatteryAssault")
  call SaveStr(MHT,'A03R',0,"CM_FreezingField")
  call SaveStr(MHT,'A0AV',0,"CM_FreezingField")
  call SaveStr(MHT,'A1E9',0,"CM_Nova")
  call SaveStr(MHT,'A14P',0,"Storm_StaticRemnant")
  call SaveStr(MHT,'A14R',0,"Storm_ElectricVortex")
  call SaveStr(MHT,'A14O',0,"Storm_BallLightning")
  call SaveStr(MHT,'A0AR',0,"DK_DragonTail")
  call SaveStr(MHT,'QB0G',0,"DK_DragonTail")
  call SaveStr(MHT,'A03G',0,"DK_DragonForm_Act")
  call SaveStr(MHT,'QM00',0,"DK_DragonForm_Act")
  call SaveStr(MHT,'A2QI',0,"Kaolin_GeomagneticGrip_Effect")
  call SaveStr(MHT,'A2TH',0,"Kaolin_Stones_SummonStart")
  call SaveStr(MHT,'A2QM',0,"Kaolin_BoulderSmash_InitSup")
  call SaveStr(MHT,'A2QT',0,"Oracle_FortunesEnd_Sup")
  call SaveStr(MHT,'A2T5',0,"Oracle_FatesEdict_Sup")
  call SaveStr(MHT,'QB0O',0,"Oracle_PurifingFlames_InitSup")
  call SaveStr(MHT,'A2SG',0,"Oracle_PurifingFlames_InitSup")
  call SaveStr(MHT,'A2TF',0,"Oracle_FalsePromise_Start")
  call SaveStr(MHT,'QB11',0,"Oracle_FalsePromise_Start")
  call SaveStr(MHT,'A0SK',0,"ES_Fissure")
  call SaveStr(MHT,'A0DH',0,"ES_EchoSlam_Act")
  call SaveStr(MHT,'A1OB',0,"ES_EchoSlam_Act")
  call SaveStr(MHT,'A01B',0,"Enchantress_NaturesAttendants")
  call SaveStr(MHT,'A0DX',0,"Enchantress_Enchant")
  call SaveStr(MHT,'A0B1',0,"Enigma_MidnightPulse")
  call SaveStr(MHT,'A0I7',0,"Enigma_Malefice_InitSup")
  call SaveStr(MHT,'A180',0,"Enigma_DemonicConversion")
  call SaveStr(MHT,'A1BX',0,"Enigma_BlackHole")
  call SaveStr(MHT,'A30L',0,"Enigma_BlackHole")
  call SaveStr(MHT,'A09W',0,"Lion_FingerOfDeath_Splash")
  call SaveStr(MHT,'A0SC',0,"Puck_WaningRift")
  call SaveStr(MHT,'A1QP',0,"Puck_DreamCoil")
  call SaveStr(MHT,'A0S8',0,"Puck_DreamCoil")
  call SaveStr(MHT,'A0S9',0,"Puck_IllusoryOrb")
  call SaveStr(MHT,'A0SA',0,"Puck_EtherealJaunt")
  call SaveStr(MHT,'A21E',0,"Prophet_Sprout")
  call SaveStr(MHT,'A1W8',0,"Prophet_WrathOfNature")
  call SaveStr(MHT,'A1W9',0,"Prophet_WrathOfNature")
  call SaveStr(MHT,'A0QR',0,"Huskar_LifeBreak")
  call SaveStr(MHT,'A1B3',0,"Huskar_LifeBreak")
  call SaveStr(MHT,'A0QP',0,"Huskar_InnerVitality")
  call SaveStr(MHT,'A0O5',0,"THD_Macropyre")
  call SaveStr(MHT,'A30T',0,"THD_LiquidFire")
  call SaveStr(MHT,'A1B1',0,"THD_Macropyre")
  call SaveStr(MHT,'ANLS',0,"LinkenSphere_Share")
  call SaveStr(MHT,'A0O7',0,"THD_DualBreath")
  call SaveStr(MHT,'A0M1',0,"Juggernaut_Omnislash")
  call SaveStr(MHT,'A1AX',0,"Juggernaut_Omnislash")
  call SaveStr(MHT,'A05G',0,"Juggernaut_Bladefury")
  call SaveStr(MHT,'A2S8',0,"Omni_GuardianAngelUpg")
  call SaveStr(MHT,'A10U',0,"Kotl_Recall")
  call SaveStr(MHT,'A10X',0,"Kotl_ManaLeak")
  call SaveStr(MHT,'A112',0,"Kotl_ChakraMagic")
  call SaveStr(MHT,'QM01',0,"Kotl_SpiritForm")
  call SaveStr(MHT,'A11X',0,"Kotl_BlindingLight")
  call SaveStr(MHT,'Z042',0,"LoDLightStrikeArray_Cast")
  call SaveStr(MHT,'QB0E',0,"LoDLightStrikeArray_Cast")
  call SaveStr(MHT,'A09Z',0,"Lina_LagunaBladeUpg")
  call SaveStr(MHT,'A054',0,"Luna_Eclipse")
  call SaveStr(MHT,'A00U',0,"Luna_Eclipse")
  call SaveStr(MHT,'A0KV',0,"Potm_Starfall")
  call SaveStr(MHT,'A0KU',0,"Potm_MoonlightShadows")
  call SaveStr(MHT,'A0LN',0,"Potm_Leap")
  call SaveStr(MHT,'A0L8',0,"PotM_EluneArrow_Start")
  call SaveStr(MHT,'A33U',0,"StormOld_LightningGrapple")
  call SaveStr(MHT,'A0FN',0,"Morphling_Waveform")
  call SaveStr(MHT,'QB02',0,"Morphling_Waveform")
  call SaveStr(MHT,'A0G8',0,"Morphling_Replicate")
  call SaveStr(MHT,'A0GC',0,"Morphling_ReplicateReplace")
  call SaveStr(MHT,'A0G6',0,"Morphling_AdaptiveStrike")
  call SaveStr(MHT,'A07U',0,"Naga_SongOfSiren")
  call SaveStr(MHT,'A2KU',0,"Naga_RipTide")
  call SaveStr(MHT,'A24D',0,"Naga_Ensnare")
  call SaveStr(MHT,'A08N',0,"Omni_Purification")
  call SaveStr(MHT,'A10D',0,"PL_SpiritLance")
  call SaveStr(MHT,'QB0B',0,"PL_Doppelwalk")
  call SaveStr(MHT,'A0D7',0,"PL_Doppelwalk")
  call SaveStr(MHT,'A26N',0,"Treant_LeechSeed")
  call SaveStr(MHT,'A14L',0,"Silencer_CurseOfSilence")
  call SaveStr(MHT,'A0L3',0,"Silencer_GlobalSilence_Start")
  call SaveStr(MHT,'A2QC',0,"Silencer_GlobalSilence_Start")
  call SaveStr(MHT,'A064',0,"Sniper_Shrapnel")
  call SaveStr(MHT,'A0RG',0,"Riki_SmokeScreen")
  call SaveStr(MHT,'A0K9',0,"Riki_BlinkStrike")
  call SaveStr(MHT,'A0WP',0,"myGodStrength")
  call SaveStr(MHT,'A43D',0,"myGodStrength")
  call SaveStr(MHT,'A190',0,"Sven_StormBolt")
  call SaveStr(MHT,'A1EG',0,"LoneDruid_Rabid")
  call SaveStr(MHT,'A0A5',0,"LoneDruid_SpiritBear")
  call SaveStr(MHT,'A0AG',0,"LoneDruid_TrueForm")
  call SaveStr(MHT,'A1A1',0,"Chieftain_SplitEarth")
  call SaveStr(MHT,'A43J',0,"Chieftain_SplitEarth")
  
  call SaveStr(MHT,'A0BQ',0,"Tinker_MarchOfMachines")
  call SaveStr(MHT,'A049',0,"Tinker_Laser")
  call SaveStr(MHT,'A33G',0,"Tinker_Laser")
  call SaveStr(MHT,'A33F',0,"Tinker_Rockets")
  call SaveStr(MHT,'A05E',0,"Tinker_Rockets")
  
  call SaveStr(MHT,'A0BZ',0,"Tiny_Toss")
  call SaveStr(MHT,'A0LL',0,"Tiny_Avalanche")
  call SaveStr(MHT,'A1EJ',0,"Troll_BattleTrance")
  call SaveStr(MHT,'A0BE',0,"TrollRageMorph")
  call SaveStr(MHT,'A21M',0,"Troll_AxesRanged")
  call SaveStr(MHT,'A21N',0,"Troll_AxesMelee")
  call SaveStr(MHT,'A1N4',0,"Ursa_Overpower")
  call SaveStr(MHT,'QB0P',0,"Ursa_Overpower")
  call SaveStr(MHT,'A0LC',0,"Ursa_Enrage")
  call SaveStr(MHT,'A443',0,"Ursa_Enrage")
  call SaveStr(MHT,'A17O',0,"VS_WaveOfTerror")
  call SaveStr(MHT,'A0IN',0,"VS_NetherSwap")
  call SaveStr(MHT,'A1AW',0,"VS_NetherSwap")
  call SaveStr(MHT,'A1EA',0,"TA_Refraction")
  call SaveStr(MHT,'QB03',0,"TA_Refraction")
  call SaveStr(MHT,'A0RV',0,"TA_Meld")
  call SaveStr(MHT,'A14I',0,"WR_Windrun")
  call SaveStr(MHT,'A12J',0,"WR_Shacleshot")
  call SaveStr(MHT,'A12K',0,"WR_Powershot")
  call SaveStr(MHT,'A12P',0,"WR_FocusFire")
  call SaveStr(MHT,'A1D6',0,"WR_FocusFire")
  call SaveStr(MHT,'A29G',0,"Zeus_WrathOfGod")
  call SaveStr(MHT,'A29H',0,"Zeus_WrathOfGod")
  call SaveStr(MHT,'A0JC',0,"Zeus_LightningBolt")
  call SaveStr(MHT,'A020',0,"Zeus_ChainLightning")
  call SaveStr(MHT,'A0I3',0,"Abaddon_DeathCoil")
  call SaveStr(MHT,'A0MF',0,"Abaddon_AphoticShield")
  call SaveStr(MHT,'A0S1',0,"Axe_BattleHunger")
  call SaveStr(MHT,'A0I6',0,"Axe_BerserkerCall")
  call SaveStr(MHT,'A0E2',0,"Axe_CullingBlade")
  call SaveStr(MHT,'A1MR',0,"Axe_CullingBlade")
  call SaveStr(MHT,'A04Y',0,"Bane_Nightmare")
  call SaveStr(MHT,'A02Q',0,"Bane_Grip")
  call SaveStr(MHT,'A1D9',0,"Bane_Grip")
  call SaveStr(MHT,'A1EL',0,"Batrider_StickyNapalm")
  call SaveStr(MHT,'A19V',0,"Batrider_FlameBreak")
  call SaveStr(MHT,'QM04',0,"Batrider_Firefly")
  call SaveStr(MHT,'A19O',0,"Batrider_FlamingLasso")
  call SaveStr(MHT,'A0LH',0,"BS_Rupture")
  call SaveStr(MHT,'A0EC',0,"BS_Bloodrage_Action")
  call SaveStr(MHT,'Z234',0,"LoDSpinWeb_Cast")
  call SaveStr(MHT,'A0WQ',0,"Brood_Hunger")
  call SaveStr(MHT,'A0BH',0,"Brood_SpawnSpiderlings")
  call SaveStr(MHT,'A0RW',0,"CK_RealityRift")
  call SaveStr(MHT,'A03O',0,"CK_Phantasm")
  call SaveStr(MHT,'A04Q',0,"BoneFletcher_DeathPact")
  call SaveStr(MHT,'A0OJ',0,"OD_AstralImprisonment")
  call SaveStr(MHT,'A0OK',0,"OD_SanityEclipse")
  call SaveStr(MHT,'A1VW',0,"OD_SanityEclipse")
  call SaveStr(MHT,'A0QG',0,"DS_IonShell")
  call SaveStr(MHT,'A0QE',0,"DS_Vacuum")
  call SaveStr(MHT,'A0R7',0,"DS_Surge")
  call SaveStr(MHT,'A21Q',0,"DS_WallOfReplica")
  call SaveStr(MHT,'A0QK',0,"DS_WallOfReplica")
  call SaveStr(MHT,'A15S',0,"Undying_Decay")
  call SaveStr(MHT,'A0R5',0,"Undying_SoulRip")
  call SaveStr(MHT,'A15V',0,"Undying_TombStone")
  call SaveStr(MHT,'QM03',0,"Undying_FleshGolem")
  call SaveStr(MHT,'A0LK',0,"Void_Timewalk")
  call SaveStr(MHT,'A0J1',0,"Void_Chronosphere")
  call SaveStr(MHT,'A1D7',0,"Void_Chronosphere")
  call SaveStr(MHT,'A333',0,"Furion_ForceOfNature")
  call SaveStr(MHT,'Z610',0,"Lod_DeafeningBlast_Effect")
  call SaveStr(MHT,'Z609',0,"Lod_EMP_Effect")
  call SaveStr(MHT,'Z608',0,"Lod_Tornado_Effect")
  call SaveStr(MHT,'Z607',0,"Lod_Alacrity_Effect")
  call SaveStr(MHT,'Z606',0,"Lod_IceWall_Effect")
  call SaveStr(MHT,'Z605',0,"Lod_GhostWalk_Effect")
  call SaveStr(MHT,'Z604',0,"Lod_ColdSnap_Effect")
  call SaveStr(MHT,'Z603',0,"Lod_ForgeSpirit_Effect")
  call SaveStr(MHT,'Z602',0,"Lod_ChaosMeteor_Effect")
  call SaveStr(MHT,'Z601',0,"Lod_SunStrike_Effect")
  call SaveStr(MHT,'QF89',0,"MARKSMANSHIP_EFFECT_sup")
  call SaveStr(MHT,'A33A',0,"Traxex_Gust_Start")
  
  call SaveStr(MHT,'AHtb',0,"SkeletonKing_HellfireBlast")
  call SaveStr(MHT,'QB0H',0,"SkeletonKing_HellfireBlast")
  call SaveStr(MHT,'A2S0',0,"SkeletonKing_MortalStrike_RegSup")
  call SaveStr(MHT,'A0N8',0,"Meepo_Poof")
  call SaveStr(MHT,'A0NB',0,"Meepo_Earthbind")
  call SaveStr(MHT,'Z397',0,"Leshrak_SplitEarth")
  call SaveStr(MHT,'QB0F',0,"Leshrak_SplitEarth")
  call SaveStr(MHT,'A06V',0,"Leshrak_Lightnings")
  
  call SaveStr(MHT,'A20T',0,"Leshrak_DiabolicEdict")
  call SaveStr(MHT,'A21G',0,"Leshrak_PulseNova")
  call SaveStr(MHT,'A21F',0,"Leshrak_PulseNova")
  call SaveStr(MHT,'A05T',0,"Lich_ChainFrost")
  call SaveStr(MHT,'A08H',0,"Lich_ChainFrost")
  call SaveStr(MHT,'A0X5',0,"Lion_Impale")
  call SaveStr(MHT,'A053',0,"Lich_DarkRitual")
  call SaveStr(MHT,'A093',0,"Lycan_Shapeshift")
  call SaveStr(MHT,'QM02',0,"Lycan_Shapeshift")
  call SaveStr(MHT,'A03D',0,"Lycan_SpiritWolves")
  call SaveStr(MHT,'A0ZF',0,"Lycan_Howl")
  call SaveStr(MHT,'A094',0,"Doom_LvlDeath")
  call SaveStr(MHT,'A10R',0,"Doom_Devour")
  call SaveStr(MHT,'A1OP',0,"Doom_ScorchedEarth")
  call SaveStr(MHT,'A0A2',0,"DoomAghActStart")
  call SaveStr(MHT,'A29L',0,"Magnus_ReversePolarity")
  call SaveStr(MHT,'A447',0,"Magnus_ReversePolarity")
  call SaveStr(MHT,'A037',0,"Magnus_Empower")
  call SaveStr(MHT,'A1RD',0,"Magnus_Skewer")
  call SaveStr(MHT,'A0G2',0,"Medusa_MysticSnake")
  call SaveStr(MHT,'A1C0',0,"Medusa_SplitShot")
  call SaveStr(MHT,'A418',0,"Medusa_SplitShotOff")
  call SaveStr(MHT,'A1AT',0,"Medusa_StoneGaze_Start")
  call SaveStr(MHT,'QB10',0,"Medusa_StoneGaze_Start")
  call SaveStr(MHT,'A194',0,"Lifestealer_OpenWounds")
  call SaveStr(MHT,'A0SW',0,"Lifestealer_Infest")
  call SaveStr(MHT,'A0T2',0,"Lifestealer_Rage")
  call SaveStr(MHT,'QB0Q',0,"Lifestealer_Rage")
  call SaveStr(MHT,'A05V',0,"Necrolyte_DeathPulse")
  call SaveStr(MHT,'A067',0,"Necrolyte_ReapersScythe")
  call SaveStr(MHT,'A08P',0,"Necrolyte_ReapersScythe")
  call SaveStr(MHT,'A0X7',0,"NA_Impale")
  call SaveStr(MHT,'A1H5',0,"NA_Manaburn")
  call SaveStr(MHT,'A2KO',0,"NA_SpikedCarapace")
  call SaveStr(MHT,'A0FH',0,"Shadowraze_Cast")
  call SaveStr(MHT,'A0F0',0,"Shadowraze_Cast")
  call SaveStr(MHT,'A0EY',0,"Shadowraze_Cast")
  call SaveStr(MHT,'A29J',0,"SF_RequiemOfSouls")
  call SaveStr(MHT,'A1MP',0,"SF_RequiemOfSouls")
  call SaveStr(MHT,'A344',0,"TrueForm_BattleRoar")
  call SaveStr(MHT,'A34C',0,"TrueForm_BattleRoar")
  
  call SaveStr(MHT,'A02H',0,"NightHunter_Void")
  call SaveStr(MHT,'A0YM',0,"PA_StiflingDagger")
  call SaveStr(MHT,'A0PL',0,"PA_Blink")
  call SaveStr(MHT,'A0RA',0,"PitLord_PitOfMalice")
  call SaveStr(MHT,'A06I',0,"Pudge_MeatHook")
  call SaveStr(MHT,'A1CX',0,"Pudge_Dismember")
  call SaveStr(MHT,'A2TD',0,"Oblivion_Decripify_Act")
  call SaveStr(MHT,'A1E7',0,"Razor_PlasmaField")
  call SaveStr(MHT,'A1AO',0,"Razor_EyeOfTheStorm")
  call SaveStr(MHT,'A1UV',0,"Razor_EyeOfTheStorm")
  call SaveStr(MHT,'A06O',0,"SK_Burrowstrike")
  call SaveStr(MHT,'A0H0',0,"SK_Sandstorm")
  call SaveStr(MHT,'A29K',0,"Slardar_SlithereenCrush")
  call SaveStr(MHT,'QB0I',0,"Slardar_SlithereenCrush")
  call SaveStr(MHT,'A0HW',0,"Spectre_SpectralDagger")
  call SaveStr(MHT,'A0H9',0,"Spectre_Haunt")
  call SaveStr(MHT,'A0HA',0,"Spectre_Reality")
  call SaveStr(MHT,'A0G4',0,"Spiritbreaker_NetherStrike")
  call SaveStr(MHT,'A1D8',0,"Spiritbreaker_NetherStrike")
  call SaveStr(MHT,'A07Q',0,"TB_Sunder")
  call SaveStr(MHT,'A0H4',0,"TB_ConjureImage")
  call SaveStr(MHT,'A046',0,"Tidehunter_Gush")
  call SaveStr(MHT,'A29I',0,"Tidehunter_Ravage")
  call SaveStr(MHT,'A226',0,"Tidehunter_AnchorSmash")
  call SaveStr(MHT,'A0MU',0,"Doom_DoomCast")
  call SaveStr(MHT,'A0OR',0,"Dazzle_ShadowWave")
  call SaveStr(MHT,'A0NQ',0,"Dazzle_PoisonTouch")
  call SaveStr(MHT,'A10Q',0,"Dazzle_Weave")
  call SaveStr(MHT,'A1DB',0,"Dazzle_Weave")
  call SaveStr(MHT,'A10L',0,"Dazzle_Grave")
  call SaveStr(MHT,'A173',0,"Venomancer_VenomousGale")
  call SaveStr(MHT,'A013',0,"Venomancer_PoisonNova")
  call SaveStr(MHT,'A0A6',0,"Venomancer_PoisonNova")
  call SaveStr(MHT,'A1UZ',0,"Viper_ViperStrike")
  call SaveStr(MHT,'A080',0,"Viper_ViperStrike")
  call SaveStr(MHT,'A08X',0,"Visage_GraveChill")
  call SaveStr(MHT,'A1NE',0,"Visage_Familiars")
  call SaveStr(MHT,'A2IG',0,"Visage_Familiars")
  call SaveStr(MHT,'A1NA',0,"Visage_SoulAssumption")
  call SaveStr(MHT,'A06P',0,"WL_Upheaval")
  call SaveStr(MHT,'A0J5',0,"WL_FatalBounds")
  call SaveStr(MHT,'A0AS',0,"WL_ShadowWord")
  call SaveStr(MHT,'S00U',0,"WL_Infernal")
  call SaveStr(MHT,'A0CT',0,"Weaver_TimeLapse")
  call SaveStr(MHT,'A1QW',0,"Weaver_TheSwarm")
  call SaveStr(MHT,'A0NM',0,"WD_ParalyzingCask")
  call SaveStr(MHT,'A0NE',0,"WD_VoodooRestoration")
  call SaveStr(MHT,'A0NO',0,"WD_Maledict")
  call SaveStr(MHT,'A0NT',0,"WD_DeathWard")
  call SaveStr(MHT,'A0NX',0,"WD_DeathWard")
  call SaveStr(MHT,'A1HS',0,"AA_IceVortex")
  call SaveStr(MHT,'A1MG',0,"AA_ColdFeet")
  call SaveStr(MHT,'A1MI',0,"AA_IceBlast")
  call SaveStr(MHT,'A2QE',0,"AA_IceBlast")
  call SaveStr(MHT,'A1HQ',0,"AA_ChillingTouch")
  call SaveStr(MHT,'A1IM',0,"Slark_DarkPact")
  call SaveStr(MHT,'A1IN',0,"Slark_ShadowDance")
  call SaveStr(MHT,'A1J7',0,"Slark_Pounce")
  call SaveStr(MHT,'A04A',0,"QoP_ScreamOfPain")
  call SaveStr(MHT,'A28R',0,"MyQoPSWBasic")
  call SaveStr(MHT,'A28S',0,"MyQoPSW")
  call SaveStr(MHT,'A45W',0,"Queen_VitalStrike")
  call SaveStr(MHT,'A45X',0,"Queen_ArrowShower")
  
  
  call SaveStr(MHT,'A00P',0,"ShadowShaman_Shackles")
  call SaveStr(MHT,'A1RJ',0,"Phoenix_Dive")
  call SaveStr(MHT,'A461',0,"Queen_Snatch")
  call SaveStr(MHT,'A1RK',0,"Phoenix_Supernova")
  call SaveStr(MHT,'A43H',0,"Phoenix_Supernova")
  
  call SaveStr(MHT,'A1YX',0,"Phoenix_FireSpirits")
  call SaveStr(MHT,'A1S4',0,"SD_ShadowPoison")
  call SaveStr(MHT,'A1S8',0,"SD_Disruption")
  call SaveStr(MHT,'A1SB',0,"SD_SoulCatcher")
  call SaveStr(MHT,'A343',0,"SD_DemonicPurge")
  call SaveStr(MHT,'A34J',0,"SD_DemonicPurgeAgh")
  call SaveStr(MHT,'A1SO',0,"Gyro_RocketBarrage")
  call SaveStr(MHT,'A1SQ',0,"Gyro_HomingMissile")
  call SaveStr(MHT,'A1T5',0,"Gyro_Calldown")
  call SaveStr(MHT,'A235',0,"Gyro_Calldown")
  call SaveStr(MHT,'A229',0,"Gyro_FlakCannon")
  call SaveStr(MHT,'A1SU',0,"Disruptor_KineticField")
  call SaveStr(MHT,'A1SW',0,"Disruptor_Glimpse")
  call SaveStr(MHT,'A1TV',0,"Disruptor_ThunderStrike_StartSup")
  call SaveStr(MHT,'A1U6',0,"Disruptor_StaticField")
  call SaveStr(MHT,'A30N',0,"Disruptor_StaticField")
  call SaveStr(MHT,'A2KQ',0,"UnrefinedFireblast")
  call SaveStr(MHT,'A1PH',0,"TB_SoulSteal")
  
  call SaveStr(MHT,'A1T8',0,"Wisp_Spirits")
  call SaveStr(MHT,'A1TA',0,"Wisp_Tether")
  call SaveStr(MHT,'A1TB',0,"Wisp_Relocate")
  call SaveStr(MHT,'A1YO',0,"Tuskar_IceShards")
  call SaveStr(MHT,'A1YQ',0,"Tuskar_WalrusPunch")
  call SaveStr(MHT,'A1S7',0,"Tuskar_Snowball")
  call SaveStr(MHT,'A27F',0,"Rubick_Telekinesis")
  call SaveStr(MHT,'A27G',0,"Rubick_Fadebolt")
  call SaveStr(MHT,'A27H',0,"Rubick_SpellSteal")
  call SaveStr(MHT,'A30J',0,"Rubick_SpellSteal")
  call SaveStr(MHT,'A073',0,"Banshee_Exorcism")
  call SaveStr(MHT,'A03J',0,"Banshee_Exorcism")
  call SaveStr(MHT,'A04J',0,"Banshee_Exorcism")
  call SaveStr(MHT,'A04M',0,"Banshee_Exorcism")
  call SaveStr(MHT,'A04N',0,"Banshee_Exorcism")
  call SaveStr(MHT,'A2HS',0,"Xin_FlameGuard")
  call SaveStr(MHT,'A2H0',0,"Xin_SleightOfFistWrap")
  call SaveStr(MHT,'QB0L',0,"Xin_SleightOfFistWrap")
  call SaveStr(MHT,'A2H3',0,"Xin_SearingChains")
  call SaveStr(MHT,'A2JO',0,"Xin_FireRemnants")
  call SaveStr(MHT,'A2JQ',0,"Xin_FireRemnants")
  call SaveStr(MHT,'A2JP',0,"Xin_FireRemnants")
  call SaveStr(MHT,'A2JR',0,"Xin_FireRemnants")
  call SaveStr(MHT,'A2JL',0,"Xin_FireRemnantsB")
  call SaveStr(MHT,'A2CI',0,"LegionCommander_Duel")
  call SaveStr(MHT,'A2J2',0,"LegionCommander_PressTheAttack")
  call SaveStr(MHT,'A2JB',0,"LegionCommander_OverhelmingOdds")
  call SaveStr(MHT,'A2BG',0,"Skywrath_MysticFlare")
  call SaveStr(MHT,'A30H',0,"Skywrath_MysticFlare")
  call SaveStr(MHT,'A2BE',0,"Skywrath_ArcaneBolt")
  call SaveStr(MHT,'A2HN',0,"Skywrath_AncientSeal")
  call SaveStr(MHT,'A2IT',0,"Skywrath_ConcussiveShot")
  call SaveStr(MHT,'A2FK',0,"Shredder_WhirlingDeath")
  call SaveStr(MHT,'A2E3',0,"Shredder_Timberchain")
  call SaveStr(MHT,'A2E5',0,"Shredder_Chakram")
  call SaveStr(MHT,'A43Q',0,"Shredder_Chakram")
  call SaveStr(MHT,'A43S',0,"Shredder_Chakram")
  
  call SaveStr(MHT,'A45H',0,"KotaKotaWinds")
  
  call SaveStr(MHT,'A11N',0,"Admiral_XMark_Effectsup")
  call SaveStr(MHT,'A300',0,"Beastmaster_CallHawk")
  call SaveStr(MHT,'A301',0,"Beastmaster_CallBeast")
  call SaveStr(MHT,'A07F',0,"Lich_FrostNova_Start")
  call SaveStr(MHT,'A0CC',0,"Oblivion_LifeDrain_Start")
  call SaveStr(MHT,'A02Z',0,"Oblivion_LifeDrain_Start")
  call SaveStr(MHT,'A32A',0,"Kodo_Spit")
  call SaveStr(MHT,'A32C',0,"Kodo_Trample")
  call SaveStr(MHT,'A32E',0,"Kodo_Digest")
  call SaveStr(MHT,'A32D',0,"Kodo_DigestSpitEffectSup")
  call SaveStr(MHT,'A32G',0,"Kodo_DrumWars")
  call SaveStr(MHT,'A004',0,"Bounty_ShurikenToss")
  call SaveStr(MHT,'A0GK',0,"Bane_BrainSap")
  call SaveStr(MHT,'A0R0',0,"PitLord_DarkRift")
  call SaveStr(MHT,'A04C',0,"CM_FrostBite")
  call SaveStr(MHT,'A44U',0,"OgreLord_AnteUpWrap")
  call SaveStr(MHT,'A44X',0,"BloodrageNewStart")
  call SaveStr(MHT,'A44Z',0,"BloodRite")
  
  call SaveStr(MHT,'A451',0,"FirewallAct")
  call SaveStr(MHT,'A456',0,"InfernoAct")
  call SaveStr(MHT,'A454',0,"FireStompActEffect")
  
  call SaveStr(MHT,'A2LB',0,"Wyvern_Embrace_Start")
  call SaveStr(MHT,'A0Z0',0,"Wyvern_Curse_Real_Start")
  call SaveStr(MHT,'A01Z',0,"Tree_Invis_Start")
  call SaveStr(MHT,'A0CA',0,"Weaver_Shukuchi_Start")
  call SaveStr(MHT,'A2N1',0,"Shadow_Amulet_Condition")
  call SaveStr(MHT,'A055',0,"Chaos_Bolt_Wrap")
  call SaveStr(MHT,'A085',0,"Keeper_Illuminate_Start")
  call SaveStr(MHT,'A121',0,"Keeper_Illuminate_End")
  call SaveStr(MHT,'A07Z',0,"Tree_Overgrowth_Start")
  call SaveStr(MHT,'A44S',0,"Tree_Overgrowth_Start")
  call SaveStr(MHT,'A01V',0,"EyeInTheForest")
  call SaveStr(MHT,'A1HH',0,"UrnaSwarmInfestB")
  
  
  call SaveStr(MHT,'A2K4',0,"Halberd_Start")
  
  call SaveStr(MHT,'QB00',0,"Chaos_Bolt_Wrap")
  call SaveStr(MHT,'QB01',0,"Weaver_Shukuchi_Start")
  call SaveStr(MHT,'QB04',0,"Silencer_LastWord")
  
  call SaveStr(MHT,'A2O2',0,"Drow_Trueshot_Toggling")
  //call SaveStr(MHT,'A528',0,"Tinker_Rearm_DummySpell")
  call SaveStr(MHT,'A34A',0,"CheatDeath_Use")
  call SaveStr(MHT,'A40K',0,"Formless_SpellCast")
  call SaveStr(MHT,'A40L',0,"Formless_SpellCast")
  call SaveStr(MHT,'A40M',0,"Formless_SpellCast")
  call SaveStr(MHT,'A40N',0,"Formless_SpellCast")
  call SaveStr(MHT,'A2TI',0,"Kaolin_Magnetize_Init")
  call SaveStr(MHT,'A29J',0,"RequiemWrapper")
  call SaveStr(MHT,'A02A',0,"VS_MagicMissile_Wrap")
  
  call SaveStr(MHT,'A1AU',0,"Sniper_Agh")
  
  call SaveStr(MHT,'QB0J',0,"Ogre_Fireblast_Wrap")
  call SaveStr(MHT,'A04W',0,"Ogre_Fireblast_Wrap")
  call SaveStr(MHT,'A42I',0,"CrimsonGuard_Act")
  call SaveStr(MHT,'A42W',0,"Butterfly_Flutter")
  call SaveStr(MHT,'A44V',0,"OgreLord_CashIn")
  
  //ITEMS store: they are called via different trigger but still its more useful to keep here
  call SaveStr(MHT,'A02X',12,"NewWards")
  call SaveStr(MHT,'AIsw',12,"NewWards")
  call SaveStr(MHT,'A0H6',12,"EOD")
  call SaveStr(MHT,'A0B6',12,"EBD")
  call SaveStr(MHT,'A0JT',12,"E3D")
  call SaveStr(MHT,'A0OT',12,"FSD")
  call SaveStr(MHT,'Aeat',12,"FLD")
  call SaveStr(MHT,'ANTG',12,"FLD")
  call SaveStr(MHT,'A231',12,"GQD")
  call SaveStr(MHT,'A1R5',12,"GQD")
  call SaveStr(MHT,'A0HB',12,"GUD")
  call SaveStr(MHT,'A0D3',12,"GUD")
  call SaveStr(MHT,'A0DF',12,"GUD")
  call SaveStr(MHT,'ACch',12,"GWDb")
  call SaveStr(MHT,'A11F',12,"GBD")
  call SaveStr(MHT,'A11E',12,"GBD")
  call SaveStr(MHT,'A0S3',12,"GBD")
  call SaveStr(MHT,'A11D',12,"GBD")
  call SaveStr(MHT,'A11G',12,"GBD")
  call SaveStr(MHT,'A11H',12,"GBD")
  call SaveStr(MHT,'A0CK',12,"G3D")
  call SaveStr(MHT,'A1FP',12,"GVD")
  call SaveStr(MHT,'A02W',12,"G5D")
  call SaveStr(MHT,'A0FD',12,"H8D")
  call SaveStr(MHT,'A0JL',12,"HHD")
  call SaveStr(MHT,'A0T9',12,"HPD")
  call SaveStr(MHT,'A0VR',12,"HID")
  call SaveStr(MHT,'A0JY',12,"HUD")
  call SaveStr(MHT,'A138',12,"LZ9")
  call SaveStr(MHT,'A14C',12,"LZ9")
  call SaveStr(MHT,'A14D',12,"LX9")
  call SaveStr(MHT,'A141',12,"H5D")
  call SaveStr(MHT,'A1WI',12,"H5D")
  call SaveStr(MHT,'A12W',12,"I4D")
  call SaveStr(MHT,'A15W',12,"BladeMailSpell")
  call SaveStr(MHT,'A19M',12,"IGD")
  call SaveStr(MHT,'A1AC',12,"IRD")
  call SaveStr(MHT,'A1AS',12,"I3D")
  call SaveStr(MHT,'A2KS',12,"BSO")
  call SaveStr(MHT,'A0GD',12,"FAD")
  call SaveStr(MHT,'A1EW',12,"G1D")
  call SaveStr(MHT,'A0B8',12,"I1D")
  call SaveStr(MHT,'A1WE',12,"I1D")
  call SaveStr(MHT,'A1MO',12,"J4D")
  call SaveStr(MHT,'A1Q8',12,"IAD")
  call SaveStr(MHT,'A1QD',12,"IOD")
  call SaveStr(MHT,'A1T7',12,"KID")
  call SaveStr(MHT,'A0K7',12,"KHD")
  call SaveStr(MHT,'A28Y',12,"KDD")
  call SaveStr(MHT,'A1ZI',12,"J5D")
  call SaveStr(MHT,'A1ZW',12,"JDD")
  call SaveStr(MHT,'A206',12,"JMD")
  call SaveStr(MHT,'A28D',12,"JPD")
  call SaveStr(MHT,'A2EA',12,"JUD")
  call SaveStr(MHT,'A2HQ',12,"J3D")
  call SaveStr(MHT,'A02O',12,"JBD")
  call SaveStr(MHT,'A08Y',12,"JBD")
  call SaveStr(MHT,'A08Z',12,"JBD")
  call SaveStr(MHT,'A090',12,"JBD")
  call SaveStr(MHT,'A092',12,"JBD")
  call SaveStr(MHT,'A2TK',12,"Item_Bloodstone_Init")
  call SaveStr(MHT,'AItb',12,"Item_Dust_Init")
  call SaveStr(MHT,'A1FD',12,"Item_QuellingBlade_Reg")
  call SaveStr(MHT,'A0JZ',12,"Courier_Burst")
  
  
  //EVENT_UNIT_SPELL_ENDCAST
  call SaveStr(MHT,'A1P8',1,"Spiritbreaker_Charge_Stop")
  call SaveStr(MHT,'A085',1,"Keeper_Illuminate_Check")
  call SaveStr(MHT,'A2QT',1,"Oracle_FortunesEnd_PreEnd")
  
  
  
  //EVENT_UNIT_SPELL_FINISH
  call SaveStr(MHT,'A1AA',2,"Tauren_Stomp_Effect")
  call SaveStr(MHT,'A2LK',2,"Tauren_Stomp_Effect")
  call SaveStr(MHT,'A065',2,"Rearm_Effect")
  call SaveStr(MHT,'A0BE',2,"TrollRageMorph")
  //call SaveStr(MHT,'A44V',2,"OgreLord_CashInWrap")
  
  //EVENT_UNIT_SPELL_CAST
  call SaveStr(MHT,'A064',3,"Sniper_Shrapnel_OnCast")
  call SaveStr(MHT,'A0AM',3,"RemoteMineActivation")
  call SaveStr(MHT,'A0A3',3,"RemoteMineActivation")
  call SaveStr(MHT,'A0A4',3,"RemoteMineActivation")
  call SaveStr(MHT,'A1FZ',3,"RemoteMineActivation")
  call SaveStr(MHT,'A1WF',3,"RemoteMineFocused")
  call SaveStr(MHT,'A451',3,"FirewallOnCast")
  call SaveStr(MHT,'A0AS',3,"WL_ShadowWordOnCast")
  call SaveStr(MHT,'A0BQ',3,"Tinker_MarchOfMachines_OnCast")
  call SaveStr(MHT,'A0SW',3,"Lifestealer_Infest_OnCast")
  call SaveStr(MHT,'A0EC',3,"BS_Bloodrage_StopCastInit")
  call SaveStr(MHT,'A2QM',3,"Kaolin_BoulderSmash_OnCast_Wrap")
  call SaveStr(MHT,'A04Y',3,"Bane_Nightmare_OnCast")
  call SaveStr(MHT,'A34A',3,"CheatDeath_Cast")
  call SaveStr(MHT,'A34J',3,"SD_DemonicPurgeAghCast")
  call SaveStr(MHT,'A1AA',3,"Tauren_Stomp_Check")
  call SaveStr(MHT,'A2LK',3,"Tauren_Stomp_Check")
  call SaveStr(MHT,'A11N',3,"Admiral_XMark_OnCastsup")
  call SaveStr(MHT,'AEbl',3,"AM_Blink_OnCast")
  call SaveStr(MHT,'QB08',3,"AM_Blink_OnCast")
  call SaveStr(MHT,'A00L',3,"Double_Edge_Condtionsup")
  call SaveStr(MHT,'A28T',3,"Chen_HolyPersuation_OnCast")
  call SaveStr(MHT,'A14O',3,"Storm_BallLightning_OnCast")
  call SaveStr(MHT,'A2QI',3,"Kaolin_GeomagneticGrip_Cast")
  call SaveStr(MHT,'A2QT',3,"Oracle_FortunesEnd_OnCastSup")
  call SaveStr(MHT,'A180',3,"Enigma_DemonicConversion_OnCast")
  call SaveStr(MHT,'A1BX',3,"Enigma_BlackHole_OnCast")
  call SaveStr(MHT,'A30L',3,"Enigma_BlackHole_OnCast")
  call SaveStr(MHT,'A21E',3,"Prophet_NaturesWrath_OnCast")
  call SaveStr(MHT,'A0M1',3,"Juggernaut_Omnislash_OnCast")
  call SaveStr(MHT,'A1AX',3,"Juggernaut_Omnislash_OnCast")
  call SaveStr(MHT,'A10U',3,"Kotl_Recall_OnCast")
  //call SaveStr(MHT,'A11Y',3,"Kotl_Recall_OnCast")
  //call SaveStr(MHT,'A11Z',3,"Kotl_Recall_OnCast")
  call SaveStr(MHT,'A01P',3,"Lina_LagunaBlade_OnCast")
  //call SaveStr(MHT,'A09Z',3,"Lina_LagunaBlade_OnCast")
  call SaveStr(MHT,'A24D',3,"Naga_Ensnare_OnCast")
  call SaveStr(MHT,'A10D',3,"PL_SpiritLance_OnCast")
  call SaveStr(MHT,'A0K9',3,"Rikimaru_BlinkStrike_OnCast")
  call SaveStr(MHT,'A190',3,"Sven_StormBolt_OnCast")
  call SaveStr(MHT,'A0BZ',3,"Tiny_Toss_OnCast")
  call SaveStr(MHT,'A0IN',3,"VS_NetherSwap_OnCast")
  call SaveStr(MHT,'A1AW',3,"VS_NetherSwap_OnCast")
  call SaveStr(MHT,'A02A',3,"VS_MagicMissile_OnCast")
  call SaveStr(MHT,'A0RW',3,"CK_RealityRift_OnCast")
  call SaveStr(MHT,'A0OJ',3,"OD_AstralImprisonment_OnCast")
  call SaveStr(MHT,'A0QE',3,"DS_Vacuum_OnCast")
  call SaveStr(MHT,'AHtb',3,"SkeletonKing_HellfireBlast_OnCast")
  call SaveStr(MHT,'QB0H',3,"SkeletonKing_HellfireBlast_OnCast")
  call SaveStr(MHT,'A0R0',3,"Pitlord_DarkRift_OnCast")
  call SaveStr(MHT,'A226',3,"Tidehunter_AnhorSmash_OnCast")
  call SaveStr(MHT,'A32D',3,"Kodo_DigestSpitCast")
  call SaveStr(MHT,'A08C',3,"Fear_Night_OnCast")
  call SaveStr(MHT,'A2TD',3,"Oblivion_Decripify_OnCast")
  call SaveStr(MHT,'A095',3,"Lion_Finger_OnCast")
  call SaveStr(MHT,'A09W',3,"Lion_Finger_OnCast")
  call SaveStr(MHT,'A12K',3,"WR_Powershot_OnCast")
  call SaveStr(MHT,'A12P',3,"FocusFire_OnCast")
  call SaveStr(MHT,'A1D6',3,"FocusFire_OnCast")
  call SaveStr(MHT,'A1S8',3,"SD_Disruption_OnCast")
  call SaveStr(MHT,'A1TB',3,"Wisp_Relocate_OnCast")
  call SaveStr(MHT,'QB0L',3,"SleightOfFistAbuseStop")
  call SaveStr(MHT,'A2H0',3,"SleightOfFistAbuseStop")
  call SaveStr(MHT,'A0B1',3,"Enigma_MidnightPulse_OnCast")
  
  //EVENT_UNIT_HERO_SKILL   // only called the first time the spell is leveled
  call SaveStr(MHT,'A064',4,"ShrapnelInitRecharging")
  call SaveStr(MHT,'A1P8',4,"Spiritbreaker_Charge_Learn")
  call SaveStr(MHT,'A21L',4,"Warlord_WhirlingAxes_Learn")
  call SaveStr(MHT,'QP1Z',4,"Bloodseeker_Thrist_Learn")
  call SaveStr(MHT,'A0I8',4,"Bloodseeker_Thrist_Learn")
  call SaveStr(MHT,'QP22',4,"Void_Backtrack_Init")
  call SaveStr(MHT,'A0CZ',4,"Void_Backtrack_Init")
  call SaveStr(MHT,'A0AK',4,"HCF")
  call SaveStr(MHT,'A1FY',4,"HCF")
  call SaveStr(MHT,'A0S1',4,"PHF")
  
  call SaveStr(MHT,'QP08',4,"Riki_PermanentInvis_Learnd")
  call SaveStr(MHT,'A0MB',4,"Riki_PermanentInvis_Learnd")
  call SaveStr(MHT,'A0MX',4,"Brewmaster_Brawler")
  call SaveStr(MHT,'QP0H',4,"Brewmaster_Brawler")
  call SaveStr(MHT,'A34J',4,"SD_DemonicPurgeAgh_Learn")
  call SaveStr(MHT,'A32G',4,"Kodo_DigestBonuses")
  call SaveStr(MHT,'AIcd',4,"Pitlord_Atrophy_Init")
  call SaveStr(MHT,'QP1C',4,"Pitlord_Atrophy_Init")
  //call SaveStr(MHT,'A0O3',4,"Alchemist_Greed_Learn")
  //call SaveStr(MHT,'QP0O',4,"Alchemist_Greed_Learn")
  call SaveStr(MHT,'A0NS',4,"Abbadon_Time_Learn")
  call SaveStr(MHT,'A1DA',4,"Abbadon_Time_Learn")
  call SaveStr(MHT,'A517',4,"Abbadon_Time_Learn")
  call SaveStr(MHT,'A518',4,"Abbadon_Time_Learn")
  call SaveStr(MHT,'A0RP',4,"Templar_Trap_Learn")
  call SaveStr(MHT,'A449',4,"Templar_Trap_Learn")
  
  call SaveStr(MHT,'QP28',4,"CheatDeath_Learn")
  call SaveStr(MHT,'A34A',4,"CheatDeath_Learn")
  call SaveStr(MHT,'A2O2',4,"MyTrueshot")
  call SaveStr(MHT,'QF88',4,"Trax_Marksmanship_learn")
  call SaveStr(MHT,'A062',4,"Luna_Aura_Learn")
  call SaveStr(MHT,'QP0E',4,"Luna_Aura_Learn")
  call SaveStr(MHT,'A524',4,"Bounty_Jinada_LearnTrigger")
  call SaveStr(MHT,'A0M3',4,"BB_BB_Learn")
  call SaveStr(MHT,'QP1M',4,"BB_BB_Learn")
  call SaveStr(MHT,'A06B',4,"Techies_SuicideSquad_Learn")
  call SaveStr(MHT,'A01N',4,"Necrolyte_Heartstopper_Learn")
  call SaveStr(MHT,'QP11',4,"Necrolyte_Heartstopper_Learn")
  call SaveStr(MHT,'A0BR',4,"SF_Necromastery_Learn")
  call SaveStr(MHT,'QP0R',4,"PhantomAssassin_Blur_Learn")
  call SaveStr(MHT,'A03P',4,"PhantomAssassin_Blur_Learn")
  call SaveStr(MHT,'A06D',4,"Butcher_FleshHeap_Learn")
  call SaveStr(MHT,'QP13',4,"Butcher_FleshHeap_Learn")
  call SaveStr(MHT,'QP10',4,"Tidehunter_KrakenShell_Learn")
  call SaveStr(MHT,'A04E',4,"Tidehunter_KrakenShell_Learn")
  call SaveStr(MHT,'A0MM',4,"Viper_CorrosiveSkin_Reg2")
  call SaveStr(MHT,'QP0Y',4,"Viper_CorrosiveSkin_Reg2")
  call SaveStr(MHT,'A1NA',4,"Visage_SoulAssumption_Learn")
  call SaveStr(MHT,'A0NA',4,"Spectre_Dispersion_Learn")
  call SaveStr(MHT,'QP20',4,"Spectre_Dispersion_Learn")
  call SaveStr(MHT,'A0H9',4,"Spectre_AddHaunt")
  call SaveStr(MHT,'A1E6',4,"Razor_UnstableCurrent_Learn")
  call SaveStr(MHT,'QP0Z',4,"Razor_UnstableCurrent_Learn")
  call SaveStr(MHT,'A0QQ',4,"Huskar_BerserkerBlood_Learn")
  call SaveStr(MHT,'QP1L',4,"Huskar_BerserkerBlood_Learn")
  call SaveStr(MHT,'A0QW',4,"StormSpirit_Overload_Learn")
  call SaveStr(MHT,'QP1V',4,"StormSpirit_Overload_Learn")
  call SaveStr(MHT,'A1EA',4,"TemplarAssassin_Refraction_Learn")
  call SaveStr(MHT,'QB03',4,"TemplarAssassin_Refraction_Learn")
  call SaveStr(MHT,'A01Y',4,"Leoric_Reincarnation_Learn")
  call SaveStr(MHT,'A18X',4,"Lina_FierySoul_Learn")
  call SaveStr(MHT,'QP1U',4,"Lina_FierySoul_Learn")
  call SaveStr(MHT,'A1CD',4,"Chieftain_NaturalOrder_Learning")
  call SaveStr(MHT,'QP1I',4,"Chieftain_NaturalOrder_Learning")
  call SaveStr(MHT,'A1IN',4,"Slark_ShadowDance_Learn")
  call SaveStr(MHT,'A28Q',4,"Wisp_Overcharge_Learn")
  call SaveStr(MHT,'A27V',4,"Rubick_NullField_Learn")
  call SaveStr(MHT,'QP0P',4,"Rubick_NullField_Learn")
  
  
  //Called everytime as 5th or 6th skill obtained FIRST time. They have no Learn trigger, so u have to list functions here
  call SaveStr(MHT,'A064',1000,"ShrapnelInitRecharging")
  call SaveStr(MHT,'A0CG',1000,"GeminateAttack_Learn")
  call SaveStr(MHT,'A086',1000,"HunterInTheNight_Leveling")
  call SaveStr(MHT,'A43S',1000,"ChakramLevelup")
  call SaveStr(MHT,'A0BR',1000,"SF_Necromastery_Learn")
  call SaveStr(MHT,'A0EY',1000,"SF_Shadowrazes_Learn")
  call SaveStr(MHT,'A03E',1000,"Lycan_FeralImpulse_Leveling")
  call SaveStr(MHT,'A32G',1000,"Kodo_DigestBonuses")
  call SaveStr(MHT,'A0MX',1000,"Brewmaster_Brawler")
  call SaveStr(MHT,'A21M',1000,"Warlord_WhirlingAxes_Learn")
  call SaveStr(MHT,'A34A',1000,"CheatDeath_Learn")
  
  call SaveStr(MHT,'A40B',1000,"Ogre_Bloodlust_Learn")
  call SaveStr(MHT,'A2O2',1000,"MyTrueshot")
  call SaveStr(MHT,'A34J',1000,"SD_DemonicPurgeAgh_Learn")
  call SaveStr(MHT,'A0MB',1000,"Riki_PermanentInvis_Learnd")
  call SaveStr(MHT,'P019',1000,"Maiden_Brilliance_Learn")
  //call SaveStr(MHT,'A0O3',1000,"Alchemist_Greed_Learn")
  call SaveStr(MHT,'A1P8',1000,"Spiritbreaker_Charge_Learn")
  call SaveStr(MHT,'A0RP',1000,"Templar_Trap_Learn")
  call SaveStr(MHT,'A449',1000,"Templar_Trap_Learn")
  call SaveStr(MHT,'AIcd',1000,"Pitlord_Atrophy_Init")
  call SaveStr(MHT,'QF88',1000,"Trax_Marksmanship_learn")
  call SaveStr(MHT,'A1IN',1000,"Slark_ShadowDance_Learn")
  call SaveStr(MHT,'A13T',1000,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A522',1000,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A19Q',1000,"Tiny_CraggyExterior_Learning")
  call SaveStr(MHT,'A0CY',1000,"Tiny_Grow_Learning")
  call SaveStr(MHT,'A1CD',1000,"Chieftain_NaturalOrder_Learning")
  
  call SaveStr(MHT,'A0QQ',1000,"Huskar_BerserkerBlood_Learn")
  call SaveStr(MHT,'A0M3',1000,"Bristleback_Bristleback_Learn")
  call SaveStr(MHT,'A03U',1000,"Sniper_TakeAim_Learn")
  
  call SaveStr(MHT,'A062',1000,"Luna_Aura_Learn")
  call SaveStr(MHT,'A0KX',1000,"Morphling_Morph_Learn")
  call SaveStr(MHT,'A0A5',1000,"LoneDruid_SpiritBear_Leveling")
  call SaveStr(MHT,'A27V',1000,"Rubick_NullField_Learn")
  call SaveStr(MHT,'A28Q',1000,"Wisp_Overcharge_Learn")
  call SaveStr(MHT,'A18X',1000,"Lina_FierySoul_Learn")
  call SaveStr(MHT,'A11N',1000,"Admiral_XMark_Learn")
  call SaveStr(MHT,'A01Y',1000,"Leoric_Reincarnation_Learn")
  
  call SaveStr(MHT,'A0RO',1000,"TemplarAssassin_PsiBlades_Leveling")
  call SaveStr(MHT,'A0QW',1000,"StormSpirit_Overload_Learn")
  call SaveStr(MHT,'A1E6',1000,"Razor_UnstableCurrent_Learn")
  call SaveStr(MHT,'A0NA',1000,"Spectre_Dispersion_Learn")
  call SaveStr(MHT,'A0NS',1000,"Abbadon_Time_Learn")
  call SaveStr(MHT,'A0VX',1000,"Visage_GravekeeperCloak_Leveling")
  call SaveStr(MHT,'A1NA',1000,"Visage_SoulAssumption_Learn")
  call SaveStr(MHT,'A04E',1000,"Tidehunter_KrakenShell_Learn")
  
  call SaveStr(MHT,'A06D',1000,"Butcher_FleshHeap_Learn")
  
  call SaveStr(MHT,'A03P',1000,"PhantomAssassin_Blur_Learn")
  call SaveStr(MHT,'A01N',1000,"Necrolyte_Heartstopper_Learn")
  call SaveStr(MHT,'A0I8',1000,"Bloodseeker_Thrist_Learn")
  call SaveStr(MHT,'A06B',1000,"Techies_SuicideSquad_Learn")
  call SaveStr(MHT,'A1IQ',1000,"Bounty_Jinada_Learn")
  call SaveStr(MHT,'A524',1000,"Bounty_Jinada_Learn")
  call SaveStr(MHT,'A0IF',1000,"Destroyer_EssenceAura_Leveling")
  call SaveStr(MHT,'A1EA',1000,"TemplarAssassin_Refraction_Learn")
  call SaveStr(MHT,'QB03',1000,"TemplarAssassin_Refraction_Learn")
  call SaveStr(MHT,'A0AK',1000,"HCF")
  call SaveStr(MHT,'A0LV',1000,"Chen_Test_Learn")
  call SaveStr(MHT,'A2AI',1000,"DragonKnight_DragonTail_Leveling")
  call SaveStr(MHT,'A0CZ',1000,"Void_Backtrack_Init")
  call SaveStr(MHT,'A2S0',1000,"SkeletonKing_MortalStrike_AddCrit")
  call SaveStr(MHT,'A0MM',1000,"Viper_CorrosiveSkin_Reg2")
  call SaveStr(MHT,'A0CL',1000,"DK_DragonBlood_Act")
  call SaveStr(MHT,'A0OO',1000,"Beastmaster_CallOfTheWild_Learned")
  call SaveStr(MHT,'A303',1000,"Bone_SearingArrows_Learn")
  call SaveStr(MHT,'A0H4',1000,"TB_ConjureImage_Leveled")
  call SaveStr(MHT,'Q0BK',1000,"IncapacitatingBite_Learn")
  call SaveStr(MHT,'A2JK',1000,"Xin_FireRemnants_Learn")
  call SaveStr(MHT,'A1C0',1000,"Medusa_SplitShot_Learn")
  call SaveStr(MHT,'A440',1000,"OldMarksmanshipBonus")
  //EVENT_UNIT_HERO_SKILL   // called everytime the spell is leveled, including lvl 1
  
  call SaveStr(MHT,'A43S',5,"ChakramLevelup")
  call SaveStr(MHT,'A440',5,"OldMarksmanshipBonus")
  call SaveStr(MHT,'QP25',5,"OldMarksmanshipBonus")
  call SaveStr(MHT,'A2E5',5,"ChakramLevelup")
  call SaveStr(MHT,'Q0BK',5,"IncapacitatingBite_Learn")
  call SaveStr(MHT,'A2JK',5,"Xin_FireRemnants_Learn")
  call SaveStr(MHT,'A1C0',5,"Medusa_SplitShot_Learn")
  call SaveStr(MHT,'A2S0',5,"SkeletonKing_MortalStrike_AddCrit")
  call SaveStr(MHT,'QP0W',5,"SkeletonKing_MortalStrike_AddCrit")
  call SaveStr(MHT,'A11N',5,"Admiral_XMark_Learn")
  
  call SaveStr(MHT,'A2AI',5,"DragonKnight_DragonTail_Leveling")
  call SaveStr(MHT,'A03E',5,"Lycan_FeralImpulse_Leveling")
  call SaveStr(MHT,'QP0Q',5,"Lycan_FeralImpulse_Leveling")
  
  call SaveStr(MHT,'QP23',5,"Visage_GravekeeperCloak_Leveling")
  call SaveStr(MHT,'A0VX',5,"Visage_GravekeeperCloak_Leveling")
  call SaveStr(MHT,'A0IF',5,"Destroyer_EssenceAura_Leveling")
  call SaveStr(MHT,'QP1A',5,"Destroyer_EssenceAura_Leveling")
  
  call SaveStr(MHT,'A086',5,"HunterInTheNight_Leveling")
  call SaveStr(MHT,'QP0T',5,"HunterInTheNight_Leveling")
  call SaveStr(MHT,'A08E',5,"Stalker_Fear_Leveling")
  
  call SaveStr(MHT,'A0A5',5,"LoneDruid_SpiritBear_Leveling")
  call SaveStr(MHT,'A0CY',5,"Tiny_Grow_Learning")
  call SaveStr(MHT,'QP1K',5,"Tiny_Grow_Learning")
  call SaveStr(MHT,'QP1J',5,"Tiny_CraggyExterior_Learning")
  call SaveStr(MHT,'A19Q',5,"Tiny_CraggyExterior_Learning")
  call SaveStr(MHT,'A0EY',5,"SF_Shadowrazes_Learn")
  
  
  
  call SaveStr(MHT,'A0KX',5,"Morphling_Morph_Learn")
  call SaveStr(MHT,'A0CG',5,"GeminateAttack_Learn")
  call SaveStr(MHT,'A0OO',5,"Beastmaster_CallOfTheWild_Learned")
  call SaveStr(MHT,'A03U',5,"Sniper_TakeAim_Learn")
  call SaveStr(MHT,'QP1Q',5,"Sniper_TakeAim_Learn")
  
  call SaveStr(MHT,'P019',5,"Maiden_Brilliance_Learn")
  call SaveStr(MHT,'QP05',5,"Maiden_Brilliance_Learn")
  call SaveStr(MHT,'A0H4',5,"TB_ConjureImage_Leveled")
  call SaveStr(MHT,'A0CL',5,"DK_DragonBlood_Act")
  call SaveStr(MHT,'QP0J',5,"DK_DragonBlood_Act")
  call SaveStr(MHT,'A0RO',5,"TemplarAssassin_PsiBlades_Leveling")
  call SaveStr(MHT,'QP1S',5,"TemplarAssassin_PsiBlades_Leveling")
  call SaveStr(MHT,'A40B',5,"Ogre_Bloodlust_Learn")
  
  call SaveStr(MHT,'A13T',5,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A0LV',5,"Chen_Test_Learn")
  call SaveStr(MHT,'A522',5,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A32Y',5,"Kodo_DigestLeveling")
  call SaveStr(MHT,'A32Z',5,"Doom_Devour_Leveling")
  call SaveStr(MHT,'A331',5,"Phoenix_Spirits_Leveling")
  call SaveStr(MHT,'A303',5,"Bone_SearingArrows_Learn")
  
  
  // Used for s5-s6 support, called everytime unit obtains next level of ability, but not 1st
  call SaveStr(MHT,'A440',1001,"OldMarksmanshipBonus")
  call SaveStr(MHT,'A0CG',1001,"GeminateAttack_Learn")
  call SaveStr(MHT,'A2E5',1001,"ChakramLevelup")
  call SaveStr(MHT,'A1C0',1001,"Medusa_SplitShot_Learn")
  call SaveStr(MHT,'A2JK',1001,"Xin_FireRemnants_Learn")
  call SaveStr(MHT,'A11N',1001,"Admiral_XMark_Learn")
  call SaveStr(MHT,'A086',1001,"HunterInTheNight_Leveling")
  call SaveStr(MHT,'A0EY',1001,"SF_Shadowrazes_Learn")
  call SaveStr(MHT,'A331',1001,"Phoenix_Spirits_Leveling")
  call SaveStr(MHT,'A40B',1001,"Ogre_Bloodlust_Learn")
  call SaveStr(MHT,'A0H4',1001,"TB_ConjureImage_Leveled")
  call SaveStr(MHT,'A32Z',1001,"Doom_Devour_Leveling")
  call SaveStr(MHT,'A0KX',1001,"Morphling_Morph_Learn")
  call SaveStr(MHT,'A32Y',1001,"Kodo_DigestLeveling")
  call SaveStr(MHT,'Q0BK',1001,"IncapacitatingBite_Learn")
  call SaveStr(MHT,'A303',1001,"Bone_SearingArrows_Learn")
  call SaveStr(MHT,'P019',1001,"Maiden_Brilliance_Learn")
  call SaveStr(MHT,'A0OO',1001,"Beastmaster_CallOfTheWild_Learned")
  call SaveStr(MHT,'QP05',1001,"Maiden_Brilliance_Learn")
  call SaveStr(MHT,'A2S0',1001,"SkeletonKing_MortalStrike_AddCrit")
  call SaveStr(MHT,'A0LV',1001,"Chen_Test_Learn")
  call SaveStr(MHT,'A0RO',1001,"TemplarAssassin_PsiBlades_Leveling")
  call SaveStr(MHT,'A13T',1001,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A522',1001,"Kunka_Tidebringer_Learn")
  call SaveStr(MHT,'A19Q',1001,"Tiny_CraggeExterior_Leveling")
  call SaveStr(MHT,'QP1J',1001,"Tiny_CraggeExterior_Leveling")
  call SaveStr(MHT,'A03U',1001,"Sniper_TakeAim_Learn")
  call SaveStr(MHT,'A0A5',1001,"LoneDruid_SpiritBear_Leveling")
  call SaveStr(MHT,'A03E',1001,"Lycan_FeralImpulse_Leveling")
  call SaveStr(MHT,'A0VX',1001,"Visage_GravekeeperCloak_Leveling")
  call SaveStr(MHT,'A2AI',1001,"DragonKnight_DragonTail_Leveling")
  call SaveStr(MHT,'A0CY',1001,"Tiny_Grow_Learning")
  call SaveStr(MHT,'A0IF',1001,"Destroyer_EssenceAura_Leveling")
  call SaveStr(MHT,'A0CL',1001,"DK_DragonBlood_Act")
  call SaveStr(MHT,'QP0J',1001,"DK_DragonBlood_Act")
  
  //EVENT_UNIT_SPELL_CHANNEL
  call SaveStr(MHT,'A01O',7,"VKE")
  call SaveStr(MHT,'A04P',7,"Sniper_Assassinate")
  call SaveStr(MHT,'A1AU',7,"Sniper_Assassinate")
  call SaveStr(MHT,'A454',7,"FireStompAct")
  //EVENT_UNIT_ATTACKED
  
  
  //EVENT_UNIT_ISSUED_ORDER
  //EVENT_UNIT_ISSUED_POINT_ORDER
  //EVENT_UNIT_ISSUED_TARGET_ORDER
  
  
  //EVENT_PLAYER_UNIT_SUMMON
  call SaveStr(MHT,'A24K',9,"Terrorblase_Reflection_Illusion")
  
  
  //EVENT_PLAYER_CHAT
  call SaveStr(MHT,StringHash("-display"),10,"Psi_Blades_Display_Toggle")
  //call SaveStr(MHT,StringHash("-stats"),10,"Display_Stats")
  //call SaveStr(MHT,StringHash("-st"),10,"Display_Stats")
  //call SaveStr(MHT,StringHash("derp"),10,"herp")//for imbaness \:D/
endfunction

function LoDEvent_Add takes nothing returns nothing
  local unit u = GetTriggerUnit()
  if LoadBoolean(MHT,GetHandleId(u),2) then
    set u=null
    return
  endif
  //call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_HERO_SKILL)
  
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CAST)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_EFFECT)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_FINISH)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_CHANNEL)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_SPELL_ENDCAST)
  
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_ORDER)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_POINT_ORDER)
  call TriggerRegisterUnitEvent(GAME_TRIGGER,u,EVENT_UNIT_ISSUED_TARGET_ORDER)
  call SaveBoolean(MHT,GetHandleId(u),2,true)//used to check if a unit has registered order events
  
  set u = null
endfunction

function LichFunctionToDisplayTimeLeft takes integer seconds,integer r,integer g,integer b,integer a,real x,real y,integer h returns nothing
  local string s=I2S(seconds)
  local integer i1
  local integer i2
  local integer i3
  if seconds>99 then
    set TIMERIMG[1]=true
    set TIMERIMG[2]=true
    set TIMERIMG[3]=true
    call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",61,61,x-50,y,0,true)
    call SaveImageHandle(HY,h,1520,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
    call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",61,61,x-20,y,0,true)
    call SaveImageHandle(HY,h,1521,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
    call WriteImageOnGround("Fonts\\"+SubString(s,2,3)+".blp",61,61,x+20,y,0,true)
    call SaveImageHandle(HY,h,1522,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
  elseif seconds >9 then
    set TIMERIMG[2]=true
    set TIMERIMG[3]=true
    call WriteImageOnGround("Fonts\\"+SubString(s,0,1)+".blp",61,61,x-33,y,0,true)
    call SaveImageHandle(HY,h,1521,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
    call WriteImageOnGround("Fonts\\"+SubString(s,1,2)+".blp",61,61,x-3,y,0,true)
    call SaveImageHandle(HY,h,1522,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
  else
    set TIMERIMG[2]=true
    set TIMERIMG[3]=true
    call PlaySoundBJ(Sound_Tick)
    call WriteImageOnGround("Fonts\\0.blp",61,61,x-33,y,0,true)
    call SaveImageHandle(HY,h,1521,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
    call WriteImageOnGround("Fonts\\"+s+".blp",61,61,x-3,y,0,true)
    call SaveImageHandle(HY,h,1522,tt_image1)
    call SetImageColor(tt_image1,r,g,b,a)
  endif
endfunction

function APShowTimer takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local integer i=R2I(TimerGetRemaining(NK))
  local image im
  local integer k=1
  loop
    set LastTimeActivity[k]=TimerGetElapsed(GlobalTimer)
    set k=k+1
    exitwhen k>11
  endloop
  if TIMERIMG[1]==true then
    set im=LoadImageHandle(HY,h,1520)
    call DestroyImage(im)
    set TIMERIMG[1]=false
  endif
  if TIMERIMG[2]==true then
    set im=LoadImageHandle(HY,h,1521)
    call DestroyImage(im)
    set TIMERIMG[2]=false
  endif
  if TIMERIMG[3]==true then
    set im=LoadImageHandle(HY,h,1522)
    call DestroyImage(im)
    set TIMERIMG[3]=false
  endif
  if i==0 or b_AllPlayersReady then
    call FlushChildHashtable(HY,h)
    call DestroyTrigger(t)
  else
    call LichFunctionToDisplayTimeLeft(i,255,2,2,255,-6970,6726,h)
  endif
  set t=null
endfunction

function ShowTimersInit takes nothing returns nothing
  set APShowTimersTrig=CreateTrigger()// timer on taverns
  set Sound_Tick=CreateSound( "Sound\\Interface\\BattleNetTick.wav", false, false, false, 10, 10, "" )
  call SetSoundParamsFromLabel( Sound_Tick, "ChatroomTimerTick" )
  call SetSoundDuration( Sound_Tick, 476 )
  call TriggerRegisterTimerEvent(APShowTimersTrig,1,true)
  call TriggerAddCondition(APShowTimersTrig,Condition(function APShowTimer))
  call TriggerEvaluate(APShowTimersTrig)
  set AddTime1=CreateUnit(Player(15),'h302',-7070,6936,270)
  set AddTime2=CreateUnit(Player(15),'h302',-7070,6616,270)
  set AddTime3=CreateUnit(Player(15),'h303',-6920,6616,270)
  set AddTime4=CreateUnit(Player(15),'h303',-6920,6936,270)
  set AltarOfRandom=CreateUnit(Player(15),'h306',-6995,7200,270)
  //	if (Mode_MD or Mode_SD) and i_BonusDraftAmount==0 then
  //		call SetUnitPosition(AltarOfRandom,-5751, 7050)
  //		call SetUnitPosition(AddTime1,-5700, 6850)
  //		call SetUnitPosition(AddTime2,-5800, 6850)
  //		call SetUnitPosition(AddTime3,-5700, 6450)
  //		call SetUnitPosition(AddTime4,-5800, 6450)
  //	endif
endfunction

function MeleeRangeItemsFix takes nothing returns boolean
  local integer i=1
  local integer k=0
  local item it=null
  local boolean f=false
  local integer h=GetHandleId(GetTriggeringTrigger())
  local real time=TimerGetElapsed(GlobalTimer)
  loop
    if IsDead(udg_Hero[i])==false and TimerGetRemaining(HeroRespawnTimer[i])<=0 and time-LoadReal(HY,h,GetHandleId(udg_Hero[i])) > 2 then
      call SaveReal(HY,h,GetHandleId(udg_Hero[i]),time)
      set k=0
      loop
        exitwhen k>5
        set it=UnitItemInSlot(udg_Hero[i],k)
        if it!=null then
          if GetIndex(it)==-1 then
            call UnitRemoveItem(udg_Hero[i],it)
          else
            call RestrictedItems_UpdateMeleeRange(udg_Hero[i],it)
          endif
        endif
        set k=k+1
      endloop
    endif
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>12
  endloop
  set it=null
  return false
endfunction

function Kaolin_addsubskill takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer PlayerId=GetPlayerId(GetOwningPlayer(u))
  local integer xx=1
  local boolean b=false
  loop
    if PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]>=441 and PlayerSkillNumber[PlayerId*PlayerSkillOffset+xx]<=444 then
      set b=true
    endif
    set xx=xx+1
    exitwhen b or xx>4+NumberOfExtraAbilities
  endloop
  if not LoadBoolean(HY,GetHandleId(u),StringHash("rolling stones")) and b then
    call UnitAddAbility2(u,'A2TH')
    call Kaolin_RollingBoulder_Init(u)
    call SaveBoolean(HY,GetHandleId(u),StringHash("rolling stones"),true)
  endif
  set u=null
  call FlushChildHashtable(HY,h)
  call DestroyTimer(t)
  set t=null
endfunction

function Kaolin_Prereg takes nothing returns nothing
  local timer t
  local integer h
  if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,0,false,function Kaolin_addsubskill)
    call SaveUnitHandle(HY,h,0,GetTriggerUnit())
  endif
  set t=null
endfunction

function Weaver_TimeLapse_LearnFixed takes unit u returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEventPeriodic(t,.5)
  call TriggerAddAction(t,function RDG)
  call SaveUnitHandle(HY,GetHandleId(t),221,u)
  set t=null
endfunction

function TimeLapse_Init takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  call Weaver_TimeLapse_LearnFixed(u)
  set u=null
  call FlushChildHashtable(HY,h)
  call CleanTrigger(t)
  set t=null
endfunction

function TimeLapse_PreInit takes nothing returns nothing
  local trigger t
  local integer h
  local unit u
  local unit d
  if b_isPickTime==false and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==true and IsUnitIllusion(GetTriggerUnit())==false then
    set t=CreateTrigger()
    set h=GetHandleId(t)
    set u=GetTriggerUnit()
    call TriggerRegisterTimerEvent(t,0,false)
    call TriggerAddCondition(t,Condition(function TimeLapse_Init))
    call SaveUnitHandle(HY,h,0,u)
    set t=CreateTrigger()
    set h=GetHandleId(t)
    call TriggerRegisterTimerEvent(t,.5,true)
    call TriggerAddCondition(t,Condition(function FQG))
    call SaveUnitHandle(HY,h,304,u)
    set d=CreateUnit(GetOwningPlayer(u),'o01A',GetUnitX(u),GetUnitY(u),0)
    call SaveUnitHandle(HY,h,305,d)
    call SaveUnitHandle(HeroStats,GetHandleId(u),'DUMM',d)
    set d=null
    set u=null
    set t=null
  endif
endfunction

function Bughunter_Dummies takes nothing returns nothing
  local unit hero
  local unit dummy
  local integer i=1
  local integer lvl=0
  local boolean b=Mode_S5 or Mode_S6
  if b_isPickTime then
    return
  endif
  loop
    set hero=udg_Hero[i]
    set dummy=BugHunterProviders[i]
    set lvl=GetUnitAbilityLevel(hero,'A086')+GetUnitAbilityLevel(hero,'QP0T')
    if lvl==0 and b then
      if SkillID[PlayerSkillNumber[i*PlayerSkillOffset+5]]=='P247' then
        set lvl=ExtraAbilityLevel[i*2+1]
      endif
    endif
    if lvl>0 then
      if IsDayTime() then
        if GetUnitAbilityLevel(dummy,'A330')!=0 then
          call UnitRemoveAbility(dummy,'A330')
        endif
        if IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false then
          if GetUnitAbilityLevel(hero,'P247')>0 and GetUnitAbilityLevel(hero,'P247')!=5  then
            call SetUnitAbilityLevel(hero,'P247',5)
          endif
          if GetUnitAbilityLevel(hero,'A116')>0 then
            call UnitRemoveAbility(hero,'A116')
            call UnitRemoveAbility(hero,'A117')
          endif
        endif
      else
        if GetUnitAbilityLevel(dummy,'A330')!=lvl then
          call UnitAddAbility2(dummy,'A330')
          call SetUnitAbilityLevel(dummy,'A330',lvl)
        endif
        if IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false then
          if GetUnitAbilityLevel(hero,'P247')!=lvl then
            call SetUnitAbilityLevel(hero,'P247',lvl)
          endif
          if GetUnitAbilityLevel(hero,'A116')==0 then
            call UnitAddAbility2(hero,'A116')
            call UnitAddAbility2(hero,'A117')
          endif
        endif
      endif
    elseif GetUnitAbilityLevel(dummy,'A330')>0 then
      call UnitRemoveAbility(dummy,'A330')
    endif
    if IsDead(hero)==false and IsHeroDead[GetPlayerId(GetOwningPlayer(hero))]==false and (GetUnitAbilityLevel(hero,'A08E')>0 or SkillID[PlayerSkillNumber[GetPlayerId(GetOwningPlayer(hero))*PlayerSkillOffset+5]]=='A08C') then
      if IsDayTime()==false then
        if GetUnitAbilityLevel(hero,'A08E')>0 then
          call SetUnitAbilityLevel(hero,'A08C',GetUnitAbilityLevel(hero,'A08E'))
        else
          call SetUnitAbilityLevel(hero,'A08C',ExtraAbilityLevel[GetPlayerId(GetOwningPlayer(hero))*2+1])
        endif
      else
        call SetUnitAbilityLevel(hero,'A08C',5)
      endif
    endif
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>11
  endloop
  set hero=null
  set dummy=null
endfunction

function NIghtstalker_Passive_Global takes nothing returns nothing
  local timer t=CreateTimer()
  local integer i=1
  loop
    set BugHunterProviders[i]=CreateUnit(Player(i),'e00C',0,0,0)
    call UnitAddAbility2(BugHunterProviders[i],'Aloc')
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>11
  endloop
  call TimerStart(t,1,true,function Bughunter_Dummies)
  set t=null
endfunction

function OnPurge takes nothing returns nothing
  local unit u=GetSpellTargetUnit()
  call UnitRemoveAbility(u,'B02U')//viscous nasal goo
  call UnitRemoveAbility(u,'BHtc')//thunderclap
  call UnitRemoveAbility(u,'A1JA')
  call UnitRemoveAbility(u,'B0CD')
  call UnitRemoveAbility(u,'A1LD')
  call UnitRemoveAbility(u,'Aetl')
  call SetNapalmFactory(u,0,0)
  if IsUnitEnemy(u,GetOwningPlayer(GetTriggerUnit())) then
    call UnitRemoveAbility(u,'A0WO')//gods strength
    call UnitRemoveAbility(u,'B009')
    call UnitRemoveAbility(u,'A1HN')//Chlling touch
    call UnitRemoveAbility(u,'B0CJ')
    call UnitRemoveAbility(u,'A0QO')//inner vitality
    call UnitRemoveAbility(u,'B080')
    call UnitRemoveAbility(u,'A0VJ')//alacrity
    call UnitRemoveAbility(u,'A109')
    call UnitRemoveAbility(u,'A0P0')//shadow word ally
    call UnitRemoveAbility(u,'B073')
    call UnitRemoveAbility(u,'C025')//warcry
    call UnitRemoveAbility(u,'D025')
    call UnitRemoveAbility(u,'A2J9')//Press the attack
    call UnitRemoveAbility(u,'A2JA')
    call UnitRemoveAbility(u,'A2J8')
    call UnitRemoveAbility(u,'A2J7')
    call UnitRemoveAbility(u,'B0FQ')//Flame Guard
  else
    call UnitRemoveAbility(u,'A42Q')//Thunder strike
    call UnitRemoveAbility(u,'B0HH')
    call UnitRemoveAbility(u,'A42R')//Meteor
    call UnitRemoveAbility(u,'B0HI')
    call UnitRemoveAbility(u,'A17K')//shadow word enemy
    call UnitRemoveAbility(u,'B0AP')
    call UnitRemoveAbility(u,'B307')//Liquid fire
    call UnitRemoveAbility(u,'B03J')//Ignite
    call UnitRemoveAbility(u,'B001')//Viper Strike
    call UnitRemoveAbility(u,'BEsh')//Shadow strike
    call UnitRemoveAbility(u,'BEsi')//Shadow Strike 2
    call UnitRemoveAbility(u,'B0AQ')//Venomous Gale
    call UnitRemoveAbility(u,'B0FY')//Concussive Shot
    call UnitRemoveAbility(u,'A10Z')//mana leaks!!!
    call UnitRemoveAbility(u,'A111')
    call UnitRemoveAbility(u,'A10Y')
    call UnitRemoveAbility(u,'A110')
    call UnitRemoveAbility(u,'B09M')
    call UnitRemoveAbility(u,'B09N')
    call UnitRemoveAbility(u,'B09O')
    call UnitRemoveAbility(u,'B09L')
    call UnitRemoveAbility(u,'A1PS')//curse of the silence
    call UnitRemoveAbility(u,'B0CQ')
    call UnitRemoveAbility(u,'A0OW')//poison touch
    call UnitRemoveAbility(u,'B07I')
    call UnitRemoveAbility(u,'A42S')//whirling death
    call UnitRemoveAbility(u,'B0HJ')
    call UnitRemoveAbility(u,'Bpoi')//poison attack
    call UnitRemoveAbility(u,'Bfro')//frost attack
    call UnitRemoveAbility(u,'A204')//walrus punch slow
    call UnitRemoveAbility(u,'B0DY')
  endif
  set u=null
endfunction

function RadianceBearers takes nothing returns boolean
  return IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04I')>0 and IsHexed(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'BNdo')==0 and GetUnitAbilityLevel(GetFilterUnit(),'B0FG')==0
endfunction

function RadianceEnemies takes nothing returns boolean
  return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(TEMPUNIT)) and IsUnitInGroup(GetFilterUnit(),RadianceDamaged)==false and IsDead(GetFilterUnit())==false and GetUnitAbilityLevel(GetFilterUnit(),'A04R')==0 and GetUnitAbilityLevel(GetFilterUnit(),'Aloc')==0 and IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE)==false and IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL)==false 
endfunction

function RadianceDamage takes nothing returns nothing
  call DamageTarget(tt_unit1,GetEnumUnit(),1,50)
endfunction

function RadianceForGroup takes nothing returns nothing
  local unit u=GetEnumUnit()
  local group g=GetAvailableGroup()
  set TEMPUNIT=u
  call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),725,Condition(function RadianceEnemies))
  call GroupAddGroup(g,RadianceDamaged)
  set TEMPUNIT=u
  set tt_unit1=CreateUnit(GetOwningPlayer(u),'e00E',GetUnitX(u),GetUnitY(u),0)
  call ForGroup(g,function RadianceDamage)
  call KillGroup(g)
  set g=null
  set u=null
endfunction

function RadianceTick takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Condition(function RadianceBearers))
  call GroupClear(RadianceDamaged)
  call ForGroup(g,function RadianceForGroup)
  call KillGroup(g)
  set g=null
endfunction

function RadiancePick takes nothing returns nothing
  local timer t
  if HaveSavedBoolean(UTable,'RADI',0)==false then
    call SaveBoolean(UTable,'RADI',0,false)
    set t=CreateTimer()
    call TimerStart(t,1,true,function RadianceTick)
    set t=null
  endif
endfunction

function DoubleClickDisassemble takes unit u, item it, integer slot returns nothing
  local integer emptyslots=1
  local integer reqslots=0
  local integer i=0
  local item newitem
  local integer index=GetIndex(it)
  local player p
  if index!=indexid_Perseverance and index!=indexid_RingOfBasilius and index!=indexid_RingOfBasiliusHero and index!=indexid_ShivasGuard and index!=indexid_ShivasGuardCourier and index!=indexid_Mjollnir and index!=indexid_ArcaneBoots and index!=indexid_HelmOfTheDominator and index!=indexid_HelmOfTheDominatorCourier and index!=indexid_MantaStyle and index!=indexid_MantaStyleRanged and index!=indexid_EtherealBlade and index!=indexid_SangeAndYasha and index!=indexid_RingOfAquila and index!=indexid_RingOfAquilaHero and index!=indexid_AbyssalBlade then
    return
  endif
  loop
    if UnitItemInSlot(u,i)==null then
      set emptyslots=emptyslots+1
    endif
    set i=i+1
    exitwhen i>5
  endloop
  if index==indexid_Perseverance or index==indexid_RingOfBasilius  or index==indexid_RingOfBasiliusHero  or index==indexid_ArcaneBoots  or index==indexid_HelmOfTheDominator  or index==indexid_HelmOfTheDominatorCourier  or index==indexid_EtherealBlade  or index==indexid_SangeAndYasha  or index==indexid_RingOfAquila  or index==indexid_RingOfAquilaHero or index==indexid_AbyssalBlade then
    set reqslots=2
  elseif index==indexid_ShivasGuard or index==indexid_ShivasGuardCourier or index==indexid_Mjollnir or index==indexid_MantaStyle or index==indexid_MantaStyleRanged then
    set reqslots=3
  endif
  if emptyslots>=reqslots then
    call DisableTrigger(t_manipulateitem)
    set p=GetItemPlayer(it)
    call RemoveItem(it)
    if index==indexid_Perseverance then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RingOfHealth],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_VoidStone],p,false,1)
    elseif index==indexid_RingOfBasilius or index==indexid_RingOfBasiliusHero then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RingOfProtection],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_SobiMask],p,false,1)
    elseif index==indexid_ShivasGuard or index==indexid_ShivasGuardCourier then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_PlateMail],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_MysticStaff],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RecipeShivasGuard],p,false,1)
    elseif index==indexid_Mjollnir then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Hyperstone],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Maelstrom],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RecipeMjollnir],p,false,1)
    elseif index==indexid_ArcaneBoots then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_BootsOfSpeed],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_EnergyBooster],p,false,1)
    elseif index==indexid_HelmOfTheDominator or index==indexid_HelmOfTheDominatorCourier then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_HelmOfIronWill],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_MaskOfDeath],p,false,1)
    elseif index==indexid_MantaStyle or index==indexid_MantaStyleRanged then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Yasha],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_UltimateOrb],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RecipeMantaStyle],p,false,1)
    elseif index==indexid_EtherealBlade then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Eaglehorn],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_GhostScepter],p,false,1)
    elseif index==indexid_SangeAndYasha then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Sange],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_Yasha],p,false,1)
    elseif index==indexid_RingOfAquila or index==indexid_RingOfAquilaHero then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_WraithBand],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_RingOfBasilius],p,false,1)
    elseif index==indexid_AbyssalBlade then
      call UnitAddItemByIdLoD(u,Item_Real[indexid_CraniumBasher],p,false,1)
      call UnitAddItemByIdLoD(u,Item_Real[indexid_SacredRelic],p,false,1)
    endif
    call EnableTrigger(t_manipulateitem)
  else
    call Error(GetOwningPlayer(u),"Not enough space in the inventory. Disassembling requires "+I2S(reqslots)+" slots at least.")
  endif
  set newitem=null
endfunction

function DoubleRightClick takes nothing returns nothing
  local integer id=GetIssuedOrderId()
  if id>=852002 and id<=852007 then
    if GetOrderTargetItem()==UnitItemInSlot(GetTriggerUnit(),id-852002) then
      call DoubleClickDisassemble(GetTriggerUnit(),GetOrderTargetItem(),id-852002)
    endif
  endif
endfunction

function DoubleRightClickInit takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerAddCondition(t,Condition(function DoubleRightClick))
  set t=null
endfunction

function PushOutToMap takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  if GetUnitTypeId(u)!='hfoo' and GetUnitAbilityLevel(u,'Aloc')==0 then
    if SafeX50(x)!=x then
      call SetUnitX(u,SafeX50(x))
    endif
    if SafeY50(y)!=y then
      call SetUnitY(u,SafeY50(y))
    endif
  endif
  set u=null
endfunction

function PushOutToMap2 takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local real x=GetUnitX(u)
  local real y=GetUnitY(u)
  if GetUnitAbilityLevel(u,'Aloc')==0 and GetOwningPlayer(u)!=Player(15) then
    call SetUnitPosition(u,x,y)
  endif
  set u=null
endfunction

function PushOut2 takes nothing returns nothing
  local trigger t=CreateTrigger()
  set ExtraBoundaries=CreateRegion()
  set ExtraBoundariesAdv=CreateRegion()
  call RegionAddRect(ExtraBoundaries,Rect(-6424,-7473,-7500,-7885))
  call RegionAddRect(ExtraBoundariesAdv,Rect(5744,6860,7502,7240))
  call RegionAddRect(ExtraBoundariesAdv,Rect(7300,5400,7502,6800))
  call TriggerRegisterEnterRegion(t,ExtraBoundaries,Condition(function ReturnTrue))
  call TriggerRegisterEnterRegion(t,ExtraBoundariesAdv,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function PushOutToMap2))
  set t=null
endfunction

function RoshanPitOccluderHeightFix takes nothing returns nothing
  call SetDestructableOccluderHeight(GetEnumDestructable(),9999)
endfunction

function RoshanPitBlockersFilter takes nothing returns boolean
  return IsValidTree(GetFilterDestructable())==false
endfunction

function RecreateHeroIfMissed takes integer i, integer h returns nothing
  local player p=Player(i)
  local integer k=i*100
  local unit u=CreateUnit(p,LoadInteger(HY,h,k+80),LoadReal(HY,h,k),LoadReal(HY,h,k+1),90)
  local item it=null
  
  set it=CreateItem(LoadInteger(HY,h,k+1),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+1),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+11)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+11))
  endif
  set it=CreateItem(LoadInteger(HY,h,k+2),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+2),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+12)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+12))
  endif
  set it=CreateItem(LoadInteger(HY,h,k+3),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+3),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+13)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+13))
  endif
  set it=CreateItem(LoadInteger(HY,h,k+4),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+4),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+14)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+14))
  endif
  set it=CreateItem(LoadInteger(HY,h,k+5),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+5),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+15)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+15))
  endif
  set it=CreateItem(LoadInteger(HY,h,k+6),0,0)
  call SetItemPlayer(it,LoadPlayerHandle(HY,h,k+6),true)
  call UnitAddItem(u,it)
  if LoadInteger(HY,h,k+16)>0 then
    call SetItemCharges(it,LoadInteger(HY,h,k+16))
  endif
  set ExtraAbilityLevel[GetPlayerId(p)*2+1]=0
  set ExtraAbilityLevel[GetPlayerId(p)*2+2]=0
  call AddHeroXP(u,LoadInteger(HY,h,k+30),false)
  call DisplayTimedTextToPlayer(p,0,0,20,"|c00ff0000  Your hero was recreated due to a fatal error. Please report this replay at |c00ffff00LegendsOfDota.com|r |c00ff0000if you notice any problems.|r")
  set u=null
  set it=null
endfunction

function SaveHeroesTick takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u
  local item it
  local integer i=1
  local integer k
  local boolean missing=false
  loop
    if PlayerHaveHero[i] and IsPlayerLeaver(Player(i))==false then
      set missing=false
      set u=udg_Hero[i]
      if u==null or GetUnitTypeId(u)<1 or GetHandleId(u)<1 then
        set missing=true
      endif
      set k=i*100
      if missing==false then
        call SaveBoolean(HY,h,k,true)
        call SaveInteger(HY,h,k+80,GetUnitTypeId(u))
        set it=UnitItemInSlot(u,0)
        call SaveInteger(HY,h,k+1,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+1,GetItemPlayer(it))
        call SaveInteger(HY,h,k+11,GetItemCharges(it))
        set it=UnitItemInSlot(u,1)
        call SaveInteger(HY,h,k+2,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+2,GetItemPlayer(it))
        call SaveInteger(HY,h,k+12,GetItemCharges(it))
        set it=UnitItemInSlot(u,2)
        call SaveInteger(HY,h,k+3,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+3,GetItemPlayer(it))
        call SaveInteger(HY,h,k+13,GetItemCharges(it))
        set it=UnitItemInSlot(u,3)
        call SaveInteger(HY,h,k+4,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+4,GetItemPlayer(it))
        call SaveInteger(HY,h,k+14,GetItemCharges(it))
        set it=UnitItemInSlot(u,4)
        call SaveInteger(HY,h,k+5,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+5,GetItemPlayer(it))
        call SaveInteger(HY,h,k+15,GetItemCharges(it))
        set it=UnitItemInSlot(u,5)
        call SaveInteger(HY,h,k+6,GetItemTypeId(it))
        call SavePlayerHandle(HY,h,k+6,GetItemPlayer(it))
        call SaveInteger(HY,h,k+16,GetItemCharges(it))
        call SaveReal(HY,h,k,GetUnitX(u))
        call SaveReal(HY,h,k+1,GetUnitY(u))
        call SaveInteger(HY,h,k+30,GetHeroXP(u))
      endif
      if missing and LoadBoolean(HY,h,k) then
        call RecreateHeroIfMissed(i,h)
      endif
    endif
    
    set i=i+1
    if i==6 then
      set i=7
    endif
    exitwhen i>11
    
  endloop
  
  set u=null
  set it=null
  set t=null
endfunction

function DoubleHold_Blink takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  if GetUnitX(u)!=LoadReal(HY,h,0) or GetUnitY(u)!=LoadReal(HY,h,1) or IsDead(u) then
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(HY,h)
    call UnitRemoveAbility(u,'A40E')
  else
    call UnitRemoveAbility(u,'A40E')
    call UnitAddAbility2(u,'A40E')
  endif
  set u=null
  set t=null
endfunction

function DoubleHold_AntiInvis takes unit u returns nothing
  local timer t=CreateTimer()
  call TimerStart(t,0.2,true,function DoubleHold_Blink)
  call SaveUnitHandle(HY,GetHandleId(t),0,u)
  call UnitAddAbility2(u,'A40E')
  call SaveReal(HY,GetHandleId(t),0,GetUnitX(u))
  call SaveReal(HY,GetHandleId(t),1,GetUnitY(u))
  set t=null
endfunction

function DoubleHold takes nothing returns nothing
  local unit u
  local integer h
  if IsPlayerBelongToTeams(GetTriggerPlayer())==false or IsUnitIllusion(GetTriggerUnit()) then
    return
  endif
  set u=GetTriggerUnit()
  set h=GetHandleId(u)
  if GetIssuedOrderId()==851993 then//hold
    if LoadBoolean(HY,h,'ACQR')==false then
      if LoadInteger(HY,h,'ACQR')!=1 then
        call AddTimedKeyToUnit(u,'ACQR',0.2)
      else
        call AddTimedKeyToUnit(u,'ACQR',0)
        call DoubleHold_AntiInvis(u)
        if IsScourge(GetOwningPlayer(u)) then
          call SetPlayerAlliance(GetOwningPlayer(u), Scourges[0], ALLIANCE_HELP_RESPONSE, false)
        else
          call SetPlayerAlliance(GetOwningPlayer(u), Sentinels[0], ALLIANCE_HELP_RESPONSE, false)
        endif
      endif
    endif
  else
    if GetUnitAbilityLevel(u,'A40E')>0 then
      if IsScourge(GetOwningPlayer(u)) then
        call SetPlayerAlliance(GetOwningPlayer(u), Scourges[0], ALLIANCE_HELP_RESPONSE, true)
      else
        call SetPlayerAlliance(GetOwningPlayer(u), Sentinels[0], ALLIANCE_HELP_RESPONSE, true)
      endif
    endif
  endif
  set u=null
endfunction

function CID takes integer d_id, integer r_id, integer s_id, integer m_id, string IconPath returns integer
  set ITC=ITC+1
  set Item_Dummy[ITC]=d_id
  set Item_Real[ITC]=r_id
  set Item_SellerUnit[ITC]=s_id
  call SaveBoolean(UnitStats,Item_SellerUnit[ITC],0,true)
  set Item_Mute[ITC]=m_id
  set Item_Icon[ITC]=IconPath
  return ITC
endfunction

function InitItems takes nothing returns nothing
  local string s=""
  call CID('I0FF','I0FG',0,0,"ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn.blp")
  set indexid_BootsOfSpeed=CID('I02Q','I02O','h011','I00A',"ReplaceableTextures\\CommandButtons\\BTNBootsOfSpeed.blp")
  set indexid_GlovesOfHaste=CID('I02S','I02P','h012','I0CA',"ReplaceableTextures\\CommandButtons\\BTNGlove.blp")
  set indexid_BootsOfElvenskin=CID('I02N','I02R','h013','I0CS',"ReplaceableTextures\\CommandButtons\\BTNBoots.blp")
  set indexid_CircletOfNobility=CID('I02X','I02Y','h015','I0D4',"ReplaceableTextures\\CommandButtons\\BTNCirclet.blp")
  set indexid_BeltOfStrength=CID('I02Z','I043','h016','I0CV',"ReplaceableTextures\\CommandButtons\\BTNBelt.blp")
  set indexid_BladesOfAlacrity=CID('I030','I044','h017','I0D2',"ReplaceableTextures\\CommandButtons\\BTNINV_ThrowingKnife_03.blp")
  set indexid_BladesOfAttack=CID('I031','I045','h018','I0D5',"ReplaceableTextures\\CommandButtons\\BTNClawsOfAttack.blp")
  set indexid_Broadsword=CID('I032','I046','h019','I0CZ',"ReplaceableTextures\\CommandButtons\\BTNSteelMelee.blp")
  set indexid_Chainmail=CID('I033','I047','h01A','I0D7',"ReplaceableTextures\\CommandButtons\\BTNINV_Chest_Chain_12.blp")
  set indexid_Claymore=CID('I034','I048','h01B','I0CX',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_19.blp")
  set indexid_DemonEdge=CID('I035','I049','h01C','I0CI',"ReplaceableTextures\\CommandButtons\\BTNFrostMourne.blp")
  set indexid_Eaglehorn=CID('I036','I04A','h01D','I0CH',"ReplaceableTextures\\CommandButtons\\BTNINV_Weapon_Bow_06.blp")
  set indexid_EnergyBooster=CID('I037','I04B','h01E','I0CR',"ReplaceableTextures\\CommandButtons\\BTNEnchantedGemstone.blp")
  set indexid_GauntletOfStrength=CID('I038','I04C','h01F','I0CJ',"ReplaceableTextures\\CommandButtons\\BTNGauntletsOfOgrePower.blp")
  set indexid_Gem=CID('I039','I04D','h01G','I0DG',"ReplaceableTextures\\CommandButtons\\BTNGem.blp")
  set indexid_GemCourier=CID('I0MS','I0MR',0,'I0MT',"ReplaceableTextures\\CommandButtons\\BTNGem.blp")
  set indexid_HelmOfIronWill=CID('I03B','I04E','h01H','I0DA',"ReplaceableTextures\\CommandButtons\\BTNHelmutPurple.blp")
  set indexid_Hyperstone=CID('I03C','I04F','h01I','I0CQ',"ReplaceableTextures\\CommandButtons\\BTNPeriapt1.blp")
  set indexid_IronwoodBranch=CID('I03D','I04G','h01J','I0CU',"ReplaceableTextures\\CommandButtons\\BTNNatureTouchGrow.blp")
  set indexid_KelensDagger=CID('I03E','I04H','h01K','I0C7',"ReplaceableTextures\\CommandButtons\\BTNDaggerOfEscape.blp")
  set indexid_DisabledKelensDagger=CID('I03E','I04I','h01K','I0DH',"ReplaceableTextures\\CommandButtons\\BTNDaggerOfEscape.blp")
  set indexid_MantleOfIntelligence=CID('I03F','I04J','h01L','I0CM',"ReplaceableTextures\\CommandButtons\\BTNMantleOfIntelligence.blp")
  set indexid_MaskOfDeath=CID('I03G','I04K','h01M','I0CD',"ReplaceableTextures\\CommandButtons\\BTNUndeadShrine.blp")
  set indexid_MesserschmidtReaver=CID('I03H','I04L','h01N','I0CG',"ReplaceableTextures\\CommandButtons\\BTNSpiritWalkerMasterTraining.blp")
  set indexid_MithrilHammer=CID('I03I','I04M','h01O','I0D0',"ReplaceableTextures\\CommandButtons\\BTNHammer.blp")
  set indexid_MysticStaff=CID('I03J','I04N','h01P','I0CN',"ReplaceableTextures\\CommandButtons\\BTNStaffOfNegation.blp")
  set indexid_OgreAxe=CID('I03K','I04O','h01Q','I0D8',"ReplaceableTextures\\CommandButtons\\BTNSpiritWalkerAdeptTraining.tga")
  set indexid_PlaneswalkerCloak=CID('I03L','I04P','h01R','I0CE',"ReplaceableTextures\\CommandButtons\\BTNINV_Misc_Cape_08.blp")
  set indexid_PlateMail=CID('I03M','I04Q','h01S','I0DB',"ReplaceableTextures\\CommandButtons\\BTNINV_Chest_Plate13.blp")
  set indexid_PointBooster=CID('I03N','I04R','h01T','I0CL',"ReplaceableTextures\\CommandButtons\\BTNUsedSoulGem.blp")
  set indexid_Quarterstaff=CID('I03P','I04S','h01U','I0CY',"ReplaceableTextures\\CommandButtons\\BTNAlleriaFlute.blp")
  set indexid_RingOfHealth=CID('I03Q','I04T','h01V','I0DI',"ReplaceableTextures\\CommandButtons\\BTNGoldRing.blp")
  set indexid_RingOfProtection=CID('I03R','I04U','h01W','I0CW',"ReplaceableTextures\\CommandButtons\\BTNRingPurple.blp")
  set indexid_RingOfRegeneration=CID('I03S','I04V','h01X','I0DJ',"ReplaceableTextures\\CommandButtons\\BTNRingSkull.blp")
  set indexid_RobeOfMagi=CID('I03T','I04W','h01Y','I0CP',"ReplaceableTextures\\CommandButtons\\BTNRobeOfTheMagi.blp")
  set indexid_SacredRelic=CID('I03U','I04X','h01Z','I0CC',"ReplaceableTextures\\CommandButtons\\BTNStaffOfTeleportation.blp")
  set indexid_SlippersOfAgility=CID('I03V','I04Y','h020','I0C5',"ReplaceableTextures\\CommandButtons\\BTNSlippersOfAgility.blp")
  set indexid_SobiMask=CID('I03W','I04Z','h021','I0DK',"ReplaceableTextures\\CommandButtons\\BTNSobiMask.blp")
  set indexid_StaffOfWizardry=CID('I03X','I050','h022','I0D1',"ReplaceableTextures\\CommandButtons\\BTNWandOfCyclone.blp")
  set indexid_StoutShield=CID('I03A','I051','h023','I0D9',"ReplaceableTextures\\CommandButtons\\BTNSteelArmor.blp")
  set indexid_StoutShieldRanged=CID('I0KB','I0KA',0,'I0KC',"ReplaceableTextures\\CommandButtons\\BTNSteelArmor.blp")
  set indexid_UltimateOrb=CID('I03Y','I052','h024','I0C9',"ReplaceableTextures\\CommandButtons\\BTNOrbofSlowness.blp")
  set indexid_VitalityBooster=CID('I03Z','I053','h025','I0CK',"ReplaceableTextures\\CommandButtons\\BTNSoulGem.blp")
  set indexid_VoidStone=CID('I040','I054','h026','I0DL',"ReplaceableTextures\\CommandButtons\\BTNPeriapt.blp")
  set indexid_javelin=CID('I041','I055','h027','I0D6',"ReplaceableTextures\\CommandButtons\\BTNSteelRanged.blp")
  set indexid_Bottle0Shop=CID('I00L','I0AV','h02B',0,"ReplaceableTextures\\CommandButtons\\BTNBottle0.blp")
  set indexid_Bottle0=CID('I05E','I0AM',0,'I0DN',"ReplaceableTextures\\CommandButtons\\BTNBottle0.blp")
  set indexid_Bottle1=CID('I0AU','I0AN',0,'I0DO',"ReplaceableTextures\\CommandButtons\\BTNBottle1.blp")
  set indexid_Bottle2=CID('I0AS','I0AO',0,'I0DP',"ReplaceableTextures\\CommandButtons\\BTNBottle2.blp")
  set indexid_Bottle3=CID('I0AT','I0AP',0,'I0DQ',"ReplaceableTextures\\CommandButtons\\BTNBottle3.blp")
  set indexid_BottleIllusion=CID('I0GW','I0GY',0,'I0H3',"ReplaceableTextures\\CommandButtons\\BTNBottle_Illusion.blp")
  set indexid_BottleRegen=CID('I0H2','I0GX',0,'I0DR',"ReplaceableTextures\\CommandButtons\\BTNBottle_Regeneration.blp")
  set indexid_BottleHaste=CID('I0GV','I0H1',0,'I0H4',"ReplaceableTextures\\CommandButtons\\BTNBottle_Haste.blp")
  set indexid_BottleBounty=CID('I0Q8','I0Q7',0,'I0Q9',"ReplaceableTextures\\CommandButtons\\BTNBottle_Haste.blp")
  set indexid_BottleDD=CID('I0AR','I0H0',0,'I0H6',"ReplaceableTextures\\CommandButtons\\BTNBottle_DoubleDamage.blp")
  set indexid_BottleInvis=CID('I0AQ','I0GZ',0,'I0H5',"ReplaceableTextures\\CommandButtons\\BTNBottle_Invisibility.blp")
  set indexid_MagicStick=CID('I0GD','I0GC','h074','I0GE',"ReplaceableTextures\\CommandButtons\\BTNWand.blp")
  set indexid_MagicWand=CID('I0HC','I0HB',0,'I0HA',"ReplaceableTextures\\CommandButtons\\BTNStarWand.blp")
  set indexid_QuellingBlade=CID('I0HT','I0HR','h07W','I0HV',"ReplaceableTextures\\CommandButtons\\BTNOrcMeleeUpTwo.blp")
  set indexid_QuellingBladeRanged=CID('I0HU','I0HP',0,'I0HW',"ReplaceableTextures\\CommandButtons\\BTNOrcMeleeUpTwo.blp")
  set indexid_corruptor=CID('I0N4','I0N3',0,'I0N5',"ReplaceableTextures\\CommandButtons\\BTNPoisonBlade.blp")
  set indexid_corruptorranged=CID('I0N7','I0N6',0,'I0N8',"ReplaceableTextures\\CommandButtons\\BTNPoisonBlade.blp")
  set indexid_TalismanOfEvasion=CID('I0J7','I0J6','h083','I0J8',"ReplaceableTextures\\CommandButtons\\BTNAmulet.blp")
  set indexid_GhostScepter=CID('I0JJ','I0JI','h087','I0JK',"ReplaceableTextures\\CommandButtons\\BTNGreenStaff.blp")
  set indexid_OrbOfVenom=CID('I0MA','I0M9','h0CM','I0MB',"ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp")
  set indexid_OrbOfVenomRanged=CID('I0MD','I0ME',0,'I0MC',"ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp")
  set indexid_Tango=CID('I057','I05C','h02A','ITGB',"ReplaceableTextures\\CommandButtons\\BTNAncientOfTheEarth.blp")
  set indexid_CrimsonGuard=CID('I0QI','I0QH',0,'I0QJ',"ReplaceableTextures\\CommandButtons\\BTNCrimsonGuard.blp")
  set indexid_RecipeCrimsonGuard=CID('I0QL','I0QK','ho02','I0QM',"ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp")
  set indexid_TangoSec=CID('INTD','INTG',0,0,"ReplaceableTextures\\CommandButtons\\BTNAncientOfTheEarth.blp")
  set indexid_ClarityPotion=CID('I042','I05D','h028','INCP',"ReplaceableTextures\\CommandButtons\\BTNLesserClarityPotion.blp")
  set indexid_ghostpotion=CID('I0HO','I0HN','h07V',0,"ReplaceableTextures\\CommandButtons\\BTNVialFull.blp")
  set indexid_HealingSalve=CID('I056','I05F','h029','INHS',"ReplaceableTextures\\CommandButtons\\BTNHealingSalve.blp")
  set indexid_ObserverWards=CID('I058','I05G','h02C',0,"ReplaceableTextures\\CommandButtons\\BTNSentryWard.blp")
  set indexid_SentryWards=CID('I059','I05H','h02D',0,"ReplaceableTextures\\CommandButtons\\BTNBlueSentryWard.blp")
  set indexid_ScrollOfTownPortal=CID('I05A','I05I','h02E',0,"ReplaceableTextures\\CommandButtons\\BTNScrollUber.blp")
  set indexid_AnimalCourier=CID('I05B','I05J','h02F',0,"ReplaceableTextures\\CommandButtons\\BTNCritterChicken.blp")
  set indexid_Cheese=CID('I0B0','I0B1',0,0,"ReplaceableTextures\\CommandButtons\\BTNCheese.blp")
  set indexid_DivinityPotion=CID('I0GG','I0GF','h075',0,"ReplaceableTextures\\CommandButtons\\BTNPotionOfDivinity.blp")
  set indexid_dustofappearance=CID('I0GI','I0GH','h076',0,"ReplaceableTextures\\CommandButtons\\BTNDustOfAppearance.blp")
  set indexid_wandofillusions=CID('I0KT','I0KS','h0B9',0,"ReplaceableTextures\\CommandButtons\\BTNWandOfManaSteal.blp")
  set indexid_Smoke=CID('I0NF','I0NG','h0D3',0,"ReplaceableTextures\\CommandButtons\\BTNSmokePotion.blp")
  set indexid_Perseverance=CID('I061','I062',0,'I01J',"ReplaceableTextures\\CommandButtons\\BTNOrbOfFire.blp")
  set indexid_HeaddressOfRejuvenation=CID('I064','I063',0,'I01K',"ReplaceableTextures\\CommandButtons\\BTNINV_Helmet_17.blp")
  set indexid_NathrezimBuckler=CID('I065','I066',0,'I01L',"ReplaceableTextures\\CommandButtons\\BTNThoriumArmor.blp")
  set indexid_RingOfBasilius=CID('I068','I067',0,'I01M',"ReplaceableTextures\\CommandButtons\\BTNRingVioletSpider.tga")
  set indexid_RingOfBasiliusHero=CID('I069','I06A',0,'I0C6',"ReplaceableTextures\\CommandButtons\\BTNRingVioletSpider.tga")
  set indexid_bootsOfTravel=CID('I06C','I06B',0,'I01P',"ReplaceableTextures\\CommandButtons\\BTNAbility_Rogue_Sprint.blp")
  set indexid_PowerTreadsAgility=CID('I03O','I02T',0,'I01R',"ReplaceableTextures\\CommandButtons\\BTNWirtsLegGreen.blp")
  set indexid_PowerTreadsStrength=CID('I02U','I05Y',0,'I01Q',"ReplaceableTextures\\CommandButtons\\BTNWirtsLeg.blp")
  set indexid_PowerTreadsIntelligence=CID('I060','I05Z',0,'I01S',"ReplaceableTextures\\CommandButtons\\BTNWirtsLegBlue.blp")
  set indexid_HandOfMidas=CID('I06E','I06D',0,'I01T',"ReplaceableTextures\\CommandButtons\\BTNGoldGloves.blp")
  set indexid_HandOfMidasCourier=CID('I0NO','I0NN',0,'I0NP',"ReplaceableTextures\\CommandButtons\\BTNGoldGloves.blp")
  set indexid_OblivionStaff=CID('I06G','I06F',0,'I01U',"ReplaceableTextures\\CommandButtons\\BTNINV_Mace_10.blp")
  set indexid_Bracer=CID('I06I','I06H',0,'I01V',"ReplaceableTextures\\CommandButtons\\BTNRunedBracers.blp")
  set indexid_WraithBand=CID('I06K','I06J',0,'I01W',"ReplaceableTextures\\CommandButtons\\BTNRevenant.blp")
  set indexid_NullTalisman=CID('I06M','I06L',0,'I01X',"ReplaceableTextures\\CommandButtons\\BTNTalisman.tga")
  set indexid_Yasha=CID('I08F','I08G',0,'I01Y',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_10.blp")
  set indexid_Sange=CID('I08I','I08H',0,'I01Z',"ReplaceableTextures\\CommandButtons\\BTNJapaneseSword.blp")
  set indexid_CraniumBasher=CID('I08J','I08K',0,'I020',"ReplaceableTextures\\CommandButtons\\BTNINV_Hammer_10.blp")
  set indexid_CraniumBasherRanged=CID('I08M','I08L',0,'I0C8',"ReplaceableTextures\\CommandButtons\\BTNINV_Hammer_10.blp")
  set indexid_BladeMail=CID('I08N','I08O',0,'I021',"ReplaceableTextures\\CommandButtons\\BTNINV_Chest_Plate06.blp")
  set indexid_Maelstrom=CID('I08Q','I08P',0,'I022',"ReplaceableTextures\\CommandButtons\\BTNStormHammer.blp")
  set indexid_DiffusalBlade=CID('I08S','I08R',0,'I023',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_11.blp")
  set indexid_DiffusalBlade_upg=CID('I0JB','I0J9',0,'I0JD',"ReplaceableTextures\\CommandButtons\\BTNDiffusal2.blp")
  set indexid_DiffusalBlade_empty=CID('I0EW','I0EV',0,'I0EX',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_11.blp")
  set indexid_DiffusalBlade_upg_empty=CID('I0JC','I0JA',0,'I0JE',"ReplaceableTextures\\CommandButtons\\BTNDiffusal2.blp")
  set indexid_HelmOfTheDominator=CID('I08U','I08T',0,'I024',"ReplaceableTextures\\CommandButtons\\BTNINV_Helmet_13.blp")
  set indexid_HelmOfTheDominatorCourier=CID('I08W','I08V',0,'I0CO',"ReplaceableTextures\\CommandButtons\\BTNINV_Helmet_13.blp")
  set indexid_MaskOfMadness=CID('I08X','I08Y',0,'I025',"ReplaceableTextures\\CommandButtons\\BTNHelmOfValor.blp")
  set indexid_Eul=CID('I090','I08Z',0,'I026',"ReplaceableTextures\\CommandButtons\\BTNStaffofpurification.blp")
  set indexid_SoulBooster=CID('I092','I091',0,'I027',"ReplaceableTextures\\CommandButtons\\BTNPhilosophersStone.blp")
  set indexid_Mekansm=CID('I094','I093',0,'I028',"ReplaceableTextures\\CommandButtons\\BTNSpellShieldAmulet.blp")
  set indexid_SangeAndYasha=CID('I096','I095',0,'I029',"ReplaceableTextures\\CommandButtons\\BTNSpell_Holy_BlessingOfStrength.blp")
  set indexid_Desolator=CID('I098','I097',0,'I02A',"ReplaceableTextures\\CommandButtons\\BTNAbility_Gouge.blp")
  set indexid_BattleFury=CID('I09A','I099',0,'I02B',"ReplaceableTextures\\CommandButtons\\BTNINV_ThrowingAxe_06.blp")
  set indexid_Crystalys=CID('I09B','I09C',0,'I02C',"ReplaceableTextures\\CommandButtons\\BTNThoriumMelee.blp")
  set s="ReplaceableTextures\\CommandButtons\\BTNRodOfNecromancy.blp"
  set indexid_BKB10=CID('I0G2','I0FZ',0,'I0G8',s)
  set indexid_BKB09=CID('I0G6','I0G0',0,'I0G9',s)
  set indexid_BKB08=CID('I09E','I0FY',0,'I0G7',s)
  set indexid_BKB07=CID('I0G5','I0FS',0,'I02D',s)
  set indexid_BKB06=CID('I0G3','I09D',0,'I0GB',s)
  set indexid_BKB05=CID('I0G4','I0G1',0,'I0GA',s)
  set indexid_BlackKingBar04=CID('I0P6','I0P8',0,'I0P7',s)
  set indexid_Aegis=CID('I0AX','I0AW',0,0,"ReplaceableTextures\\CommandButtons\\BTNArcaniteArmor.blp")
  set indexid_MantaStyle=CID('I09G','I09F',0,'I02E',"ReplaceableTextures\\CommandButtons\\BTNINV_ThrowingAxe_02.blp")
  set indexid_MantaStyleRanged=CID('I0MV','I0MU',0,'I0MW',"ReplaceableTextures\\CommandButtons\\BTNINV_ThrowingAxe_02.blp")
  set indexid_LotharsEdge=CID('I09I','I09H',0,'I02F',"ReplaceableTextures\\CommandButtons\\BTNLothars.blp")
  set s="ReplaceableTextures\\CommandButtons\\BTNINV_Wand_06.blp"
  set indexid_Dagon1=CID('I09K','I09M',0,'I01G',s)
  set indexid_Dagon2=CID('I09J','I09P',0,'I02G',s)
  set indexid_Dagon3=CID('I09Q','I09N',0,'I0DC',s)
  set indexid_Dagon4=CID('I09S','I09O',0,'I0DD',s)
  set indexid_Dagon5=CID('I09R','I09L',0,'I0D3',s)
  set indexid_Necronomicon1=CID('I09U','I09T',0,'I02H',"ReplaceableTextures\\CommandButtons\\BTNNecromancerAdept.blp")
  set indexid_Necronomicon2=CID('I09V','I09X',0,'I02I',"ReplaceableTextures\\CommandButtons\\BTNBookOfTheDead.blp")
  set indexid_Necronomicon3=CID('I09W','I09Y',0,'I02J',"ReplaceableTextures\\CommandButtons\\BTNNecromancerMaster.blp")
  set indexid_LinkensSphere=CID('I0A0','I09Z',0,'I0BO',"ReplaceableTextures\\CommandButtons\\BTNOrb of Water.blp")
  set indexid_LinkenDummy=CID('I0HK','I0HJ',0,'I0HL',"ReplaceableTextures\\CommandButtons\\BTNOrb of Water.blp")
  set indexid_DivineRapier=CID('I0A2','I0A1',0,'I0BP',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_25.blp")
  set indexid_DivineRapierFree=CID('I0LI','I0LJ',0,'I0LK',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_25.blp")
  set indexid_Buriza=CID('I0A4','I0A3',0,'I0BQ',"ReplaceableTextures\\CommandButtons\\BTNINV_Weapon_Crossbow_10.blp")
  set indexid_MKBOn=CID('I0A6','I0A5',0,'I0BR',"ReplaceableTextures\\CommandButtons\\BTNINV_Weapon_Halberd_10.blp")
  set indexid_MKBOff=CID('I0K8','I0K7',0,'I0K9',"ReplaceableTextures\\CommandButtons\\BTNINV_Weapon_Halberd_10.blp")
  set indexid_RadianceOn=CID('I0A7','I0A8',0,'I0BS',"ReplaceableTextures\\CommandButtons\\BTNTransmute.blp")
  set indexid_RadianceOff=CID('I0KQ','I0KP',0,'I0KR',"ReplaceableTextures\\CommandButtons\\BTNTransmute.blp")
  set indexid_HeartOfTarrasque=CID('I0AA','I0A9',0,'I0BT',"ReplaceableTextures\\CommandButtons\\BTNHeartOfAszune.blp")
  set indexid_DisabledHeartOfTarrasque=CID('I0AA','I0KL',0,'I0KM',"ReplaceableTextures\\CommandButtons\\BTNHeartOfAszune.blp")
  set indexid_Satanic=CID('I0AC','I0AB',0,'I0BU',"ReplaceableTextures\\CommandButtons\\BTNHornOfDoom.blp")
  set indexid_EyeOfSkadi=CID('I0AD','I0AE',0,'I0BV',"ReplaceableTextures\\CommandButtons\\BTNIceShard.blp")
  set indexid_EyeOfSkadiRanged=CID('I0AG','I0AF',0,'I0CT',"ReplaceableTextures\\CommandButtons\\BTNIceShard.blp")
  set indexid_Butterfly=CID('I0AH','I0AI',0,'I0BW',"ReplaceableTextures\\CommandButtons\\BTNINV_ThrowingKnife_04.blp")
  set indexid_AghanimBasic=CID('I0B8','I0AY',0,'I00B',"ReplaceableTextures\\CommandButtons\\BTNINV_Wand_05.blp")
  set indexid_aghanimUpgrader=CID('I0QT','I0QS',0,'I0QU',"ReplaceableTextures\\CommandButtons\\BTNINV_Wand_05.blp")
  set indexid_RefresherOrb=CID('I0AK','I0AJ',0,'I0BX',"ReplaceableTextures\\CommandButtons\\BTNHeartOfSearinox.blp")
  set indexid_GuinsooHex=CID('I07K','I0AL',0,'I0BY',"ReplaceableTextures\\CommandButtons\\BTNINV_Sword_09.blp")
  set indexid_Vanguard=CID('I0BB','I0BA',0,'I0BZ',"ReplaceableTextures\\CommandButtons\\BTNAdvancedUnholyArmor.blp")
  set indexid_VanguardRanged=CID('I0LE','I0LC',0,'I0LD',"ReplaceableTextures\\CommandButtons\\BTNAdvancedUnholyArmor.blp")
  set indexid_ArcaneRing=CID('I0BC','I0BD',0,'I00C',"ReplaceableTextures\\CommandButtons\\BTNArcaneRing.blp")
  set indexid_Mjollnir=CID('I0BF','I0BE',0,'I0C0',"ReplaceableTextures\\CommandButtons\\BTNThunderMallet.blp")
  set indexid_FlyingCourier=CID('I014','I01D',0,0,"ReplaceableTextures\\CommandButtons\\BTNRavenForm.blp")
  set indexid_VladmirsOffering=CID('I0BH','I0BG',0,'I0C1',"ReplaceableTextures\\CommandButtons\\BTNCloakOfFlames.blp")
  set indexid_AssaultCuirass=CID('I0BI','I0BJ',0,'I0C2',"ReplaceableTextures\\CommandButtons\\BTNINV_Chest_Chain_14.blp")
  set indexid_bloodstone=CID('I0BL','I0BK',0,'I0C3',"ReplaceableTextures\\CommandButtons\\BTNINV_Misc_Gem_Bloodstone_02.blp")
  set indexid_HoodOfDefiance=CID('I0BN','I0BM',0,'I0C4',"ReplaceableTextures\\CommandButtons\\BTNHoodOfCunning.blp")
  set indexid_ArmletOn=CID('I00S','I00M',0,'I01C',"ReplaceableTextures\\CommandButtons\\BTNImprovedUnholyStrength.blp")
  set indexid_ArmletOff=CID('I00T','I00Q',0,'I01E',"ReplaceableTextures\\CommandButtons\\BTNUnholyStrength.blp")
  set indexid_ArmletOnCourier=CID('I00V','I00N',0,'I01F',"ReplaceableTextures\\CommandButtons\\BTNImprovedUnholyStrength.blp")
  set indexid_ArmletOffCourier=CID('I00W','I00R',0,'I0DE',"ReplaceableTextures\\CommandButtons\\BTNUnholyStrength.blp")
  set indexid_ShivasGuard=CID('I00X','I00Z',0,'I0CF',"ReplaceableTextures\\CommandButtons\\BTNAdvancedMoonArmor.blp")
  set indexid_ShivasGuardCourier=CID('I00Y','I010',0,'I0DF',"ReplaceableTextures\\CommandButtons\\BTNAdvancedMoonArmor.blp")
  set indexid_Orchid=CID('I013','I012',0,'I0CB',"ReplaceableTextures\\CommandButtons\\BTNStaffOfSilence.blp")
  set indexid_PhaseBoots=CID('I0GK','I0GJ',0,'I0GL',"ReplaceableTextures\\CommandButtons\\BTNPhaseBoots.blp")
  set indexid_ForceStaff=CID('I0HG','I0HI',0,'I0HH',"ReplaceableTextures\\CommandButtons\\BTNForceStaff.blp")
  set indexid_Pipe=CID('I0I0','I0K6',0,'I0I2',"ReplaceableTextures\\CommandButtons\\BTNPipeOfInsight.blp")
  set indexid_PoormansShield=CID('I0JG','I0JF',0,'I0JH',"ReplaceableTextures\\CommandButtons\\BTNImprovedUnholyArmor.blp")
  set indexid_PoormansShieldRanged=CID('I0KD','I0KF',0,'I0KE',"ReplaceableTextures\\CommandButtons\\BTNImprovedUnholyArmor.blp")
  set indexid_UrnOfShadows=CID('I0KX','I0KY',0,'I0KZ',"ReplaceableTextures\\CommandButtons\\BTNUrnOfKelThuzad.blp")
  set indexid_UrnOfShadowsEmpty=CID('I0LG','I0LF',0,'I0LH',"ReplaceableTextures\\CommandButtons\\BTNUrnOfKelThuzad.blp")
  set indexid_SoulRing=CID('I0LP','I0LL',0,'I0LQ',"ReplaceableTextures\\CommandButtons\\BTNSoulRing.blp")
  set indexid_EtherealBlade=CID('I0LR','I0LT',0,'I0LS',"ReplaceableTextures\\CommandButtons\\BTNGhostBlade.blp")
  set indexid_ArcaneBoots=CID('I0MJ','I0MI',0,'I0MK',"ReplaceableTextures\\CommandButtons\\BTNArcaneBoots.blp")
  set indexid_MedallionOfCourage=CID('I0N1','I0N0',0,'I0N2',"ReplaceableTextures\\CommandButtons\\BTNMedalionOfCourage.blp")
  set indexid_janggo=CID('I0ND','I0NE',0,'I0NC',"ReplaceableTextures\\CommandButtons\\BTNJanggo.blp")
  set indexid_janggoempty=CID('I0NL','I0NK',0,'I0NM',"ReplaceableTextures\\CommandButtons\\BTNJanggo.blp")
  set indexid_VeilOfDiscord=CID('I0O2','I0O3',0,'I0O4',"ReplaceableTextures\\CommandButtons\\BTNBoneChimes.blp")
  set indexid_BladeOfTheReaper=CID('I0OC','I0OE',0,'I0OD',"ReplaceableTextures\\CommandButtons\\BTNBoneChimes.blp")
  set indexid_TranquilBoots=CID('I0OF','I0OG',0,'I0OH',"ReplaceableTextures\\CommandButtons\\BTNTranquilBoots.blp")
  set indexid_TranquilBootsBroken=CID('I0OJ','I0OI',0,'I0OK',"ReplaceableTextures\\CommandButtons\\BTNTranquilBoots.blp")
  set indexid_RodOfAtos=CID('I0OM','I0OL',0,'I0ON',"ReplaceableTextures\\CommandButtons\\BTNWitchDoctorMaster.blp")
  set indexid_MoonShard=CID('I0OP','I0OO',0,'I0OQ',"ReplaceableTextures\\CommandButtons\\BTNPendantOfMana.blp")
  set indexid_HeavensHalberd=CID('I0OU','I0OV',0,'I0OW',"ReplaceableTextures\\CommandButtons\\BTNHalberd.blp")
  set indexid_AbyssalBlade=CID('I0OY','I0OX',0,'I0OZ',"ReplaceableTextures\\CommandButtons\\BTNAnnihilator.blp")
  set indexid_RingOfAquila=CID('I0P0','I0P1',0,'I0P2',"ReplaceableTextures\\CommandButtons\\BTNRingJadeFalcon.blp")
  set indexid_RingOfAquilaHero=CID('I0P3','I0P4',0,'I0P5',"ReplaceableTextures\\CommandButtons\\BTNRingJadeFalcon.blp")
  call CID(0,0,'h02G',0,"")
  call CID(0,0,'h086',0,"")
  set s="ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp"
  set indexid_RecipeHeaddressOfRejuvenation=CID('I05L','I05R','h02H','I0DS',s)
  set indexid_RecipeNethrezimBuckler=CID('I05M','I05S','h02I','I0DT',s)
  call CID(0,0,'h02J',0,"")
  set indexid_RecipeBootsOfTravel=CID('I05O','I05T','h02K','I0DU',s)
  set indexid_RecipePowerTreads=CID(0,0,'h014',0,s)
  set indexid_RecipeHandOfMidas=CID('I05P','I05U','h02L','I0DW',s)
  call CID(0,0,'h02M',0,"")
  set indexid_RecipeBracer=CID('I05K','I05V','h02N','I0DX',s)
  set indexid_RecipeWraithBand=CID('I05N','I05W','h02O','I0DY',s)
  set indexid_RecipeNullTalisman=CID('I05Q','I05X','h02P','I0DZ',s)
  set indexid_RecipeYasha=CID('I06N','I06O','h02Q','I0E0',s)
  set indexid_RecipeSange=CID('I06Q','I06P','h02R','I0E1',s)
  set indexid_RecipeCraniumBasher=CID('I06R','I06S','h02S','I0E2',s)
  call CID(0,0,'h02T',0,"")
  set indexid_RecipeMaelstrom=CID('I06W','I06V','h02U','I0E4',s)
  set indexid_RecipeDiffusalBlade=CID('I06X','I06Y','h02V','I0E5',s)
  call CID(0,0,'h02W',0,"")
  set indexid_RecipeMaskOfMadness=CID('I070','I06Z','h02X','I0E6',s)
  set indexid_RecipeEul=CID('I071','I072','h02Y','I0E7',s)
  call CID(0,0,'h02Z',0,"")
  set indexid_RecipeMekansm=CID('I074','I073','h030','I0E8',s)
  set indexid_RecipeSangeAndYasha=CID(0,0,'h031',0,"")
  set indexid_RecipeDesolator=CID('I076','I07V','h032','I0EA',s)
  call CID(0,0,'h033',0,"")
  set indexid_RecipeCrystalys=CID('I077','I07W','h034','I0EB',s)
  set indexid_RecipeBKB=CID('I078','I07X','h035','I0EC',s)
  set indexid_RecipeMantaStyle=CID('I079','I07Y','h036','I0ED',s)
  set indexid_RecipeLotharsEdge=CID('I07A',0,'h037','I0EE',s)
  set indexid_RecipeDagon=CID('I07B','I080','h038','I0EF',s)
  set indexid_RecipeNecronomicon=CID('I07C','I081','h039','I0EG',s)
  set indexid_RecipeLinken=CID('I07D','I082','h03A','I0EH',s)
  call CID(0,0,'h03C',0,"")
  set indexid_RecipeBuriza=CID('I07E','I083','h03D','I0EI',s)
  call CID(0,0,'h03E',0,"")
  set indexid_RecipeRadiance=CID('I07G','I07F','h03F','I0EJ',s)
  set indexid_RecipeHeartOfTarrasque=CID('I07H','I084','h03G','I0EK',s)
  set indexid_RecipeSatanic=CID('I07O','I085','h03H','I0EL',s)
  set indexid_RecipeEyeOfSkadi=CID(0,0,'h03I',0,"")
  set indexid_RecipeButterfly=CID(0,0,'h03J',0,"")
  set indexid_RecipeAghanim=CID(0,0,'h03K',0,"")
  set indexid_RecipeRefresherOrb=CID('I07J','I088','h03L','I0EO',s)
  call CID(0,0,'h03M',0,"")
  call CID(0,0,'h03N',0,"")
  set indexid_RecipeArcaneRing=CID('I07M','I089','h03O','I0EP',s)
  set indexid_RecipeFlyingCourier=CID('I07P','I08A','h03Q','I0EQ',s)
  set indexid_RecipeVladmirOffering=CID('I07Q','I08B','h03R','I0ER',s)
  set indexid_RecipeAssaultCuirass=CID('I07R','I08C','h03S','I0ES',s)
  set indexid_RecipeBloodstone=CID('I0QQ','I0QN','h03T','I0QR',s)
  call CID(0,0,'h03U',0,"")
  set indexid_RecipeArmlet=CID('I07S','I08D','h03V','I0ET',s)
  set indexid_RecipeShivasGuard=CID('I07T','I08E','h03W','I0EU',s)
  call CID(0,0,'h079',0,"")
  set indexid_RecipeMagicWand=CID('I0H8','I0H7','h07S','I0H9',s)
  set indexid_RecipeForceStaff=CID('I0HD','I0HF','h07T','I0HE',s)
  set indexid_RecipePipe=CID('I0HX','I0HZ','h07X','I0HY',s)
  set indexid_RecipeMjollnir=CID('I07L','I0KN','h03P','I0KO',s)
  set indexid_RecipeUrnOfShadows=CID('I0KW','I0KV','h0BA','I0KU',s)
  set indexid_RecipeSoulRing=CID('I0LM','I0LN','h0BQ','I0LO',s)
  set indexid_RecipeJanggo=CID('I0N9','I0NA','h0D1','I0NB',s)
  set indexid_RecipeMedallion=CID('I0NH','I0NI','h0CY','I0NJ',s)
  set indexid_RecipeVeilOfDiscord=CID('I0O5','I0O6','h0DD','I0O7',s)
  set indexid_RecipeOrchid=CID('I0OB','I0OA','h03X','I0O9',s)
  set indexid_RecipeBladeOfReaper=CID(0,0,'h0DT',0,"")
  set indexid_RecipeTranquilBoots=CID(0,0,'h0DU',0,"")
  call CID(0,0,'h0E9',0,"")
  call CID(0,0,'h0EA',0,"")
  call CID(0,0,'h0EC',0,"")
  set indexid_ShadowAmulet=CID('I0P9','I0PB','h0EI','I0PA',"ReplaceableTextures\\CommandButtons\\BTNPendantOfMana.blp")
  set Item_SideShops[CID('I03A','I051','h08K','I0D9',"ReplaceableTextures\\CommandButtons\\BTNSteelArmor.blp")]=indexid_StoutShield
  set Item_SideShops[CID('I03Y','I052','h08X','I0C9',"ReplaceableTextures\\CommandButtons\\BTNOrbofSlowness.blp")]=indexid_UltimateOrb
  set Item_SideShops[CID('I02S','I02P','h08S','I0CA',"ReplaceableTextures\\CommandButtons\\BTNGlove.blp")]=indexid_GlovesOfHaste
  set Item_SideShops[CID('I02N','I02R','h08P','I0CS',"ReplaceableTextures\\CommandButtons\\BTNBoots.blp")]=indexid_BootsOfElvenskin
  set Item_SideShops[CID('I02Z','I043','h08Q','I0CV',"ReplaceableTextures\\CommandButtons\\BTNBelt.blp")]=indexid_BeltOfStrength
  set Item_SideShops[CID('I031','I045','h08T','I0D5',"ReplaceableTextures\\CommandButtons\\BTNClawsOfAttack.blp")]=indexid_BladesOfAttack
  set Item_SideShops[CID('I03B','I04E','h08N','I0DA',"ReplaceableTextures\\CommandButtons\\BTNHelmutPurple.blp")]=indexid_HelmOfIronWill
  set Item_SideShops[CID('I03E','I04H','h08W','I0C7',"ReplaceableTextures\\CommandButtons\\BTNDaggerOfEscape.blp")]=indexid_KelensDagger
  set Item_SideShops[CID('I03G','I04K','h08O','I0CD',"ReplaceableTextures\\CommandButtons\\BTNUndeadShrine.blp")]=indexid_MaskOfDeath
  set Item_SideShops[CID('I03P','I04S','h08U','I0CY',"ReplaceableTextures\\CommandButtons\\BTNAlleriaFlute.blp")]=indexid_Quarterstaff
  set Item_SideShops[CID('I03Q','I04T','h08G','I0DI',"ReplaceableTextures\\CommandButtons\\BTNGoldRing.blp")]=indexid_RingOfHealth
  set Item_SideShops[CID('I03S','I04V','h08L','I0DJ',"ReplaceableTextures\\CommandButtons\\BTNRingSkull.blp")]=indexid_RingOfRegeneration
  set Item_SideShops[CID('I03T','I04W','h08R','I0CP',"ReplaceableTextures\\CommandButtons\\BTNRobeOfTheMagi.blp")]=indexid_RobeOfMagi
  set Item_SideShops[CID('I03V','I04Y','h08E','I0C5',"ReplaceableTextures\\CommandButtons\\BTNSlippersOfAgility.blp")]=indexid_SlippersOfAgility
  set Item_SideShops[CID('I03W','I04Z','h08J','I0DK',"ReplaceableTextures\\CommandButtons\\BTNSobiMask.blp")]=indexid_SobiMask
  set Item_SideShops[CID('I0GD','I0GC','h08I','I0GE',"ReplaceableTextures\\CommandButtons\\BTNWand.blp")]=indexid_MagicStick
  set Item_SideShops[CID('I0HT','I0HR','h08F','I0HW',"ReplaceableTextures\\CommandButtons\\BTNOrcMeleeUpTwo.blp")]=indexid_QuellingBlade
  set Item_SideShops[CID('I0J7','I0J6','h08V','I0J8',"ReplaceableTextures\\CommandButtons\\BTNAmulet.blp")]=indexid_TalismanOfEvasion
  set Item_SideShops[CID('I03L','I04P','h08M','I0CE',"ReplaceableTextures\\CommandButtons\\BTNINV_Misc_Cape_08.blp")]=indexid_PlaneswalkerCloak
  set Item_SideShops[CID('I05A','I05I','h08H',0,"ReplaceableTextures\\CommandButtons\\BTNScrollUber.blp")]=indexid_ScrollOfTownPortal
  set Item_SideShops[CID('I037','I04B','h093','I0CR',"ReplaceableTextures\\CommandButtons\\BTNEnchantedGemstone.blp")]=indexid_EnergyBooster
  set Item_SideShops[CID('I02Q','I02O','h0BO','I00A',"ReplaceableTextures\\CommandButtons\\BTNINV_Misc_Cape_08.blp")]=indexid_BootsOfSpeed
  set Item_SideShops[CID('I0MA','I0M9','h0CN','I0MB',"ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp")]=indexid_OrbOfVenom
  set Item_SideShops[CID('I033','I047','h0D0','I0D7',"ReplaceableTextures\\CommandButtons\\BTNGlove.blp")]=indexid_Broadsword
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfHealth
  set Rec_Comp_2[Recipe_Max]=indexid_VoidStone
  set Rec_Final[Recipe_Max]=indexid_Perseverance
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_2[Recipe_Max]=indexid_IronwoodBranch
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeHeaddressOfRejuvenation
  set Rec_Final[Recipe_Max]=indexid_HeaddressOfRejuvenation
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Chainmail
  set Rec_Comp_2[Recipe_Max]=indexid_IronwoodBranch
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeNethrezimBuckler
  set Rec_Final[Recipe_Max]=indexid_NathrezimBuckler
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfProtection
  set Rec_Comp_2[Recipe_Max]=indexid_SobiMask
  set Rec_Final[Recipe_Max]=indexid_RingOfBasilius
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeBootsOfTravel
  set Rec_Final[Recipe_Max]=indexid_bootsOfTravel
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_BootsOfElvenskin
  set Rec_Comp_3[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Final[Recipe_Max]=indexid_PowerTreadsAgility
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_BeltOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Final[Recipe_Max]=indexid_PowerTreadsStrength
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_RobeOfMagi
  set Rec_Comp_3[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Final[Recipe_Max]=indexid_PowerTreadsIntelligence
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeHandOfMidas
  set Rec_Final[Recipe_Max]=indexid_HandOfMidas
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Quarterstaff
  set Rec_Comp_2[Recipe_Max]=indexid_RobeOfMagi
  set Rec_Comp_3[Recipe_Max]=indexid_SobiMask
  set Rec_Final[Recipe_Max]=indexid_OblivionStaff
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_CircletOfNobility
  set Rec_Comp_2[Recipe_Max]=indexid_GauntletOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeBracer
  set Rec_Final[Recipe_Max]=indexid_Bracer
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_CircletOfNobility
  set Rec_Comp_2[Recipe_Max]=indexid_SlippersOfAgility
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeWraithBand
  set Rec_Final[Recipe_Max]=indexid_WraithBand
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_CircletOfNobility
  set Rec_Comp_2[Recipe_Max]=indexid_MantleOfIntelligence
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeNullTalisman
  set Rec_Final[Recipe_Max]=indexid_NullTalisman
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BladesOfAlacrity
  set Rec_Comp_2[Recipe_Max]=indexid_BootsOfElvenskin
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeYasha
  set Rec_Final[Recipe_Max]=indexid_Yasha
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_OgreAxe
  set Rec_Comp_2[Recipe_Max]=indexid_BeltOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeSange
  set Rec_Final[Recipe_Max]=indexid_Sange
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_javelin
  set Rec_Comp_2[Recipe_Max]=indexid_BeltOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeCraniumBasher
  set Rec_Final[Recipe_Max]=indexid_CraniumBasher
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Broadsword
  set Rec_Comp_2[Recipe_Max]=indexid_Chainmail
  set Rec_Comp_3[Recipe_Max]=indexid_RobeOfMagi
  set Rec_Final[Recipe_Max]=indexid_BladeMail
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MithrilHammer
  set Rec_Comp_2[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeMaelstrom
  set Rec_Final[Recipe_Max]=indexid_Maelstrom
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BladesOfAlacrity
  set Rec_Comp_2[Recipe_Max]=indexid_BladesOfAlacrity
  set Rec_Comp_3[Recipe_Max]=indexid_RobeOfMagi
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeDiffusalBlade
  set Rec_Final[Recipe_Max]=indexid_DiffusalBlade
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_DiffusalBlade
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDiffusalBlade
  set Rec_Final[Recipe_Max]=indexid_DiffusalBlade_upg
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_DiffusalBlade_empty
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDiffusalBlade
  set Rec_Final[Recipe_Max]=indexid_DiffusalBlade_upg
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_HelmOfIronWill
  set Rec_Comp_2[Recipe_Max]=indexid_MaskOfDeath
  set Rec_Final[Recipe_Max]=indexid_HelmOfTheDominator
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MaskOfDeath
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeMaskOfMadness
  set Rec_Final[Recipe_Max]=indexid_MaskOfMadness
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SobiMask
  set Rec_Comp_2[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_3[Recipe_Max]=indexid_VoidStone
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeEul
  set Rec_Final[Recipe_Max]=indexid_Eul
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_PointBooster
  set Rec_Comp_2[Recipe_Max]=indexid_EnergyBooster
  set Rec_Comp_3[Recipe_Max]=indexid_VitalityBooster
  set Rec_Final[Recipe_Max]=indexid_SoulBooster
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_HeaddressOfRejuvenation
  set Rec_Comp_2[Recipe_Max]=indexid_NathrezimBuckler
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeMekansm
  set Rec_Final[Recipe_Max]=indexid_Mekansm
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Sange
  set Rec_Comp_2[Recipe_Max]=indexid_Yasha
  set Rec_Final[Recipe_Max]=indexid_SangeAndYasha
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MithrilHammer
  set Rec_Comp_2[Recipe_Max]=indexid_MithrilHammer
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeDesolator
  set Rec_Final[Recipe_Max]=indexid_Desolator
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Perseverance
  set Rec_Comp_2[Recipe_Max]=indexid_Broadsword
  set Rec_Comp_3[Recipe_Max]=indexid_Claymore
  set Rec_Final[Recipe_Max]=indexid_BattleFury
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BladesOfAttack
  set Rec_Comp_2[Recipe_Max]=indexid_Broadsword
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeCrystalys
  set Rec_Final[Recipe_Max]=indexid_Crystalys
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MithrilHammer
  set Rec_Comp_2[Recipe_Max]=indexid_OgreAxe
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeBKB
  set Rec_Final[Recipe_Max]=indexid_BKB10
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Yasha
  set Rec_Comp_2[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeMantaStyle
  set Rec_Final[Recipe_Max]=indexid_MantaStyleRanged
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_ShadowAmulet
  set Rec_Comp_2[Recipe_Max]=indexid_Claymore
  set Rec_Final[Recipe_Max]=indexid_LotharsEdge
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_2[Recipe_Max]=indexid_NullTalisman
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeDagon
  set Rec_Final[Recipe_Max]=indexid_Dagon1
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Dagon1
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDagon
  set Rec_Final[Recipe_Max]=indexid_Dagon2
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Dagon2
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDagon
  set Rec_Final[Recipe_Max]=indexid_Dagon3
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Dagon3
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDagon
  set Rec_Final[Recipe_Max]=indexid_Dagon4
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Dagon4
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeDagon
  set Rec_Final[Recipe_Max]=indexid_Dagon5
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_2[Recipe_Max]=indexid_BeltOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeNecronomicon
  set Rec_Final[Recipe_Max]=indexid_Necronomicon1
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Necronomicon1
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeNecronomicon
  set Rec_Final[Recipe_Max]=indexid_Necronomicon2
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Necronomicon2
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeNecronomicon
  set Rec_Final[Recipe_Max]=indexid_Necronomicon3
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_2[Recipe_Max]=indexid_Perseverance
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeLinken
  set Rec_Final[Recipe_Max]=indexid_LinkensSphere
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_DemonEdge
  set Rec_Comp_2[Recipe_Max]=indexid_SacredRelic
  set Rec_Final[Recipe_Max]=indexid_DivineRapier
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Crystalys
  set Rec_Comp_2[Recipe_Max]=indexid_DemonEdge
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeBuriza
  set Rec_Final[Recipe_Max]=indexid_Buriza
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_DemonEdge
  set Rec_Comp_2[Recipe_Max]=indexid_javelin
  set Rec_Comp_3[Recipe_Max]=indexid_javelin
  set Rec_Final[Recipe_Max]=indexid_MKBOn
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SacredRelic
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeRadiance
  set Rec_Final[Recipe_Max]=indexid_RadianceOn
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MesserschmidtReaver
  set Rec_Comp_2[Recipe_Max]=indexid_VitalityBooster
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeHeartOfTarrasque
  set Rec_Final[Recipe_Max]=indexid_HeartOfTarrasque
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MesserschmidtReaver
  set Rec_Comp_2[Recipe_Max]=indexid_HelmOfTheDominator
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeSatanic
  set Rec_Final[Recipe_Max]=indexid_Satanic
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MesserschmidtReaver
  set Rec_Comp_2[Recipe_Max]=indexid_HelmOfTheDominatorCourier
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeSatanic
  set Rec_Final[Recipe_Max]=indexid_Satanic
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_2[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_3[Recipe_Max]=indexid_PointBooster
  set Rec_Comp_4[Recipe_Max]=indexid_OrbOfVenom
  set Rec_Final[Recipe_Max]=indexid_EyeOfSkadi
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_2[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_3[Recipe_Max]=indexid_PointBooster
  set Rec_Comp_4[Recipe_Max]=indexid_OrbOfVenomRanged
  set Rec_Final[Recipe_Max]=indexid_EyeOfSkadi
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RecipeCrimsonGuard
  set Rec_Comp_2[Recipe_Max]=indexid_NathrezimBuckler
  set Rec_Comp_3[Recipe_Max]=indexid_Vanguard
  set Rec_Final[Recipe_Max]=indexid_CrimsonGuard
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RecipeCrimsonGuard
  set Rec_Comp_2[Recipe_Max]=indexid_NathrezimBuckler
  set Rec_Comp_3[Recipe_Max]=indexid_VanguardRanged
  set Rec_Final[Recipe_Max]=indexid_CrimsonGuard
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Eaglehorn
  set Rec_Comp_2[Recipe_Max]=indexid_Quarterstaff
  set Rec_Comp_3[Recipe_Max]=indexid_TalismanOfEvasion
  set Rec_Final[Recipe_Max]=indexid_Butterfly
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SobiMask
  set Rec_Comp_2[Recipe_Max]=indexid_Chainmail
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeMedallion
  set Rec_Final[Recipe_Max]=indexid_MedallionOfCourage
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_PointBooster
  set Rec_Comp_2[Recipe_Max]=indexid_OgreAxe
  set Rec_Comp_3[Recipe_Max]=indexid_BladesOfAlacrity
  set Rec_Comp_4[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Final[Recipe_Max]=indexid_AghanimBasic
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Perseverance
  set Rec_Comp_2[Recipe_Max]=indexid_OblivionStaff
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeRefresherOrb
  set Rec_Final[Recipe_Max]=indexid_RefresherOrb
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_UltimateOrb
  set Rec_Comp_2[Recipe_Max]=indexid_MysticStaff
  set Rec_Comp_3[Recipe_Max]=indexid_VoidStone
  set Rec_Final[Recipe_Max]=indexid_GuinsooHex
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_VitalityBooster
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfHealth
  set Rec_Comp_3[Recipe_Max]=indexid_StoutShield
  set Rec_Final[Recipe_Max]=indexid_Vanguard
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_VitalityBooster
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfHealth
  set Rec_Comp_3[Recipe_Max]=indexid_StoutShieldRanged
  set Rec_Final[Recipe_Max]=indexid_Vanguard
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_EnergyBooster
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfProtection
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeArcaneRing
  set Rec_Final[Recipe_Max]=indexid_ArcaneRing
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Hyperstone
  set Rec_Comp_2[Recipe_Max]=indexid_Maelstrom
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeMjollnir
  set Rec_Final[Recipe_Max]=indexid_Mjollnir
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_AnimalCourier
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeFlyingCourier
  set Rec_Final[Recipe_Max]=indexid_FlyingCourier
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfBasilius
  set Rec_Comp_3[Recipe_Max]=indexid_MaskOfDeath
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeVladmirOffering
  set Rec_Final[Recipe_Max]=indexid_VladmirsOffering
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfBasiliusHero
  set Rec_Comp_3[Recipe_Max]=indexid_MaskOfDeath
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeVladmirOffering
  set Rec_Final[Recipe_Max]=indexid_VladmirsOffering
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Hyperstone
  set Rec_Comp_2[Recipe_Max]=indexid_PlateMail
  set Rec_Comp_3[Recipe_Max]=indexid_Chainmail
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeAssaultCuirass
  set Rec_Final[Recipe_Max]=indexid_AssaultCuirass
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SoulBooster
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeBloodstone
  set Rec_Comp_3[Recipe_Max]=indexid_SoulRing
  set Rec_Final[Recipe_Max]=indexid_bloodstone
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_3[Recipe_Max]=indexid_RingOfHealth
  set Rec_Comp_4[Recipe_Max]=indexid_PlaneswalkerCloak
  set Rec_Final[Recipe_Max]=indexid_HoodOfDefiance
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_GlovesOfHaste
  set Rec_Comp_2[Recipe_Max]=indexid_HelmOfIronWill
  set Rec_Comp_3[Recipe_Max]=indexid_BladesOfAttack
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeArmlet
  set Rec_Final[Recipe_Max]=indexid_ArmletOffCourier
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MysticStaff
  set Rec_Comp_2[Recipe_Max]=indexid_PlateMail
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeShivasGuard
  set Rec_Final[Recipe_Max]=indexid_ShivasGuard
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_OblivionStaff
  set Rec_Comp_2[Recipe_Max]=indexid_OblivionStaff
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeOrchid
  set Rec_Final[Recipe_Max]=indexid_Orchid
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_BladesOfAttack
  set Rec_Comp_3[Recipe_Max]=indexid_BladesOfAttack
  set Rec_Final[Recipe_Max]=indexid_PhaseBoots
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_MagicStick
  set Rec_Comp_2[Recipe_Max]=indexid_IronwoodBranch
  set Rec_Comp_3[Recipe_Max]=indexid_IronwoodBranch
  set Rec_Comp_4[Recipe_Max]=indexid_IronwoodBranch
  set Rec_Comp_5[Recipe_Max]=indexid_RecipeMagicWand
  set Rec_Final[Recipe_Max]=indexid_MagicWand
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_2[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeForceStaff
  set Rec_Final[Recipe_Max]=indexid_ForceStaff
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_HoodOfDefiance
  set Rec_Comp_2[Recipe_Max]=indexid_HeaddressOfRejuvenation
  set Rec_Comp_3[Recipe_Max]=indexid_RecipePipe
  set Rec_Final[Recipe_Max]=indexid_Pipe
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_StoutShield
  set Rec_Comp_2[Recipe_Max]=indexid_SlippersOfAgility
  set Rec_Comp_3[Recipe_Max]=indexid_SlippersOfAgility
  set Rec_Final[Recipe_Max]=indexid_PoormansShield
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_StoutShieldRanged
  set Rec_Comp_2[Recipe_Max]=indexid_SlippersOfAgility
  set Rec_Comp_3[Recipe_Max]=indexid_SlippersOfAgility
  set Rec_Final[Recipe_Max]=indexid_PoormansShield
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SobiMask
  set Rec_Comp_2[Recipe_Max]=indexid_GauntletOfStrength
  set Rec_Comp_3[Recipe_Max]=indexid_GauntletOfStrength
  set Rec_Comp_4[Recipe_Max]=indexid_RecipeUrnOfShadows
  set Rec_Final[Recipe_Max]=indexid_UrnOfShadows
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_SobiMask
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeSoulRing
  set Rec_Final[Recipe_Max]=indexid_SoulRing
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Eaglehorn
  set Rec_Comp_2[Recipe_Max]=indexid_GhostScepter
  set Rec_Final[Recipe_Max]=indexid_EtherealBlade
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_EnergyBooster
  set Rec_Final[Recipe_Max]=indexid_ArcaneBoots
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_RobeOfMagi
  set Rec_Comp_2[Recipe_Max]=indexid_Bracer
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeJanggo
  set Rec_Final[Recipe_Max]=indexid_janggo
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_janggo
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeJanggo
  set Rec_Final[Recipe_Max]=indexid_janggo
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_janggoempty
  set Rec_Comp_2[Recipe_Max]=indexid_RecipeJanggo
  set Rec_Final[Recipe_Max]=indexid_janggo
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_HelmOfIronWill
  set Rec_Comp_2[Recipe_Max]=indexid_NullTalisman
  set Rec_Comp_3[Recipe_Max]=indexid_RecipeVeilOfDiscord
  set Rec_Final[Recipe_Max]=indexid_VeilOfDiscord
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_BootsOfSpeed
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfProtection
  set Rec_Comp_3[Recipe_Max]=indexid_RingOfRegeneration
  set Rec_Final[Recipe_Max]=indexid_TranquilBoots
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_2[Recipe_Max]=indexid_StaffOfWizardry
  set Rec_Comp_3[Recipe_Max]=indexid_VitalityBooster
  set Rec_Final[Recipe_Max]=indexid_RodOfAtos
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_Sange
  set Rec_Comp_2[Recipe_Max]=indexid_TalismanOfEvasion
  set Rec_Final[Recipe_Max]=indexid_HeavensHalberd
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_CraniumBasher
  set Rec_Comp_2[Recipe_Max]=indexid_SacredRelic
  set Rec_Final[Recipe_Max]=indexid_AbyssalBlade
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_WraithBand
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfBasilius
  set Rec_Final[Recipe_Max]=indexid_RingOfAquila
  set Recipe_Max=Recipe_Max+1
  set Rec_Comp_1[Recipe_Max]=indexid_WraithBand
  set Rec_Comp_2[Recipe_Max]=indexid_RingOfBasiliusHero
  set Rec_Final[Recipe_Max]=indexid_RingOfAquilaHero
endfunction

function EscPressedFiler takes nothing returns nothing
  local unit u
  if b_isPickTime then
    if GetUnitTypeId(GetFilterUnit())=='hfoo' then
      if GetTriggerPlayer()==GetLocalPlayer() then
        call ClearSelection()
        call SelectUnit(LoadUnitHandle(HY,GetHandleId(GetFilterUnit()),0),true)
      endif
    endif
  endif
  set u=null
endfunction

function EscPressed takes nothing returns nothing
  local group g=GetAvailableGroup()
  call GroupEnumUnitsSelected(g,GetTriggerPlayer(),Condition(function EscPressedFiler))
  call KillGroup(g)
  set g=null
endfunction

function TreeReviveSpeed takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local destructable d=LoadDestructableHandle(HY,h,0)
  call SetDestructableAnimationSpeed(d,1)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set d=null
  set t=null
endfunction

function TreeReviveAnim takes destructable d returns nothing
  local timer t=CreateTimer()
  local integer h=GetHandleId(t)
  call TimerStart(t,2,false,function TreeReviveSpeed)
  if GetDestructableTypeId(d)=='NTtw' then
    call SetDestructableAnimation(d,"birth")
    call SetDestructableAnimationSpeed(d,600)
  else
    call SetDestructableAnimation(d,"birth")
    call SetDestructableAnimationSpeed(d,3)
  endif
  call SaveDestructableHandle(HY,h,0,d)
  
  set t=null
endfunction

function TreeReviveTimer takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local destructable d=LoadDestructableHandle(HY,h,0)
  call DestructableRestoreLife(d,GetDestructableMaxLife(d),false)
  call TreeReviveAnim(d)
  call PauseTimer(t)
  call DestroyTimer(t)
  call FlushChildHashtable(HY,h)
  set t=null
  set d=null
endfunction

function TreeRevive takes nothing returns nothing
  local timer t=CreateTimer()
  local real time=GetRandomReal(180,300)
  call TimerStart(t,time,false,function TreeReviveTimer)
  call SaveDestructableHandle(HY,GetHandleId(t),0,GetTriggerDestructable())
  //	call echo(Id2String(GetDestructableTypeId(GetFilterDestructable())))
  set t=null
endfunction

function TreeRevivalGrouping takes nothing returns boolean
  if IsValidTree(GetFilterDestructable()) then
    call TriggerRegisterDeathEvent(TreeRevivalTrigger,GetFilterDestructable())
  else
    //		if LoadBoolean(HY,'000D',GetDestructableTypeId(GetFilterDestructable()))==false then
    //			set dstr[asdasd]=GetDestructableTypeId(GetFilterDestructable())
    //			set asdasd=asdasd+1
    //			call SaveBoolean(HY,'000D',GetDestructableTypeId(GetFilterDestructable()),true)
    //		endif
  endif
  return false
endfunction

function SBE takes integer uid, integer aid returns nothing
  call SaveInteger(UMD,uid,5,aid)
endfunction

function SaveBonusEffects takes nothing returns nothing
  call SBE(HeroID[indexid_VS],'A1NR')
  call SBE(HeroID[indexid_Zeus],'A0PF')
  call SBE(HeroID[indexid_Enchantress],'A1X2')
  call SBE(HeroID[indexid_Morphling],0)
  call SBE(HeroID[indexid_CM],'A0Q9')
  call SBE(HeroID[indexid_Sven],0)
  call SBE(HeroID[indexid_NagaSiren],0)
  call SBE(HeroID[indexid_ES],'A1OC')
  call SBE(HeroID[indexid_Riki],0)
  call SBE(HeroID[indexid_LoneDruid],0)
  call SBE(HeroID[indexid_Lina],'A0PC')
  call SBE(HeroID[indexid_Juggernaut],'A1QL')
  call SBE(HeroID[indexid_Silencer],0)
  call SBE(HeroID[indexid_Treant],0)
  call SBE(HeroID[indexid_Chieftain],0)
  call SBE(HeroID[indexid_Kotl],0)
  call SBE(HeroID[indexid_Ursa],0)
  call SBE(HeroID[indexid_OgreMagi],'A0P9')
  call SBE(HeroID[indexid_Tinker],0)
  call SBE(HeroID[indexid_Furion],'A20M')
  call SBE(HeroID[indexid_PL],0)
  call SBE(HeroID[indexid_Tiny],0)
  call SBE(HeroID[indexid_Techies],'A1R7')
  call SBE(HeroID[indexid_Chen],'A20V')
  call SBE(HeroID[indexid_Luna],'A1NQ')
  call SBE(HeroID[indexid_Sniper],0)
  call SBE(HeroID[indexid_Troll],0)
  call SBE(HeroID[indexid_Rhasta],'A0P8')
  call SBE(HeroID[indexid_Wisp],0)
  call SBE(HeroID[indexid_Pandaren],0)
  call SBE(HeroID[indexid_Centaur],0)
  call SBE(HeroID[indexid_Bounty],0)
  call SBE(HeroID[indexid_DK],0)
  call SBE(HeroID[indexid_AM],0)
  call SBE(HeroID[indexid_Trax],0)
  call SBE(HeroID[indexid_Omni],0)
  call SBE(HeroID[indexid_Beastmaster],'A29E')
  call SBE(HeroID[indexid_THD],'A1VF')
  call SBE(HeroID[indexid_Alchemist],0)
  call SBE(HeroID[indexid_Potm],0)
  call SBE(HeroID[indexid_Storm],0)
  call SBE(HeroID[indexid_Huskar],'A1NS')
  call SBE(HeroID[indexid_Lanaya],0)
  call SBE(HeroID[indexid_Puck],'A1RG')
  call SBE(HeroID[indexid_Clock],'A220')
  call SBE(HeroID[indexid_Admiral],0)
  call SBE(HeroID[indexid_WR],0)
  call SBE(HeroID[indexid_Gyro],'A23E')
  call SBE(HeroID[indexid_Disruptor],0)
  call SBE(HeroID[indexid_Tusk],0)
  call SBE(HeroID[indexid_Phoenix],0)
  call SBE(HeroID[indexid_BB],0)
  call SBE(HeroID[indexid_Rubick],0)
  call SBE(HeroID[indexid_Xin],0)
  call SBE(HeroID[indexid_Legion],0)
  call SBE(HeroID[indexid_Skywrath],0)
  call SBE(HeroID[indexid_Timber],0)
  call SBE(HeroID[indexid_Lycan],0)
  call SBE(HeroID[indexid_Brood],0)
  call SBE(HeroID[indexid_PA],0)
  call SBE(HeroID[indexid_Medusa],0)
  call SBE(HeroID[indexid_Bala],0)
  call SBE(HeroID[indexid_Leoric],0)
  call SBE(HeroID[indexid_Doom],0)
  call SBE(HeroID[indexid_NA],0)
  call SBE(HeroID[indexid_Slardar],0)
  call SBE(HeroID[indexid_QoP],'A0P7')
  call SBE(HeroID[indexid_Bone],0)
  call SBE(HeroID[indexid_Void],'A1R3')
  call SBE(HeroID[indexid_Viper],0)
  call SBE(HeroID[indexid_Razor],0)
  call SBE(HeroID[indexid_Lifestealer],0)
  call SBE(HeroID[indexid_Pugna],'A0PB')
  call SBE(HeroID[indexid_Tide],0)
  call SBE(HeroID[indexid_Bane],'A1R8')
  call SBE(HeroID[indexid_Necrolyte],'A1R9')
  call SBE(HeroID[indexid_Pudge],'A1VB')
  call SBE(HeroID[indexid_Barathum],'A1VE')
  call SBE(HeroID[indexid_Weaver],0)
  call SBE(HeroID[indexid_SF],0)
  call SBE(HeroID[indexid_SK],'A1NX')
  call SBE(HeroID[indexid_Axe],'A1V9')
  call SBE(HeroID[indexid_BS],0)
  call SBE(HeroID[indexid_Abaddon],0)
  call SBE(HeroID[indexid_Spectre],0)
  call SBE(HeroID[indexid_WD],'A1V5')
  call SBE(HeroID[indexid_OD],'A1VZ')
  call SBE(HeroID[indexid_WL],'A1UY')
  call SBE(HeroID[indexid_Geomancer],0)
  call SBE(HeroID[indexid_Dazzle],0)
  call SBE(HeroID[indexid_Pit],0)
  call SBE(HeroID[indexid_Zombie],0)
  call SBE(HeroID[indexid_DS],'A21Z')
  call SBE(HeroID[indexid_Kodo],0)
  call SBE(HeroID[indexid_Enigma],0)
  call SBE(HeroID[indexid_Batrider],0)
  call SBE(HeroID[indexid_AA],0)
  call SBE(HeroID[indexid_Slark],0)
  call SBE(HeroID[indexid_TB],0)
  call SBE(HeroID[indexid_Leshrak],0)
  call SBE(HeroID[indexid_SD],0)
  call SBE(HeroID[indexid_Lich],'A0PE')
  call SBE(HeroID[indexid_Banshee],0)
  call SBE(HeroID[indexid_Lion],'A0PA')
  call SBE(HeroID[indexid_Veno],0)
  call SBE(HeroID[indexid_Magnus],0)
  call SBE(HeroID[indexid_Visage],0)
  call SBE(HeroID[indexid_Nessaj],0)
  call SBE(HeroID[indexid_Wyvern],0)
  call SBE(HeroID[indexid_Zet],0)
  call SBE(HeroID[indexid_Earth],0)
  call SBE(HeroID[indexid_Oracle],0)
  call SBE(HeroID[indexid_Crabe],0)
  call SBE(HeroID[indexid_Sieger],0)
  call SBE(HeroID[indexid_Sorcesser],0)
  call SBE(HeroID[indexid_Invoker],0)
  call SBE(HeroID[indexid_Formless],0)
  call SBE(HeroID[indexid_SpaceOrc],0)
endfunction

function LoopTrash takes nothing returns nothing
  local timer t=GetExpiredTimer()
  call RemoveItem(CreateItem('I006'+GetRandomInt(0,2),GetLocationX(TopRuneSpawn),GetLocationY(TopRuneSpawn)))
  call RemoveItem(CreateItem('I006'+GetRandomInt(0,2),GetLocationX(BottomRuneSpawn),GetLocationY(BottomRuneSpawn)))
  call RemoveItem(CreateItem(Item_Dummy[indexid_DivineRapier],GetRandomReal(-6000,6000),GetRandomReal(-6000,6000)))
  call RemoveItem(CreateItem(Item_Dummy[indexid_Gem],GetRandomReal(-6000,6000),GetRandomReal(-6000,6000)))
  //call RemoveUnit(CreateUnit(Player(12),'n00L',GetRectCenterX(Q4),GetRectCenterY(Q4),0))
  call TimerStart(t,GetRandomReal(1.5,3),false,function LoopTrash)
  set t=null
endfunction

function HeroTrasher takes nothing returns nothing
  //	local unit u
  //	local integer i=1
  //	loop
  //		if udg_Hero[i]!=null then
  //			call echo("go for "+I2S(i))
  //			set u=CreateUnit(Neutrals,EMPTYDUMMY,0,0,0)
  //			call UnitAddAbility2(u,'A1HX')
  //			call UnitApplyTimedLife(u,'BTLF',1)
  //			call SetUnitX(u,GetUnitX(udg_Hero[i]))
  //			call SetUnitY(u,GetUnitY(udg_Hero[i]))
  //			call AddSpecialEffectTarget("war3mapImported\\modelcrash.mdx",u,"origin")
  //		endif
  //		set i=i+1
  //		exitwhen i>11
  //	endloop
  //	
  //	call TimerStart(GetExpiredTimer(),GetRandomReal(1.5,3.0),false,function HeroTrasher)
  //	set u=null
endfunction

function RuneTrasher takes nothing returns nothing
  local timer t=CreateTimer()
  //	call TimerStart(t,1,false,function LoopTrash)
  //	set t=CreateTimer()
  //	call TimerStart(t,6.00,false,function HeroTrasher)
  set t=null
endfunction

function Buyback_Addunit takes integer id returns nothing
  set buybackC=buybackC+1
  set BuybackUnitId[buybackC]=id
  set BuybackUnitCost[buybackC]=50*buybackC+50
endfunction

function Buyback_Init takes nothing returns nothing
  call Buyback_Addunit('h09G')
  call Buyback_Addunit('h09T')
  call Buyback_Addunit('h09F')
  call Buyback_Addunit('h09H')
  call Buyback_Addunit('h09E')
  call Buyback_Addunit('h09D')
  call Buyback_Addunit('h09C')
  call Buyback_Addunit('h09B')
  call Buyback_Addunit('h099')
  call Buyback_Addunit('h09A')
  call Buyback_Addunit('h09J')
  call Buyback_Addunit('h09K')
  call Buyback_Addunit('h09L')
  call Buyback_Addunit('h09M')
  call Buyback_Addunit('h09N')
  call Buyback_Addunit('h09O')
  call Buyback_Addunit('h09P')
  call Buyback_Addunit('h09Q')
  call Buyback_Addunit('h09R')
  call Buyback_Addunit('h09S')
  call Buyback_Addunit('h09I')
  call Buyback_Addunit('h09Z')
  call Buyback_Addunit('h09X')
  call Buyback_Addunit('h0A1')
  call Buyback_Addunit('h0A2')
  call Buyback_Addunit('h0A6')
  call Buyback_Addunit('h0A3')
  call Buyback_Addunit('h0A4')
  call Buyback_Addunit('h09Y')
  call Buyback_Addunit('h09V')
  call Buyback_Addunit('h0A0')
  call Buyback_Addunit('h09U')
  call Buyback_Addunit('h0AF')
  call Buyback_Addunit('h0AD')
  call Buyback_Addunit('h0AE')
  call Buyback_Addunit('h0AC')
  call Buyback_Addunit('h0AB')
  call Buyback_Addunit('h0AA')
  call Buyback_Addunit('h0A9')
  call Buyback_Addunit('h0AG')
  call Buyback_Addunit('h0A7')
  call Buyback_Addunit('h0AO')
  call Buyback_Addunit('h0AY')
  call Buyback_Addunit('h0AH')
  call Buyback_Addunit('h0AI')
  call Buyback_Addunit('h0AJ')
  call Buyback_Addunit('h0AP')
  call Buyback_Addunit('h0AQ')
  call Buyback_Addunit('h0AK')
  call Buyback_Addunit('h0AR')
  call Buyback_Addunit('h0AL')
  call Buyback_Addunit('h0AS')
  call Buyback_Addunit('h09W')
  call Buyback_Addunit('h0AM')
  call Buyback_Addunit('h0A8')
  call Buyback_Addunit('h0AT')
  call Buyback_Addunit('h0AU')
  call Buyback_Addunit('h0AN')
  call Buyback_Addunit('h0AV')
  call Buyback_Addunit('h0AW')
  set BuybackID[0]=BuybackUnitId[0]
  set BuybackID[1]=BuybackUnitId[0]
  set BuybackID[2]=BuybackUnitId[0]
  set BuybackID[3]=BuybackUnitId[0]
  set BuybackID[4]=BuybackUnitId[0]
  set BuybackID[5]=BuybackUnitId[0]
  set BuybackID[6]=BuybackUnitId[0]
  set BuybackID[7]=BuybackUnitId[0]
  set BuybackID[8]=BuybackUnitId[0]
  set BuybackID[9]=BuybackUnitId[0]
  set BuybackID[10]=BuybackUnitId[0]
  set BuybackID[11]=BuybackUnitId[0]
  set BuybackID[12]=BuybackUnitId[0]
  set BuybackID[13]=BuybackUnitId[0]
  set BuybackID[14]=BuybackUnitId[0]
endfunction

function ConvertCircle takes unit u, integer pid returns nothing
  local player p=Player(pid)
  call UnitAddAbility(u,'A141')
  if GetLocalPlayer()==p then
    call ClearSelection()
    call SelectUnit(u, true)
    call SetUnitVertexColor(u,255,255,255,255)
  else
    call SetUnitVertexColor(u,255,255,255,25)
  endif
  set CirclesOfPower[pid]=u
  set ItemSpawnX[pid]=GetUnitX(u)
  set ItemSpawnY[pid]=GetUnitY(u)
endfunction

function TestTrack2 takes nothing returns nothing
  local trigger t=GetTriggeringTrigger()
  local trackable tt=GetTriggeringTrackable()
  call echo(I2S(LoadInteger(HY,GetHandleId(tt),0)))
  
  
  set t=null
  set tt=null
endfunction

function TestTrack takes nothing returns nothing
  //	local trackable t1
  //	local trackable t2
  //	local string peasant = ""//units\\human\\Peasant\\Peasant.mdl"
  //	local string invisible = ""
  //	local string path = invisible
  //	local trigger tt=CreateTrigger()
  //	if ( GetLocalPlayer() == Player(1) ) then
  //		set path = peasant
  //	endif
  //	set t1 = CreateTrackable(path, -500, 0, 0)
  //	set path = invisible
  //	if ( GetLocalPlayer() == Player(2) ) then
  //		set path = peasant
  //	endif
  //	set t2 = CreateTrackable(path, -500, 0, 0)
  //	call SaveInteger(HY,GetHandleId(t2),0,2)
  //	call SaveInteger(HY,GetHandleId(t1),0,1)
  //	call TriggerRegisterTrackableTrackEvent(tt,t1)
  //	call TriggerRegisterTrackableTrackEvent(tt,t2)
  //	call TriggerAddCondition(tt,Condition(function TestTrack2))
  //	set t1=null
  //	set t2=null
  //	set tt=null
  
endfunction

function ActionSelect takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetTriggerPlayer()
  local integer id=GetPlayerId(p)
  if u == ShowPickUnit then
    set testr1[id]=true
    set testr2[id]=true
  endif
  if u == VisPickUnit then
    if ( GetPlayerController(p) == MAP_CONTROL_USER ) and ( GetPlayerSlotState(p) == PLAYER_SLOT_STATE_PLAYING ) then
      if testr1[id] == false or testr2[id] == true then
        if IsUnitVisible(ShowTUnit, p) == false then
          set amhc[id]=amhc[id]+1
          if ModuloInteger(amhc[id],30)==3 then
            call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,10, udg_Colors[id]+GetPlayerName(p) + "|r: Maphack detected "+I2S(amhc[id]) + " times")
          endif
          if advancedTracking and ModuloInteger(amhc[id],60)==5 then
            call Traffic_RegisterData("MH"+I2S(id),R2I(TimerGetElapsed(GlobalTimer)))
          endif
        endif
        call SelectUnit(ShowPickUnit, false)
      endif
      set testr1[id]=false
      set testr2[id]=false
    endif
  endif
  if ShowPickUnit != u and VisPickUnit != u then
    set counter1[id]=counter1[id] + 1
    if counter1[id] == 12 then
      set lastunit1[id]=u
    endif
    if counter1[id] == 11 then
      set lastunit2[id]=u
    endif
    if counter1[id] > 12 then
      set counter1[id]=12
    endif
  endif
endfunction

function ActionDeSelect takes nothing returns nothing
  local unit u=GetTriggerUnit()
  local player p=GetTriggerPlayer()
  local integer id=GetPlayerId(p)
  if ShowPickUnit != u and VisPickUnit != u then
    set counter1[id]=counter1[id] - 1
    if lastunit1[id] == u then
      set lastunit1[id]=null
    endif
    if lastunit2[id] == u then
      set lastunit2[id]=null
    endif
  endif
  if u == ShowPickUnit then
    set testr2[id]=false
  endif
endfunction

function DetectMh takes nothing returns nothing
  if DicktB then
    call SetUnitX(ShowPickUnit, GetRectMinX(bj_mapInitialPlayableArea) + 600)
    call SetUnitY(ShowPickUnit, GetRectMaxY(bj_mapInitialPlayableArea) - 600)
  endif
  if counter1[GetPlayerId(GetTriggerPlayer())] <= 10 then
    call SelectUnit(ShowPickUnit, true)
    call SelectUnit(VisPickUnit, true)
    call SelectUnit(VisPickUnit, false)
    call SelectUnit(ShowPickUnit, false)
  else
    call DisableTrigger(TriggerEn1)
    call DisableTrigger(TriggerEn2)
    call SelectUnit(lastunit1[GetPlayerId(GetLocalPlayer())], false)
    call SelectUnit(lastunit2[GetPlayerId(GetLocalPlayer())], false)
    call SelectUnit(ShowPickUnit, true)
    call SelectUnit(VisPickUnit, true)
    call SelectUnit(VisPickUnit, false)
    call SelectUnit(ShowPickUnit, false)
    call SelectUnit(lastunit1[GetPlayerId(GetLocalPlayer())], true)
    call SelectUnit(lastunit2[GetPlayerId(GetLocalPlayer())], true)
    call EnableTrigger(TriggerEn1)
    call EnableTrigger(TriggerEn2)
  endif
  if DicktB  then
    call SetUnitX(ShowPickUnit, GetRectMaxX(bj_mapInitialPlayableArea))
    call SetUnitY(ShowPickUnit, GetRectMinY(bj_mapInitialPlayableArea))
    set DicktB = false
  else 
    set DicktB = true
  endif
endfunction

function InitAMH takes nothing returns nothing
  local integer i=1
  set ShowPickUnit=CreateUnit(Player(12), 'hfoo', GetRectMaxX(bj_mapInitialPlayableArea), GetRectMinY(bj_mapInitialPlayableArea), 0.00)
  set VisPickUnit=CreateUnit(Player(12), 'hfoo', GetRectMinX(bj_mapInitialPlayableArea) + 600, GetRectMaxY(bj_mapInitialPlayableArea) - 600, 0.00)
  set ShowTUnit=CreateUnit(Player(12), 'hfoo', GetRectMaxX(bj_mapInitialPlayableArea), GetRectMinY(bj_mapInitialPlayableArea), 0.00)
  set TriggerEn1=CreateTrigger()
  set TriggerEn2=CreateTrigger()
  loop
    exitwhen i > 12
    call TriggerRegisterPlayerUnitEvent(TriggerEn1, Player(i), EVENT_PLAYER_UNIT_SELECTED, null)
    call TriggerRegisterPlayerUnitEvent(TriggerEn2, Player(i), EVENT_PLAYER_UNIT_DESELECTED, null)
    set i=i + 1
  endloop
  call TriggerAddAction(TriggerEn1, function ActionSelect)
  call TriggerAddAction(TriggerEn2, function ActionDeSelect)
  set TimerMh = CreateTimer()
  call TimerStart(TimerMh, 1.5, true, function DetectMh)
endfunction

function AntihackInit takes nothing returns nothing
  local trigger t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.1,false)
  call TriggerAddAction(t,function InitAMH)
  
  call RuneTrasher()
  
  set t=null
endfunction

function RechargeBottleFountain takes unit u returns nothing
  local integer i=0
  local item it
  local integer id
  local integer k=UnitInventorySize(u)
  loop
    exitwhen i>k
    set it=UnitItemInSlot(u,i)
    set id=GetIndex(it)
    if(id==indexid_Bottle0 or id==indexid_Bottle1 or id==indexid_Bottle2)and GetItemUserData(it)>0 then
      call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouchTarget.mdl",u,"overhead"))
      call SoundForPlayer(GetOwningPlayer(u),"Abilities\\Spells\\Human\\Heal\\HealTarget.wav")
      set tt_player1=GetItemPlayer(it)
      call DestroyItem(it)
      set tt_item1=AddItemByIdInSlot(u,Item_Real[indexid_Bottle3],i)
      call SetItemPlayer(tt_item1,tt_player1,false)
      call SetItemUserData(tt_item1,1)
      call UnitRemoveAbility(u,'B0GI')
    endif
    set i=i+1
  endloop
  set it=null
endfunction

function FountainHealPeriodic takes nothing returns nothing
  local timer t=GetExpiredTimer()
  local integer h=GetHandleId(t)
  local unit u=LoadUnitHandle(HY,h,0)
  local integer hu=GetHandleId(u)
  if IsDead(u) and hu<=0 then
    set hu=LoadInteger(HY,h,-1)
    call FlushChildHashtable(HY,hu)
    call PauseTimer(t)
    call DestroyTimer(t)
  else
    if IsUnitInRegion(LoadRegionHandle(HY,h,1),u)==false then
      call SaveInteger(HY,h,0,LoadInteger(HY,h,0)+1)
      if LoadBoolean(HY,h,25) then
        call UnitRemoveAbility(u,'Avul')
      endif
    else
      call SaveInteger(HY,h,0,0)
      if LoadBoolean(HY,h,25) then
        call UnitAddAbility2(u,'Avul')
      endif
    endif
    if LoadInteger(HY,h,0) > 25 then
      call DestroyEffect(LoadEffectHandle(HY,h,2))
      call DestroyEffect(LoadEffectHandle(HY,h,3))
      call RemoveSavedHandle(HY,hu,'FNTN')
      call FlushChildHashtable(HY,h)
      call PauseTimer(t)
      call DestroyTimer(t)
    elseif IsDead(u)==false then
      if LoadInteger(HY,h,0) == 0 then
        if LoadBoolean(HY,h,15)==false then
          call RechargeBottleFountain(u)
        endif
        call SaveBoolean(HY,h,15,LoadBoolean(HY,h,15)==false)
      endif
      call SetWidgetLife(u,GetWidgetLife(u)+0.004*GetUnitState(u,UNIT_STATE_MAX_LIFE))
      call SetUnitState(u,UNIT_STATE_MANA,GetUnitState(u,UNIT_STATE_MANA)+0.004*GetUnitState(u,UNIT_STATE_MAX_LIFE)+1.4)
      if GetWidgetLife(u)==GetUnitState(u,UNIT_STATE_MAX_LIFE) and GetUnitState(u,UNIT_STATE_MANA)==GetUnitState(u,UNIT_STATE_MAX_MANA) then
        call DestroyEffect(LoadEffectHandle(HY,h,2))
        call DestroyEffect(LoadEffectHandle(HY,h,3))
        call SaveBoolean(HY,h,0,true)
      elseif LoadBoolean(HY,h,0) then
        call SaveEffectHandle(HY,h,2,AddSpecialEffectTarget("Abilities\\Spells\\Other\\ANrl\\ANrlTarget.mdl",u,"origin"))
        call SaveEffectHandle(HY,h,3,AddSpecialEffectTarget("Abilities\\Spells\\Other\\ANrm\\ANrmTarget.mdl",u,"origin"))
        call SaveBoolean(HY,h,0,false)
      endif
    endif
  endif
  
  set t=null
  set u=null
endfunction

function FountainHeal takes unit u, region r returns nothing
  local timer t
  local integer h
  if HaveSavedHandle(HY,GetHandleId(u),'FNTN')then
    set t=LoadTimerHandle(HY,GetHandleId(u),'FNTN')
    set h=GetHandleId(t)
  else
    set t=CreateTimer()
    set h=GetHandleId(t)
    call TimerStart(t,0.1,true,function FountainHealPeriodic)
    call SaveUnitHandle(HY,h,0,u)
    call SaveInteger(HY,h,-1,GetHandleId(u))
    call SaveTimerHandle(HY,GetHandleId(u),'FNTN',t)
    call SaveRegionHandle(HY,h,1,r)
    call SaveBoolean(HY,h,0,true)
    call SaveBoolean(HY,h,25,IsCourier(u))
    if IsCourier(u) then
      call UnitAddAbility2(u,'Avul')
    endif
  endif
  
  set t=null
endfunction

function SentFountainArea takes nothing returns boolean
  if IsSentinel(GetOwningPlayer(GetTriggerUnit())) and GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')==0 and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
    if GetTriggerEventId()==EVENT_GAME_ENTER_REGION then
      call FountainHeal(GetTriggerUnit(),SentFountainReg)
    endif
  endif
  return false
endfunction

function ScourgeFountainArea takes nothing returns boolean
  if IsScourge(GetOwningPlayer(GetTriggerUnit())) and GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')==0 and IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)==false then
    if GetTriggerEventId()==EVENT_GAME_ENTER_REGION then
      call FountainHeal(GetTriggerUnit(),ScourgeFountainReg)
    endif
  endif
  return false
endfunction

function InitSomeLists takes nothing returns nothing
  
endfunction

function InitCustomTeams takes nothing returns nothing
  call SetPlayerTeam(Player(1),0)
  call SetPlayerTeam(Player(2),0)
  call SetPlayerTeam(Player(3),0)
  call SetPlayerTeam(Player(4),0)
  call SetPlayerTeam(Player(5),0)
  call SetPlayerTeam(Player(7),1)
  call SetPlayerTeam(Player(8),1)
  call SetPlayerTeam(Player(9),1)
  call SetPlayerTeam(Player(10),1)
  call SetPlayerTeam(Player(11),1)
endfunction

function main takes nothing returns nothing
  local weathereffect we
  local integer i
  local player p
  local unit u
  local integer hu
  local trigger t
  local real life
  local integer ZG8
  local integer HFH
  local version v
  local integer T88
  local integer a
  local location YT9
  local region UJE
  local real d
  local timer tt
  call LoD_Init()
  call SuspendTimeOfDay(true)
  call TriggerAddCondition(GAME_TRIGGER,Condition(function LoD_Event_Condition))
  call TriggerAddCondition(CHAT_TRIGGER,Condition(function LoD_Chat_Event))
  call SetCameraBounds(-7552.+GetCameraMargin(CAMERA_MARGIN_LEFT),-7936.+GetCameraMargin(CAMERA_MARGIN_BOTTOM),7552.-GetCameraMargin(CAMERA_MARGIN_RIGHT),7424.-GetCameraMargin(CAMERA_MARGIN_TOP),-7552.+GetCameraMargin(CAMERA_MARGIN_LEFT),7424.-GetCameraMargin(CAMERA_MARGIN_TOP),7552.-GetCameraMargin(CAMERA_MARGIN_RIGHT),-7936.+GetCameraMargin(CAMERA_MARGIN_BOTTOM))
  call SetDayNightModels("Environment\\DNC\\DNCFelwood\\DNCFelwoodTerrain\\DNCFelwoodTerrain.mdl","Environment\\DNC\\DNCFelwood\\DNCFelwoodUnit\\DNCFelwoodUnit.mdl")
  call SetWaterBaseColor(0,0,255,255)
  call NewSoundEnvironment("Default")
  call SetAmbientDaySound("FelwoodDay")
  call SetAmbientNightSound("FelwoodNight")
  call SetMapMusic("Music",true,0)
  
  
  set OC=CreateSound("Abilities\\Spells\\NightElf\\Blink\\BlinkArrival1.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(OC,"BlinkTarget")
  call SetSoundDuration(OC,1466)
  call SetSoundPitch(OC,1.6)
  set AC=CreateSound("Abilities\\Spells\\Human\\Blizzard\\BlizzardLoop1.wav",true,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(AC,"BlizzardLoop")
  call SetSoundDuration(AC,4000)
  set BC=CreateSound("Buildings\\Undead\\TempleOfTheDamned\\TempleOfTheDamnedWhat.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(BC,"TempleOfTheDamnedWhat")
  call SetSoundDuration(BC,3518)
  call SetSoundDistanceCutoff(BC,2000.)
  set CC=CreateSound("Abilities\\Spells\\Human\\Flare\\FlareTarget2.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(CC,"Flare2")
  call SetSoundDuration(CC,1344)
  call SetSoundDistanceCutoff(CC,2000.)
  set Sounds_Dominating=CreateSound("Sounds\\Dominating.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Dominating,1802)
  call SetSoundChannel(Sounds_Dominating,0)
  call SetSoundVolume(Sounds_Dominating,127)
  call SetSoundPitch(Sounds_Dominating,1.)
  set Sounds_DK=CreateSound("Sounds\\Double_Kill.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_DK,2012)
  call SetSoundChannel(Sounds_DK,0)
  call SetSoundVolume(Sounds_DK,127)
  call SetSoundPitch(Sounds_DK,1.)
  set Sounds_FB=CreateSound("Sounds\\firstblood.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_FB,1567)
  call SetSoundChannel(Sounds_FB,0)
  call SetSoundVolume(Sounds_FB,127)
  call SetSoundPitch(Sounds_FB,1.)
  set Sound_TechiesLaugh=CreateSound("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack1.wav",false,false,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(Sound_TechiesLaugh,"GoblinSapperYesAttack")
  call SetSoundDuration(Sound_TechiesLaugh,813)
  call SetSoundChannel(Sound_TechiesLaugh,0)
  set Sounds_Godlike=CreateSound("Sounds\\GodLike.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Godlike,1828)
  call SetSoundChannel(Sounds_Godlike,0)
  call SetSoundVolume(Sounds_Godlike,127)
  call SetSoundPitch(Sounds_Godlike,1.)
  set Sounds_HolyShit=CreateSound("Sounds\\HolyShit.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_HolyShit,2325)
  call SetSoundChannel(Sounds_HolyShit,0)
  call SetSoundVolume(Sounds_HolyShit,127)
  call SetSoundPitch(Sounds_HolyShit,1.)
  set KC=CreateSound("Buildings\\NightElf\\MoonWell\\MoonWellWhat1.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(KC,"MoonWellWhat")
  call SetSoundDuration(KC,2972)
  call SetSoundDistances(KC,600.,10000.)
  call SetSoundDistanceCutoff(KC,2000.)
  set LC=CreateSound("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaos.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(LC,"MarkOfChaos")
  call SetSoundDuration(LC,4000)
  set Sounds_KillingSpree=CreateSound("Sounds\\Killing_Spree.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_KillingSpree,2377)
  call SetSoundChannel(Sounds_KillingSpree,0)
  call SetSoundVolume(Sounds_KillingSpree,127)
  call SetSoundPitch(Sounds_KillingSpree,1.)
  set NC=CreateSound("Sound\\Buildings\\Death\\NightElfBuildingDeathSmall1.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(NC,"DeathNightElfBuildingCancel")
  call SetSoundDuration(NC,3675)
  set Sounds_Megakill=CreateSound("Sounds\\MegaKill.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Megakill,2612)
  call SetSoundChannel(Sounds_Megakill,0)
  call SetSoundVolume(Sounds_Megakill,127)
  call SetSoundPitch(Sounds_Megakill,1.)
  set SoundMeld=CreateSound("Abilities\\Spells\\NightElf\\ShadowMeld\\ShadowMeld1.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(SoundMeld,"ShadowMeld")
  call SetSoundDuration(SoundMeld,941)
  set Sounds_Monsterkill=CreateSound("Sounds\\MonsterKill.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Monsterkill,3344)
  call SetSoundChannel(Sounds_Monsterkill,0)
  call SetSoundVolume(Sounds_Monsterkill,127)
  call SetSoundPitch(Sounds_Monsterkill,1.)
  set Sounds_Ownage=CreateSound("Sounds\\Ownage.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Ownage,2586)
  call SetSoundChannel(Sounds_Ownage,0)
  call SetSoundVolume(Sounds_Ownage,127)
  call SetSoundPitch(Sounds_Ownage,1.)
  set TD=CreateSound("Abilities\\Spells\\Undead\\DevourMagic\\DevourMagic.wav",false,true,true,10,10,"MissilesEAX")
  call SetSoundParamsFromLabel(TD,"DevourMagicLaunch")
  call SetSoundDuration(TD,1225)
  set QD=CreateSound("Sound\\Ambient\\DoodadEffects\\TheHornOfCenarius.wav",false,false,false,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(QD,"HornOfCenariusSound")
  call SetSoundDuration(QD,12121)
  call SetSoundVolume(QD,115)
  set Sounds_TrippleKill=CreateSound("Sounds\\triple_kill.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_TrippleKill,1907)
  call SetSoundChannel(Sounds_TrippleKill,0)
  call SetSoundVolume(Sounds_TrippleKill,127)
  call SetSoundPitch(Sounds_TrippleKill,1.)
  set Sounds_Unstoppable=CreateSound("Sounds\\Unstoppable.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_Unstoppable,2038)
  call SetSoundChannel(Sounds_Unstoppable,0)
  call SetSoundVolume(Sounds_Unstoppable,127)
  call SetSoundPitch(Sounds_Unstoppable,1.)
  set CE=CreateSound("Abilities\\Spells\\Human\\DivineShield\\PaladinDivineShieldDeath1.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(CE,"DivineShieldDeath")
  call SetSoundDuration(CE,1043)
  call SetSoundDistanceCutoff(CE,1500.)
  set DE=CreateSound("Abilities\\Spells\\Items\\AIso\\SoulGem.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(DE,"SoulGem")
  call SetSoundDuration(DE,4474)
  set Sounds_WickedSick=CreateSound("Sounds\\WhickedSick.mp3",false,false,false,10,10,"DefaultEAXON")
  call SetSoundDuration(Sounds_WickedSick,2612)
  call SetSoundChannel(Sounds_WickedSick,0)
  call SetSoundVolume(Sounds_WickedSick,127)
  call SetSoundPitch(Sounds_WickedSick,1.)
  set FE=CreateSound("Units\\Creeps\\GoblinSapper\\GoblinSapperYesAttack4.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(FE,"GoblinSapperYesAttack")
  call SetSoundDuration(FE,1091)
  call SetSoundChannel(FE,0)
  set GE=CreateSound("Abilities\\Spells\\NightElf\\shadowstrike\\ShadowStrikeBirth1.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(GE,"ShadowStrikeBirth")
  call SetSoundDuration(GE,2194)
  call SetSoundPitch(GE,1.2)
  set XE=CreateSound("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.wav",false,false,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(XE,"ReviveHuman")
  call SetSoundDuration(XE,3196)
  call SetSoundChannel(XE,8)
  set gg_snd_DarkSummoningLaunch1 = CreateSound( "Abilities\\Spells\\Undead\\DarkSummoning\\DarkSummoningLaunch1.wav", false, true, true, 10, 10, "SpellsEAX" )
  call SetSoundParamsFromLabel( gg_snd_DarkSummoningLaunch1, "DarkSummoningMissileLaunch" )
  call SetSoundDuration( gg_snd_DarkSummoningLaunch1, 2624 )
  call SetSoundChannel(gg_snd_DarkSummoningLaunch1,10)
  set gg_snd_PossessionMissileLaunch1 = CreateSound( "Abilities\\Spells\\Undead\\Possession\\PossessionMissileLaunch1.wav", false, true, true, 10, 10, "SpellsEAX" )
  call SetSoundParamsFromLabel( gg_snd_PossessionMissileLaunch1, "PossessionMissileLaunch" )
  call SetSoundDuration( gg_snd_PossessionMissileLaunch1, 1335 )
  call SetSoundChannel(gg_snd_PossessionMissileLaunch1,10)
  set Sounds_UltraKill=CreateSound("Sounds\\UltraKill.mp3",false,false,false,10,10,"")
  call SetSoundDuration(Sounds_UltraKill,1958)
  call SetSoundChannel(Sounds_UltraKill,0)
  call SetSoundVolume(Sounds_UltraKill,127)
  call SetSoundPitch(Sounds_UltraKill,1.)
  set Sounds_Rampage=CreateSound("Sounds\\Rampage.mp3",false,false,false,10,10,"")
  call SetSoundDuration(Sounds_Rampage,1195)
  call SetSoundChannel(Sounds_Rampage,0)
  call SetSoundVolume(Sounds_Rampage,127)
  call SetSoundPitch(Sounds_Rampage,1.)
  set ME=CreateSound("Units\\Orc\\AncestralGuardian\\AncestralGuardianAttack1.wav",false,true,true,10,10,"CombatSoundsEAX")
  call SetSoundParamsFromLabel(ME,"AncestralGuardianAttack1")
  call SetSoundDuration(ME,1181)
  set NE=CreateSound("Abilities\\Spells\\Human\\Feedback\\Feedback.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(NE,"Feedback")
  call SetSoundDuration(NE,1222)
  set SE=CreateSound("Units\\Undead\\Abomination\\AbominationPissed5.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(SE,"AbominationPissed")
  call SetSoundDuration(SE,1735)
  set RE=CreateSound("Sound\\Units\\Death\\ArtilleryCorpseExplodeDeath1.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(RE,"ArtilleryExplodeDeath")
  call SetSoundDuration(RE,1486)
  set PE=CreateSound("Units\\Undead\\CryptFiend\\CryptFiendPissed2.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(PE,"CryptFiendPissed")
  call SetSoundDuration(PE,3541)
  set ResQFun=CreateSound("Units\\Orc\\BatTroll\\TrollbatriderPissed4.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(ResQFun,"TrollbatriderPissed")
  call SetSoundDuration(ResQFun,2659)
  set QE=CreateSound("Units\\Undead\\Banshee\\BansheeDeath.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(QE,"BansheeDeath")
  call SetSoundDuration(QE,2380)
  set IF=CreateSound("Abilities\\Spells\\Other\\Volcano\\VolcanoLoop.wav",false,false,false,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(IF,"VolcanoLoop")
  call SetSoundDuration(IF,7616)
  set OF=CreateSound("Abilities\\Spells\\Human\\ThunderClap\\ThunderClapCaster.wav",false,false,false,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(OF,"ThunderClap")
  call SetSoundDuration(OF,3451)
  set AF=CreateSound("Abilities\\Spells\\Orc\\MirrorImage\\MirrorImage.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(AF,"MirrorImage")
  call SetSoundDuration(AF,1756)
  set BF=CreateSound("Abilities\\Spells\\Human\\CloudOfFog\\CloudOfFogLoop1.wav",true,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(BF,"CloudOfFogLoop")
  call SetSoundDuration(BF,2038)
  call SetSoundPitch(BF,.9)
  set ZF=CreateSound("Sound\\Interface\\Hint.wav",false,false,false,10,10,"")
  call SetSoundParamsFromLabel(ZF,"Hint")
  call SetSoundDuration(ZF,2006)
  set VF=CreateSound("war3mapImported\\pl_impact_stun.mp3",false,true,true,10,10,"SpellsEAX")
  call SetSoundDuration(VF,1340)
  call SetSoundChannel(VF,11)
  call SetSoundVolume(VF,127)
  call SetSoundPitch(VF,1.)
  call SetSoundDistances(VF,600.,10000.)
  call SetSoundDistanceCutoff(VF,2000.)
  call SetSoundConeAngles(VF,.0,.0,127)
  call SetSoundConeOrientation(VF,.0,.0,.0)
  set WF=CreateSound("Sound\\Buildings\\Fire\\OrcHumanLargeBuildingFire1.wav",true,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(WF,"HumanFireLarge")
  call SetSoundDuration(WF,3471)
  set XF=CreateSound("Units\\Human\\Phoenix\\PhoenixEggWhat1.wav",false,false,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(XF,"PhoenixEggWhat")
  call SetSoundDuration(XF,1579)
  call SetSoundChannel(XF,0)
  set KF=CreateSound("Abilities\\Spells\\Human\\SpellSteal\\SpellStealMissile.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(KF,"SpellStealMissileLaunch")
  call SetSoundDuration(KF,1541)
  set LF=CreateSound("Abilities\\Spells\\Human\\SpellSteal\\SpellStealTarget.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(LF,"SpellStealTarget")
  call SetSoundDuration(LF,984)
  set MF=CreateSound("Abilities\\Spells\\Undead\\UndeadMine\\AcolyteMining.wav",false,true,true,10,10,"DefaultEAXON")
  call SetSoundParamsFromLabel(MF,"AcolyteMining")
  call SetSoundDuration(MF,4233)
  call SetSoundChannel(MF,0)
  set SF=CreateSound("Abilities\\Spells\\Undead\\ReplenishMana\\SpiritTouch.wav",false,true,true,10,10,"SpellsEAX")
  call SetSoundParamsFromLabel(SF,"SpiritTouch")
  call SetSoundDuration(SF,2043)
  call SetSoundChannel(SF,11)
  set ScouBotMeleeSpawnRect=Rect(6176.,3136.,6400.,3392.)
  set ScouMidMeleeSpawnRect=Rect(3616.,3584.,3872.,3872.)
  set ScouTopMeleeSpawnRect=Rect(2304.,5280.,2752.,5728.)
  set gg_rct_Hero_Creation_UD=Rect(6176.,5952.,6624.,6240.)
  set SentBotRangeSpawnRect=Rect(-4224.,-6848.,-3968.,-6592.)
  set SentTopRangeSpawnRect=Rect(-6304.,-4384.,-6080.,-4224.)
  set SentMidRangeSpawnRect=Rect(-4928.,-5760.,-4736.,-5536.)
  set ScouBotRangeSpawnRect=Rect(6048.,3424.,6304.,3776.)
  set ScouMidRangeSpawnRect=Rect(4128.,3776.,4352.,4032.)
  set ScouTopRangeSpawnRect=Rect(2752.,5408.,3040.,5632.)
  set gg_rct_Hero_Creation_NE=Rect(-7040.,-6912.,-6688.,-6656.)
  set SentBotMeleeSpawnRect=Rect(-3648.,-6880.,-3424.,-6688.)
  set SentTopMeleeSpawnRect=Rect(-6336.,-4224.,-5984.,-3904.)
  set SentMidMeleeSpawnRect=Rect(-4896.,-5504.,-4608.,-5184.)
  set BottomRuneSpawnRect=Rect(2912.,-2944.,3104.,-2720.)
  set F4=Rect(5696.,5504.,7296.,7392.)
  set G4=Rect(-7680.,-8032.,-6176.,-6240.)
  set TopRuneSpawnRect=Rect(-2464.,1536.,-2240.,1760.)
  set NR_Und_Ar=Rect(4480,-1184,4512,-1216)
  set NR_Elf_Ar=Rect(-3328.,-416.,-3104.,-96.)
  set NR_Elf_Cr=Rect(1440.,-4096.,1728.,-3872.)
  set NR_Und_Bpr=Rect(-4576.,3328.,-4448.,3488.)
  set NR_Und_Pr=Rect(-3264.,4192.,-2912.,4320.)
  set NR_Elf_Pr=Rect(2848.,-5088.,3072.,-4928.)
  set NR_Und_TRr=Rect(-1824.,2240.,-1472.,2464.)
  set NR_Elf_BRr=Rect(3008.,-3776.,3136.,-3648.)
  set NR_Und_BBr=Rect(1184.,2976.,1280.,3104.)
  set NR_Elf_OldSmr=Rect(-512.,-3648.,-320.,-3520.)
  set gg_rct_Allpick_Sent=Rect(-7104.,6656.,-6848.,6912.)
  set gg_rct_Allpick_Scourge=Rect(-7104.,6656.,-6880.,6880.)
  set Q4=Rect(4192,-2272,4224,-2304)
  set NR_Und_A=Rect(4000,-736,4768,-1568)
  set NR_Elf_A=Rect(-3552.,-768.,-2528.,320.)
  set NR_Elf_C=Rect(1056.,-5216.,2368.,-3744.)
  set NR_Und_Bp=Rect(-5120.,3008.,-3648.,4320.)
  set NR_Und_P=Rect(-3456.,3808.,-2656.,4864.)
  set NR_Elf_P=Rect(2272.,-6080.,3776.,-4928.)
  set NR_Und_TR=Rect(-1888.,2208.,-992.,3040.)
  set NR_Und_BB=Rect(416.,2624.,1632.,3648.)
  set NR_Elf_BR=Rect(2592.,-4800.,3744.,-3328.)
  set NR_Elf_OldSm=Rect(-1024.,-3808.,192.,-2752.)
  set H5=Rect(-7936.,-7776.,-5920.,-5760.)
  set Z5=Rect(5504.,5184.,7744.,7136.)
  set NR_Uld_OldSm=Rect(-800.,3072.,64.,4032.)
  set NR_Uld_OldSmr=Rect(-384.,3392.,-192.,3520.)
  set NR_Elf_Roof=Rect(-1728.,-5056.,-768.,-3840.)
  set NR_Elf_Roofr=Rect(-1152.,-4704.,-960.,-4480.)
  set J5=Rect(-480.,-800.,-256.,-512.)
  set IA=Rect(-8192.,-3712.,-7008.,-2144.)
  set OA=Rect(-3360.,-8192.,-1472.,-7648.)
  set BA=Rect(-2528.,-7840.,-1696.,-7488.)
  set CA=Rect(-2336.,-7584.,-1600.,-7456.)
  set DA=Rect(-8192.,2016.,-6816.,2880.)
  set EA=Rect(6880.,-3328.,8000.,-2624.)
  set Waypoints_ScMidSpawn=Rect(3904.,2976.,4160.,3264.)
  set Waypoints_ScTopSpawn=Rect(2336.,5952.,2592.,6240.)
  set Waypoints_ScBotSpawn=Rect(6304.,1984.,6560.,2272.)
  set Waypoints_SentBotSpawn=Rect(-3328.,-6912.,-3072.,-6624.)
  set Waypoints_SentMidSpawn=Rect(-4384.,-4800.,-4128.,-4512.)
  set Waypoints_SentTopSpawn=Rect(-6432.,-3840.,-6176.,-3552.)
  set p=Player(15)
  set GoblinShop_Bot=CreateUnit(p,'u00Z',7360.,-4416.,270.)
  set GoblinShop_Top=CreateUnit(p,'u00Z',-7296.,4224.,270.)
  set u=CreateUnit(p,'uC74',3200.,-64.,270.)
  set u=CreateUnit(p,'uC74',-4544.,1152.,270.)
  set GoblinMerch_Top=CreateUnit(p,'u010',-7296.,4416.,270.)
  set GoblinMerch_Bot=CreateUnit(p,'u010',7360.,-4224.,270.)
  call SetUnitColor(GoblinMerch_Bot,ConvertPlayerColor(12))
  call SetUnitColor(GoblinMerch_Top,ConvertPlayerColor(12))
  call SetUnitColor(GoblinShop_Top,ConvertPlayerColor(12))
  call SetUnitColor(GoblinShop_Bot,ConvertPlayerColor(12))
  set TopWaypointDummy=CreateUnit(p,'e00D',-6005.1,5458.6,212.15)
  set MidWaypointDummy=CreateUnit(p,'e00B',-561.7,-651.7,325.6)
  set BottomWaypointDummy=CreateUnit(p,'e00A',5613.5,-6350.9,64.)
  set SentBaseWaypointDummy=CreateUnit(p,'e008',-5467.9,-5891.1,307.304)
  set ScouBaseWaypointDummy=CreateUnit(p,'e001',4901.8,4536.6,212.11)
  call ConfigureNeutralVictim()
  set PL8=Filter(function ReturnTrue)
  set filterIssueHauntOrderAtLocBJ=Filter(function IssueHauntOrderAtLocBJFilter)
  set filterEnumDestructablesInCircleBJ=Filter(function S08)
  set filterGetUnitsInRectOfPlayer=Filter(function GetUnitsInRectOfPlayerFilter)
  set filterGetUnitsOfTypeIdAll=Filter(function GetUnitsOfTypeIdAllFilter)
  set filterGetUnitsOfPlayerAndTypeId=Filter(function GetUnitsOfPlayerAndTypeIdFilter)
  set filterMeleeTrainedUnitIsHeroBJ=Filter(function MeleeTrainedUnitIsHeroBJFilter)
  set filterLivingPlayerUnitsOfTypeId=Filter(function LivingPlayerUnitsOfTypeIdFilter)
  set ZG8=0
  loop
    exitwhen ZG8==16
    set bj_FORCE_PLAYER[ZG8]=CreateForce()
    call ForceAddPlayer(bj_FORCE_PLAYER[ZG8],Player(ZG8))
    set ZG8=ZG8+1
  endloop
  set bj_FORCE_ALL_PLAYERS=CreateForce()
  call ForceEnumPlayers(bj_FORCE_ALL_PLAYERS,null)
  set bj_cineModePriorSpeed=GetGameSpeed()
  set bj_cineModePriorFogSetting=IsFogEnabled()
  set bj_cineModePriorMaskSetting=IsFogMaskEnabled()
  set ZG8=0
  loop
    exitwhen ZG8>=bj_MAX_QUEUED_TRIGGERS
    set bj_queuedExecTriggers[ZG8]=null
    set bj_queuedExecUseConds[ZG8]=false
    set ZG8=ZG8+1
  endloop
  set bj_isSinglePlayer=false
  set HFH=0
  set ZG8=0
  loop
    exitwhen ZG8>=12
    if(GetPlayerController(Player(ZG8))==MAP_CONTROL_USER and GetPlayerSlotState(Player(ZG8))==PLAYER_SLOT_STATE_PLAYING)then
      set HFH=HFH+1
    endif
    set ZG8=ZG8+1
  endloop
  set bj_isSinglePlayer=(HFH==1)
  set bj_rescueSound=CreateSoundFromLabel("Rescue",false,false,false,10000,10000)
  set bj_questDiscoveredSound=CreateSoundFromLabel("QuestNew",false,false,false,10000,10000)
  set bj_questUpdatedSound=CreateSoundFromLabel("QuestUpdate",false,false,false,10000,10000)
  set bj_questCompletedSound=CreateSoundFromLabel("QuestCompleted",false,false,false,10000,10000)
  set bj_questFailedSound=CreateSoundFromLabel("QuestFailed",false,false,false,10000,10000)
  set bj_questHintSound=CreateSoundFromLabel("Hint",false,false,false,10000,10000)
  set bj_questSecretSound=CreateSoundFromLabel("SecretFound",false,false,false,10000,10000)
  set bj_questItemAcquiredSound=CreateSoundFromLabel("ItemReward",false,false,false,10000,10000)
  set bj_questWarningSound=CreateSoundFromLabel("Warning",false,false,false,10000,10000)
  set bj_victoryDialogSound=CreateSoundFromLabel("QuestCompleted",false,false,false,10000,10000)
  set bj_defeatDialogSound=CreateSoundFromLabel("QuestFailed",false,false,false,10000,10000)
  call DelayedSuspendDecayCreate()
  set v=VersionGet()
  if(v==VERSION_REIGN_OF_CHAOS)then
    set bj_MELEE_MAX_TWINKED_HEROES=bj_MELEE_MAX_TWINKED_HEROES_V0
  else
    set bj_MELEE_MAX_TWINKED_HEROES=bj_MELEE_MAX_TWINKED_HEROES_V1
  endif
  call InitQueuedTriggers()
  call InitRescuableBehaviorBJ()
  call InitDNCSounds()
  call InitMapRects()
  call InitSummonableCaps()
  set T88=0
  loop
    set bj_stockAllowedPermanent[T88]=false
    set bj_stockAllowedCharged[T88]=false
    set bj_stockAllowedArtifact[T88]=false
    set T88=T88+1
    exitwhen T88>10
  endloop
  call SetAllItemTypeSlots(11)
  call SetAllUnitTypeSlots(11)
  set bj_stockUpdateTimer=CreateTimer()
  call TimerStart(bj_stockUpdateTimer,bj_STOCK_RESTOCK_INITIAL_DELAY,false,function TG8)
  set bj_stockItemPurchased=CreateTrigger()
  call TriggerRegisterPlayerUnitEvent(bj_stockItemPurchased,Player(15),EVENT_PLAYER_UNIT_SELL_ITEM,null)
  call TriggerAddAction(bj_stockItemPurchased,function RemovePurchasedItem)
  call DetectGameStarted()
  set PreloaderUnit=CreateUnit(Player(15),'H00Y',0,0,0)
  call ShowUnit(PreloaderUnit,false)
  call PauseUnit(PreloaderUnit,true)
  set tt=CreateTimer()
  call SaveTimerHandle(HY,GetHandleId(PreloaderUnit),0,tt)
  set i=0
  loop
    set b_isHeroPicked[i]=false
    set IsHeroIngame[i]=false
    set WO[i]=0
    set i=i+1
    exitwhen(i>NumberOfHeroes)
  endloop
  set OwnageCounters[1]=0
  set OwnageCounters[2]=0
  set DM_Counter[0]=0
  set DM_LivesUsed[0]=0
  set DM_Counter[1]=0
  set DM_LivesUsed[1]=0
  set Force_Elfs=CreateForce()
  set Force_Unds=CreateForce()
  set AllPlayers=CreateForce()
  call TK8()
  call InitGroups()
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,15,true)
  call TriggerAddCondition(t,Condition(function UJ8))
  set t=null
  set RestrictedRegion=CreateRegion()
  call RegionAddRect(RestrictedRegion,Rect(-7968.,5216.,-7456.,5920.))
  call RegionAddRect(RestrictedRegion,Rect(-8064.,2880.,-7648.,4512.))
  call RegionAddRect(RestrictedRegion,Rect(-3296.,3712.,-2688.,3968.))
  call RegionAddRect(RestrictedRegion,Rect(-2400.,2016.,-1952.,2624.))
  call RegionAddRect(RestrictedRegion,Rect(-2016.,1600.,-1216.,2048.))
  call RegionAddRect(RestrictedRegion,Rect(-2144.,2528.,-1888.,2944.))
  call RegionAddRect(RestrictedRegion,Rect(-1280.,1728.,-736.,2176.))
  call RegionAddRect(RestrictedRegion,Rect(-1696.,-768.,-1376.,-448.))
  call RegionAddRect(RestrictedRegion,Rect(-576.,.0,-352.,256.))
  call RegionAddRect(RestrictedRegion,Rect(3104.,-2784.,3680.,-2304.))
  call RegionAddRect(RestrictedRegion,Rect(3264.,-3040.,3872.,-2656.))
  call RegionAddRect(RestrictedRegion,Rect(4960.,-3104.,5632.,-2816.))
  call RegionAddRect(RestrictedRegion,Rect(4896.,-3744.,5280.,-3456.))
  call RegionAddRect(RestrictedRegion,Rect(7488.,-3520.,8192.,-2336.))
  call RegionAddRect(RestrictedRegion,Rect(6656.,-3328.,7808.,-2656.))
  call RegionAddRect(RestrictedRegion,Rect(7104.,-8192.,8192.,-5920.))
  call RegionAddRect(RestrictedRegion,Rect(5952.,-8192.,7200.,-7712.))
  call RegionAddRect(RestrictedRegion,Rect(7168.,-6240.,8128.,-5184.))
  call RegionAddRect(RestrictedRegion,Rect(5824.,-8032.,6400.,-7776.))
  call RegionAddRect(RestrictedRegion,Rect(6976.,-6560.,7488.,-5920.))
  call RegionAddRect(RestrictedRegion,Rect(-5856.,2944.,-5600.,3200.))
  call RegionAddRect(RestrictedRegion,Rect(6784.,-7776.,7264.,-7456.))
  call RegionAddRect(RestrictedRegion,Rect(-8192.,-8128.,5472.,-7648.))
  call RegionAddRect(RestrictedRegion,Rect(2368.,-7904.,2688.,-7584.))
  call RegionAddRect(RestrictedRegion,Rect(-1664.,-7808.,-1344.,-7552.))
  call RegionAddRect(RestrictedRegion,Rect(-2944.,-8192.,-1664.,-7680.))
  call RegionAddRect(RestrictedRegion,Rect(-4000.,-8192.,-3168.,-7616.))
  call RegionAddRect(RestrictedRegion,Rect(-5760.,-8000.,-5184.,-7584.))
  call RegionAddRect(RestrictedRegion,Rect(-3296.,3744.,-3104.,3872.))
  call RegionAddRect(RestrictedRegion,Rect(-8192.,-8192.,-6720.,-7744.))
  call RegionAddRect(RestrictedRegion,Rect(-8192.,-6432.,-7456.,-4928.))
  call RegionAddRect(RestrictedRegion,Rect(-8192.,-8128.,-7904.,8160.))
  call RegionAddRect(RestrictedRegion,Rect(-7744.,3936.,-7328.,5600.))
  call RegionAddRect(RestrictedRegion,Rect(-7680.,1984.,-6560.,2816.))
  call RegionAddRect(RestrictedRegion,Rect(-7776.,1696.,-6944.,2176.))
  call RegionAddRect(RestrictedRegion,Rect(-8032.,-3040.,-7680.,-2720.))
  call RegionAddRect(RestrictedRegion,Rect(-7904.,-2656.,-7552.,-2336.))
  call RegionAddRect(RestrictedRegion,Rect(-3936.,-2720.,-3584.,-2400.))
  call RegionAddRect(RestrictedRegion,Rect(-3168.,-1952.,-2912.,-1696.))
  call RegionAddRect(RestrictedRegion,Rect(-4128.,-1632.,-3776.,-1152.))
  call RegionAddRect(RestrictedRegion,Rect(-4992.,-1792.,-3968.,-1440.))
  call RegionAddRect(RestrictedRegion,Rect(-5536.,-1664.,-4832.,-1280.))
  call RegionAddRect(RestrictedRegion,Rect(-2304.,3872.,-2048.,4096.))
  call RegionAddRect(RestrictedRegion,Rect(-5664.,-1440.,-5344.,.0))
  call RegionAddRect(RestrictedRegion,Rect(-5824.,-1504.,-5472.,-544.))
  call RegionAddRect(RestrictedRegion,Rect(-5216.,-1216.,-4480.,-384.))
  call RegionAddRect(RestrictedRegion,Rect(-5632.,448.,-5152.,1856.))
  call RegionAddRect(RestrictedRegion,Rect(-5856.,1440.,-5248.,2592.))
  call RegionAddRect(RestrictedRegion,Rect(-5408.,1888.,-4928.,2368.))
  call RegionAddRect(RestrictedRegion,Rect(-5056.,1664.,-4064.,2144.))
  call RegionAddRect(RestrictedRegion,Rect(-4320.,1344.,-3808.,1952.))
  call RegionAddRect(RestrictedRegion,Rect(-4224.,1440.,-3200.,2016.))
  call RegionAddRect(RestrictedRegion,Rect(-2112.,3424.,-1856.,3744.))
  call RegionAddRect(RestrictedRegion,Rect(-2400.,640.,-2208.,896.))
  call RegionAddRect(RestrictedRegion,Rect(-3392.,640.,-3200.,896.))
  call RegionAddRect(RestrictedRegion,Rect(-3744.,-1024.,-3232.,384.))
  call RegionAddRect(RestrictedRegion,Rect(-2016.,-5504.,-1664.,-4768.))
  call RegionAddRect(RestrictedRegion,Rect(-1760.,-5248.,-1312.,-4800.))
  call RegionAddRect(RestrictedRegion,Rect(896.,-3328.,1088.,-3072.))
  call RegionAddRect(RestrictedRegion,Rect(2816.,-3488.,3008.,-3232.))
  call RegionAddRect(RestrictedRegion,Rect(1568.,-2976.,1760.,-2656.))
  call RegionAddRect(RestrictedRegion,Rect(-768.,-1344.,-480.,-1024.))
  call RegionAddRect(RestrictedRegion,Rect(1152.,-6560.,1376.,-6272.))
  call RegionAddRect(RestrictedRegion,Rect(1216.,-6368.,1504.,-6176.))
  call RegionAddRect(RestrictedRegion,Rect(-1376.,-6784.,-1184.,-6528.))
  call RegionAddRect(RestrictedRegion,Rect(7616.,-6528.,8192.,8160.))
  call RegionAddRect(RestrictedRegion,Rect(7072.,-2304.,7264.,-2048.))
  call RegionAddRect(RestrictedRegion,Rect(-7872.,7872.,8192.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(1792.,7776.,2112.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(-2656.,.0,-2496.,256.))
  call RegionAddRect(RestrictedRegion,Rect(-768.,7232.,-416.,7424.))
  call RegionAddRect(RestrictedRegion,Rect(-7968.,5472.,-7648.,5792.))
  call RegionAddRect(RestrictedRegion,Rect(1120.,7904.,1312.,8160.))
  call RegionAddRect(RestrictedRegion,Rect(736.,4480.,1120.,4800.))
  call RegionAddRect(RestrictedRegion,Rect(2208.,4928.,2400.,5152.))
  call RegionAddRect(RestrictedRegion,Rect(576.,4384.,1120.,4928.))
  call RegionAddRect(RestrictedRegion,Rect(2560.,4160.,2784.,4576.))
  call RegionAddRect(RestrictedRegion,Rect(6208.,7488.,8192.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(576.,4256.,1024.,4672.))
  call RegionAddRect(RestrictedRegion,Rect(544.,4352.,992.,4768.))
  call RegionAddRect(RestrictedRegion,Rect(704.,2496.,1376.,2784.))
  call RegionAddRect(RestrictedRegion,Rect(-2240.,1792.,-1856.,2240.))
  call RegionAddRect(RestrictedRegion,Rect(-1472.,1472.,-992.,1728.))
  call RegionAddRect(RestrictedRegion,Rect(2368.,-3264.,2656.,-2944.))
  call RegionAddRect(RestrictedRegion,Rect(2624.,-3648.,2816.,-2912.))
  call RegionAddRect(RestrictedRegion,Rect(2464.,-3456.,2656.,-3200.))
  call RegionAddRect(RestrictedRegion,Rect(2784.,-3232.,2976.,-2976.))
  call RegionAddRect(RestrictedRegion,Rect(2784.,-3424.,2976.,-3168.))
  call RegionAddRect(RestrictedRegion,Rect(7328.,7808.,8192.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(1984.,7584.,3296.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(2240.,7392.,2560.,8192.))
  call RegionAddRect(RestrictedRegion,Rect(-1888.,416.,-1696.,576.))
  call RegionAddRect(RestrictedRegion,Rect(7776.,2720.,8192.,3648.))
  call RegionAddRect(RestrictedRegion,Rect(5280.,640.,5664.,1184.))
  call RegionAddRect(RestrictedRegion,Rect(-3104.,2720.,-2624.,3232.))
  
  call AddDispellableBuff('A341')
  call AddDispellableBuff('A345')
  call AddDispellableBuff('QH00')
  call AddDispellableBuff('A347')
  call AddDispellableBuff('A348')
  call AddDispellableBuff('A349')
  call AddDispellableBuff('A1W3')
  call AddDispellableBuff('A317')
  call AddDispellableBuff('A315')
  call AddDispellableBuff('A42O')
  call AddDispellableBuff('A42R')
  call AddDispellableBuff('A314')
  call AddDispellableBuff('A313')
  call AddDispellableBuff('A312')
  call AddDispellableBuff('A310')
  call AddDispellableBuff('A30Y')
  call AddDispellableBuff('B307')
  call AddDispellableBuff('A334')
  call AddDispellableBuff('A40F')
  call AddDispellableBuff('A335')
  call AddDispellableBuff('B08B')
  call AddDispellableBuff('B083')
  call AddDispellableBuff('B06Z')
  call AddDispellableBuff('B0GR')
  call AddDispellableBuff('A44Y')
  call AddDispellableBuff('B0GT')
  call AddDispellableBuff('B0GK')
  call AddDispellableBuff('B0GG')
  call AddDispellableBuff('A2L8')
  call AddDispellableBuff('BPSE')
  call AddDispellableBuff('B06Q')
  call AddDispellableBuff('BSTN')
  call AddDispellableBuff('BHtc')
  call AddDispellableBuff('B0BM')
  call AddDispellableBuff('B0BR')
  call AddDispellableBuff('B0C1')
  call AddDispellableBuff('BEer')
  call AddDispellableBuff('B02U')
  call AddDispellableBuff('B07E')
  call AddDispellableBuff('B0CF')
  call AddDispellableBuff('B06M')
  call AddDispellableBuff('B07N')
  call AddDispellableBuff('B08S')
  call AddDispellableBuff('B00Q')
  call AddDispellableBuff('B072')
  call AddDispellableBuff('BUan')
  call AddDispellableBuff('B095')
  call AddDispellableBuff('B02V')
  call AddDispellableBuff('B01Y')
  call AddDispellableBuff('BNab')
  call AddDispellableBuff('B08R')
  call AddDispellableBuff('B066')
  call AddDispellableBuff('B03I')
  call AddDispellableBuff('B063')
  call AddDispellableBuff('B03C')
  call AddDispellableBuff('B00L')
  call AddDispellableBuff('BHca')
  call AddDispellableBuff('Bcsd')
  call AddDispellableBuff('B079')
  call AddDispellableBuff('B0BQ')
  call AddDispellableBuff('B0B9')
  call AddDispellableBuff('Bprg')
  call AddDispellableBuff('B08M')
  call AddDispellableBuff('B0GM')
  call AddDispellableBuff('B02G')
  call AddDispellableBuff('B01X')
  call AddDispellableBuff('B01D')
  call AddDispellableBuff('B092')
  call AddDispellableBuff('B0AQ')
  call AddDispellableBuff('BEsh')
  call AddDispellableBuff('B017')
  call AddDispellableBuff('B0AE')
  call AddDispellableBuff('B0AD')
  call AddDispellableBuff('B08O')
  call AddDispellableBuff('Bfro')
  call AddDispellableBuff('B027')
  call AddDispellableBuff('B028')
  call AddDispellableBuff('B05H')
  call AddDispellableBuff('B0BS')
  call AddDispellableBuff('Bcri')
  call AddDispellableBuff('B0BF')
  call AddDispellableBuff('B0BE')
  call AddDispellableBuff('B090')
  call AddDispellableBuff('B008')
  call AddDispellableBuff('B04B')
  call AddDispellableBuff('B02F')
  call AddDispellableBuff('BUsp')
  call AddDispellableBuff('Bust')
  call AddDispellableBuff('B0CC')
  call AddDispellableBuff('B03J')
  call AddDispellableBuff('B078')
  call AddDispellableBuff('Bdet')
  call AddDispellableBuff('B00T')
  call AddDispellableBuff('Bslo')
  call AddDispellableBuff('BNdh')
  call AddDispellableBuff('B07V')
  call AddDispellableBuff('B07U')
  call AddDispellableBuff('BNsi')
  call AddDispellableBuff('B031')
  call AddDispellableBuff('BNso')
  call AddDispellableBuff('B00P')
  call AddDispellableBuff('B02M')
  call AddDispellableBuff('A1LD')
  call AddDispellableBuff('B0CD')
  call AddDispellableBuff('A1JA')
  call AddDispellableBuff('B043')
  call AddDispellableBuff('BNpa')
  call AddDispellableBuff('B01N')
  call AddDispellableBuff('BIcb')
  call AddDispellableBuff('B04Q')
  call AddDispellableBuff('B00C')
  call AddDispellableBuff('B09K')
  call AddDispellableBuff('B033')
  call AddDispellableBuff('B08F')
  call AddDispellableBuff('B08E')
  call AddDispellableBuff('Bpoi')
  call AddDispellableBuff('B0AM')
  call AddDispellableBuff('BNrd')
  call AddDispellableBuff('B00H')
  call AddDispellableBuff('BOhx')
  call AddDispellableBuff('B03F')
  call AddDispellableBuff('B02N')
  call AddDispellableBuff('B0E7')
  call AddDispellableBuff('B06D')
  call AddDispellableBuff('B0BN')
  call AddDispellableBuff('B09Q')
  call AddDispellableBuff('B0DI')
  call AddDispellableBuff('B0BB')
  call AddDispellableBuff('B09J')
  call AddDispellableBuff('B0AF')
  call AddDispellableBuff('B071')
  call AddDispellableBuff('B08N')
  call AddDispellableBuff('B02I')
  call AddDispellableBuff('B08Q')
  call AddDispellableBuff('B0C2')
  call AddDispellableBuff('B06S')
  call AddDispellableBuff('B02S')
  call AddDispellableBuff('B02W')
  call AddDispellableBuff('B05Q')
  call AddDispellableBuff('B02D')
  call AddDispellableBuff('B0BY')
  call AddDispellableBuff('B02P')
  call AddDispellableBuff('B05F')
  call AddDispellableBuff('B0EP')
  call AddDispellableBuff('B0ER')
  call AddDispellableBuff('B0ET')
  call AddDispellableBuff('B0FN')
  call AddDispellableBuff('B0FY')
  call AddDispellableBuff('B0FT')
  call AddDispellableBuff('B0G0')
  call AddDispellableBuff('B0F5')
  
  call AddPositiveBuffToList('Broa')
  call AddPositiveBuffToList('B014')
  call AddPositiveBuffToList('B00G')
  call AddPositiveBuffToList('B016')
  call AddPositiveBuffToList('B077')
  call AddPositiveBuffToList('B0FP')
  call AddPositiveBuffToList('B0FQ')
  call AddPositiveBuffToList('Bblo')
  call AddPositiveBuffToList('B013')
  
  call FlushGameCache(InitGameCache("dr.x"))
  set GCM=InitGameCache("dr.x")
  call FlushGameCache(InitGameCache("d"))
  set RGCGC=InitGameCache("d")
  call FlushGameCache(InitGameCache("meta"))
  set RGCGC2=InitGameCache("meta")
  call FlushGameCache(InitGameCache("mapid"))
  set RGCGC3=InitGameCache("mapid")
  set BonusDamageSystemCont[0]='A17F'
  set BonusDamageSystemCont[1]='A17G'
  set BonusDamageSystemCont[2]='A17H'
  set BonusDamageSystemCont[3]='A17C'
  set BonusDamageSystemCont[4]='A17D'
  set BonusDamageSystemCont[5]='A17E'
  set BonusDamageSystemCont[6]='A17J'
  set BonusDamageSystemCont[7]='A17I'
  set BonusDamageSystemCont[8]='A17L'
  set BonusDamageSystemCont[9]='A439'
  set BonusDamageSystemCont[10]='A43A'
  set BonusDamageSystemCont[11]='A43B'
  
  set BonusMSPercentSystem[0]='USS0'
  set BonusMSPercentSystem[1]='USS1'
  set BonusMSPercentSystem[2]='USS2'
  set BonusMSPercentSystem[3]='USS3'
  set BonusMSPercentSystem[4]='USS4'
  set BonusMSPercentSystem[5]='USS5'
  set BonusMSPercentSystem[6]='USS6'
  set BonusMSPercentSystem[7]='USS7'
  set BonusMSPercentSystem[8]='USS8'
  set BonusMSPercentSystem[9]='USS9'
  set EvasionContainers[0]='EVS0'
  set EvasionContainers[1]='EVS1'
  set EvasionContainers[2]='EVS2'
  set EvasionContainers[3]='EVS3'
  set EvasionContainers[4]='EVS4'
  set EvasionContainers[5]='EVS5'
  set EvasionContainers[6]='EVS6'
  set EvasionContainers[7]='EVS7'
  set EvasionContainers[8]='EVS8'
  
  set HPBonusSystem[0]='A1QE'
  set HPBonusSystem[1]='A1QF'
  set HPBonusSystem[2]='A1QI'
  set HPBonusSystem[3]='A1QK'
  set HPBonusSystem[4]='A1QJ'
  set HPBonusSystem[5]='A1QH'
  set HPBonusSystem[6]='A1QO'
  set HPBonusSystem[7]='A1QN'
  set HPBonusSystem[8]='A1QM'
  set HPBonusSystem[9]='A1QG'
  set HPBonusSystem[10]='A1QQ'
  set NegativeArmorSystem[0]='A1CM'
  set NegativeArmorSystem[1]='A1CK'
  set NegativeArmorSystem[2]='A1CF'
  set NegativeArmorSystem[3]='A1CI'
  set NegativeArmorSystem[4]='A1CG'
  set NegativeArmorSystem[5]='A1CH'
  set ArmletStrBonus[0]='ARM0'
  set ArmletStrBonus[1]='ARM1'
  set ArmletStrBonus[2]='ARM2'
  set ArmletStrBonus[3]='ARM3'
  set ArmletStrBonus[4]='ARM4'
  set PN=CreateTrigger()
  call TriggerAddCondition(PN,Condition(function GS9))
  call ExeFunc("Buyback_Init")
  set GlobalTimer=CreateTimer()
  set CS=Rect(-7040,-7680,7040,7168)
  call SetFloatGameState(GAME_STATE_TIME_OF_DAY,6.)
  call SuspendTimeOfDay(false)
  call SetSkyModel("Environment\\Sky\\FoggedSky\\FoggedSky.mdl")
  call SetCreepCampFilterState(true)
  set MainModeInTxt="Normal Mode"
  call TimerStart(GlobalTimer,99999.,false,null)
  set Weather_Rain=AddWeatherEffect(bj_mapInitialPlayableArea,'RAhr')
  set Weather_Snow=AddWeatherEffect(bj_mapInitialPlayableArea,'SNbs')
  set Weather_Moonlight=AddWeatherEffect(bj_mapInitialPlayableArea,'LRma')
  set Weather_Wind=AddWeatherEffect(bj_mapInitialPlayableArea,'WOlw')
  set Sentinels[0]=Player(0)
  set Sentinels[1]=Player(1)
  set Sentinels[2]=Player(2)
  set Sentinels[3]=Player(3)
  set Sentinels[4]=Player(4)
  set Sentinels[5]=Player(5)
  set Scourges[0]=Player(6)
  set Scourges[1]=Player(7)
  set Scourges[2]=Player(8)
  set Scourges[3]=Player(9)
  set Scourges[4]=Player(10)
  set Scourges[5]=Player(11)
  set Neutrals=Player(12)
  set ABDGroup=CreateGroup()
  call SetUnitPathing(SentBaseWaypointDummy,false)
  call SetUnitPathing(BottomWaypointDummy,false)
  call SetUnitPathing(MidWaypointDummy,false)
  call SetUnitPathing(TopWaypointDummy,false)
  call SetUnitPathing(ScouBaseWaypointDummy,false)
  call UnitAddAbility(ScouBaseWaypointDummy,'Avul')
  call UnitAddAbility(TopWaypointDummy,'Avul')
  call UnitAddAbility(MidWaypointDummy,'Avul')
  call UnitAddAbility(BottomWaypointDummy,'Avul')
  call UnitAddAbility(SentBaseWaypointDummy,'Avul')
  set FrozenThroneLoc=GetUnitLoc(ScouBaseWaypointDummy)
  set TreeOfLifeLoc=GetUnitLoc(SentBaseWaypointDummy)
  set MidCreepsWaypoint=GetUnitLoc(MidWaypointDummy)
  set TopCreepsWaypoint=GetUnitLoc(TopWaypointDummy)
  set BottomCreepsWaypoint=GetUnitLoc(BottomWaypointDummy)
  set WaypointLocations[1]=TreeOfLifeLoc
  set WaypointLocations[2]=TopCreepsWaypoint
  set WaypointLocations[3]=MidCreepsWaypoint
  set WaypointLocations[4]=BottomCreepsWaypoint
  set WaypointLocations[5]=FrozenThroneLoc
  set ScourgeMidMeleeSpawn=GetRectCenter(ScouMidMeleeSpawnRect)
  set ScourgeTopMeleeSpawn=GetRectCenter(ScouTopMeleeSpawnRect)
  set ScourgeBottomMeleeSpawn=GetRectCenter(ScouBotMeleeSpawnRect)
  set ScourgeMidRangeSpawn=GetRectCenter(ScouMidRangeSpawnRect)
  set ScourgeTopRangeSpawn=GetRectCenter(ScouTopRangeSpawnRect)
  set ScourgeBottomRangeSpawn=GetRectCenter(ScouBotRangeSpawnRect)
  set SentinelMidMeleeSpawn=GetRectCenter(SentMidMeleeSpawnRect)
  set SentinelTopMeleeSpawn=GetRectCenter(SentTopMeleeSpawnRect)
  set SentinelBottomMeleeSpawn=GetRectCenter(SentBotMeleeSpawnRect)
  set SentinelMidRangeSpawn=GetRectCenter(SentMidRangeSpawnRect)
  set SentinelTopRangeSpawn=GetRectCenter(SentTopRangeSpawnRect)
  set SentinelBottomRangeSpawn=GetRectCenter(SentBotRangeSpawnRect)
  set TopRuneSpawn=GetRectCenter(TopRuneSpawnRect)
  set BottomRuneSpawn=GetRectCenter(BottomRuneSpawnRect)
  
  
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  //call TriggerRegisterAnyUnitEvent(DamageRegister,EVENT_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function DamageRegisterEnter))
  set DamageRegister=CreateTrigger()
  call TriggerAddCondition(DamageRegister,Condition(function DamageHappened))
  
  set SentFountain=CreateUnit(Sentinels[0],'nfoh',-7168,-7168,270)
  call CreateUnit(Sentinels[0],'o00G',-7168,-7168,270)
  set SentinelBuilding_ShopCache=CreateUnit(Player15,'hC95',-6880,-7136,270)
  set SentinelBuilding_ShopWeapon=CreateUnit(Player15,'n01K',-7264,-6688,270)
  set SentinelBuilding_ShopAccessorizer=CreateUnit(Player15,'nC38',-7264,-6880,270)
  set SentinelBuilding_ShopChimaera=CreateUnit(Player15,'e025',-6624,-7136,270)
  set SentinelBuilding_Shop1=CreateUnit(Player15,'n00V',-6940+64,-6368,270)
  set SentinelBuilding_Shop2=CreateUnit(Player15,'n00W',-7264+0,-6496+64,270)
  set SentinelBuilding_Shop3=CreateUnit(Player15,'n002',-6816+64,-6368,270)
  set SentinelBuilding_Shop4=CreateUnit(Player15,'n00X',-7200+64,-6368,270)
  set SentinelBuilding_Shop5=CreateUnit(Player15,'n009',-6678+64,-6432,270)
  set SentinelBuilding_Shop6=CreateUnit(Player15,'n0HE',-7072+64,-6368,270)
  set TreeOfLife=CreateUnit(Sentinels[0],'etol',-5568,-6016,270)
  set Towers_Sent_Top_1=CreateUnit(Sentinels[0],'e00R',-6112,1568,90)
  set Towers_Sent_Mid_1=CreateUnit(Sentinels[0],'e00R',-1504,-1824,45)
  set Towers_Sent_Bot_1=CreateUnit(Sentinels[0],'e00R',4960,-6752,0)
  set Towers_Sent_Top_2=CreateUnit(Sentinels[0],'e011',-6112,-1184,90)
  set Towers_Sent_Mid_2=CreateUnit(Sentinels[0],'e011',-3488,-3296,45)
  set Towers_Sent_Bot_2=CreateUnit(Sentinels[0],'e011',-608,-6688,0)
  
  call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Top_2),'ABDr',Rect(-6944.,-1792.,-5248.,-224.))
  call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Mid_2),'ABDr',Rect(-4128.,-3712.,-2496.,-2272.))
  call SaveRectHandle(MHT,GetHandleId(Towers_Sent_Bot_2),'ABDr',Rect(-1536.,-7424.,640.,-6048.))
  call GroupAddUnit(ABDGroup,Towers_Sent_Top_2)
  call GroupAddUnit(ABDGroup,Towers_Sent_Mid_2)
  call GroupAddUnit(ABDGroup,Towers_Sent_Bot_2)
  
  set Towers_Sent_Top_3=CreateUnit(Sentinels[0],'e00S',-6368,-4256,90)
  set Towers_Sent_Mid_3=CreateUnit(Sentinels[0],'e00S',-4448,-4960,45)
  set Towers_Sent_Bot_3=CreateUnit(Sentinels[0],'e00S',-3744,-6816,0)
  set Towers_Sent_Tree1=CreateUnit(Sentinels[0],'e019',-5536,-5664,45)
  set Towers_Sent_Tree2=CreateUnit(Sentinels[0],'e019',-5216,-6048,45)
  set Elf_Rax_Melee_Top=CreateUnit(Sentinels[0],'eaom',-6080,-4480,90)
  set Elf_Rax_Melee_Mid=CreateUnit(Sentinels[0],'eaom',-4416,-5312,45)
  set Elf_Rax_Melee_Bot=CreateUnit(Sentinels[0],'eaom',-4032,-7040,0)
  set Elf_Rax_Range_Top=CreateUnit(Sentinels[0],'eaoe',-6656,-4480,90)
  set Elf_Rax_Range_Mid=CreateUnit(Sentinels[0],'eaoe',-4864,-4992,45)
  set Elf_Rax_Range_Bot=CreateUnit(Sentinels[0],'eaoe',-4032,-6528,0)
  
  call SaveBaseRects(Towers_Sent_Top_3)
  call SaveBaseRects(Towers_Sent_Mid_3)
  call SaveBaseRects(Towers_Sent_Bot_3)
  call SaveBaseRects(Towers_Sent_Tree1)
  call SaveBaseRects(Towers_Sent_Tree2)
  call SaveBaseRects(Elf_Rax_Melee_Top)
  call SaveBaseRects(Elf_Rax_Melee_Mid)
  call SaveBaseRects(Elf_Rax_Melee_Bot)
  call SaveBaseRects(Elf_Rax_Range_Top)
  call SaveBaseRects(Elf_Rax_Range_Mid)
  call SaveBaseRects(Elf_Rax_Range_Bot)
  
  set EK7=CreateUnit(Sentinels[0],'emow',-5856,-5472,270)
  set EM7=CreateUnit(Sentinels[0],'emow',-6624,-5088,270)
  set EN7=CreateUnit(Sentinels[0],'emow',-5344,-3936,270)
  set EO7=CreateUnit(Sentinels[0],'emow',-5088,-4576,270)
  set EP7=CreateUnit(Sentinels[0],'emow',-3936,-5344,270)
  set EQ7=CreateUnit(Sentinels[0],'emow',-5088,-5536,270)
  set ER7=CreateUnit(Sentinels[0],'emow',-4896,-6240,270)
  set ES7=CreateUnit(Sentinels[0],'emow',-3808,-5856,270)
  set ET7=CreateUnit(Sentinels[0],'emow',-4512,-7072,270)
  set EU7=CreateUnit(Sentinels[0],'emow',-5472,-4704,270)
  set EV7=CreateUnit(Sentinels[0],'emow',-4512,-5856,270)
  set EW7=CreateUnit(Sentinels[0],'eaow',-6080,-5120,270)
  set EX7=CreateUnit(Sentinels[0],'eaow',-4544,-6528,270)
  set EY7=CreateUnit(Sentinels[0],'edob',-6400,-5696,270)
  set EZ7=CreateUnit(Sentinels[0],'edob',-5248,-6848,270)
  call SetPlayerAbilityAvailable2(Player15,'Aro1',false)
  call SetUnitColor(SentinelBuilding_ShopCache,PlayColor0)
  call SetUnitColor(SentinelBuilding_ShopChimaera,PlayColor0)
  call SetUnitColor(SentinelBuilding_ShopAccessorizer,PlayColor12)
  call SetUnitColor(SentinelBuilding_ShopWeapon,PlayColor12)
  call SetUnitColor(SentinelBuilding_Shop1,PlayColor12)
  call SetUnitColor(SentinelBuilding_Shop2,PlayColor12)
  call SetUnitColor(SentinelBuilding_Shop3,PlayColor12)
  call SetUnitColor(SentinelBuilding_Shop4,PlayColor12)
  call SetUnitColor(SentinelBuilding_Shop5,PlayColor12)
  call UnitAddAbility(Towers_Sent_Top_1,'Avul')
  call UnitAddAbility(Towers_Sent_Mid_1,'Avul')
  call UnitAddAbility(Towers_Sent_Bot_1,'Avul')
  call UnitAddAbility(Towers_Sent_Top_2,'Avul')
  call UnitAddAbility(Towers_Sent_Mid_2,'Avul')
  call UnitAddAbility(Towers_Sent_Bot_2,'Avul')
  call UnitAddAbility(Towers_Sent_Top_3,'Avul')
  call UnitAddAbility(Towers_Sent_Mid_3,'Avul')
  call UnitAddAbility(Towers_Sent_Bot_3,'Avul')
  call UnitAddAbility(Towers_Sent_Tree1,'Avul')
  call UnitAddAbility(Towers_Sent_Tree2,'Avul')
  call UnitAddAbility(TreeOfLife,'Avul')
  call UnitAddAbility(Elf_Rax_Melee_Top,'Avul')
  call UnitAddAbility(Elf_Rax_Melee_Mid,'Avul')
  call UnitAddAbility(Elf_Rax_Melee_Bot,'Avul')
  call UnitAddAbility(Elf_Rax_Range_Top,'Avul')
  call UnitAddAbility(Elf_Rax_Range_Mid,'Avul')
  call UnitAddAbility(Elf_Rax_Range_Bot,'Avul')
  call UnitAddAbility(EW7,'Avul')
  call UnitAddAbility(EX7,'Avul')
  call UnitAddAbility(EY7,'Avul')
  call UnitAddAbility(EZ7,'Avul')
  call UnitAddAbility(EK7,'Avul')
  call UnitAddAbility(EM7,'Avul')
  call UnitAddAbility(EN7,'Avul')
  call UnitAddAbility(EO7,'Avul')
  call UnitAddAbility(EP7,'Avul')
  call UnitAddAbility(EQ7,'Avul')
  call UnitAddAbility(ER7,'Avul')
  call UnitAddAbility(ES7,'Avul')
  call UnitAddAbility(ET7,'Avul')
  call UnitAddAbility(EU7,'Avul')
  call UnitAddAbility(EV7,'Avul')
  set ScourgeFountain=CreateUnit(Scourges[0],'ndfl',6784,6368,270)
  call CreateUnit(Scourges[0],'o00G',6784,6368,270)
  set ScourgeBuilding_ShopGateway=CreateUnit(Player15,'nC35',6816,5984,270)
  set ScourgeBuilding_ShopWeapon=CreateUnit(Player15,'n01K',6304,6368,270)
  set ScourgeBuilding_ShopAccessorizer=CreateUnit(Player15,'nC38',6496,6368,270)
  set ScourgeBuilding_ShopGraveyard=CreateUnit(Player15,'u00Q',6816,5664,270)
  set ScourgeBuilding_Shop1=CreateUnit(Player15,'n00V',5920,6048+128,0)
  set ScourgeBuilding_Shop2=CreateUnit(Player15,'n00W',5984+128,6432,0)
  set ScourgeBuilding_Shop3=CreateUnit(Player15,'n002',5920,5920+128,0)
  set ScourgeBuilding_Shop4=CreateUnit(Player15,'n00X',5920+64,6304+128,0)
  set ScourgeBuilding_Shop5=CreateUnit(Player15,'n009',5984,5792+128,0)
  set ScourgeBuilding_Shop6=CreateUnit(Player15,'n0HE',5920,6176+128,0)
  set FrozenThrone=CreateUnit(Scourges[0],'unpl',5248,4918,220)
  set Towers_Scourge_Top_1=CreateUnit(Scourges[0],'u00M',-4704,5920,270)
  set Towers_Scourge_Mid_1=CreateUnit(Scourges[0],'u00M',1056,-96,270)
  set Towers_Scourge_Bot_1=CreateUnit(Scourges[0],'u00M',6048,-2080,270)
  set Towers_Scourge_Top_2=CreateUnit(Scourges[0],'u00D',-32,5920,270)
  set Towers_Scourge_Mid_2=CreateUnit(Scourges[0],'u00D',2528,1824,270)
  set Towers_Scourge_Bot_2=CreateUnit(Scourges[0],'u00D',6272,-160,270)
  
  call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Top_2),'ABDr',Rect(-1088.,5376.,768.,6624.))
  call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Mid_2),'ABDr',Rect(1600.,1024.,3456.,2432.))
  call SaveRectHandle(MHT,GetHandleId(Towers_Scourge_Bot_2),'ABDr',Rect(5504.,-1056.,7200.,512.))
  call GroupAddUnit(ABDGroup,Towers_Scourge_Top_2)
  call GroupAddUnit(ABDGroup,Towers_Scourge_Mid_2)
  call GroupAddUnit(ABDGroup,Towers_Scourge_Bot_2)
  
  set Towers_Scourge_Top_3=CreateUnit(Scourges[0],'u00N',2976,5792,270)
  set Towers_Scourge_Mid_3=CreateUnit(Scourges[0],'u00N',3936,3488,270)
  set Towers_Scourge_Bot_3=CreateUnit(Scourges[0],'u00N',6368,2528,270)
  set Towers_Scourge_Throne1=CreateUnit(Scourges[0],'u00T',4832,4832,270)
  set Towers_Scourge_Throne2=CreateUnit(Scourges[0],'u00T',5152,4512,270)
  
  set Und_Rax_Melee_Top=CreateUnit(Scourges[0],'usep',3392,5504,270)
  set Und_Rax_Melee_Mid=CreateUnit(Scourges[0],'usep',4352,3584,270)
  set Und_Rax_Melee_Bot=CreateUnit(Scourges[0],'usep',6656,2880,270)
  set Und_Rax_Range_Top=CreateUnit(Scourges[0],'utod',3392,6080,270)
  set Und_Rax_Range_Mid=CreateUnit(Scourges[0],'utod',3904,3904,270)
  set Und_Rax_Range_Bot=CreateUnit(Scourges[0],'utod',6080,2944,270)
  
  call SaveBaseRects(Towers_Scourge_Top_3)
  call SaveBaseRects(Towers_Scourge_Mid_3)
  call SaveBaseRects(Towers_Scourge_Bot_3)
  call SaveBaseRects(Towers_Scourge_Throne1)
  call SaveBaseRects(Towers_Scourge_Throne2)
  call SaveBaseRects(Und_Rax_Melee_Top)
  call SaveBaseRects(Und_Rax_Melee_Mid)
  call SaveBaseRects(Und_Rax_Melee_Bot)
  call SaveBaseRects(Und_Rax_Range_Top)
  call SaveBaseRects(Und_Rax_Range_Mid)
  call SaveBaseRects(Und_Rax_Range_Bot)
  
  set I77=CreateUnit(Scourges[0],'uzig',2656,4704,270)
  set I87=CreateUnit(Scourges[0],'uzig',3168,4064,270)
  set I97=CreateUnit(Scourges[0],'uzig',3488,4832,270)
  set ID7=CreateUnit(Scourges[0],'uzig',4128,6240,270)
  set IE7=CreateUnit(Scourges[0],'uzig',4064,5280,270)
  set IF7=CreateUnit(Scourges[0],'uzig',4384,4256,270)
  set IG7=CreateUnit(Scourges[0],'uzig',5728,4000,270)
  set IH7=CreateUnit(Scourges[0],'uzig',5536,2464,270)
  set II7=CreateUnit(Scourges[0],'uzig',5024,3744,270)
  set IJ7=CreateUnit(Scourges[0],'uzig',6880,3936,270)
  set IK7=CreateUnit(Scourges[0],'uzig',4640,2848,270)
  set IM7=CreateUnit(Scourges[0],'usap',3968,5888,270)
  set IN7=CreateUnit(Scourges[0],'usap',6400,3584,270)
  set IO7=CreateUnit(Scourges[0],'ubon',4992,5952,270)
  set IP7=CreateUnit(Scourges[0],'ubon',6464,4608,270)
  call SetUnitColor(ScourgeBuilding_ShopGateway,PlayColor6)
  call SetUnitColor(ScourgeBuilding_ShopAccessorizer,PlayColor12)
  call SetUnitColor(ScourgeBuilding_ShopWeapon,PlayColor12)
  call SetUnitColor(ScourgeBuilding_Shop1,PlayColor12)
  call SetUnitColor(ScourgeBuilding_Shop2,PlayColor12)
  call SetUnitColor(ScourgeBuilding_Shop3,PlayColor12)
  call SetUnitColor(ScourgeBuilding_Shop4,PlayColor12)
  call SetUnitColor(ScourgeBuilding_Shop5,PlayColor12)
  call UnitAddAbility(Towers_Scourge_Top_1,'Avul')
  call UnitAddAbility(Towers_Scourge_Mid_1,'Avul')
  call UnitAddAbility(Towers_Scourge_Bot_1,'Avul')
  call UnitAddAbility(Towers_Scourge_Top_2,'Avul')
  call UnitAddAbility(Towers_Scourge_Mid_2,'Avul')
  call UnitAddAbility(Towers_Scourge_Bot_2,'Avul')
  call UnitAddAbility(Towers_Scourge_Top_3,'Avul')
  call UnitAddAbility(Towers_Scourge_Mid_3,'Avul')
  call UnitAddAbility(Towers_Scourge_Bot_3,'Avul')
  call UnitAddAbility(Towers_Scourge_Throne1,'Avul')
  call UnitAddAbility(Towers_Scourge_Throne2,'Avul')
  call UnitAddAbility(FrozenThrone,'Avul')
  call UnitAddAbility(Und_Rax_Melee_Top,'Avul')
  call UnitAddAbility(Und_Rax_Melee_Mid,'Avul')
  call UnitAddAbility(Und_Rax_Melee_Bot,'Avul')
  call UnitAddAbility(Und_Rax_Range_Top,'Avul')
  call UnitAddAbility(Und_Rax_Range_Mid,'Avul')
  call UnitAddAbility(Und_Rax_Range_Bot,'Avul')
  call UnitAddAbility(IM7,'Avul')
  call UnitAddAbility(IN7,'Avul')
  call UnitAddAbility(IO7,'Avul')
  call UnitAddAbility(IP7,'Avul')
  call UnitAddAbility(I77,'Avul')
  call UnitAddAbility(I87,'Avul')
  call UnitAddAbility(I97,'Avul')
  call UnitAddAbility(ID7,'Avul')
  call UnitAddAbility(IE7,'Avul')
  call UnitAddAbility(IF7,'Avul')
  call UnitAddAbility(IG7,'Avul')
  call UnitAddAbility(IH7,'Avul')
  call UnitAddAbility(II7,'Avul')
  call UnitAddAbility(IJ7,'Avul')
  call UnitAddAbility(IK7,'Avul')
  
  set CirclesOfPower_1=CreateUnit(Player(1),'ncop',-7424,-7176,270)
  call ConvertCircle(CirclesOfPower_1,1)
  set CirclesOfPower_2=CreateUnit(Player(2),'ncop',-7424,-6998,270)
  call ConvertCircle(CirclesOfPower_2,2)
  set CirclesOfPower_3=CreateUnit(Player(3),'ncop',-7424,-6820,270)
  call ConvertCircle(CirclesOfPower_3,3)
  set CirclesOfPower_4=CreateUnit(Player(4),'ncop',-7424,-6592,270)
  call ConvertCircle(CirclesOfPower_4,4)
  set CirclesOfPower_5=CreateUnit(Player(5),'ncop',-7424,-6400,270)
  call ConvertCircle(CirclesOfPower_5,5)
  
  set CirclesOfPower_7=CreateUnit(Player(7),'ncop',7040,6400,270)
  call ConvertCircle(CirclesOfPower_7,7)
  set CirclesOfPower_8=CreateUnit(Player(8),'ncop',7040,6208,270)
  call ConvertCircle(CirclesOfPower_8,8)
  set CirclesOfPower_9=CreateUnit(Player(9),'ncop',7040,6016,270)
  call ConvertCircle(CirclesOfPower_9,9)
  set CirclesOfPower_10=CreateUnit(Player(10),'ncop',7040,5824,270)
  call ConvertCircle(CirclesOfPower_10,10)
  set CirclesOfPower_11=CreateUnit(Player(11),'ncop',7040,5632,270)
  call ConvertCircle(CirclesOfPower_11,11)
  
  call InitForces()
  call InitHeroes()
  set t=CreateTrigger()
  set TavernIntSent1=CreateUnit(p,'n008',-7360,6464,270)
  set TavernIntSent2=CreateUnit(p,'n0GJ',-7168,6464,270)
  set TavernIntScourge1=CreateUnit(p,'n01D',-6848,6464,270)
  set TavernIntScourge2=CreateUnit(p,'n0LH',-6656,6464,270)
  set TavernAgiSent1=CreateUnit(p,'n01N',-7360,6784,270)
  set TavernAgiSent2=CreateUnit(p,'n007',-7168,6784,270)
  set TavernAgiScourge1=CreateUnit(p,'n005',-6848,6784,270)
  set TavernAgiScourge2=CreateUnit(p,'n0LI',-6656,6784,270)
  set TavernStrSent1=CreateUnit(p,'n01B',-7360,7104,270)
  set TavernStrSent2=CreateUnit(p,'n01P',-7168,7104,270)
  set TavernStrScourge1=CreateUnit(p,'n0GK',-6848,7104,270)
  set TavernStrScourge2=CreateUnit(p,'n0LJ',-6656,7104,270)
  call TechAll()
  call SetUnitColor(TavernIntSent1,ConvertPlayerColor(1))
  call SetUnitColor(TavernIntSent2,ConvertPlayerColor(1))
  call SetUnitColor(TavernIntScourge1,ConvertPlayerColor(9))
  call SetUnitColor(TavernIntScourge2,ConvertPlayerColor(9))
  call SetUnitColor(TavernAgiSent1,ConvertPlayerColor(6))
  call SetUnitColor(TavernAgiSent2,ConvertPlayerColor(6))
  call SetUnitColor(TavernAgiScourge1,ConvertPlayerColor(10))
  call SetUnitColor(TavernAgiScourge2,ConvertPlayerColor(10))
  call SetUnitColor(TavernStrSent1,ConvertPlayerColor(0))
  call SetUnitColor(TavernStrSent2,ConvertPlayerColor(0))
  call SetUnitColor(TavernStrScourge1,ConvertPlayerColor(11))
  call SetUnitColor(TavernStrScourge2,ConvertPlayerColor(11))
  set t=null
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function InitAbilLists))
  set RF=CreateTrigger()
  call TriggerRegisterTimerEvent(RF,0.01,false)
  call TriggerAddAction(RF,function InitQuests)
  set t=CreateTrigger()
  call TriggerRegisterPlayerEventLeave(t,Sentinels[1])
  call TriggerRegisterPlayerEventLeave(t,Sentinels[2])
  call TriggerRegisterPlayerEventLeave(t,Sentinels[3])
  call TriggerRegisterPlayerEventLeave(t,Sentinels[4])
  call TriggerRegisterPlayerEventLeave(t,Sentinels[5])
  call TriggerRegisterPlayerEventLeave(t,Scourges[1])
  call TriggerRegisterPlayerEventLeave(t,Scourges[2])
  call TriggerRegisterPlayerEventLeave(t,Scourges[3])
  call TriggerRegisterPlayerEventLeave(t,Scourges[4])
  call TriggerRegisterPlayerEventLeave(t,Scourges[5])
  call TriggerAddAction(t,function PlayerLeave_Act1)
  call TriggerAddAction(t,function PlayerLeave_CheckFF)
  call TriggerAddAction(t,function PlayerLeave_DropSkills)
  if udg_ObserverMode then
    call IY9()
    set t=CreateTrigger()
    if IsPlayerObserver(udg_Observer1)then
      call TriggerRegisterPlayerEventLeave(t,udg_Observer1)
    endif
    if IsPlayerObserver(udg_Observer2)then
      call TriggerRegisterPlayerEventLeave(t,udg_Observer2)
    endif
    call TriggerAddAction(t,function IZ9)
  endif
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_REVIVE_FINISH)
  call TriggerAddAction(t,function HeroRespawn)
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function VD9))
  call TriggerAddAction(t,function HeroEntersMap)
  set HeroEnters=t
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
  call TriggerAddAction(t,function TavernHeroSelected)
  call TriggerAddCondition(t,Condition(function VX9))
  set t=CreateTrigger()
  call TriggerRegisterPlayerEvent(t,Player(1),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(2),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(3),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(4),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(5),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(7),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(8),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(9),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(10),EVENT_PLAYER_END_CINEMATIC)
  call TriggerRegisterPlayerEvent(t,Player(11),EVENT_PLAYER_END_CINEMATIC)
  call TriggerAddCondition(t,Condition(function EscPressed))
  set TriggerGoldPerSecond=CreateTrigger()
  call TriggerRegisterTimerEvent(TriggerGoldPerSecond,0.6,true)
  call TriggerAddCondition(TriggerGoldPerSecond,Condition(function GoldPerSecTrigger))
  call DisableTrigger(TriggerGoldPerSecond)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddAction(t,function UpdateTime)
  set TriggerUpdateGameTime=t
  call SetTime(0,0,false)
  call InitUltiesCD()
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
  call TriggerAddCondition(t,Condition(function ReliableGoldHandling))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function RevivingQueue))
  
  set M87=CreateTrigger()
  call TriggerAddCondition(M87,Condition(function YM9))
  set tt=CreateTimer()
  call TimerStart(tt,60,true,function RoshanBuffer)
  set tt=null
  set CourierDead[GetPlayerId(Sentinels[0])]=false
  set CourierDead[GetPlayerId(Scourges[0])]=false
  call TimedReveal(Player(0),5,-6990.,6840.,750)
  call TimedReveal(Player(1),5,-6990.,6840.,750)
  call TimedReveal(Player(2),5,-6990.,6840.,750)
  call TimedReveal(Player(3),5,-6990.,6840.,750)
  call TimedReveal(Player(4),5,-6990.,6840.,750)
  call TimedReveal(Player(5),5,-6990.,6840.,750)
  call TimedReveal(Player(6),5,-6990.,6840.,750)
  call TimedReveal(Player(7),5,-6990.,6840.,750)
  call TimedReveal(Player(8),5,-6990.,6840.,750)
  call TimedReveal(Player(9),5,-6990.,6840.,750)
  call TimedReveal(Player(10),5,-6990.,6840.,750)
  call TimedReveal(Player(11),5,-6990.,6840.,750)
  call TimedReveal(Player(12),5,-6990.,6840.,750)
  call ExecuteFunc("InitItems")
  set WE7=CreateRegion()
  call RegionAddRect(WE7,Rect(-8192.,-8128.,-5120.,-5536.))
  call RegionAddRect(WE7,Rect(4608.,4352.,8192.,8192.))
  set RuneSpawnTrigger=CreateTrigger()
  call TriggerAddCondition(RuneSpawnTrigger,Condition(function RuneSpawn))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELL)
  call TriggerAddCondition(t,Condition(function UnitItem_Enter))
  
  set t_manipulateitem=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerRegisterAnyUnitEvent(t_manipulateitem,EVENT_PLAYER_UNIT_PAWN_ITEM)
  call TriggerAddCondition(t_manipulateitem,Condition(function CM9))
  
  set GenericItemActionTrigger=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerRegisterAnyUnitEvent(GenericItemActionTrigger,EVENT_PLAYER_UNIT_PAWN_ITEM)
  call TriggerAddCondition(GenericItemActionTrigger,Condition(function CA9))
  
  set t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function Spell_Disassemble))
  set t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerAddCondition(t,Condition(function CourierCantSell))
  
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function BloodstoneMP))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SUMMON)
  call TriggerAddAction(t,function Autoselection)
  call TriggerAddCondition(t,Condition(function ReturnTrue))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.1,true)
  call TriggerAddCondition(t,Condition(function CheckToggleItems))
  //	set t=CreateTrigger()
  //	call TriggerRegisterTimerEvent(t,.75,true)
  //	call TriggerAddCondition(t,Condition(function BottleRefill))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerAddCondition(t,Condition(function D2D))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerAddCondition(t,Condition(function D5D))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerAddCondition(t,Condition(function E7D))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerAddCondition(t,Condition(function EDD))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.5,true)
  call TriggerAddCondition(t,Condition(function LinkensWrapper))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerAddCondition(t,Condition(function FBD))
  call Spectre_Dispersion_Init()
  call SetAltMinimapIcon("war3mapImported\\black.blp")
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function VariousItemSpells))
  set t=CreateTrigger()
  call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_SPELL_EFFECT,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_SPELL_CAST,Condition(function ReturnTrue))
  
  call TriggerAddCondition(t,Condition(function RoshanSlam))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_USE_ITEM)
  call TriggerAddCondition(t,Condition(function KBD))
  set YT9=GetRectCenter(Q4)
  set Roshan=CreateUnitAtLoc(Player(12),'n00L',YT9,bj_UNIT_FACING)
  call SetUnitAcquireRange(Roshan,150)
  call YI9(Roshan)
  call RemoveLocation(YT9)
  call UnitAddItem(Roshan,CreateItem(Item_Real[indexid_Aegis],0,0))
  call UnitAddAbility(Roshan,'A142')
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Ar),GetRectCenterY(NR_Und_Ar),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Ar),GetRectCenterY(NR_Und_Ar),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Ar),GetRectCenterY(NR_Elf_Ar),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Cr),GetRectCenterY(NR_Elf_Cr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Bpr),GetRectCenterY(NR_Und_Bpr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_Pr),GetRectCenterY(NR_Und_Pr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Pr),GetRectCenterY(NR_Elf_Pr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_TRr),GetRectCenterY(NR_Und_TRr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_BRr),GetRectCenterY(NR_Elf_BRr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Und_BBr),GetRectCenterY(NR_Und_BBr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_OldSmr),GetRectCenterY(NR_Elf_OldSmr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Uld_OldSmr),GetRectCenterY(NR_Uld_OldSmr),0))
  call RemoveUnit(CreateUnit(Neutrals,'u001',GetRectCenterX(NR_Elf_Roofr),GetRectCenterY(NR_Elf_Roofr),0))
  set t=CreateTrigger()
  call TriggerRegisterUnitInRange(t,BottomWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerRegisterUnitInRange(t,MidWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerRegisterUnitInRange(t,TopWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function KLD))
  set IG=CreateTrigger()
  call TriggerAddAction(IG,function K1D)
  set OG=CreateTrigger()
  call TriggerAddAction(OG,function K0D)
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,SentMidMeleeSpawnRect)
  call RegionAddRect(UJE,SentMidRangeSpawnRect)
  call RegionAddRect(UJE,Waypoints_SentMidSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function K5D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,ScouMidRangeSpawnRect)
  call RegionAddRect(UJE,ScouMidMeleeSpawnRect)
  call RegionAddRect(UJE,Waypoints_ScMidSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function K2D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,SentTopMeleeSpawnRect)
  call RegionAddRect(UJE,SentTopRangeSpawnRect)
  call RegionAddRect(UJE,Waypoints_SentTopSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function M4D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,ScouTopRangeSpawnRect)
  call RegionAddRect(UJE,ScouTopMeleeSpawnRect)
  call RegionAddRect(UJE,Waypoints_ScTopSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function M7D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,SentBotRangeSpawnRect)
  call RegionAddRect(UJE,SentBotMeleeSpawnRect)
  call RegionAddRect(UJE,Waypoints_SentBotSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function M8D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,ScouBotRangeSpawnRect)
  call RegionAddRect(UJE,ScouBotMeleeSpawnRect)
  call RegionAddRect(UJE,Waypoints_ScBotSpawn)
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function M9D))
  set AG=CreateTrigger()
  call TriggerAddAction(AG,function CreepSpawning)
  set BG=CreateTrigger()
  call TriggerRegisterUnitEvent(BG,Elf_Rax_Range_Top,EVENT_UNIT_DEATH)
  call TriggerAddAction(BG,function MRD)
  set CG=CreateTrigger()
  call TriggerRegisterUnitEvent(CG,Elf_Rax_Range_Mid,EVENT_UNIT_DEATH)
  call TriggerAddAction(CG,function MSD)
  set DG=CreateTrigger()
  call TriggerRegisterUnitEvent(DG,Elf_Rax_Range_Bot,EVENT_UNIT_DEATH)
  call TriggerAddAction(DG,function MTD)
  set EG=CreateTrigger()
  call TriggerRegisterUnitEvent(EG,Elf_Rax_Melee_Top,EVENT_UNIT_DEATH)
  call TriggerAddAction(EG,function MUD)
  set FG=CreateTrigger()
  call TriggerRegisterUnitEvent(FG,Elf_Rax_Melee_Mid,EVENT_UNIT_DEATH)
  call TriggerAddAction(FG,function MVD)
  set GG=CreateTrigger()
  call TriggerRegisterUnitEvent(GG,Elf_Rax_Melee_Bot,EVENT_UNIT_DEATH)
  call TriggerAddAction(GG,function MWD)
  set HG=CreateTrigger()
  call TriggerRegisterUnitEvent(HG,Und_Rax_Range_Top,EVENT_UNIT_DEATH)
  call TriggerAddAction(HG,function MXD)
  set ZG=CreateTrigger()
  call TriggerRegisterUnitEvent(ZG,Und_Rax_Range_Mid,EVENT_UNIT_DEATH)
  call TriggerAddAction(ZG,function MYD)
  set VG=CreateTrigger()
  call TriggerRegisterUnitEvent(VG,Und_Rax_Range_Bot,EVENT_UNIT_DEATH)
  call TriggerAddAction(VG,function MZD)
  set WG=CreateTrigger()
  call TriggerRegisterUnitEvent(WG,Und_Rax_Melee_Top,EVENT_UNIT_DEATH)
  call TriggerAddAction(WG,function MAD)
  set XG=CreateTrigger()
  call TriggerRegisterUnitEvent(XG,Und_Rax_Melee_Mid,EVENT_UNIT_DEATH)
  call TriggerAddAction(XG,function MBD)
  set YG=CreateTrigger()
  call TriggerRegisterUnitEvent(YG,Und_Rax_Melee_Bot,EVENT_UNIT_DEATH)
  call TriggerAddAction(YG,function MCD)
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,TreeOfLife,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function M3D))
  set t=CreateTrigger()
  call TriggerRegisterUnitEvent(t,FrozenThrone,EVENT_UNIT_DAMAGED)
  call TriggerAddCondition(t,Condition(function MLD))
  set JG=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(JG,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(JG,Condition(function M1D))
  call TriggerAddAction(JG,function MegaCreepsSent)
  set KG=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(KG,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(KG,Condition(function M5D))
  call TriggerAddAction(KG,function MegaCreepsScourge)
  set LG=CreateTrigger()
  call TriggerAddAction(LG,function CreepUpgradeTime)
  set MG=CreateTrigger()
  call TriggerRegisterTimerEvent(MG,75,false)
  call TriggerAddAction(MG,function PreloadNeutrals)
  set NG=CreateTrigger()
  call TriggerAddCondition(NG,Condition(function NeutralsRespawn))
  set SG=CreateTrigger()
  call TriggerAddAction(SG,function SuperCreeps)
  set TG=CreateTrigger()
  call TriggerAddAction(TG,function RefreshBoard)
  set QG=CreateTrigger()
  call TriggerRegisterTimerEventPeriodic(QG,1.)
  call TriggerAddAction(QG,function BigRefreshBoard)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DESELECTED)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SELECTED)
  call TriggerAddCondition(t,Condition(function ShopAnimation))
  set t=CreateTrigger()
  call TriggerAddCondition(t,Condition(function ABD))
  call TriggerRegisterUnitEvent(t,Towers_Sent_Top_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Top_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Top_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Top_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Mid_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Bot_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Tree1,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Tree1,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Tree2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Sent_Tree2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Top,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Mid,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Melee_Bot,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Top,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Top,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Mid,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Elf_Rax_Range_Bot,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Top_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Mid_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_3,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Bot_3,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne1,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne1,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne2,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Towers_Scourge_Throne2,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Top,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Top,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Mid,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Mid,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Bot,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Melee_Bot,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Top,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Top,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Mid,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Mid,EVENT_UNIT_DEATH)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Bot,EVENT_UNIT_DAMAGED)
  call TriggerRegisterUnitEvent(t,Und_Rax_Range_Bot,EVENT_UNIT_DEATH)
  
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,1,true)
  call TriggerAddCondition(t,Condition(function ABD_HealTimer))
  call TriggerAddCondition(t,Condition(function FixCameraHeight))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,5,true)
  call TriggerAddCondition(t,Condition(function ABD_Timer))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,4,true)
  call TriggerAddCondition(t,Condition(function RZD))
  set Y57=GetAvailableGroup()
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function R3D))
  call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_VISIBLE,-4550,1250,300,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_VISIBLE,-4550,1250,300,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_VISIBLE,3200,1,300,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_VISIBLE,3200,1,300,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_VISIBLE,-7292,4186,450,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_VISIBLE,-7292,4186,450,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Sentinels[0],FOG_OF_WAR_VISIBLE,7348,-4334,450,true,true))
  call DestroyFogModifier(CreateFogModifierRadius(Scourges[0],FOG_OF_WAR_VISIBLE,7348,-4334,450,true,true))
  call DestroyFogModifier(CreateFogModifierRect(Sentinels[0],FOG_OF_WAR_VISIBLE,CS,true,true))
  call DestroyFogModifier(CreateFogModifierRect(Scourges[0],FOG_OF_WAR_VISIBLE,CS,true,true))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,3.5,true)
  call TriggerAddCondition(t,Condition(function CourierFountainCheck))
  set YK=CreateTrigger()
  call TriggerRegisterUnitEvent(YK,FrozenThrone,EVENT_UNIT_DEATH)
  call TriggerAddAction(YK,function SKD)
  set JK=CreateTrigger()
  call TriggerRegisterUnitEvent(JK,TreeOfLife,EVENT_UNIT_DEATH)
  call TriggerAddAction(JK,function SID)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_ATTACKED)
  call TriggerAddCondition(t,Condition(function SPD))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_SPELL_EFFECT)
  call TriggerAddCondition(t,Condition(function STD))
  set ZI7=CreateTrigger()
  call TriggerAddAction(ZI7,function SXD)
  set t=CreateTrigger()
  call TriggerRegisterPlayerUnitEvent(t,Neutrals,EVENT_PLAYER_UNIT_ATTACKED,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function Roshan_IllusionKiller))
  set ZJ7=CreateRegion()
  call RegionAddRect(ZJ7,Rect(3456,-2016,4448,-2624))
  set UG=CreateTrigger()
  call TriggerRegisterEnterRectSimple(UG,GetWorldBounds())
  call TriggerAddCondition(UG,Condition(function SZD))
  call TriggerAddAction(UG,function DummyUtilize)
  set IH=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(IH,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(IH,Condition(function SBD))
  call TriggerAddAction(IH,function S6D)
  set OH=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(OH,EVENT_PLAYER_UNIT_DEATH)
  call TriggerAddCondition(OH,Condition(function SLD))
  call TriggerAddAction(OH,function S5D)
  if(bj_isSinglePlayer and S2D())then
    call AddFlyingCourierIfSolo()
    call T3D()
  endif
  set t=CreateTrigger()
  call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-wtf",true)
  call TriggerAddAction(t,function T0D)
  call TriggerAddCondition(t,Condition(function T6D))
  set t=CreateTrigger()
  call TriggerRegisterPlayerUnitEvent(t,Sentinels[1],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Sentinels[2],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Sentinels[3],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Sentinels[4],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Sentinels[5],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Scourges[1],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Scourges[2],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Scourges[3],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Scourges[4],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerRegisterPlayerUnitEvent(t,Scourges[5],EVENT_PLAYER_HERO_LEVEL,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function T2D))
  set t=CreateTrigger()
  call TriggerRegisterPlayerChatEvent(t,PlayerModeTyper,"-test",true)
  call TriggerAddCondition(t,Condition(function U7D))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,GetWorldBounds())
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function HeroAttackedLogic_Init))
  set t=CreateTrigger()
  call TriggerRegisterUnitInRange(t,BottomWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerRegisterUnitInRange(t,MidWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerRegisterUnitInRange(t,TopWaypointDummy,300,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function UZD))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,25,false)
  call TriggerAddAction(t,function UCD)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,2,false)
  call TriggerAddCondition(t,Condition(function U2D))
  set KK=CreateRegion()
  call RegionAddRect(KK,G4)
  call RegionAddRect(KK,F4)
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,25,false)
  call TriggerAddAction(t,function VFD)
  set t=CreateTrigger()
  call TriggerRegisterPlayerChatEvent(t,Sentinels[1],"",false)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[2],"",false)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[3],"",false)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[4],"",false)
  call TriggerRegisterPlayerChatEvent(t,Sentinels[5],"",false)
  call TriggerRegisterPlayerChatEvent(t,Scourges[1],"",false)
  call TriggerRegisterPlayerChatEvent(t,Scourges[2],"",false)
  call TriggerRegisterPlayerChatEvent(t,Scourges[3],"",false)
  call TriggerRegisterPlayerChatEvent(t,Scourges[4],"",false)
  call TriggerRegisterPlayerChatEvent(t,Scourges[5],"",false)
  call TriggerAddAction(t,function VGD)
  set i=0
  loop
    set CSONStatus1[i]=true
    set CSONStatus2[i]=true
    set FixedCameraOnHero[i]=false
    set AutoselectionStatus[i]=true
    set HeroHasBeenUnlocked[i]=false
    set ShowDeathTimer[i]=false
    set ShowRollNumbers[i]=true
    set hhnActive[i]=false
    set CustomWaterColor[i]=false
    set IsPlayerLeftGame[i]=false
    set IsHeroDead[i]=false
    set BottlePickupRunesOldfashion[i]=false
    set HidePassivesForPlayer[i]=false
    set RGCFFed[i]=false
    set HideMorphIcon[i]=false
    set ShakingOn[i]=true
    set PlayerSkillNumber[i*PlayerSkillOffset+1]=0
    set PlayerSkillNumber[i*PlayerSkillOffset+2]=0
    set PlayerSkillNumber[i*PlayerSkillOffset+3]=0
    set PlayerSkillNumber[i*PlayerSkillOffset+4]=0
    set PlayerSkillNumber[i*PlayerSkillOffset+5]=0
    set PlayerSkillNumber[i*PlayerSkillOffset+6]=0
    set LeftAt[i]="Here"
    set HasAlreadyPickedHero[i]=false
    set udg_Hero[i]=null
    set HeroTypeId[i]=0
    set PlayerHaveRealHero[i]=false
    set PlayerHaveHero[i]=false
    set HeroRespawnTimer[i]=CreateTimer()
    set HasUsedRandom[i]=false
    set IsImpossibleToBuyback[i]=false
    set SDHeroesPoolInc[i]=0
    set ResetCooldown[i]=0
    set ReadyCooldown[i]=-2
    set FleshHeapCount[i]=0
    set ShowSkills[i]=false
    set OO[i]=0
    set G3[i]=false
    set MultikillTimers[i]=CreateTimer()
    call SaveInteger(HY,GetHandleId(MultikillTimers[i]),0,i)
    set PlayerKillsStreak[i]=0
    set MultikillCounter[i]=0
    set TrackBonusBounty[i]=0
    set HackStatus[i]=false
    set NetWorths[i]=0
    set NetWorthRecount[i]=false
    set NetWorthsNoGold[i]=0
    set TxtDur[i]=10.
    set ClearCounter[i]=0
    set i=i+1
    exitwhen i>16
  endloop
  set i=0
  loop
    set tt_int1=GetPlayerId(Sentinels[i])
    set TempInt=GetPlayerId(Scourges[i])
    set ShowDeathTimer[tt_int1]=true
    set ShowDeathTimer[TempInt]=true
    set SoundsMuted[tt_int1]=false
    set SoundsMuted[TempInt]=false
    set ItemInfoShown[tt_int1]=false
    set ItemInfoShown[TempInt]=false
    set SpellInfoShown[tt_int1]=false
    set SpellInfoShown[TempInt]=false
    set ShowCourierIcon[tt_int1]=false
    set ShowCourierIcon[TempInt]=false
    set A47[tt_int1]=false
    set A47[TempInt]=false
    set i=i+1
    exitwhen i>5
  endloop
  set t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerAddCondition(t,Condition(function ZTD))
  set t=CreateTrigger()
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_ORDER)
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
  call TriggerRegisterHumanUnitEvent(t,EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER)
  call TriggerAddCondition(t,Condition(function DoubleHold))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,5,true)
  call TriggerAddCondition(t,Condition(function ZSD))
  
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function ZAD))
  
  set t=null
  set t=CreateTrigger()
  call TriggerAddAction(t,function LLD)
  call TriggerAddCondition(t,Condition(function B1D))
  set AR7=t
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,.01,false)
  call TriggerAddCondition(t,Condition(function L1D))
  if udg_ObserverMode then
    set t=CreateTrigger()
    call TriggerRegisterTimerEvent(t,1,true)
    call TriggerAddCondition(t,Condition(function IJE))
  endif
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,10,true)
  call TriggerAddCondition(t,Condition(function MeleeRangeItemsFix))
  set MeleeRangeItemsSwitcher=t
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerAddCondition(t,Condition(function JEE))
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,15,false)
  call TriggerAddCondition(t,Condition(function JDE))
  set t=CreateTrigger()
  set UJE=CreateRegion()
  call RegionAddRect(UJE,GetWorldBounds())
  call TriggerRegisterEnterRegion(t,UJE,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function YYF))
  set i=0
  loop
    set SpawnHistory[i]=0
    set i=i+1
    exitwhen i>40
  endloop
  set t=CreateTrigger()
  call TriggerRegisterTimerEvent(t,0.1,false)
  call TriggerAddAction(t,function HEH)
  call SetTerrainFogEx(0,9999999.,10000000.,.0,.0,.0,.0)
  // RMD - MapID
  call Traffic_RegisterCustomGlobalData("i","d",0x03)
  
  // RMD - Meta Data
  call Traffic_RegisterCustomMetaData("a","Kills",0)
  call Traffic_RegisterCustomMetaData("b","Deaths",0)
  call Traffic_RegisterCustomMetaData("c","Assists",0)
  call Traffic_RegisterCustomMetaData("d","CreepKills",0)
  call Traffic_RegisterCustomMetaData("e","CreepDenies",0)
  call Traffic_RegisterCustomMetaData("f","Neutrals",0)
  
  call StoreAllTints()
  call ExecuteFunc("StoreAllUnitsBounty")
  call StoreAllUnitsSightRange()
  call InitSCMD()
  set RoshanCanWalkHere=Rect(3008,-2016,4448,-2784)
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PICKUP_ITEM)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_DROP_ITEM)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_PAWN_ITEM)
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_HERO_SKILL)
  call TriggerAddCondition(t,Condition(function EvasionStacking))
  //	set ShowSkillsOnSelectT=CreateTrigger()
  //	call TriggerRegisterAnyUnitEvent(ShowSkillsOnSelectT,EVENT_PLAYER_UNIT_SELECTED)
  //	call TriggerAddCondition(ShowSkillsOnSelectT,Condition(function ShowSkillsOnSelecting))
  set t=CreateTrigger()
  call TriggerRegisterAnyUnitEvent(t,EVENT_PLAYER_UNIT_CHANGE_OWNER)
  call TriggerAddCondition(t,Condition(function OwnerChanging))
  call DoubleRightClickInit()
  set  t=CreateTrigger()
  call TriggerRegisterLeaveRectSimple(t,bj_mapInitialPlayableArea)
  call TriggerAddCondition(t,Condition(function PushOutToMap))
  call TimerStart(CreateTimer(),1,true,function SaveHeroesTick)
  call ExeFunc("Spiritbreaker_Charge_Init")
  call ExeFunc("PRD_Init")
  
  set t=CreateTrigger()
  call TriggerRegisterEnterRectSimple(t,GetWorldBounds())
  call TriggerAddCondition(t,Condition(function Kaolin_Prereg))
  if Kaolin_PreloadAnimation==false then
    set Kaolin_PreloadAnimation=true
  endif
  call TriggerAddCondition(t,Condition(function TimeLapse_PreInit))
  
  
  set t=CreateTrigger()
  set SentFountainReg=CreateRegion()
  call RegionAddRect(SentFountainReg,Rect(-7648,-7680,-6240,-6240))
  call TriggerRegisterEnterRegion(t,SentFountainReg,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function SentFountainArea))
  set t=CreateTrigger()
  set ScourgeFountainReg=CreateRegion()
  call RegionAddRect(ScourgeFountainReg,Rect(5856,5472,7712,7296))
  call TriggerRegisterEnterRegion(t,ScourgeFountainReg,Condition(function ReturnTrue))
  call TriggerAddCondition(t,Condition(function ScourgeFountainArea))
  set t=null
  
  set t=null
  set UJE=null
  
  
  call HideAbility('A42L')
  call HideAbility('A24H')
  
  call HideAbility('A344')
  call HideAbility('A2J9')
  call HideAbility('A2JA')
  call HideAbility('A2J8')
  call HideAbility('A2J7')
  call HideAbility('A27S')
  call HideAbility('A27Q')
  call HideAbility('A27R')
  call HideAbility('A1IE')
  call HideAbility('A1IF')
  call HideAbility('A1IG')
  call HideAbility('A2QA')
  call HideAbility('A27T')
  call HideAbility('A1CA')
  call HideAbility('A1C9')
  call HideAbility('A1CB')
  call HideAbility('A1CC')
  call HideAbility('QF9E')
  call HideAbility('A1LD')
  call HideAbility('A1UH')
  call HideAbility('A1HZ')
  call HideAbility('A1I4')
  call HideAbility('A1I3')
  call HideAbility('A1I6')
  call HideAbility('A29N')
  call HideAbility('A414')
  call HideAbility('A174')
  call HideAbility('QF9E')
  call HideAbility('A1ET')
  call HideAbility('A1ES')
  call HideAbility('A1EQ')
  call HideAbility('A1ER')
  call HideAbility('A23F')
  call HideAbility('A1VV')
  
  call HideAbility(EvasionContainers[0])
  call HideAbility(EvasionContainers[1])
  call HideAbility(EvasionContainers[2])
  call HideAbility(EvasionContainers[3])
  call HideAbility(EvasionContainers[4])
  call HideAbility(EvasionContainers[5])
  call HideAbility(EvasionContainers[6])
  call HideAbility(EvasionContainers[7])
  call HideAbility(EvasionContainers[8])
  call HideAbility(BonusMSPercentSystem[0])
  call HideAbility(BonusMSPercentSystem[1])
  call HideAbility(BonusMSPercentSystem[2])
  call HideAbility(BonusMSPercentSystem[3])
  call HideAbility(BonusMSPercentSystem[4])
  call HideAbility(BonusMSPercentSystem[5])
  call HideAbility(BonusMSPercentSystem[6])
  call HideAbility(BonusMSPercentSystem[7])
  call HideAbility(BonusMSPercentSystem[8])
  call HideAbility(BonusMSPercentSystem[9])
  call HideAbility('A431')
  set stuns[0]='A420'
  set stuns[1]='A421'
  set stuns[2]='A422'
  set stuns[3]='A423'
  set stuns[4]='A424'
  set stuns[5]='A425'
  set stuns[6]='A426'
  set stuns[7]='A427'
  set stuns[8]='A428'
  set stuns[9]='A429'
  set stuns[10]='A42A'
  set stuns[11]='A42B'
  set stuns[12]='A42C'
  call InitShopping()
  set u=null
  set YT9=null
  call SetReservedLocalHeroButtons(1)
  call InitMyLb()
  set TreeRevivalTrigger=CreateTrigger()
  call TriggerAddCondition(TreeRevivalTrigger,Condition(function TreeRevive))
  call EnumDestructablesInRect(GetPlayableMapRect(),Condition(function ReturnTrue),function TreeRevivalGrouping)
  set t=null
  
  if bj_isSinglePlayer then
    //call TestTrack()
  endif
  call SaveBonusEffects()
  
  set i=0
  loop
    call PreloadQueryAdd(LoDArmourAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDArmourAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDArmourNegAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDArmourNegAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDDamageAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDDamageAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDRegenAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDRegenAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDManaRegenAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDManaRegenAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDAttackAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDAttackAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDAttackNegAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDAttackNegAbilityCount
  endloop
  set i=0
  loop
    call PreloadQueryAdd(LoDDamageNegAbilityBase+i)
    set i=i+1
    exitwhen i >= LoDDamageNegAbilityCount
  endloop
  
  call PreloadQueryAdd(HPBonusSystem[0])
  call PreloadQueryAdd(HPBonusSystem[1])
  call PreloadQueryAdd(HPBonusSystem[2])
  call PreloadQueryAdd(HPBonusSystem[3])
  call PreloadQueryAdd(HPBonusSystem[4])
  call PreloadQueryAdd(HPBonusSystem[5])
  call PreloadQueryAdd(HPBonusSystem[6])
  call PreloadQueryAdd(HPBonusSystem[7])
  call PreloadQueryAdd(HPBonusSystem[8])
  call PreloadQueryAdd(HPBonusSystem[9])
  call PreloadQueryAdd(HPBonusSystem[10])
  
  call EnumDestructablesInRect(Rect(3262,-1900,4817,-2800),Condition(function RoshanPitBlockersFilter),function RoshanPitOccluderHeightFix)
  call PushOut2()
  
endfunction

function config takes nothing returns nothing
  call SetMapName("TRIGSTR_50000")
  call SetMapDescription("TRIGSTR_50001")
  call SetPlayers(10)
  call SetTeams(10)
  
  call SetGamePlacement(MAP_PLACEMENT_TEAMS_TOGETHER)
  call DefineStartLocation(0,-6990.,6840.)
  call DefineStartLocation(1,-6990.,6840.)
  call DefineStartLocation(2,-6990.,6840.)
  call DefineStartLocation(3,-6990.,6840.)
  call DefineStartLocation(4,-6990.,6840.)
  call DefineStartLocation(5,-6990.,6840.)
  call DefineStartLocation(6,-6990.,6840.)
  call DefineStartLocation(7,-6990.,6840.)
  call DefineStartLocation(8,-6990.,6840.)
  call DefineStartLocation(9,-6990.,6840.)
  call SetPlayerStartLocation(Player(1),0)
  call ForcePlayerStartLocation(Player(1),0)
  call SetPlayerColor(Player(1),ConvertPlayerColor(1))
  call SetPlayerRacePreference(Player(1),RACE_PREF_NIGHTELF)
  call SetPlayerRaceSelectable(Player(1),false)
  call SetPlayerController(Player(1),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(2),1)
  call ForcePlayerStartLocation(Player(2),1)
  call SetPlayerColor(Player(2),ConvertPlayerColor(2))
  call SetPlayerRacePreference(Player(2),RACE_PREF_NIGHTELF)
  call SetPlayerRaceSelectable(Player(2),false)
  call SetPlayerController(Player(2),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(3),2)
  call ForcePlayerStartLocation(Player(3),2)
  call SetPlayerColor(Player(3),ConvertPlayerColor(3))
  call SetPlayerRacePreference(Player(3),RACE_PREF_NIGHTELF)
  call SetPlayerRaceSelectable(Player(3),false)
  call SetPlayerController(Player(3),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(4),3)
  call ForcePlayerStartLocation(Player(4),3)
  call SetPlayerColor(Player(4),ConvertPlayerColor(4))
  call SetPlayerRacePreference(Player(4),RACE_PREF_NIGHTELF)
  call SetPlayerRaceSelectable(Player(4),false)
  call SetPlayerController(Player(4),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(5),4)
  call ForcePlayerStartLocation(Player(5),4)
  call SetPlayerColor(Player(5),ConvertPlayerColor(5))
  call SetPlayerRacePreference(Player(5),RACE_PREF_NIGHTELF)
  call SetPlayerRaceSelectable(Player(5),false)
  call SetPlayerController(Player(5),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(7),5)
  call ForcePlayerStartLocation(Player(7),5)
  call SetPlayerColor(Player(7),ConvertPlayerColor(7))
  call SetPlayerRacePreference(Player(7),RACE_PREF_UNDEAD)
  call SetPlayerRaceSelectable(Player(7),false)
  call SetPlayerController(Player(7),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(8),6)
  call ForcePlayerStartLocation(Player(8),6)
  call SetPlayerColor(Player(8),ConvertPlayerColor(8))
  call SetPlayerRacePreference(Player(8),RACE_PREF_UNDEAD)
  call SetPlayerRaceSelectable(Player(8),false)
  call SetPlayerController(Player(8),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(9),7)
  call ForcePlayerStartLocation(Player(9),7)
  call SetPlayerColor(Player(9),ConvertPlayerColor(9))
  call SetPlayerRacePreference(Player(9),RACE_PREF_UNDEAD)
  call SetPlayerRaceSelectable(Player(9),false)
  call SetPlayerController(Player(9),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(10),8)
  call ForcePlayerStartLocation(Player(10),8)
  call SetPlayerColor(Player(10),ConvertPlayerColor(10))
  call SetPlayerRacePreference(Player(10),RACE_PREF_UNDEAD)
  call SetPlayerRaceSelectable(Player(10),false)
  call SetPlayerController(Player(10),MAP_CONTROL_USER)
  call SetPlayerStartLocation(Player(11),9)
  call ForcePlayerStartLocation(Player(11),9)
  call SetPlayerColor(Player(11),ConvertPlayerColor(11))
  call SetPlayerRacePreference(Player(11),RACE_PREF_UNDEAD)
  call SetPlayerRaceSelectable(Player(11),false)
  call SetPlayerController(Player(11),MAP_CONTROL_USER)
  call InitCustomTeams()
  call SetPlayerAlliance(Player(15),Player(1),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(2),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(3),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(4),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(5),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(7),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(8),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(9),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(10),ConvertAllianceType(6),true)
  call SetPlayerAlliance(Player(15),Player(11),ConvertAllianceType(6),true)
  call SetStartLocPrioCount(0,9)
  call SetStartLocPrio(0,0,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,1,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,2,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,3,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,4,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(0,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(1,9)
  call SetStartLocPrio(1,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,1,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,2,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,3,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,4,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(1,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(2,9)
  call SetStartLocPrio(2,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,2,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,3,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,4,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(2,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(3,9)
  call SetStartLocPrio(3,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,3,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,4,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(3,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(4,9)
  call SetStartLocPrio(4,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,4,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(4,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(5,9)
  call SetStartLocPrio(5,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,4,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,5,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(5,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(6,9)
  call SetStartLocPrio(6,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,4,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,5,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,6,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(6,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(7,9)
  call SetStartLocPrio(7,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,4,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,5,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,6,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,7,8,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(7,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(8,9)
  call SetStartLocPrio(8,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,4,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,5,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,6,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,7,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(8,8,9,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrioCount(9,9)
  call SetStartLocPrio(9,0,0,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,1,1,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,2,2,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,3,3,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,4,4,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,5,5,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,6,6,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,7,7,MAP_LOC_PRIO_HIGH)
  call SetStartLocPrio(9,8,8,MAP_LOC_PRIO_HIGH)
endfunction
//\[\033[01;36m\][\u@\h\[\033[01;37m\] \W\[\033[01;36m\]]\$\[\033[00m\]